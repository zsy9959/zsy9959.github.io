<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="VLAN,VLAN间路由," />










<meta name="description" content="为什么需要VLAN　　1. 什么是VLAN? 　　VLAN(Virtual LAN)，翻译成中文是“虚拟局域网”。LAN可以是由少数几台家用计算机构成的网络，也可以是数以百计的计算机构成的企业网络。VLAN所指的LAN特指使用路由器分割的网络——也就是广播域。 　　在此让我们先复习一下广播域的概念。广播域，指的是广播帧(目标MAC地址全部为1)所能传递到的范围，亦即能够直接通信的范围。严格地说，并">
<meta property="og:type" content="article">
<meta property="og:title" content="VLAN">
<meta property="og:url" content="http://example.com/2021/04/30/VLAN/index.html">
<meta property="og:site_name" content="zsy&#39;s blog">
<meta property="og:description" content="为什么需要VLAN　　1. 什么是VLAN? 　　VLAN(Virtual LAN)，翻译成中文是“虚拟局域网”。LAN可以是由少数几台家用计算机构成的网络，也可以是数以百计的计算机构成的企业网络。VLAN所指的LAN特指使用路由器分割的网络——也就是广播域。 　　在此让我们先复习一下广播域的概念。广播域，指的是广播帧(目标MAC地址全部为1)所能传递到的范围，亦即能够直接通信的范围。严格地说，并">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/1.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/2.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/3.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/4.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/5.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/6.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/VLAN%E9%97%B4%E5%88%92%E5%88%86.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/7.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/8.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/9.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/10.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/11.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/12.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/tag.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/13.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/14.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/15.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/16.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/17.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/18.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/19.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/20.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/21.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/22.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/23.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/%E4%B8%BE%E4%BE%8B.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/24.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/25.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/26.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/27.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/28.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/29.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/30.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/Aceess.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/Trunk.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/Hybrid.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/31.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/%E5%AD%90%E6%8E%A5%E5%8F%A3.png">
<meta property="og:image" content="http://example.com/2021/04/30/VLAN/VLANIF.png">
<meta property="article:published_time" content="2021-04-30T06:47:09.000Z">
<meta property="article:modified_time" content="2021-05-05T09:41:42.822Z">
<meta property="article:author" content="张思宇">
<meta property="article:tag" content="VLAN">
<meta property="article:tag" content="VLAN间路由">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/04/30/VLAN/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/2021/04/30/VLAN/"/>





  <title>VLAN | zsy's blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zsy's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">just simple</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/home" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/30/VLAN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">VLAN</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-30T14:47:09+08:00">
                2021-04-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="为什么需要VLAN"><a href="#为什么需要VLAN" class="headerlink" title="为什么需要VLAN"></a>为什么需要VLAN</h2><p>　　1. 什么是VLAN?</p>
<p>　　VLAN(Virtual LAN)，翻译成中文是“虚拟局域网”。LAN可以是由少数几台家用计算机构成的网络，也可以是数以百计的计算机构成的企业网络。VLAN所指的LAN特指使用路由器分割的网络——也就是广播域。</p>
<p>　　在此让我们先复习一下广播域的概念。广播域，指的是广播帧(目标MAC地址全部为1)所能传递到的范围，亦即能够直接通信的范围。严格地说，并不仅仅是广播帧，多播帧(Multicast Frame)和目标不明的单播帧(Unknown Unicast Frame)也能在同一个广播域中畅行无阻。</p>
<p>　　本来，二层交换机只能构建单一的广播域，不过使用VLAN功能后，它能够将网络分割成多个广播域。</p>
<p>　　2.未分割广播域时……</p>
<p>　　那么，为什么需要分割广播域呢?那是因为，如果仅有一个广播域，有可能会影响到网络整体的传输性能。具体原因，请参看附图加深理解。</p>
<p><img src="/2021/04/30/VLAN/1.png"></p>
<p>　　图中，是一个由5台二层交换机(交换机1～5)连接了大量客户机构成的网络。假设这时，计算机A需要与计算机B通信。在基于以太网的通信中，必须在数据帧中指定目标MAC地址才能正常通信，因此计算机A必须先广播“ARP请求(ARP Request)信息”，来尝试获取计算机B的MAC地址。</p>
<p>　　交换机1收到广播帧(ARP请求)后，会将它转发给除接收端口外的其他所有端口，也就是Flooding了。接着，交换机2收到广播帧后也会Flooding。交换机3、4、5也还会Flooding。最终ARP请求会被转发到同一网络中的所有客户机上。</p>
<p><img src="/2021/04/30/VLAN/2.png"></p>
<p>　　请大家注意一下，这个ARP请求原本是为了获得计算机B的MAC地址而发出的。也就是说：只要计算机B能收到就万事大吉了。可是事实上，数据帧却传遍整个网络，导致所有的计算机都收到了它。如此一来，一方面广播信息消耗了网络整体的带宽，另一方面，收到广播信息的计算机还要消耗一部分CPU时间来对它进行处理。造成了网络带宽和CPU运算能力的大量无谓消耗。</p>
<p>　　3. 广播信息是那么经常发出的吗?</p>
<p>　　读到这里，您也许会问：广播信息真是那么频繁出现的吗?</p>
<p>　　答案是：是的!实际上广播帧会非常频繁地出现。利用TCP/IP协议栈通信时，除了前面出现的ARP外，还有可能需要发出DHCP、RIP等很多其他类型的广播信息。</p>
<p>　　ARP广播，是在需要与其他主机通信时发出的。当客户机请求DHCP服务器分配IP地址时，就必须发出DHCP的广播。而使用RIP作为路由协议时，每隔30秒路由器都会对邻近的其他路由器广播一次路由信息。RIP以外的其他路由协议使用多播传输路由信息，这也会被交换机转发(Flooding)。除了TCP/IP以外，NetBEUI、IPX和Apple Talk等协议也经常需要用到广播。例如在Windows下双击打开“网络计算机”时就会发出广播(多播)信息。(Windows XP除外……)</p>
<p>　　总之，广播就在我们身边。下面是一些常见的广播通信：</p>
<p>　　(1)ARP请求：建立IP地址和MAC地址的映射关系。</p>
<p>　　(2)RIP：一种路由协议。</p>
<p>　　(3)DHCP：用于自动设定IP地址的协议。</p>
<p>　　(4)NetBEUI：Windows下使用的网络协议。</p>
<p>　　(5)IPX：NovellNetware使用的网络协议。</p>
<p>　　(6)Apple Talk：苹果公司的Macintosh计算机使用的网络协议。</p>
<p>　　如果整个网络只有一个广播域，那么一旦发出广播信息，就会传遍整个网络，并且对网络中的主机带来额外的负担。因此，在设计LAN时，需要注意如何才能有效地分割广播域。</p>
<p>　　4.广播域的分割与VLAN的必要性</p>
<p>　　分割广播域时，一般都必须使用到路由器。使用路由器后，可以以路由器上的网络接口(LAN Interface)为单位分割广播域。</p>
<p>　　但是，通常情况下路由器上不会有太多的网络接口，其数目多在1～4个左右。随着宽带连接的普及，宽带路由器(或者叫IP共享器)变得较为常见，但是需要注意的是，它们上面虽然带着多个(一般为4个左右)连接LAN一侧的网络接口，但那实际上是路由器内置的交换机，并不能分割广播域。</p>
<p>　　况且使用路由器分割广播域的话，所能分割的个数完全取决于路由器的网络接口个数，使得用户无法自由地根据实际需要分割广播域。</p>
<p>　　与路由器相比，二层交换机一般带有多个网络接口。因此如果能使用它分割广播域，那么无疑运用上的灵活性会大大提高。</p>
<p>　　用于在二层交换机上分割广播域的技术，就是VLAN。通过利用VLAN，我们可以自由设计广播域的构成，提高网络设计的自由度。</p>
<h2 id="实现VLAN的机制"><a href="#实现VLAN的机制" class="headerlink" title="实现VLAN的机制"></a>实现VLAN的机制</h2><p>　　1. 实现VLAN的机制</p>
<p>　　在理解了“为什么需要VLAN”之后，接下来让我们来了解一下交换机是如何使用VLAN分割广播域的。</p>
<p>　　首先，在一台未设置任何VLAN的二层交换机上，任何广播帧都会被转发给除接收端口外的所有其他端口(Flooding)。例如，计算机A发送广播信息后，会被转发给端口2、3、4。</p>
<p><img src="/2021/04/30/VLAN/3.png"></p>
<p>　　这时，如果在交换机上生成红、蓝两个VLAN;同时设置端口1、2属于红色VLAN、端口3、4属于蓝色VLAN。再从A发出广播帧的话，交换机就只会把它转发给同属于一个VLAN的其他端口——也就是同属于红色VLAN的端口2，不会再转发给属于蓝色VLAN的端口。</p>
<p>　　同样，C发送广播信息时，只会被转发给其他属于蓝色VLAN的端口，不会被转发给属于红色VLAN的端口。</p>
<p><img src="/2021/04/30/VLAN/4.png"></p>
<p>　　就这样，VLAN通过限制广播帧转发的范围分割了广播域。上图中为了便于说明，以红、蓝两色识别不同的VLAN，在实际使用中则是用“VLAN ID”来区分的。</p>
<p>　　2.直观地描述VLAN</p>
<p>　　如果要更为直观地描述VLAN的话，我们可以把它理解为将一台交换机在逻辑上分割成了数台交换机。在一台交换机上生成红、蓝两个VLAN，也可以看作是将一台交换机换做一红一蓝两台虚拟的交换机。</p>
<p><img src="/2021/04/30/VLAN/5.png"></p>
<p>　　在红、蓝两个VLAN之外生成新的VLAN时，可以想象成又添加了新的交换机。</p>
<p>　　但是，VLAN生成的逻辑上的交换机是互不相通的。因此，在交换机上设置VLAN后，如果未做其他处理，VLAN间是无法通信的。</p>
<p>　　明明接在同一台交换机上，但却偏偏无法通信——这个事实也许让人难以接受。但它既是VLAN方便易用的特征，又是使VLAN令人难以理解的原因。</p>
<p>　　3. 需要VLAN间通信时怎么办</p>
<p>　　那么，当我们需要在不同的VLAN间通信时又该如何是好呢?</p>
<p>　　请大家再次回忆一下：VLAN是广播域。而通常两个广播域之间由路由器连接，广播域之间来往的数据包都是由路由器中继的。因此，VLAN间的通信也需要路由器提供中继服务，这被称作“VLAN间路由”。</p>
<p>　　VLAN间路由，可以使用普通的路由器，也可以使用三层交换机。其中的具体内容，等有机会再细说吧。在这里希望大家先记住不同VLAN间互相通信时需要用到路由功能。</p>
<p>　　VLAN的访问链接(Access Link)</p>
<p>　　1.交换机的端口类型</p>
<p>　　交换机的端口，可以分为以下两种：</p>
<p>　　(1)访问链接(Access Link)</p>
<p>　　(2)汇聚链接(Trunk Link)</p>
<p>　　接下来就让我们来依次学习这两种不同端口的特征。这一讲，首先学习“访问链接”。</p>
<p>　　2.访问链接</p>
<p>　　访问链接，指的是“只属于一个VLAN，且仅向该VLAN转发数据帧”的端口。在大多数情况下，访问链接所连的是客户机。</p>
<p>　　通常设置VLAN的顺序是：</p>
<p>　　(1)生成VLAN</p>
<p>　　(2)设定访问链接(决定各端口属于哪一个VLAN)</p>
<p>　　设定访问链接的手法，可以是事先固定的、也可以是根据所连的计算机而动态改变设定。前者被称为“静态VLAN”、后者自然就是“动态VLAN”了。</p>
<p>　　● 静态VLAN——基于端口</p>
<p>　　静态VLAN又被称为基于端口的VLAN(PortBased VLAN)。顾名思义，就是明确指定各端口属于哪个VLAN的设定方法。</p>
<p><img src="/2021/04/30/VLAN/6.png"></p>
<p>　　由于需要一个个端口地指定，因此当网络中的计算机数目超过一定数字(比如数百台)后，设定操作就会变得烦杂无比。并且，客户机每次变更所连端口，都必须同时更改该端口所属VLAN的设定——这显然不适合那些需要频繁改变拓补结构的网络。</p>
<p>　　● 动态VLAN</p>
<p>　　另一方面，动态VLAN则是根据每个端口所连的计算机，随时改变端口所属的VLAN。这就可以避免上述的更改设定之类的操作。动态VLAN可以大致分为3类：</p>
<p>　　(1)基于MAC地址的VLAN(MAC Based VLAN)</p>
<p>　　(2)基于子网的VLAN(Subnet Based VLAN)</p>
<p>　　(3)基于用户的VLAN(User Based VLAN)</p>
<p>　　其间的差异，主要在于根据OSI参照模型哪一层的信息决定端口所属的VLAN。</p>
<p><img src="/2021/04/30/VLAN/VLAN%E9%97%B4%E5%88%92%E5%88%86.png"></p>
<p>　　● 基于MAC地址的VLAN</p>
<p>　　基于MAC地址的VLAN，就是通过查询并记录端口所连计算机上网卡的MAC地址来决定端口的所属。假定有一个MAC地址“A”被交换机设定为属于VLAN “10”，那么不论MAC地址为“A”的这台计算机连在交换机哪个端口，该端口都会被划分到VLAN 10中去。计算机连在端口1时，端口1属于VLAN 10;而计算机连在端口2时，则是端口2属于VLAN 10。</p>
<p><img src="/2021/04/30/VLAN/7.png"></p>
<p>　　由于是基于MAC地址决定所属VLAN的，因此可以理解为这是一种在OSI的第二层设定访问链接的办法。</p>
<p>　　但是，基于MAC地址的VLAN，在设定时必须调查所连接的所有计算机的MAC地址并加以登录。而且如果计算机交换了网卡，还是需要更改设定。</p>
<p>　　● 基于IP地址的VLAN</p>
<p>　　基于子网的VLAN，则是通过所连计算机的IP地址，来决定端口所属VLAN的。不像基于MAC地址的VLAN，即使计算机因为交换了网卡或是其他原因导致MAC地址改变，只要它的IP地址不变，就仍可以加入原先设定的VLAN。</p>
<p><img src="/2021/04/30/VLAN/8.png"></p>
<p>　　因此，与基于MAC地址的VLAN相比，能够更为简便地改变网络结构。IP地址是OSI参照模型中第三层的信息，所以我们可以理解为基于子网的VLAN是一种在OSI的第三层设定访问链接的方法。</p>
<p>　　基于用户的VLAN，则是根据交换机各端口所连的计算机上当前登录的用户，来决定该端口属于哪个VLAN。这里的用户识别信息，一般是计算机操作系统登录的用户，比如可以是Windows域中使用的用户名。这些用户名信息，属于OSI第四层以上的信息。</p>
<p>　　总的来说，决定端口所属VLAN时利用的信息在OSI中的层面越高，就越适于构建灵活多变的网络。</p>
<p>　　VLAN的汇聚链接(Trunk Link)</p>
<p>　　1.需要设置跨越多台交换机的VLAN时……</p>
<p>　　到此为止，我们学习的都是使用单台交换机设置VLAN时的情况。那么，如果需要设置跨越多台交换机的VLAN时又如何呢?</p>
<p>　　在规划企业级网络时，很有可能会遇到隶属于同一部门的用户分散在同一座建筑物中的不同楼层的情况，这时可能就需要考虑到如何跨越多台交换机设置VLAN的问题了。假设有如下图所示的网络，且需要将不同楼层的A、C和B、D设置为同一个VLAN。</p>
<p><img src="/2021/04/30/VLAN/9.png"></p>
<p>　　这时最关键的就是“交换机1和交换机2该如何连接才好呢?”</p>
<p>　　最简单的方法，自然是在交换机1和交换机2上各设一个红、蓝VLAN专用的接口并互联了。</p>
<p><img src="/2021/04/30/VLAN/10.png"></p>
<p>　　但是，这个办法从扩展性和管理效率来看都不好。例如，在现有网络基础上再新建VLAN时，为了让这个VLAN能够互通，就需要在交换机间连接新的网线。建筑物楼层间的纵向布线是比较麻烦的，一般不能由基层管理人员随意进行。并且，VLAN越多，楼层间(严格地说是交换机间)互联所需的端口也越来越多，交换机端口的利用效率低是对资源的一种浪费、也限制了网络的扩展。</p>
<p>　　为了避免这种低效率的连接方式，人们想办法让交换机间互联的网线集中到一根上，这时使用的就是汇聚链接(Trunk Link)。</p>
<p>　　2.何谓汇聚链接?</p>
<p>　　汇聚链接(Trunk Link)指的是能够转发多个不同VLAN的通信的端口。</p>
<p>　　汇聚链路上流通的数据帧，都被附加了用于识别分属于哪个VLAN的特殊信息。</p>
<p>　　现在再让我们回过头来考虑一下刚才那个网络如果采用汇聚链路又会如何呢?用户只需要简单地将交换机间互联的端口设定为汇聚链接就可以了。这时使用的网线还是普通的UTP线，而不是什么其他的特殊布线。图例中是交换机间互联，因此需要用交叉线来连接。</p>
<p>　　接下来，让我们具体看看汇聚链接是如何实现跨越交换机间的VLAN的。</p>
<p>　　A发送的数据帧从交换机1经过汇聚链路到达交换机2时，在数据帧上附加了表示属于红色VLAN的标记。</p>
<p>　　交换机2收到数据帧后，经过检查VLAN标识发现这个数据帧是属于红色VLAN的，因此去除标记后根据需要将复原的数据帧只转发给其他属于红色VLAN的端口。这时的转送，是指经过确认目标MAC地址并与MAC地址列表比对后只转发给目标MAC地址所连的端口。只有当数据帧是一个广播帧、多播帧或是目标不明的帧时，它才会被转发到所有属于红色VLAN的端口。</p>
<p>　　蓝色VLAN发送数据帧时的情形也与此相同。</p>
<p><img src="/2021/04/30/VLAN/11.png"></p>
<p>　　通过汇聚链路时附加的VLAN识别信息，有可能支持标准的“IEEE 802.1Q”协议，也可能是Cisco产品独有的“ISL(Inter Switch Link)”。如果交换机支持这些规格，那么用户就能够高效率地构筑横跨多台交换机的VLAN。</p>
<p>　　另外，汇聚链路上流通着多个VLAN的数据，自然负载较重。因此，在设定汇聚链接时，有一个前提就是必须支持100Mbps以上的传输速度。</p>
<p>　　另外，默认条件下，汇聚链接会转发交换机上存在的所有VLAN的数据。换一个角度看，可以认为汇聚链接(端口)同时属于交换机上所有的VLAN。由于实际应用中很可能并不需要转发所有VLAN的数据，因此为了减轻交换机的负载、也为了减少对带宽的浪费，我们可以通过用户设定限制能够经由汇聚链路互联的VLAN。</p>
<p>　　关于IEEE 802.1Q和ISL的具体内容，将在下一讲中提到。</p>
<p>　　3.访问链接的总结</p>
<p>　　综上所述，设定访问链接的手法有静态VLAN和动态VLAN两种，其中动态VLAN又可以继续细分成几个小类。</p>
<p>　　其中基于子网的VLAN和基于用户的VLAN有可能是网络设备厂商使用独有的协议实现的，不同厂商的设备之间互联有可能出现兼容性问题;因此在选择交换机时，一定要注意事先确认。</p>
<p>　　下表总结了静态VLAN和动态VLAN的相关信息。</p>
<p>　　种类解说</p>
<p>　　静态VLAN(基于端口的VLAN)将交换机的各端口固定指派给VLAN</p>
<p>　　动态VLAN基于MAC地址的VLAN根据各端口所连计算机的MAC地址设定</p>
<p>　　基于子网的VLAN根据各端口所连计算机的IP地址设定</p>
<p>　　基于用户的VLAN根据端口所连计算机上登录用户设定</p>
<p>　　VLAN的汇聚方式——IEEE802.1Q与ISL</p>
<p>　　1.汇聚方式</p>
<p>　　在交换机的汇聚链接上，可以通过对数据帧附加VLAN信息，构建跨越多台交换机的VLAN。</p>
<p>　　附加VLAN信息的方法，最具有代表性的有：</p>
<p>　　(1)IEEE 802.1Q</p>
<p>　　(2)ISL</p>
<p>　　现在就让我们看看这两种协议分别如何对数据帧附加VLAN信息。</p>
<p>　　2.IEEE 802.1Q</p>
<p>　　IEEE 802.1Q，俗称“Dot One Q”，是经过IEEE认证的对数据帧附加VLAN识别信息的协议。</p>
<p>　　在此，请大家先回忆一下以太网数据帧的标准格式。</p>
<p>　　IEEE 802.1Q所附加的VLAN识别信息，位于数据帧中“发送源MAC地址”与“类别域”(Type Field)之间。具体内容为2字节的TPID(Tag Protocol IDentifier)和2字节的TCI(Tag Control Information)，共计4字节。</p>
<p>　　在数据帧中添加了4字节的内容，那么CRC值自然也会有所变化。这时数据帧上的CRC是插入TPID、TCI后，对包括它们在内的整个数据帧重新计算后所得的值。</p>
<p><img src="/2021/04/30/VLAN/12.png"></p>
<p><img src="/2021/04/30/VLAN/tag.png"></p>
<p>　　而当数据帧离开汇聚链路时，TPID和TCI会被去除，这时还会进行一次CRC的重新计算。</p>
<p>　　TPID字段在以太网报文中所处位置与不带VLAN Tag的报文中协议类型字段所处位置相同。TPID的值固定为0x8100，它标示网络帧承载的802.1Q类型，交换机通过它来确定数据帧内附加了基于IEEE 802.1Q的VLAN信息。而实质上的VLAN ID，是TCI中的12位元。由于总共有12位，因此最多可供识别4096个VLAN。</p>
<p>　　基于IEEE 802.1Q附加的VLAN信息，就像在传递物品时附加的标签。因此，它也被称作“标签型VLAN”(Tagging VLAN)。</p>
<p>　　3.ISL(Inter Switch Link)</p>
<p>　　ISL，是Cisco产品支持的一种与IEEE 802.1Q类似的、用于在汇聚链路上附加VLAN信息的协议。</p>
<p>　　使用ISL后，每个数据帧头部都会被附加26字节的“ISL包头(ISL Header)”，并且在帧尾带上通过对包括ISL包头在内的整个数据帧进行计算后得到的4字节CRC值。换而言之，就是总共增加了30字节的信息。</p>
<p>　　在使用ISL的环境下，当数据帧离开汇聚链路时，只要简单地去除ISL包头和新CRC就可以了。由于原先的数据帧及其CRC都被完整保留，因此无需重新计算CRC。</p>
<p><img src="/2021/04/30/VLAN/13.png"></p>
<p>　　ISL有如用ISL包头和新CRC将原数据帧整个包裹起来，因此也被称为“封装型VLAN”(Encapsulated VLAN)。</p>
<p>　　需要注意的是，不论是IEEE802.1Q的“Tagging VLAN”，还是ISL的“Encapsulated VLAN”，都不是很严密的称谓。不同的书籍与参考资料中，上述词语有可能被混合使用，因此需要大家在学习时格外注意。</p>
<p>　　并且由于ISL是Cisco独有的协议，因此只能用于Cisco网络设备之间的互联。</p>
<h2 id="VLAN间路由"><a href="#VLAN间路由" class="headerlink" title="VLAN间路由"></a>VLAN间路由</h2><p>1.VLAN间路由的必要性</p>
<p>　　根据目前为止学习的知识，我们已经知道两台计算机即使连接在同一台交换机上，只要所属的VLAN不同就无法直接通信。接下来我们将要学习的就是如何在不同的VLAN间进行路由，使分属不同VLAN的主机能够互相通信。</p>
<p>　　首先，先来复习一下为什么不同VLAN间不通过路由就无法通信。在LAN内的通信，必须在数据帧头中指定通信目标的MAC地址。而为了获取MAC地址，TCP/IP协议下使用的是ARP。ARP解析MAC地址的方法，则是通过广播。也就是说，如果广播报文无法到达，那么就无从解析MAC地址，亦即无法直接通信。</p>
<p>　　计算机分属不同的VLAN，也就意味着分属不同的广播域，自然收不到彼此的广播报文。因此，属于不同VLAN的计算机之间无法直接互相通信。为了能够在VLAN间通信，需要利用OSI参照模型中更高一层——网络层的信息(IP地址)来进行路由。关于路由的具体内容，以后有机会再详细解说吧。</p>
<p>　　路由功能，一般主要由路由器提供。但在今天的局域网里，我们也经常利用带有路由功能的交换机——三层交换机(Layer 3 Switch)来实现。接下来就让我们分别看看使用路由器和三层交换机进行VLAN间路由时的情况。</p>
<p>2.使用路由器进行VLAN间路由</p>
<p>　　在使用路由器进行VLAN间路由时，与构建横跨多台交换机的VLAN时的情况类似，我们还是会遇到“该如何连接路由器与交换机”这个问题。路由器和交换机的接线方式，大致有以下两种：</p>
<p>　　(1)将路由器与交换机上的每个VLAN分别连接</p>
<p>　　(2)不论VLAN有多少个，路由器与交换机都只用一条网线连接</p>
<p>　　最容易想到的，当然还是“把路由器和交换机以VLAN为单位分别用网线连接”了。将交换机上用于和路由器互联的每个端口设为访问链接(Access Link)，然后分别用网线与路由器上的独立端口互联。如下图所示，交换机上有2个VLAN，那么就需要在交换机上预留2个端口用于与路由器互联;路由器上同样需要有2个端口;两者之间用2条网线分别连接。</p>
<p><img src="/2021/04/30/VLAN/14.png"></p>
<p>　　如果采用这个办法，大家应该不难想象它的扩展性很成问题。每增加一个新的VLAN，都需要消耗路由器的端口和交换机上的访问链接，而且还需要重新布设一条网线。而路由器，通常不会带有太多LAN接口的。新建VLAN时，为了对应增加的VLAN所需的端口，就必须将路由器升级成带有多个LAN接口的高端产品，这部分成本、还有重新布线所带来的开销，都使得这种接线法成为一种不受欢迎的办法。</p>
<p>　　那么，第二种办法“不论VLAN数目多少，都只用一条网线连接路由器与交换机”呢?当使用一条网线连接路由器与交换机、进行VLAN间路由时，需要用到汇聚链接。</p>
<p>　　具体实现过程为：首先将用于连接路由器的交换机端口设为汇聚链接(Trunk Link)，而路由器上的端口也必须支持汇聚链路。双方用于汇聚链路的协议自然也必须相同。接着在路由器上定义对应各个VLAN的“子接口”(Sub Interface)。尽管实际与交换机连接的物理端口只有一个，但在理论上我们可以把它分割为多个虚拟端口。</p>
<p>　　VLAN将交换机从逻辑上分割成了多台，因而用于VLAN间路由的路由器，也必须拥有分别对应各个VLAN的虚拟接口。</p>
<p><img src="/2021/04/30/VLAN/15.png"></p>
<p>　　采用这种方法的话，即使之后在交换机上新建VLAN，仍只需要一条网线连接交换机和路由器。用户只需要在路由器上新设一个对应新VLAN的子接口就可以了。与前面的方法相比，扩展性要强得多，也不用担心需要升级LAN接口数不足的路由器或是重新布线。</p>
<p>3.同一VLAN内的通信</p>
<p>　　接下来，我们继续学习使用汇聚链路连接交换机与路由器时，VLAN间路由是如何进行的。如下图所示，为各台计算机以及路由器的子接口设定IP地址。</p>
<p><img src="/2021/04/30/VLAN/16.png"></p>
<p>　　红色VLAN(VLAN ID=1)的网络地址为192.168.1.0/24，蓝色VLAN(VLAN ID=2)的网络地址为192.168.2.0/24。各计算机的MAC地址分别为A/B/C/D，路由器汇聚链接端口的MAC地址为R。交换机通过对各端口所连计算机MAC地址的学习，生成如下的MAC地址列表。</p>
<p>　　首先考虑计算机A与同一VLAN内的计算机B之间通信时的情形。</p>
<p>　　计算机A发出ARP请求信息，请求解析B的MAC地址。交换机收到数据帧后，检索MAC地址列表中与收信端口同属一个VLAN的表项。结果发现，计算机B连接在端口2上，于是交换机将数据帧转发给端口2，最终计算机B收到该帧。收发信双方同属一个VLAN之内的通信，一切处理均在交换机内完成。</p>
<p><img src="/2021/04/30/VLAN/17.png"></p>
<p>4.不同VLAN间的通信</p>
<p>　　接下来是这一讲的核心内容，不同VLAN间的通信。让我们来考虑一下计算机A与计算机C之间通信时的情况。</p>
<p><img src="/2021/04/30/VLAN/18.png"></p>
<p>　　计算机A从通信目标的IP地址(192.168.2.1)得出C与本机不属于同一个网段。因此会向设定的默认网关(DefaultGateway，GW)转发数据帧。在发送数据帧之前，需要先用ARP获取路由器的MAC地址。</p>
<p>　　得到路由器的MAC地址R后，接下来就是按图中所示的步骤发送往C去的数据帧。①的数据帧中，目标MAC地址是路由器的地址R、但内含的目标IP地址仍是最终要通信的对象C的地址。这一部分的内容，涉及到局域网内经过路由器转发时的通信步骤，有机会再详细解说吧。</p>
<p>　　交换机在端口1上收到①的数据帧后，检索MAC地址列表中与端口1同属一个VLAN的表项。由于汇聚链路会被看作属于所有的VLAN，因此这时交换机的端口6也属于被参照对象。这样交换机就知道往MAC地址R发送数据帧，需要经过端口6转发。</p>
<p>　　从端口6发送数据帧时，由于它是汇聚链接，因此会被附加上VLAN识别信息。由于原先是来自红色VLAN的数据帧，因此如图中②所示，会被加上红色VLAN的识别信息后进入汇聚链路。路由器收到②的数据帧后，确认其VLAN识别信息，由于它是属于红色VLAN的数据帧，因此交由负责红色VLAN的子接口接收。</p>
<p>　　接着，根据路由器内部的路由表，判断该向哪里中继。</p>
<p>　　由于目标网络192.168.2.0/24是蓝色VLAN，，且该网络通过子接口与路由器直连，因此只要从负责蓝色VLAN的子接口转发就可以了。这时，数据帧的目标MAC地址被改写成计算机C的目标地址;并且由于需要经过汇聚链路转发，因此被附加了属于蓝色VLAN的识别信息。这就是图中③的数据帧。</p>
<p>　　交换机收到③的数据帧后，根据VLAN标识信息从MAC地址列表中检索属于蓝色VLAN的表项。由于通信目标——计算机C连接在端口3上、且端口3为普通的访问链接，因此交换机会将数据帧去除VLAN识别信息后(数据帧④)转发给端口3，最终计算机C才能成功地收到这个数据帧。</p>
<p>　　进行VLAN间通信时，即使通信双方都连接在同一台交换机上，也必须经过：“发送方——交换机——路由器——交换机——接收方”这样一个流程。</p>
<p>　　三层交换机</p>
<p>　　1.使用路由器进行VLAN间路由时的问题</p>
<p>　　现在，我们知道只要能提供VLAN间路由，就能够使分属不同VLAN的计算机互相通信。但是，如果使用路由器进行VLAN间路由的话，随着VLAN之间流量的不断增加，很可能导致路由器成为整个网络的瓶颈。</p>
<p>　　交换机使用被称为ASIC(ApplicationSpecified Integrated Circuit)的专用硬件芯片处理数据帧的交换操作，在很多机型上都能实现以缆线速度(Wired Speed)交换。而路由器，则基本上是基于软件处理的。即使以缆线速度接收到数据包，也无法在不限速的条件下转发出去，因此会成为速度瓶颈。就VLAN间路由而言，流量会集中到路由器和交换机互联的汇聚链路部分，这一部分尤其特别容易成为速度瓶颈。并且从硬件上看，由于需要分别设置路由器和交换机，在一些空间狭小的环境里可能连设置的场所都成问题。</p>
<p>　　2.三层交换机(Layer 3 Switch)</p>
<p>　　为了解决上述问题，三层交换机应运而生。三层交换机，本质上就是“带有路由功能的(二层)交换机”。路由属于OSI参照模型中第三层网络层的功能，因此带有第三层路由功能的交换机才被称为“三层交换机”。</p>
<p>　　关于三层交换机的内部结构，可以参照下面的简图。</p>
<p><img src="/2021/04/30/VLAN/19.png"></p>
<p>　　在一台本体内，分别设置了交换机模块和路由器模块;而内置的路由模块与交换模块相同，使用ASIC硬件处理路由。因此，与传统的路由器相比，可以实现高速路由。并且，路由与交换模块是汇聚链接的，由于是内部连接，可以确保相当大的带宽。</p>
<p>　　● 使用三层交换机进行VLAN间路由(VLAN内通信)</p>
<p>　　在三层交换机内部数据究竟是怎样传播的呢?基本上，它和使用汇聚链路连接路由器与交换机时的情形相同。</p>
<p>　　假设有如下图所示的4台计算机与三层交换机互联。当使用路由器连接时，一般需要在LAN接口上设置对应各VLAN的子接口;而三层交换机则是在内部生成“VLAN接口”(VLAN Interface)。VLAN接口，是用于各VLAN收发数据的接口。(注：在Cisco的Catalyst系列交换机上，VLAN Interface被称为SVI——Switched Virtual Interface)</p>
<p><img src="/2021/04/30/VLAN/20.png"></p>
<p>　　为了与使用路由器进行VLAN间路由对比，让我们同样来考虑一下计算机A与计算机B之间通信时的情况。首先是目标地址为B的数据帧被发到交换机;通过检索同一VLAN的MAC地址列表发现计算机B连在交换机的端口2上;因此将数据帧转发给端口2。</p>
<p>　　● 使用三层交换机进行VLAN间路由(VLAN间通信)</p>
<p>　　接下来设想一下计算机A与计算机C间通信时的情形。针对目标IP地址，计算机A可以判断出通信对象不属于同一个网络，因此向默认网关发送数据(Frame 1)。</p>
<p>　　交换机通过检索MAC地址列表后，经由内部汇聚链接，将数据帧转发给路由模块。在通过内部汇聚链路时，数据帧被附加了属于红色VLAN的VLAN识别信息(Frame 2)。</p>
<p>　　路由模块在收到数据帧时，先由数据帧附加的VLAN识别信息分辨出它属于红色VLAN，据此判断由红色VLAN接口负责接收并进行路由处理。因为目标网络192.168.2.0/24是直连路由器的网络、且对应蓝色VLAN;因此，接下来就会从蓝色VLAN接口经由内部汇聚链路转发回交换模块。在通过汇聚链路时，这次数据帧被附加上属于蓝色VLAN的识别信息(Frame 3)。</p>
<p>　　交换机收到这个帧后，检索蓝色VLAN的MAC地址列表，确认需要将它转发给端口3。由于端口3是通常的访问链接，因此转发前会先将VLAN识别信息去除(Frame 4)。最终，计算机C成功地收到交换机转发来的数据帧。</p>
<p><img src="/2021/04/30/VLAN/21.png"></p>
<p>　　整体的流程，与使用外部路由器时的情况十分相似——都需要经过“发送方→交换模块→路由模块→交换模块→接收方”。</p>
<h2 id="加速VLAN间通信的手段"><a href="#加速VLAN间通信的手段" class="headerlink" title="加速VLAN间通信的手段"></a>加速VLAN间通信的手段</h2><p>　　1.流(Flow)</p>
<p>　　根据到此为止的学习，我们已经知道VLAN间路由，必须经过外部的路由器或是三层交换机的内置路由模块。但是，有时并不是所有的数据都需要经过路由器(或路由模块)。</p>
<p>　　例如，使用FTP(File Transfer Protocol)传输容量为数MB以上的较大的文件时，由于MTU的限制，IP协议会将数据分割成小块后传输、并在接收方重新组合。这些被分割的数据，“发送的目标”是完全相同的。发送目标相同，也就意味着同样的目标IP地址、目标端口号(注：特别强调一下，这里指的是TCP/UDP端口)。自然，源IP地址、源端口号也应该相同。这样一连串的数据流被称为“流”(Flow)。</p>
<p>　　只要将流最初的数据正确地路由以后，后继的数据理应也会被同样地路由。</p>
<p>　　据此，后继的数据不再需要路由器进行路由处理;通过省略反复进行的路由操作，可以进一步提高VLAN间路由的速度。</p>
<p><img src="/2021/04/30/VLAN/22.png"></p>
<p>　　2.加速VLAN间路由的机制</p>
<p>　　接下来，让我们具体考虑一下该如何使用三层交换机进行高速VLAN间路由。</p>
<p>　　首先，整个流的第一块数据，照常由交换机转发→路由器路由→再次由交换机转发到目标所连端口。这时，将第一块数据路由的结果记录到缓存里保存下来。需要记录的信息有：</p>
<p>　　(1)目标IP地址</p>
<p>　　(2)源IP地址</p>
<p>　　(3)目标TCP/UDP端口号</p>
<p>　　(4)源TCP/UDP端口号</p>
<p>　　(5)接收端口号(交换机)</p>
<p>　　(6)转发端口号(交换机)</p>
<p>　　(7)转发目标MAC地址</p>
<p>　　等等。</p>
<p>　　同一个流的第二块以后的数据到达交换机后，直接通过查询先前保存在缓存中的信息查出“转发端口号”后就可以转发给目标所连端口了。</p>
<p>　　这样一来，就不需要再一次次经由内部路由模块中继，而仅凭交换机内部的缓存信息就足以判断应该转发的端口。</p>
<p>　　这时，交换机会对数据帧进行由路由器中继时相似的处理，例如改写MAC地址、IP包头中的TTL和Check Sum校验码信息等。</p>
<p><img src="/2021/04/30/VLAN/23.png"></p>
<p>　　通过在交换机上缓存路由结果，实现了以缆线速度(Wired Speed)接收发送方传输来数据的数据、并且能够全速路由、转发给接收方。</p>
<p>　　需要注意的是，类似的加速VLAN间路由的手法多由各厂商独有的技术所实现，并且该功能的称谓也因厂商而异。例如，在Cisco的Catalyst系列交换机上，这种功能被称为“多层交换”(Multi Layer Switching)。另外，除了三层交换机的内部路由模块，外部路由器中的某些机型也支持类似的高速VLAN间路由机制。</p>
<h2 id="VLAN间路由举例"><a href="#VLAN间路由举例" class="headerlink" title="VLAN间路由举例"></a>VLAN间路由举例</h2><h3 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h3><ul>
<li>通过使用路由器可以实现VLAN间通信。</li>
<li>当路由器使用多臂的方式实现VLAN间的通信时，路由器的接口资源将受到极大的挑战，当VLAN数量特别多时，采用多臂路由的方式是不具备可行性的，并且此种方式的可扩展性并不高。</li>
<li>当路由器采用单臂的方式实现VLAN间通信时，与多臂路由相比，是一种更佳的选择，因为单臂的可扩展性更高、更经济。</li>
<li>但是单臂路由也存在一定的短板：（1）路由器与交换机之间的链路由于需承载所有VLAN间的通信数据，因此它的负载将变得非常高，尤其是当VLAN的数量特别多、VLAN间通信的流量特别大时，这段链路将变得不堪重负。（2）单臂链路也不具备冗余性，一旦链路发生故障，VLAN之间的通信也就无法再正常进行。</li>
<li>使用三层交换机（Layer 3 Switch）也可以实现VLAN间通信，并且能优化上述问题。</li>
</ul>
<h3 id="三层交换机"><a href="#三层交换机" class="headerlink" title="三层交换机"></a>三层交换机</h3><ul>
<li>三层交换机除了能够实现二层交换机所有功能，还支持路由功能。</li>
<li>三层交换机除了拥有二层接口外，还拥有三层接口。</li>
<li>VLANIF （VLAN Interface）VLAN接口就是一种非常重要的三层接口，这是一种逻辑接口，物理上并不存在。</li>
<li>在一台三层交换机上创建了一个VLAN时，就可以将交换机的物理接口(比如GE0/0/1)加入到该VLAN中，此时这些物理接口都是二层接口。与此同时，还能在交换机上配置这个VLAN对应的VLANIF，也就是这个VLAN对应的三层接口。</li>
<li>三层接口能够与同处于这个VLAN内的设备进行二层通信。另外VLANIF作为一个三层接口，拥有路由功能，可以进行IP地址配置，而通常情况下，这个IP地址会作为VLAN中设备的默认网关地址。</li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>如下图所示的网络拓扑中：</p>
<ul>
<li>交换机拥有两个VLAN，分别是VLAN 10及VLAN20，物理接口GE0/0/1, GE0/0/2及GE0/0/3都被配置为Access类型，其中GE0/0/1及GE0/0/2接口加入了VLAN10，而GE0/0/3接口则加入了VLAN20。</li>
<li>VLANIF 10配置了IP地址192.168.10.254, VLANIF 20则配置了IP地址192.168.20.254。</li>
<li>各VLAN内的PC都将其默认网关地址配置为相应VLAN的VLANIF IP地址。</li>
<li>由于交换机配置了VLAN IF接口，那么三层交换机同时拥有交换模块以及路由模块。</li>
</ul>
<p><img src="/2021/04/30/VLAN/%E4%B8%BE%E4%BE%8B.png"></p>
<h3 id="在三层交换机上，同网段二层数据交换"><a href="#在三层交换机上，同网段二层数据交换" class="headerlink" title="在三层交换机上，同网段二层数据交换"></a>在三层交换机上，同网段二层数据交换</h3><p>以PC1发送一份数据给PC2为例，大致过程如下：<br>（1）PC1构造单播数据帧：</p>
<ul>
<li>PC1的上层协议产生的数据载荷到了网络层，数据载荷被封装IP头部，在IP头部中，源IP地址是192.168.10.1，目的IP地址是192.168.10.2。</li>
<li>数据载荷被封装好IP头部后，数据下发到网卡，继续为其进行数据链路层封装，将其封装成以太网数据帧，该数据帧的源MAC地址为PC1的网卡MAC地址，而目的MAC地址为192.168.10.2这个IP地址对应的MAC地址。</li>
<li>PC1查询ARP表试图寻找相应的ARP表项，初始时PC1的ARP表中并没有相应的表项，因此PCl发送一个广播的ARP Request去请求PC2的MAC地址。</li>
</ul>
<p>（2）交换机处理PC1发送的广播ARP Request数据帧：</p>
<ul>
<li>ARP Request的广播数据帧到达了交换机的GE0/0/1接口后，会被打上VLAN10的Tag。</li>
<li>交换机通过读取数据帧头部，发现这是一个广播数据帧，此时有三个动作：<br>a.将收到的ARP Request广播数据帧在所有加入VLAN10的端口上泛洪，b.将数据帧解封装，将数据帧帧中的源Mac地址、VLAN10、GE0/0/1形成一条新的Mac地址表项c 另外交换机通过数据帧头部的“类型”字段发现该帧内封装着一个ARP报文，将数据帧解封装后上送到自己的ARP协议模块，而ARP模块发现这个ARP报文请求的是192.168.10.2这个IP地址的MAC地址，该IP地址并非自己所有，因此它直接忽略这个数据帧。</li>
</ul>
<p>（3）PC2处理泛洪得到的广播ARP Request数据帧：</p>
<ul>
<li>交换机在VLAN10内泛洪了PC1发送的ARP Request，因此PC2会收到这个数据帧，它将记录相应的ARP表项（PC1的IP地址和Mac地址），</li>
<li>通过解析ARP Request广播数据帧，发现该报文请求的IP地址就是自己，于是会发送一个单播的ARP Reply帧进行回应。</li>
</ul>
<p>（4）交换机处理PC2回应的单播ARP Reply数据帧：</p>
<ul>
<li>交换机收到这个数据帧，解析数据帧头部，将数据帧帧中的源Mac地址、VLAN10、GE0/0/2形成一条新的Mac地址表项</li>
<li>另外解析数据帧头部后，通过查询MAC地址表并找到目的MAC地址所关联的出接口（通过PC1发送的广播ARP Request报文学习的Mac地址表项），将数据帧从GE0/0/1接口发出。</li>
</ul>
<p>（5）PC1处理交换机传递的单播ARP Reply数据帧：</p>
<ul>
<li>PC1收到了这个ARP Reply，解析数据帧，可以获知了192.168.10.2对应的MAC地址，形成相应的ARP表项（PC2的IP地址和Mac地址）</li>
<li>PC1获取PC2的Mac地址后，可以继续封装单播数据帧，然后将单播数据帧从网卡发出。</li>
</ul>
<p>（6）交换机处理PC1发送的单播数据帧：</p>
<ul>
<li>交换机收到这个数据帧，发现这是一个单播数据帧，于是在MAC地址表中查询目的MAC地址，找到匹配的表项后（PC2回应的ARP Reply报文学习的Mac地址表项），将该帧从GE0/0/2接口发出。</li>
</ul>
<p>（7）PC2处理交换机传递的单播数据帧：</p>
<ul>
<li>PC2收到这个数据帧后，解析以太网头部，发现目的Mac地址正是自己网卡的Mac地址，通过数据帧头部的“类型”字段发现该帧内封装着一个IP数据报</li>
<li>将IP数据报上送IP协议栈，继续继续IP头部，发现目的IP地址也是自己网卡的IP地址，通IP数据报头部中的“协议”字段发现数据报内还封装上层应用协议的数据</li>
<li>将上层应用协议的数据上送给上层协议模块处理数据。</li>
</ul>
<h3 id="在三层交换机上，跨网段三层数据交换"><a href="#在三层交换机上，跨网段三层数据交换" class="headerlink" title="在三层交换机上，跨网段三层数据交换"></a>在三层交换机上，跨网段三层数据交换</h3><p>以PC1发送一份数据给PC3为例，大致过程如下:<br>（1）PC1构造单播数据帧：</p>
<ul>
<li>PC1的上层协议产生的数据载荷到了网络层，数据载荷被封装IP头部，源IP地址是192.168.10.1，目的IP地址是192.168.20.1。</li>
<li>将数据帧下送到了PC1的网卡，网卡将其封装成以太网数据帧，由于数据包的目的IP地址与本机不在相同网段（PC2可以通过将IP地址与地址掩码做 &amp;操作，确定其IP网段范围），这意味着PC1需要先把报文发送到默认网关，因此数据帧的目的MAC地址需填写网关(192.168.10.254)的MAC地址。</li>
<li>PC1在ARP表中查询192.168.10.254，发现并没有匹配的表项，因此它发送一个广播的ARP Request试图查询网关的MAC地址。</li>
</ul>
<p>（2）交换机处理广播ARP Request数据帧：</p>
<ul>
<li>广播ARP Request数据帧到达了交换机的GE0/0/1接口，会被打上VLAN10的Tag。</li>
<li>交换机通过读取数据帧头部，发现这是一个广播数据帧，有三个动作：<br>a. 将广播报文在加入VLAN 10的端口上进行泛洪，b.将数据帧解封装，将数据帧帧中的源Mac地址、VLAN10、GE0/0/1形成一条新的Mac地址表项c 另外交换机通过数据帧头部的“类型”字段发现该帧内封装着一个ARP报文，将数据帧解封装后上送到自己的ARP协议模块，而ARP模块发现这个ARP报文请求的是192.168.10.254这个IP地址的MAC地址，恰好VLANIF 10的IP地址就是192.168.10.254，因此它直接发送一个ARP Reply对PCI进行回应。</li>
</ul>
<p>（3）PC1处理收到的ARP Reply报文：</p>
<ul>
<li>PC1收到了这个ARP Reply，获知了192.168.10.254对应的MAC地址，因此继续封装数据帧，然后将数据帧从网卡发出。</li>
</ul>
<p>（4）交换机处理收到的单播数据帧：</p>
<ul>
<li>交换机收到这个数据帧，发现这是一个单播数据帧，而且该帧的目的MAC地址正是本机的MAC地址，因此交换机将数据帧解封装，并将里面的数据上送到IP模块进行处理（通过数据帧头部的“类型”字段可以得知数据帧封装着一个IP数据报）。</li>
<li>IP模块读取数据包的目的IP地址后，发现目的IP地址并非本机的IP地址，于是它在路由表中查询这个地址，结果发现有一条本地直连路由匹配（最长掩码匹配原则），而该直连路由的出接口是VLANIF20，因此交换机重新将这个数据包封装成帧。</li>
<li>新的以太网帧头中，源MAC地址填写的是交换机的MAC地址，而目的MAC则需填写192.168.20.1的MAC地址，如果交换机的ARP表中没有相关的表项，那么它需要在VLAN20中发送广播ARPRequest去请求PC3的MAC地址（此过程和1-2过程类似，不在赘述），最后将封装好的数据帧从GE0/0/3接口发出。</li>
</ul>
<p>（5）PC3处理交换机传递的单播数据帧：</p>
<ul>
<li>PC3收到这个数据帧后，解析以太网帧头部，发现目的Mac地址正是自己网卡的Mac地址，通过数据帧头部的“类型”字段发现该帧内封装着一个IP数据报</li>
<li>将IP数据报上送IP协议栈，继续继续IP头部，发现目的IP地址也是自己网卡的IP地址，通IP数据报头部中的“协议”字段发现数据报内还封装上层应用协议的数据</li>
<li>将上层应用协议的数据上送给上层协议模块处理数据。</li>
</ul>
<h2 id="传统型路由器存在的意义"><a href="#传统型路由器存在的意义" class="headerlink" title="传统型路由器存在的意义"></a>传统型路由器存在的意义</h2><p>　　1.路由器的必要性</p>
<p>　　三层交换机的价格，在问世之初非常昂贵，但是现在它们的价格已经下降了许多。目前国外一些廉价机型的售价，折合成人民币后仅为一万多元，而且还在继续下降中。</p>
<p>　　既然三层交换机能够提供比传统型路由器更为高速的路由处理，那么网络中还有使用路由器的必要吗?</p>
<p>　　答案是：“是”。</p>
<p>　　使用路由器的必要性，主要表现在以下几个方面：</p>
<p>　　(1)用于与WAN连接</p>
<p>　　三层交换机终究是“交换机”。也就是说，绝大多数机型只配有LAN(以太网)接口。在少数高端交换机上也有用于连接WAN的串行接口或是ATM接口，但在大多数情况下，连接WAN还是需要用到路由器。</p>
<p>　　(2)保证网络安全</p>
<p>　　在三层交换机上，通过数据包过滤也能确保一定程度的网络安全。但是使用路由器所提供的各种网络安全功能，用户可以构建更为安全可靠的网络。</p>
<p>　　路由器提供的网络安全功能中，除了最基本的数据包过滤功能外，还能基于IPSec构建VPN(VirtualPrivate Network)、利用RADIUS进行用户认证等等。</p>
<p>　　(3)支持除TCP/IP以外的异构网络架构</p>
<p>　　尽管TCP/IP已经成为当前网络协议架构的主流，但还有不少网络利用Novell Netware下的IPX/SPX或Macintosh下的AppleTalk等网络协议。三层交换机中，除了部分高端机型外基本上还只支持TCP/IP。因此，在需要使用除TCP/IP之外其他网络协议的环境下，路由器还是必不可少的。</p>
<p>　　注：在少数高端交换机上，也能支持上述路由器的功能。例如Cisco的Catalyst 6500系列，就可以选择与WAN连接的接口模块;还有可选的基于IPSec实现VPN的模块;并且也能支持TCP/IP以外的其他网络协议。</p>
<p>　　2.路由器和交换机配合构建LAN的实例</p>
<p>　　下面让我们来看一个路由器和交换机搭配构建LAN的实例。</p>
<p><img src="/2021/04/30/VLAN/24.png"></p>
<p>　　利用在各楼层配置的二层交换机定义VLAN，连接TCP/IP客户计算机。各楼层间的VLAN间通信，利用三层交换机的高速路由加以实现。如果网络环境要求高可靠性，还可以考虑冗余配置三层交换机。</p>
<p>　　与WAN的连接，则通过带有各种网络接口的路由器进行。并且，通过路由器的数据包过滤和VPN等功能实现网络安全。此外，使用路由器还能支持Novell Netware等TCP/IP之外的网络。</p>
<p>　　只有在充分掌握了二层、三层交换机以及传统路由器的基础上，才能做到物竞其用，构筑出高效率、高性价比的网络。</p>
<h2 id="使用VLAN设计局域网"><a href="#使用VLAN设计局域网" class="headerlink" title="使用VLAN设计局域网"></a>使用VLAN设计局域网</h2><p>　　1.使用VLAN设计局域网的特点</p>
<p>　　通过使用VLAN构建局域网，用户能够不受物理链路的限制而自由地分割广播域。</p>
<p>　　另外，通过先前提到的路由器与三层交换机提供的VLAN间路由，能够适应灵活多变的网络构成。</p>
<p>　　但是，由于利用VLAN容易导致网络构成复杂化，因此也会造成整个网络的组成难以把握。</p>
<p>　　可以这样说，在利用VLAN时，除了有“网络构成灵活多变”这个优点外，还搭配着“网络构成复杂化”这个缺点。</p>
<p>　　下面，就让我们来看看具体的实例。</p>
<p>　　2.不使用VLAN的局域网中网络构成的改变</p>
<p>　　假设有如图所示的由1台路由器、2台交换机构成的“不使用VLAN构建”的网络。</p>
<p><img src="/2021/04/30/VLAN/25.png"></p>
<p>　　图中的路由器，带有2个LAN接口。左侧的网络是192.168.1.0/24，右侧是192.168.2.0/24。</p>
<p>　　现在如果想将192.168.1.0/24这个网络上的计算机A转移到192.168.2.0/24上去，就需要改变物理连接、将A接到右侧的交换机上。</p>
<p>　　并且，当需要新增一个地址为192.168.3.0/24的网络时，还要在路由器上再占用一个LAN接口并添置一台交换机。而由于这台路由器上只带了2个LAN接口，因此为了新增网络还必须将路由器升级为带有3个以上LAN接口的产品。</p>
<p>　　3.使用VLAN的局域网中网络构成的改变</p>
<p>　　接下来再假设有一个由1台路由器、2台交换机构成的“使用VLAN”的局域网。交换机与交换机、交换机与路由器之间均为汇聚链路;并且假设192.168.1.0/24对应红色VLAN、192.168.2.0/24对应蓝色VLAN。</p>
<p><img src="/2021/04/30/VLAN/26.png"></p>
<p>　　需要将连接在交换机1上192.168.1.0/24这个网段的计算机A转属192.168.2.0/24时，无需更改物理布线。只要在交换机上生成蓝色VLAN，然后将计算机A所连的端口1加入到蓝色VLAN中去，使它成为访问链接即可。</p>
<p>　　然后，根据需要设定计算机A的IP地址、默认网关等信息就可以了。如果IP地址相关的设定是由DHCP获取的，那么在客户机方面无需进行任何设定修改，就可以在不同网段间移动。</p>
<p>　　利用VLAN后，我们可以在免于改动任何物理布线的前提下，自由进行网络的逻辑设计。如果所处的工作环境恰恰需要经常改变网络布局，那么利用VLAN的优势就非常明显了。</p>
<p>　　并且，当需要新增一个地址为192.168.3.0/24的网段时，也只需要在交换机上新建一个对应192.168.3.0/24的VLAN，并将所需的端口加入它的访问链路就可以了。</p>
<p>　　如果网络环境中还需要利用外部路由器，则只要在路由器的汇聚端口上新增一个子接口的设定就可以完成全部操作，而不需要消耗更多的物理接口(LAN接口)。要使用的是三层交换机内部的路由模块，则只需要新设一个VLAN接口即可。</p>
<p>　　网络环境的成长，往往是难以预测的，很可能经常会出现需要分割现有网络或是增加新网络的情况。而充分活用VLAN后，就可以轻易地解决这些问题。</p>
<p>　　4.利用VLAN而导致的网络结构复杂化</p>
<p>　　虽然利用VLAN可以灵活地构建网络，但是同时，它也带来了网络结构复杂化的问题。</p>
<p>　　特别是由于数据流纵横交错，一旦发生故障时，准确定位并排除故障会比较困难。</p>
<p>　　为了便于理解数据流向的复杂化，假设有下图所示的网络。计算机A向计算机C发送数据时，数据流的整体走向如下：</p>
<p>　　计算机A→交换机1→路由器→交换机1→交换机2→计算机C</p>
<p><img src="/2021/04/30/VLAN/27.png"></p>
<p><img src="/2021/04/30/VLAN/28.png"></p>
<p>　　首先计算机A向交换机1送出数据(①)，其后数据被转发给路由器(②)进行VLAN间路由。路由后的数据，再从汇聚链路返回交换机1(③)。由于通信目标计算机C并不直连在交换机1上，因此还需要经过汇聚链路转发到交换机2(④)。在交换机2上，数据最终被转发到C所连的端口2上，这才完成整个流程(⑤)。</p>
<p>　　在这个例子中，仅由2台交换机构成网络，其数据流已经如此复杂，如果构建横跨多台交换机的VLAN的话，每个数据流的流向显然会更加难以把握。</p>
<p>　　5. 网络的逻辑结构与物理结构</p>
<p>　　为了对应日渐复杂化的数据流，管理员需要从“逻辑结构”与“物理结构”两方面入手，把握好网络的现状。</p>
<p>　　物理结构，指的是从物理层和数据链路层观察到的网络的现状，表示了网络的物理布线形态和VLAN的设定等等。</p>
<p>　　而逻辑结构，则表示从网络层以上的层面观察到的网络结构。下面我们就试着以路由器为中心分析一个IP网络的逻辑结构。</p>
<p>　　还是先前的那个例子，描绘了布线形态和VLAN设定的“物理结构”如下图所示。</p>
<p><img src="/2021/04/30/VLAN/29.png"></p>
<p>　　分析这个物理结构并转换成以路由器为中心的逻辑结构后，会得到如下的逻辑结构图。当我们需要进行路由或是数据包过滤的设定时，都必须在逻辑结构的基础上进行。</p>
<p><img src="/2021/04/30/VLAN/30.png"></p>
<p>　　把握这两种网络结构图的区别是十分重要的，特别是在VLAN和三层交换机大行其道的现代企业级网络当中。</p>
<h2 id="VLAN以太网二层接口类型"><a href="#VLAN以太网二层接口类型" class="headerlink" title="VLAN以太网二层接口类型"></a>VLAN以太网二层接口类型</h2><h3 id="Access接口"><a href="#Access接口" class="headerlink" title="Access接口"></a>Access接口</h3><p>接收数据帧</p>
<ul>
<li>Untagged数据帧,打上PVID，接收。</li>
<li>Tagged数据帧，与PVID比较，相同则接收;不同则丢弃。</li>
</ul>
<p>发送数据帧</p>
<ul>
<li>VID与PVID比较，相同则剥离标签发送;不同则丢弃。</li>
</ul>
<p><img src="/2021/04/30/VLAN/Aceess.png"></p>
<h3 id="Trunk接口"><a href="#Trunk接口" class="headerlink" title="Trunk接口"></a>Trunk接口</h3><p>接收数据帧</p>
<ul>
<li>Untagged数据帧，打上PVID，且VID在允许列表中，则接收;VID不在允许列表,则丢弃。</li>
<li>Tagged数据帧，查看VID是否在允许列表中，在允许列表中，则接收;VID不在允许列表，则丢弃。</li>
</ul>
<p>发送数据帧</p>
<ul>
<li>VID在允许列表中，且VID与PVID一致，则剥离标签发送。</li>
<li>VID在允许列表，但VID与PVID不一致，则直接带标签发送。</li>
<li>不在允许列表中，则直接丢弃。</li>
</ul>
<p><img src="/2021/04/30/VLAN/Trunk.png"></p>
<h3 id="Hybrid接口-前两者混合接口"><a href="#Hybrid接口-前两者混合接口" class="headerlink" title="Hybrid接口(前两者混合接口)"></a>Hybrid接口(前两者混合接口)</h3><p>接收数据帧</p>
<ul>
<li>Untagged数据帧，打上PVID，且VID在允许列表中，则接收;VID不在允许列表中，则丢弃。</li>
<li>Tagged数据帧,查看VID是否在允许列表中，在允许列表中，则接收;VID不在允许列表，则丢弃。</li>
</ul>
<p>发送数据帧</p>
<ul>
<li>VID不在允许列表中，直接丢弃。</li>
<li>VID在Untagged列表中，剥离标签发送。</li>
<li>VID在Tagged列表中，带标签直接发送。</li>
</ul>
<p><img src="/2021/04/30/VLAN/Hybrid.png"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="/2021/04/30/VLAN/31.png"></p>
<h2 id="VLAN基础配置命令"><a href="#VLAN基础配置命令" class="headerlink" title="VLAN基础配置命令"></a>VLAN基础配置命令</h2><p>1.创建VLAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei] vlan vlan-id</span><br></pre></td></tr></table></figure>
<p>通过此命令创建VLAN并进入VLAN视图，如果VLAN已存在，直接进入该VLAN的视图。</p>
<p>vlan-id是整数形式，取值范围是1~4094。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei] vlan batch &#123; vlan-id1 [ to vlan-id2 ] &#125;</span><br></pre></td></tr></table></figure>
<p>通过此命令批量创建VLAN。其中:</p>
<ul>
<li>batch:指定批量创建的VLAN ID。</li>
<li>vlan-id1:表示第一个VLAN的编号。</li>
<li>vlan-id2:表示最后一个VLAN的编号。</li>
</ul>
<h3 id="Access接口配置命令"><a href="#Access接口配置命令" class="headerlink" title="Access接口配置命令"></a>Access接口配置命令</h3><p>1.配置接口类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port link-type access</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置接口的链路类型为Access。<br>2.配置Access接口的缺省VLAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port default vlan vlan-id</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置接口的缺省VLAN并同时加入这个VLAN。</p>
<ul>
<li>vlan-id:配置缺省VLAN的编号。整数形式，取值范围是1~4094。</li>
</ul>
<h3 id="Trunk接口配置命令"><a href="#Trunk接口配置命令" class="headerlink" title="Trunk接口配置命令"></a>Trunk接口配置命令</h3><p>1.配置接口类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port link-type trunk</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置接口的链路类型为Trunk。<br>2.配置Trunk接口加入指定VLAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port trunk allow-pass vlan &#123; &#123; vlan-id1 [ to vlan-id2 ] &#125;| all &#125;</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置Trunk类型接口加入的VLAN。<br>3.(可选)配置Trunk接口的缺省VLAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port trunk pvid vlan vlan-id</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置Trunk类型接口的缺省VLAN。</p>
<h3 id="Hybrid接口配置命令"><a href="#Hybrid接口配置命令" class="headerlink" title="Hybrid接口配置命令"></a>Hybrid接口配置命令</h3><p>1.配置接口类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEtherneto&#x2F;0&#x2F;1] port link-type hybrid</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置接口的链路类型为Hybrid。<br>2.配置Hybrid接口加入指定VLAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port hybrid untagged vlan &#123; &#123; vlan-id1 [ to vlan-id2 ] &#125; | all &#125;</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置Hybrid类型接口加入的VLAN，这些VLAN的帧以Untagged方式通过接口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port hybrid tagged vlan &#123; &#123; vlan-id1 [ to vlan-id2] &#125; | all &#125;</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置Hybrid类型接口加入的VLAN，这些VLAN的帧以Tagged方式通过接口。<br>3.(可选)配置Hybrid接口的缺省VLAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port hybrid pvid vlan vlan-id</span><br></pre></td></tr></table></figure>
<p>在接口视图下，配置Hybrid类型接口的缺省VLAN。</p>
<h3 id="基于MAC地址划分VLAN配置命令"><a href="#基于MAC地址划分VLAN配置命令" class="headerlink" title="基于MAC地址划分VLAN配置命令"></a>基于MAC地址划分VLAN配置命令</h3><p>1.关联MAC地址与VLAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-vlan10] mac-vlan mac-address mac-address [ mac-address-mask | mac-address-mask-length ]</span><br></pre></td></tr></table></figure>
<p>通过此命令配置MAC地址与VLAN关联。</p>
<ul>
<li>mac-address:指定与VLAN关联的MAC地址。格式为H-H-H。其中H为4位的十六进制数，可以输入1~4位，如00e0、fcO1。当输入不足4位时，表示前面的几位为0，如:输入e0，等同于O0e0。MAC地址不可设置为O000-0000-0000、FFFF-FFFF-FFFF和组播地址。</li>
<li>mac-address-mask:指定MAC地址掩码。格式为H-H-H，其中H为1至4位的十六进制数。</li>
<li> mac-address-mask-length:指定MAC地址掩码长度。整数形式，取值范围是1~48。</li>
</ul>
<p>2.使能MAC地址与VLAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Huawei-GigabitEtherneto&#x2F;0&#x2F;1] mac-vlan enable</span><br></pre></td></tr></table></figure>
<p>通过此命令使能接口的MAC VLAN功能。</p>
<h2 id="VLAN间路由子接口配置命令"><a href="#VLAN间路由子接口配置命令" class="headerlink" title="VLAN间路由子接口配置命令"></a>VLAN间路由子接口配置命令</h2><p><img src="/2021/04/30/VLAN/%E5%AD%90%E6%8E%A5%E5%8F%A3.png"></p>
<h2 id="VLANIF接口接口配置"><a href="#VLANIF接口接口配置" class="headerlink" title="VLANIF接口接口配置"></a>VLANIF接口接口配置</h2><p><img src="/2021/04/30/VLAN/VLANIF.png"></p>
<h2 id="二层接口和三层接口对比"><a href="#二层接口和三层接口对比" class="headerlink" title="二层接口和三层接口对比"></a>二层接口和三层接口对比</h2><table>
<thead>
<tr>
<th>二层接口(Layer2 Interface )</th>
<th>三层接口(Layer3 Interface )</th>
</tr>
</thead>
<tbody><tr>
<td>二层接口不能配置IP地址</td>
<td>三层接口可以配置IP地址</td>
</tr>
<tr>
<td>二层接口不具备MAC地址</td>
<td>三层接口具备MAC地址</td>
</tr>
<tr>
<td>当二层接口收到数据帧时，设备在其MAC地址表中查询该帧的目的MAC地址，找到匹配的MAC地址表项后按照该表项的指示转发帧;如果没有找到匹配的MAC地址表项，则将帧进行泛洪。</td>
<td>三层接口收到数据帧后，如果数据帧的目的MAC地址与设备的本地MAC地址相同，则将数据帧解除封装，然后在路由表中查询数据包的目的IP地址，找到匹配的路由表项后按照该表项的指示转发包;如果没有找到匹配的表项，则将包丢弃。</td>
</tr>
<tr>
<td>典型的二层接口如二层交换机（只具备二层交换能力的交换机)的物理接口;大部分三层交换机（同时具备二层及三层交换能力的交换机）的物理接口缺省为二层接口。</td>
<td>典型的三层接口如路由器的三层接口。某些三层交换机的物理接口可以切换成三层模式。此外除了物理三层接口，还存在逻辑三层接口，例如交换机的VLANIF，或者网络设备上的逻辑子接口，如GEO/0/1.10。</td>
</tr>
<tr>
<td>二层接口并不隔离广播域，当二层接口收到广播帧时，会将数据帧进行泛洪。</td>
<td>三层接口隔离广播域，当三层接口收到广播帧时，缺省不会进行泛洪，而是直接终结。</td>
</tr>
</tbody></table>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/VLAN/" rel="tag"># VLAN</a>
          
            <a href="/tags/VLAN%E9%97%B4%E8%B7%AF%E7%94%B1/" rel="tag"># VLAN间路由</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/04/29/%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4/" rel="next" title="网络管理与运维">
                <i class="fa fa-chevron-left"></i> 网络管理与运维
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/05/01/%E4%BB%A5%E5%A4%AA%E7%BD%91%E4%BA%A4%E6%8D%A2/" rel="prev" title="以太网交换">
                以太网交换 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/mydog.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">78</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zsy9959" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zsy9959@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81VLAN"><span class="nav-number">1.</span> <span class="nav-text">为什么需要VLAN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0VLAN%E7%9A%84%E6%9C%BA%E5%88%B6"><span class="nav-number">2.</span> <span class="nav-text">实现VLAN的机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VLAN%E9%97%B4%E8%B7%AF%E7%94%B1"><span class="nav-number">3.</span> <span class="nav-text">VLAN间路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E9%80%9FVLAN%E9%97%B4%E9%80%9A%E4%BF%A1%E7%9A%84%E6%89%8B%E6%AE%B5"><span class="nav-number">4.</span> <span class="nav-text">加速VLAN间通信的手段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VLAN%E9%97%B4%E8%B7%AF%E7%94%B1%E4%B8%BE%E4%BE%8B"><span class="nav-number">5.</span> <span class="nav-text">VLAN间路由举例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E8%83%8C%E6%99%AF"><span class="nav-number">5.1.</span> <span class="nav-text">技术背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E5%B1%82%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="nav-number">5.2.</span> <span class="nav-text">三层交换机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.3.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E4%B8%89%E5%B1%82%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%B8%8A%EF%BC%8C%E5%90%8C%E7%BD%91%E6%AE%B5%E4%BA%8C%E5%B1%82%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2"><span class="nav-number">5.4.</span> <span class="nav-text">在三层交换机上，同网段二层数据交换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E4%B8%89%E5%B1%82%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%B8%8A%EF%BC%8C%E8%B7%A8%E7%BD%91%E6%AE%B5%E4%B8%89%E5%B1%82%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2"><span class="nav-number">5.5.</span> <span class="nav-text">在三层交换机上，跨网段三层数据交换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%A0%E7%BB%9F%E5%9E%8B%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AD%98%E5%9C%A8%E7%9A%84%E6%84%8F%E4%B9%89"><span class="nav-number">6.</span> <span class="nav-text">传统型路由器存在的意义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8VLAN%E8%AE%BE%E8%AE%A1%E5%B1%80%E5%9F%9F%E7%BD%91"><span class="nav-number">7.</span> <span class="nav-text">使用VLAN设计局域网</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VLAN%E4%BB%A5%E5%A4%AA%E7%BD%91%E4%BA%8C%E5%B1%82%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%9E%8B"><span class="nav-number">8.</span> <span class="nav-text">VLAN以太网二层接口类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Access%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.1.</span> <span class="nav-text">Access接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Trunk%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.2.</span> <span class="nav-text">Trunk接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hybrid%E6%8E%A5%E5%8F%A3-%E5%89%8D%E4%B8%A4%E8%80%85%E6%B7%B7%E5%90%88%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.3.</span> <span class="nav-text">Hybrid接口(前两者混合接口)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">8.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VLAN%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4"><span class="nav-number">9.</span> <span class="nav-text">VLAN基础配置命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Access%E6%8E%A5%E5%8F%A3%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4"><span class="nav-number">9.1.</span> <span class="nav-text">Access接口配置命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Trunk%E6%8E%A5%E5%8F%A3%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4"><span class="nav-number">9.2.</span> <span class="nav-text">Trunk接口配置命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hybrid%E6%8E%A5%E5%8F%A3%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4"><span class="nav-number">9.3.</span> <span class="nav-text">Hybrid接口配置命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EMAC%E5%9C%B0%E5%9D%80%E5%88%92%E5%88%86VLAN%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4"><span class="nav-number">9.4.</span> <span class="nav-text">基于MAC地址划分VLAN配置命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VLAN%E9%97%B4%E8%B7%AF%E7%94%B1%E5%AD%90%E6%8E%A5%E5%8F%A3%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4"><span class="nav-number">10.</span> <span class="nav-text">VLAN间路由子接口配置命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VLANIF%E6%8E%A5%E5%8F%A3%E6%8E%A5%E5%8F%A3%E9%85%8D%E7%BD%AE"><span class="nav-number">11.</span> <span class="nav-text">VLANIF接口接口配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E5%B1%82%E6%8E%A5%E5%8F%A3%E5%92%8C%E4%B8%89%E5%B1%82%E6%8E%A5%E5%8F%A3%E5%AF%B9%E6%AF%94"><span class="nav-number">12.</span> <span class="nav-text">二层接口和三层接口对比</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张思宇</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
