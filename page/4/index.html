<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="my blog">
<meta property="og:type" content="website">
<meta property="og:title" content="zsy&#39;s blog">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="zsy&#39;s blog">
<meta property="og:description" content="my blog">
<meta property="og:locale">
<meta property="article:author" content="张思宇">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/page/4/"/>





  <title>zsy's blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zsy's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">just simple</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/home" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/" itemprop="url">IP-IP组播基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T11:18:10+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•网络中存在各种各样的业务，从流量模型看一般可以将业务分为两类：</p>
<p>▫点到点业务：比如FTP，WEB业务，此类业务主要特点是不同的用户有不同的需求，比如用户A需要下载资料A，用户B需要下载资料B。此类业务一般由单播承载，服务器对于不同用户发送不同的点到点数据流。</p>
<p>▫点到多点业务：比如IPTV，视频会议等，此类业务的特点是用户对于业务有相同的需求，比如用户A，B，C，D都需要收看视频X，此类业务可以使用单播，组播，广播承载。但使用单播或广播承载点到多点业务时存在一定问题。</p>
<p>▫组播技术能够较好的解决单播或广播在承载点到多点业务时存在的问题。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述组播的定义及组播的地址结构</p>
<p>▫描述组播数据的转发原理</p>
<p>▫描述反向路径转发的原理</p>
<h1 id="1-IP组播基本概念"><a href="#1-IP组播基本概念" class="headerlink" title="1.IP组播基本概念"></a>1.IP组播基本概念</h1><h2 id="点到多点业务的困境"><a href="#点到多点业务的困境" class="headerlink" title="点到多点业务的困境"></a>点到多点业务的困境</h2><p>点到多点业务可以由单播，组播，广播进行承载，现网中也有各种各样的实现方式。但使用单播或者广播承载点到多点业务时存在一些固有的问题。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/1.png"></p>
<blockquote>
<p>•单播（Unicast）是在一台源IP主机和一台目的IP主机之间进行。网络上绝大部分的数据都是以单播的形式传输的，例如电子邮件收发、网上银行都是采用单播实现的。</p>
<ul>
<li>在单播通信中每一个数据包都有确切的目的IP地址；对于同一份数据，如果存在多个接收者，Server需发送与接收者数目相同的单播数据包；当接收者增加到成百上千时，将极大加重Server创建相同数据和发送多份相同拷贝后所产生的消耗，网络中的设备性能及链路带宽都会面临一定程度的浪费；单播方式较适合用户稀少的网络，当用户量较大时很难保证网络传输质量。</li>
</ul>
<p>•广播（Broadcast）是在一台源IP主机和网络中所有其它的IP主机之间进行，属于一对所有的通讯方式，所有主机都可以接收到（不管是否需要）。</p>
<ul>
<li>广播数据包被限制在广播域中；一旦有设备发送广播数据，则广播域内所有设备都会收到这个数据包，并且不得不耗费资源去处理，大量的广播数据包将消耗网络的带宽及设备资源；广播方式只适合共享网段，且信息安全性和有偿服务得不到保障。</li>
</ul>
</blockquote>
<h2 id="使用组播承载点到多点业务"><a href="#使用组播承载点到多点业务" class="headerlink" title="使用组播承载点到多点业务"></a>使用组播承载点到多点业务</h2><p>•组播方式下，单一的信息流沿组播分发树被同时发送给一组用户，相同的组播数据流在每一条链路上最多仅有一份。相比单播和广播，使用组播的好处如下：</p>
<p>▫相比单播，用户的增加不会导致信息源负载的加重，不会导致网络资源消耗的显著增加。</p>
<p>▫相比广播，不会造成网络资源的浪费，并能提高信息传输的安全性，而且组播可以实现跨网段的传输。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/2.png"></p>
<blockquote>
<p>•组播（Multicast）是在一台源IP主机和多台（一组）IP主机之间进行，中间的网络设备根据接收者的需要，有选择性地对数据进行复制和转发。</p>
<p>•组播技术有效地满足了单点发送、多点接收的需求，实现了IP网络中点到多点业务数据的高效传送，能够大量节约网络带宽、降低网络负载。</p>
<p>•组播分发树：组播流量的转发路径。</p>
</blockquote>
<h2 id="组播数据报文结构"><a href="#组播数据报文结构" class="headerlink" title="组播数据报文结构"></a>组播数据报文结构</h2><p>•组播数据报文的结构与单播报文类似，但组播数据报文的目的MAC地址与目的IP地址与单播报文有很大差异。</p>
<p>​    ▫组播目的IP地址：目的IP地址为组播IP地址，地址范围从224.0.0.0到239.255.255.255</p>
<p>​    ▫组播目的MAC地址：目的MAC地址为组播MAC地址，组播MAC地址由组播IP地址映射而来</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/3.png"></p>
<h2 id="组播IP地址"><a href="#组播IP地址" class="headerlink" title="组播IP地址"></a>组播IP地址</h2><p>•在IPv4地址空间中，D类地址（224.0.0.0/4）被用于组播。一个组播地址就表示一个点到多点的数据流，比如IPTV数据流，语音会议数据流。</p>
<p>•大多数情况下，同一个组播网络里不同的业务（比如，IPTV，语音会议）就需要使用不同的组播IP地址。</p>
<p>•IANA对D类地址做了进一步的定义，几种主要的组播地址如下表所示：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/4.png"></p>
<blockquote>
<p>•IPv4组播地址：</p>
<p>▫IPv4地址空间分为五类，即A类、B类、C类、D类和E类。D类地址为IPv4组播地址，范围是从224.0.0.0到239.255.255.255，用于标识组播组，且仅能作为组播报文的目的地址使用，不能作为源地址使用。</p>
<p>▫IPv4组播报文的源地址字段为IPv4单播地址，可使用A、B或C类地址，不能是D类、E类地址。</p>
<p>▫在网络层上，加入同一组播组的所有用户主机能够识别同一个IPv4组播组地址。一旦网络中某用户加入该组播组，则此用户就能接收以该组地址为目的地址的IP组播报文。</p>
</blockquote>
<h2 id="组播MAC地址"><a href="#组播MAC地址" class="headerlink" title="组播MAC地址"></a>组播MAC地址</h2><p>•以太网传输IPv4单播报文的时候，目的MAC地址使用的是接收者的MAC地址。但是在传输组播数据时，其目的地不再是一个具体的接收者，而是一个成员不确定的组，所以要使用IPv4组播MAC地址。</p>
<p>•IANA规定，IPv4组播MAC地址的高24位为0x01005e，第25位为0，低23位为IPv4组播地址的低23位，例如组播组地址224.0.1.1对应的组播MAC地址为01-00-5e-00-01-01。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/5.png"></p>
<blockquote>
<p>•IPv4组播地址的前4位是固定的1110，对应组播MAC地址的高25位，后28位中只有23位被映射到MAC地址，因此丢失了5位的地址信息，直接结果是有32个IPv4组播地址映射到同一MAC地址上。例如IP地址为224.0.1.1、224.128.1.1、225.0.1.1、239.128.1.1等组播组的组播MAC地址都为01-00-5e-00-01-01。网络管理员在分配地址时必须考虑这种情况。</p>
<p>•IETF认为同一个局域网中两个或多个组地址生成相同的MAC地址的几率非常低，不会造成太大的影响。</p>
<p>•组播MAC地址标识了一组设备，这种MAC地址第1个字节的最低比特位为1，例如0100-5e-00ab。</p>
<p>•一个组播MAC地址所标识的一组设备有着共同的特点，那就是它们都加入了相同的组播组，这些设备将会侦听目的MAC地址为该组播MAC地址的数据帧。只有单播MAC地址才能够被分配给一个以太网接口，组播或广播MAC地址是不能被分配给任何一个以太网接口的，换句话说，这两种类型的MAC地址不能作为数据帧的源MAC地址，而只能作为目的MAC地址。</p>
<p>•对于组播MAC地址，相信大家并不会太陌生，例如STP协议的BPDU载荷便是被直接封装在以太网数据帧中的，并且数据帧的目的MAC地址为0180-c200-0000，这就是一个组播MAC地址，类似这样的例子还有很多，此处不再一一列举，这些组播MAC地址并不与组播IP地址存在关联。</p>
<p>•除此之外，还有一类组播MAC地址是我们需要格外关注的，那就是与组播IP地址存在映射关系的组播MAC地址。本课程介绍的组播MAC地址对应该类型。</p>
</blockquote>
<h2 id="组播网络基本架构"><a href="#组播网络基本架构" class="headerlink" title="组播网络基本架构"></a>组播网络基本架构</h2><p>•组播网络大体可以分为三个部分：</p>
<p>▫源端网络：将组播源产生的组播数据发送至组播网络。</p>
<p>▫组播转发网络：形成无环的组播转发路径，该转发路径也被称为组播分发树（Multicast Distribution Tree）。</p>
<p>▫成员端网络：让组播网络感知组播组成员位置与加入的组播组。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/6.png"></p>
<blockquote>
<p>•组播源（Source）：组播流量的发送者，例如多媒体服务器。组播源无需运行任何组播协议，只需简单 地将组播数据发送出来即可。 </p>
<p>•组播接收者（Receiver）：也被称为组播组成员，是期望接收特定组播组流量的设备，例如运行多媒体 直播客户端软件的PC。</p>
<p>•组播组（Multicast Group）：用IP组播地址进行标识的一个集合。任何用户主机（或其他接收设备），加入一个组播组，就成为了该组成员，可以识别并接收发往该组播组的组播数据。</p>
<p>•组播路由器（Multicast Router）：支持组播、运行组播协议的网络设备，实际上不仅仅路由器能够支持 组播，交换机、防火墙等设备也能够支持组播（取决于设备型号），路由器仅是一个代表。</p>
<p>•第一跳路由器（First-Hop Router）：组播转发路径上，与组播源相连且负责转发该组播源发出的组播数据的PIM路由器。</p>
<p>•最后一跳路由器（Last-Hop Router）：组播转发路径上，与组播组成员相连且负责向该组成员转发组播数据的PIM路由器。</p>
<p>•IGMP（Internet Group Management Protocol，因特网组管理协议），是TCP/IP协议族中负责IP组播成员管理的协议，它用来在接收者和与其直接相邻的组播路由器之间建立、维护组播组成员关系。</p>
</blockquote>
<h2 id="组播服务模型"><a href="#组播服务模型" class="headerlink" title="组播服务模型"></a>组播服务模型</h2><p>•组播组成员在接收组播数据时可以对于组播数据源进行选择，因此产生了ASM（Any-Source Multicast，任意源组播）和SSM（Source-Specific Multicast，指定源组播）两种组播服务模型。</p>
<p>▫ASM：组成员加入组播组以后，组成员可以接收到任意源发送到该组的数据。</p>
<p>▫SSM：组成员加入组播组以后，组成员只会收到指定源发送到该组的数据。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/7.png"></p>
<blockquote>
<p>•ASM特点：</p>
<p>▫ASM为了提高安全性，可以在路由器上配置针对组播源的过滤策略，允许或禁止来自某些组播源的报文通过。最终从接收者角度看，数据是经过筛选的。</p>
<p>▫ASM模型要求组地址必须整个组播网络中唯一。“唯一”指的是同一时刻一个ASM地址只能被一种组播应用使用。如果有两种不同的应用程序使用了同一个ASM组地址发送数据，它们的接收者会同时收到来自两个源的数据。这样一方面会导致网络流量拥塞，另一方面也会给接收者主机造成困扰。</p>
<p>•SSM特点：</p>
<p>▫SSM模型对组地址不再要求全网唯一，只需要每个组播源保持唯一。这里的“唯一”指的是同一个源上不同的组播应用必须使用不同的SSM地址来区分。不同的源之间可以使用相同的组地址，因为SSM模型中针对每一个（源，组）信息都会生成表项。这样一方面节省了组播组地址，另一方面也不会造成网络拥塞。</p>
</blockquote>
<h1 id="2-组播数据转发原理"><a href="#2-组播数据转发原理" class="headerlink" title="2.组播数据转发原理"></a>2.组播数据转发原理</h1><h2 id="组播数据转发的困局"><a href="#组播数据转发的困局" class="headerlink" title="组播数据转发的困局"></a>组播数据转发的困局</h2><p>组播数据转发需要依赖路由表项。但是基于目的网络的路由表在转发组播数据时存在一定问题：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/8.png"></p>
<h2 id="组播路由与RPF检查"><a href="#组播路由与RPF检查" class="headerlink" title="组播路由与RPF检查"></a>组播路由与RPF检查</h2><p>•由于组播转发容易产生环路，次优，重复报文，所以组播路由表项除了目的网络和出接口外还需要添加组播源和入接口的信息。设备仅转发从特定唯一的入接口收到的组播数据，从而避免组播转发时产生环路，次优，重复报文（部分解决）等问题。</p>
<p>•对于相同的组播源，设备通过RPF（Reverse Path Forwarding，反向路径转发）检查可以确定设备上唯一的组播流量入接口。</p>
<p>•组播路由表项以及与RPF检查的关系如下：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/9.png"></p>
<blockquote>
<p>•组播路由表项出接口一般需要通过组播路由协议确定。</p>
<p>•组播路由协议将在《PIM原理与配置》课程介绍。</p>
<p>•组播路由表项包含组播源与组播组，因此有事又被称为（S，G）表项。</p>
</blockquote>
<h2 id="RPF检查工作原理"><a href="#RPF检查工作原理" class="headerlink" title="RPF检查工作原理"></a>RPF检查工作原理</h2><p>•RPF检查过程如下：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/10.png"></p>
<blockquote>
<p>•组播路由器根据报文的源地址通过路由表（单播路由表、MBGP路由表或组播静态路由表）查找到达“报文源”的路由，查看到“报文源”的路由表项的出接口是否与收到组播报文的入接口一致。如果一致，则认为该组播报文从正确的接口到达，从而保证了整个转发路径的正确性和唯一性。这个过程就被称为RPF检查。</p>
</blockquote>
<h2 id="RPF路由选举规则"><a href="#RPF路由选举规则" class="headerlink" title="RPF路由选举规则"></a>RPF路由选举规则</h2><p>RPF路由可以从单播路由、MBGP路由、组播静态路由中选举产生。当路由器收到一份组播报文后，如果这三种路由表都存在，具体检查过程如下：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/11.png"></p>
<blockquote>
<p>•根据以下原则从这三条最优路由中选择一条作为RPF路由：</p>
<ul>
<li><p>如果配置了按照最长匹配选择路由，则从这三条路由中选出最长匹配的那条路由；</p>
</li>
<li><p>如果这三条路由的掩码一样，则选择优先级最高的那条路由；</p>
</li>
<li><p>如果它们的优先级也相同，则按照组播静态路由、MBGP路由、单播路由的顺序进行选择。</p>
</li>
</ul>
<p>•MBGP：</p>
<ul>
<li>MBGP（Multicast BGP，组播BGP）主要用于传递组播源相关的路由条目。</li>
</ul>
<p>•组播静态路由表：</p>
<ul>
<li>手工配置组播源与出接口的对应关系。</li>
</ul>
</blockquote>
<h2 id="组播分发树"><a href="#组播分发树" class="headerlink" title="组播分发树"></a>组播分发树</h2><p>•组播数据转发需要保证转发路径无环，无次优路径且无重复包。</p>
<p>•通过RPF机制与组播路由协议，组播网络可以最终形成无环、无次优且无重复包的组播转发路径，该路径可以被称为<strong>组播分发树</strong>。</p>
<p>•组播分发树以<strong>组播源为根</strong>，<strong>以组成员为叶子</strong>形成转发路径，组播数据在转发时都基于组播分发树进行转发。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/12.png"></p>
<h2 id="组播数据转发流程"><a href="#组播数据转发流程" class="headerlink" title="组播数据转发流程"></a>组播数据转发流程</h2><p>组播数据转发基本流程如下：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/13.png"></p>
<blockquote>
<p>•组播路由表项出接口与组播转发路径由组播路由协议决定。</p>
<p>​    ▫组播路由协议主要有：PIM，MBGP，MSDP。</p>
<p>​    ▫关于组播路由协议的内容将在《PIM原理与配置》课程讲解。</p>
<p>•组播组成员位置由IGMP通告。</p>
<p>​    ▫关于IGMP的内容将在《IGMP原理与配置》课程讲解。</p>
</blockquote>
<h2 id="组播协议介绍"><a href="#组播协议介绍" class="headerlink" title="组播协议介绍"></a>组播协议介绍</h2><p>•组播网络需要基于多种组播协议才能建立转发路径：</p>
<p>▫工作在成员端网络的主要是IGMP（Internet Group Management Protocol，因特网组管理协议）协议，用于<strong>告知组播网络，组成员的位置与所加组播组。</strong></p>
<p>▫工作在组播转发网络的协议主要有PIM，MSDP，MBGP。</p>
<p>▪PIM（Protocol Independent Multicast，协议无关组播）协议主要作用是<strong>生成AS域内的组播分发树</strong>。</p>
<p>▪MSDP（Multicast Source Discovery Protocol，组播源发现协议）主要作用是<strong>帮助生成AS域间的组播分发树</strong>。</p>
<p>▪MBGP（Multicast BGP，组播BGP）主要作用是帮助<strong>跨域组播流进行RPF校验</strong>。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/14.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）IPv4组播地址的范围是什么？</p>
<p>A.192.168.0.0~192.168.255.255</p>
<p>B.172.21.0.0~172.21.255.255</p>
<p><strong>C.224.0.0.0~239.255.255.255</strong></p>
<p>D.240.0.0.0~255.255.255.255</p>
<blockquote>
<p>IANA（Internet Assigned Numbers Authority，互联网编号分配委员会）将D类地址空间分配给IPv4组播使用。IPv4地址一共32位，D类地址最高4位为1110，因此地址范围从224.0.0.0到239.255.255.255。</p>
</blockquote>
<p>2.（多选题）下面描述RPF作用正确的是？</p>
<p><strong>A. 避免重复的组播报文</strong></p>
<p>B. 加速组播流量转发速度</p>
<p><strong>C. 防环</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•组播主要解决单播或广播在承载点到多点流量时存在的问题：</p>
<ul>
<li><p>使用单播承载点到多点流量时，随着点到多点业务客户端的增加，可能会引起带宽占用过高或源服务器压力过大等问题。</p>
</li>
<li><p>使用广播承载点到多点流量时，虽然不存在单播承载点到多点流量时的问题，但缺乏安全性。</p>
</li>
</ul>
<p>•组播网络一般由三部分组成：源端网络，组播转发网络，成员端网络。</p>
<ul>
<li>组播转发网络负责组播数据在组播路由器之间转发，但是在转发过程中可能存在环路，次优路径，重复报文等问题。这些问题可以通过RPF检查部分或全部解决。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/" itemprop="url">IP-交换机堆叠与集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T11:17:56+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•随着企业的发展，企业网络的规模越来越大，这对企业网络提出了更高的要求：更高的可靠性、更低的故障恢复时间、设备更加易于管理等。</p>
<p>•传统的园区网高可靠性技术出现故障时切换时间很难做到毫秒级别、实现可靠性的方案通常为一主一备，存在着严重的资源浪费。同时随着网络设备的越来越多，管理将会变得越加复杂。为构建可靠、易管理、资源利用率高、易于扩展的交换网络，引入了交换机堆叠、集群技术。</p>
<p>•本章节中将介绍交换机堆叠、集群技术的技术原理、组网方式等。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述交换机堆叠、集群的基本概念</p>
<p>▫阐述堆叠、集群的建立过程</p>
<p>▫阐述堆叠、集群的分裂检测技术原理</p>
<h1 id="1-堆叠、集群技术概述"><a href="#1-堆叠、集群技术概述" class="headerlink" title="1.堆叠、集群技术概述"></a>1.堆叠、集群技术概述</h1><h2 id="堆叠、集群简介"><a href="#堆叠、集群简介" class="headerlink" title="堆叠、集群简介"></a>堆叠、集群简介</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/1.png"></p>
<blockquote>
<p>•堆叠（iStack），将多台支持堆叠特性的交换机通过堆叠线缆连接在一起，从逻辑上虚拟成一台交换设备，作为一个整体参与数据转发。</p>
<p>•集群（Cluster Switch System，CSS），将两台支持集群特性的交换机设备组合在一起，从逻辑上虚拟成一台交换设备。</p>
<p>•集群只支持两台设备，一般高端框式交换机支持CSS、盒式设备支持iStack。</p>
<p>•通过使用堆叠、集群技术结合链路聚合技术可以简单构建高可靠、无环的园区网络。</p>
</blockquote>
<h2 id="堆叠、集群架构"><a href="#堆叠、集群架构" class="headerlink" title="堆叠、集群架构"></a>堆叠、集群架构</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/2.png"></p>
<p>•使用堆叠、集群技术将独立的交换机虚拟化成一台逻辑的交换机，一般接入、汇聚层盒式交换机采用堆叠技术，汇聚、核心层交换机采用集群技术。</p>
<p>•在逻辑交换机之间使用链路聚合技术，无需部署STP、VRRP实现高可靠性。</p>
<p>•实现高可靠性的同时设备之间的链路可以同时传输流量，链路利用率得以提升。</p>
<h2 id="堆叠、集群的优势-1"><a href="#堆叠、集群的优势-1" class="headerlink" title="堆叠、集群的优势 (1)"></a>堆叠、集群的优势 (1)</h2><p>使用堆叠、集群可有效提高资源利用率，获得更高的转发性能、链路带宽。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/3.png"></p>
<h2 id="堆叠、集群的优势-2"><a href="#堆叠、集群的优势-2" class="headerlink" title="堆叠、集群的优势 (2)"></a>堆叠、集群的优势 (2)</h2><p>使用堆叠、集群可以降低网络规划的复杂度，方便对于网络的管理。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/4.png"></p>
<h2 id="堆叠、集群的优势-3"><a href="#堆叠、集群的优势-3" class="headerlink" title="堆叠、集群的优势 (3)"></a>堆叠、集群的优势 (3)</h2><p>使用堆叠、集群可以大大降低故障导致的业务中断时间。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/5.png"></p>
<h1 id="2-堆叠技术原理"><a href="#2-堆叠技术原理" class="headerlink" title="2.堆叠技术原理"></a>2.堆叠技术原理</h1><h2 id="堆叠基本概念"><a href="#堆叠基本概念" class="headerlink" title="堆叠基本概念"></a>堆叠基本概念</h2><p>•堆叠系统中所有的单台交换机都称为成员交换机，按照功能不同，可以分为三种角色：</p>
<ul>
<li><p>主交换机（Master）：主交换机负责管理整个堆叠。堆叠系统中只有一台主交换机。</p>
</li>
<li><p>备交换机（Standby）：备交换机是主交换机的备份交换机。堆叠系统中只有一台备交换机。当主交换机故障时，备交换机会接替原主交换机的所有业务。</p>
</li>
<li><p>从交换机（Slave）：从交换机用于业务转发，堆叠系统中可以有多台从交换机。从交换机数量越多，堆叠系统的转发带宽越大。除主交换机和备交换机外，堆叠中其他所有的成员交换机都是从交换机。当备交换机不可用时，从交换机承担备交换机的角色。</p>
</li>
</ul>
<p>•堆叠优先级：堆叠优先级是成员交换机的一个属性，主要用于角色选举过程中确定成员交换机的角色，优先级值越大表示优先级越高，优先级越高当选为主交换机的可能性越大。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/6.png"></p>
<h2 id="堆叠ID"><a href="#堆叠ID" class="headerlink" title="堆叠ID"></a>堆叠ID</h2><p>•堆叠ID，即成员交换机的槽位号（Slot ID），用来标识和管理成员交换机，堆叠中所有成员交换机的堆叠ID都是唯一的。</p>
<p>•设备堆叠ID缺省为0。堆叠时由堆叠主交换机对设备的堆叠ID进行管理，当堆叠系统有新成员加入时，如果新成员与已有成员堆叠ID冲突，则堆叠主交换机从0～最大的堆叠ID进行遍历，找到第一个空闲的ID分配给该新成员。</p>
<p>•在建立堆叠时，建议提前规划好设备的堆叠ID。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/7.png"></p>
<h2 id="堆叠逻辑接口"><a href="#堆叠逻辑接口" class="headerlink" title="堆叠逻辑接口"></a>堆叠逻辑接口</h2><p>•堆叠逻辑接口：交换机之间用于建立堆叠的逻辑接口，每台交换机支持两个逻辑堆叠端口，分别为stack-port n/1和stack-port n/2，其中n为成员交换机的堆叠ID。</p>
<p>•一个逻辑堆叠端口可以绑定多个物理成员端口，用来提高堆叠的可靠性和堆叠带宽。</p>
<p>•堆叠成员设备之间，本端设备的逻辑堆叠端口stack-port n/1必须与对端设备的逻辑堆叠端口stack-port m/2相连。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/8.png"></p>
<blockquote>
<p>•如果两端设备对应的逻辑堆叠端口（本端的stack-port n/1与对端的stack-port m/2）内包含多个物理成员端口，对物理成员端口的连接无对应端口号的要求。</p>
</blockquote>
<h2 id="堆叠系统组建过程"><a href="#堆叠系统组建过程" class="headerlink" title="堆叠系统组建过程"></a>堆叠系统组建过程</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/9.png"></p>
<h2 id="堆叠方式"><a href="#堆叠方式" class="headerlink" title="堆叠方式"></a>堆叠方式</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/10.png"></p>
<blockquote>
<p>•每台交换机支持两个逻辑堆叠端口，分别为stack-port n/1和stack-port n/2，其中n为成员交换机的堆叠ID。</p>
</blockquote>
<h2 id="堆叠连接拓扑"><a href="#堆叠连接拓扑" class="headerlink" title="堆叠连接拓扑"></a>堆叠连接拓扑</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/11.png"></p>
<h2 id="主交换机选举"><a href="#主交换机选举" class="headerlink" title="主交换机选举"></a>主交换机选举</h2><p>•确定出堆叠的连接方式和连接拓扑，完成成员交换机之间的物理连接之后，所有成员交换机上电。此时，堆叠系统开始进行主交换机的选举。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/12.png"></p>
<h2 id="备交换机选举"><a href="#备交换机选举" class="headerlink" title="备交换机选举"></a>备交换机选举</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/13.png"></p>
<h2 id="软件、配置同步"><a href="#软件、配置同步" class="headerlink" title="软件、配置同步"></a>软件、配置同步</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/14.png"></p>
<h2 id="堆叠管理与配置文件"><a href="#堆叠管理与配置文件" class="headerlink" title="堆叠管理与配置文件"></a>堆叠管理与配置文件</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/15.png"></p>
<blockquote>
<p>•堆叠系统的配置文件包括：</p>
<p>​    ▫全局配置：例如IP地址、STP、VLAN、SNMP等，适用于所有堆叠成员交换机。新加入堆叠系统的交换机使用堆叠系统的全局配置，不再使用交换机自己的全局配置。交换机离开堆叠系统时，将继续使用堆叠系统的配置直到加入新的堆叠系统。</p>
<p>​    ▫接口配置：适用于接口所在成员交换机。接口上的配置和堆叠ID有关，当堆叠ID改变时：</p>
<p>▪如果新ID在配置文件中不存在对应的接口配置，则新ID的接口配置使用默认配置。</p>
<p>▪如果新ID在配置文件中存在对应的接口配置，则新ID的接口配置使用对应的配置。</p>
<p>•堆叠相关配置不会丢失，即从设备离开堆叠之后，堆叠相关配置仍会继续存在，同样会进行堆叠的选举，如果需要彻底清除堆叠配置需要通过命令手动清除，清除的配置内容包括：</p>
<p>​    ▫交换机槽位号</p>
<p>​    ▫堆叠优先级</p>
<p>​    ▫堆叠保留VLAN</p>
<p>​    ▫系统MAC切换时间</p>
<p>​    ▫堆叠口配置</p>
<p>​    ▫堆叠口速率配置</p>
<p>​    执行该命令会导致设备重启</p>
</blockquote>
<h2 id="堆叠成员退出"><a href="#堆叠成员退出" class="headerlink" title="堆叠成员退出"></a>堆叠成员退出</h2><p>堆叠成员退出是指成员交换机从堆叠系统中离开。根据退出成员交换机角色的不同，对堆叠系统的影响也有所不同：</p>
<p>▫当主交换机退出，备份交换机升级为主交换机，重新计算堆叠拓扑并同步到其他成员交换机，指定新的备交换机，之后进入稳定运行状态。</p>
<p>▫当备交换机退出，主交换机重新指定备交换机，重新计算堆叠拓扑并同步到其他成员交换机，之后进入稳定运行状态。</p>
<p>▫当从交换机退出，主交换机重新计算堆叠拓扑并同步到其他成员交换机，之后进入稳定运行状态。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/16.png"></p>
<blockquote>
<p>•堆叠成员交换机退出的过程，主要就是拆除堆叠线缆和移除交换机的过程：</p>
<ul>
<li><p>对于环形堆叠：成员交换机退出后，为保证网络的可靠性还需要把退出交换机连接的两个端口通过堆叠线缆进行连接。</p>
</li>
<li><p>对于链形堆叠：拆除中间交换机会造成堆叠分裂。这时需要在拆除前进行业务分析，尽量减少对业务的影响。</p>
</li>
</ul>
</blockquote>
<h2 id="堆叠成员加入"><a href="#堆叠成员加入" class="headerlink" title="堆叠成员加入"></a>堆叠成员加入</h2><p>堆叠成员加入是指向已经稳定运行的堆叠系统添加一台新的交换机：</p>
<p>▫将未上电的交换机连线加入堆叠之后再上电启动，新加入的交换机会选举为从交换机，堆叠系统中原有主备从角色不变。</p>
<p>▫角色选举结束后，主交换机更新堆叠拓扑信息，同步到其他成员交换机上，并向新加入的交换机分配堆叠ID（新加入的交换机没有配置堆叠ID或配置的堆叠ID与原堆叠系统的冲突时）。</p>
<p>▫新加入的交换机更新堆叠ID，并同步主交换机的配置文件和系统软件，之后进入稳定运行状态。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/17.png"></p>
<blockquote>
<p>•未上电的交换机加入堆叠：</p>
<p>​    ▫如果是链形连接，新加入的交换机建议添加到链形的两端，这样对现有的业务影响最小。</p>
<p>​    ▫如果是环形连接，需要把当前环形拆成链形，然后在链形的两端添加设备。</p>
</blockquote>
<h2 id="堆叠合并"><a href="#堆叠合并" class="headerlink" title="堆叠合并"></a>堆叠合并</h2><p>•堆叠合并是指稳定运行的两个堆叠系统合并成一个新的堆叠系统。</p>
<p>•例如：已上电的一台交换机并且配置了堆叠（已形成单机堆叠），通过堆叠线缆与已经在运行的堆叠系统连接。该过程为堆叠合并，与堆叠加入不同。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/18.png"></p>
<blockquote>
<p>•单机堆叠：单机堆叠就是一台交换机使能了堆叠功能，整个堆叠系统中只有一台主交换机。只有使能了堆叠功能的交换机才可以加入堆叠系统或与其他使能了堆叠功能的交换机组建堆叠。</p>
<p>•堆叠合并过程如下：</p>
<p>▫两个堆叠系统的主交换机通过竞争，选举出一个更优的作为新堆叠系统的主交换机。</p>
<p>▫竞争成功的主交换机所在的堆叠系统将保持原有主备从角色和配置不变，业务也不会受到影响</p>
<p>▫而另外一个堆叠系统的所有成员交换机将重新启动，以从交换机的角色加入到新堆叠系统，其堆叠ID将由新主交换机重新分配，并将同步新主交换机的配置文件和系统软件，该堆叠系统的原有业务也将中断。</p>
</blockquote>
<h2 id="堆叠分裂"><a href="#堆叠分裂" class="headerlink" title="堆叠分裂"></a>堆叠分裂</h2><p>堆叠分裂是指稳定运行的堆叠系统中带电移出部分成员交换机，或者堆叠线缆多点故障导致一个堆叠系统变成多个堆叠系统。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/19.png"></p>
<h2 id="堆叠分裂引起的问题"><a href="#堆叠分裂引起的问题" class="headerlink" title="堆叠分裂引起的问题"></a>堆叠分裂引起的问题</h2><p>由于堆叠系统中所有成员交换机都使用同一个IP地址（VLANIF接口地址）和MAC地址（堆叠系统MAC），一个堆叠系统分裂后，可能产生多个具有相同IP地址和MAC地址的堆叠系统，从而引起网络故障，为此必须进行IP地址和MAC地址的冲突检查。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/20.png"></p>
<blockquote>
<p> •堆叠系统作为一台设备与网络中其他设备通信，具有唯一的MAC地址，称为堆叠系统MAC地址。通常情况下使用主交换机的MAC地址作为堆叠系统MAC地址。</p>
<p>•当堆叠系统的MAC地址是主交换机的MAC地址，主交换机故障或者离开堆叠系统，在默认情况下堆叠系统MAC地址会延时10分钟切换，即在10分钟内两个分裂的堆叠系统的MAC相同。</p>
</blockquote>
<h2 id="MAD"><a href="#MAD" class="headerlink" title="MAD"></a>MAD</h2><p>•多主检测MAD（Multi-Active Detection）：一种检测和处理堆叠分裂的协议，链路故障导致堆叠系统分裂后，MAD可以实现堆叠分裂的检测、冲突处理和故障恢复，降低堆叠分裂对业务的影响。</p>
<p>•MAD检测方式有两种：直连检测方式和代理检测方式。在同一个堆叠系统中，两种检测方式互斥，不可以同时配置。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/21.png"></p>
<blockquote>
<p>•分裂后的堆叠系统通过MAD检测线缆（普通线缆，手动配置为MAD检测链路）发送MAD检测报文进行竞选，竞选失败的堆叠系统会关闭所有的物理端口（手动配置的保留端口除外）以保证不会因IP、MAC冲突对业务产生影响。</p>
<p>•MAD检测过程如下：</p>
<p>▫堆叠分裂之后，分裂后的堆叠系统存在相同的IP地址、MAC地址（堆叠系统MAC），将会导致网络中表项错误，如下游设备的ARP表项、MAC地址表项，从而导致业务异常。</p>
<p>▫为此分类后的堆叠系统会通过MAC检测线缆进行竞选。</p>
<p>▫竞选失败者关闭自身物理接口，从而不会和竞选成功地堆叠系统产生IP地址、MAC地址冲突。</p>
</blockquote>
<h2 id="MAD检测-直连检测"><a href="#MAD检测-直连检测" class="headerlink" title="MAD检测 - 直连检测"></a>MAD检测 - 直连检测</h2><p>直连检测方式是指堆叠成员交换机间通过普通线缆直连的专用链路进行多主检测。在直连检测方式中，堆叠系统正常运行时，不发送MAD报文；堆叠系统分裂后，分裂后的两台交换机以1秒为周期通过检测链路发送MAD报文进行多主冲突处理。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/22.png"></p>
<blockquote>
<p>•通过中间设备直连可以实现通过中间设备缩短堆叠成员交换机之间的检测链路长度，适用于成员交换机相距较远的场景。与通过中间设备直连相比，Full-mesh方式直连可以避免由中间设备故障导致的MAD检测失败，但是每两台成员交换机之间都建立全连接会占用较多的接口，所以该方式适用于成员交换机数目较少的场景。</p>
</blockquote>
<h2 id="MAD检测-代理检测"><a href="#MAD检测-代理检测" class="headerlink" title="MAD检测 - 代理检测"></a>MAD检测 - 代理检测</h2><p>代理检测方式是在堆叠系统Eth-Trunk上启用代理检测，在代理设备上启用MAD检测功能。此种检测方式要求堆叠系统中的所有成员交换机都与代理设备连接，并将这些链路加入同一个Eth-Trunk内。与直连检测方式相比，代理检测方式无需占用额外的接口，Eth-Trunk接口可同时运行MAD代理检测和其他业务。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/23.png"></p>
<blockquote>
<p>•在代理检测方式中，堆叠系统正常运行时，堆叠成员交换机以30s为周期通过检测链路发送MAD报文。堆叠成员交换机对在正常工作状态下收到的MAD报文不做任何处理；堆叠分裂后，分裂后的两个堆叠系统以1s为周期通过检测链路发送MAD报文进行多主冲突处理。</p>
</blockquote>
<h2 id="MAD冲突处理-1"><a href="#MAD冲突处理-1" class="headerlink" title="MAD冲突处理 (1)"></a>MAD冲突处理 (1)</h2><p>堆叠分裂后，MAD冲突处理机制使用MAD报文进行MAD竞争，竞争结果为堆叠系统处于Detect状态或者Recovery状态：</p>
<p>▫Detect：竞争成功，堆叠系统将处于正常工作状态。</p>
<p>▫Recovery：竞争失败，堆叠系统将状态处于禁用状态，关闭除手动配置的保留端口以外的其它所有物理端口。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/24.png"></p>
<h2 id="MAD冲突处理-2"><a href="#MAD冲突处理-2" class="headerlink" title="MAD冲突处理 (2)"></a>MAD冲突处理 (2)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/25.png"></p>
<h2 id="堆叠主备倒换"><a href="#堆叠主备倒换" class="headerlink" title="堆叠主备倒换"></a>堆叠主备倒换</h2><p>•如果堆叠系统当前的主交换机不是用户期望的，此时可以通过配置主备倒换实现将堆叠备交换机升为堆叠主交换机。</p>
<p>•除了用户通过命令执行的主备倒换之外，主交换机故障重启也会引起主备倒换。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/26.png"></p>
<blockquote>
<p>•原来的备交换机升为主交换机</p>
<p>•新主交换机重新指定备交换机</p>
<p>•原来的主交换机重启后重新加入堆叠系统，并被选举为从交换机。</p>
</blockquote>
<h2 id="堆叠升级"><a href="#堆叠升级" class="headerlink" title="堆叠升级"></a>堆叠升级</h2><p>堆叠升级方式有三种：智能升级、传统升级和平滑升级。</p>
<p>▫智能升级：堆叠建立或者新的交换机加入堆叠时会自动和主交换机的版本进行同步。</p>
<p>▫传统升级：和普通设备升级一样，指定下次启动版本，重启整个堆叠系统进行升级，会造成较长时间的业务中断。</p>
<p>▫平滑升级：将堆叠系统划分成为active、backup区域，可以分区域升级，整个堆叠系统的上下行采用备份组网，主、备链路分别处于active、backup区域，可以实现升级时的业务不中断。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/27.png"></p>
<blockquote>
<p>•Active区域：主交换机所在的区域</p>
<p>•平滑升级的三个阶段：</p>
<p>▫主交换机下发命令触发整个堆叠系统进入平滑升级状态，backup区各个成员交换机以新的系统软件进行启动。</p>
<p>▫backup区以新版本建立一个独立的堆叠系统，并通知active区进入升级阶段，主控权由active区的主交换机转移到backup区的主交换机，backup区负责流量传输，active区进入升级过程。</p>
<p>▫active区以新系统软件重新启动并加入backup区的堆叠系统，backup区的主交换机根据最终堆叠建立的结果发布升级的结果。</p>
</blockquote>
<h2 id="跨设备链路聚合-1"><a href="#跨设备链路聚合-1" class="headerlink" title="跨设备链路聚合 (1)"></a>跨设备链路聚合 (1)</h2><p>•堆叠支持跨设备链路聚合技术，堆叠后成为逻辑上的一台交换机，支持将Eth-Trunk的成员接口分布在不同的成员交换机上。</p>
<p>•当其中一条聚合链路故障或堆叠中某台成员交换机故障时，Eth-Trunk接口通过堆叠线缆将流量重新分布到其他聚合链路上，实现了链路间和设备间的备份，保证了数据流量的可靠传输。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/28.png"></p>
<h2 id="跨设备链路聚合-2"><a href="#跨设备链路聚合-2" class="headerlink" title="跨设备链路聚合 (2)"></a>跨设备链路聚合 (2)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/29.png"></p>
<blockquote>
<p>•如上图所时，在上行链路出现故障时跨设备链路聚合技术能够通过堆叠线缆将流量负载分担到其他成员交换机上的成员接口，从而提高网络可靠性。</p>
<p>•跨成员设备的流量会经过堆叠线缆，如果跨成员设备流量较大，将会大大增加堆叠线缆的带宽压力。</p>
</blockquote>
<h2 id="流量本地优先转发-1"><a href="#流量本地优先转发-1" class="headerlink" title="流量本地优先转发 (1)"></a>流量本地优先转发 (1)</h2><p>链路聚合的负载分担算法根据流量特征将报文分担在不同的成员链路上，对于跨设备链路聚合极有可能出现报文的出接口和入接口不在同一台成员设备之上的情况，此时堆叠成员之间将会通过堆叠线缆转发流量，这增加了堆叠线缆的流量负担，同时也降低了转发效率。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/30.png"></p>
<blockquote>
<p>•如上图所示，当链路聚合将流量分担到其他成员设备上时，部分流量将会经过堆叠线缆转发，这会大大增加堆叠线缆的带宽承载压力。如果通过堆叠线缆需要转发的流量甚至超过了堆叠线缆的带宽，报文将无法及时得到传输。</p>
</blockquote>
<h2 id="流量本地优先转发-2"><a href="#流量本地优先转发-2" class="headerlink" title="流量本地优先转发 (2)"></a>流量本地优先转发 (2)</h2><p>为保证流量转发效率、降低堆叠线缆带宽负载，设备可以开启流量本地优先转发，从本设备进入的流量优先从本地转发出去，当本设备无出接口或者出接口全部故障，才会从其它成员交换机的接口转发出去。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/31.png"></p>
<h1 id="3-集群技术原理"><a href="#3-集群技术原理" class="headerlink" title="3.集群技术原理"></a>3.<strong>集群技术原理</strong></h1><h2 id="集群介绍"><a href="#集群介绍" class="headerlink" title="集群介绍"></a>集群介绍</h2><p>•集群交换机系统CSS（Cluster Switch System），又称为集群，是指将两台支持集群特性的交换机设备组合在一起，从逻辑上虚拟成一台交换设备。</p>
<p>•CSS与iStack的区别在于，一般框式交换机堆叠称为CSS，盒式交换机称为堆叠，堆叠与集群两者只是叫法和实现有些差异，但是功能是一样的。</p>
<p>•本小节着重介绍集群与堆叠存在的差异之处。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/32.png"></p>
<h2 id="集群基本概念"><a href="#集群基本概念" class="headerlink" title="集群基本概念"></a>集群基本概念</h2><p>•集群中的单台交换机称为集群成员交换机，按照功能不同，可以分为两种角色：</p>
<p>▫主交换机（Master）：主交换机，即Master，负责管理整个集群。</p>
<p>▫备交换机（Standby）：备交换机，即Standby，是主交换机的备份交换机。</p>
<p>•集群ID：即CSS ID，用来标识成员交换机，集群中成员交换机的集群ID是唯一的。</p>
<p>•CSS Link：集群链路，专门用于组建集群，实现主交换机和备交换机之间数据通信。</p>
<p>•集群优先级：即CSS Priority，主要用于角色选举过程中确定成员交换机的角色。优先级值越大优先级越高。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/33.png"></p>
<blockquote>
<p>•备交换机，即Standby，是主交换机的备份交换机。当主交换机故障时，备交换机会接替原主交换机的所有业务。集群中只有一台备交换机。</p>
<p>•集群链路可以是一条链路，也可以是捆绑在一起的多条链路。</p>
<p>•缺省情况下，交换机的集群ID为1。相同ID的两台交换机不能建立集群，所以在建立集群前，需要手工配置集群中一台交换机的集群ID为2。</p>
<p>•交换机的集群优先级越高当选为主交换机的可能性越大，但选举主交换机比较的不止优先级。</p>
</blockquote>
<h2 id="集群控制平面"><a href="#集群控制平面" class="headerlink" title="集群控制平面"></a>集群控制平面</h2><p>•两台交换机使用集群线缆连接好，分别使能集群功能并完成配置后重启，集群系统会自动建立。</p>
<p>•集群系统建立后，在控制平面上，主交换机的主用主控板成为集群系统的控制平面，作为整个系统的管理主角色。备交换机的主用主控板成为集群系统的备用控制平面，作为系统的管理备角色。主交换机和备交换机的备用主控板作为集群系统候选备用主控板。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/34.png"></p>
<blockquote>
<p>•集群主交换机选举规则与堆叠选举规则一致，另外一台交换机则是备交换机。</p>
</blockquote>
<h2 id="集群物理连接"><a href="#集群物理连接" class="headerlink" title="集群物理连接"></a>集群物理连接</h2><p>根据集群技术发展阶段不同，集群物理连接方式也存在区别：</p>
<p>▫传统CSS：使用主控板上的集群卡建立集群连接，或者使用业务口建立集群连接。</p>
<p>▫CSS2：第二代集群交换机系统，专指使用交换网板上的集群卡方式建立集群连接的集群。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/35.png"></p>
<blockquote>
<p>•使用业务口连接时两端成员接口数量、类型相同，接线顺序无限制。</p>
<p>•业务口集群按照链路的分布，有两种组网形式：</p>
<ul>
<li><p>1+0组网：每台成员交换机配置一个逻辑集群端口，物理成员端口分布在一块业务板上，依靠一块业务板上物理成员端口与对框的物理成员端口实现集群连接。</p>
</li>
<li><p>1+1组网：每台成员交换机配置两个逻辑集群端口，物理成员端口分布在两块业务板上，如图所示，不同业务板上的集群链路形成备份。</p>
</li>
</ul>
<p>•CSS2：专指交换网板上通过集群卡方式建立的交换网硬件集群，并且在原有集群技术的基础上，增加了集群主控1+N备份等技术。</p>
</blockquote>
<h2 id="传统CSS"><a href="#传统CSS" class="headerlink" title="传统CSS"></a>传统CSS</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/36.png"></p>
<p>•对于只支持CSS构架的框式交换机，框内接口板之间流量、跨框流量必须经过主控板。</p>
<p>•单框上没有正常工作的主控板时流量无法从一个接口板转发到另外一个接口板，同时也无法跨框转发到另一个框。</p>
<h2 id="CSS2"><a href="#CSS2" class="headerlink" title="CSS2"></a>CSS2</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/37.png"></p>
<p>•支持CSS2构架的框式交换机采用转控分离的构架，单框内接口板之间流量、跨框流量无需经过主控板，集群系统内单台框无能够正常工作的主控板不影响该框的流量转发。</p>
<p>•CSS2支持任意一个框式交换机内存在一个主控板运行正常，集群的两个框式交换机上的接口板都可以正常转发报文，该特性被称为“集群主控1+N备份”。</p>
<h1 id="4-基本配置"><a href="#4-基本配置" class="headerlink" title="4.基本配置"></a>4.基本配置</h1><h2 id="堆叠配置-1"><a href="#堆叠配置-1" class="headerlink" title="堆叠配置 (1)"></a>堆叠配置 (1)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/38.png"></p>
<h2 id="堆叠配置-2"><a href="#堆叠配置-2" class="headerlink" title="堆叠配置 (2)"></a>堆叠配置 (2)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/39.png"></p>
<h2 id="堆叠配置-3"><a href="#堆叠配置-3" class="headerlink" title="堆叠配置 (3)"></a>堆叠配置 (3)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/40.png"></p>
<h2 id="堆叠配置-4"><a href="#堆叠配置-4" class="headerlink" title="堆叠配置 (4)"></a>堆叠配置 (4)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/41.png"></p>
<h2 id="堆叠配置案例"><a href="#堆叠配置案例" class="headerlink" title="堆叠配置案例"></a>堆叠配置案例</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/42.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/43.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/44.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/45.png"></p>
<h2 id="集群配置-1"><a href="#集群配置-1" class="headerlink" title="集群配置 (1)"></a>集群配置 (1)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/46.png"></p>
<h2 id="集群配置-2"><a href="#集群配置-2" class="headerlink" title="集群配置 (2)"></a>集群配置 (2)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/47.png"></p>
<blockquote>
<p>•集群的MAD检测功能，配置方式、配置命令与堆叠一致。</p>
</blockquote>
<h2 id="集群配置案例"><a href="#集群配置案例" class="headerlink" title="集群配置案例"></a>集群配置案例</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/48.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/49.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/50.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/51.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）堆叠加入与堆叠合并有什么区别？</p>
<p><strong>堆叠加入是交换机未上电之前已经通过堆叠线缆连接到了已有的堆叠系统，当上电启动之后因为堆叠系统已经存在主交换机，所以该交换机只会竞选成为从交换机。堆叠合并是两个堆叠系统通过堆叠线缆连在一起，此时两个堆叠系统会竞选新的主交换机并更新拓扑。<br> 一台交换机已经上电之后自身会成为一个堆叠系统并且由于没有竞争者自己会成为主交换机，这种情况下把该交换机通过堆叠线缆与另外一个堆叠系统相连就属于堆叠合并，这是一种典型的堆叠合并与堆叠加入的差异性场景。</strong></p>
<p>2.（简答题）多主检测的目的是？多主检测失败的一方会采取什么操作？</p>
<p><strong>防止堆叠、集群分裂之后相同的IP地址、MAC地址造成网络中其他网络设备的表项冲突，从而导致转发异常。检测失败的一方将会关闭除保留端口之外的所有端口，从而避免相同IP地址、相同MAC地址对其他网络设备造成表项冲突。</strong></p>
<p>3.（简答题） CSS2相比较于传统CSS区别在于？</p>
<p><strong>CSS2支持1+N主控备份，整个集群系统中只要有一个主控板处于工作状态，整个集群系统的控制平面可以正常工作的情况下，集群系统整体的数据平面就可以正常转发报文。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•堆叠、集群技术大大简化了网络部署的复杂化、降低了网络管理的复杂度，实现了快速部署高可靠、无环的园区网络，同时也极大地降低了网络故障的影响时间。</p>
<p>•为防止相同的IP地址、MAC地址造成的转发异常，可以配置MAD检测，MAD检测分为直接连接的检测方式以及代理设备检测，MAD竞争失败的一方会关闭除保留端口之外的所有物理端口。</p>
<p>•为保证报文的转发效率，在堆叠、集群上部署Eth-Trunk时尽量开启本地优先转发尽量避免跨框流量的产生。</p>
<p>•CSS2技术通过交换网板上的集群卡进行集群，结合交换机转控分离的构架，可以实现主控的1+N备份。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/" itemprop="url">IP-园区网典型技术应用概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-16T20:09:50+08:00">
                2021-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•工厂、政府机关、商场、写字楼、校园、公园等，这些场所内为了实现数据互通而搭建的网络都可以称之为园区网。园区有大有小，有行业属性的不同，相应地，园区网络也变化多样。但是，无论如何变化，园区网络一般划分为出口层、核心层、汇聚层及接入层。</p>
<p>•本课程主要介绍园区网络的总体架构、网络各层次中所使用的常用技术及协议、典型的组网场景。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述大型园区网络的典型架构。</p>
<p>▫描述常用以太网交换技术。</p>
<p>▫描述WLAN常见应用场景。</p>
<p>▫描述园区网络可靠性的常用技术。</p>
<p>▫描述园区网络网络服务与管理的常用技术。</p>
<p>▫描述园区网络安全的常用技术。</p>
<p>▫描述园区网络常用的VPN技术。</p>
<h1 id="1-园区网络架构与常见技术概述"><a href="#1-园区网络架构与常见技术概述" class="headerlink" title="1.园区网络架构与常见技术概述"></a>1.<strong>园区网络架构与常见技术概述</strong></h1><h2 id="“城市，除了马路，都是园区”"><a href="#“城市，除了马路，都是园区”" class="headerlink" title="“城市，除了马路，都是园区”"></a>“城市，除了马路，都是园区”</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/1.png"></p>
<h2 id="什么是园区网络？"><a href="#什么是园区网络？" class="headerlink" title="什么是园区网络？"></a>什么是园区网络？</h2><p>•园区网络一般是指企业或者机构的内部网络。</p>
<p>•园区网络的主要目的是使企业或者机构的各项业务运作更有效率。</p>
<p>•按规模可以将园区网络划分成：</p>
<p>▫大型园区网络：终端用户数量/个 &gt; 2000；网元数量/个 &gt; 100。</p>
<p>▫中型园区网络：2000 &gt; 终端用户数量/个 &gt; 200；100 &gt;网元数量/个 &gt; 25。</p>
<p>▫小型园区网络：终端用户数量/个 &lt; 200；网元数量/个 &lt; 25。</p>
<p>•有些企业还存在不同地域的办公分支机构，每个分支机构网络可看做一个单园区网络。</p>
<h2 id="常见的行业园区网"><a href="#常见的行业园区网" class="headerlink" title="常见的行业园区网"></a>常见的行业园区网</h2><p>•企业园区网络</p>
<p>▫关注网络可靠性、先进性，持续提升员工的办公体验，保障运营生产的效率和质量。</p>
<p>•校园网络</p>
<p>▫分为普教园区和高教园区。</p>
<p>▫高教园区相对复杂，通常存在教研网、学生网，还可能有运营性的宿舍网络。</p>
<p>▫网络可管理性、安全性要求高；对网络先进性亦有要求。</p>
<p>•政务园区网络</p>
<p>▫通常指政府机构的内部网络。</p>
<p>▫安全要求极高，通常采用内网和外网隔离的措施保障涉密信息的绝对安全。</p>
<p>•商业园区网络</p>
<p>▫商场、超市、酒店、公园等。</p>
<p>▫网络主要用于服务消费者，此外还包含服务内部办公的子网。</p>
<p>▫提供上网服务，并构建商业智能化系统提升用户体验，降低运维成本，提升商业效率，实现价值转移。</p>
<blockquote>
<p>•为了满足不同行业园区的需求，园区网络架构会根据其服务的行业特点进行设计， 最终打造的是带有行业属性的园区网络方案。</p>
</blockquote>
<h2 id="园区网络典型架构"><a href="#园区网络典型架构" class="headerlink" title="园区网络典型架构"></a>园区网络典型架构</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/2.png"></p>
<p>•<strong>核心层</strong>：是园区网骨干，是园区数据交换的核心，联接园区网的各个组成部分，如数据中心、管理中心、园区出口等。</p>
<p>•<strong>汇聚层</strong>：处于园区网的中间层次，完成数据汇聚或交换的功能，可以提供一些关键的网络基本功能，如路由、安全等。</p>
<p>•<strong>接入层</strong>：为终端用户提供园区网接入功能，是园区网的边界。</p>
<p>•<strong>出口区</strong>：园区内部网络到外部网络的边界，用于实现内部用户接入到公网，外部用户（包括客户、合作伙伴、分支机构、远程用户等）接入到内部网络。</p>
<p>•<strong>数据中心区</strong>：部署服务器和应用系统的区域，为企业内部和外部用户提供数据和应用服务。</p>
<h2 id="园区网络主要协议-技术"><a href="#园区网络主要协议-技术" class="headerlink" title="园区网络主要协议/技术"></a>园区网络主要协议/技术</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/3.png"></p>
<blockquote>
<p>•NAT：Network Address Translation，网络地址转换。</p>
<p>•LLDP：Link Layer Discovery Protocol，链路层发现协议。链路层发现协议是IEEE 802.1ab中定义的第二层发现协议。通过采用LLDP技术，在网络规模迅速扩大时，网管系统可以快速掌握二层网络拓扑信息、拓扑变化信息。</p>
<p>•NETCONF：Network Configuration Protocol，网络配置协议。NETCONF是一种提供网络设备配置管理的协议，采用基于数据编码的可扩展标记语言配置数据以及协议信息，提供了安装、操作和删除网元配置的机制。</p>
<p>•YANG：Yet Another Next Generation，通过NETCONF网络配置协议发送的数据的数据建模语言，可以用来建模网元的配置数据和状态数据。</p>
<p>•SNMP：Simple Network Management Protocol，简单网络管理协议。</p>
<p>•VRRP：Virtual Router Redundancy Protocol，虚拟路由冗余协议。</p>
<p>•MSTP：Multiple Spanning Tree Protocol，多生成树协议。</p>
</blockquote>
<h1 id="2-以太网交换基础"><a href="#2-以太网交换基础" class="headerlink" title="2.以太网交换基础"></a>2.以太网交换基础</h1><h2 id="从TCP-IP对等模型说起"><a href="#从TCP-IP对等模型说起" class="headerlink" title="从TCP/IP对等模型说起"></a>从TCP/IP对等模型说起</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/4.png"></p>
<p>•将网络的通信过程划分为小一些、简单一些的部件，有助于各个部件的开发、设计和故障排除。</p>
<p>•通过网络组件的标准化，允许多个供应商进行开发。</p>
<p>•通过定义在模型的每一层实现什么功能，鼓励产业的标准化。</p>
<p>•允许各种类型的网络硬件和软件相互通信。</p>
<h2 id="从园区网络到以太网二层交换"><a href="#从园区网络到以太网二层交换" class="headerlink" title="从园区网络到以太网二层交换"></a>从园区网络到以太网二层交换</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/5.png"></p>
<p>•接入层为用户提供各种接入方式，是终端接入网络的第一层。</p>
<p>•接入层通常由接入交换机组成，接入层交换机在网络中数量众多，安装位置分散，通常是简单的二层交换机。</p>
<p>•如果终端层存在无线终端设备，接入层需要无线接入点AP设备，AP设备通过接入交换机接入网络。</p>
<h2 id="什么是二层交换"><a href="#什么是二层交换" class="headerlink" title="什么是二层交换"></a>什么是二层交换</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/6.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/7.png"></p>
<p>•二层交换是以太网交换机的基本功能。</p>
<p>•二层交换指的是交换机根据数据帧的第二层头部中的目的MAC地址进行帧转发的行为。</p>
<p>•每台交换机都维护一个MAC地址表，用于指导数据帧转发。</p>
<p>•当交换机收到数据帧时，将在其MAC地址表中查询该帧的目的MAC地址，并根据匹配的表项执行相应的操作。此外，交换机收到数据帧时，还会进行源MAC地址学习。</p>
<blockquote>
<p>•二层交换设备工作在OSI模型的第二层，即数据链路层，它对数据包的转发是建立在MAC（Media Access Control ）地址基础之上的。</p>
<p>•二层交换设备通过解析和学习以太网帧的源MAC来维护MAC地址与接口的对应关系（保存MAC与接口对应关系的表称为MAC表），通过其目的MAC来查找MAC表决定向哪个接口转发。</p>
<p>•二层交换设备不同的接口发送和接收数据独立，各接口属于不同的冲突域，因此有效地隔离了网络中物理层冲突域，使得通过它互连的主机（或网络）之间不必再担心流量大小对于数据发送冲突的影响。</p>
</blockquote>
<h2 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/8.png"></p>
<p>•VLAN（Virtual Local Area Network）即虚拟局域网，是将一个物理的LAN在逻辑上划分成多个广播域的通信技术。</p>
<p>•一个VLAN中所有设备都是在同一广播域内，不同的VLAN为不同的广播域。</p>
<p>•VLAN内的设备间可以直接通信，而VLAN间不能直接互通。</p>
<p>•VLAN之间互相隔离，不同VLAN间需通过三层设备实现相互通信。</p>
<p>•一个VLAN一般为一个逻辑子网。</p>
<p>•VLAN中成员多基于交换机的端口分配，所谓的VLAN划分，通常指的是将交换机的接口添加到特定的VLAN中，从而该接口所连接的设备也加入到了该VLAN。</p>
<h2 id="以太网二层接口类型概述"><a href="#以太网二层接口类型概述" class="headerlink" title="以太网二层接口类型概述"></a>以太网二层接口类型概述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/9.png"></p>
<p>交换机的以太网二层接口主要存在以下三种类型：</p>
<p>•<strong>Access</strong>：常用来连接用户PC、服务器等终端设备的接口。Access接口所连接的这些设备的网卡往往只收发无标记帧。Access接口只能加入一个VLAN。</p>
<p>•<strong>Trunk</strong>：Trunk接口允许多个VLAN的数据帧通过，这些数据帧通过802.1Q Tag实现区分。Trunk接口常用于交换机之间的互联，也用于连接路由器、防火墙等设备的子接口。</p>
<p>•<strong>Hybrid</strong>：Hybrid接口与Trunk接口类似，也允许多个VLAN的数据帧通过，这些数据帧通过802.1Tag实现区分。用户可以灵活指定Hybrid接口在发送某个（或某些）VLAN的数据帧时是否携带Tag。</p>
<h3 id="Access接口"><a href="#Access接口" class="headerlink" title="Access接口"></a>Access接口</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/10.png"></p>
<blockquote>
<p>•所有的二层接口无论其类型如何，都有一个缺省VLAN ID，这个缺省VLAN ID被称为PVID（Port Default VLAN ID），在华为的交换机上，PVID缺省为1。另外，出于提高数据帧处理效率的考虑，在交换机内部，数据帧一律携带Tag。 </p>
</blockquote>
<h3 id="Trunk接口"><a href="#Trunk接口" class="headerlink" title="Trunk接口"></a>Trunk接口</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/11.png"></p>
<h3 id="Hybrid接口"><a href="#Hybrid接口" class="headerlink" title="Hybrid接口"></a>Hybrid接口</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/12.png"></p>
<p>•Hybrid接口也能承载多个VLAN的数据，它与Trunk接口在数据帧的接收行为上大体相同，这里不再赘述。Trunk接口在发送数据帧时，仅当待发送的数据帧与发送接口的PVID相同时，数据帧的Tag才会被移除，除此之外，该接口发送出去的其他VLAN的数据帧都是携带Tag的。而Hybrid接口发送数据帧的行为则与Trunk接口不同。我们可以通过命令指定Hybrid接口在发送某个，或者某些VLAN的数据帧时不携带Tag。</p>
<h3 id="VLAN划分方式总览"><a href="#VLAN划分方式总览" class="headerlink" title="VLAN划分方式总览"></a>VLAN划分方式总览</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/13.png"></p>
<h3 id="实现VLAN之间的IP可达性"><a href="#实现VLAN之间的IP可达性" class="headerlink" title="实现VLAN之间的IP可达性"></a>实现VLAN之间的IP可达性</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/14.png"></p>
<h2 id="以太网链路聚合"><a href="#以太网链路聚合" class="headerlink" title="以太网链路聚合"></a>以太网链路聚合</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/15.png"></p>
<p>•<strong>链路聚合（Link Aggregation,LAG）</strong>是将多条物理链路捆绑在一起成为一条逻辑链路，从而增加链路带宽的技术。</p>
<p>•完成聚合后的链路称为以太网聚合链路。</p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/16.png"></p>
<blockquote>
<p>•随着网络规模不断扩大，用户对骨干链路的带宽和可靠性提出越来越高的要求。在传统技术中，常用更换高速率的接口板或更换支持高速率接口板的设备的方式来增加带宽，但这种方案需要付出高额的费用，而且不够灵活。</p>
<p>•采用链路聚合技术可以在不进行硬件升级的条件下，通过将多个物理接口捆绑为一个逻辑接口，达到增加链路带宽的目的。在实现增大带宽目的的同时，链路聚合采用备份链路的机制，可以有效的提高设备之间链路的可靠性。</p>
<p>•LAG是指将若干条以太链路捆绑在一起所形成的逻辑链路，简写为Eth-Trunk。每个聚合组唯一对应着一个逻辑接口，这个逻辑接口称之为聚合接口或Eth-Trunk接口。</p>
<p>•链路聚合技术主要有以下三个优势：</p>
<p>▫增加带宽：链路聚合接口的最大带宽可以达到各成员接口带宽之和。</p>
<p>▫提高可靠性：当某条活动链路出现故障时，流量可以切换到其他可用的成员链路上。</p>
<p>▫负载分担：在一个链路聚合组内，可以实现在各成员活动链路上的负载分担。</p>
</blockquote>
<h2 id="生成树技术：防环-保证二层网络可靠性"><a href="#生成树技术：防环-保证二层网络可靠性" class="headerlink" title="生成树技术：防环+保证二层网络可靠性"></a>生成树技术：防环+保证二层网络可靠性</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/17.png"></p>
<p>•解决交换网络中的环路问题</p>
<p>•动态地适应根据网络拓扑变更</p>
<p>•配合冗余链路，保证二层网络可靠性</p>
<h1 id="3-无线接入"><a href="#3-无线接入" class="headerlink" title="3.无线接入"></a>3.无线接入</h1><h2 id="WLAN与主要网元"><a href="#WLAN与主要网元" class="headerlink" title="WLAN与主要网元"></a>WLAN与主要网元</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/18.png"></p>
<h2 id="WLAN组网架构综述"><a href="#WLAN组网架构综述" class="headerlink" title="WLAN组网架构综述"></a>WLAN组网架构综述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/19.png"></p>
<blockquote>
<p>无线接入点 (AP, Access Point)</p>
<p>▫一般支持FAT AP（胖AP）、FIT AP（瘦AP）和云管理AP三种工作模式，根据网络规划的需求，可以灵活地在多种模式下切换。</p>
<p>▫FAT AP：适用于家庭，独立工作，需单独配置，功能较为单一，成本低。独立完成用户接入、认证、数据安全、业务转发和QoS等功能。</p>
<p>▫FIT AP：适用于大中型企业，需要配合AC使用，由AC统一管理和配置，功能丰富，对网络维护人员的技能要求高。用户接入、AP上线、认证、路由、AP管理、安全协议、QoS等功能需要同AC配合完成。</p>
<p>▫云管理：适用于中小型企业，需要配合云管理平台使用，由云管理平台统一管理和配置，功能丰富，即插即用，对网络维护人员的技能要求低。</p>
<p>无线接入控制器 (AC, Access Controller)</p>
<p>▫一般位于整个网络的汇聚层，提供高速、安全、可靠的WLAN业务。</p>
<p>▫提供大容量、高性能、高可靠性、易安装、易维护的无线数据控制业务，具有组网灵活、绿色节能等优势。</p>
</blockquote>
<h2 id="AC-FIT-AP架构"><a href="#AC-FIT-AP架构" class="headerlink" title="AC+FIT AP架构"></a>AC+FIT AP架构</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/20.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/21.png"></p>
<blockquote>
<p>•AC和AP之间使用的通信协议是无线接入点控制和配置（Control And Provisioning of Wireless Access Points，CAPWAP）。CAPWAP协议定义的主要内容有：AP自动发现AC，AC对AP进行安全认证，AP从AC获取软件，AP从AC获得初始和动态配置等。通过该协议，AP和AC之间建立起CAPWAP隧道。CAPWAP隧道有两种：控制隧道和数据隧道。控制隧道主要传输控制报文（也称管理报文，是AC管理控制AP的报文）；数据隧道主要传输数据报文。CAPWAP隧道可以进行数据传输层安全（Datagram Transport Layer Security，DTLS）加密，因此传输的报文更加安全。</p>
<p>•相比于FAT AP架构，AC+FIT AP架构的优点如下。</p>
<p>▫配置与部署：通过AC进行集中地网络配置和管理，不再需要对每个AP进行单独配置操作，同时对整网AP进行信道、功率的自动调整，免去了烦琐的人工调整过程。</p>
<p>▫安全性：由于FAT AP无法进行统一的升级操作，无法保证所有AP版本都有最新的安全补丁，而AC+FIT AP架构主要的安全能力是在AC上的，软件更新和安全配置仅需在AC上进行，从而可以快速进行全局安全设置；同时，为了防止加载恶意代码，设备会对软件进行数字签名认证，增强了更新过程的安全性。AC也实现了FAT AP架构无法支持的一些安全功能，包括病毒检测、统一资源定位地址（Uniform Resource Locater，URL）过滤、状态检测防火墙等高级安全特性。</p>
<p>▫更新与扩展：架构的集中管理模式使得同一AC下的AP有着相同的软件版本。当需要更新时，先由AC获取更新包或补丁，然后由AC统一更新AP版本。AP和AC的功能拆分也减少了对AP版本的频繁更新，有关用户认证、网管和安全等功能的更新只需在AC上进行。</p>
</blockquote>
<h2 id="AC-FIT-AP架构-1"><a href="#AC-FIT-AP架构-1" class="headerlink" title="AC+FIT AP架构"></a>AC+FIT AP架构</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/22.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/23.png"></p>
<h1 id="4-网络可靠性"><a href="#4-网络可靠性" class="headerlink" title="4.网络可靠性"></a>4.网络可靠性</h1><h2 id="使用VRRP实现网关冗余"><a href="#使用VRRP实现网关冗余" class="headerlink" title="使用VRRP实现网关冗余"></a>使用VRRP实现网关冗余</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/24.png"></p>
<blockquote>
<p>•虚拟路由冗余协议VRRP（Virtual Router Redundancy Protocol）通过把几台路由设备联合组成一台虚拟的路由设备，将虚拟路由设备的IP地址作为用户的默认网关实现与外部网络通信。当网关设备发生故障时，VRRP机制能够选举新的网关设备承担数据流量，从而保障网络的可靠通信。</p>
<p>•通常，同一网段内的所有主机上都设置一条相同的、以网关为下一跳的缺省路由。主机发往其他网段的报文将通过缺省路由发往网关，再由网关进行转发，从而实现主机与外部网络的通信。当网关发生故障时，本网段内所有以网关为缺省路由的主机将无法与外部网络通信。增加出口网关是提高系统可靠性的常见方法，此时如何在多个出口之间进行选路就成为需要解决的问题。</p>
<p>•VRRP的出现很好的解决了这个问题。VRRP能够在不改变组网的情况下，将多台路由设备组成一个虚拟路由器，通过配置虚拟路由器的IP地址为默认网关，实现默认网关的备份。</p>
<ul>
<li><strong>冗余备份</strong>：VRRP可以将多台路由设备配置为缺省网关路由器，当出现单点故障的时候通过备份链路进行业务传输，从而降低网络故障的可能性，保证用户的各种业务不中断传输。</li>
<li><strong>负载分担</strong>：VRRP可以实现多台设备同时承担业务流量，从而减轻主用设备上数据流量的承载压力，在路由设备之间更均衡地分担流量。</li>
<li><strong>联动功能</strong>：VRRP联动可以监视上行链路的故障。当上行接口或链路故障时，VRRP备份组的Master设备降低优先级，重新进行选举，确保Master路由器为最佳的VRRP路由设备，保证流量的正常转发。VRRP与BFD联动可以提高VRRP备份组中主备设备的切换速度。利用BFD检测速度快的特点，在Master设备和Backup设备之间建立BFD会话并与VRRP备份组进行绑定，实现Master设备和Backup设备之间的链路出现故障时，Backup设备迅速切换为Master，承担网络流量。</li>
</ul>
</blockquote>
<h2 id="集群-堆叠简介"><a href="#集群-堆叠简介" class="headerlink" title="集群/堆叠简介"></a>集群/堆叠简介</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/25.png"></p>
<p>•iStack（Intelligent Stack，智能堆叠），简称堆叠，是指将多台支持堆叠特性的交换机设备组合在一起，从逻辑上组合成一台交换设备。iStack针对华为盒式交换机。</p>
<p>•CSS（Cluster Switch System，集群交换机系统），又称为集群，是指将两台支持集群特性的交换机设备组合在一起，从逻辑上组合成一台交换设备。CSS针对华为框式交换机。</p>
<h2 id="堆叠与园区网络树形结构组网形态"><a href="#堆叠与园区网络树形结构组网形态" class="headerlink" title="堆叠与园区网络树形结构组网形态"></a>堆叠与园区网络树形结构组网形态</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/26.png"></p>
<p>•堆叠iStack（Intelligent Stack），是指将多台支持堆叠特性的交换机设备组合在一起，从逻辑上组合成一台整体交换设备。</p>
<p>•堆叠系统建立之前，每台交换机都是单独的实体，有自己独立的IP地址和MAC地址，对外体现为多台交换机，用户需要独立的管理所有的交换机；堆叠建立后堆叠成员对外体现为一个统一的逻辑实体，用户使用一个IP地址对堆叠中的所有交换机进行管理和维护，如图所示。通过交换机堆叠，可以实现网络大数据量转发和网络高可靠性，同时简化网络管理。</p>
<h1 id="5-网络服务与网络管理"><a href="#5-网络服务与网络管理" class="headerlink" title="5.网络服务与网络管理"></a>5.网络服务与网络管理</h1><h2 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/27.png"></p>
<blockquote>
<p>•动态主机配置协议DHCP（Dynamic Host Configuration Protocol）是一种用于集中对用户IP地址进行动态管理和配置的技术。即使规模较小的网络，通过DHCP也可以使后续增加网络设备变得简单快捷。</p>
<p>•DHCP允许计算机动态地获取IP地址，而不是静态为每台主机指定地址。</p>
<p>•DHCP能够分配其他配置参数，例如客户端的启动配置文件，使客户端仅用一个消息就获取它所需要的所有配置信息。</p>
<p>•DHCP协议由RFC 2131定义，采用客户端/服务器通信模式，由客户端（DHCP Client）向服务器（DHCP Server）提出配置申请，服务器返回为客户端分配的配置信息。</p>
<p>•DHCP可以提供两种地址分配机制，网络管理员可以根据网络需求为不同的主机选择不同的分配策略。</p>
<p>▫动态分配机制：通过DHCP为主机分配一个有使用期限（这个使用期限通常叫做租期）的IP地址。这种分配机制适用于主机需要临时接入网络或者空闲地址数小于网络主机总数且主机不需要永久连接网络的场景。</p>
<p>▫静态分配机制：网络管理员通过DHCP为指定的主机分配固定的IP地址。相比手工静态配置IP地址，通过DHCP方式静态分配机制避免人工配置发生错误，方便管理员统一维护管理。</p>
<p>•DHCP受益主要有以下两点：</p>
<p>▫降低客户端的配置和维护成本</p>
<p>▫集中管理</p>
</blockquote>
<h2 id="NTP"><a href="#NTP" class="headerlink" title="NTP"></a>NTP</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/28.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/29.png"></p>
<blockquote>
<p>•网络时间协议NTP（Network Time Protocol）是TCP/IP协议族里面的一个应用层协议。NTP用于在一系列分布式时间服务器与客户端之间同步时钟。NTP的实现基于IP和UDP。NTP报文通过UDP传输，端口号是123。</p>
<p>•随着网络拓扑的日益复杂，整个网络内设备的时钟同步将变得十分重要。如果依靠管理员手工修改系统时钟，不仅工作量巨大，而且时钟的准确性也无法得到保证。NTP的出现就是为了解决网络内设备系统时钟的同步问题。</p>
<p>•NTP主要应用于网络中所有设备时钟需要保持一致的场合，比如：网络管理：对从不同路由器采集来的日志信息、调试信息进行分析时，需要以时间作为参照依据。</p>
<p>▫计费系统：要求所有设备的时钟保持一致。</p>
<p>▫多个系统协同处理同一个复杂事件：为保证正确的执行顺序，多个系统必须参考同一时钟。</p>
<p>▫备份服务器和客户机之间进行增量备份：要求备份服务器和所有客户机之间的时钟同步。</p>
<p>▫系统时间：某些应用程序需要知道用户登录系统的时间以及文件修改的时间。</p>
<p>•交换机既可以作为NTP的服务器，也可以作为NTP的客户端。</p>
</blockquote>
<h2 id="LLDP"><a href="#LLDP" class="headerlink" title="LLDP"></a>LLDP</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/30.png"></p>
<blockquote>
<p>•LLDP（Link Layer Discovery Protocol）是IEEE 802.1ab中定义的链路层发现协议。LLDP是一种标准的二层发现方式，可以将本端设备的管理地址、设备标识、接口标识等信息组织起来，并发布给自己的邻居设备，邻居设备收到这些信息后将其以标准的管理信息库MIB（Management Information Base）的形式保存起来，以供网络管理系统查询及判断链路的通信状况。</p>
<p>•随着网络规模越来越大，网络设备种类繁多，并且各自的配置错综复杂，对网络管理能力的要求也越来越高。传统网络管理系统多数只能分析到三层网络拓扑结构，无法确定网络设备的详细拓扑信息、是否存在配置冲突等。因此需要有一个标准的二层信息交流协议。</p>
<p>•LLDP提供了一种标准的链路层发现方式。通过LLDP获取的设备二层信息能够快速获取相连设备的拓扑状态；显示出客户端、交换机、路由器、应用服务器以及网络服务器之间的路径；检测设备间的配置冲突、查询网络失败的原因。企业网用户可以通过使用网管系统，对支持运行LLDP协议的设备进行链路状态监控，在网络发生故障的时候快速进行故障定位。</p>
</blockquote>
<h2 id="SNMP"><a href="#SNMP" class="headerlink" title="SNMP"></a>SNMP</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/31.png"></p>
<h2 id="NETCONF-YANG"><a href="#NETCONF-YANG" class="headerlink" title="NETCONF/YANG"></a>NETCONF/YANG</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/32.png"></p>
<h1 id="6-网络安全"><a href="#6-网络安全" class="headerlink" title="6.网络安全"></a>6.网络安全</h1><h2 id="园区网络安全概述"><a href="#园区网络安全概述" class="headerlink" title="园区网络安全概述"></a>园区网络安全概述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/33.png"></p>
<h2 id="基于防火墙的安全区域划分及安全策略"><a href="#基于防火墙的安全区域划分及安全策略" class="headerlink" title="基于防火墙的安全区域划分及安全策略"></a>基于防火墙的安全区域划分及安全策略</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/34.png"></p>
<p>•安全区域（Security Zone），或者简称为区域（Zone），是一个安全的概念，大部分的安全策略都基于安全区域实施。</p>
<p>•一个安全区域是防火墙若干接口所连网络的集合，这些网络中的用户具有相同的安全属性。</p>
<p>•将企业员工网络、公司服务器网络、外部网络划分到不同安全区域，对安全区域间的流量进行检测和保护。</p>
<blockquote>
<p>•在一台防火墙上不允许创建两个相同安全级别（Priority）的安全区域；</p>
<p>•防火墙的接口必须加入一个安全区域，否则不能正常转发流量。</p>
<p>•防火墙的一个接口只能属于一个安全区域。</p>
<p>•防火墙的一个安全区域可以拥有多个接口。</p>
<p>•系统自带的缺省安全区域不能删除，用户可以根据实际需求创建自定义的安全区域。</p>
</blockquote>
<h2 id="防火墙双机热备概述"><a href="#防火墙双机热备概述" class="headerlink" title="防火墙双机热备概述"></a>防火墙双机热备概述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/35.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/36.png"></p>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/37.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/38.png"></p>
<h1 id="7-VPN"><a href="#7-VPN" class="headerlink" title="7.VPN"></a>7.VPN</h1><h2 id="VPN技术应用场景"><a href="#VPN技术应用场景" class="headerlink" title="VPN技术应用场景"></a>VPN技术应用场景</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/39.png"></p>
<p>•对于规模较大的企业来说，网络访问需求不仅仅局限于公司总部网络内，分公司、出差员工、合作单位等也需要访问公司总部的网络资源，一般采用VPN（Virtual Private Network，虚拟专用网络）技术来实现这一需求。</p>
<p>•VPN可以在不改变现有网络结构的情况下，建立虚拟专用连接。因其具有廉价、专用和虚拟等多种优势，在现网中应用非常广泛。</p>
<p>•VPN是一类技术的统称，不同的VPN技术拥有不同的特性和实现方式，常见的VPN技术包括IPSec VPN、GRE VPN、L2TP VPN、MPLS VPN等。</p>
<blockquote>
<p>•IPSec：IP Security， 因特网协议安全协议。</p>
<p>•GRE：Generic Routing Encapsulation， 通用路由封装协议。</p>
<p>•L2TP：Layer 2 Tunneling Protocol， 二层隧道协议。</p>
<p>•MPLS：Multiprotocol Label Switching，多协议标签交换协议。</p>
</blockquote>
<h1 id="8-组播"><a href="#8-组播" class="headerlink" title="8.组播"></a>8.组播</h1><h2 id="组播应用场景"><a href="#组播应用场景" class="headerlink" title="组播应用场景"></a>组播应用场景</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/40.png"></p>
<p>•企业存在一些公告信息，例如天气、值班表、机房注意事项、宣传视频等，为方便公司员工和来访人员及时获取这些信息，通常采用在公司人员密集处布置显示屏的方式。</p>
<p>•每一块显示屏显示的内容一致，这是典型的点到多点通信的场景。如果采用单播的方式传递信息，网络中的设备性能及链路带宽都会面临一定程度的浪费。</p>
<p>•组播技术有效地满足了单点发送、多点接收的需求，实现了IP网络中点到多点业务数据的高效传送，能够大量节约网络带宽、降低网络负载。</p>
<blockquote>
<p>•单播（Unicast）是在一台源IP主机和一台目的IP主机之间进行。网络上绝大部分的数据都是以单播的形式传输的，例如电子邮件收发、网上银行都是采用单播实现的。</p>
<ul>
<li>在单播通信中每一个数据包都有确切的目的IP地址；对于同一份数据，如果存在多个接收者，Server需发送与接收者数目相同的单播数据包；当接收者增加到成百上千时，将极大加重Server创建相同数据和发送多份相同拷贝后所产生的消耗，网络中的设备性能及链路带宽都会面临一定程度的浪费；单播方式较适合用户稀少的网络，当用户量较大时很难保证网络传输质量。</li>
</ul>
<p>•广播（Broadcast）是在一台源IP主机和网络中所有其它的IP主机之间进行，属于一对所有的通讯方式，所有主机都可以接收到（不管是否需要）。</p>
<ul>
<li>广播数据包被限制在广播域中；一旦有设备发送广播数据，则广播域内所有设备都会收到这个数据包，并且不得不耗费资源去处理，大量的广播数据包将消耗网络的带宽及设备资源；广播方式只适合共享网段，且信息安全性和有偿服务得不到保障。</li>
</ul>
<p>•组播（Multicast）是在一台源IP主机和多台（一组）IP主机之间进行，中间的网络设备根据接收者的需要，有选择性地对数据进行复制和转发。</p>
</blockquote>
<h2 id="组播网络基本架构"><a href="#组播网络基本架构" class="headerlink" title="组播网络基本架构"></a>组播网络基本架构</h2><p>组播网络大体可以分为三个部分：</p>
<p>▫源端网络：将组播源产生的组播数据发送至组播网络。</p>
<p>▫组播转发网络：形成无环的组播转发路径，该转发路径也被称为组播分发树（Multicast Distribution Tree）。</p>
<p>▫成员端网络：让组播网络感知组播组成员位置与加入的组播组。</p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/41.png"></p>
<blockquote>
<p>•组播源（Source）：组播流量的发送者，例如多媒体服务器。组播源无需运行任何组播协议，只需简单 地将组播数据发送出来即可。 </p>
<p>•组播接收者（Receiver）：也被称为组播组成员，是期望接收特定组播组流量的设备，例如运行多媒体直播客户端软件的PC。</p>
<p>•组播组（Multicast Group）：用IP组播地址进行标识的一个集合。任何用户主机（或其他接收设备），加入一个组播组，就成为了该组成员，可以识别并接收发往该组播组的组播数据。</p>
<p>•组播路由器（Multicast Router）：支持组播、运行组播协议的网络设备，实际上不仅仅路由器能够支持 组播，交换机、防火墙等设备也能够支持组播（取决于设备型号），路由器仅是一个代表。</p>
<p>•第一跳路由器（First-Hop Router）：组播转发路径上，与组播源相连且负责转发该组播源发出的组播数据的PIM路由器。</p>
<p>•最后一跳路由器（Last-Hop Router）：组播转发路径上，与组播组成员相连且负责向该组成员转发组播数据的PIM路由器。</p>
<p>•IGMP（Internet Group Management Protocol，因特网组管理协议），是TCP/IP协议族中负责IP组播成员管理的协议，它用来在接收者和与其直接相邻的组播路由器之间建立、维护组播组成员关系。</p>
</blockquote>
<h1 id="9-IPv6"><a href="#9-IPv6" class="headerlink" title="9.IPv6"></a>9.IPv6</h1><h2 id="IPv6概述"><a href="#IPv6概述" class="headerlink" title="IPv6概述"></a>IPv6概述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/42.png"></p>
<p>•IPv4协议是目前广泛部署的因特网协议。在因特网发展初期，IPv4以其协议简单、易于实现、互操作性好的优势而得到快速发展。但随着因特网的迅猛发展， IPv4地址空间不足的问题日趋明显，IPv6取代IPv4势在必行。</p>
<p>•IPv6（Internet Protocol Version 6）是网络层协议的第二代标准协议，也被称为IPng（IP Next Generation）。它是Internet工程任务组IETF（Internet Engineering Task Force）设计的一套规范，是IPv4（Internet Protocol Version 4）的升级版本。</p>
<p>•IPv6地址长度为128 bit，海量的地址空间，满足物联网等新兴业务、有利于业务演进及扩展。</p>
<h2 id="ICMPv6"><a href="#ICMPv6" class="headerlink" title="ICMPv6"></a>ICMPv6</h2><p>•ICMPv6 （Internet Control Message Protocol for IPv6）是IPv6的基础协议之一。</p>
<p>•ICMPv6报文被广泛应用于其它协议中，包括NDP、PathMTU发现机制等。</p>
<p>•ICMPv6控制着IPv6中的地址自动配置、地址解析、地址冲突检测、路由选择、以及差错控制等关键环节。</p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/43.png"></p>
<blockquote>
<p>•NDP：Neighbor Discovery Protocol，邻居发现协议。</p>
</blockquote>
<h2 id="IPv6路由"><a href="#IPv6路由" class="headerlink" title="IPv6路由"></a>IPv6路由</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/44.png"></p>
<p>IPv6网络支持静态路由和动态路由协议：</p>
<ul>
<li><p>静态路由：</p>
<ul>
<li>IPv6静态路由的配置方式和IPv4静态路由的配置方式相同。</li>
</ul>
</li>
<li><p>动态路由协议：</p>
<ul>
<li>OSPFv3</li>
<li>IS-IS</li>
<li>BGP4+</li>
</ul>
</li>
</ul>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）以下关于交换机二层接口的描述，正确的是？(   )</p>
<p><strong>A.交换机的二层接口类型有Access、Trunk、Hybrid。</strong></p>
<p><strong>B.Access接口只能加入一个VLAN。</strong></p>
<p><strong>C.缺省情况下，Trunk接口允许VLAN1的流量通过，而且在发送时不携带VLAN Tag。</strong></p>
<p><strong>D.在Hybrid接口上可通过命令指定接口在发送特定VLAN的流量时，是否携带VLAN Tag。</strong></p>
<p>2.（多选题）以太网链路聚合技术有哪些优势？(   )</p>
<p><strong>A.增加带宽：链路聚合接口的最大带宽可以达到各成员接口带宽之和。</strong></p>
<p><strong>B.提高可靠性：当某条活动链路出现故障时，流量可以切换到其他可用的成员链路上。</strong></p>
<p><strong>C.负载分担：在一个链路聚合组内，可以实现在各成员活动链路上的负载分担。</strong></p>
<p>D.智能调优：可根据流量大小自动调整活动接口数量。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本章系统地介绍了园区网络典型技术场景化应用：以太网交换基础、无线接入、网络可靠性、网络服务与网络管理、路由与网络可达性、网络安全、VPN。</p>
<p>•受限于课程篇幅，本文无法将园区网络中所用的技术一一列举。通过本章的学习，读者已经了解园区网络的典型架构，以及典型技术在园区网络中的应用，有助于读者继续学习后续课程。</p>
<p>•在后续的课程中，我们将深入探讨园区网络的关键技术，为将来学习园区网络解决方案打下扎实基础。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/" itemprop="url">IP-流量过滤与转发路径控制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-16T20:09:21+08:00">
                2021-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•传统的路由转发原理是首先根据报文的目的地址查找路由表，然后进行报文转发。随着业务的发展，用户更加希望能够在传统路由转发的基础上根据自己定义的策略进行报文转发和选路。</p>
<p>•为提高网络安全性，用户希望能够控制进入网络的报文，将没有权限进入网络或存在安全隐患的报文隔离在网络边界。</p>
<p>•本课程将会学习流量过滤技术、策略路由以及使用MQC（Modular QoS Command-Line Interface，模块化QoS命令行）的方式控制报文的转发路径和进行流量过滤。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述策略路由的使用场景</p>
<p>▫阐明策略路由的分类</p>
<p>▫描述如何使用MQC配置策略路由</p>
<p>▫描述如何使用MQC过滤报文</p>
<h1 id="1-策略路由"><a href="#1-策略路由" class="headerlink" title="1.策略路由"></a>1.策略路由</h1><h2 id="策略路由技术背景"><a href="#策略路由技术背景" class="headerlink" title="策略路由技术背景"></a>策略路由技术背景</h2><p>在某些场景中我们希望一些特定用户、特定业务的流量走指定的转发路径，而其余用户或业务的流量则依旧根据路由表进行转发。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/1.png"></p>
<h2 id="PBR介绍-基本概念"><a href="#PBR介绍-基本概念" class="headerlink" title="PBR介绍 - 基本概念"></a>PBR介绍 - 基本概念</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/2.png"></p>
<p>•PBR（Policy-Based Routing，策略路由）：PBR使得网络设备不仅能够基于报文的目的IP地址进行数据转发，更能基于其他元素进行数据转发，例如源IP地址、源MAC地址、目的MAC地址、源端口号、目的端口号、VLAN-ID等等。</p>
<p>•用户还可以使用ACL匹配特定的报文，然后针对该ACL进行PBR部署。</p>
<p>•若设备部署了PBR，则被匹配的报文优先根据PBR的策略进行转发，即PBR策略的优先级高于传统路由表。</p>
<h2 id="PBR介绍-结构"><a href="#PBR介绍-结构" class="headerlink" title="PBR介绍 - 结构"></a>PBR介绍 - 结构</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/3.png"></p>
<p>•PBR与Route-Policy类似，由多个节点组成，每个节点由匹配条件（条件语句）和执行动作（执行语句）组成。</p>
<p>•每个节点内可包含多个条件语句。</p>
<p>•节点内的多个条件语句之间的关系为“与”，即匹配所有条件语句才会执行本节点内的动作。</p>
<p>•节点之间的关系为“或”，PBR根据节点编号从小到大顺序执行，匹配当前节点将不会继续向下匹配。</p>
<h2 id="PBR介绍-命令语法"><a href="#PBR介绍-命令语法" class="headerlink" title="PBR介绍 - 命令语法"></a>PBR介绍 - 命令语法</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/4.png"></p>
<blockquote>
<p>•PBR的节点匹配模式：</p>
<p>​    ▫permit表示对满足匹配条件的报文进行策略路由</p>
<p>​    ▫deny表示对满足匹配条件的报文不进行策略路由</p>
</blockquote>
<h2 id="PBR与路由策略区别"><a href="#PBR与路由策略区别" class="headerlink" title="PBR与路由策略区别"></a>PBR与路由策略区别</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/5.png"></p>
<h2 id="PBR的分类"><a href="#PBR的分类" class="headerlink" title="PBR的分类"></a>PBR的分类</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/6.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/7.png"></p>
<h2 id="PBR典型应用场景-1"><a href="#PBR典型应用场景-1" class="headerlink" title="PBR典型应用场景 (1)"></a>PBR典型应用场景 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/8.png"></p>
<p>•内网防火墙旁挂部署在核心交换机，为防护内网在核心交换机的三层接口上部署PBR，将来自外部网络的流量牵引到防火墙上进行安全检查，检查完的流量再发送回核心交换机，由核心交换机依据路由表转发到内网。</p>
<p>•将流量牵引到别的设备进行安全检查等类似的行为我们称之为“引流”，PBR是一种常见的引流工具。</p>
<h2 id="PBR典型应用场景-2"><a href="#PBR典型应用场景-2" class="headerlink" title="PBR典型应用场景 (2)"></a>PBR典型应用场景 (2)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/9.png"></p>
<p>当企业存在多个网络出口时，若想指定部分网段访问Internet时的网络出口，可以使用PBR：在出口设备的内网接口配置PBR，匹配来自内网的流量，为其指定不同的下一跳公网地址。</p>
<h2 id="配置介绍-1"><a href="#配置介绍-1" class="headerlink" title="配置介绍 (1)"></a>配置介绍 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/10.png"></p>
<blockquote>
<p>•当ACL的rule配置为permit时，设备会对匹配该规则的报文执行本地策略路由的动作：</p>
<ul>
<li><p>本地策略路由中策略点为permit时对满足匹配条件的报文进行策略路由；</p>
</li>
<li><p>本地策略路由中策略点为deny时对满足匹配条件的报文不进行策略路由，即根据目的地址查找路由表转发报文。</p>
</li>
</ul>
<p>•当ACL配置了rule，如果报文未匹配上任何规则，则根据目的地址查找路由表转发报文。</p>
<p>•当ACL的rule配置为deny或ACL未配置规则时，应用该ACL的本地策略路由不生效，即根据目的地址查找路由表转发报文。</p>
</blockquote>
<h2 id="配置介绍-2"><a href="#配置介绍-2" class="headerlink" title="配置介绍 (2)"></a>配置介绍 (2)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/11.png"></p>
<blockquote>
<p>•除了该方式之外，接口策略路由还可以使用MQC的方式进行配置。</p>
</blockquote>
<h2 id="配置案例-1"><a href="#配置案例-1" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/12.png"></p>
<p>需求：</p>
<p>▫内网存在两个网段，网段1：10.1.1.0/24，网段2：10.1.2.0/24，在RTA的GE0/0/0接口部署PBR，实现网段1访问Internet通过ISP1、网段2访问Internet通过ISP2。</p>
<p>▫RTA上旁挂了一台服务器，要求在RTA上部署的策略路由不影响内网用户访问该服务器。</p>
<h2 id="配置案例-2"><a href="#配置案例-2" class="headerlink" title="配置案例 (2)"></a>配置案例 (2)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/13.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/14.png"></p>
<h2 id="配置案例-3"><a href="#配置案例-3" class="headerlink" title="配置案例 (3)"></a>配置案例 (3)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/15.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/16.png"></p>
<h1 id="2-MQC"><a href="#2-MQC" class="headerlink" title="2.MQC"></a>2.MQC</h1><h2 id="MQC介绍-1"><a href="#MQC介绍-1" class="headerlink" title="MQC介绍 (1)"></a>MQC介绍 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/17.png"></p>
<p>•MQC（Modular QoS Command-Line Interface，模块化QoS命令行）是指通过将具有某类共同特征的数据流划分为一类，并为同一类数据流提供相同的服务，也可以对不同类的数据流提供不同的服务。</p>
<p>•MQC包含三个要素：流分类（traffic classifier）、流行为（traffic behavior）和流策略（traffic policy）。</p>
<p>•MQC的流行为支持重定向报文，因此可以使用MQC实现IP单播策略路由。</p>
<h2 id="MQC介绍-2"><a href="#MQC介绍-2" class="headerlink" title="MQC介绍 (2)"></a>MQC介绍 (2)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/18.png"></p>
<p>•流策略：将流分类和流行为绑定，对分类后的报文执行对应流行为中定义的动作。</p>
<p>•一个流策略可以绑定多个流分类和流行为。</p>
<h2 id="MQC-流分类"><a href="#MQC-流分类" class="headerlink" title="MQC - 流分类"></a>MQC - 流分类</h2><p>流分类：定义一组流量匹配规则，以对报文进行分类。流分类支持的匹配项如下所示。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/19.png"></p>
<blockquote>
<p>•流分类中各规则之间的关系分为：and或or，缺省情况下的关系为or。</p>
<ul>
<li><p>and：当流分类中包含ACL规则时，报文必须匹配其中一条ACL规则以及所有非ACL规则；当流分类中没有ACL规则时，报文必须匹配所有非ACL规则。</p>
</li>
<li><p>or：报文只要匹配了流分类中的一个规则，设备就认为报文匹配中该流分类。</p>
</li>
</ul>
</blockquote>
<h2 id="MQC-流行为"><a href="#MQC-流行为" class="headerlink" title="MQC - 流行为"></a>MQC - 流行为</h2><p>流行为：用来定义执行的动作，支持报文过滤、重标记优先级、重定向、流量统计等动作。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/20.png"></p>
<h2 id="MQC-流策略"><a href="#MQC-流策略" class="headerlink" title="MQC - 流策略"></a>MQC - 流策略</h2><p>•流策略：流策略支持在接口上调用。</p>
<p>•流策略存在方向(inbound、outbound)的概念，策略中的流行为匹配入、出方向的报文，对匹配中的报文执行相应的流动作。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/21.png"></p>
<blockquote>
<p>•流策略不同于PBR，PBR只能调用在三层接口，而流策略支持调用在二层接口。</p>
</blockquote>
<h2 id="使用MQC实现策略路由"><a href="#使用MQC实现策略路由" class="headerlink" title="使用MQC实现策略路由"></a>使用MQC实现策略路由</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/22.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/23.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/24.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/25.png"></p>
<h1 id="3-流量过滤"><a href="#3-流量过滤" class="headerlink" title="3.流量过滤"></a>3.流量过滤</h1><h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>为提高网络安全性，管理人员需要控制进入网络的流量，将不信任的报文丢弃在网络边界。所谓的不信任报文是指对用户来说存在安全隐患或者不愿意接收的报文。同时保证数据访问安全性，企业网络中经常会要求一些部门之间不能相互访问。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/26.png"></p>
<h2 id="流量过滤工具"><a href="#流量过滤工具" class="headerlink" title="流量过滤工具"></a>流量过滤工具</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/27.png"></p>
<h2 id="Traffic-Filter部署位置"><a href="#Traffic-Filter部署位置" class="headerlink" title="Traffic-Filter部署位置"></a>Traffic-Filter部署位置</h2><p>使用Traffic-Filter过滤流量可以灵活地选择部署位置，在流量进入设备或者离开设备的接口上执行过滤动作，双向访问的业务禁止其中一个方向即可实现阻断业务的需求。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/28.png"></p>
<blockquote>
<p>•Traffic-Filter部署的位置不同，其调用的ACL内容也不相同。</p>
</blockquote>
<h2 id="使用Traffic-Filter过滤流量"><a href="#使用Traffic-Filter过滤流量" class="headerlink" title="使用Traffic-Filter过滤流量"></a>使用Traffic-Filter过滤流量</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/29.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/30.png"></p>
<h2 id="使用MQC过滤流量-1"><a href="#使用MQC过滤流量-1" class="headerlink" title="使用MQC过滤流量 (1)"></a>使用MQC过滤流量 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/31.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/32.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/33.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）本地策略路由与接口策略路由的区别在于？</p>
<p><strong>本地策略路由对本地始发的流量生效，而接口策略路由只会对接口入方向的流量生效。</strong></p>
<p>2.（简答题）使用MQC方式过滤流量时，流分类中匹配的ACL与Traffic-Filter调用的ACL有何区别？</p>
<p><strong>MQC调用的ACL里permit、deny只代表是否匹配流量，不代表是否放通、拒绝流量，而Traffic-Filter调用的ACL里permit、deny代表放通、拒绝流量。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本课程介绍了PBR的应用场景、PBR的分类以及如何配置本地策略路由、接口策略路由。</p>
<p>•MQC支持多种灵活的流量匹配方式以及执行动作，同时还可以在多种视图下调用，使用MQC可以完成策略路由、流量过滤的功能。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/" itemprop="url">IP-路由策略与路由控制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-16T20:08:48+08:00">
                2021-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•在复杂的数据通信网络中，根据实际组网需求，往往需要实施一些路由策略对路由信息进行过滤、属性设置等操作，通过对路由的控制，可以影响数据流量转发。</p>
<p>•路由策略并非单一的技术或者协议，而是一个技术专题或方法论，里面包含了多种工具及方法。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫使用ACL匹配感兴趣路由</p>
<p>▫使用IP-Prefix匹配感兴趣路由</p>
<p>▫使用Filter-Policy进行路由过滤</p>
<p>▫使用Route-Policy进行路由过滤及路由属性修改</p>
<h1 id="1-路由控制概述"><a href="#1-路由控制概述" class="headerlink" title="1.路由控制概述"></a>1.<strong>路由控制概述</strong></h1><h2 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/1.png"></p>
<p>•R1上将业务A、B、C的网段路由引入时希望不引入业务C网段路由，同时R3上将OSPF路由引入到IS-IS中时，同样只希望引入B业务网段路由。</p>
<p>•此时需要一个工具在引入路由时进行限制。</p>
<h2 id="路由控制概述"><a href="#路由控制概述" class="headerlink" title="路由控制概述"></a>路由控制概述</h2><p>路由控制可以通过路由策略（Route-Policy）实现，路由策略应用灵活而广泛，有以下几种常见方式：</p>
<p>▫控制路由的发布：通过路由策略对发布的路由进行过滤，只发布满足条件的路由。</p>
<p>▫控制路由的接收：通过路由策略对接收的路由进行过滤，只接收满足条件的路由。</p>
<p>▫控制路由的引入：通过路由策略控制从其他路由协议引入的路由条目，只有满足条件的路由才会被引入。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/2.png"></p>
<h1 id="2-路由控制工具"><a href="#2-路由控制工具" class="headerlink" title="2.路由控制工具"></a>2.路由控制工具</h1><h2 id="路由匹配工具"><a href="#路由匹配工具" class="headerlink" title="路由匹配工具"></a>路由匹配工具</h2><h3 id="匹配工具1：访问控制列表"><a href="#匹配工具1：访问控制列表" class="headerlink" title="匹配工具1：访问控制列表"></a>匹配工具1：访问控制列表</h3><p>•访问控制列表（Access Control List，ACL）是一个匹配工具，能够对报文及路由进行匹配和区分。</p>
<p>•ACL由若干条permit或deny语句组成。每条语句就是该ACL的一条规则，每条语句中的permit或deny就是与这条规则相对应的处理动作。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/3.png"></p>
<blockquote>
<p>ACL的组成：</p>
<p>▫ACL编号：在网络设备上配置ACL时，每个ACL都需要分配一个编号，称为ACL编号，用来标识ACL。不同分类的ACL编号范围不同，这个后面具体讲。</p>
<p>▫规则：前面提到了，一个ACL通常由若干条“permit/deny”语句组成，每条语句就是该ACL的一条规则。</p>
<p>▫规则编号：每条规则都有一个相应的编号，称为规则编号，用来标识ACL规则。可以自定义，也可以系统自动分配。ACL规则的编号范围是0～4294967294，所有规则均按照规则编号从小到大进行排序。</p>
<p>▫动作：每条规则中的permit或deny，就是与这条规则相对应的处理动作。permit指“允许”，deny指“拒绝”，但是ACL一般是结合其他技术使用，不同的场景，处理动作的含义也有所不同。</p>
<ul>
<li>比如：ACL如果与流量过滤技术结合使用（即流量过滤中调用ACL），permit就是“允许通行”的意思，deny就是“拒绝通行”的意思。</li>
</ul>
<p>▫匹配项：ACL定义了极其丰富的匹配项。例子中体现的源地址，ACL还支持很多其他规则匹配项。例如，二层以太网帧头信息（如源MAC、目的MAC、以太帧协议类型）、三层报文信息（如目的地址、协议类型）以及四层报文信息（如TCP/UDP端口号）等。</p>
</blockquote>
<h4 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/4.png"></p>
<p>匹配规则：</p>
<ul>
<li>“0”表示“匹配”；“1”表示“无需匹配”</li>
</ul>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/5.png"></p>
<blockquote>
<p>•当进行IP地址匹配的时候，后面会跟着32位掩码位，这32位称为通配符。</p>
<p>•通配符，也是点分十进制格式，换算成二进制后，“0”表示“匹配”，“1”表示“不匹配”。通配符中的1或者0可以不连续。</p>
<p>•具体看下这2条规则：</p>
<ul>
<li><p>rule 5: 拒绝源IP地址为10.1.1.1报文通过——因为通配符为全0，所以每一位都要严格匹配，因此匹配的是主机IP地址10.1.1.1；</p>
</li>
<li><p>rule 15:允许源IP地址为10.1.1.0/24网段地址的报文通过——因为通配符：0.0.0.11111111，后8位为1，表示不关心，因此10.1.1.xxxxxxxx 的后8位可以为任意值，所以匹配的是10.1.1.0/24网段。</p>
</li>
</ul>
<p>•例子：如果要精确匹配192.168.1.1/24这个IP地址对应的网段地址，通配符是多少？</p>
<ul>
<li>可以得出：网络位需要严格匹配，主机位无所谓，因此通配符为“0.0.0.255”。</li>
</ul>
<p>•两个特殊的通配符：</p>
<ul>
<li><p>当通配符全为0来匹配IP地址时，表示精确匹配某个IP地址；</p>
</li>
<li><p>当通配符全为1来匹配0.0.0.0地址时，表示匹配了所有IP地址。</p>
</li>
</ul>
</blockquote>
<h4 id="ACL的分类与基本ACL"><a href="#ACL的分类与基本ACL" class="headerlink" title="ACL的分类与基本ACL"></a>ACL的分类与基本ACL</h4><p>•基于ACL规则定义方式的划分</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/6.png"></p>
<p>•基本ACL</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/7.png"></p>
<blockquote>
<p>•对于使用ACL进行路由匹配的场景，用户只能使用基本ACL。</p>
</blockquote>
<h4 id="ACL的匹配机制"><a href="#ACL的匹配机制" class="headerlink" title="ACL的匹配机制"></a>ACL的匹配机制</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/8.png"></p>
<blockquote>
<p>•ACL的匹配机制概括来说就是：</p>
<ul>
<li><p>配置ACL的设备接收报文后，会将该报文与ACL中的规则逐条进行匹配，如果不能匹配上，就会继续尝试去匹配下一条规则。</p>
</li>
<li><p>一旦匹配上，则设备会对该报文执行这条规则中定义的处理动作，并且不再继续尝试与后续规则匹配。</p>
</li>
</ul>
<p>•匹配流程：首先系统会查找设备上是否配置了ACL。</p>
<ul>
<li><p>如果ACL不存在，则返回ACL匹配结果为：不匹配。</p>
</li>
<li><p>如果ACL存在，则查找设备是否配置了ACL规则。</p>
<ul>
<li>如果规则不存在，则返回ACL匹配结果为：不匹配。</li>
<li>如果规则存在，则系统会从ACL中编号最小的规则开始查找。<ul>
<li>如果匹配上了permit规则，则停止查找规则，并返回ACL匹配结果为：匹配（允许）。</li>
<li>如果匹配上了deny规则，则停止查找规则，并返回ACL匹配结果为：匹配（拒绝）。</li>
<li>如果未匹配上规则，则继续查找下一条规则，以此循环。如果一直查到最后一条规则，报文仍未匹配上，则返回ACL匹配结果为：不匹配。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>•从整个ACL匹配流程可以看出，报文与ACL规则匹配后，会产生两种匹配结果：“匹配”和“不匹配”。</p>
<ul>
<li><p>匹配（命中规则）：指存在ACL，且在ACL中查找到了符合匹配条件的规则。不论匹配的动作是“permit”还是“deny”，都称为“匹配”，而不是只是匹配上permit规则才算“匹配”。</p>
</li>
<li><p>不匹配（未命中规则）：指不存在ACL，或ACL中无规则，再或者在ACL中遍历了所有规则都没有找到符合匹配条件的规则。以上三种情况，都叫做“不匹配”。</p>
</li>
</ul>
<p>•匹配原则：一旦命中即停止匹配。</p>
</blockquote>
<h4 id="ACL的匹配顺序及匹配结果"><a href="#ACL的匹配顺序及匹配结果" class="headerlink" title="ACL的匹配顺序及匹配结果"></a>ACL的匹配顺序及匹配结果</h4><p>配置顺序（config模式）</p>
<p>▫系统按照ACL规则编号从小到大的顺序进行报文匹配，规则编号越小越容易被匹配。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/9.png"></p>
<blockquote>
<p>•一条ACL可以由多条“deny或permit”语句组成，每一条语句描述一条规则，这些规则可能存在包含关系，也可能有重复或矛盾的地方，因此ACL的匹配顺序是十分重要的。</p>
<p>•华为设备支持两种匹配顺序：自动排序（auto模式）和配置顺序（config模式）。缺省的ACL匹配顺序是config模式。</p>
<ul>
<li><p>自动排序，是指系统使用“深度优先”的原则，将规则按照精确度从高到低进行排序，并按照精确度从高到低的顺序进行报文匹配。——这个比较复杂，这里就不具体展开了，</p>
</li>
<li><p>配置顺序，系统按照ACL规则编号从小到大的顺序进行报文匹配，规则编号越小越容易被匹配。——这个就是前面提到的匹配顺序。</p>
<ul>
<li>如果后面又添加了一条规则，则这条规则会被加入到相应的位置，报文仍然会按照从小到大的顺序进行匹配。</li>
</ul>
</li>
</ul>
<p>•注意：ACL技术总是与其他技术结合在一起使用的，因此，所结合的技术不同，“允许 (permit)”及“拒绝 (deny)”的实际作用也会不同。例如，当ACL技术与路由过滤技术结合使用时，permit就是“匹配该条路由条目”的意思，deny就是“不匹配该条路由条目”的意思。</p>
</blockquote>
<h4 id="常用匹配举例"><a href="#常用匹配举例" class="headerlink" title="常用匹配举例"></a>常用匹配举例</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/10.png"></p>
<h4 id="基本ACL的基础配置命令"><a href="#基本ACL的基础配置命令" class="headerlink" title="基本ACL的基础配置命令"></a>基本ACL的基础配置命令</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/11.png"></p>
<blockquote>
<p>•创建基本ACL</p>
<p>•[Huawei] <strong>acl</strong> [ <strong>number</strong> ] <em>acl-number</em> [ <strong>match-order</strong> <strong>config</strong> ]</p>
<ul>
<li><p><em>acl-number</em>：指定访问控制列表的编号。</p>
</li>
<li><p><strong>match-order</strong> <strong>config</strong>：指定ACL规则的匹配顺序，config表示配置顺序。</p>
</li>
</ul>
<p>•[Huawei] <strong>acl</strong> <strong>name</strong> <em>acl-name</em> { <strong>basic</strong> | <em>acl-number</em> } [ <strong>match-order</strong> <strong>config</strong> ]</p>
<ul>
<li><p><em>acl-name</em>：指定创建的ACL的名称。</p>
</li>
<li><p><strong>basic</strong>：指定ACL的类型为基本ACL。</p>
</li>
</ul>
<p>•配置基本ACL规则</p>
<p>•[Huawei-acl-basic-2000] <strong>rule</strong> [ <em>rule-id</em> ] { <strong>deny</strong> | <strong>permit</strong> } [ <strong>source</strong> { <em>source-address source-wildcard</em> | <strong>any</strong> } | <strong>time-range</strong> <em>time-name</em> ] </p>
<ul>
<li><p><em>rule-id</em>：指定ACL的规则ID。</p>
</li>
<li><p><strong>deny</strong>：指定拒绝符合条件的报文。</p>
</li>
<li><p><strong>permit</strong>：指定允许符合条件的报文。</p>
</li>
<li><p><strong>source</strong> { <em>source-address source-wildcard</em> | <strong>any</strong> }：指定ACL规则匹配报文的源地址信息。如果不配置，表示报文的任何源地址都匹配。其中：</p>
<ul>
<li><em>source-address</em>：指定报文的源地址。</li>
<li><em>source-wildcard</em>：指定源地址通配符。</li>
<li><strong>any</strong>：表示报文的任意源地址。相当于source-address为0.0.0.0或者source-wildcard为255.255.255.255。</li>
</ul>
</li>
<li><p><strong>time-range</strong> <em>time-name</em>：指定ACL规则生效的时间段。其中，time-name表示ACL规则生效时间段名称。如果不指定时间段，表示任何时间都生效。</p>
</li>
</ul>
</blockquote>
<h3 id="匹配工具2：IP前缀列表"><a href="#匹配工具2：IP前缀列表" class="headerlink" title="匹配工具2：IP前缀列表"></a>匹配工具2：IP前缀列表</h3><p>•IP前缀列表（IP-Prefix List）是将路由条目的网络地址、掩码长度作为匹配条件的过滤器，可在各路由协议发布和接收路由时使用。</p>
<p>•不同于ACL，IP-Prefix List能够同时匹配IP地址前缀长度以及掩码长度，增强了匹配的精确度。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/12.png"></p>
<p>1、<strong>ip-prefix-name</strong>：地址前缀列表名称<br>2、<strong>序号</strong>：本匹配项在地址前缀列表中的序号，匹配时根据序号从小到大进行顺序匹配<br>3、<strong>动作</strong>：permit/deny，地址前缀列表的匹配模式为允许/拒绝，表示匹配/不匹配<br>4、<strong>IP网段与掩码</strong>：匹配路由的网络地址，以及限定网络地址的前多少位需严格匹配<br>5、<strong>掩码范围</strong>：匹配路由前缀长度，掩码长度的匹配范围 mask-length&lt;=greater-equal-value&lt;=less-equal-value&lt;=32</p>
<h4 id="IP-Prefix的匹配机制"><a href="#IP-Prefix的匹配机制" class="headerlink" title="IP-Prefix的匹配机制"></a>IP-Prefix的匹配机制</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/13.png"></p>
<h4 id="IP-Prefix的匹配示例"><a href="#IP-Prefix的匹配示例" class="headerlink" title="IP-Prefix的匹配示例"></a>IP-Prefix的匹配示例</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/14.png"></p>
<h4 id="IP-Prefix的基础配置命令"><a href="#IP-Prefix的基础配置命令" class="headerlink" title="IP-Prefix的基础配置命令"></a>IP-Prefix的基础配置命令</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/15.png"></p>
<blockquote>
<p>•<strong>ip-prefix-name</strong>：指定地址前缀列表的名称。字符串形式，长度范围是1～169，不支持空格，区分大小写。</p>
<p>•<strong>index</strong> <em>index-number</em>：指定本匹配项在地址前缀列表中的序号。整数形式，取值范围是1～4294967295。缺省情况下，该序号值按照配置先后顺序依次递增，每次加10，第一个序号值为10。</p>
<p>•<strong>permit</strong>：指定地址前缀列表的匹配模式为允许。在该模式下，如果过滤的IP地址在定义的范围内，则通过过滤，进行相应的设置；否则，必须进行下一节点的测试。</p>
<p>•<strong>deny</strong>：指定地址前缀列表的匹配模式为拒绝。在该模式下，如果过滤的IP地址在定义的范围内，该IP地址不能通过过滤从而不能进入下一节点的测试；否则，将进行下一节点的测试。</p>
<p>•<em>ipv4-address mask-length</em>：指定IP地址和指定掩码长度。其中掩码长度为整数形式，取值范围是0～32。</p>
<p>•<strong>greater-equal</strong> <em>greater-equal-value</em>：指定掩码长度匹配范围的下限。若不配置<strong>greater-equal</strong> <em>greater-equal-value</em>和<strong>less-equal</strong> <em>less-equal-value</em>，则使用mask-length作为掩码长度。 </p>
<ul>
<li><p>参数<em>greater-equal-value</em>的取值限制为：<em>mask-length</em>&lt;=<em>greater-equal-value</em>&lt;=<em>less-equal-value</em>&lt;=32。</p>
</li>
<li><p>如果只配置了<strong>greater-equal</strong>，则掩码长度范围在<em>greater-equal-value</em>和32之间。</p>
</li>
</ul>
<p>•<strong>less-equal</strong> <em>less-equal-value</em>：指定掩码长度匹配范围的上限。若不配置<strong>greater-equal</strong> <em>greater-equal-value</em>和<strong>less-equal</strong> <em>less-equal-value</em>，则使用<em>mask-length</em>作为掩码长度。</p>
<ul>
<li><p>参数less-equal-value的取值限制为：<em>mask-length</em>&lt;=<em>greater-equal-value</em>&lt;=<em>less-equal-value</em>&lt;=32<em>。</em></p>
</li>
<li><p>如果只配置了<strong>less-equal</strong>，则掩码长度范围在<em>mask-length</em>和<em>less-equal-value</em>之间。</p>
</li>
</ul>
</blockquote>
<h4 id="IP-Prefix的配置举例-1"><a href="#IP-Prefix的配置举例-1" class="headerlink" title="IP-Prefix的配置举例 (1)"></a>IP-Prefix的配置举例 (1)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/16.png"></p>
<blockquote>
<p>•Case1说明：这种情况属于单节点的精确匹配，只有目的地址，掩码完全相同的路由才会匹配成功，而且节点的匹配模式为Permit，所以路由10.1.1.0/24被Permit，属于匹配成功并被Permit，其他路由由于未匹配成功被Deny。</p>
<p>•Case2说明：这种情况属于单节点的精确匹配，但节点的匹配模式为deny，所以路由10.1.1.0/24还是被Deny，属于匹配成功但被Deny，其他路由则属于未匹配成功被默认Deny。</p>
</blockquote>
<h4 id="IP-Prefix的配置举例-2"><a href="#IP-Prefix的配置举例-2" class="headerlink" title="IP-Prefix的配置举例 (2)"></a>IP-Prefix的配置举例 (2)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/17.png"></p>
<blockquote>
<p>•Case1说明：这种情况属于多节点的精确匹配。</p>
<ul>
<li><p>路由10.1.1.0/24在匹配index 10时，满足匹配条件，但匹配模式是deny，属于匹配成功但被Deny。</p>
</li>
<li><p>路由10.1.1.1/32在匹配index 10时，不满足匹配条件，则继续匹配index 20，此时匹配成功，且index 20的匹配模式是permit，属于匹配成功并被Permit。</p>
</li>
<li><p>其他路由由于都不符合index 10和20的条件，属于未匹配成功被默认Deny。</p>
</li>
</ul>
<p>•Case2说明：此时<em>greater-equal-value</em>=26，<em>less-equal-value</em>=32。配置时，需满足<em>mask-length</em>&lt;=<em>greater-equal-value</em>&lt;=<em>less-equal-value</em>，否则配置不成功。</p>
</blockquote>
<h4 id="IP-Prefix的配置举例-3"><a href="#IP-Prefix的配置举例-3" class="headerlink" title="IP-Prefix的配置举例 (3)"></a>IP-Prefix的配置举例 (3)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/18.png"></p>
<blockquote>
<p>•Case1说明：此时<em>greater-equal-value</em>=8，<em>less-equal-value</em>=32，前8个bit与10.0.0.0相同，掩码长度在8-32之间的路由全部被匹配。</p>
<p>•Case2说明：</p>
<ul>
<li><p>对于index 10，<em>greater-equal-value</em>=24，<em>less-equal-value</em>=32，前24个bit与10.1.1.0相同，所有掩码长度在24到32的路由全部被Deny；</p>
</li>
<li><p>对于index 20，<em>greater-equal-value</em>=0，<em>less-equal-value</em>=32，前16个bit与10.1.0.0相同，掩码长度在16到32的路由被匹配，此时只有10.1.0.0/16被匹配，剩下的被默认deny。</p>
</li>
</ul>
</blockquote>
<h2 id="路由策略工具"><a href="#路由策略工具" class="headerlink" title="路由策略工具"></a>路由策略工具</h2><h3 id="策略工具1：Filter-Policy"><a href="#策略工具1：Filter-Policy" class="headerlink" title="策略工具1：Filter-Policy"></a>策略工具1：Filter-Policy</h3><p>•Filter-Policy（过滤-策略）是一个很常用的路由信息过滤工具，能够对接收、发布、引入的路由进行过滤，可应用于IS-IS、OSPF、BGP等协议。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/19.png"></p>
<p>•如图所示，R1、R2、R3之间运行BGP路由协议，路由在各个设备之间传递，当需要根据实际需求过滤某些路由信息的时候可以使用Filter-Policy实现。</p>
<h4 id="Filter-Policy在距离矢量路由协议中的应用"><a href="#Filter-Policy在距离矢量路由协议中的应用" class="headerlink" title="Filter-Policy在距离矢量路由协议中的应用"></a>Filter-Policy在距离矢量路由协议中的应用</h4><p>在距离矢量路由协议中，设备之间传递的是路由信息，如果需要对这种路由信息进行某种过滤，可以使用Filter-Policy实现，出方向和入方向的生效位置如图所示。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/20.png"></p>
<blockquote>
<p>•距离矢量协议是基于路由表生成路由的，因此过滤器会影响从邻居接收的路由和向邻居发布的路由。</p>
<p>•如果要过滤掉上游设备到下游设备的路由，只需要在上游设备配置filter-policy export或者在下游设备上配置filter-policy import。</p>
</blockquote>
<h4 id="Filter-Policy在链路状态路由协议中的应用"><a href="#Filter-Policy在链路状态路由协议中的应用" class="headerlink" title="Filter-Policy在链路状态路由协议中的应用"></a>Filter-Policy在链路状态路由协议中的应用</h4><p>在链路状态路由协议中，各路由设备之间传递的是LSA信息，然后设备根据LSA汇总成的LSDB信息计算出路由表。但是Filter-Policy只能过滤路由信息，无法过滤LSA。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/21.png"></p>
<blockquote>
<p>•OSPF把网络中所泛洪的LSA存储到自己的LSDB中，并且运行SPF算法，计算出一颗以自己为根，无环的最短路径树，Filter-Policy对OSPF计算出来的路由（加载到路由表之前）进行过滤，而不会对LSA进行过滤。</p>
<p>•上面的实例以OSPF为例，展示了Filter-Policy在链路状态中的应用。</p>
</blockquote>
<h4 id="Filter-Policy的基础配置命令-1"><a href="#Filter-Policy的基础配置命令-1" class="headerlink" title="Filter-Policy的基础配置命令 (1)"></a>Filter-Policy的基础配置命令 (1)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/22.png"></p>
<blockquote>
<p>命令：[Huawei-ospf-100] <strong>filter-policy</strong> { acl-number | <strong>acl-name</strong> acl-name | <strong>ip-prefix</strong> ip-prefix-name | <strong>route-policy</strong> route-policy-name [ <strong>secondary</strong> ] } <strong>import</strong></p>
<ul>
<li>acl-number：指定基本访问控制列表号。整数形式，取值范围是2000～2999。</li>
<li><strong>acl-name</strong> acl-name：指定访问控制列表名称。字符串形式，不支持空格，区分大小写，长度范围是1～32，以英文字母a～z或A～Z开始。</li>
<li><strong>ip-prefix</strong> ip-prefix-name：指定地址前缀列表名称。字符串形式，长度范围是1～169，不支持空格，区分大小写。当输入的字符串两端使用双引号时，可在字符串中输入空格。</li>
<li><strong>route-policy</strong> route-policy-name：指定路由策略名称。字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</li>
<li><strong>secondary</strong>：设置优选次优路由。</li>
</ul>
<p>命令：[Huawei-ospf-100] <strong>filter-policy</strong> { acl-number | <strong>acl-name</strong> acl-name | <strong>ip-prefix</strong> ip-prefix-name | <em>9</em>route-policy** route-policy-name } <strong>export</strong> [ protocol [ process-id ] ]</p>
<ul>
<li>protocol process-id：指定需要对引入的特定的路由协议进行过滤。目前的协议包括direct、isis、bgp、ospf、unr和static。当指定路由协议为RIP、IS-IS、OSPF时，还可以指定进程号。整数类型，取值范围是1～65535，缺省值是1。</li>
</ul>
</blockquote>
<h4 id="Filter-Policy的基础配置命令-2"><a href="#Filter-Policy的基础配置命令-2" class="headerlink" title="Filter-Policy的基础配置命令 (2)"></a>Filter-Policy的基础配置命令 (2)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/23.png"></p>
<h4 id="Filter-Policy的基础配置命令-3"><a href="#Filter-Policy的基础配置命令-3" class="headerlink" title="Filter-Policy的基础配置命令 (3)"></a>Filter-Policy的基础配置命令 (3)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/24.png"></p>
<h4 id="OSPF中使用Filter-Policy"><a href="#OSPF中使用Filter-Policy" class="headerlink" title="OSPF中使用Filter-Policy"></a>OSPF中使用Filter-Policy</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/25.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/26.png"></p>
<blockquote>
<p>•OSPF的路由信息记录在LSDB中，<strong>filter-policy import</strong>命令实际上是对OSPF计算出来的路由进行过滤，不是对发布和接收的LSA进行过滤。</p>
<p>•<strong>filter-policy export</strong>命令通过指定<em>protocol</em>或<em>process-id</em>对特定的某一种协议或某一进程的路由进行过滤。如果没有指定<em>protocol</em>和<em>process-id</em>，则OSPF将对所有引入的路由信息进行过滤。</p>
</blockquote>
<h4 id="IS-IS中使用Filter-Policy"><a href="#IS-IS中使用Filter-Policy" class="headerlink" title="IS-IS中使用Filter-Policy"></a>IS-IS中使用Filter-Policy</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/27.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/28.png"></p>
<blockquote>
<p>•IS-IS的路由表项需要被成功下发到IP路由表中，才能用来指导IP报文转发。如果IS-IS路由表中有到达某个目的网段的路由，但是并不希望将该路由下发到IP路由表中，可以使用<strong>filter-policy import</strong>命令结合基本ACL、IP-Prefix、路由策略等方式，只将部分IS-IS路由下发到IP路由表中。</p>
</blockquote>
<h4 id="BGP中使用Filter-Policy"><a href="#BGP中使用Filter-Policy" class="headerlink" title="BGP中使用Filter-Policy"></a>BGP中使用Filter-Policy</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/29.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/30.png"></p>
<h3 id="策略工具2：Route-Policy"><a href="#策略工具2：Route-Policy" class="headerlink" title="策略工具2：Route-Policy"></a>策略工具2：Route-Policy</h3><p>•Route-Policy是一个策略工具，用于过滤路由信息，以及为过滤后的路由信息设置路由属性。</p>
<p>•一个Route-Policy由一个或多个节点（Node）构成，每个节点都可以是一系列条件语句（匹配条件）以及执行语句（执行动作）的集合，这些集合按照编号从小到大的顺序排列。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/31.png"></p>
<p>•每个节点内可包含多个条件语句。节点内的多个条件语句之间的关系为“与”，即匹配所有条件语句才会执行本节点内的动作。</p>
<p>•节点之间的关系为“或”，route-policy根据节点编号大小从小到大顺序执行，匹配中一个节点将不会继续向下匹配。</p>
<blockquote>
<p>•当使用Route-Policy时，Node的值小的节点先进行匹配。一个节点匹配成功后，路由将不再匹配其他节点。全部节点匹配失败后，路由将被过滤。</p>
</blockquote>
<h4 id="Route-Policy的组成"><a href="#Route-Policy的组成" class="headerlink" title="Route-Policy的组成"></a>Route-Policy的组成</h4><p>一个Route-Policy由一个或多个节点构成，每个节点包括多个if-match和apply子句。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/32.png"></p>
<p>•permit或deny：指定Route-Policy节点的匹配模式为允许或拒绝。</p>
<p>•node：指定Route-Policy的节点号。整数形式，取值范围是0～65535。</p>
<p>•if-match子句：定义该节点的匹配条件。</p>
<p>•apply子句：定义针对被匹配路由执行的操作。</p>
<h4 id="Route-Policy的匹配顺序"><a href="#Route-Policy的匹配顺序" class="headerlink" title="Route-Policy的匹配顺序"></a>Route-Policy的匹配顺序</h4><p>路由策略使用不同的匹配条件和匹配模式选择路由和改变路由属性。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/33.png"></p>
<blockquote>
<p>•一个路由策略中包含N（N&gt;=1）个节点（Node）。路由进入路由策略后，按节点序号从小到大依次检查各个节点是否匹配。匹配条件由If-match子句定义。</p>
<ul>
<li><p>当路由与该节点的所有If-match子句都匹配成功后，进入匹配模式选择，不再匹配其他节点。匹配模式分permit和deny两种：</p>
<ul>
<li><p>permit：路由将被允许通过，并且执行该节点的apply子句对路由信息的一些属性进行设置。</p>
</li>
<li><p>deny：路由将被拒绝通过。</p>
</li>
</ul>
</li>
<li><p>当路由与该节点的任意一个If-match子句匹配失败后，进入下一节点。如果和所有节点都匹配失败，路由信息将被拒绝通过。</p>
</li>
</ul>
</blockquote>
<h4 id="Route-Policy的基础配置命令-1"><a href="#Route-Policy的基础配置命令-1" class="headerlink" title="Route-Policy的基础配置命令 (1)"></a>Route-Policy的基础配置命令 (1)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/34.png"></p>
<blockquote>
<p>•命令：<strong>route-policy</strong> <em>route-policy-name</em> { <strong>permit</strong> | <strong>deny</strong> } <strong>node</strong> <em>node</em></p>
<ul>
<li><p><strong>permit</strong>：指定Route-Policy节点的匹配模式为允许。如果路由与节点所有的if-match子句匹配成功，则执行此节点apply子句；否则，进行下一节点。</p>
</li>
<li><p><strong>deny</strong>：指定Route-Policy节点的匹配模式为拒绝。如果路由与节点所有的if-match子句匹配成功，则该路由将被拒绝通过；否则进行下一节点。</p>
</li>
<li><p><strong>node</strong> <em>node</em>：指定Route-Policy的节点号。当使用Route-Policy时，node的值小的节点先进行匹配。一个节点匹配成功后，路由将不再匹配其他节点。全部节点匹配失败后，路由将被过滤。整数形式，取值范围是0～65535。</p>
</li>
</ul>
</blockquote>
<h4 id="Route-Policy的基础配置命令-2"><a href="#Route-Policy的基础配置命令-2" class="headerlink" title="Route-Policy的基础配置命令 (2)"></a>Route-Policy的基础配置命令 (2)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/35.png"></p>
<blockquote>
<p>•apply子句用来为路由策略指定动作，用来设置匹配成功的路由的属性。在一个节点中，如果没有配置apply子句，则该节点仅起过滤路由的作用。如果配置一个或多个apply子句，则通过节点匹配的路由将执行所有apply子句。</p>
</blockquote>
<h1 id="3-路由控制案例"><a href="#3-路由控制案例" class="headerlink" title="3.路由控制案例"></a>3.路由控制案例</h1><h2 id="对接收的路由进行过滤"><a href="#对接收的路由进行过滤" class="headerlink" title="对接收的路由进行过滤"></a>对接收的路由进行过滤</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/36.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/37.png"></p>
<blockquote>
<p>•通过Filter-Policy进行路由过滤，只影响本地的路由表，因此R3可以正常学习到192.168.1.0/24网段的路由。</p>
</blockquote>
<h2 id="对发布的路由进行过滤"><a href="#对发布的路由进行过滤" class="headerlink" title="对发布的路由进行过滤"></a>对发布的路由进行过滤</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/38.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/39.png"></p>
<h2 id="修改路由属性"><a href="#修改路由属性" class="headerlink" title="修改路由属性"></a>修改路由属性</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/40.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/41.png"></p>
<h2 id="双点双向路由重发布"><a href="#双点双向路由重发布" class="headerlink" title="双点双向路由重发布"></a>双点双向路由重发布</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/42.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/myblog\zsyblog\source_posts\IP-路由策略与路由控制\43.png"></p>
<h2 id="次优路径问题"><a href="#次优路径问题" class="headerlink" title="次优路径问题"></a>次优路径问题</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/44.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/45.png"></p>
<h2 id="解决次优路径问题-1"><a href="#解决次优路径问题-1" class="headerlink" title="解决次优路径问题 (1)"></a>解决次优路径问题 (1)</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/46.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/47.png"></p>
<h2 id="解决次优路径问题-2"><a href="#解决次优路径问题-2" class="headerlink" title="解决次优路径问题 (2)"></a>解决次优路径问题 (2)</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/48.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/49.png"></p>
<h2 id="路由环路问题"><a href="#路由环路问题" class="headerlink" title="路由环路问题"></a>路由环路问题</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/50.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/51.png"></p>
<h3 id="解决路由环路问题-1"><a href="#解决路由环路问题-1" class="headerlink" title="解决路由环路问题 (1)"></a>解决路由环路问题 (1)</h3><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/52.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/53.png"></p>
<h3 id="解决路由环路问题-2"><a href="#解决路由环路问题-2" class="headerlink" title="解决路由环路问题 (2)"></a>解决路由环路问题 (2)</h3><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/54.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/55.png"></p>
<h3 id="解决路由环路问题-3"><a href="#解决路由环路问题-3" class="headerlink" title="解决路由环路问题 (3)"></a>解决路由环路问题 (3)</h3><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/56.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/57.png"></p>
<h2 id="场景思考"><a href="#场景思考" class="headerlink" title="场景思考"></a>场景思考</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/58.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）Filter-Policy export在OSPF、BGP中的作用分别是？</p>
<p><strong>在OSPF中的作用为过滤从其他路由协议引入到OSPF中的路由条目；在BGP中的作用为限制本地对外发布的路由条目。</strong></p>
<p>2.（简答题）Route-Policy多个节点之间的逻辑关系为？一个节点内多个条件语句的逻辑关系为？</p>
<p><strong>节点之间的逻辑关系为或，条件语句间的逻辑关系为与。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•控制路由的发布、接收时需要先将相应的路由使用匹配器进行抓取，最常见的匹配器有ACL、 IP-Prefix List 。</p>
<p>•Filter-Policy、Route-Policy都可用来在发布、接收路由时进行过滤，但需要注意在链路状态路由协议中使用Filter-Policy并不能正常的过滤链路状态信息，只是影响了本地的路由表。</p>
<p>•Route-Policy在发布、接收路由时可以对路由的属性进行灵活地修改，以实现XXX。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/" itemprop="url">BGP-EVPN基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-10T21:21:55+08:00">
                2021-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•标准BGP-4仅支持IPv4单播地址，为了支持更多的网络层协议，MP-BGP（Multiprotocol Extensions for BGP-4）（RFC4760）被提出作为BGP-4的扩展允许不同类型的地址族在BGP中同时分发，例如IPv4组播、IPv6、L3VPN、EVPN等。</p>
<p>•随着SDN的发展和商用，EVPN（Ethernet VPN）在各解决方案中占据重要角色，应用覆盖全场景包括园区网络、数据中心网络、广域IP承载网络和SD-WAN。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述MP-BGP的基本概念</p>
<p>▫描述EVPN的起源</p>
<p>▫描述EVPN的常见路由类型</p>
<p>▫描述EVPN的典型应用场景</p>
<h1 id="MP-BGP"><a href="#MP-BGP" class="headerlink" title="MP-BGP"></a>MP-BGP</h1><h2 id="MP-BGP-1"><a href="#MP-BGP-1" class="headerlink" title="MP-BGP"></a>MP-BGP</h2><p>MP-BGP（Multiprotocol Extensions for BGP-4）在RFC4760中被定义，用于实现BGP-4的扩展以允许BGP携带多种网络层协议（例如IPv6、L3VPN、EVPN等）。这种扩展有很好的后向兼容性，即一个支持MP-BGP的路由器可以和一个仅支持BGP-4的路由器交互。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/1.png"></p>
<blockquote>
<p>•<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/rfc4760/">https://datatracker.ietf.org/doc/rfc4760/</a></p>
</blockquote>
<h2 id="BGP-4扩展"><a href="#BGP-4扩展" class="headerlink" title="BGP-4扩展"></a>BGP-4扩展</h2><p>•BGP-4中IPv4特有的三个信息是NEXT_HOP属性、AGGREGATOR和IPv4 NLRI。因此为了支持多种网络层协议，BGP-4需要增加两种能力：</p>
<p>​    ▫关联其他网络层协议下一跳信息的能力。</p>
<p>​    ▫关联其他网络层协议NLRI的能力。</p>
<p>•这种两种能力被互联网数字分配机构（IANA）统称为地址族（Address Family，AF）。</p>
<p>•为了实现后向兼容性，协议规定MP-BGP增加两种新的属性，MP_REACH_NLRI和MP_UNREACH_NLRI，分别用于表示可达的目的信息和不可达的目的信息。这两种属性都属于可选非过渡（optional and non-transitive）。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/2.png"></p>
<blockquote>
<p>•BGP-4规定IPv4的NEXT_HOP和AGGREGATOR属于Path attributes字段，IPv4的NLRI中携带IPv4的路由条目。</p>
<p>•MP-BGP新增Path attributes的字段，将对应的网络层协议的NEXT_HOP字段和NLRI归属于MP_REACH_NLRI。MP_REACH_NLRI为Path attributes的新增字段。</p>
</blockquote>
<h2 id="MP-REACH-NLRI"><a href="#MP-REACH-NLRI" class="headerlink" title="MP_REACH_NLRI"></a>MP_REACH_NLRI</h2><p>•MP_REACH_NLRI被携带于BGP Update报文中，有以下作用：</p>
<p>​    ▫通告可达的路由给BGP邻居</p>
<p>​    ▫通告可达路的路由的下一跳给BGP邻居</p>
<p>•其详细字段如下：</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/3.png"></p>
<blockquote>
<p>•SAFI字段中1表示单播，2表示组播。值由IANA分配，其分配原则被定义于RFC2434（Guidelines for Writing an IANA Considerations Section in RFCs）。</p>
<p>•本章节后续学习EVPN的AFI为25 (L2VPN) ，SAFI为70 (EVPN)。</p>
</blockquote>
<h2 id="MP-UNREACH-NLRI"><a href="#MP-UNREACH-NLRI" class="headerlink" title="MP_UNREACH_NLRI"></a>MP_UNREACH_NLRI</h2><p>•MP_UNREACH_NLRI被携带于BGP Update报文中，用于撤销不可达的路由。</p>
<p>•其详细字段如下：</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/4.png"></p>
<blockquote>
<p>•例如EVPN的AFI为25 (L2VPN) ，SAFI为70 (EVPN)。</p>
</blockquote>
<h1 id="EVPN"><a href="#EVPN" class="headerlink" title="EVPN"></a>EVPN</h1><h2 id="EVPN简介"><a href="#EVPN简介" class="headerlink" title="EVPN简介"></a>EVPN简介</h2><h3 id="MPLS简介"><a href="#MPLS简介" class="headerlink" title="MPLS简介"></a>MPLS简介</h3><p>•MPLS （Multiprotocol Label Switching，多协议标记交换）位于TCP/IP协议栈中的数据链路层和网络层之间，在两层之间增加了额外的MPLS头部。报文转发直接基于MPLS头部。MPLS头部又被称为MPLS标签（Label）。</p>
<p>•MPLS以标签交换替代IP转发，实现了基于标签的快速转发。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/5.png"></p>
<blockquote>
<p>•MPLS起源于IPv4（Internet Protocol version 4），其核心技术可扩展到多种网络协议，包括IPv6（Internet Protocol version 6）、IPX（Internet Packet Exchange）、Appletalk、DECnet、CLNP（Connectionless Network Protocol）等。MPLS中的“Multiprotocol”指的就是支持多种网络协议。</p>
<p>•MPLS以标签交换替代IP转发。标签是一个短而定长的、只具有本地意义的连接标识符，与ATM的VPI/VCI以及Frame Relay的DLCI类似。</p>
<p>•MPLS域（MPLS Domain）：一系列连续的运行MPLS的网络设备构成了一个MPLS域。</p>
</blockquote>
<h3 id="VPLS简介"><a href="#VPLS简介" class="headerlink" title="VPLS简介"></a>VPLS简介</h3><p>VPLS（Virtual Private LAN Service）是一种基于以太网的二层VPN技术，它在MPLS网络上提供了类似LAN的业务，允许用户可以从多个地址位置接入网络、相互访问。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/6.png"></p>
<h3 id="传统L2VPN"><a href="#传统L2VPN" class="headerlink" title="传统L2VPN"></a>传统L2VPN</h3><p>•传统的L2VPN业务例如VPLS（Virtual Private LAN Service），提供用户远程站点之间二层连接服务。它组建二层交换网，像二层交换机一样透传以太报文。本例中PE1和PE2组建的VPLS网络透传CE1和CE2之间的VLAN流量。</p>
<p>•因此在传统L2VPN中对于远端MAC地址的学习依靠ARP广播泛洪，PE设备将需要承载广播流量。广播占用较多的接口带宽，这是传统L2VPN的一个典型问题。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/7.png"></p>
<blockquote>
<p>•VPLS有更多的问题，例如不支持多活接入、故障收敛慢、不支持负载均衡等不在本课程介绍，请学习HCIE-HCIE-Datacom《Etherent VPN》和RFC 7209 - Requirements for Ethernet VPN (EVPN)。</p>
</blockquote>
<h3 id="EVPN的诞生"><a href="#EVPN的诞生" class="headerlink" title="EVPN的诞生"></a>EVPN的诞生</h3><p>•随着新技术和新场景对网络需求，VPLS被暴露出更多的问题无法满足二层VPN的需求。业界重新审视了对Ethernet VPN的需求（RFC 7209），提出新的解决方案EVPN（Ethernet VPN）。</p>
<p>•EVPN最初在RFC 7432中被定义，EVPN引入控制平面，用于更好的控制MAC地址学习过程。</p>
<p>•EVPN的控制平面采用MP-BGP，数据平面支持MPLS LSPs或者IP/GRE tunneling。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/8.png"></p>
<blockquote>
<p>•<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/rfc7209/">https://datatracker.ietf.org/doc/rfc7209/</a></p>
<p>•<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/rfc7432/">https://datatracker.ietf.org/doc/rfc7432/</a></p>
</blockquote>
<h3 id="EVPN的优势"><a href="#EVPN的优势" class="headerlink" title="EVPN的优势"></a>EVPN的优势</h3><p>•EVPN颠覆了传统L2 VPN数据面学习的方式，引入控制面学习MAC和IP指导数据转发，实现了转控分离。</p>
<p>•EVPN解决传统L2 VPN的典型问题，带来双活，快速收敛，简化运维等更多的价值。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/9.png"></p>
<blockquote>
<p>•更多详细EVPN原理，请参考HCIE-Datacom《Ethernet VPN》。</p>
</blockquote>
<h2 id="EVPN常见路由"><a href="#EVPN常见路由" class="headerlink" title="EVPN常见路由"></a>EVPN常见路由</h2><h3 id="EVPN-NLRI"><a href="#EVPN-NLRI" class="headerlink" title="EVPN NLRI"></a>EVPN NLRI</h3><p>•EVPN定义了一种新的BGP NLRI（Network Layer Reachable Information）来承载所有的EVPN路由，被称为EVPN NLRI。</p>
<p>•EVPN NLRI是MP-BGP的新型扩展，被包含于MP_REACH_NLRI中，定义了新的NLRI。它规定了EVPN的AFI（Address Family Identifier）是25，SAFI（Subsequent Address Family Identifier）是70。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/10.png"></p>
<h3 id="EVPN路由"><a href="#EVPN路由" class="headerlink" title="EVPN路由"></a>EVPN路由</h3><p>EVPN NLRI格式采用TLV（Type-Length-Value）三元组结构，使得报文具有很强的灵活性和扩展性：</p>
<p>▫Route Type定义了不同的EVPN路由。RFC 7432中首先定义了四类路由。</p>
<p>▫Length定义了字段的长度。</p>
<p>▫Route Type Specifc则表示不同的路由类型有不同的字段填充。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/11.png"></p>
<blockquote>
<p>•The NLRI field in the MP_REACH_NLRI/MP_UNREACH_NLRI attribute contains the EVPN NLRI (encoded as specified above). </p>
<p>•The EVPN NLRI is carried in BGP [<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc4271">RFC4271</a>] using BGP Multiprotocol Extensions [<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc4760">RFC4760</a>] with an Address Family Identifier (AFI) of 25 (L2VPN) and a Subsequent Address Family Identifier (SAFI) of 70 (EVPN). The NLRI field in the MP_REACH_NLRI/MP_UNREACH_NLRI attribute contains the EVPN NLRI (encoded as specified above). </p>
<p>•In order for two BGP speakers to exchange labeled EVPN NLRI, they must use BGP Capabilities Advertisements to ensure that they both are capable of properly processing such NLRI. This is done as specified in [<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc4760">RFC4760</a>], by using capability code 1 (multiprotocol BGP) with an AFI of 25 (L2VPN) and a SAFI of 70 (EVPN).</p>
</blockquote>
<h3 id="EVPN更多类型路由及作用"><a href="#EVPN更多类型路由及作用" class="headerlink" title="EVPN更多类型路由及作用"></a>EVPN更多类型路由及作用</h3><p>EVPN不仅限于二层VPN的应用，随着其EVPN路由类型的增加，支持更多的应用例如L3 VPN功能。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/12.png"></p>
<blockquote>
<p>•Type5类路由IP Prefix Route在标准化进程中目前处于草案阶段，draft-ietf-bess-evpn-prefix-advertisement。</p>
</blockquote>
<h3 id="EVPN协议标准"><a href="#EVPN协议标准" class="headerlink" title="EVPN协议标准"></a>EVPN协议标准</h3><p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/13.png"></p>
<h2 id="EVPN典型应用场景"><a href="#EVPN典型应用场景" class="headerlink" title="EVPN典型应用场景"></a>EVPN典型应用场景</h2><h3 id="EVPN在广域IP承载网的应用"><a href="#EVPN在广域IP承载网的应用" class="headerlink" title="EVPN在广域IP承载网的应用"></a>EVPN在广域IP承载网的应用</h3><p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/14.png"></p>
<blockquote>
<p>•E-LINE、E-TREE、E-LAN是EVC定义的三种类型，具体请参考城域以太网标准。<a target="_blank" rel="noopener" href="https://wiki.mef.net/display/CESG/E-Line">https://wiki.mef.net/display/CESG/E-Line</a></p>
<p>•MEF中提到了三种EVC的服务种类，点到点EVC（Point-to-Point EVC）、多点到多点EVC（Mutlipoint-to-Multipoint EVC）和根到多点EVC（Rooted-Multipoint EVC）。</p>
<ul>
<li>E-LINE：一条点到点的EVC将两个UNI严格地关联。</li>
<li>E-LAN：一个多点到多点EVC可以将两个或者两个以上的UNI关联起来，而且用户/运营商可以在不影响其他UNI的前提下根据需要向这个EVC中添加任意个UNI，或者将这个EVC中的某些UNI剔除。</li>
<li>E-TREE：这种EVC类似于三层VPN中的Hub-Spoke模式，它包含一个或多个根UNI（Root）和若干叶子UNI（Leaf），其中根UNI可以和EVC中的所有UNI直接通信，而叶子UNI只能和EVC中的根UNI直接通信，两个叶子UNI之间不能直接通信。 </li>
</ul>
</blockquote>
<h3 id="EVPN在数据中心网络的应用"><a href="#EVPN在数据中心网络的应用" class="headerlink" title="EVPN在数据中心网络的应用"></a>EVPN在数据中心网络的应用</h3><p>•在云数据中心采用EVPN的NVO（Network Virtualization Overlay）解决方案（RFC 8365）。</p>
<p>•推荐数据平面使用VXLAN封装与控制平面EVPN结合，构建灵活的数据中心Overlay网络。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/15.png"></p>
<h3 id="EVPN在园区网的应用"><a href="#EVPN在园区网的应用" class="headerlink" title="EVPN在园区网的应用"></a>EVPN在园区网的应用</h3><p>•园区网虚拟化园区解决方案同在云数据中心相同，采用EVPN的NVO解决方案（RFC 8365）。</p>
<p>•在不同的底层组网上使用VXLAN封装与控制平面EVPN结合，构建灵活的数据中心Overlay网络。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/16.png"></p>
<h3 id="EVPN在SD-WAN的应用"><a href="#EVPN在SD-WAN的应用" class="headerlink" title="EVPN在SD-WAN的应用"></a>EVPN在SD-WAN的应用</h3><p>•SD-WAN是新一代的企业分支互联解决方案，支持智能动态选路、ZTP和可视化等特性。</p>
<p>•SD-WAN解决方案中，在RR与CPE之间部署EVPN用于在控制平面传播SD-WAN的Overlay VPN路由，数据平面采用IPSec VPN构建安全的转发通道。</p>
<p><img src="/2021/05/10/BGP-EVPN%E5%9F%BA%E7%A1%80/17.png"></p>
<blockquote>
<p>•Overlay VPN路由包括站点VPN路由前缀、下一跳TNP路由信息以及用于CPE之间数据通道的数据加密所需要的IPSec相关密钥等信息。详细内容请参考SD-WAN课程。</p>
<p>•CPE（Customer Premise Equipment，客户终端设备）。</p>
</blockquote>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>1.（简答题）请简述EVPN的原理和常见的路由类型。</p>
<p><strong>EVPN是MP-BGP的扩展，常见有五种路由类型，被用于作为L2或者L3隧道的控制平面。</strong></p>
<p>2.（简答题）请简述EVPN的应用场景。</p>
<p><strong>EVPN可以被广泛用于企业全场景，例如SD-WAN、园区网、数据中心和广域网。在数据中心和园区中，EVPN与VXLAN结合构建业务 Overlay。在SD-WAN场景中EVPN与IPSec结合构建企业分支互联网络。在广域网中EVPN可以与各种底层隧道/标签技术结合，例如MPLS/SR/VPLS/VPWS等。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MP-BGP对BGP-4的扩展允许不同类型的地址族在BGP中同时分发，例如IPv4组播、IPv6、L3VPN、EVPN等。</p>
<p>•本章节简单介绍EVPN的提出用于解决Ethernet二层VPN的问题。随着应用场景的逐渐丰富和协议的扩展，EVPN可以被用于多场景包括广域IP承载网络、数据中心网络、园区网络和SD-WAN。</p>
<h1 id="拓展信息"><a href="#拓展信息" class="headerlink" title="拓展信息"></a>拓展信息</h1><p>•<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/rfc4760/">https://datatracker.ietf.org/doc/rfc4760/</a></p>
<p>•<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/rfc7209/">https://datatracker.ietf.org/doc/rfc7209/</a></p>
<p>•<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/rfc7432/">https://datatracker.ietf.org/doc/rfc7432/</a></p>
<p>•<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/rfc8365/">https://datatracker.ietf.org/doc/rfc8365/</a></p>
<p>•<a target="_blank" rel="noopener" href="https://wiki.mef.net/display/CESG/MEF+6.3+-+EVC+Ethernet+Services+Definitions">https://wiki.mef.net/display/CESG/MEF+6.3+-+EVC+Ethernet+Services+Definitions</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/" itemprop="url">BGP路由优选</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-10T17:56:08+08:00">
                2021-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•BGP是一个应用非常广泛的边界网关路由协议，在全球范围内被大量部署。BGP定义了多种路径属性，并且拥有丰富的路由策略工具，这使得BGP在路由操控和路径决策上变得非常灵活。</p>
<p>•针对BGP路由的各种属性的操作都可能影响路由的优选，从而对网络的流量产生影响，因此掌握BGP路由的优选规则十分重要。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述BGP路由优选规则</p>
<p>▫实现BGP路由控制</p>
<h1 id="BGP路由优选"><a href="#BGP路由优选" class="headerlink" title="BGP路由优选"></a>BGP路由优选</h1><h2 id="BGP路由优选规则"><a href="#BGP路由优选规则" class="headerlink" title="BGP路由优选规则"></a>BGP路由优选规则</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p><strong>丢弃下一跳不可达的路由。</strong></p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<blockquote>
<p><strong>↑</strong>  <strong>取值越大越优</strong></p>
</blockquote>
<hr>
<blockquote>
<p><strong>↓</strong>  <strong>取值越小越优</strong></p>
</blockquote>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<blockquote>
<p>当前8条属性全部相同时可以形成路由负载分担</p>
<p>•上述规则依序排列，BGP进行路由优选时，从第一条规则开始执行，如果根据第一条规则无法作出判断，例如路由的Preferred-Value属性值相同，则继续执行下一条规则，如果根据当前的规则，BGP能够决策出最优的路由，则不再继续往下执行。</p>
<p>•本文选取了BGP路由优选规则中最为关键的12条，接下来将逐一讲解并验证上述规则。</p>
<p>•在后续的内容中可能会提到诸如“第8条选路规则”之类的术语，则对应本页所罗列的第8条选路规则。</p>
<p>•AIGP（Accumulated Interior Gateway Protocol，累加IGP度量值）用于传递并累加IGP metric值，该属性值并不常用，在BGP路由优选规则中并不涉及。</p>
</blockquote>
<hr>
<h2 id="拓扑说明-1"><a href="#拓扑说明-1" class="headerlink" title="拓扑说明 (1)"></a>拓扑说明 (1)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/2.png"></p>
<p>•AS、设备互联地址如图所示，所有设备均创建Loopback0接口，IP地址为10.0.x.x（x为设备编号），所有设备使用环回口地址作为Router ID。</p>
<p>•AS200内运行OSPF，在内部互联接口（不包含连接外部AS的接口）、Loopback接口上激活OSPF。</p>
<h2 id="拓扑说明-2"><a href="#拓扑说明-2" class="headerlink" title="拓扑说明 (2)"></a>拓扑说明 (2)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/3.png"></p>
<p>•AS内部基于Loopback0接口建立IBGP对等体关系，AS之间基于直连接口建立EBGP对等体关系。</p>
<p>•R4、R5上存在相同的网段：10.0.45.0/24，通过import-route命令将该网段的直连路由注入到BGP，用于验证BGP路由优选规则。</p>
<h2 id="BGP路由优选规则-1"><a href="#BGP路由优选规则-1" class="headerlink" title="BGP路由优选规则"></a>BGP路由优选规则</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   <strong>丢弃下一跳不可达的路由。</strong></p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h2 id="丢弃下一跳不可达的路由-1"><a href="#丢弃下一跳不可达的路由-1" class="headerlink" title="丢弃下一跳不可达的路由 (1)"></a>丢弃下一跳不可达的路由 (1)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/4.png"></p>
<p>•R4、R5将BGP路由10.0.45.0/24通告给AS200时Next_Hop属性值为10.0.24.4、10.0.34.5。</p>
<p>•R2、R3将路由通告给R1时不修改Next_Hop属性值，R1学习到的两条BGP路由10.0.45.0/24下一跳为10.0.24.4、10.0.34.5。</p>
<p>•R1进行BGP路由下一跳迭代查询时，由于R2、R3未在连接外部AS的接口上激活OSPF，导致路由迭代失败，R1上的BGP路由10.0.45.0/24下一跳不可达。</p>
<p>•在R1上通过<strong>display bgp routing</strong>查看BGP路由表，此时BGP路由10.0.45.0/24为非有效路由条目。</p>
<h2 id="丢弃下一跳不可达的路由-2"><a href="#丢弃下一跳不可达的路由-2" class="headerlink" title="丢弃下一跳不可达的路由 (2)"></a>丢弃下一跳不可达的路由 (2)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/5.png"></p>
<p>在R2、R3上通过<strong>next-hop-local</strong>命令修改Next_Hop属性值为本地更新源地址。</p>
<p>R2、R3向R1通告BGP路由时Next_Hop属性值将会变为：10.0.2.2、10.0.3.3。</p>
<p>这两个下一跳地址在R1上能够成功进行路由迭代，BGP路由的下一跳地址将会变成可达。</p>
<h2 id="丢弃下一跳不可达的路由-3"><a href="#丢弃下一跳不可达的路由-3" class="headerlink" title="丢弃下一跳不可达的路由 (3)"></a>丢弃下一跳不可达的路由 (3)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/6.png"></p>
<h2 id="BGP路由优选规则1"><a href="#BGP路由优选规则1" class="headerlink" title="BGP路由优选规则1"></a>BGP路由优选规则1</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p><strong>1.优选Preferred-Value属性值最大的路由。</strong></p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="修改Preferred-Value"><a href="#修改Preferred-Value" class="headerlink" title="修改Preferred-Value"></a>修改Preferred-Value</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/7.png"></p>
<p>使用<strong>preferred-value</strong>命令修改R3通告的BGP路由其Preferred-Value为100 ，优于R2通告BGP路由的默认Preferred-Value ，R1将会优选R3通告的BGP路由10.0.45.0/24。</p>
<h3 id="查看R1-BGP路由表"><a href="#查看R1-BGP路由表" class="headerlink" title="查看R1 BGP路由表"></a>查看R1 BGP路由表</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/8.png"></p>
<p>R3（10.0.3.3）通告的BGP路由拥有更高的Preferred-Value（100），因此R1将会优选R3通告的BGP路由10.0.45.0/24。</p>
<h2 id="BGP路由优选规则2"><a href="#BGP路由优选规则2" class="headerlink" title="BGP路由优选规则2"></a>BGP路由优选规则2</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p><strong>2.优选Local_Preference属性值最大的路由。</strong></p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="修改Local-Preference-1"><a href="#修改Local-Preference-1" class="headerlink" title="修改Local_Preference (1)"></a>修改Local_Preference (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/9.png"></p>
<h3 id="修改Local-Preference-2"><a href="#修改Local-Preference-2" class="headerlink" title="修改Local_Preference (2)"></a>修改Local_Preference (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/10.png"></p>
<p>下一跳可达、相同Preferred-Value的情况下将会比较Local_Preference，R3通告的BGP路由Local_Preference值为200，高于R2通告的BGP路由，R1将会优选R3通告的BGP路由。</p>
<h2 id="BGP路由优选规则3"><a href="#BGP路由优选规则3" class="headerlink" title="BGP路由优选规则3"></a>BGP路由优选规则3</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p><strong>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</strong></p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="本地优先"><a href="#本地优先" class="headerlink" title="本地优先"></a>本地优先</h3><p>•本条规则可以概括为在相同条件下，优选本地生成的路由，从对等体学习到的路由条目为次优。</p>
<p>•同时本地生成的路由也可能存在多种途径，当本地存在多种途径学习到相同路由时，从高到低优先级如下：</p>
<ul>
<li>手动聚合：手动通过aggregate命令在BGP视图内聚合生成的聚合路由</li>
<li>自动聚合：Summary automatic命令生成的自动聚合路由</li>
<li>Network方式注入的路由</li>
<li>Import-route方式注入的路由</li>
</ul>
<blockquote>
<p>•本条规则我们验证了：</p>
<p>​    ▫本地产生的BGP路由优于从对等体学习的BGP路由</p>
<p>​    ▫手动聚合产生的BGP路由优于自动聚合产生的BGP路由</p>
</blockquote>
<h3 id="手动聚合-1"><a href="#手动聚合-1" class="headerlink" title="手动聚合 (1)"></a>手动聚合 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/11.png"></p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/12.png"></p>
<h3 id="手动聚合-2"><a href="#手动聚合-2" class="headerlink" title="手动聚合 (2)"></a>手动聚合 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/13.png"></p>
<blockquote>
<p>•BGP路由表中“s”标志代表该路由条目被抑制。</p>
</blockquote>
<h3 id="手动聚合-3"><a href="#手动聚合-3" class="headerlink" title="手动聚合 (3)"></a>手动聚合 (3)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/14.png"></p>
<p>•R3上通过<strong>display bgp routing-table</strong> <strong>10.0.45.0</strong> <strong>24</strong>查看BGP路由10.0.45.0/24的详细信息，存在两条有效路由，其中最优的为手动聚合产生的路由。</p>
<p>•在本案例中我们验证了本地产生的BGP路由优于从对等体学习的BGP路由。</p>
<h3 id="自动聚合-1"><a href="#自动聚合-1" class="headerlink" title="自动聚合 (1)"></a>自动聚合 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/15.png"></p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/16.png"></p>
<h3 id="自动聚合-2"><a href="#自动聚合-2" class="headerlink" title="自动聚合 (2)"></a>自动聚合 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/17.png"></p>
<h3 id="自动聚合-3"><a href="#自动聚合-3" class="headerlink" title="自动聚合 (3)"></a>自动聚合 (3)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/18.png"></p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/19.png"></p>
<h3 id="自动聚合-4"><a href="#自动聚合-4" class="headerlink" title="自动聚合 (4)"></a>自动聚合 (4)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/20.png"></p>
<p>•R3上通过<strong>display bgp routing-table</strong> <strong>10.0.0.0</strong> 查看BGP路由10.0.0.0/8的详细信息，存在三条有效路由，其中最优的条目由聚合产生，并且存在Atomic-aggregate属性，由此可以看出该聚合条目为手动聚合产生的条目。</p>
<p>•R3上相同的BGP聚合路由：手动聚合 &gt; 自动聚合。</p>
<p>•在该案例中我们验证了手动聚合产生的BGP路由优于自动聚合产生的BGP路由。</p>
<blockquote>
<p>•本地Network优于本地import，此案例不再展示。</p>
<p>•自动聚合产生的聚合路由并不会携带Atomic-aggregate属性。</p>
</blockquote>
<h2 id="BGP路由优选规则4"><a href="#BGP路由优选规则4" class="headerlink" title="BGP路由优选规则4"></a>BGP路由优选规则4</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p><strong>4.优选AS_Path属性值最短的路由。</strong></p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="优选AS-Path最短-1"><a href="#优选AS-Path最短-1" class="headerlink" title="优选AS_Path最短 (1)"></a>优选AS_Path最短 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/21.png"></p>
<h3 id="优选AS-Path最短-2"><a href="#优选AS-Path最短-2" class="headerlink" title="优选AS_Path最短 (2)"></a>优选AS_Path最短 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/22.png"></p>
<h2 id="BGP路由优选规则5"><a href="#BGP路由优选规则5" class="headerlink" title="BGP路由优选规则5"></a>BGP路由优选规则5</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p><strong>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</strong></p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="Origin属性验证-1"><a href="#Origin属性验证-1" class="headerlink" title="Origin属性验证 (1)"></a>Origin属性验证 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/23.png"></p>
<p>•R4、R5上默认采用import-route方式将路由10.0.45.0/24注入到BGP，R1的BGP路由表中两条BGP路由10.0.45.0/24其Origin属性都是“？”，此时R1优选R4注入的BGP路由。</p>
<p>•在R5上修改注入路由的方式为network</p>
<p>•之后在R1上再次查看BGP路由表。</p>
<h3 id="Origin属性验证-2"><a href="#Origin属性验证-2" class="headerlink" title="Origin属性验证 (2)"></a>Origin属性验证 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/24.png"></p>
<p>•此时R5注入的BGP路由10.0.45.0/24其Origin属性为“i”，在前几条优选规则相同情况下，起源类型为“i”的BGP路由成为优选路由。</p>
<h2 id="BGP路由优选规则6"><a href="#BGP路由优选规则6" class="headerlink" title="BGP路由优选规则6"></a>BGP路由优选规则6</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p><strong>6.优选MED属性值最小的路由。</strong></p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="优选MED最小-1"><a href="#优选MED最小-1" class="headerlink" title="优选MED最小 (1)"></a>优选MED最小 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/25.png"></p>
<h3 id="优选MED最小-2"><a href="#优选MED最小-2" class="headerlink" title="优选MED最小 (2)"></a>优选MED最小 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/26.png"></p>
<h2 id="BGP路由优选规则7"><a href="#BGP路由优选规则7" class="headerlink" title="BGP路由优选规则7"></a>BGP路由优选规则7</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p><strong>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</strong></p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="优选从EBGP对等体学来的路由-1"><a href="#优选从EBGP对等体学来的路由-1" class="headerlink" title="优选从EBGP对等体学来的路由 (1)"></a>优选从EBGP对等体学来的路由 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/27.png"></p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/28.png"></p>
<h3 id="优选从EBGP对等体学来的路由-2"><a href="#优选从EBGP对等体学来的路由-2" class="headerlink" title="优选从EBGP对等体学来的路由 (2)"></a>优选从EBGP对等体学来的路由 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/29.png"></p>
<h2 id="BGP路由优选规则8"><a href="#BGP路由优选规则8" class="headerlink" title="BGP路由优选规则8"></a>BGP路由优选规则8</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p><strong>8.优选到Next_Hop的IGP度量值最小的路由。</strong></p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="IGP-Cost"><a href="#IGP-Cost" class="headerlink" title="IGP Cost"></a>IGP Cost</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/30.png"></p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/31.png"></p>
<h3 id="优选IGP-Cost值最小-1"><a href="#优选IGP-Cost值最小-1" class="headerlink" title="优选IGP Cost值最小 (1)"></a>优选IGP Cost值最小 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/32.png"></p>
<h3 id="优选IGP-Cost值最小-2"><a href="#优选IGP-Cost值最小-2" class="headerlink" title="优选IGP Cost值最小 (2)"></a>优选IGP Cost值最小 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/33.png"></p>
<h3 id="优选IGP-Cost值最小-3"><a href="#优选IGP-Cost值最小-3" class="headerlink" title="优选IGP Cost值最小 (3)"></a>优选IGP Cost值最小 (3)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/34.png"></p>
<p>•R1上通过<strong>display bgp routing-table</strong> <strong>10.0.45.0 24</strong> 查看BGP路由的详细信息，下一跳10.0.2.2的BGP路由其IGP cost值变为了10，而下一跳为10.0.3.3的BGP路由其IGP cost为默认值1，所以R1优选下一跳为10.0.3.3的路由。</p>
<p>•在R1的路由详细信息中可以看到如下内容：</p>
<p>​    <strong>not preferred for IGP cost</strong></p>
<p>​    表明该路由因为IGP cost未被优选。</p>
<h3 id="BGP路由等价负载分担"><a href="#BGP路由等价负载分担" class="headerlink" title="BGP路由等价负载分担"></a>BGP路由等价负载分担</h3><p>•在大型网络中，到达同一目的地通常会存在多条有效BGP路由，设备只会优选一条最优的BGP路由，将该路由加载到路由表中使用，这一特点往往会造成很多流量负载不均衡的情况。</p>
<p>•通过配置BGP负载分担，可以使得设备同时将多条等代价的BGP路由加载到路由表，实现流量负载均衡，减少网络拥塞。</p>
<p>•值得注意的是，尽管配置了BGP负载分担，设备依然只会在多条到达同一目的地的BGP路由中优选一条路由，并只将这条路由通告给其他对等体。</p>
<p>•在设备上使能BGP负载分担功能后，只有满足条件的多条BGP路由才会成为等价路由，进行负载分担。</p>
<blockquote>
<p>•默认情况下设备只会对AS_Path完全相同的路由进行负载分担，可以使用<strong>load-balancing as-path-ignore</strong>忽略AS_Path路径不一致。</p>
<p>•在公网中到达同一目的地的路由形成负载分担时，系统会首先判断最优路由的类型。若最优路由为IBGP路由则只是IBGP路由参与负载分担，若最优路由为EBGP路由则只是EBGP路由参与负载分担，即公网中到达同一目的地的IBGP和EBGP路由不能形成负载分担。</p>
</blockquote>
<h3 id="形成BGP路由等价负载分担的条件"><a href="#形成BGP路由等价负载分担的条件" class="headerlink" title="形成BGP路由等价负载分担的条件"></a>形成BGP路由等价负载分担的条件</h3><p>•Preferred-Value属性值相同。</p>
<p>•Local_Preference属性值相同。</p>
<p>•都是聚合路由或者非聚合路由。</p>
<p>•AS_Path属性长度相同。</p>
<p>•Origin类型（IGP、EGP、Incomplete）相同。</p>
<p>•MED属性值相同。</p>
<p>•都是EBGP路由或都是IBGP路由。</p>
<p>•AS内部IGP的Metric相同。</p>
<p>•AS_Path属性完全相同。</p>
<h3 id="配置BGP路由负载分担"><a href="#配置BGP路由负载分担" class="headerlink" title="配置BGP路由负载分担"></a>配置BGP路由负载分担</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/35.png"></p>
<p>以左侧拓扑为例，R1上两条BGP路由在不做任何路由策略、配置的情况下，前8条优选规则无法比较出优选路由。因此可以配置IBGP路由的负载分担。</p>
<h3 id="配置BGP路由负载分担后"><a href="#配置BGP路由负载分担后" class="headerlink" title="配置BGP路由负载分担后"></a>配置BGP路由负载分担后</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/36.png"></p>
<h2 id="BGP路由优选规则9"><a href="#BGP路由优选规则9" class="headerlink" title="BGP路由优选规则9"></a>BGP路由优选规则9</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p><strong>9.优选Cluster_List最短的路由。</strong></p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="优选Cluster-List最短案例-1"><a href="#优选Cluster-List最短案例-1" class="headerlink" title="优选Cluster_List最短案例 (1)"></a>优选Cluster_List最短案例 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/37.png"></p>
<p>对拓扑做如下修改：</p>
<p>•只在R5上将10.0.45.0/24发布到BGP</p>
<p>•配置R1为RR，R3为R1的客户端。</p>
<p>•R2、R3之间基于环回口建立IBGP对等体关系</p>
<p>R2上将收到R3通告的BGP路由10.0.45.0/24、R1反射的BGP路由10.0.45.0/24。</p>
<p>默认配置下，前面介绍的规则无法比较出优选路由，此时将根据Cluster_List进行优选。</p>
<h3 id="优选Cluster-List最短案例-2"><a href="#优选Cluster-List最短案例-2" class="headerlink" title="优选Cluster_List最短案例 (2)"></a>优选Cluster_List最短案例 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/38.png"></p>
<p>从BGP路由表中无法看出优选的是R1反射的BGP路由还是R3通告的BGP路由，此时可以通过命令<strong>display</strong> <strong>bgp routing</strong> <strong>10.0.45.0</strong> <strong>24</strong>查看BGP路由详细信息。</p>
<h3 id="优选Cluster-List最短案例-3"><a href="#优选Cluster-List最短案例-3" class="headerlink" title="优选Cluster_List最短案例 (3)"></a>优选Cluster_List最短案例 (3)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/39.png"></p>
<p>•经由R1反射的路由不是最优路由，原因也被标出：</p>
<p><strong>not preferred for Cluster List</strong>*</p>
<p>•R3直接通告给R2的BGP路由因为没有经过路由反射器，不存在Cluster_List属性，即被认为Cluster_List长度为0，小于由R1反射的BGP路由其Cluster_List长度（1），所以R3通告的BGP路由为优选路由。</p>
<h2 id="BGP路由优选规则10"><a href="#BGP路由优选规则10" class="headerlink" title="BGP路由优选规则10"></a>BGP路由优选规则10</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p><strong>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</strong></p>
<p>11.优选具有最小IP地址的对等体通告的路由。</p>
<h3 id="优选Router-ID最小-1"><a href="#优选Router-ID最小-1" class="headerlink" title="优选Router ID最小 (1)"></a>优选Router ID最小 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/40.png"></p>
<p>在我们的讲解拓扑中，默认配置下R1从R2、R3都会收到BGP路由10.0.45.0/24，并且前面的优选规则无法比较出优选路由，最终将会根据本条规则，优选Router ID最小的对等体通告的BGP路由，在本案例中也就是R2通告的BGP路由。</p>
<h3 id="优选Router-ID最小-2"><a href="#优选Router-ID最小-2" class="headerlink" title="优选Router ID最小 (2)"></a>优选Router ID最小 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/41.png"></p>
<p>查看R1的BGP路由表详细信息，来自10.0.3.3的BGP路由因Router ID原因没有被优选：<br> <strong>not preferred for router ID</strong></p>
<h3 id="优选Orginator-ID最小-1"><a href="#优选Orginator-ID最小-1" class="headerlink" title="优选Orginator_ID最小 (1)"></a>优选Orginator_ID最小 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/42.png"></p>
<p>如果BGP路由携带Originator_ID属性，则在本条规则的优选过程中，将比较Originator_ID的大小，并优选Originator_ID最小的BGP路由。</p>
<h3 id="优选Orginator-ID最小-2"><a href="#优选Orginator-ID最小-2" class="headerlink" title="优选Orginator_ID最小 (2)"></a>优选Orginator_ID最小 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/43.png"></p>
<h2 id="BGP路由优选规则11"><a href="#BGP路由优选规则11" class="headerlink" title="BGP路由优选规则11"></a>BGP路由优选规则11</h2><p>当到达同一个目的网段存在多条路由时，BGP通过如下的次序进行路由优选：</p>
<p>   丢弃下一跳不可达的路由。</p>
<p>1.优选Preferred-Value属性值最大的路由。</p>
<p>2.优选Local_Preference属性值最大的路由。</p>
<p>3.本地始发的BGP路由优于从其他对等体学习到的路由，本地始发的路由优先级：优选手动聚合&gt;自动聚合&gt;network&gt;import&gt;从对等体学到的。</p>
<p>4.优选AS_Path属性值最短的路由。</p>
<p>5.优选Origin属性最优的路由。Origin属性值按优先级从高到低的排列是：IGP、EGP及Incomplete。</p>
<p>6.优选MED属性值最小的路由。</p>
<p>7.优选从EBGP对等体学来的路由（EBGP路由优先级高于IBGP路由）。</p>
<p>8.优选到Next_Hop的IGP度量值最小的路由。</p>
<p>9.优选Cluster_List最短的路由。</p>
<p>10.优选Router ID（Orginator_ID）最小的设备通告的路由。</p>
<p><strong>11.优选具有最小IP地址的对等体通告的路由。</strong></p>
<h3 id="优选具有最小IP地址的对等体-1"><a href="#优选具有最小IP地址的对等体-1" class="headerlink" title="优选具有最小IP地址的对等体 (1)"></a>优选具有最小IP地址的对等体 (1)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/44.png"></p>
<p>•当前面所有规则都无法比较出优选路由时，此时会根据对等体地址大小来进行优选，对等体地址较小者发送的路由较优。</p>
<p>•修改前一条规则的验证拓扑，R2、R3都与R4相连，R4作为RR客户端，只在R4上将路由发布到BGP，此时R2、R3反射的BGP路由将拥有相同的Originator ID：10.0.4.4。</p>
<h3 id="优选具有最小IP地址的对等体-2"><a href="#优选具有最小IP地址的对等体-2" class="headerlink" title="优选具有最小IP地址的对等体 (2)"></a>优选具有最小IP地址的对等体 (2)</h3><p><img src="/2021/05/10/BGP%E8%B7%AF%E7%94%B1%E4%BC%98%E9%80%89/45.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）从EBGP对等体收到的BGP路由通告给IBGP对等体时如何修改next_hop属性值为自身更新源地址？</p>
<p><strong>使用peer next-hop-local命令指定next_hop属性为TCP连接源地址。</strong></p>
<p>2.（判断题）当前三条优选规则相同的情况下，BGP会比较AS_Path长度，当AS_Path长度相同时会比较AS号的大小。</p>
<p>A.对</p>
<p><strong>B.错</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•BGP采用路径属性进行路由优选，这让BGP拥有丰富的可选比较项，可以在不同的场景下根据不同的路径属性选择出最适合的路由。</p>
<p>•BGP定义了一套详细的最优路径选择算法，这使得路由器能够在任何复杂的、高冗余性的网络环境下选择出最优的路径，这套算法也被称作BGP路由优选规则，或者BGP选路原则。</p>
<p>•BGP选路原则在实际中频繁应用，需要熟练掌握。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/" itemprop="url">BGP路径属性与路由反射器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-10T17:55:55+08:00">
                2021-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•任何一条BGP路由都拥有多个路径属性（Path Attributes），当路由器通告BGP路由给它的对等体时，该路由将会携带多个路径属性，这些属性描述了BGP路由的各项特征，同时在某些场景下也会影响BGP路由优选的决策。</p>
<p>•IBGP水平分割规则用于防止AS内部产生环路，在很大程度上杜绝了IBGP路由产生环路的可能性，但是同时也带来了新的问题：BGP路由在AS内部只能传递一跳，如果建立IBGP对等体全互联模型又会加重设备的负担。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述BGP常见的路径属性及作用</p>
<p>▫描述BGP路由反射器的概念及应用场景</p>
<p>▫描述BGP路由反射器的规则及工作机制</p>
<h1 id="BGP路径属性"><a href="#BGP路径属性" class="headerlink" title="BGP路径属性"></a>BGP路径属性</h1><h2 id="路径属性"><a href="#路径属性" class="headerlink" title="路径属性"></a><strong>路径属性</strong></h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/1.png"></p>
<p>•任何一条BGP路由都拥有多个路径属性。</p>
<p>•当路由器将BGP路由通告给它的对等体时，一并被通告的还有路由所携带的各个路径属性。</p>
<p>•BGP的路径属性将影响路由优选</p>
<h2 id="路径属性分类"><a href="#路径属性分类" class="headerlink" title="路径属性分类"></a>路径属性分类</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/2.png"></p>
<p>•公认属性是所有BGP路由器都必须能够识别的属性</p>
<p>•公认属性可以分为两类：</p>
<p>​    ▫公认必遵（Well-known Mandatory）：必须包括在每个Update消    息里。</p>
<p>​    ▫公认任意（Well-known Discretionary）：可能包括在某些Update    消息里。</p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/3.png"></p>
<p>•可选属性不需要都被BGP路由器所识别</p>
<p>•可选属性可以分为两类：</p>
<p>​    ▫可选过渡（Optional Transitive）：BGP设备不识别此类属性依然会    接受该类属性并通告给其他对等体。</p>
<p>​    ▫可选非过渡（Optional Non-transitive）：BGP设备不识别此类属性    会忽略该属性，且不会通告给其他对等体。    </p>
<blockquote>
<p>•BGP属性很多，这里仅列出常用BGP属性。</p>
</blockquote>
<h2 id="BGP-Update报文举例"><a href="#BGP-Update报文举例" class="headerlink" title="BGP Update报文举例"></a>BGP Update报文举例</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/4.png"></p>
<h2 id="AS-Path"><a href="#AS-Path" class="headerlink" title="AS_Path"></a>AS_Path</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/5.png"></p>
<p>•该属性为公认必遵属性，是前往目标网络的路由经过的AS号列表；</p>
<p>•作用：确保路由在EBGP对等体之间传递无环；另外也作为路由优选的衡量标准之一；</p>
<p>•路由在被通告给EBGP对等体时，路由器会在该路由的AS_Path中追加上本地的AS号；路由被通告给IBGP对等体时，AS_Path不会发生改变。</p>
<h2 id="AS-Path防止环路"><a href="#AS-Path防止环路" class="headerlink" title="AS_Path防止环路"></a>AS_Path防止环路</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/6.png"></p>
<p>R1从R4收到的BGP路由更新中AS_Path属性数值为：400 300 200 100，存在自身AS号，不接收该路由，从而防止了路由环路的产生。</p>
<h2 id="AS-Path影响路由优选"><a href="#AS-Path影响路由优选" class="headerlink" title="AS_Path影响路由优选"></a>AS_Path影响路由优选</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/7.png"></p>
<h2 id="AS-Path类型"><a href="#AS-Path类型" class="headerlink" title="AS_Path类型"></a>AS_Path类型</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/8.png"></p>
<blockquote>
<p>•路由聚合解决了两类问题，一是减轻了设备的负担，二是隐藏了明细的路由信息，减少了路由震荡的影响。但是路由聚合后，AS_Path属性丢失，存在产生环路的风险，为此可以通过AS_SET类型的AS_Path属性携带聚合前的AS路径信息。</p>
<p>•当发生路由聚合后，如果需要聚合路由携带所有明细路由中AS_Path属性携带的AS号防止环路，则在配置聚合的命令中增加as-set参数。</p>
<p>•在AS_SET的示例中AS 300内发生了路由聚合并配置了as-set参数，则聚合路由会将明细路由的AS_Path信息用一个AS-Set集表示（放在中括号{}里的AS号信息，该集合内的AS号没有先后顺序），在聚合路由中携带用以防止环路。</p>
<p>•除了AS_SET、AS_AS_SEQENCE之外，AS_Path还存在另外两种类型：AS_Confed_Sequence、AS_Confed_Set，这两种类型应用于BGP联邦中，本课程不涉及。</p>
</blockquote>
<h2 id="修改AS-Path"><a href="#修改AS-Path" class="headerlink" title="修改AS_Path"></a>修改AS_Path</h2><p>使用Route-Policy修改BGP路由的AS_Path属性时，可以使用以下三种方式：</p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/9.png"></p>
<h2 id="Origin"><a href="#Origin" class="headerlink" title="Origin"></a>Origin</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/10.png"></p>
<p>•该属性为公认必遵属性，它标识了BGP路由的起源。如上表所示，根据路由被引入BGP的方式不同，存在三种类型的Origin。</p>
<p>•当去往同一个目的地存在多条不同Origin属性的路由时，在其他条件都相同的情况下，BGP将按如Origin的下顺序优选路由：IGP &gt; EGP &gt; Incomplete。</p>
<h2 id="Origin在BGP表中的显示"><a href="#Origin在BGP表中的显示" class="headerlink" title="Origin在BGP表中的显示"></a>Origin在BGP表中的显示</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/11.png"></p>
<h2 id="Next-Hop"><a href="#Next-Hop" class="headerlink" title="Next_Hop"></a>Next_Hop</h2><p>•该属性是一个公认必遵属性，用于指定到达目标网络的下一跳地址。</p>
<p>•当路由器学习到BGP路由后，需对BGP路由的Next_Hop属性值进行检查，该属性值（IP地址）必须在本地路由可达，如果不可达，则这条BGP路由不可用。</p>
<p>•在不同的场景中，设备对BGP路由的缺省Next_Hop属性值的设置规则如下：</p>
<p>▫路由器将BGP路由通告给自己的EBGP对等体时，将该路由的Next_Hop设置为自己的更新源IP地址。</p>
<p>▫路由器在收到EBGP对等体所通告的BGP路由后，在将路由传递给自己的IBGP对等体时，会保持路由的Next_Hop属性值不变。</p>
<p>▫如果路由器收到某条BGP路由，该路由的Next_Hop属性值与EBGP对等体（更新对象）同属一个网段，那么该条路由的Next_Hop地址将保持不变并传递给它的BGP对等体。</p>
<h2 id="Next-Hop的缺省操作-1"><a href="#Next-Hop的缺省操作-1" class="headerlink" title="Next_Hop的缺省操作 (1)"></a>Next_Hop的缺省操作 (1)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/12.png"></p>
<p>路由器将BGP路由通告给自己的EBGP对等体时，将该路由的Next_Hop设置为自己的TCP连接源地址。</p>
<h2 id="Next-Hop的缺省操作-2"><a href="#Next-Hop的缺省操作-2" class="headerlink" title="Next_Hop的缺省操作 (2)"></a>Next_Hop的缺省操作 (2)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/13.png"></p>
<p>路由器在收到EBGP对等体所通告的BGP路由后，在将路由传递给自己的IBGP对等体时，会保持路由的Next_Hop属性值不变。</p>
<h2 id="Next-Hop的缺省操作-3"><a href="#Next-Hop的缺省操作-3" class="headerlink" title="Next_Hop的缺省操作 (3)"></a>Next_Hop的缺省操作 (3)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/14.png"></p>
<p>如果路由器收到某条BGP路由，该路由的Next_Hop属性值与EBGP对等体（更新对象）同属一个网段，那么该条路由的Next_Hop地址将保持不变并传递给它的BGP对等体。</p>
<h2 id="修改Next-hop属性"><a href="#修改Next-hop属性" class="headerlink" title="修改Next_hop属性"></a>修改Next_hop属性</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/15.png"></p>
<p>使用<strong>peer next-hop-local</strong>命令可以在设置向IBGP对等体（组）通告路由时，把下一跳属性设为自身的TCP连接源地址。</p>
<blockquote>
<p>•缺省情况下，R2通告给R3的BGP路由10.0.1.0/24的NextHop属性值为10.0.12.1，若R2未将到达10.0.12.0/24的路由发布到AS200的IGP协议中，那么R3将无法获知到达10.0.12.1的路由，此时BGP路由10.0.1.0/24的NextHop不可达，该路由将被视为无效。</p>
</blockquote>
<h2 id="Local-Preference"><a href="#Local-Preference" class="headerlink" title="Local_Preference"></a>Local_Preference</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/16.png"></p>
<p>•Local_Preference即本地优先级属性，是公认任意属性，可以用于告诉AS中的路由器，哪条路径是离开本AS的首选路径。</p>
<p>•Local_Preference属性值越大则BGP路由越优。缺省的Local_Preference值为100。</p>
<p>•该属性只能被传递给IBGP对等体，而不能传递给EBGP对等体。</p>
<h2 id="在BGP路由表中查看Local-Preference"><a href="#在BGP路由表中查看Local-Preference" class="headerlink" title="在BGP路由表中查看Local_Preference"></a>在BGP路由表中查看Local_Preference</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/17.png"></p>
<p>Local_Preference为200的BGP路由优于Local_Preference为100的BGP路由，在BGP路由表中来自10.0.12.1的BGP路由为最优。</p>
<h2 id="Local-Preference注意事项"><a href="#Local-Preference注意事项" class="headerlink" title="Local_Preference注意事项"></a>Local_Preference注意事项</h2><p>•Local_Preference属性只能在IBGP对等体间传递（除非做了策略否则Local_Preference值在IBGP对等体间传递过程中不会丢失），而不能在EBGP对等体间传递，如果在EBGP对等体间收到的路由的路径属性中携带了Local_Preference，则会进行错误处理。</p>
<p>•但是可以在AS边界路由器上使用Import方向的策略来修改Local_Preference属性值。也就是在收到路由之后，在本地为路由赋予Local_Preference。</p>
<p>•使用<strong>bgp</strong> <strong>default local-preference</strong>命令修改缺省Local_Preference值，该值缺省为100。</p>
<p>•路由器在向其EBGP对等体发送路由更新时，不能携带Local_Preference属性，但是对方接收路由之后，会在本地为这条路由赋一个缺省Local_Preference值（100），然后再将路由传递给自己的IBGP对等体。</p>
<p>•本地使用<strong>network</strong>命令及<strong>import-route</strong>命令引入的路由， Local_Preference为缺省值100，并能在AS内向其他IBGP对等体传递，传递过程中除非受路由策略影响，否则Local_Preference不变。</p>
<h2 id="Community技术背景-1"><a href="#Community技术背景-1" class="headerlink" title="Community技术背景 (1)"></a>Community技术背景 (1)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/18.png"></p>
<h2 id="Community技术背景-2"><a href="#Community技术背景-2" class="headerlink" title="Community技术背景 (2)"></a>Community技术背景 (2)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/19.png"></p>
<h2 id="Community属性"><a href="#Community属性" class="headerlink" title="Community属性"></a>Community属性</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/20.png"></p>
<p>•Community（团体）属性为可选过渡属性，是一种路由标记，用于简化路由策略的执行。</p>
<p>•可以将某些路由分配一个特定的Community属性值，之后就可以基于Community值而不是网络前缀/掩码信息来匹配路由并执行相应的策略了。</p>
<h2 id="Community属性格式"><a href="#Community属性格式" class="headerlink" title="Community属性格式"></a>Community属性格式</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/21.png"></p>
<p>Community属性值长度为32bit，也就是4Byte。可使用两种形式呈现：</p>
<p>​    ▫十进制整数格式。</p>
<p>​    ▫AA：NN格式，其中AA表示AS号，NN是自定义的编号。</p>
<blockquote>
<p>•团体（Community）属性分为自定义团体属性和公认团体属性。</p>
</blockquote>
<h2 id="公认Community属性"><a href="#公认Community属性" class="headerlink" title="公认Community属性"></a>公认Community属性</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/22.png"></p>
<p>RFC1997（BGP Communities Attribute）定义了几个公认的Community属性值，如上表所示。</p>
<blockquote>
<p>•No_Export_Subconfed团体属性涉及到BGP联邦的概念，本课程不涉及。</p>
</blockquote>
<h2 id="MED"><a href="#MED" class="headerlink" title="MED"></a>MED</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/23.png"></p>
<p>•MED（Multi-Exit Discriminator，多出口鉴别器）是可选非过渡属性，是一种度量值，用于向外部对等体指出进入本AS的首选路径，即当进入本AS的入口有多个时，AS可以使用MED动态地影响其他AS选择进入的路径。</p>
<p>•MED属性值越小则BGP路由越优。</p>
<p>•MED主要用于在AS之间影响BGP的选路。MED被传递给EBGP对等体后，对等体在其AS内传递路由时，携带该MED值，但将路由再次传递给其EBGP对等体时，缺省不会携带MED属性。</p>
<h2 id="关于MED的一些注意事项"><a href="#关于MED的一些注意事项" class="headerlink" title="关于MED的一些注意事项"></a>关于MED的一些注意事项</h2><p>•缺省情况下，路由器只比较来自同一相邻AS的BGP路由的MED值，也就是说如果去往同一个目的地的两条路由来自不同的相邻AS，则不进行MED值的比较。</p>
<p>•一台BGP路由器将路由通告给EBGP对等体时，是否携带MED属性，需要根据以下条件进行判断（不对EBGP对等体使用策略的情况下）：</p>
<ul>
<li>如果该BGP路由是本地始发（本地通过network或import-route命令引入）的，则缺省携带MED属性发送给EBGP对等体。</li>
<li>如果该BGP路由为从BGP对等体学习到，那么该路由传递给EBGP对等体时缺省不会携带MED属性。</li>
<li>在IBGP对等体之间传递路由时，MED值会被保留并传递，除非部署了策略，否则MED值在传递过程中不发生改变也不会丢失。</li>
</ul>
<h2 id="MED的默认操作-1"><a href="#MED的默认操作-1" class="headerlink" title="MED的默认操作 (1)"></a>MED的默认操作 (1)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/24.png"></p>
<p>•如果路由器通过IGP学习到一条路由，并通过<strong>network</strong>或<strong>import-route</strong>的方式将路由引入BGP，产生的BGP路由的MED值继承路由在IGP中的metric。例如上图中如果R2通过OSPF学习到了10.0.1.0/24路由，并且该路由在R2的全局路由表中OSPF Cost=100，那么当R2将路由network进BGP后，产生的BGP路由的MED值为100。</p>
<p>•如果路由器将本地直连、静态路由通过<strong>network</strong>或<strong>import-route</strong>的方式引入BGP，那么这条BGP路由的MED为0，因为直连、静态路由cost为0。</p>
<h2 id="MED的默认操作-2"><a href="#MED的默认操作-2" class="headerlink" title="MED的默认操作 (2)"></a>MED的默认操作 (2)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/25.png"></p>
<p>•如果路由器通过BGP学习到其他对等体传递过来的路由，那么将路由更新给自己的EBGP对等体时，默认是不携带MED的。这就是所谓的：“MED不会跨AS传递”。例如在上图中，如果R3从R2学习到一条携带了MED属性的BGP路由，则它将该路由通告给R4时，缺省是不会携带MED属性的。</p>
<p>•可以使用default med命令修改缺省的MED值，<strong>default med</strong>命令只对本设备上用<strong>import-route</strong>命令引入的路由和BGP的聚合路由生效。例如在R2上配置<strong>default med 999</strong>，那么R2通过<strong>import-route</strong>及<strong>aggregate</strong>命令产生的路由传递给R3时，路由携带的MED为999。</p>
<h2 id="Atomic-Aggregate及Aggregator"><a href="#Atomic-Aggregate及Aggregator" class="headerlink" title="Atomic_Aggregate及Aggregator"></a>Atomic_Aggregate及Aggregator</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/26.png"></p>
<p>Atomic_Aggregate属于公认任意属性，而Aggregator属性属于可选过渡属性。</p>
<blockquote>
<p>•R3上通过<strong>aggregate</strong>命令将BGP路由10.0.1.0/24、10.0.2.0/24、10.0.3.0/24、10.0.4.0/24聚合成了10.0.0.0/16，并使用<strong>detail-suppressed</strong>抑制了明细路由的对外发布，R3只会将聚合后的BGP路由传递给R4，而不传递聚合前的明细路由。</p>
<p>•Atomic_Aggregate是一个公认自由决定属性，它只相当于一种预警标记，而并不承载任何信息。当路由器收到一条BGP路由更新且发现该条路由携带Atomic_Aggregate属性时，它便知道该条路由可能出现了路径属性的丢失，此时该路由器把这条路由再通告给其他对等体时，需保留路由的Atomic_Aggregate属性。另外，收到该路由更新的路由器不能将这条路由再度明细化。</p>
<p>•另一个重要的属性是Aggregator，这是一个可选传递属性，当路由聚合被执行时，执行路由聚合操作的路由器可以为该聚合路由添加Aggregator属性，并在该属性中记录本地AS号及自己的Router-ID，因此Aggregator属性用于标记路由聚合行为发生在哪个AS及哪台BGP路由器上</p>
</blockquote>
<h2 id="查看聚合之后的路由"><a href="#查看聚合之后的路由" class="headerlink" title="查看聚合之后的路由"></a>查看聚合之后的路由</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/27.png"></p>
<p>在BGP路由详细信息中可与看到Aggregator属性记录了聚合设备的AS号、Router ID，同时通过Atomic-Aggregate属性标明该路由为聚合路由。</p>
<h2 id="Preferred-Value介绍"><a href="#Preferred-Value介绍" class="headerlink" title="Preferred-Value介绍"></a>Preferred-Value介绍</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/28.png"></p>
<p>•Preferred-Value（协议首选值）是华为设备的特有属性，该属性仅在本地有效。当BGP路由表中存在到相同目的地的路由时，将优先选择Preferred-Value值高的路由。</p>
<p>•取值范围：0~65535；该值越大，则路由越优先。</p>
<p>•Preferred-Value只能在路由器本地配置，而且只影响本设备的路由优选。该属性不会传递给任何BGP对等体。</p>
<h2 id="在BGP路由表中查看Preferred-Value"><a href="#在BGP路由表中查看Preferred-Value" class="headerlink" title="在BGP路由表中查看Preferred-Value"></a>在BGP路由表中查看Preferred-Value</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/29.png"></p>
<p>Preferred-Value为100的BGP路由优于Preferred-Value为0的路由，在BGP路由表中来自10.0.12.1的BGP路由为最优。</p>
<blockquote>
<p>•Preferred-value在路由表中简写为PrefVal。</p>
</blockquote>
<h1 id="BGP路由反射器"><a href="#BGP路由反射器" class="headerlink" title="BGP路由反射器"></a>BGP路由反射器</h1><h2 id="中转AS中的IBGP问题"><a href="#中转AS中的IBGP问题" class="headerlink" title="中转AS中的IBGP问题"></a>中转AS中的IBGP问题</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/30.png"></p>
<p>•由于水平分割的原因，为了保证中转AS200所有的BGP路由器都能学习到完整的BGP路由，就必须在AS内实现IBGP全互联。然而实现IBGP全互联存在诸多短板：</p>
<ul>
<li><p>路由器需维护大量的TCP及BGP连接，尤其在路由器数量较多时；</p>
</li>
<li><p>AS内BGP网络的可扩展性较差。</p>
</li>
</ul>
<p>•为此可以采用路由反射器技术。</p>
<h2 id="路由反射器角色"><a href="#路由反射器角色" class="headerlink" title="路由反射器角色"></a>路由反射器角色</h2><p>•引入路由反射器之后存在两种角色：</p>
<ul>
<li><p>RR（Route Reflector）：路由反射器</p>
</li>
<li><p>Client：RR客户端</p>
</li>
</ul>
<p>•RR会将学习的路由反射出去，从而使得IBGP路由在AS内传播无需建立IBGP全互联。</p>
<p>•将一台BGP路由器指定为RR的同时，还需要指定其Client。至于Client本身，无需做任何配置，它并不知晓网络中存在RR。</p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/31.png"></p>
<h2 id="路由反射规则"><a href="#路由反射规则" class="headerlink" title="路由反射规则"></a>路由反射规则</h2><p>RR在接收BGP路由时：</p>
<p>▫如果路由反射器从自己的非客户对等体学习到一条IBGP路由，则它会将该路由反射给所有客户</p>
<p>▫如果路由反射器从自己的客户学习到一条IBGP路由，则它会将该路由反射给所有非客户，以及除了该客户之外的其他所有客户</p>
<p>▫如果路由学习自EBGP对等体，则发送给所有客户、非客户IBGP对等体。</p>
<blockquote>
<p>•当路由反射器执行路由反射时，它只将自己使用的、最优的BGP路由进行反射</p>
</blockquote>
<h2 id="反射规则示例-1"><a href="#反射规则示例-1" class="headerlink" title="反射规则示例 (1)"></a>反射规则示例 (1)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/32.png"></p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/33.png"></p>
<h2 id="反射规则示例-2"><a href="#反射规则示例-2" class="headerlink" title="反射规则示例 (2)"></a>反射规则示例 (2)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/34.png"></p>
<p>注意此处“反射”和“发送”的区别。“发送”指的是传统情况下（相当于RR不存在的场景下）的BGP路由传递行为，而“反射”指的是遵循路由反射规则的情况下，RR执行的路由传递动作，被反射出去的路由会被RR插入特殊的路径属性。</p>
<blockquote>
<p>•RR将路由反射时不会修改以下的BGP路径属性：Next_Hop、AS_Path、 Local_Preference、MED，如果反射器修改这几个路径属性的值则有可能产生路由环路。</p>
</blockquote>
<h2 id="RR场景下的路由防环"><a href="#RR场景下的路由防环" class="headerlink" title="RR场景下的路由防环"></a>RR场景下的路由防环</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/35.png"></p>
<p>•RR的设定使得IBGP水平分割原则失效，这就可能导致环路的产生，为此RR会为BGP路由添加两个特殊的路径属性来避免出现环路：</p>
<p>​    ▫Originator_ID</p>
<p>​    ▫Cluster_List</p>
<p>•Originator_ID、Cluster_List属性都属于可选过渡类型。</p>
<h2 id="Originator-ID"><a href="#Originator-ID" class="headerlink" title="Originator ID"></a>Originator ID</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/36.png"></p>
<p>•RR将一条BGP路由进行反射时会在反射出去的路由中增加Originator_ID，其值为本地AS中通告该路由的BGP路由器Router ID。</p>
<p>•若AS内存在多个RR，则Originator_ID属性由第一个RR创建，并且不被后续的RR（若有）所更改。</p>
<p>•当BGP路由器收到一条携带Originator_ID属性的IBGP路由，并且Originator_ID属性值与自身的Router ID相同，则它会忽略关于该条路由的更新。</p>
<h2 id="路由反射簇-Cluster"><a href="#路由反射簇-Cluster" class="headerlink" title="路由反射簇 (Cluster)"></a>路由反射簇 (Cluster)</h2><p>•路由反射簇包括反射器RR及其Client。一个AS内允许存在多个路由反射簇（如下图）。</p>
<p>•每一个簇都有唯一的簇ID（Cluster_ID，缺省时为RR的BGP Router ID ）。</p>
<p>•当一条路由被反射器反射后，该RR（该簇）的Cluster_ID就会被添加至路由的Cluster_list属性中。 </p>
<p>•当RR收到一条携带Cluster_list属性的BGP路由，且该属性值中包含该簇的Cluster_ID时，RR认为该条路由存在环路，因此将忽略关于该条路由的更新。</p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/37.png"></p>
<h2 id="Cluster-List"><a href="#Cluster-List" class="headerlink" title="Cluster_List"></a><strong>Cluster_List</strong></h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/38.png"></p>
<p>•R2发送给R1的路由，经过R1反射给R3时除了添加Originator_ID之外还会添加Cluster_List：10.0.1.1。R3再次反射给R4时， Cluster_List值为：10.0.3.3 10.0.1.1，R4再次反射给R1时Cluster_List值为：10.0.4.4 10.0.3.3 10.0.1.1。</p>
<p>•当R4将路由反射给R1时，R1发现Cluster_List包含了自身Cluster_ID，判断存在环路，从而忽略该路由更新。</p>
<h2 id="RR应用举例"><a href="#RR应用举例" class="headerlink" title="RR应用举例"></a>RR应用举例</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/39.png"></p>
<h2 id="配置介绍"><a href="#配置介绍" class="headerlink" title="配置介绍"></a><strong>配置介绍</strong></h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/40.png"></p>
<h2 id="配置案例-1"><a href="#配置案例-1" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/41.png"></p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/42.png"></p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/43.png"></p>
<h2 id="配置案例-2"><a href="#配置案例-2" class="headerlink" title="配置案例 (2)"></a>配置案例 (2)</h2><p>分别在R3、R1查看BGP路由10.4.4.0/24。</p>
<p><img src="/2021/05/10/BGP%E8%B7%AF%E5%BE%84%E5%B1%9E%E6%80%A7%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%8F%8D%E5%B0%84%E5%99%A8/44.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）AS_Path属性属于哪种类型的BGP属性？(   )</p>
<p>A.可选过渡</p>
<p>B.可选非过渡</p>
<p><strong>C.公认必遵</strong></p>
<p>D.公认任意</p>
<p>2.（简答题）MED值的作用是什么？是否可以跨越AS传递该属性值？</p>
<p><strong>在本AS存在多个入口时通过MED值可影响其他AS选择进入本AS的路径，MED作为可选非过渡属性，不可以跨越AS传递。</strong></p>
<p>3.（简单题）为防止环路产生，路由反射器使用了何种路径属性？</p>
<p><strong>Originator_ID、Cluster_ID</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•BGP在通告路由时会携带丰富的路径属性，这些属性描述了路由的特征，同时在某些场景下也会影响BGP的路由优选。</p>
<p>•BGP的路径属性可以分为公认属性、可选属性。对于公认属性，所有BGP路由器都必须识别；对于可选属性，不需要所有BGP路由器都能识别。</p>
<p>•为解决IBGP水平分割问题可以采用全互联的IBGP连接，但是该方式需要维护大量的IBGP对等体关系，为此可以部署RR来减少IBGP对等体关系的数量。</p>
<p>•RR的设定打破了IBGP水平分割规则，为了防止路由环路产生，BGP增加了Originator_ID、Cluster_ID两个路径属性。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/BGP%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/" itemprop="url">BGP基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-10T17:55:27+08:00">
                2021-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/BGP.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•为方便管理规模不断扩大的网络，网络被分成了不同的AS（Autonomous System，自治系统）。早期，EGP（Exterior Gateway Protocol，外部网关协议）被用于实现在AS之间动态交换路由信息。但是EGP设计得比较简单，只发布网络可达的路由信息，而不对路由信息进行优选，同时也没有考虑环路避免等问题，很快就无法满足网络管理的要求。</p>
<p>•BGP是为取代最初的EGP而设计的另一种外部网关协议。不同于最初的EGP，BGP能够进行路由优选、避免路由环路、更高效率的传递路由和维护大量的路由信息。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述BGP基本概念</p>
<p>▫描述BGP的对等体类型</p>
<p>▫阐明BGP对等体建立过程</p>
<p>▫阐明BGP状态机</p>
<p>▫实现BGP基本配置</p>
<h1 id="BGP概述"><a href="#BGP概述" class="headerlink" title="BGP概述"></a>BGP概述</h1><h2 id="AS"><a href="#AS" class="headerlink" title="AS"></a>AS</h2><p>OSPF、IS-IS等IGP路由协议在组织机构网络内部广泛应用，随着网络规模扩大，网络中路由数量不断增长，IGP已无法管理大规模网络，AS的概念由此诞生。</p>
<p>AS指的是在同一个组织管理下，使用统一选路策略的设备集合。</p>
<p>不同AS通过AS号区分，AS号存在16bit、32bit两种表示方式。IANA负责AS号的分发。</p>
<p>当不同AS之间需要进行通信时，在AS之间应使用何种路由协议进行路由的传递？</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/1.png"></p>
<blockquote>
<p>•IANA（Internet Assigned Numbers Authority，因特网地址分配组织）：IAB（Internet Architecture Board，因特网体系委员会）的下设组织。IANA授权NIC（ Network Information Center，网络信息中心）和其他组织负责IP地址和域名分配，同时，IANA负责维护TCP/IP协议族所采用的协议标识符数据库，包括自治系统号。</p>
<p>•在长度为16bit的AS号表示方式中：64512-65534为私有AS号，在长度为32bit的AS号表示方式中：4200000000-4294967294为私有AS号。</p>
</blockquote>
<h2 id="使用IGP传递路由"><a href="#使用IGP传递路由" class="headerlink" title="使用IGP传递路由"></a>使用IGP传递路由</h2><p>•AS之间需要直连链路，或通过VPN协议构造逻辑直连（例如GRE Tunnel）进行邻居建立。</p>
<p>•AS之间可能是不同的机构、公司，相互之间无法完全信任，使用IGP可能存在暴露AS内部的网络信息的风险。</p>
<p>•整个网络规模扩大，路由数量进一步增加，路由表规模变大，路由收敛变慢，设备性能消耗加大。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/2.png"></p>
<blockquote>
<p>•VPN（virtual private network，虚拟专用网）：使用虚拟专业网络技术可以从逻辑上建立一个直接连接的网络。</p>
</blockquote>
<h2 id="使用BGP传递路由"><a href="#使用BGP传递路由" class="headerlink" title="使用BGP传递路由"></a>使用BGP传递路由</h2><p>为此在AS之间专门使用BGP（Border Gateway Protocol，边界网关协议）协议进行路由传递，相较于传统的IGP协议：</p>
<ul>
<li><p>BGP基于TCP，只要能够建立TCP连接即可建立BGP。</p>
</li>
<li><p>只传递路由信息，不会暴露AS内的拓扑信息。</p>
</li>
<li><p>触发式更新，而不是进行周期性更新。</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/3.png"></p>
<h2 id="BGP发展历史"><a href="#BGP发展历史" class="headerlink" title="BGP发展历史"></a>BGP发展历史</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/4.png"></p>
<blockquote>
<p>•目前关于BGP-4最新的RFC是4271，相比较于RFC1771，对于一些细节进行了进一步说明，如事件、状态机以及BGP路由决策流程等。</p>
</blockquote>
<h2 id="BGP在企业中的应用"><a href="#BGP在企业中的应用" class="headerlink" title="BGP在企业中的应用"></a>BGP在企业中的应用</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/5.png"></p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/6.png"></p>
<h1 id="BGP的基本概念"><a href="#BGP的基本概念" class="headerlink" title="BGP的基本概念"></a>BGP的基本概念</h1><h2 id="BGP概述-1"><a href="#BGP概述-1" class="headerlink" title="BGP概述"></a>BGP概述</h2><p>•BGP是一种实现自治系统AS之间的路由可达，并选择最佳路由的矢量性协议。早期发布的三个版本分别是BGP-1（RFC1105）、BGP-2（RFC1163）和BGP-3（RFC1267），1994年开始使用BGP-4（RFC1771），2006年之后单播IPv4网络使用的版本是BGP-4（RFC4271），其他网络（如IPv6等）使用的版本是MP-BGP（RFC4760）。 </p>
<p>•BGP的特点：</p>
<ul>
<li>BGP使用TCP作为其传输层协议（端口号为179），使用触发式路由更新，而不是周期性路由更新。</li>
<li>BGP能够承载大批量的路由信息，能够支撑大规模网络。</li>
<li>BGP提供了丰富的路由策略，能够灵活的进行路由选路，并能指导对等体按策略发布路由。</li>
<li>BGP能够支撑MPLS/VPN的应用，传递客户VPN路由。</li>
<li>BGP提供了路由聚合和路由衰减功能用于防止路由振荡，通过这两项功能有效地提高了网络稳定性。</li>
</ul>
<h2 id="BGP特征-1"><a href="#BGP特征-1" class="headerlink" title="BGP特征 (1)"></a>BGP特征 (1)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/7.png"></p>
<p>•BGP使用TCP为传输层协议，TCP端口号179。路由器之间的BGP会话基于TCP连接而建立。</p>
<p>•运行BGP的路由器被称为BGP发言者（BGP Speaker），或BGP路由器。</p>
<p>•两个建立BGP会话的路由器互为对等体（Peer），BGP对等体之间交换BGP路由表。</p>
<p>•BGP路由器只发送增量的BGP路由更新，或进行触发式更新（不会周期性更新）。</p>
<p>•BGP能够承载大批量的路由前缀，可在大规模网络中应用。</p>
<h2 id="BGP特征-2"><a href="#BGP特征-2" class="headerlink" title="BGP特征 (2)"></a>BGP特征 (2)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/8.png"></p>
<p>•BGP通常被称为路径矢量路由协议（Path-Vector Routing Protocol）。</p>
<p>•每条BGP路由都携带多种路径属性（Path attribute），BGP可以通过这些路径属性控制路径选择，而不像IS-IS、OSPF只能通过Cost控制路径选择，因此在路径选择上，BGP具有丰富的可操作性，可以在不同场景下选择最合适的路径控制方式。</p>
<h2 id="BGP对等体关系"><a href="#BGP对等体关系" class="headerlink" title="BGP对等体关系"></a>BGP对等体关系</h2><p>•与OSPF、IS-IS等协议不同，BGP的会话是基于TCP建立的。建立BGP对等体关系的两台路由器并不要求必须直连。</p>
<p>•BGP存在两种对等体关系类型：EBGP及IBGP：</p>
<ul>
<li><p>EBGP（External BGP）：位于不同自治系统的BGP路由器之间的BGP对等体关系。两台路由器之间要建立EBGP对等体关系，必须满足两个条件：</p>
<ul>
<li>两个路由器所属AS不同（即AS号不同）。</li>
<li>在配置EBGP时，Peer命令所指定的对等体IP地址要求路由可达，并且TCP连接能够正确建立。</li>
</ul>
</li>
<li><p>IBGP（Internal BGP）：位于相同自治系统的BGP路由器之间的BGP邻接关系。</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/9.png"></p>
<h2 id="BGP对等体关系建立-1"><a href="#BGP对等体关系建立-1" class="headerlink" title="BGP对等体关系建立 (1)"></a>BGP对等体关系建立 (1)</h2><p>先启动BGP的一端先发起TCP连接，如左图所示，R1先启动BGP，R1使用随机端口号向R2的179端口发起TCP连接，完成TCP连接的建立。</p>
<p>三次握手建立完成之后，R1、R2之间相互发送Open报文，携带参数用于对等体建立，参数协商正常之后双方相互发送Keepalive报文，收到对端发送的Keepalive报文之后对等体建立成功，同时双方定期发送Keepalive报文用于保持连接。</p>
<p>其中Open报文中携带：</p>
<ul>
<li><p>My Autonomous System：自身AS号</p>
</li>
<li><p>Hold Time：用于协商后续Keepalive报文发送时间</p>
</li>
<li><p>BGP Identifier：自身Router ID</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/10.png"></p>
<blockquote>
<p>•BGP建立对等体的对等体都会发起TCP三次握手，所以会建立两个TCP连接，但是实际BGP只会保留其中一个TCP连接，从Open报文中获取对端BGP Identifier之后BGP对等体会比较本端的Router ID和对端的Router ID大小，如果本端Router ID小于对端Router ID，则会关闭本地建立的TCP连接，使用由对端主动发起创建的TCP连接进行后续的BGP报文交互。</p>
</blockquote>
<h2 id="BGP对等体关系建立-2"><a href="#BGP对等体关系建立-2" class="headerlink" title="BGP对等体关系建立 (2)"></a>BGP对等体关系建立 (2)</h2><p>BGP对等体关系建立之后，BGP路由器发送BGP Update（更新）报文通告路由到对等体。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/11.png"></p>
<h2 id="TCP连接源地址"><a href="#TCP连接源地址" class="headerlink" title="TCP连接源地址"></a>TCP连接源地址</h2><p>缺省情况下，BGP使用报文出接口作为TCP连接的本地接口。</p>
<p>在部署IBGP对等体关系时，建议使用Loopback地址作为更新源地址。Loopback接口非常稳定，而且可以借助AS内的IGP和冗余拓扑来保证可靠性。</p>
<p>在部署EBGP对等体关系时，通常使用直连接口的IP地址作为源地址，如若使用Loopback接口建立EBGP对等体关系，则应注意EBGP多跳问题。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/12.png"></p>
<h2 id="BGP报文类型-1"><a href="#BGP报文类型-1" class="headerlink" title="BGP报文类型 (1)"></a>BGP报文类型 (1)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/13.png"></p>
<p>BGP存在5种类型的报文，不同类型的报文拥有相同的头部（header）。</p>
<blockquote>
<p>•不同于常见的IGP协议，BGP使用TCP作为传输层协议，端口号179，这使得BGP支持在非直连的路由器之间建立对等体关系。</p>
</blockquote>
<h2 id="BGP报文类型-2"><a href="#BGP报文类型-2" class="headerlink" title="BGP报文类型 (2)"></a>BGP报文类型 (2)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/14.png"></p>
<h2 id="BGP报文格式-报文头格式"><a href="#BGP报文格式-报文头格式" class="headerlink" title="BGP报文格式 - 报文头格式"></a>BGP报文格式 - 报文头格式</h2><p>BGP五种报文都拥有相同的报文头，格式如左侧所示，主要字段解释如下：</p>
<ul>
<li>pMarker：16Byte，用于标明BGP报文边界，所有bit均为“1”。</li>
<li>pLength：2Byte，BGP报文总长度（包括报文头在内），以Byte为单位。</li>
<li>pType：1Byte，BGP报文的类型。其取值从1到5，分别表示Open、Update、Notification、Keepalive和Route-refresh 报文。</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/15.png"></p>
<h2 id="BGP报文格式-Open"><a href="#BGP报文格式-Open" class="headerlink" title="BGP报文格式 - Open"></a>BGP报文格式 - Open</h2><p>Open报文是TCP连接建立之后发送的第一个报文，用于建立BGP对等体之间的连接关系，报文格式如左侧所示，主要字段解释如下：</p>
<ul>
<li><p>pVersion：BGP的版本号。对于BGP 4来说，其值为4。</p>
</li>
<li><p>pMy AS（autonomous system）：本地AS号。通过比较两端的AS号可以判断对端是否和本端处于相同AS。</p>
</li>
<li><p>pHold Time：保持时间。在建立对等体关系时两端要协商Hold Time，并保持一致。如果在这个时间内未收到对端发来的Keepalive报文或Update报文，则认为BGP连接中断。</p>
</li>
<li><p>pBGP Identifier：BGP标识符，以IP地址的形式表示，用来识别BGP路由器。</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/16.png"></p>
<blockquote>
<p>•Opt Parm Len：Optional parameters的长度。</p>
<p>•Optional parameters：宣告自身对于一些可选功能的支持，比如认证、多协议支持。</p>
<p>•除了IPv4单播路由信息，BGP4+还支持多种网络层协议（如IPv6、组播），在协商时BGP对等体之间会通过Optional parameters字段协商对网络层协议的支持能力。</p>
</blockquote>
<h3 id="Open协商成功条件"><a href="#Open协商成功条件" class="headerlink" title="Open协商成功条件"></a>Open协商成功条件</h3><ol>
<li>版本不一致</li>
<li>tcp 179 被过滤</li>
<li>IBGP AS相同 EBGP AS不相同</li>
<li>EBGP检测多跳</li>
<li>认证</li>
<li>Router id 不能冲突</li>
<li>peer 地址必须可达</li>
</ol>
<h2 id="BGP报文格式-Update"><a href="#BGP报文格式-Update" class="headerlink" title="BGP报文格式 - Update"></a>BGP报文格式 - Update</h2><p>•Update报文用于在对等体之间传递路由信息，可以用于发布、撤销路由。</p>
<p>•一个Update报文可以通告具有相同路径属性的多条路由，这些路由保存在NLRI（Network Layer Reachable Information，网络层可达信息）中。同时Update还可以携带多条不可达路由，用于告知对方撤销路由，这些保存在Withdrawn Routes字段中。</p>
<p>•报文格式如左侧所示，主要字段解释如下：</p>
<ul>
<li><p>Withdrawn routes：不可达路由的列表。</p>
</li>
<li><p>Path attributes：与NLRI相关的所有路径属性列表，每个路径属性由一个TLV（Type-Length-Value）三元组构成。</p>
</li>
<li><p>NLRI：可达路由的前缀和前缀长度二元组。</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/17.png"></p>
<blockquote>
<p>•Unfeasible routes length：不可达路由字段的长度，以Byte为单位。如果为0则说明没有Withdrawn Routes 字段。</p>
<p>•Withdrawn Routes Length：标明Withdrawn Routes部分的长度。其值为零时，表示没有撤销的路由。</p>
<p>•Total path attribute length：路径属性字段的长度，以Byte为单位。如果为0则说明没有Path Attributes 字段。</p>
</blockquote>
<h2 id="BGP报文格式-Notification"><a href="#BGP报文格式-Notification" class="headerlink" title="BGP报文格式 - Notification"></a>BGP报文格式 - Notification</h2><p>当BGP检测到错误状态时（对等体关系建立时、建立之后都可能发生），就会向对等体发送Notification，告知对端错误原因。之后BGP连接将会立即中断。</p>
<ul>
<li><p>pError Code、Error subcode：差错码、差错子码，用于告知对端具体的错误类型。</p>
</li>
<li><p>pData：用于辅助描述详细的错误内容，长度并不固定。</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/18.png"></p>
<h2 id="BGP报文格式-Keepalive"><a href="#BGP报文格式-Keepalive" class="headerlink" title="BGP报文格式 - Keepalive"></a>BGP报文格式 - Keepalive</h2><p>•BGP路由器收到对端发送的Keepalive报文，将对等体状态置为已建立，同时后续定期发送keepalive报文用于保持连接。</p>
<p>•Keepalive报文格式中只包含报文头，没有附加其他任何字段。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/19.png"></p>
<h2 id="BGP报文格式-Route-refresh"><a href="#BGP报文格式-Route-refresh" class="headerlink" title="BGP报文格式 - Route-refresh"></a>BGP报文格式 - Route-refresh</h2><p>•Route-refresh报文用来要求对等体重新发送指定地址族的路由信息，一般为本端修改了相关路由策略之后让对方重新发送Update报文，本端执行新的路由策略重新计算BGP路由。</p>
<p>•相关字段内容如下：</p>
<ul>
<li><p>pAFI：Address Family Identifier，地址族标识，如IPv4。</p>
</li>
<li><p>pRes.：保留，8个bit必须置0。</p>
</li>
<li><p>pSAFI：Subsequent Address Family Identifier，子地址族标识。</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/20.png"></p>
<blockquote>
<p>•在Open报文协商时会协商是否支持Route-refresh，如果对等体支持Route-refresh能力，则可以通过<strong>refresh</strong> <strong>bgp</strong>命令手工对BGP连接进行软复位，BGP软复位可以在不中断BGP连接的情况下重新刷新BGP路由表，并应用新的策略。</p>
<p>•对于不支持Route-Refresh能力的BGP对等体，可以配置<strong>keep-all-routes</strong>命令，保留该对等体的所有原始路由，这样不需要复位BGP连接即可完成路由表的刷新。</p>
<p>•缺省情况下未开启<strong>keep-all-routes</strong>。</p>
</blockquote>
<h2 id="BGP状态机-1"><a href="#BGP状态机-1" class="headerlink" title="BGP状态机 (1)"></a>BGP状态机 (1)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/21.png"></p>
<h2 id="BGP状态机-2"><a href="#BGP状态机-2" class="headerlink" title="BGP状态机 (2)"></a>BGP状态机 (2)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/22.png"></p>
<blockquote>
<p>•Idle状态是BGP初始状态。在Idle状态下，BGP拒绝对等体发送的连接请求。只有在收到本设备的Start事件后，BGP才开始尝试和其它BGP对等体进行TCP连接，并转至Connect状态。</p>
<ul>
<li>Start事件是由一个操作者配置一个BGP过程，或者重置一个已经存在的过程或者路由器软件重置BGP过程引起的。</li>
<li>任何状态中收到Notification报文或TCP拆链通知等Error事件后，BGP都会转至Idle状态。</li>
</ul>
<p>•在Connect状态下，BGP启动连接重传定时器（Connect Retry），等待TCP完成连接。</p>
<ul>
<li>如果TCP连接成功，那么BGP向对等体发送Open报文，并转至OpenSent状态。</li>
<li>如果TCP连接失败，那么BGP转至Active状态。</li>
<li>如果连接重传定时器超时，BGP仍没有收到BGP对等体的响应，那么BGP继续尝试和其它BGP对等体进行TCP连接，停留在Connect状态。</li>
</ul>
<p>•在Active状态下，BGP总是在试图建立TCP连接。</p>
<ul>
<li>如果TCP连接成功，那么BGP向对等体发送Open报文，关闭连接重传定时器，并转至OpenSent状态。</li>
<li>如果TCP连接失败，那么BGP停留在Active状态。</li>
<li>如果连接重传定时器超时，BGP仍没有收到BGP对等体的响应，那么BGP转至Connect状态。</li>
</ul>
<p>•在OpenSent状态下，BGP等待对等体的Open报文，并对收到的Open报文中的AS号、版本号、认证码等进行检查。</p>
<ul>
<li><p>如果收到的Open报文正确，那么BGP发送Keepalive报文，并转至OpenConfirm状态。</p>
</li>
<li><p>如果发现收到的Open报文有错误，那么BGP发送Notification报文给对等体，并转至Idle状态。</p>
</li>
</ul>
<p>•在OpenConfirm状态下，BGP等待Keepalive或Notification报文。如果收到Keepalive报文，则转至Established状态，如果收到Notification报文，则转至Idle状态。</p>
<p>•在Established状态下，BGP可以和对等体交换Update、Keepalive、Route-refresh报文和Notification报文。</p>
<ul>
<li><p>如果收到正确的Update或Keepalive报文，那么BGP就认为对端处于正常运行状态，将保持BGP连接。</p>
</li>
<li><p>如果收到错误的Update或Keepalive报文，那么BGP发送Notification报文通知对端，并转至Idle状态。</p>
</li>
<li><p>Route-refresh报文不会改变BGP状态。</p>
</li>
<li><p>如果收到Notification报文，那么BGP转至Idle状态。</p>
</li>
<li><p>如果收到TCP拆链通知，那么BGP断开连接，转至Idle状态。</p>
</li>
</ul>
</blockquote>
<h2 id="BGP状态机详解-1"><a href="#BGP状态机详解-1" class="headerlink" title="BGP状态机详解 (1)"></a>BGP状态机详解 (1)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/23.png"></p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/24.png"></p>
<h2 id="BGP状态机详解-2"><a href="#BGP状态机详解-2" class="headerlink" title="BGP状态机详解 (2)"></a>BGP状态机详解 (2)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/25.png"></p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/26.png"></p>
<h2 id="BGP对等体表"><a href="#BGP对等体表" class="headerlink" title="BGP对等体表"></a>BGP对等体表</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/27.png"></p>
<p>•在设备上通过<strong>display</strong> <strong>bgp</strong> <strong>peer</strong>命令查看BGP对等体表，其中主要参数含义：</p>
<ul>
<li><p>Peer：对等体地址</p>
</li>
<li><p>V：version，版本号</p>
</li>
<li><p>AS：对等体AS号</p>
</li>
<li><p>Up/Down：该对等体已经存在up或者down的时间</p>
</li>
<li><p>State：对等体状态，这里显示的为BGP状态机的状态</p>
</li>
<li><p>PrefRcv：prefix received，从该对等体收到的路由前缀数目</p>
</li>
</ul>
<blockquote>
<p>•BGP对等体表的作用为列出本设备的BGP对等体，以及对等体的状态等信息。</p>
<p>•MsgRcvd 、MsgSent：从对等体收到的报文个数，向对等体发送的报文个数。</p>
<p>•OutQ：out queue，对外发送报文队列中排队的个数，一般为0。</p>
</blockquote>
<h2 id="BGP路由表-1"><a href="#BGP路由表-1" class="headerlink" title="BGP路由表 (1)"></a>BGP路由表 (1)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/28.png"></p>
<p>•在设备上通过<strong>display bgp routing-table</strong>查看BGP路由表：</p>
<ul>
<li><p>Network：路由的目的网络地址以及网络掩码</p>
</li>
<li><p>NextHop：下一跳地址</p>
</li>
</ul>
<p>•如果想要查看某条路由更加详细的信息，可以通过<strong>display</strong> <strong>bgp</strong> <strong>routing-table</strong> <em>ipv4-address { mask |</em> <em>mask-length}</em> 查看，该命令会将匹配的BGP路由信息详细展示。</p>
<blockquote>
<p>•列出本设备发现的所有BGP路由，如果到达同一个目的地存在多条路由，则将路由都进行罗列，但每个目的地只会优选一条路由。</p>
</blockquote>
<h2 id="BGP路由表-2"><a href="#BGP路由表-2" class="headerlink" title="BGP路由表 (2)"></a>BGP路由表 (2)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/29.png"></p>
<blockquote>
<p>•通过<strong>display</strong> <strong>bgp</strong> <strong>routing-table</strong> <em>ipv4-address { mask | mask-length }</em> 可以显示指定IP地址/掩码长度的路由信息，在其中有关于该BGP路由的详细信息，如：路由始发者、下一跳地址、路由的路径属性等。</p>
</blockquote>
<h2 id="BGP路由的生成"><a href="#BGP路由的生成" class="headerlink" title="BGP路由的生成"></a>BGP路由的生成</h2><p>•不同于IGP路由协议，BGP自身并不会发现并计算产生路由，BGP将IGP路由表中的路由注入到BGP路由表中，并通过Update报文传递给BGP对等体。</p>
<p>•BGP注入路由的方式有两种：</p>
<ul>
<li><p>Network</p>
</li>
<li><p>import-route</p>
</li>
</ul>
<p>•与IGP协议相同，BGP支持根据已有的路由条目进行聚合，生成聚合路由。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/30.png"></p>
<h2 id="Network注入路由-1"><a href="#Network注入路由-1" class="headerlink" title="Network注入路由 (1)"></a>Network注入路由 (1)</h2><p>通过Network方式注入路由：</p>
<p><strong>1.AS200内的BGP路由器已经通过IGP协议OSPF学习到了两条路由：10.1.0.0/24和10.2.0.0/24，在BGP进程内通过network命令注入这两条路由，这两条路由将会出现在本地的BGP路由表中。</strong></p>
<p><em>2.AS200内的BGP路由器通过Update报文将路由传递给AS300内的BGP路由器。</em></p>
<p><em>3.AS300内的BGP路由器收到路由后，将这两条路由加入到本地的BGP路由表中。</em></p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/31.png"></p>
<blockquote>
<p>•Network方式注入的路由必须是已经存在于IP路由表中的路由条目，否则不会被成功注入到BGP路由表中。</p>
</blockquote>
<h2 id="Network注入路由-2"><a href="#Network注入路由-2" class="headerlink" title="Network注入路由 (2)"></a>Network注入路由 (2)</h2><p>通过Network方式注入路由：</p>
<p><em>1.AS200内的BGP路由器已经通过IGP协议OSPF学习到了两条路由：10.1.0.0/24和10.2.0.0/24，在BGP进程内通过network命令注入这两条路由，这两条路由将会出现在本地的BGP路由表中。</em></p>
<p><strong>2.AS200内的BGP路由器通过Update报文将路由传递给AS300内的BGP路由器。</strong></p>
<p><strong>3.AS300内的BGP路由器收到路由后，将这两条路由加入到本地的BGP路由表中。</strong></p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/32.png"></p>
<h2 id="import-route方式注入路由"><a href="#import-route方式注入路由" class="headerlink" title="import-route方式注入路由"></a>import-route方式注入路由</h2><p>•Network方式注入路由虽然是精确注入，但是只能一条条配置逐条注入IP路由表中的路由，如果注入的路由条目很多配置命令将会非常复杂，为此可以使用import-route方式，将：</p>
<ol>
<li><p>直连路由</p>
</li>
<li><p>静态路由</p>
</li>
<li><p>OSPF路由</p>
</li>
<li><p>IS-IS路由</p>
</li>
</ol>
<p>等协议的路由注入到BGP路由表中。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/33.png"></p>
<h2 id="BGP聚合路由"><a href="#BGP聚合路由" class="headerlink" title="BGP聚合路由"></a>BGP聚合路由</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/34.png"></p>
<p>与众多IGP协议相同，BGP同样支持路由的手工聚合，在BGP配置视图中使用<strong>aggregate</strong>命令可以执行BGP路由手工聚合，在BGP已经学习到相应的明细路由情况下，设备会向BGP注入指定的聚合路由。</p>
<blockquote>
<p>•执行聚合之后，在本地的BGP路由表中除了原本的明细路由条目之外，还会多出一条聚合的路由条目。</p>
<p>•如果在执行聚合时指定了<strong>detail-suppressed</strong>，则BGP只会向对等体通告聚合后的路由，而不通告聚合前的明细路由。</p>
<p>•在聚合时配置了抑制明细路由的参数，R3上查看路由表，将只能看到BGP路由：10.1.0.0/22，无法看到聚合前的明细路由。</p>
</blockquote>
<h2 id="通告原则"><a href="#通告原则" class="headerlink" title="通告原则"></a>通告原则</h2><p>•BGP通过network、import-route、aggregate聚合方式生成BGP路由后，通过Update报文将BGP路由传递给对等体。</p>
<p>•BGP通告遵循以下原则：</p>
<ul>
<li><p>只发布最优且有效路由。</p>
</li>
<li><p>从EBGP对等体获取的路由，会发布给所有对等体。</p>
</li>
<li><p>IBGP水平分割：从IBGP对等体获取的路由，不会发送给IBGP对等体。</p>
</li>
<li><p>BGP同步规则指的是：当一台路由器从自己的IBGP对等体学习到一条BGP路由时（这类路由被称为IBGP路由），它将不能使用该条路由或把这条路由通告给自己的EBGP对等体，除非它又从IGP协议（例如OSPF等，此处也包含静态路由）学习到这条路由，也就是要求IBGP路由与IGP路由同步。同步规则主要用于规避BGP路由黑洞问题。</p>
</li>
</ul>
<h3 id="BGP路由通告原则一"><a href="#BGP路由通告原则一" class="headerlink" title="BGP路由通告原则一"></a>BGP路由通告原则一</h3><p>•第一条原则：只发布最优且有效（即下一跳地址可达）路由。</p>
<p>•通过<strong>display</strong> <strong>bgp</strong> <strong>routing-table</strong>命令可以查看BGP路由表。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/35.png"></p>
<p>•在BGP路由表中同时存在以下两个标志的路由为最优、有效：</p>
<ul>
<li><p>* : 代表有效</p>
</li>
<li><p>&gt; : 代表最优</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/36.png"></p>
<h3 id="BGP路由通告原则二"><a href="#BGP路由通告原则二" class="headerlink" title="BGP路由通告原则二"></a>BGP路由通告原则二</h3><p>第二条原则：从EBGP对等体获取的路由，会发布给所有对等体。</p>
<p>R2从EBGP对等体获取的BGP路由，会发布给所有EBGP、IBGP对等体。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/37.png"></p>
<h3 id="BGP路由通告原则三-1"><a href="#BGP路由通告原则三-1" class="headerlink" title="BGP路由通告原则三 (1)"></a>BGP路由通告原则三 (1)</h3><p>•第三条原则：从IBGP对等体获取的BGP路由，不会再发送给其他IBGP对等体。</p>
<p>•该条原则也被称为“IBGP水平分割”。</p>
<p>•如图所示，如果IBGP对等体学习到的路由会继续传递给其他的IBGP对等体：</p>
<ul>
<li><p>R2将一条路由传递给了IBGP对等体R3</p>
</li>
<li><p>R3收到路由之后传递给IBGP对等体R1</p>
</li>
<li><p>R1继续传递给IBGP对等体R2</p>
<p>路由环路形成。</p>
</li>
</ul>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/38.png"></p>
<h3 id="BGP路由通告原则三-2"><a href="#BGP路由通告原则三-2" class="headerlink" title="BGP路由通告原则三 (2)"></a>BGP路由通告原则三 (2)</h3><p>•第三条原则可能会带来新的问题，如左侧所示，当BGP路由器R2将路由传递给BGP路由器R1时，由于第三条原则限制，R1无法将BGP路由传递给R3，R3将无法学习到路由。</p>
<p>•为解决该问题可以采用AS内IBGP全互联的方式，即：R2、R3之间建立非直连的IBGP对等体关系，以此让BGP路由器R2将路由传递给BGP路由器 R3。</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/39.png"></p>
<h3 id="BGP路由通告原则四-1"><a href="#BGP路由通告原则四-1" class="headerlink" title="BGP路由通告原则四 (1)"></a>BGP路由通告原则四 (1)</h3><p>•第四条原则：当一台路由器从自己的IBGP对等体学习到一条BGP路由时（这类路由被称为IBGP路由），它将不能使用该条路由或把这条路由通告给自己的EBGP对等体，除非它又从IGP协议（例如OSPF等，此处也包含静态路由）学习到这条路由，该条规则也被称为BGP同步原则。</p>
<p>•如图所示：</p>
<ol>
<li><p>BGP路由器R4上存在一条路由10.0.4.0/24，R4将其传递给了R2。</p>
</li>
<li><p>R2将路由传递给非直连IBGP对等体R3。</p>
</li>
<li><p>R3将路由传递给R5。</p>
</li>
<li><p>之后R5向10.0.4.4发起访问。</p>
</li>
</ol>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/40.png"></p>
<h3 id="BGP路由通告原则四-2"><a href="#BGP路由通告原则四-2" class="headerlink" title="BGP路由通告原则四 (2)"></a>BGP路由通告原则四 (2)</h3><p>•R5访问10.0.4.4：</p>
<ol>
<li><p>R5查找路由表，将报文发送给R3。</p>
</li>
<li><p>R3收到报文后查找路由表，匹配到一条BGP路由，其下一跳为R2，但是R2为非直连下一跳，需要进行路由迭代，通过IGP学习到的路由迭代出下一跳为R1。R3将报文发送给R1。</p>
</li>
<li><p>R1收到报文后查找路由表，因为R1并非BGP路由器，未与R2建立IBGP对等体关系，因此R1上并无BGP路由10.0.4.0/24，路由查找失败，R1将报文丢弃。</p>
</li>
</ol>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/41.png"></p>
<blockquote>
<p>•产生该问题根本原因为AS200域内未运行BGP的路由器并无从BGP学习到的路由条目，查找路由失败，导致R1丢弃报文。为此制定了BGP同步原则：</p>
<p>当BGP的路由条目也存在于IGP路由表时才对外发送，以图中场景为例，当R3查看IGP路由表，OSPF路由表中并无路由10.0.4.0/24，因此并不会向R5发送该路由，自然也不会产生后续的访问失败问题。</p>
<p>•解决该问题的方式有：</p>
<ul>
<li>将BGP路由重分发到IGP中，基本不会使用该方式。</li>
<li>建立全互联的IBGP对等体关系，让全网所有路由器都拥有BGP路由。</li>
</ul>
</blockquote>
<h1 id="BGP的基本配置"><a href="#BGP的基本配置" class="headerlink" title="BGP的基本配置"></a>BGP的基本配置</h1><h2 id="配置介绍"><a href="#配置介绍" class="headerlink" title="配置介绍"></a>配置介绍</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/42.png"></p>
<blockquote>
<p>•如果没有配置Router ID，则BGP会自动选取系统视图下的Router ID作为BGP协议的Router ID。系统视图下的Router ID选择规则，请参见命令router-id中的描述。</p>
</blockquote>
<h2 id="配置案例-1"><a href="#配置案例-1" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/43.png"></p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/44.png"></p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/45.png"></p>
<h2 id="配置案例-2"><a href="#配置案例-2" class="headerlink" title="配置案例 (2)"></a>配置案例 (2)</h2><p>在R3上查看BGP对等体状态：</p>
<p><img src="/2021/05/10/BGP%E5%9F%BA%E7%A1%80/46.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）BGP使用的TCP目的端口号是多少？</p>
<p><strong>179</strong></p>
<p>2.（简答题）BGP对等体关系有哪几种？划分的依据是什么？</p>
<p><strong>IBGP、EBGP对等体关系，对等体是否和自身处于一个AS内。</strong></p>
<p>3.（多选题）BGP对等体关系建立、更新路由分别使用（  ）、（  ）报文。</p>
<p>A.Route-refresh</p>
<p><strong>B.Open</strong></p>
<p>C.Notification</p>
<p><strong>D.Update</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本章节介绍了BGP基础知识，涵盖了：BGP产生的背景、AS的概念、BGP的特征等。</p>
<p>•本章节中我们详细地学习了BGP的对等体关系建立过程以及BGP状态机，学习时将对等体关系建立过程与状态机的转换相结合有助于理解记忆。</p>
<p>• 不同于IGP路由协议，BGP不能自己发现、计算路由条目，其路由条目由IGP协议路由表中的路由发布得到。</p>
<p>•BGP在进行路由通告时遵循四条原则，这些原则对BGP路由传递进行了限制。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/IS-IS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/10/IS-IS/" itemprop="url">IS-IS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-10T16:36:30+08:00">
                2021-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/10/IS-IS/IS-IS.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•IS-IS（Intermediate System to Intermediate System，中间系统到中间系统）是ISO （International Organization for Standardization，国际标准化组织）为它的CLNP（ConnectionLessNetwork Protocol，无连接网络协议）设计的一种动态路由协议。</p>
<p>•随着TCP/IP协议的流行，为了提供对IP路由的支持，IETF在RFC1195中对IS-IS进行了扩充和修改，使它能够同时应用在TCP/IP和OSI（Open System Interconnect，开放式系统互联）环境中，我们将扩展后的IS-IS称为集成IS-IS。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述IS-IS的基本概念</p>
<p>▫描述IS-IS的工作原理</p>
<p>▫描述IS-IS与OSPF的差异</p>
<p>▫实现IS-IS的常用配置</p>
<h1 id="IS-IS的基本概念"><a href="#IS-IS的基本概念" class="headerlink" title="IS-IS的基本概念"></a>IS-IS的基本概念</h1><h2 id="IS-IS概述"><a href="#IS-IS概述" class="headerlink" title="IS-IS概述"></a>IS-IS概述</h2><p>IS-IS是ISO定义的OSI协议栈中的CLNS（ConnectionLess Network Service，无连接网络服务）的一部分。</p>
<p><img src="/2021/05/10/IS-IS/1.png"></p>
<blockquote>
<p>•IS-IS是一种链路状态路由协议，IS-IS与OSPF在许多方面非常相似，例如运行IS-IS协议的直连设备之间通过发送Hello报文发现彼此，然后建立邻接关系，并交互链路状态信息。</p>
<p>•CLNS由以下三个部分组成：</p>
<p>​    ▫CLNP：类似于TCP/IP中的IP协议。</p>
<p>​    ▫IS-IS：类似于TCP/IP中的OSPF。</p>
<p>​    ▫ES-IS：类似于TCP/IP中的ARP，ICMP等。</p>
<p>•ES：End System，终端系统，类似于IP网络环境中的主机。</p>
<p>•ES-IS：End System to Intermediate System，终端系统到中间系统。</p>
<p>•IP网络环境中不涉及CLNP以及ES-IS，因此本课程不做详细介绍。</p>
</blockquote>
<h2 id="NSAP"><a href="#NSAP" class="headerlink" title="NSAP"></a>NSAP</h2><p>•NSAP（Network Service Access Point，网络服务访问点）是OSI协议栈中用于定位资源的地址，主要用于提供网络层和上层应用之间的接口。NSAP包括IDP及DSP，如下图所示：</p>
<p><img src="/2021/05/10/IS-IS/2.png"></p>
<p>•IDP（Initial Domian Part）相当于IP地址中的主网络号。它是由ISO规定，并由AFI（Authority and Format Identifier）与IDI（Initial Domain Identifier）两部分组成。AFI表示地址分配机构和地址格式，IDI用来标识域。</p>
<p>•DSP（Domian Specific Part）相当于IP地址中的子网号和主机地址。它由High Order DSP、System ID和SEL三个部分组成。High Order DSP用来分割区域，System ID用来区分主机，SEL（NSAP Selector）用来指示服务类型。</p>
<h2 id="NET"><a href="#NET" class="headerlink" title="NET"></a>NET</h2><p>•NET（Network Entity Title，网络实体名称）是OSI协议栈中设备的网络层信息，主要用于路由计算，由区域地址（Area ID）和System ID组成，可以看作是特殊的NSAP（SEL为00的NSAP）。</p>
<p>•NET的长度与NSAP的相同，最长为20Byte，最短为8Byte。</p>
<p>•在IP网络中运行IS-IS时，只需配置NET，根据NET地址设备可以获取到Area ID以及System ID。</p>
<p><img src="/2021/05/10/IS-IS/3.png"></p>
<blockquote>
<p>•Area ID由IDP和DSP中的High Order DSP组成，既能够标识路由域，也能够标识路由域中的区域。因此，它们一起被称为区域地址，相当于OSPF中的区域编号。</p>
<p>​    ▫一般情况下，一个路由器只需要配置一个区域地址，且同一区域中所有节点的区域地址都要相同。为了支持区域的平滑合并、分割及转换，缺省情况下，一个IS-IS进程下最多可配置3个区域地址。</p>
<p>•System ID用来在区域内唯一标识主机或路由器。在设备的实现中，它的长度固定为6Byte。</p>
</blockquote>
<h2 id="NET的配置举例"><a href="#NET的配置举例" class="headerlink" title="NET的配置举例"></a>NET的配置举例</h2><p>•每台运行IS-IS的网络设备至少需拥有一个NET，当然，一台设备也可以同时配置多个NET，但是这些NET的System ID必须相同。</p>
<p>•在华为的网络设备上，System ID的长度总是固定的6Byte。在一个IS-IS路由域中，设备的System ID必须唯一，为了便于管理，一般根据Router ID配置System ID。</p>
<p><img src="/2021/05/10/IS-IS/4.png"></p>
<h2 id="IS-IS和OSPF区域划分的区别"><a href="#IS-IS和OSPF区域划分的区别" class="headerlink" title="IS-IS和OSPF区域划分的区别"></a>IS-IS和OSPF区域划分的区别</h2><p>•IS-IS在自治系统内采用骨干区域与非骨干区域两级的分层结构：</p>
<p>​    ▫Level-1路由器部署在非骨干区域。</p>
<p>​    ▫Level-2路由器和Level-1-2路由器部署在骨干区域。</p>
<p>•每一个非骨干区域都通过Level-1-2路由器与骨干区域相连。</p>
<p>如图所示，IS-IS整个骨干区域不仅包括Area49.0002中的所有路由器，还包括其它区域的Level2和Level-1-2路由器。</p>
<p><img src="/2021/05/10/IS-IS/5.png"></p>
<blockquote>
<p>•在学习OSPF过程中，我们已经体会到了多区域、层次化网络设计的好处。对于链路状态路由协议而言，运行了该协议的设备会向网络中通告链路状态信息，同时也收集网络中所泛洪的链路状态信息后加以存储，并最终以这些信息为基础进行计算，从而得到路由信息。如果不采用多区域部署的方式，那么随着网络的规模逐渐增大，网络中泛洪的链路状态信息势必会越来越多，所有设备都将承受更重的负担，路由计算机收敛将逐渐变得更加缓慢，这也使得网络的扩展性变差。</p>
<p>•以上拓扑结构图可以体现IS-IS与OSPF的不同点：</p>
<p>​    ▫在IS-IS中，每个路由器都只属于一个区域；而在OSPF中，一个路由器的不同接口可以属于不同的区域。</p>
<p>​    ▫在IS-IS中，单个区域没有骨干与非骨干区域的概念；而在OSPF中，Area0被定义为骨干区域。</p>
<p>​    ▫在IS-IS中，Level-1和Level-2级别的路由都采用SPF算法，分别生成最短路径树SPT（Shortest Path Tree）；而在OSPF中，只有在同一个区域内才使用SPF算法，区域之间的路由需要通过骨干区域来转发。</p>
</blockquote>
<h2 id="IS-IS路由器的分类-1"><a href="#IS-IS路由器的分类-1" class="headerlink" title="IS-IS路由器的分类 (1)"></a>IS-IS路由器的分类 (1)</h2><p><strong>Level-1路由器</strong></p>
<p>▫Level-1路由器（例如图中的R1）是一种IS-IS区域内部路由器，它只与属于同一区域的Level-1和Level-1-2路由器形成邻接关系，这种邻接关系称为Level-1邻接关系。Level-1路由器无法与Level-2路由器建立邻接关系。</p>
<p>▫Level-1路由器只负责维护Level-1的链路状态数据库LSDB，该LSDB只包含本区域的路由信息。值得一提的是，Level-1路由器必须通过Level-1-2路由器接入IS-IS骨干区域从而访问其他区域。</p>
<p><img src="/2021/05/10/IS-IS/6.png"></p>
<h2 id="IS-IS路由器的分类-2"><a href="#IS-IS路由器的分类-2" class="headerlink" title="IS-IS路由器的分类 (2)"></a>IS-IS路由器的分类 (2)</h2><p><strong>Level-2路由器</strong></p>
<p>▫Level-2路由器（例如图中的R4、R5、R6、R7）是IS-IS骨干路由器，它可以与同一或者不同区域的Level-2路由器或者Level-1-2路由器形成邻接关系。Level-2路由器维护一个Level-2的LSDB，该LSDB包含整个IS-IS域的所有路由信息。</p>
<p>▫所有Level-2级别（即形成Level-2邻接关系）的路由器组成路由域的骨干网，负责在不同区域间通信。路由域中Level-2级别的路由器必须是物理连续的，以保证骨干网的连续性。</p>
<p><img src="/2021/05/10/IS-IS/7.png"></p>
<h2 id="IS-IS路由器的分类-3"><a href="#IS-IS路由器的分类-3" class="headerlink" title="IS-IS路由器的分类 (3)"></a>IS-IS路由器的分类 (3)</h2><p><strong>Level-1-2路由器</strong></p>
<p>▫Level-1-2路由器与OSPF中的ABR非常相似，它也是IS-IS骨干网络的组成部分。</p>
<p>▫Level-1-2路由器维护两个LSDB，Level-1的LSDB用于区域内路由，Level-2的LSDB用于区域间路由。</p>
<p>▫同时属于Level-1和Level-2的路由器称为Level-1-2路由器（例如图中的R2和R3），它可以与同一区域的Level-1和Level-1-2路由器形成Level-1邻接关系，也可以与其他区域的Level-2和Level-1-2路由器形成Level-2的邻接关系。</p>
<p><img src="/2021/05/10/IS-IS/8.png"></p>
<blockquote>
<p>•在华为路由器上配置IS-IS时，缺省时，路由器全局Level为Level-1-2，当然，可以通过命令修改该设备的类型。</p>
</blockquote>
<h2 id="IS-IS支持的网络类型"><a href="#IS-IS支持的网络类型" class="headerlink" title="IS-IS支持的网络类型"></a>IS-IS支持的网络类型</h2><p>IS-IS会自动根据接口的数据链路层封装决定该接口的缺省网络类型， IS-IS支持两种类型的网络：</p>
<p>▫广播（Broadcast）： 如Ethernet。</p>
<p>▫点到点（P2P）： 如PPP、 HDLC等。</p>
<p><img src="/2021/05/10/IS-IS/9.png"></p>
<blockquote>
<p>•对于NBMA网络，需对其配置子接口，并注意子接口类型应配置为P2P。</p>
</blockquote>
<h2 id="IS-IS开销值"><a href="#IS-IS开销值" class="headerlink" title="IS-IS开销值"></a>IS-IS开销值</h2><p>•IS-IS使用Cost（开销）作为路由度量值，Cost值越小，则路径越优。IS-IS链路的Cost与设备的接口有关，与OSPF类似，每一个激活了IS-IS的接口都会维护接口Cost。然而与OSPF不同的是，IS-IS接口的Cost在缺省情况下并不与接口带宽相关（在实际部署时，IS-IS也支持根据带宽调整Cost值），无论接口带宽多大，缺省时Cost为10。</p>
<p>•一条IS-IS路径的Cost等于本路由器到达目标网段沿途的所有链路的Cost总和。</p>
<p>•窄带 接口 1-63 全局 1-2的10次幂-1</p>
<p>•宽带 接口带宽1-2的24次幂-1 全局1-2的32次幂-1</p>
<p>•IS-IS有三种方式来确定接口的开销，按照优先级由高到低分别是：</p>
<p>​    ▫接口开销：为单个接口设置开销。</p>
<p>​    ▫全局开销：为所有接口设置开销。</p>
<p>​    ▫自动计算开销：根据接口带宽自动计算开销。</p>
<p><img src="/2021/05/10/IS-IS/10.png"></p>
<blockquote>
<p>•在早期的ISO10589中，使能IS-IS的接口下最大只能配置值为63的开销值，此时IS-IS的开销类型为narrow。但是在大型网络设计中，较小的度量范围不能满足实际需求。RFC3784中规定，使能IS-IS的接口开销值可以扩展到16777215，此时IS-IS的开销类型为wide。</p>
<p>•缺省时，华为路由器采用的开销类型是narrow。</p>
<p>•narrow类型下使用的TLV：</p>
<p>​    ▫128号TLV（IP Internal Reachability TLV）：用来携带路由域    内的IS-IS路由信息。</p>
<p>​    ▫130号TLV（IP External Reachability TLV）：用来携带路由域    外的IS-IS路由信息。</p>
<p>​    ▫2号TLV(IS Neighbors TLV)：用来携带邻居信息。</p>
<p>•wide类型下使用的TLV：</p>
<p>​    ▫135号TLV(Extended IP Reachability TLV)：用来替换原有的IP     reachability TLV，携带IS-IS路由信息，它扩展了路由开销值的    范围，并可以携带sub TLV。</p>
<p>​    ▫22号TLV（IS Extended Neighbors TLV）：用来携带邻居信息</p>
</blockquote>
<h2 id="IS-IS报文格式"><a href="#IS-IS报文格式" class="headerlink" title="IS-IS报文格式"></a>IS-IS报文格式</h2><p>•IS-IS报文是直接封装在数据链路层的帧结构中的。</p>
<p>•PDU（Protocol Data Unit，协议数据单元）可以分为两个部分，报文头（IS-IS Header）和变长字段部分（Variable Length Fields ）。</p>
<p>•其中IS-IS Header又可分为通用头部（PDU Common Header）和专用头部（PDU Specific Header）。对于所有PDU来说，通用报头都是相同的，但专用报头根据PDU类型不同而有所差别。</p>
<p><img src="/2021/05/10/IS-IS/11.png"></p>
<h2 id="IS-IS通用头部详解"><a href="#IS-IS通用头部详解" class="headerlink" title="IS-IS通用头部详解"></a>IS-IS通用头部详解</h2><p><strong>重要字段解释：</strong></p>
<p>•Intradomain Routing Protocol Discriminator：域内路由选择协议鉴别符，固定为0x83。</p>
<p>•Length Indicator：IS-IS头部的长度（包括通用头部和专用头部），以Byte为单位。</p>
<p>•Version/Protocol ID Extension：版本/协议标识扩展，固定为0x01。</p>
<p>•System ID Length：NSAP地址或NET中System ID区域的长度。值为0时，表示System ID区域的长度为6Byte。</p>
<p>•R（Reserved）：保留，固定为0。</p>
<p>•Version：固定为0x01。</p>
<p>•Max.Areas：支持的最大区域个数。设置为1～254的整数，表示该IS-IS进程实际所允许的最大区域地址数；设置为0，表示该IS-IS进程最大只支持3个区域地址数。</p>
<p><img src="/2021/05/10/IS-IS/12.png"></p>
<h2 id="IS-IS报文类型概述"><a href="#IS-IS报文类型概述" class="headerlink" title="IS-IS报文类型概述"></a>IS-IS报文类型概述</h2><p>•IS-IS的PDU有4种类型：IIH(IS-IS Hello)，LSP（ Link State PDU，链路状态报文），CSNP（Complete Sequence Number PDU，全序列号报文），PSNP（Partial Sequence Number PDU，部分序列号报文）。</p>
<p>•IIH：用于建立和维持邻接关系， 广播网络中的Level-1 IS-IS路由器使用Level-1 LAN IIH； 广播网络中的Level-2 IS-IS路由器使用Level-2 LAN IIH； 点到点网络中则使用P2P IIH。</p>
<p>•LSP：用于交换链路状态信息。LSP分为两种，Level-1 LSP、Level-2 LSP。</p>
<p>•SNP：通过描述全部或部分链路数据库中的LSP来同步各LSDB，从而维护LSDB的完整与同步。SNP包括CSNP和PSNP，进一步又可分为Level-1 CSNP、 Level-2 CSNP、 Level-1 PSNP和Level-2 PSNP。</p>
<p><img src="/2021/05/10/IS-IS/13.png"></p>
<h2 id="IS-IS常见的TLV"><a href="#IS-IS常见的TLV" class="headerlink" title="IS-IS常见的TLV"></a>IS-IS常见的TLV</h2><p>•TLV的含义是：类型（TYPE），长度（LENGTH），值（VALUE）。实际上是一个数据结构，这个结构包含了这三个字段。</p>
<p>•使用TLV结构构建报文的好处是灵活性和扩展性好。采用TLV使得报文的整体结构固定，增加新特性只需要增加新TLV即可，不需要改变整个报文的整体结构。</p>
<p><img src="/2021/05/10/IS-IS/14.png"></p>
<blockquote>
<p>•TLV也称为CLV（Code-Length-Value）。</p>
</blockquote>
<h1 id="IS-IS工作原理"><a href="#IS-IS工作原理" class="headerlink" title="IS-IS工作原理"></a>IS-IS工作原理</h1><h2 id="邻接关系建立"><a href="#邻接关系建立" class="headerlink" title="邻接关系建立"></a>邻接关系建立</h2><h3 id="IS-IS邻接关系建立原则"><a href="#IS-IS邻接关系建立原则" class="headerlink" title="IS-IS邻接关系建立原则"></a>IS-IS邻接关系建立原则</h3><p>•IS-IS按如下原则建立邻接关系：</p>
<p>​    ▫只有同一层次的相邻路由器才有可能成为邻接。</p>
<p>​    ▫对于Level-1路由器来说，Area ID必须一致。</p>
<p>​    ▫链路两端IS-IS接口的网络类型必须一致。</p>
<p>​    ▫链路两端IS-IS接口的地址必须处于同一网段（默认情况下）。</p>
<p>•由于IS-IS是直接运行在数据链路层上的协议，并且最早设计是给CLNP使用的，IS-IS邻接关系的形成与IP地址无关。但在实际的部署中，在IP网络上运行IS-IS时，需要检查对方的IP地址的。如果接口配置了从IP，那么只要双方有某个IP（主IP或者从IP）在同一网段，就能建立邻接，不一定要主IP相同。</p>
<blockquote>
<p>•通过将以太网接口模拟成点到点接口，可以建立点到点链路邻接关系。</p>
<p>•当链路两端IS-IS接口的地址不在同一网段时，如果配置接口对接收的Hello报文不作IP地址检查，也可以建立邻接关系。</p>
<p>​    ▫对于点到点接口，可以配置接口忽略IP地址检查。</p>
<p>​    ▫对于以太网接口，需要将以太网接口模拟成点到点接口，然后    才可以配置接口忽略IP地址检查。</p>
<p>•一般情况下，一个接口只需配置一个主IP地址，但在有些特殊情况下需要配置从IP地址。比如，一台路由器通过一个接口连接了一个物理网络，但该物理网络的计算机分别属于2个不同的网络，为了使路由器与物理网络中的所有计算机通信，就需要在该接口上配置一个主IP地址和一个从IP地址。路由器的每个三层接口可以配置多个IP地址，其中一个为主IP地址，其余为从IP地址，每个三层接口最多可配置31个从IP地址。</p>
</blockquote>
<h3 id="IIH"><a href="#IIH" class="headerlink" title="IIH"></a>IIH</h3><p>IIH报文用于建立和维持邻接关系，广播网络中的Level-1 IS-IS路由器使用Level-1 LAN IIH；广播网络中的Level-2 IS-IS路由器使用Level-2 LAN IIH；点到点网络中则使用P2P IIH。</p>
<p><strong>Reserved/Circuit</strong> <strong>Type</strong>：表示路由器的类型（01表示L1，10表示L2，11表示L1/L2）。 </p>
<p>Source ID ：发出Hello报文的路由器的System ID。 </p>
<p><strong>Holding Time</strong> ： 保持时间。在此时间内如果没有收到邻接发来的Hello报文，则中止已建立的邻接关系。 </p>
<p><strong>Priority</strong> <strong>：</strong>选举DIS的优先级，取值范围为0～127。数值越大，优先级越高。该字段只在广播网中的Hello消息(LAN IIH消息)携带；点到点网络的Hello消息(P2P IIH消息)没有此字段，也没有此字段之前的R保留位。 </p>
<p><strong>LAN ID</strong> <strong>：</strong> 包括DIS的System ID和伪节点ID。该字段只在广播网中的Hello消息(LAN IIH消息)携带；点到点网络的Hello消息(P2P IIH消息)没有此字段。 </p>
<p><strong>Local Circuit ID</strong> ：本地链路ID。该字段只在点到点网络的Hello消息(P2P IIH消息)携带；广播网中的Hello消息(LAN IIH消息)没有此字段。 </p>
<p><img src="/2021/05/10/IS-IS/15.png"></p>
<h3 id="广播网络中的邻接关系建立过程"><a href="#广播网络中的邻接关系建立过程" class="headerlink" title="广播网络中的邻接关系建立过程"></a>广播网络中的邻接关系建立过程</h3><p>两台运行IS-IS的路由器在交互协议报文实现路由功能之前必须首先建立邻接关系。在不同类型的网络上，IS-IS的邻接建立方式并不相同。在广播网络中，使用三次握手建立邻接关系。</p>
<p>R1及R2通过千兆以太接口互联，这两台直连的Level-1路由器建立邻接关系的过程如下：</p>
<ol>
<li><p>在Down状态下，R1组播发送Level-1 LAN IIH，此报文中邻接列表为空。</p>
</li>
<li><p>R2收到此报文后，将邻接状态标识为Initial。然后，R2再向R1回复Level-1 LAN IIH ，此报文中标识R1为R2的邻接。</p>
</li>
<li><p>R1收到此报文后，将自己与R2的邻接状态标识为Up。然后R1再向R2发送一个标识R2为R1邻接的Level-1 LAN IIH 。</p>
</li>
<li><p>R2收到此报文后，将自己与R1的邻接状态标识为Up。这样，两个路由器成功建立了邻接关系。</p>
</li>
<li><p>广播网络中需要选举DIS，在邻接关系建立后，路由器会等待两个Hello报文间隔，再进行DIS的选举。</p>
</li>
</ol>
<p><img src="/2021/05/10/IS-IS/16.png"></p>
<blockquote>
<p>•Level-1 IIH和Level-2 IIH发送的组播地址分别为01-80-C2-00-00-14、01-80-C2-00-00-15。</p>
<p>•Down：邻接关系的初始状态。</p>
<p>•Initial：收到IIH，但是报文中的邻接列表未包含路由器自身的System ID。</p>
<p>•UP：收到IIS，且邻接列表中包含路由器自身的System ID。</p>
</blockquote>
<h3 id="DIS与伪节点"><a href="#DIS与伪节点" class="headerlink" title="DIS与伪节点"></a>DIS与伪节点</h3><p>•在广播网络中，IS-IS需要在所有的路由器中选举一个路由器作为DIS（Designated Intermediate System）。</p>
<p>•DIS用来创建和更新伪节点（Pseudonodes），并负责生成伪节点的LSP，用来描述这个网络上有哪些网络设备。伪节点是用来模拟广播网络的一个虚拟节点，并非真实的路由器。在IS-IS中，伪节点用DIS的System ID和Circuit ID（非0值）标识。</p>
<p><img src="/2021/05/10/IS-IS/17.png"></p>
<h3 id="IS-IS中的DIS与OSPF中的DR"><a href="#IS-IS中的DIS与OSPF中的DR" class="headerlink" title="IS-IS中的DIS与OSPF中的DR"></a>IS-IS中的DIS与OSPF中的DR</h3><p>•Level-1和Level-2的DIS是分别选举的，用户可以为不同级别的DIS选举设置不同的优先级。</p>
<p>•DIS的选举规则如下：</p>
<p>​    ▫DIS优先级数值最大的被选为DIS。</p>
<p>​    ▫如果优先级数值最大的路由器有多台，则其中MAC地址最大的路由    器会成为DIS。</p>
<p>•DIS发送Hello PDU的时间间隔是普通路由器的1/3，这样可以确保DIS出现故障时能够被更快速地被发现。</p>
<p>•IS-IS中DIS与OSPF协议中DR（Designated Router）的区别：</p>
<p>​    ▫在IS-IS广播网中，优先级为0的路由器也参与DIS的选举，在OSPF中优先级为0的路由器则不参与DR的选举。</p>
<p>​    ▫在IS-IS广播网中，当有新的路由器加入，并符合成为DIS的条件时，这个路由器会被选中成为新的DIS，原有的伪节点被删除。此更改会引起一组新的LSP泛洪。而在OSPF中，当一台新路由器加入后，即使它的DR优先级值最大，也不会立即成为该网段中的DR。</p>
<p>​    ▫在IS-IS广播网中，同一网段上的同一级别的路由器之间都会形成邻接关系，包括所有的非DIS路由器之间也会形成邻接关系。而在OSPF中，路由器只与DR和BDR建立邻接关系。</p>
<h3 id="点到点网络中的邻接关系建立过程"><a href="#点到点网络中的邻接关系建立过程" class="headerlink" title="点到点网络中的邻接关系建立过程"></a>点到点网络中的邻接关系建立过程</h3><p>•点到点网络中，邻接关系的建立使用两次握手方式：只要路由器收到对端发来的Hello报文，就单方面宣布邻接为Up状态，建立邻接关系。</p>
<p>•两次握手机制存在明显的缺陷，华为设备在点到点网络中使用IS-IS时，默认使用三次握手建立邻接关系。此方式通过三次发送P2P IIH最终建立起邻接关系。</p>
<p><img src="/2021/05/10/IS-IS/18.png"></p>
<h2 id="链路状态数据库同步"><a href="#链路状态数据库同步" class="headerlink" title="链路状态数据库同步"></a>链路状态数据库同步</h2><h3 id="LSP"><a href="#LSP" class="headerlink" title="LSP"></a>LSP</h3><p>•IS-IS链路状态报文LSP用于交换链路状态信息。LSP分为两种：Level–1 LSP和Level–2 LSP。Level–1 LSP由Level-1路由器传送，Level–2 LSP由Level-2路由器传送，Level-1-2路由器则可传送以上两种LSP。</p>
<p>•两类LSP有相同的报文格式。</p>
<p><strong>Remaining Lifetime</strong> : LSP的生存时间，以秒为单位。 1200-0s递减。</p>
<p><strong>LSP ID</strong>:由三部分组成，System ID、伪节点ID和LSP分片后的编号。 </p>
<p><strong>Sequence Number</strong>: LSP的序列号。在路由器启动时所发送的第一个LSP报文中的序列号为1，以后当需要生成新的LSP时，新LSP的序列号在前一个LSP序列号的基础上加1。更高的序列号意味着更新的LSP。</p>
<p><strong>Checksum</strong>： LSP的校验和。 </p>
<p><strong>ATT（Attachment）</strong>：由Level-1-2路由器产生，用来指明始发路由器是否与其它区域相连。虽然此标志位也存在于Level-1和Level-2的LSP中，但实际上此字段只和Level-1-2路由器始发的L1 LSP有关。接受到ATT置位的LSP的路由器生成一条到发送该ATT置位的路由，若路径开销相同，则负载分担。</p>
<p>ATT置位的条件</p>
<ul>
<li><p>有L1的邻接关系</p>
</li>
<li><p>有和自己处于不同区域的L2的邻接关系路由器</p>
</li>
<li><p>活跃的数据库</p>
<p>L1/L2可以计算完全的路由信息（cost计算方法不一样就不可以）</p>
</li>
</ul>
<p><strong>OL（LSDB Overload，1bit）</strong>：过载标志位。设置了过载标志位的LSP虽然还会在网络中扩散，但是在计算通过超载路由器的路由时不会被采用。即对路由器设置过载位后，其它路由器在进行SPF计算时不会考虑这台路由器。当路由器内存不足时，系统自动在发送的LSP报文中设置过载标志位。 </p>
<p>**IS Type(2bit)**：生成LSP的路由器的类型。用来指明是Level-1还是Level-2路由器（01表示Level-1，11表示Level-2）。 </p>
<p><img src="/2021/05/10/IS-IS/19.png"></p>
<h3 id="IS-IS的LSDB"><a href="#IS-IS的LSDB" class="headerlink" title="IS-IS的LSDB"></a>IS-IS的LSDB</h3><p><img src="/2021/05/10/IS-IS/20.png"></p>
<blockquote>
<p>•伪节点ID：当该参数不为零时，表示该LSP为伪节点生成。</p>
<p>•分片号：当IS-IS要发布的链路状态协议数据报文PDU（Protocol Data Unit）中的信息量太大时，IS-IS路由器将会生成多个LSP分片，用来携带更多的IS-IS信息。分片号用来区分不同的LSP分片。</p>
</blockquote>
<h3 id="查看非伪节点的LSP"><a href="#查看非伪节点的LSP" class="headerlink" title="查看非伪节点的LSP"></a>查看非伪节点的LSP</h3><p><img src="/2021/05/10/IS-IS/21.png"></p>
<blockquote>
<p>•AREA ADDR：该LSP来源的区域号</p>
<p>•INTF ADDR：该LSP中描述的接口地址</p>
<p>•NBR ID：该LSP中描述的邻接信息</p>
<p>•IP-Internal：该LSP中描述的网段信息</p>
</blockquote>
<h3 id="查看伪节点LSP"><a href="#查看伪节点LSP" class="headerlink" title="查看伪节点LSP"></a>查看伪节点LSP</h3><p><img src="/2021/05/10/IS-IS/22.png"></p>
<h3 id="CSNP"><a href="#CSNP" class="headerlink" title="CSNP"></a>CSNP</h3><p>CSNP包含该设备LSDB中所有的LSP摘要，路由器通过交互 CSNP来判断是否需要同步LSDB。</p>
<p>▫在广播网络上，CSNP由DIS定期发送（缺省的发送周期为10秒）。</p>
<p>▫在点到点网络上，CSNP只在第一次建立邻接关系时发送。</p>
<p><img src="/2021/05/10/IS-IS/23.png"></p>
<h3 id="PSNP"><a href="#PSNP" class="headerlink" title="PSNP"></a>PSNP</h3><p>PSNP只包含部分LSP的摘要信息（与CSNP不同）：</p>
<p>▫当发现LSDB不同步时，PSNP来请求邻居发送新的LSP。</p>
<p>▫在点到的网络中，当收到LSP时，使用PSNP对收到的LSP进行确认。</p>
<p><img src="/2021/05/10/IS-IS/24.png"></p>
<h3 id="广播网络中LSP的同步过程"><a href="#广播网络中LSP的同步过程" class="headerlink" title="广播网络中LSP的同步过程"></a>广播网络中LSP的同步过程</h3><p>广播网络中新加入路由器与DIS同步LSDB数据库的过程：</p>
<ol>
<li><p>新加入的路由器R3首先发送IIH报文，与该广播域中的路由器建立邻接关系。建立邻接关系之后，R3等待LSP刷新定时器超时，然后将自己的LSP发往组播地址（Level-1：01-80-C2-00-00-14；Level-2：01-80-C2-00-00-15）。这样网络上所有的邻接都将收到该LSP。</p>
</li>
<li><p>该网段中的DIS会把收到R3的LSP加入到LSDB中，并等待CSNP报文定时器超时并发送CSNP报文。</p>
</li>
<li><p>R3收到DIS发来的CSNP报文，对比自己的LSDB数据库，然后向DIS发送PSNP报文请求自己没有的LSP。</p>
</li>
<li><p>DIS收到该PSNP报文请求后向R3发送对应的LSP进行LSDB的同步。 </p>
</li>
</ol>
<p><img src="/2021/05/10/IS-IS/25.png"></p>
<h3 id="点到点网络中LSP的同步过程"><a href="#点到点网络中LSP的同步过程" class="headerlink" title="点到点网络中LSP的同步过程"></a>点到点网络中LSP的同步过程</h3><p>点到点网络上LSDB数据库的同步过程：</p>
<p>•R1先与R2建立邻接关系。</p>
<p>•建立邻接关系之后，R1与R2会先发送CSNP给对端设备。如果对端的LSDB与CSNP没有同步，则发送PSNP请求索取相应的LSP。</p>
<p>•假设R2向R1索取相应的LSP。</p>
<ol>
<li><p>R1发送R2请求的LSP的同时启动LSP重传定时器，并等待R2发送的PSNP作为收到LSP的确认。</p>
</li>
<li><p>如果在接口LSP重传定时器超时后，R1没有收到R2发送的PSNP报文作为应答。</p>
</li>
<li><p>则R1重新发送该LSP。</p>
</li>
<li><p>R2收到LSP后，发送PSNP进行确认。</p>
</li>
</ol>
<p><img src="/2021/05/10/IS-IS/26.png"></p>
<h3 id="LSP的处理机制"><a href="#LSP的处理机制" class="headerlink" title="LSP的处理机制"></a>LSP的处理机制</h3><p>IS-IS通过交互LSP实现链路状态数据库同步，路由器收到LSP后，按照以下原则处理：</p>
<p>•若收到的LSP比本地LSP的更优，或者本地没有收到的LSP：</p>
<p>​    ▫在广播网络中：将其加入数据库，并组播发送新的LSP。</p>
<p>​    ▫在点到点网络中：将其加入数据库，并发送PSNP报文来确认收到此    LSP，之后将这新的LSP发送给除了发送该LSP的邻居以外的邻居。</p>
<p>•若收到的LSP和本地LSP无法比较出优劣，则不处理该LSP。</p>
<p><img src="/2021/05/10/IS-IS/27.png"></p>
<blockquote>
<p>•LSP产生的原因，IS-IS路由域内的所有路由器都会产生LSP，以下事件会触发一个新的LSP：</p>
<p>​    ▫邻接Up或Down</p>
<p>​    ▫IS-IS相关接口Up或Down</p>
<p>​    ▫引入的IP路由发生变化</p>
<p>​    ▫区域间的IP路由发生变化</p>
<p>​    ▫接口被赋了新的metric值</p>
<p>​    ▫周期性更新（刷新间隔15min）</p>
</blockquote>
<h2 id="路由计算"><a href="#路由计算" class="headerlink" title="路由计算"></a>路由计算</h2><h3 id="Level-1路由器的路由计算"><a href="#Level-1路由器的路由计算" class="headerlink" title="Level-1路由器的路由计算"></a>Level-1路由器的路由计算</h3><p>•R1是Level-1路由器，只维护Level-1 LSDB，该LSDB中包含同属一个区域的R2及R3以及R1自己产生的Level-1 LSP。</p>
<p>•R1根据LSDB中的Level-1 LSP计算出Area 49.0001内的拓扑，以及到达区域内各个网段的路由信息。</p>
<p>•R2及R3作为Area 49.0001内的Level-1-2路由器，会在它们向该区域下发的Level-1 LSP中设置ATT标志位，用于向区域内的Level-1路由器宣布可以通过自己到达其他区域。 R1作为Level-1路由器，会根据该ATT标志位，计算出指向R2或R3的默认路由。</p>
<p><img src="/2021/05/10/IS-IS/28.png"></p>
<h3 id="Level-1路由器的次优路径的问题"><a href="#Level-1路由器的次优路径的问题" class="headerlink" title="Level-1路由器的次优路径的问题"></a>Level-1路由器的次优路径的问题</h3><p>缺省时， R1只能通过指向R2或R3的默认路由到达区域外部，但是R1距离R2和R3路由器的Cost值相等，那么当R1发送数据包到192.168.20.0/24时，就有可能选择路径2，导致出现次优路径。</p>
<p><img src="/2021/05/10/IS-IS/29.png"></p>
<h3 id="路由渗透"><a href="#路由渗透" class="headerlink" title="路由渗透"></a>路由渗透</h3><p>•缺省情况下，Level-1-2路由器不会将到达其他区域的路由通告本Level-1区域中。</p>
<p>•通过路由渗透，可以将区域间路由通过Leve-1-2路由器传递到Level-1区域，此时Leve-1路由器可以学习到其他区域的详细路由，从而计算出最优路径。</p>
<p><img src="/2021/05/10/IS-IS/31.png"></p>
<h3 id="Level-1-2路由器的路由计算"><a href="#Level-1-2路由器的路由计算" class="headerlink" title="Level-1-2路由器的路由计算"></a>Level-1-2路由器的路由计算</h3><p>•R2及R3都维护Level-1 LSDB，它们能够通过这些LSDB中的LSP计算出Area 49.0001的路由。</p>
<p>•R2及R3都维护Level-2 LSDB，它们能够通过这些LSDB中的LSP计算出Area 49.0002的路由。</p>
<p>•R2及R3将到达Area 49.0001的路由以Level-2 LSP的形式发送到Area 49.0002。</p>
<p><img src="/2021/05/10/IS-IS/32.png"></p>
<h3 id="Level-2路由器的路由计算"><a href="#Level-2路由器的路由计算" class="headerlink" title="Level-2路由器的路由计算"></a>Level-2路由器的路由计算</h3><p>R4及R5作为Level-2路由器，只会维护Level-2 LSDB，它们能够根据该LSDB计算出到达全网各个网段的路由。</p>
<p><img src="/2021/05/10/IS-IS/33.png"></p>
<h1 id="IS-IS的基本配置"><a href="#IS-IS的基本配置" class="headerlink" title="IS-IS的基本配置"></a>IS-IS的基本配置</h1><h2 id="IS-IS协议的基本配置-1"><a href="#IS-IS协议的基本配置-1" class="headerlink" title="IS-IS协议的基本配置 (1)"></a>IS-IS协议的基本配置 (1)</h2><p><img src="/2021/05/10/IS-IS/34.png"></p>
<h2 id="IS-IS协议的基本配置-2"><a href="#IS-IS协议的基本配置-2" class="headerlink" title="IS-IS协议的基本配置 (2)"></a>IS-IS协议的基本配置 (2)</h2><p><img src="/2021/05/10/IS-IS/35.png"></p>
<h2 id="IS-IS协议的基本配置-3"><a href="#IS-IS协议的基本配置-3" class="headerlink" title="IS-IS协议的基本配置 (3)"></a>IS-IS协议的基本配置 (3)</h2><p><img src="/2021/05/10/IS-IS/36.png"></p>
<h2 id="案例：IS-IS配置"><a href="#案例：IS-IS配置" class="headerlink" title="案例：IS-IS配置"></a>案例：IS-IS配置</h2><p><img src="/2021/05/10/IS-IS/37.png"></p>
<p><strong>组网需求</strong></p>
<p>如图所示，现网中有5台路由器。用户希望在这5台路由器实现网络互联，并且因为R1性能相对较低，所以还要使这台路由器处理相对较少的数据信息。同时用户希望R1可以选择最优路径访问192.168.10.0/24和192.168.20.0/24网段。</p>
<p><strong>配置思路</strong></p>
<p>在各路由器上配置IS-IS基本功能，实现网络互联。其中，配置R1为Level-1路由器，可以使这台路由器维护相对少量的数据信息。同时，配置R2和R3为Level-1/2路由器与R4和R5这两台Level-2路由器互联。</p>
<h3 id="案例：R1、R2及R3的配置"><a href="#案例：R1、R2及R3的配置" class="headerlink" title="案例：R1、R2及R3的配置"></a>案例：R1、R2及R3的配置</h3><p><img src="/2021/05/10/IS-IS/38.png"></p>
<h3 id="案例：R4和R5的配置"><a href="#案例：R4和R5的配置" class="headerlink" title="案例：R4和R5的配置"></a>案例：R4和R5的配置</h3><p><img src="/2021/05/10/IS-IS/39.png"></p>
<h3 id="案例：配置验证-查看设备的IS-IS邻接表"><a href="#案例：配置验证-查看设备的IS-IS邻接表" class="headerlink" title="案例：配置验证 (查看设备的IS-IS邻接表)"></a>案例：配置验证 (查看设备的IS-IS邻接表)</h3><p><img src="/2021/05/10/IS-IS/40.png"></p>
<blockquote>
<p>•System Id字段：描述邻接的系统ID</p>
<p>•Interface字段：描述通过该路由器哪个端口与邻接建立邻接关系</p>
<p>•Type：描述与该邻接的邻接关系类型</p>
<p>•PRI：描述该邻接对应端口的DIS优先级</p>
</blockquote>
<h3 id="案例：配置验证-查看设备的IS-IS路由表-1"><a href="#案例：配置验证-查看设备的IS-IS路由表-1" class="headerlink" title="案例：配置验证 (查看设备的IS-IS路由表) (1)"></a>案例：配置验证 (查看设备的IS-IS路由表) (1)</h3><p><img src="/2021/05/10/IS-IS/41.png"></p>
<h3 id="案例：配置验证-查看设备的IS-IS路由表-2"><a href="#案例：配置验证-查看设备的IS-IS路由表-2" class="headerlink" title="案例：配置验证 (查看设备的IS-IS路由表) (2)"></a>案例：配置验证 (查看设备的IS-IS路由表) (2)</h3><p><img src="/2021/05/10/IS-IS/42.png"></p>
<h2 id="路由渗透配置"><a href="#路由渗透配置" class="headerlink" title="路由渗透配置"></a>路由渗透配置</h2><p><img src="/2021/05/10/IS-IS/43.png"></p>
<h2 id="路由渗透验证"><a href="#路由渗透验证" class="headerlink" title="路由渗透验证"></a>路由渗透验证</h2><p>通过查看R1的路由表，我们可以看到新增了两条明细路由192.168.10.0/24以及192.168.20.0/24，两条路由的开销值均为30，当有数据包经由R1到达这两个网段时，不会产生次优路径。</p>
<p><img src="/2021/05/10/IS-IS/44.png"></p>
<h2 id="IS-IS认证的分类"><a href="#IS-IS认证的分类" class="headerlink" title="IS-IS认证的分类"></a>IS-IS认证的分类</h2><p>•IS-IS认证是基于网络安全性的要求而实现的一种认证手段，通过在IS-IS报文中增加认证字段对报文进行认证。当本地路由器接收到远端路由器发送过来的IS-IS报文，如果发现认证密码不匹配，则将收到的报文进行丢弃，达到自我保护的目的。</p>
<p>•根据报文的种类，认证可以分为以下三类：</p>
<p>▫接口认证：在接口视图下配置，对Level-1和Level-2的Hello报文进行认证。</p>
<p>▫区域认证：在IS-IS进程视图下配置，对Level-1的CSNP、PSNP和LSP报文进行认证。</p>
<p>▫路由域认证：在IS-IS进程视图下配置，对Level-2的CSNP、PSNP和LSP报文进行认证。</p>
<p>•根据报文的认证方式，可以分为以下四类：</p>
<p>▫简单认证：将配置的密码直接加入报文中，这种加密方式安全性较其他两种方式低。</p>
<p>▫MD5认证：通过将配置的密码进行MD5算法加密之后再加入报文中，提高密码的安全性。</p>
<p>▫Keychian认证：通过配置随时间变化的密码链表来进一步提升网络的安全性。</p>
<p>▫HMAC-SHA256认证：通过将配置的密码进行HMAC-SHA256算法加密之后再加入报文中，提高密码的安全性。</p>
<h2 id="IS-IS认证详解"><a href="#IS-IS认证详解" class="headerlink" title="IS-IS认证详解"></a>IS-IS认证详解</h2><p><strong>接口认证</strong></p>
<p>▫Hello报文使用的认证密码保存在接口下，发送带认证TLV的认证报文，互相连接的路由器接口必须配置相同的口令。</p>
<p><strong>区域认证</strong></p>
<p>▫区域内的每一台L1路由器都必须使用相同的认证模式和具有共同的钥匙串。</p>
<p><strong>路由域认证</strong></p>
<p>▫IS-IS域内的每一台L2和L1/L2类型的路由器都必须使用相同模式的认证，并使用共同的钥匙串。</p>
<p>▫对于区域和路由域认证，可以设置为SNP和LSP分开认证。</p>
<ul>
<li>本地发送的LSP报文和SNP报文都携带认证TLV，对收到的LSP报文和SNP报文都进行认证检查。</li>
<li>本地发送的LSP报文携带认证TLV，对收到的LSP报文进行认证检查；发送的SNP报文携带认证TLV，但不对收到的SNP报文进行检查。</li>
<li>本地发送的LSP报文携带认证TLV，对收到的LSP报文进行认证检查；发送的SNP报文不携带认证TLV，也不对收到的SNP报文进行认证检查。</li>
<li>本地发送的LSP报文和SNP报文都携带认证TLV，对收到的LSP报文和SNP报文都不进行认证检查。</li>
</ul>
<h2 id="IS-IS认证的配置-1"><a href="#IS-IS认证的配置-1" class="headerlink" title="IS-IS认证的配置 (1)"></a>IS-IS认证的配置 (1)</h2><p><img src="/2021/05/10/IS-IS/45.png"></p>
<h2 id="IS-IS认证的配置-2"><a href="#IS-IS认证的配置-2" class="headerlink" title="IS-IS认证的配置 (2)"></a>IS-IS认证的配置 (2)</h2><p><img src="/2021/05/10/IS-IS/46.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）关于OSPF与IS-IS，说法正确的有？ (   )</p>
<p><strong>A.OSPF及IS-IS都是链路状态路由协议。</strong></p>
<p><strong>B.OSPF仅仅支持IP网络，而集成IS-IS支持CLNP及IP网络。</strong></p>
<p><strong>C.OSPF使用区域号0标识骨干区域。</strong></p>
<p><strong>D.IS-IS骨干区域由Level-2及Level-1-2路由器组成。</strong></p>
<p>2.（多选题）关于Level-1路由器说法正确的有？(   )</p>
<p><strong>A.Level-1路由器只能和相同区域的IS-IS路由器建立邻接关系。</strong></p>
<p>B.Level-1路由器可以和同区域的Level-2路由器建立邻接关系。</p>
<p><strong>C.缺省情况下，Level-1路由器只能通过缺省路由到达区域外部。</strong></p>
<p><strong>D.Level-1路由器的LSDB中只存在Level-1 LSP。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本课程介绍了IS-IS的基本概念。每一台运行IS-IS的路由器都至少有一个NET地址。IS-IS采用分层架构，所有Level-2和Level-1-2路由器共同构成了骨干区域，同一区域的Level-1路由器构成了普通区域。IS-IS协议有四种报文类型，分别是IIH、CSNP、PSNP、LSP。</p>
<p>•Level-1路由器只维护区域内的LSDB，Level-1路由通过离自己最近的Level-1-2路由器到达区域外部，为了避免次优路径，可以在Level-1-2路由器上部署路由渗透的特性。</p>
<p>•IS-IS支持三种认证类型，分别是接口认证、区域认证、路由域认证。</p>
<p>•IS-IS协议与OSPF协议都是链路路由状态协议，两者都需要维护LSDB，随着网络规模的不断扩大，巨大的LSDB会导致路由器整体性能下降，因此对于这两种路由协议而言，面对更大规模的组网时，需要进行多区域的网络设计。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/mydog.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">72</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zsy9959" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zsy9959@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张思宇</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
