<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="my blog">
<meta property="og:type" content="website">
<meta property="og:title" content="zsy&#39;s blog">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="zsy&#39;s blog">
<meta property="og:description" content="my blog">
<meta property="og:locale">
<meta property="article:author" content="张思宇">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/page/3/"/>





  <title>zsy's blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zsy's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">just simple</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/home" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IP-DHCP原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T21:07:42+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/DHCP.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•随着网络规模的不断扩大，网络复杂度不断提升，网络中的终端设备例如主机、手机、平板等，位置经常变化。终端设备访问网络时需要配置IP地址、网关地址、DNS服务器地址等。采用手工方式为终端配置这些参数非常低效且不够灵活。</p>
<p>•IETF于1993年发布了DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）。DHCP实现了网络参数配置的自动化，降低客户端的配置和维护成本。</p>
<p>•本课程介绍DHCP工作原理、应用场景和简单配置。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述DHCP工作原理</p>
<p>▫描述DHCP地址分配规则</p>
<p>▫区分DHCP与DHCP Relay的应用场景</p>
<p>▫实现DHCP的基本配置</p>
<h1 id="1-DHCP产生背景"><a href="#1-DHCP产生背景" class="headerlink" title="1.DHCP产生背景"></a>1.DHCP产生背景</h1><h2 id="手工配置网络参数存在的问题"><a href="#手工配置网络参数存在的问题" class="headerlink" title="手工配置网络参数存在的问题"></a>手工配置网络参数存在的问题</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<blockquote>
<p>•手工配置主机IP地址、网络掩码、网关地址、DNS服务器地址等网络参数时，需要经过地址规划、地址分配、地址配置、地址维护等复杂的操作流程。这使地址分配灵活性差，IP地址资源利用低，同时较大的工作量导致配置容易出错，对人员素质要求较高。</p>
</blockquote>
<h2 id="DHCP的基本概念"><a href="#DHCP的基本概念" class="headerlink" title="DHCP的基本概念"></a>DHCP的基本概念</h2><p>•DHCP是一种用于集中对用户IP地址进行动态管理和配置的协议。</p>
<p>•DHCP采用C/S(Client/Server，客户端/服务器)通信模式，协议报文基于UDP的方式进行交互，采用67（DHCP服务器）和68（DHCP客户端）两个端口号：</p>
<p>​    ▫正常工作时由客户端向服务器提出配置申请。</p>
<p>​    ▫服务器返回为客户端分配的IP地址等相应的配置信息。</p>
<p>•DHCP相对于手工配置有如下优点：</p>
<p>​    ▫效率高</p>
<p>​    ▫灵活性强</p>
<p>​    易于管理</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•网络终端设备，例如主机、打印机、笔记本电脑、手机和AP，作为DHCP客户端，向DHCP服务器请求分配相关网络参数。DHCP服务器响应DHCP客户端请求进行动态分配。</p>
</blockquote>
<h1 id="2-DHCP工作原理与配置"><a href="#2-DHCP工作原理与配置" class="headerlink" title="2.DHCP工作原理与配置"></a>2.DHCP工作原理与配置</h1><h2 id="DHCP客户端首次接入网络的工作原理"><a href="#DHCP客户端首次接入网络的工作原理" class="headerlink" title="DHCP客户端首次接入网络的工作原理"></a>DHCP客户端首次接入网络的工作原理</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<ol>
<li>发现阶段，即DHCP客户端发现DHCP服务器的阶段。</li>
</ol>
<ul>
<li>DHCP客户端发送DHCP DISCOVER报文来发现DHCP服务器。DHCP DISCOVER报文中携带了客户端的MAC地址、需要请求的参数列表选项、广播标志位等信息。</li>
</ul>
<ol start="2">
<li>提供阶段，即DHCP服务器提供网络配置信息的阶段。</li>
</ol>
<ul>
<li>服务器接收到DHCP DISCOVER报文后，选择跟接收DHCP DISCOVER报文接口的IP地址处于同一网段的地址池，并且从中选择一个可用的IP地址，然后通过DHCP OFFER报文发送给DHCP客户端。</li>
</ul>
<ol start="3">
<li>选择阶段，即DHCP客户端选择IP地址的阶段。</li>
</ol>
<ul>
<li><p>如果有多个DHCP服务器向DHCP客户端回应DHCP OFFER报文，则DHCP客户端一般只接收第一个收到的DHCP OFFER报文，然后以广播方式发送DHCP REQUEST报文，该报文中包含客户端想选择的DHCP服务器标识符和客户端IP地址。</p>
<p>4.确认阶段，即DHCP服务器确认所分配IP地址的阶段。</p>
</li>
<li><p>DHCP客户端收到DHCP ACK报文，会广播发送免费ARP报文，探测本网段是否有其他终端使用服务器分配的IP地址。</p>
</li>
</ul>
<blockquote>
<p>•在确认阶段，两种情况可能出现IP地址的冲突：</p>
<ul>
<li><p>DHCP服务器收到DHCP DISCOVER报文时，给客户端分配IP地址前会发送Ping探测，如果能Ping通则标识该地址不可用，并选择其他IP地址分配给客户端。</p>
</li>
<li><p>DHCP客户端获取IP地址成功后，会立即发送免费ARP报文，如果收到响应，则发送DHCP DECLINE报文通知DHCP服务器该IP地址冲突，DHCP服务器标识该地址不可用，客户端发送DHCP DISCOVER报文重新申请IP地址。</p>
</li>
</ul>
</blockquote>
<h2 id="DHCP报文格式"><a href="#DHCP报文格式" class="headerlink" title="DHCP报文格式"></a>DHCP报文格式</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•Htype （hardware type）: 表示硬件地址的类型。</p>
<p>•Hlen（hardware length）: 表示硬件地址的长度。</p>
<p>•Hops（hops）: 表示当前DHCP报文经过的DHCP Relay数目。该字段由客户端设置为0，每经过一个DHCP Relay时，该字段加1。此字段的作用是限制DHCP报文所经过的DHCP Relay数目。</p>
<p>•Xid：表示DHCP客户端选取的随机数，使DHCP服务器的回复与DHCP客户端的报文相关联。</p>
<p>•Sname（server host name）: 表示客户端获取配置信息的服务器名字。此字段由DHCP服务器填写，是可选的。如果填写，必须是一个以0结尾的字符串。</p>
<p>•File（file name）: 表示客户端启动DHCP相关配置的文件名。此字段由DHCP服务器填写，随着DHCP地址分配的同时下发至客户端。本字段是可选的，如果填写，必须是一个以0结尾的字符串。</p>
</blockquote>
<h2 id="Options预定义选项字段介绍"><a href="#Options预定义选项字段介绍" class="headerlink" title="Options预定义选项字段介绍"></a>Options预定义选项字段介绍</h2><p>•DHCP报文中Options字段为可变长度字段，最多为312Byte，此字段包含了DHCP报文类型，服务器分配给终端的配置信息，如网关IP地址，DNS服务器的IP地址，客户端可以使用IP地址的有效租期等信息。</p>
<p>•Options字段由Type、Length和Value三部分组成。其中Type字段取值范围1~255。常见的Options如下表所示：</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<h2 id="DHCP的消息类型"><a href="#DHCP的消息类型" class="headerlink" title="DHCP的消息类型"></a>DHCP的消息类型</h2><p>DHCP报文通过Options选项中的Type=53来表示DHCP的报文类型。如下图所示，当Type=53，Length=1，Value取值从01到08分别表示不同的DHCP报文类型。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<blockquote>
<p>•1-DHCP DISCOVER：DHCP客户端首次登录网络时进行DHCP交互过程发送的第一个消息，用来寻找DHCP服务器。</p>
<p>•2-DHCP OFFER：DHCP服务器用来响应DHCP DISCOVER消息，此消息携带了各种配置信息。 </p>
<p>•3-DHCP REQUEST：DHCP客户端广播请求回应DHCP服务器OFFER消息；DHCP客户端重启广播确认之前的IP地址等配置信息；续租。</p>
<p>•4-DHCP DECLINE：当客户端发现服务器分配给它的IP地址发生冲突时会通过发送此消息来通知服务器。</p>
<p>•5-DHCP ACK：DHCP服务器对客户端的DHCP REQUEST消息的确认响应消息。</p>
<p>•6-DHCP NAK：服务器对客户端的DHCP REQUEST消息的拒绝响应消息。</p>
<p>•7-DHCP RELEASE：客户端可通过发送此消息主动释放服务器分配给它的IP地址。</p>
<p>•8-DHCP INFORM：DHCP客户端获取IP地址后，如果需要向DHCP服务器获取更为详细的配置信息（网关地址、DNS服务器地址），则向DHCP服务器发送DHCP INFORM请求消息。</p>
</blockquote>
<h2 id="Options自定义选项字段介绍"><a href="#Options自定义选项字段介绍" class="headerlink" title="Options自定义选项字段介绍"></a>Options自定义选项字段介绍</h2><p>除了标准协议中规定的字段选项外，还有部分选项内容没有统一规定，统称为用户自定义选项，例如Option 82和Option 43。</p>
<ul>
<li>Option 82称为中继代理信息选项。<ul>
<li>Option 82中可以包含最多255个Sub-Option，若定义了Option 82，至少要定义一个Sub-Option。</li>
<li>DHCP中继或DHCP Snooping设备接收到DHCP客户端发送给DHCP服务器的请求报文后，在该报文中添加Option 82，并转发给DHCP服务器。管理员可以从Option 82中获得DHCP客户端的信息，例如DHCP客户端所连接交换机端口的VLAN ID、二层端口号、中继设备的MAC地址等。</li>
</ul>
</li>
</ul>
<p>▫Option 43称为厂商特定信息选项。</p>
<ul>
<li>DHCP服务器和DHCP客户端通过Option 43交换厂商特定的信息。当DHCP服务器接收到请求Option 43信息的DHCP请求报文（Option 55中带有Option 43参数）后，将在回复报文中携带Option 43，为DHCP客户端分配厂商指定的信息。</li>
<li>在WLAN组网中，AP作为DHCP客户端，DHCP服务器可以为AP指定AC的IP地址，以方便AP与AC建立连接。</li>
</ul>
<blockquote>
<p>目前option 82中常用的Sub-Option如下：</p>
<p>▫Sub-Option 1：为代理电路id（即circuit id）子项。子选项通常在DHCP中继设备上配置，定义了在传输报文的时候要携带DHCP客户端所连接交换机端口的vlan-id及二层端口号。通常Sub-Option 1与Sub-Option 2子选项要共同使用来标识DHCP源端的信息。</p>
<p>▫Sub-Option 2：代理远程id（即remote id）子项。该子选项也通常在DHCP中继设备上配置，定义了在传输报文的时候要携带中继设备的mac地址信息。</p>
<p>▫和Sub-Option 5：为链路选择（link selection）子项，该选项中包含了DHCP中继添加的ip地址。这样DHCP server在分配ip地址给DHCP客户端的时候就可以分配与该地址同网段的ip地址。</p>
</blockquote>
<h2 id="Option-43应用举例"><a href="#Option-43应用举例" class="headerlink" title="Option 43应用举例"></a>Option 43应用举例</h2><p>•在WLAN三层组网中，当AP上线时，需要获取AC的IP地址，并与AC之间建立CAPWAP隧道。</p>
<p>•AP的IP地址通过DHCP服务器分配，当AC的IP地址与AP不在同一个广播域，AP无法通过广播的方式获取AC的IP地址，则CAPWAP隧道无法建立成功。</p>
<p>•AP通过DHCP报文中的Option 43选项字段获取AC的IP地址，当AP获取AC的IP地址后，可以进一步完成CAPWAP隧道的建立，从而实现AP上线。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<h2 id="DHCP地址续租"><a href="#DHCP地址续租" class="headerlink" title="DHCP地址续租"></a>DHCP地址续租</h2><p>DHCP客户端根据IP地址的剩余租期的不同而产生不同形式的续租请求。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<p>•当租期达到50%（T1）时，DHCP客户端会自动以单播的方式向DHCP服务器发送DHCP REQUEST报文，请求更新IP地址租期。如果收到DHCP服务器回应的DHCP ACK报文，则租期更新成功。</p>
<p>•当租期达到87.5%（T2）时，如果仍未收到DHCP服务器的应答，DHCP客户端会自动以广播的方式向DHCP服务器发送DHCP REQUEST报文，请求更新IP地址租期。如果收到DHCP服务器回应的DHCP ACK报文，则租期更新成功。</p>
<p>•如果租期时间到时都没有收到服务器的回应，客户端停止使用此IP地址，重新发送DHCP DISCOVER报文请求新的IP地址。</p>
<blockquote>
<p>•DHCP服务器给每个分配给客户端的IP地址定义一个使用期限，该使用期限被称为租期。在租期到期前，DHCP客户端如果仍需要使用该IP地址，可以请求延长租期；如果不需要，可以主动释放该IP地址。在没有其他空闲地址可用的情况下，DHCP服务器会把客户端主动释放的IP地址分配给其他客户端。</p>
<p>•DHCP客户端无论在T1还是T2时刻发送DHCP REQUEST报文后，如果收到DHCP NAK报文，则重新发送DHCP DISCOVER报文请求新的IP地址。</p>
<p>•客户端在租期时间到之前，如果用户不想使用分配的IP地址（例如客户端网络位置需要变更），会触发DHCP客户端向DHCP服务器发送DHCP RELEASE报文，通知DHCP服务器释放IP地址的租期。DHCP服务器会保留这个DHCP客户端的配置信息，将IP地址列为曾经分配过的IP地址中，以便后续重新分配给该客户端或其他客户端。客户端可以通过发送DHCP INFORM报文向服务器请求更新配置信息。</p>
</blockquote>
<h2 id="DHCP客户端重用曾经使用过的地址"><a href="#DHCP客户端重用曾经使用过的地址" class="headerlink" title="DHCP客户端重用曾经使用过的地址"></a>DHCP客户端重用曾经使用过的地址</h2><p>DHCP客户端非首次接入网络时，可以重用曾经使用过的地址。例如，网络中的主机作为DHCP客户端，在关机再开机的过程中，需要重新获取相关网络参数，则可以请求分配曾经使用过的IP地址。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<p>1.选择阶段</p>
<ul>
<li>客户端广播发送包含前一次分配的IP地址的DHCP REQUEST报文，报文中的Option 50（请求的IP地址选项）字段填入曾经使用过的IP地址。</li>
</ul>
<p>2.确认阶段</p>
<ul>
<li>DHCP服务器收到DHCP REQUEST报文后，根据DHCP REQUEST报文中携带的MAC地址来查找有没有相应的租约记录。如果有则返回DHCP ACK报文，通知DHCP客户端可以继续使用这个IP地址，如果没有租约记录，则不响应。</li>
</ul>
<blockquote>
<p>•是否支持重用曾经使用过的IP地址，因不同客户端而异。</p>
</blockquote>
<h2 id="DHCP分配IP地址顺序"><a href="#DHCP分配IP地址顺序" class="headerlink" title="DHCP分配IP地址顺序"></a>DHCP分配IP地址顺序</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<h2 id="DHCP配置命令介绍-1"><a href="#DHCP配置命令介绍-1" class="headerlink" title="DHCP配置命令介绍 (1)"></a>DHCP配置命令介绍 (1)</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<blockquote>
<p>•此处以ip pool的名字为HW举例说明。</p>
<p>•缺省情况下，没有配置为指定DHCP Client分配固定IP地址。</p>
</blockquote>
<h2 id="DHCP配置命令介绍-2"><a href="#DHCP配置命令介绍-2" class="headerlink" title="DHCP配置命令介绍 (2)"></a>DHCP配置命令介绍 (2)</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<blockquote>
<p>•此处以接口GigabitEthernet0/0/1举例说明。</p>
</blockquote>
<h2 id="DHCP配置举例（1）"><a href="#DHCP配置举例（1）" class="headerlink" title="DHCP配置举例（1）"></a>DHCP配置举例（1）</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<h2 id="DHCP配置举例（2）"><a href="#DHCP配置举例（2）" class="headerlink" title="DHCP配置举例（2）"></a>DHCP配置举例（2）</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<h2 id="DHCP配置结果"><a href="#DHCP配置结果" class="headerlink" title="DHCP配置结果"></a>DHCP配置结果</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<h1 id="3-DHCP-Relay工作原理与配置"><a href="#3-DHCP-Relay工作原理与配置" class="headerlink" title="3.DHCP Relay工作原理与配置"></a>3.DHCP Relay工作原理与配置</h1><h2 id="什么是DHCP-Relay"><a href="#什么是DHCP-Relay" class="headerlink" title="什么是DHCP Relay"></a>什么是DHCP Relay</h2><p>•随着网络规模的不断扩大，网络设备不断增多，企业内不同的用户可能分布在不同的网段，一台DHCP服务器在正常情况下无法满足多个网段的地址分配需求。如果还需要通过DHCP服务器分配IP地址，则需要跨网段发送DHCP报文。</p>
<p>•DHCP Relay即DHCP中继，它是为解决DHCP服务器和DHCP客户端不在同一个广播域而提出的，提供了对DHCP广播报文的中继转发功能，能够把DHCP客户端的广播报文“透明地”传送到其它广播域的DHCP服务器上，同样也能够把DHCP服务器端的应答报文“透明地”传送到其它广播域的DHCP客户端。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<h2 id="DHCP-Relay报文格式"><a href="#DHCP-Relay报文格式" class="headerlink" title="DHCP Relay报文格式"></a>DHCP Relay报文格式</h2><p>DHCP Relay主要负责转发DHCP客户端与DHCP服务器之间的DHCP报文，所以DHCP Relay的报文格式只是把DHCP的报文部分字段做了相应的修改，报文格式没有发生变化，如下图所示：</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<p>Hops：表示当前的DHCP报文经过的DHCP中继的数目。该字段由客户端或服务器设置为0，每经过一个DHCP中继时，该字段加1。</p>
<p>Giaddr(gateway ip address)：表示第一个DHCP中继的IP地址。当客户端发出DHCP请求时，第一个DHCP中继在将DHCP请求报文转发给DHCP服务器时，会把自己的IP地址填入此字段。</p>
<blockquote>
<p>•Hops字段的作用是限制DHCP报文所经过的DHCP中继数目。服务器和客户端之间的DHCP中继数目不能超过16个，也就是Hops值不能大于16，否则DHCP报文将被丢弃。</p>
<p>•Giaddr字段，DHCP服务器会根据此字段来判断出客户端所在的网段地址，从而选择合适的地址池，为客户端分配该网段的IP地址。服务器还会根据此地址将响应报文发送给此DHCP中继，再由DHCP中继将此报文转发给客户端。若在到达DHCP服务器前经过了多个DHCP中继，该字段作为客户端所在的网段的标记，填充了第一个DHCP中继的IP地址后不会再变更，只是每经过一个DHCP中继，hops字段的数值会加1。</p>
</blockquote>
<h2 id="DHCP-Relay工作原理"><a href="#DHCP-Relay工作原理" class="headerlink" title="DHCP Relay工作原理"></a>DHCP Relay工作原理</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<p>有中继场景时DHCP客户端首次接入网络的工作原理：</p>
<p>1.发现阶段：DHCP中继接收到DHCP客户端广播发送的DHCP DISCOVER报文后，通过路由转发将DHCP报文单播发送到DHCP服务器或下一跳中继。</p>
<p>2.提供阶段：DHCP服务器根据DHCP DISCOVER报文中的Giaddr字段选择地址池为客户端分配相关网络参数，DHCP中继收到DHCP OFFER报文后，以单播或组播方式发送给DHCP Client。</p>
<p>3.选择阶段：中继接收到来自客户端的DHCP REQUEST报文的处理过程同“发现阶段”。</p>
<p>4.确认阶段：中继接收到来自服务器的DHCP ACK报文的处理过程同“提供阶段”。</p>
<blockquote>
<p>1.DHCP中继收到DHCP DISCOVER报文后，处理规则为：</p>
<ul>
<li>检查DHCP报文中的Hops字段，如果大于16，则丢弃DHCP报文；否则，将Hops字段加1（表明经过一次DHCP中继），并继续下面的操作。</li>
<li>检查DHCP报文中的Giaddr字段。如果是0，将Giaddr字段设置为接收DHCP DISCOVER报文的接口IP地址。如果不是0，则不修改该字段，继续下面的操作。</li>
<li>将DHCP报文的目的IP地址改为DHCP服务器或下一跳中继的IP地址，源地址改为中继连接客户端的接口地址，通过路由转发将DHCP报文单播发送到DHCP服务器或下一跳中继。</li>
</ul>
<p>2.DHCP服务器接收到DHCP DISCOVER报文后，选择与报文中Giaddr字段为同一网段的地址池，并为客户端分配IP地址等参数，然后向Giaddr字段标识的DHCP中继单播发送DHCP OFFER报文，DHCP中继收到DHCP OFFER报文后，会进行如下处理：</p>
<ul>
<li><p>检查报文中的Giaddr字段，如果不是接口的地址，则丢弃该报文；否则，继续下面的操作。</p>
</li>
<li><p>DHCP中继检查报文的广播标志位。如果广播标志位为1，则将DHCP OFFER报文广播发送给DHCP客户端；否则将DHCP OFFER报文单播发送给DHCP客户端。</p>
</li>
</ul>
</blockquote>
<h2 id="DHCP-Relay配置命令介绍"><a href="#DHCP-Relay配置命令介绍" class="headerlink" title="DHCP Relay配置命令介绍"></a>DHCP Relay配置命令介绍</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<h2 id="DHCP-Relay配置举例-1"><a href="#DHCP-Relay配置举例-1" class="headerlink" title="DHCP Relay配置举例 (1)"></a>DHCP Relay配置举例 (1)</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<blockquote>
<p>•各个设备配置DHCP前需要在全局视图下通过DHCP enable命令开启DHCP功能。</p>
</blockquote>
<h2 id="DHCP-Relay配置举例-2"><a href="#DHCP-Relay配置举例-2" class="headerlink" title="DHCP Relay配置举例 (2)"></a>DHCP Relay配置举例 (2)</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<h2 id="DHCP-Relay配置验证"><a href="#DHCP-Relay配置验证" class="headerlink" title="DHCP Relay配置验证"></a>DHCP Relay配置验证</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）DHCP客户端向DHCP Server进行续租时会发送哪种报文？</p>
<p>A.DHCP DISCOVER</p>
<p>B.DHCP OFFER</p>
<p><strong>C.DHCP REQUEST</strong></p>
<p>D.DHCP ACK</p>
<p>2.（单选题）以下哪条命令可以开启路由器接口的DHCP中继功能？</p>
<p>A.DHCP select server</p>
<p>B.DHCP select global</p>
<p>C.DHCP select interface</p>
<p><strong>D.DHCP select relay</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本章节主要讲解了DHCP报文的格式及关键字段的作用。通过报文交互介绍了DHCP服务器如何给DHCP客户端分配IP地址等网络参数的过程，同时阐述了地址续租与DHCP客户端重启之后如何获取IP地址的原理。</p>
<p>•当DHCP客户端与DHCP服务器不在一个广播域的时候，通过DHCP Relay的中继功能，实现DHCP报文的跨网段传输，从而完成DHCP客户端与服务器之间的报文协商。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IP-VRRP原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T20:53:26+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•局域网中的用户终端通常采用配置一个默认网关的形式访问外部网络，如果默认网关设备发生故障，那么所有用户终端访问外部网络的流量将会中断。可以通过部署多个网关的方式来解决单点故障，但是需要解决多个网关之间的冲突问题。</p>
<p>•VRRP（Virtual Router Redundancy Protocol，虚拟路由器冗余协议）既能够实现网关的备份，又能解决多个网关之间互相冲突的问题，从而提高网络可靠性。</p>
<p>•本课程主要介绍VRRP的工作原理与基本配置，以及在网络中的典型应用。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫分析局域网单网关引发的问题</p>
<p>▫阐述VRRP基本概念及工作原理</p>
<p>▫描述VRRP主备切换过程</p>
<p>▫实现VRRP基本配置</p>
<h1 id="1-VRRP技术概述"><a href="#1-VRRP技术概述" class="headerlink" title="1.VRRP技术概述"></a>1.VRRP技术概述</h1><h2 id="单网关面临的问题"><a href="#单网关面临的问题" class="headerlink" title="单网关面临的问题"></a>单网关面临的问题</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h2 id="VRRP概述"><a href="#VRRP概述" class="headerlink" title="VRRP概述"></a>VRRP概述</h2><p>通过把几台路由设备联合组成一台虚拟的“路由设备”，使用一定的机制保证当主机的下一跳路由设备出现故障时，及时将业务切换到备份路由设备，从而保持通讯的连续性和可靠性。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•VRRP的运行结果是在局域网上提供一个虚拟路由器。</p>
<p>•本例中：</p>
<ul>
<li><p>局域网中有两个路由器R1和R2，R1端口IP地址为192.168.1.251/24，R2端口IP地址为192.168.1.252/24。</p>
</li>
<li><p>配置R1和R2关联到同一个虚拟路由器，该虚拟路由器使用192.168.1.254做为端口IP地址。</p>
</li>
<li><p>所有的PC使用192.168.1.254做为默认网关。</p>
</li>
</ul>
</blockquote>
<h2 id="VRRP的基本概念-1"><a href="#VRRP的基本概念-1" class="headerlink" title="VRRP的基本概念 (1)"></a>VRRP的基本概念 (1)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<p>•<strong>VRRP路由器：</strong>运行VRRP协议的路由器，如R1和R2。VRRP是配置在路由器的接口上的，而且也是基于接口来工作的。</p>
<p>•<strong>VRID：</strong>一个VRRP组（VRRP Group）由多台协同工作的路由器（的接口）组成，使用相同的VRID（Virtual Router Identifier，虚拟路由器标识符）进行标识。属于同一个VRRP组的路由器之间交互VRRP协议报文并产生一台虚拟“路由器”。一个VRRP组中只能出现一台Master路由器。 </p>
<h2 id="VRRP的基本概念-2"><a href="#VRRP的基本概念-2" class="headerlink" title="VRRP的基本概念 (2)"></a>VRRP的基本概念 (2)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<p>•<strong>虚拟路由器：</strong>VRRP为每一个组抽象出一台虚拟“路由器”（Virtual Router），该路由器并非真实存在的物理设备，而是由VRRP虚拟出来的逻辑设备。一个VRRP组只会产生一台虚拟路由器。</p>
<p>•<strong>虚拟IP地址及虚拟MAC地址：</strong>虚拟路由器拥有自己的IP地址以及MAC地址，其中IP地址由网络管理员在配置VRRP时指定，一台虚拟路由器可以有一个或多个IP地址，通常情况下用户使用该地址作为网关地址。而虚拟MAC地址的格式是“0000-5e00-01xx”，其中xx为VRID。</p>
<h2 id="VRRP的基本概念-3"><a href="#VRRP的基本概念-3" class="headerlink" title="VRRP的基本概念 (3)"></a>VRRP的基本概念 (3)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<p>•<strong>Master路由器：</strong>“Master路由器”在一个VRRP组中承担报文转发任务。在每一个VRRP组中，只有Master路由器才会响应针对虚拟IP地址的ARP Request。Master路由器会以一定的时间间隔周期性地发送VRRP报文，以便通知同一个VRRP组中的Backup路由器关于自己的存活情况。</p>
<p>•<strong>Backup路由器：</strong>也被称为备份路由器。Backup路由器将会实时侦听Master路由器发送出来的VRRP报文，它随时准备接替Master路由器的工作。</p>
<p>•<strong>Priority：</strong>优先级值是选举Master路由器和Backup路由器的依据，优先级取值范围0-255，值越大越优先，值相等则比较接口IP地址大小，大者优先。</p>
<h2 id="VRRP报文格式"><a href="#VRRP报文格式" class="headerlink" title="VRRP报文格式"></a>VRRP报文格式</h2><p>VRRP只有一种报文，即Advertisement报文，基于组播方式发送，因此只能在同一个广播域传递。 Advertisement报文的目的组播地址为224.0.0.18。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<blockquote>
<p>VRRP报文字段含义如下：</p>
<p>▫Ver：VRRP目前有两个版本，其中VRRPv2仅适用于IPv4网络，VRRPv3适用于IPv4和IPv6两种网络。</p>
<p>▫Virtual Rtr ID：该报文所关联的虚拟路由器的标识。</p>
<p>▫Priority：发送该报文的VRRP路由器的优先级。</p>
<p>▫Count IP Addrs：该VRRP报文中所包含的虚拟IP地址的数量。</p>
<p>▫Auth Type：VRRP支持三种认证类型：不认证、纯文本密码认证、MD5方式认证，对应值分别为0、1、2。</p>
<p>▫Adver Int：发送VRRP通告消息的间隔。默认为1秒</p>
<p>▫IP Address：所关联的虚拟路由器的虚拟IP地址，可以为多个。</p>
<p>▫Authentication Data：验证所需要的密码信息。</p>
</blockquote>
<h2 id="VRRP定时器"><a href="#VRRP定时器" class="headerlink" title="VRRP定时器"></a>VRRP定时器</h2><p>在VRRP协议工作过程中，VRRP定义了两个定时器：</p>
<p>▫ADVER_INTERVAL定时器：Master发送VRRP通告报文时间周期，缺省值为1秒。</p>
<p>▫MASTER_DOWN定时器：Backup设备监听该定时器超时后，会变为Master状态。<br>     MASTER_DOWN定时器计算公式如下：</p>
<ul>
<li>MASTER_DOWN =（3* ADVER_INTERVAL）+ Skew_time（偏移时间）</li>
<li>其中，Skew_Time=（256–Priority）/256</li>
</ul>
<h1 id="2-VRRP技术原理"><a href="#2-VRRP技术原理" class="headerlink" title="2.VRRP技术原理"></a>2.VRRP技术原理</h1><h2 id="VRRP状态机"><a href="#VRRP状态机" class="headerlink" title="VRRP状态机"></a>VRRP状态机</h2><p>VRRP协议状态机有三种状态：Initialize（初始状态）、Master（活动状态）、Backup（备份状态）。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<blockquote>
<p>•一个Startup事件可以由系统在VRRP配置完成后自动触发，也可以是在已经配置VRRP的端口上，底层链路由不可用变为可用而触发。</p>
</blockquote>
<h2 id="VRRP协议状态"><a href="#VRRP协议状态" class="headerlink" title="VRRP协议状态"></a>VRRP协议状态</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h2 id="VRRP主备选举-1"><a href="#VRRP主备选举-1" class="headerlink" title="VRRP主备选举 (1)"></a>VRRP主备选举 (1)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<blockquote>
<p>•初始创建VRRP的设备工作在Initialize状态，收到接口Up的消息后，若此设备的优先级小于255，则会先切换至Backup状态，等待MASTER_DOWN定时器超时后再切换至Master状态。</p>
<p>•如果优先级高的设备先启动，优先级低的设备后启动，则优先级高的设备先进入Master状态，优先级低的设备收到高优先级的VRRP通告报文，自己仍处于Backup状态。</p>
<p>•如果优先级低的先启动，优先级高的后启动，则优先级低的先由Backup状态切换为Master状态，优先级高的设备收到优先级低的VRRP通告报文，重新进行选举，将优先级高的设备切换为Master状态。</p>
</blockquote>
<h2 id="VRRP主备选举-2"><a href="#VRRP主备选举-2" class="headerlink" title="VRRP主备选举 (2)"></a>VRRP主备选举 (2)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<blockquote>
<p>•初始创建VRRP的设备工作在Initialize状态，收到接口Up的消息后，若此设备的优先级小于255，则会先切换至Backup状态，等待MASTER_DOWN定时器超时后再切换至Master状态。</p>
<p>•如果优先级高的设备先启动，优先级低的设备后启动，则优先级高的设备先进入Master状态，优先级低的设备收到高优先级的VRRP通告报文，自己仍处于Backup状态。</p>
<p>•如果优先级低的先启动，优先级高的后启动，则优先级低的先由Backup状态切换为Master状态，优先级高的设备收到优先级低的VRRP通告报文，重新进行选举，将优先级高的设备切换为Master状态。</p>
</blockquote>
<h2 id="VRRP主备选举-3"><a href="#VRRP主备选举-3" class="headerlink" title="VRRP主备选举 (3)"></a>VRRP主备选举 (3)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•通常情况下，VRRP路由器的接口IP地址不会与虚拟路由器的IP地址重叠，也就是说我们会为虚拟路由器单独规划一个IP地址，而不会使用某台路由器的接口IP地址。当然也存在一个特殊的情况，例如在某些网络中IP地址资源比较紧缺，那么也有可能会将某台路由器的接口IP地址用于虚拟路由器，此时该路由器将无条件成为Master。</p>
<p>•无法手动将VRRP接口优先级配置为255，当接口IP地址为IP地址拥有者时，优先级自动成为255。</p>
</blockquote>
<h2 id="VRRP主备切换"><a href="#VRRP主备切换" class="headerlink" title="VRRP主备切换"></a>VRRP主备切换</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•当Master设备主动放弃Master地位（如Master设备退出备份组）时，会发送优先级为0的通告报文，用来使Backup设备快速切换成Master设备，而不用等到MASTER_DOWN定时器超时。这个切换的时间称为Skew_time。</p>
<p>•当Master设备发生网络故障而不能发送通告报文的时候，Backup设备并不能立即知道其工作状况。等到MASTER_DOWN定时器超时后，才会认为Master设备无法正常工作，从而将状态切换为Master。</p>
</blockquote>
<h2 id="VRRP主备回切"><a href="#VRRP主备回切" class="headerlink" title="VRRP主备回切"></a>VRRP主备回切</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<blockquote>
<p>•开启抢占模式的VRRP备份组，当主备进行切换时，总共时长为：3xAdver_Interval+Skew_time+Delay_time</p>
<p>•在抢占模式下，当Master的设备状态不稳定或者网络质量差时，会导致VRRP备份组频繁切换，从而引发终端ARP表项频繁刷新，为缓解此问题，通常设置抢占延时定时器，通过MASTER_INTERVAL定时器超时时间加上延时时间，确定状态稳定后，再进行主备回切。</p>
</blockquote>
<h1 id="3-VRRP典型应用"><a href="#3-VRRP典型应用" class="headerlink" title="3.VRRP典型应用"></a>3.VRRP典型应用</h1><h2 id="VRRP负载分担"><a href="#VRRP负载分担" class="headerlink" title="VRRP负载分担"></a>VRRP负载分担</h2><p>通过创建多个虚拟路由器，每个物理路由器在不同的VRRP组中扮演不同的角色，不同虚拟路由器的Virtual IP作为不同的内网网关地址可以实现流量转发负载分担。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<h2 id="VRRP监视上行端口"><a href="#VRRP监视上行端口" class="headerlink" title="VRRP监视上行端口"></a>VRRP监视上行端口</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<blockquote>
<p>•如果用户未配置VRRP监视上行端口，则当VRRP备份组中的Master设备R1的上行接口或者链路出现故障时，VRRP备份组无法感知，Master无法向外转发流量。但是由于主备不会发生切换，导致出现流量黑洞。</p>
</blockquote>
<h2 id="VRRP与BFD联动"><a href="#VRRP与BFD联动" class="headerlink" title="VRRP与BFD联动"></a>VRRP与BFD联动</h2><p>通过配置VRRP与BFD联动，当Backup设备通过BFD感知故障发生之后，不再等待Master_Down_Timer计时器超时而会在BFD检测周期结束后立即切换VRRP状态，此时可以实现毫秒级的主备切换。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<blockquote>
<p>•当VRRP备份组之间的链路出现故障时，由于此时VRRP报文无法正常交互，Backup设备需要等待Master_Down_Timer计时器超时后才会切换为Master设备，在等待切换期间内，业务流量仍会发往Master设备，此时会造成业务流量丢失。</p>
<p>•通过在Master设备和Backup设备之间建立BFD会话并与VRRP备份组进行绑定，由BFD机制快速检测VRRP备份组之间的通信故障，并在出现故障时及时通知VRRP备份组进行主备切换，从而大大减少应用中断时间。</p>
<p>•在普通BFD联动中，VRRP备份组会根据BFD会话的状态进行优先级调整，并根据调整后的优先级判断是否进行主备切换。在实际应用中，通常Master设备配置延时抢占，而Backup设备配置立即抢占，当Backup设备检测到BFD会话状态出现DOWN后，通过增加自身优先级大于Master优先级实现快速切换，当故障排除，BFD会话状态出现UP时，新的Master通过减小自己的优先级，发送vrrp通告报文，经过延迟时间后再次切换为Backup。</p>
</blockquote>
<h2 id="VRRP与MSTP结合应用"><a href="#VRRP与MSTP结合应用" class="headerlink" title="VRRP与MSTP结合应用"></a>VRRP与MSTP结合应用</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<blockquote>
<p>•MSTP是将一个或多个VLAN映射到一个生成树的实例，若干个VLAN共用一个生成树，MSTP可以实现负载均衡。</p>
<p>•VRRP配置网关可以灵活根据网络拓扑变化而自动切换，提高网络可靠性。</p>
<p>•VRRP+MSTP可以在实现负载分担的同时保证网络冗余备份。</p>
</blockquote>
<h1 id="4-VRRP基本配置"><a href="#4-VRRP基本配置" class="headerlink" title="4.VRRP基本配置"></a>4.VRRP基本配置</h1><h2 id="VRRP常用配置命令"><a href="#VRRP常用配置命令" class="headerlink" title="VRRP常用配置命令"></a>VRRP常用配置命令</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<h2 id="VRRP基础配置实例"><a href="#VRRP基础配置实例" class="headerlink" title="VRRP基础配置实例"></a>VRRP基础配置实例</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<h2 id="VRRP基础配置验证"><a href="#VRRP基础配置验证" class="headerlink" title="VRRP基础配置验证"></a>VRRP基础配置验证</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）以下关于VRRP报文中IP地址的设置正确的说法是(   )。</p>
<p><strong>A.源IP地址为Master设备端口的IP地址</strong></p>
<p>B.源IP地址为虚拟路由器的虚拟IP地址</p>
<p>C.目的IP地址为广播IP地址</p>
<p><strong>D.目的IP地址为组播IP地址</strong></p>
<p>2.（多选题）以下关于VRRP协议中各定时器的说法正确的是(   )。</p>
<p><strong>A.VRRP通告消息发送间隔默认为1秒，关联到同一虚拟路由器VRRP路由器上配置的VRRP消息通告间隔必须一致。</strong></p>
<p>B.配置抢占延迟时间为4秒，表示如果4秒中之内没有收到Master发送的VRRP通告消息，则Slave应当成为新的Master。</p>
<p>C.配置抢占延迟时间为4秒，配置VRRP消息通告间隔为2秒，表示如果6秒中之内没有收到Master发送的VRRP通告消息，则Slave应当成为新的Master。</p>
<p><strong>D.在比较繁忙的网络中，应当适当的将抢占延迟设置为一个较大的值，以避免不必要的VRRP角色振荡。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•VRRP作为一种非常重要的可靠性技术，常用于实现网关设备冗余，该协议既能提高网络可靠性，又可以实现网络负载分担。</p>
<p>•VRRP主备选举、主备切换及主备回切都主要通过VRRP优先级来控制，为了确保网络稳定性，VRRP设计了抢占延时机制，减少网络震荡。</p>
<p>•VRRP可监视上行接口状态，从而感知网络故障，联动VRRP实现网络可靠性。VRRP亦可绑定BFD会话实现快速收敛。此外，VRRP可与MSTP结合使用，在园区网络中，这是常见的组网方案。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/" itemprop="url">IP-BFD原理与应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T20:42:30+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/BFD.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•随着网络应用的广泛部署，网络发生故障极大可能导致业务异常。为了减小链路、设备故障对业务的影响，提高网络的可靠性，网络设备需要尽快检测到与相邻设备间的通信故障，以便及时采取措施，保证业务正常进行。</p>
<p>•BFD（Bidirectional Forwarding Detection，双向转发检测）提供了一个通用的、标准化的、介质无关和协议无关的快速故障检测机制，用于快速检测、监控网络中链路或者IP路由的转发连通状态。</p>
<p>•本章节主要介绍BFD工作原理以及常见的应用场景。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫阐明BFD的作用</p>
<p>▫描述BFD工作原理</p>
<p>▫实现BFD配置与应用</p>
<h1 id="1-BFD概述"><a href="#1-BFD概述" class="headerlink" title="1.BFD概述"></a>1.BFD概述</h1><h2 id="网络故障检测遇到的问题"><a href="#网络故障检测遇到的问题" class="headerlink" title="网络故障检测遇到的问题"></a>网络故障检测遇到的问题</h2><p>•在无法通过硬件信号检测故障的系统中，应用通常采用上层协议本身的Hello报文机制检测网络故障。</p>
<p>•常用路由协议的Hello报文机制检测时间较长，检测时间超过1秒钟。当应用在网络中传输的数据超过GB/s时，秒级的检测时间将会导致应用传输的数据大量丢失。</p>
<p>•在三层网络中，静态路由本身没有故障检查机制。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/1.png"></p>
<h2 id="BFD概述"><a href="#BFD概述" class="headerlink" title="BFD概述"></a>BFD概述</h2><p>•BFD提供了一个通用的、标准化的、介质无关的、协议无关的快速故障检测机制，有以下两大优点：</p>
<p>​    ▫对相邻转发引擎之间的通道提供轻负荷、快速故障检测。</p>
<p>​    ▫用单一的机制对任何介质、任何协议层进行实时检测。</p>
<p>•BFD是一个简单的“Hello”协议。两个系统之间建立BFD会话通道，并周期性发送BFD检测报文，如果某个系统在规定的时间内没有收到对端的检测报文，则认为该通道的某个部分发生了故障。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/2.png"></p>
<blockquote>
<p>•由于同一个数据路径上只建立一个BFD会话，如果不同的应用使用的BFD参数不一致，则应该配置一个能满足所有应用要求的BFD参数。</p>
</blockquote>
<h1 id="2-BFD工作原理"><a href="#2-BFD工作原理" class="headerlink" title="2.BFD工作原理"></a>2.BFD工作原理</h1><h2 id="BFD报文结构"><a href="#BFD报文结构" class="headerlink" title="BFD报文结构"></a>BFD报文结构</h2><p>•BFD检测是通过维护在两个系统之间建立的BFD会话来实现的，系统通过发送BFD报文建立会话。</p>
<p>•BFD控制报文根据场景不同封装不同，报文结构由强制部分和可选的认证字段组成。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/3.png"></p>
<p>1.Sta：BFD本地状态。</p>
<p>2.Detect Mult：检测超时倍数，用于检测方计算检测超时时间。</p>
<p>3.My Discriminator：BFD会话连接本地标识符（Local Discriminator） 。发送系统产生的一个唯一的、非0鉴别值，用来区分一个系统的多个BFD会话。 </p>
<p>4.Your Discriminator：BFD会话连接远端标识符（Remote Discriminator） 。从远端系统接收到的鉴别值，这个域直接返回接收到的“My Discriminator”，如果不知道这个值就返回0。 </p>
<p>5.Desired Min TX Interval：本地支持的最小BFD报文发送间隔。 </p>
<p>6.Required Min RX Interval：本地支持的最小BFD报文接收间隔。</p>
<p>7.Required Min Echo RX Interval：本地支持的最小Echo报文接收间隔，单位为微秒（如果本地不支持Echo功能，则设置0）。</p>
<blockquote>
<p>•Ver：BFD协议版本号，目前为1。</p>
<p>•Diag：诊断字，标明本地BFD系统最近一次会话状态发生变化的原因。</p>
<p>•P：参数发生改变时，发送方在BFD报文中置该标志，接收方必须立即响应该报文。</p>
<p>•F：响应P标志置位的回应报文中必须将F标志置位。</p>
<p>•C：转发/控制分离标志，一旦置位，控制平面的变化不影响BFD检测。</p>
<p>•A：认证标识，置1代表会话需要进行验证。</p>
<p>•D：查询请求，置位代表发送方期望采用查询模式对链路进行监测。</p>
<p>•M：为BFD将来支持点对多点扩展而设的预留位。</p>
<p>•Length：报文长度，单位为字节。</p>
</blockquote>
<h2 id="BFD会话建立"><a href="#BFD会话建立" class="headerlink" title="BFD会话建立"></a>BFD会话建立</h2><p>BFD会话的建立有两种方式，即静态建立BFD会话和动态建立BFD会话。BFD通过控制报文中的本地标识符和远端标识符区分不同的会话。静态和动态创建BFD会话的主要区别在于Local Discriminator和Remote Discriminator的配置方式不同。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/4.png"></p>
<blockquote>
<p>•动态建立BFD会话时，系统对本地标识符和远端标识符的处理方式如下：</p>
<ul>
<li>动态分配本地标识符，当应用程序触发动态创建BFD会话时，系统分配属于动态会话标识符区域的值作为BFD会话的本地标识符。然后向对端发送Remote Discriminator的值为0的BFD控制报文，进行会话协商。</li>
<li>自学习远端标识符，当BFD会话的一端收到Remote Discriminator的值为0的BFD控制报文时，判断该报文是否与本地BFD会话匹配，如果匹配，则学习接收到的BFD报文中Local Discriminator的值，获取远端标识符。</li>
</ul>
</blockquote>
<h2 id="BFD会话状态"><a href="#BFD会话状态" class="headerlink" title="BFD会话状态"></a>BFD会话状态</h2><p>BFD会话有四种状态：Down、Init、Up和AdminDown。会话状态变化通过BFD报文的State字段传递，系统根据自己本地的会话状态和接收到的对端BFD报文驱动状态改变，如左下图所示。BFD状态机的建立和拆除都采用三次握手机制，如右下图所示，以确保两端系统都能知道状态的变化。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/5.png"></p>
<blockquote>
<p>•BFD会话过程中包含有三个状态：init和up两个用来建立会话，down用来断开会话。建立和断开会话都需要三次握手确保两端系统都感知到。另外还有一个特殊状态：管理down，使会话可以通过管理手段down，在状态机中管理down也是down状态。每个系统通过报文中的sta域发送本端状态，接收报文中的sta域了解对端状态，综合起来决定状态机的跳转。</p>
<p>•Down状态说明会话down。一个会话会维持在down状态直到收到对端的报文并且该报文的sta字段标志着对端状态不是up。如果收到的是down包，状态机将从down状态跳转到init状态，如果收到的是init包，状态机将从down状态跳转到up状态，如果收到的是up包，状态机维持down状态。</p>
<p>•Init状态说明与远端正在通信，并且本地会话期望进入up状态，但是远端还没回应。一个init状态的会话会维持init状态直到收到对端的init包或者up包，就会跳转到up状态，否则等到检测时间超时以后，便会跳转到down状态，意味着与远端的通信丢失。</p>
<p>•Up状态说明BFD会话成功建立，并且正在确认链路的联通性，会话会一直保持在up状态直到链路故障或者管理down操作。如果收到远端的down包或者检测时间超时会话就会从up状态跳转到down状态。</p>
<p>•管理down意味着会话是被管理操作down的，这会导致远端系统会话进入down状态，并且一直保持down状态直到本端退出管理down。管理down并不意味着转发路径的连通性问题。</p>
</blockquote>
<h2 id="BFD检测模式"><a href="#BFD检测模式" class="headerlink" title="BFD检测模式"></a>BFD检测模式</h2><p>BFD的检测机制：两个系统建立BFD会话，并沿它们之间的路径周期性发送BFD控制报文，如果一方在既定的时间内没有收到BFD控制报文，则认为路径上发生了故障。BFD的检测模式有异步模式和查询模式两种。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/6.png"></p>
<blockquote>
<p>•异步模式和查询模式的本质区别：检测的位置不同，异步模式下本端按一定的发送周期发送BFD控制报文，检测位置为远端，远端检测本端是否周期性发送BFD控制报文；查询模式下本端检测自身发送的BFD控制报文是否得到了回应。</p>
</blockquote>
<h2 id="BFD检测时间"><a href="#BFD检测时间" class="headerlink" title="BFD检测时间"></a>BFD检测时间</h2><p>BFD会话检测时长由TX（Desired Min TX Interval），RX（Required Min RX Interval），DM（Detect Multi）三个参数决定。BFD报文的实际发送时间间隔，实际接受时间间隔由BFD会话协商决定。</p>
<p>▫本地BFD报文实际发送时间间隔＝MAX { 本地配置的发送时间间隔，对端配置的接收时间间隔 }</p>
<p>▫本地BFD报文实际接收时间间隔＝MAX { 对端配置的发送时间间隔，本地配置的接收时间间隔 }</p>
<p>▫本地BFD报文实际检测时间：</p>
<ul>
<li><p>异步模式：本地BFD报文实际检测时间＝本地BFD报文实际接收时间间隔×对端配置的BFD检测倍数</p>
</li>
<li><p>查询模式：本地BFD报文实际检测时间 = 本地BFD报文实际接收时间间隔×本端配置的BFD检测倍数</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/7.png"></p>
<blockquote>
<p>•BFD缺省时间参数</p>
<ul>
<li><p>BFD报文发送间隔默认1000毫秒，接受间隔默认1000毫秒，本地检测倍数3次。</p>
</li>
<li><p>BFD会话等待恢复时间0秒，会话延迟Up时间0秒。</p>
</li>
</ul>
<p>•检测超时倍数，用于检测方计算检测超时时间。</p>
<ul>
<li><p>查询模式：采用本地检测倍数。</p>
</li>
<li><p>异步模式：采用对端检测倍数。</p>
</li>
</ul>
</blockquote>
<h2 id="BFD-Echo功能"><a href="#BFD-Echo功能" class="headerlink" title="BFD Echo功能"></a>BFD Echo功能</h2><p>•BFD Echo功能也称为BFD回声功能，是由本地发送BFD Echo报文，远端系统将报文环回的一种检测机制。</p>
<p>•在两台直接相连的设备中，其中一台设备支持BFD功能（R1）；另一台设备不支持BFD功能（R2），只支持基本的网络层转发。为了能够快速的检测这两台设备之间的故障，可以在支持BFD功能的设备上创建单臂回声功能的BFD会话。支持BFD功能的设备主动发起回声请求功能，不支持BFD功能的设备接收到该报文后直接将其环回，从而实现转发链路的连通性检测功能。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/8.png"></p>
<h1 id="3-BFD应用场景"><a href="#3-BFD应用场景" class="headerlink" title="3.BFD应用场景"></a>3.BFD应用场景</h1><h2 id="联动功能简介"><a href="#联动功能简介" class="headerlink" title="联动功能简介"></a>联动功能简介</h2><p>联动功能由检测模块、Track和应用模块三部分组成。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/9.png"></p>
<blockquote>
<p>•监测模块负责对链路状态、网络性能等进行监测，并将探测结果通知给Track模块 。</p>
<p>•Track模块收到监测模块的探测结果后，及时改变Track项的状态，并通知应用模块。</p>
<p>•应用模块根据Track项的状态，进行相应的处理，从而实现联动。</p>
</blockquote>
<h2 id="静态路由与BFD联动"><a href="#静态路由与BFD联动" class="headerlink" title="静态路由与BFD联动"></a>静态路由与BFD联动</h2><p>•静态路由自身没有检测机制，如果静态路由存在冗余路径，通过静态路由与BFD联动，当主用路径故障时，实现静态路由的快速切换 。</p>
<p>•静态路由与BFD联动应用广泛，如下图中R1是园区网的出口路由器，R1通过两条链路分别连接ISP1和ISP2，正常情况下默认路由经过的链路为指向ISP1的链路，当通往ISP1的链路出现故障的时候，BFD会话能够快速感知，并通知路由器将流量切换到指向ISP2的链路。</p>
<blockquote>
<p>•静态路由自身没有检测机制，如果静态路由存在冗余路径，通过静态路由与BFD联动，当主用路径故障时，实现静态路由的快速切换 。</p>
<p>•静态路由与BFD联动应用广泛，如下图中R1是园区网的出口路由器，R1通过两条链路分别连接ISP1和ISP2，正常情况下默认路由经过的链路为指向ISP1的链路，当通往ISP1的链路出现故障的时候，BFD会话能够快速感知，并通知路由器将流量切换到指向ISP2的链路。</p>
</blockquote>
<h2 id="OSPF与BFD联动-1"><a href="#OSPF与BFD联动-1" class="headerlink" title="OSPF与BFD联动 (1)"></a>OSPF与BFD联动 (1)</h2><p>•OSPF在未绑定BFD的情况下，链路故障检测时间由协议Hello机制决定，通常是秒级。通过绑定BFD，可以实现毫秒级故障检测。</p>
<p>•BFD与OSPF联动就是将BFD和OSPF协议关联起来， BFD将链路故障的快速检测结果告知OSPF协议。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/11.png"></p>
<h2 id="OSPF与BFD联动-2"><a href="#OSPF与BFD联动-2" class="headerlink" title="OSPF与BFD联动 (2)"></a>OSPF与BFD联动 (2)</h2><p>BFD会话建立后会周期性地快速发送BFD报文，如果在检测时间内没有收到BFD报文则认为该双向转发路径发生了故障，通知被服务的上层应用进行相应的处理。</p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/12.png"></p>
<h1 id="4-BFD基本配置"><a href="#4-BFD基本配置" class="headerlink" title="4.BFD基本配置"></a>4.BFD基本配置</h1><h2 id="BFD配置命令介绍"><a href="#BFD配置命令介绍" class="headerlink" title="BFD配置命令介绍"></a>BFD配置命令介绍</h2><p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/13.png"></p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/14.png"></p>
<blockquote>
<p>•配置编辑完成后，用户可以执行<strong>commit</strong>提交配置，使新的配置数据在当前的系统运行配置中生效。</p>
</blockquote>
<h2 id="静态路由与BFD联动配置"><a href="#静态路由与BFD联动配置" class="headerlink" title="静态路由与BFD联动配置"></a>静态路由与BFD联动配置</h2><p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/15.png"></p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/16.png"></p>
<h2 id="BFD会话配置验证"><a href="#BFD会话配置验证" class="headerlink" title="BFD会话配置验证"></a>BFD会话配置验证</h2><p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/17.png"></p>
<h2 id="OSPF与BFD联动配置"><a href="#OSPF与BFD联动配置" class="headerlink" title="OSPF与BFD联动配置"></a>OSPF与BFD联动配置</h2><p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/18.png"></p>
<p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/19.png"></p>
<h2 id="BFD检测配置验证"><a href="#BFD检测配置验证" class="headerlink" title="BFD检测配置验证"></a>BFD检测配置验证</h2><p><img src="/2021/05/17/IP-BFD%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8/20.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）BFD会话建立过程中有以下哪几种状态？</p>
<p><strong>A.Down</strong></p>
<p><strong>B.Init</strong></p>
<p><strong>C.Up</strong></p>
<p>D.Establish</p>
<p>2.（多选题）BFD检测模式有哪些？</p>
<p><strong>A.异步模式</strong></p>
<p>B.同步模式</p>
<p><strong>C.查询模式</strong></p>
<p><strong>D.回声模式</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本章详细介绍了BFD工作原理，内容包括会话建立的过程、检测模式、检测时间以及检测流程。</p>
<p>•BFD会话建立中经过三个不同的状态，包括down、init和up，会话状态建立根据收到报文中的sta字段进行转换。BFD检测模式分为异步检测和查询模式，它们的主要区别不仅是发送检测报文的方式和检测的位置不同，同时检测时间与检测流程也不同。</p>
<p>•BFD能够快速检测链路故障，但是只有被应用模块调用，例如OSPF、静态路由，才能够实现流量路径的快速切换，因此BFD在线网当中应用非常广泛。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/" itemprop="url">IP-VRF基本概念及应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T20:33:30+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/VRF.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•回顾前面学习的课程，您还记得几个名字中带“V”的协议或技术？这些协议或技术又有哪些特点或共同点？</p>
<p>•VRF（Virtual Routing and Rorwarding，虚拟路由转发）技术通过在一台三层转发设备上创建多张路由表实现数据或业务的隔离，常用于MPLS VPN、防火墙等一些需要实现隔离的应用场景。</p>
<p>•本课程将介绍VRF的基本概念及其基本配置方法。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述VRF的基本概念</p>
<p>▫描述VRF的典型应用</p>
<p>▫实现VRF的基本配置</p>
<h1 id="1-VRF基本概念"><a href="#1-VRF基本概念" class="headerlink" title="1.VRF基本概念"></a>1.VRF基本概念</h1><h2 id="网络需求"><a href="#网络需求" class="headerlink" title="网络需求"></a>网络需求</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/1.png"></p>
<h2 id="通过部署ACL实现"><a href="#通过部署ACL实现" class="headerlink" title="通过部署ACL实现"></a>通过部署ACL实现</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/2.png"></p>
<h2 id="通过增加核心交换机实现"><a href="#通过增加核心交换机实现" class="headerlink" title="通过增加核心交换机实现"></a>通过增加核心交换机实现</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/3.png"></p>
<h2 id="通过VRF技术实现"><a href="#通过VRF技术实现" class="headerlink" title="通过VRF技术实现"></a>通过VRF技术实现</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/4.png"></p>
<h2 id="VRF的实现过程"><a href="#VRF的实现过程" class="headerlink" title="VRF的实现过程"></a>VRF的实现过程</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/5.png"></p>
<p>•VRF是对物理设备的一个逻辑划分，每个逻辑单元都被称为一个VPN实例，实例之间在路由层面是隔离的。VRF实现过程如下：</p>
<ol>
<li><p>创建实例，并将三层接口（可以是路由器的物理接口或者子接口，也可以是VLANIF接口）绑定到实例；</p>
</li>
<li><p>（可选）配置与实例绑定的路由协议或静态路由；</p>
</li>
<li><p>基于与实例绑定的接口和路由协议等建立实例路由表并基于实例路由表转发数据，实现实例间隔离。</p>
</li>
</ol>
<blockquote>
<p>•缺省时，一个网络设备的所有接口都属于同一个转发实例——设备的根实例。</p>
<p>当前路由器会有几张路由表呢？</p>
</blockquote>
<h2 id="举例：部署VRF前"><a href="#举例：部署VRF前" class="headerlink" title="举例：部署VRF前"></a>举例：部署VRF前</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/6.png"></p>
<p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/7.png"></p>
<h2 id="举例：创建VPN实例"><a href="#举例：创建VPN实例" class="headerlink" title="举例：创建VPN实例"></a>举例：创建VPN实例</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/8.png"></p>
<p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/9.png"></p>
<h2 id="举例：部署动态路由协议"><a href="#举例：部署动态路由协议" class="headerlink" title="举例：部署动态路由协议"></a>举例：部署动态路由协议</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/10.png"></p>
<p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/11.png"></p>
<h2 id="常见应用场景"><a href="#常见应用场景" class="headerlink" title="常见应用场景"></a>常见应用场景</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/12.png"></p>
<blockquote>
<p>•更多BGP/MPLS IP VPN相关内容，请参考HCIP-Datacom-Advance相关课程。</p>
</blockquote>
<h1 id="2-VRF典型配置案例"><a href="#2-VRF典型配置案例" class="headerlink" title="2.VRF典型配置案例"></a>2.VRF典型配置案例</h1><h2 id="VRF基本配置命令"><a href="#VRF基本配置命令" class="headerlink" title="VRF基本配置命令"></a>VRF基本配置命令</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/13.png"></p>
<p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/14.png"></p>
<h2 id="配置案例-背景介绍与需求分析"><a href="#配置案例-背景介绍与需求分析" class="headerlink" title="配置案例 - 背景介绍与需求分析"></a>配置案例 - 背景介绍与需求分析</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/15.png"></p>
<p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/16.png"></p>
<h2 id="配置案例-配置过程-1"><a href="#配置案例-配置过程-1" class="headerlink" title="配置案例 - 配置过程 (1)"></a>配置案例 - 配置过程 (1)</h2><p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/17.png"></p>
<p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/18.png"></p>
<p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/19.png"></p>
<p><img src="/2021/05/17/IP-VRF%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%BA%94%E7%94%A8/20.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）VRF技术可以实现（  ）的隔离。</p>
<p>A.物理层</p>
<p><strong>B.网络层</strong></p>
<p>C.数据链路层</p>
<p>D.应用层</p>
<p>2.（判断题）缺省情况下，华为数通产品上所有三层接口都属于根实例。</p>
<p><strong>A.正确</strong></p>
<p>B.错误</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•VRF技术实现了同一物理设备上不同网络之间的逻辑隔离，当在物理设备上部署多个VRF实例时，每一个VRF实例就相当于一个虚拟的网络设备。VRF实例之间的接口和路由天然隔离，当同一个物理设备连接到多个相同的网段时，也不用担心IP地址冲突的问题。</p>
<p>•VRF技术广泛应用在防火墙虚拟系统、BGP/MPLS IP VPN等多个场景中。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/" itemprop="url">IP-VPN技术概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T20:19:55+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•对于规模较大的企业来说，网络访问需求不仅仅局限于公司总部网络内，分公司、办事处、出差员工、合作单位等也需要访问公司总部的网络资源，可以采用VPN（Virtual Private Network，虚拟专用网络）技术来实现这一需求。VPN可以在不改变现有网络结构的情况下，建立虚拟专用连接。因其具有廉价、专用和虚拟等多种优势，在现网中应用非常广泛。</p>
<p>•VPN是一类技术的统称，不同的VPN技术拥有不同的特性和实现方式，常见的VPN技术包括IPSec VPN、GRE VPN、L2TP VPN、MPLS VPN等。</p>
<p>•本课程将从VPN的定义、常见的VPN类型与应用场景等几个方面对VPN进行一个简单而又全面的介绍。</p>
<blockquote>
<p>•IPSec：Internet Protocol Security， 因特网协议安全协议。</p>
<p>•GRE：Generic Routing Encapsulation， 通用路由封装协议。</p>
<p>•L2TP：Layer 2 Tunneling Protocol， 二层隧道协议。</p>
<p>•MPLS：Multiprotocol Label Switching，多协议标签交换协议。</p>
</blockquote>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述VPN的分类</p>
<p>▫描述VPN的实现方式</p>
<h1 id="1-什么是VPN"><a href="#1-什么是VPN" class="headerlink" title="1.什么是VPN"></a>1.什么是VPN</h1><h2 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h2><p>•在VPN出现之前，企业分支之间的数据传输只能依靠现有物理网络（例如Internet）。由于Internet中存在多种不安全因素，报文容易被网络中的黑客窃取或篡改，最终造成数据泄密、重要数据被破坏等后果。</p>
<p>•除了通过Internet，还可以通过搭建一条物理专网连接保证数据的安全传输，但其费用会非常昂贵，且专网的搭建和维护十分困难。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/1.png"></p>
<h2 id="VPN简介"><a href="#VPN简介" class="headerlink" title="VPN简介"></a>VPN简介</h2><p>VPN即虚拟专用网，泛指通过VPN技术在公用网络上构建的虚拟专用网络。VPN用户在此虚拟网络中传输私网流量，在不改变网络现状的情况下实现安全、可靠的连接。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/2.png"></p>
<blockquote>
<p>•VPN和传统的数据专网相比具有如下优势：</p>
<ul>
<li><p>安全：在远端用户、驻外机构、合作伙伴、供应商与公司总部之间建立可靠的连接，保证数据传输的安全性。这对于实现电子商务或金融网络与通讯网络的融合特别重要。</p>
</li>
<li><p>廉价：利用公共网络进行信息通讯，企业可以用更低的成本连接远程办事机构、出差人员和业务伙伴。</p>
</li>
<li><p>支持移动业务：支持驻外VPN用户在任何时间、任何地点的移动接入，能够满足不断增长的移动业务需求。</p>
</li>
<li><p>可扩展性：由于VPN为逻辑上的网络，物理网络中增加或修改节点，不影响VPN的部署。</p>
</li>
</ul>
<p>•公共网络又经常被称为VPN骨干网（VPN Backbone），公共网络可以是Internet，也可以是企业自建专网或运营商租赁专网。</p>
</blockquote>
<h2 id="VPN分类-根据建设单位不同"><a href="#VPN分类-根据建设单位不同" class="headerlink" title="VPN分类 - 根据建设单位不同"></a>VPN分类 - 根据建设单位不同</h2><p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/3.png"></p>
<h2 id="VPN分类-根据组网方式不同"><a href="#VPN分类-根据组网方式不同" class="headerlink" title="VPN分类 - 根据组网方式不同"></a>VPN分类 - 根据组网方式不同</h2><p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/4.png"></p>
<h2 id="VPN分类-根据实现的网络层次"><a href="#VPN分类-根据实现的网络层次" class="headerlink" title="VPN分类 - 根据实现的网络层次"></a>VPN分类 - 根据实现的网络层次</h2><p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/5.png"></p>
<blockquote>
<p>•工作在网络层和数据链路层的VPN又被称为三层VPN和二层VPN。</p>
</blockquote>
<h2 id="VPN关键技术-隧道技术"><a href="#VPN关键技术-隧道技术" class="headerlink" title="VPN关键技术 - 隧道技术"></a>VPN关键技术 - 隧道技术</h2><p>•VPN技术的基本原理是利用隧道（Tunnel）技术，对传输报文进行封装，利用VPN骨干网建立专用数据传输通道，实现报文的安全传输。</p>
<p>•位于隧道两端的VPN网关，通过对原始报文的“封装”和“解封装”，建立一个点到点的虚拟通信隧道。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/6.png"></p>
<blockquote>
<p>•隧道的功能就是在两个网络节点之间提供一条通路，使数据能够在这个通路上透明传输。VPN隧道一般是指在VPN骨干网的VPN节点之间建立的用来传输VPN数据的虚拟连接。隧道是构建VPN不可或缺的部分，用于把VPN数据从一个VPN节点透明传送到另一个上。</p>
<p>•隧道通过隧道协议实现。目前已存在不少隧道协议，如GRE（Generic Routing Encapsulation）、L2TP（Layer 2 Tunneling Protocol）等。隧道协议通过在隧道的一端给数据加上隧道协议头，即进行封装，使这些被封装的数据能都在某网络中传输，并且在隧道的另一端去掉该数据携带的隧道协议头，即进行解封装。报文在隧道中传输前后都要通过封装和解封装两个过程。</p>
<p>•部分隧道可以混合使用，如GRE Over IPSec隧道。</p>
</blockquote>
<h2 id="VPN关键技术-身份认证、数据加密与验证"><a href="#VPN关键技术-身份认证、数据加密与验证" class="headerlink" title="VPN关键技术 - 身份认证、数据加密与验证"></a>VPN关键技术 - 身份认证、数据加密与验证</h2><p>身份认证、数据加密和认证技术可以有效保证VPN网络与数据的安全性：</p>
<ul>
<li><p>身份认证：可用于部署了远程接入VPN的场景，VPN网关对用户的身份进行认证，保证接入网络的都是合法用户而非恶意用户。也可以用于VPN网关之间对对方身份的认证。</p>
</li>
<li><p>数据加密：将明文通过加密变成密文，使得数据即使被黑客截获，黑客也无法获取其中的信息。</p>
</li>
<li><p>数据验证：通过数据验证技术对报文的完整性和真伪进行检查，丢弃被伪造和被篡改的报文。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/7.png"></p>
<h1 id="2-常见VPN技术"><a href="#2-常见VPN技术" class="headerlink" title="2.常见VPN技术"></a>2.常见VPN技术</h1><h2 id="IPSec概述"><a href="#IPSec概述" class="headerlink" title="IPSec概述"></a>IPSec概述</h2><p>IPSec（IP Security） VPN一般部署在企业出口设备之间，通过加密与验证等方式，实现了数据来源验证、数据加密、数据完整性保证和抗重放等功能。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/8.png"></p>
<blockquote>
<p>•数据来源验证：接收方验证发送方身份是否合法。</p>
<p>•数据加密：发送方对数据进行加密，以密文的形式在Internet上传送，接收方对接收的加密数据进行解密后处理或直接转发。</p>
<p>•数据完整性：接收方对接收的数据进行验证，以判定报文是否被篡改。</p>
<p>•抗重放：接收方拒绝旧的或重复的数据包，防止恶意用户通过重复发送捕获到的数据包所进行的攻击。</p>
</blockquote>
<h2 id="IPSec协议体系"><a href="#IPSec协议体系" class="headerlink" title="IPSec协议体系"></a>IPSec协议体系</h2><p>IPSec不是一个单独的协议，它给出了IP网络上数据安全的一整套体系结构，包括AH（Authentication Header）、ESP（Encapsulating Security Payload）、IKE（Internet Key Exchange）等协议。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/9.png"></p>
<blockquote>
<p>•IPSec使用认证头AH（Authentication Header）和封装安全载荷ESP（Encapsulating Security Payload）两种安全协议来传输和封装数据，提供认证或加密等安全服务。</p>
<ul>
<li><p>AH和ESP协议提供的安全功能依赖于协议采用的验证、加密算法。</p>
</li>
<li><p>AH仅支持认证功能，不支持加密功能。ESP支持认证和加密功能。</p>
</li>
<li><p>安全协议提供认证或加密等安全服务需要有秘钥的存在。</p>
</li>
</ul>
<p>•秘钥交换的方式有两种：</p>
<ul>
<li><p>带外共享密钥：在发送、接收设备上手工配置静态的加密、验证密钥。双方通过带外共享的方式（例如通过电话或邮件方式）保证密钥一致性。这种方式的缺点是可扩展性差，在点到多点组网中配置密钥的工作量成倍增加。另外，为提升网络安全性需要周期性修改密钥，这种方式下也很难实施。</p>
</li>
<li><p>通过IKE协议自动协商密钥：IKE建立在Internet安全联盟和密钥管理协议ISAKMP定义的框架上，采用DH（Diffie-Hellman）算法在不安全的网络上安全地分发密钥。这种方式配置简单，可扩展性好，特别是在大型动态的网络环境下此优点更加突出。同时，通信双方通过交换密钥交换材料来计算共享的密钥，即使第三方截获了双方用于计算密钥的所有交换数据，也无法计算出真正的密钥。</p>
</li>
</ul>
</blockquote>
<h2 id="IPSec基本原理"><a href="#IPSec基本原理" class="headerlink" title="IPSec基本原理"></a>IPSec基本原理</h2><p>IPSec隧道建立过程中需要协商IPSec SA（Security Association，安全联盟），IPSec SA一般通过IKE协商生成。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/10.png"></p>
<blockquote>
<p>•SA由一个三元组来唯一标识，这个三元组包括安全参数索引SPI（Security Parameter Index）、目的IP地址和使用的安全协议号（AH或ESP）。其中，SPI是为唯一标识SA而生成的一个32位比特的数值，它在AH和ESP头中传输。在手工配置SA时，需要手工指定SPI的取值。使用IKE协商产生SA时，SPI将随机生成。</p>
<p>•SA是单向的逻辑连接，因此两个IPSec对等体之间的双向通信，最少需要建立两个SA来分别对两个方向的数据流进行安全保护。</p>
<p>•IKE作为秘钥协商协议，存在两个版本：IKEv1和IKEv2，本课程采用IKEv1为例进行介绍，IKEv2内容可参考产品文档对应内容。</p>
<ul>
<li><p>IKEv1协商阶段1的目的是建立IKE SA。IKE SA建立后对等体间的所有ISAKMP消息都将通过加密和验证，这条安全通道可以保证IKEv1第二阶段的协商能够安全进行。IKE SA是一个双向的逻辑连接，两个IPSec对等体间只建立一个IKE SA。</p>
</li>
<li><p>IKEv1协商阶段2的目的就是建立用来安全传输数据的IPSec SA，并为数据传输衍生出密钥。该阶段使用IKEv1协商阶段1中生成的密钥对ISAKMP消息的完整性和身份进行验证，并对ISAKMP消息进行加密，故保证了交换的安全性。</p>
</li>
</ul>
<p>•IKE协商成功意味着双向的IPSec隧道已经建立，可以通过ACL方式或者安全框架方式定义IPSec“感兴趣流”，符合感兴趣流流量特征的数据都将被送入IPSec隧道进行处理。</p>
<p>•感兴趣流：需要被IPSec保护的数据流。</p>
</blockquote>
<h2 id="GRE概述"><a href="#GRE概述" class="headerlink" title="GRE概述"></a>GRE概述</h2><p>通用路由封装协议（General Routing Encapsulation，GRE）是一种三层VPN封装技术。GRE可以对某些网络层协议（如IPX、IPv4、IPv6等）的报文进行封装，使封装后的报文能够在另一种网络中（如IPv4）传输，从而解决了跨越异种网络的报文传输问题。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/11.png"></p>
<blockquote>
<p>•如图所示，通过在IPv4网络上建立GRE隧道，解决了两个IPv6网络的通信问题。</p>
<p>•GRE还具备封装组播报文的能力。由于动态路由协议中会使用组播报文，因此更多时候GRE会在需要传递组播路由数据的场景中被用到，这也是GRE被称为通用路由封装协议的原因。</p>
</blockquote>
<h2 id="GRE基本原理"><a href="#GRE基本原理" class="headerlink" title="GRE基本原理"></a>GRE基本原理</h2><p>•GRE构成要素分为3个部分：乘客协议、封装协议和运输协议。</p>
<p>▫乘客协议是指用户在传输数据时所使用的原始网络协议。</p>
<p>▫封装协议的作用就是用来“包装”乘客协议对应的报文，使原始报文能够在新的网络中传输。</p>
<p>▫运输协议是指被封装以后的报文在新网络中传输时所使用的网络协议。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/12.png"></p>
<blockquote>
<p>•隧道接口（Tunnel Interface）是为实现报文的封装而提供的一种点对点类型的虚拟接口，与Loopback接口类似，都是一种逻辑接口。</p>
<p>•如图所示，乘客协议为IPv6，封装协议为GRE，运输协议为IPv4。整体转发流程如下：</p>
<ol>
<li><p>当R1收到IP1发来的IPv6数据包，查询设备路由表，发现出接口是隧道接口，则将此报文发给隧道接口处理。</p>
</li>
<li><p>隧道接口给原始报文添加GRE头部，然后根据配置信息，给报文加上IP头。该IP头的源地址就是隧道源地址，IP头的目的地址就是隧道目的地址。</p>
</li>
<li><p>封装后的报文在IPv4网络中进行普通的IPv4路由转发，最终到达目的地R2。</p>
</li>
<li><p>解封装过程和封装过程相反，这里不再赘述。</p>
</li>
</ol>
</blockquote>
<h2 id="GRE-Over-IPSec"><a href="#GRE-Over-IPSec" class="headerlink" title="GRE Over IPSec"></a>GRE Over IPSec</h2><p>•GRE的主要缺点是不支持加密和认证，数据的安全传输得不到很好的保障。</p>
<p>•IPSec的主要缺点是只支持IP协议，且不支持组播。</p>
<p>•可通过部署GRE Over IPSec结合两种VPN技术的优点。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/13.png"></p>
<h2 id="L2TP概述"><a href="#L2TP概述" class="headerlink" title="L2TP概述"></a>L2TP概述</h2><p>•L2TP是虚拟私有拨号网VPDN（Virtual Private Dial-up Network）隧道协议的一种，它扩展了点到点协议PPP的应用，是一种在远程办公场景中为出差员工或企业分支远程访问企业内网资源提供接入服务的VPN。</p>
<p>•L2TP组网架构中包括LAC（L2TP Access Concentrator，L2TP访问集中器）和LNS（L2TP Network Server，L2TP网络服务器）</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/14.png"></p>
<blockquote>
<p>•VPDN是指利用公共网络（如ISDN和PSTN）的拨号功能及接入网来实现虚拟专用网，为企业、小型ISP、移动办公人员提供接入服务。VPDN采用专用的网络加密通信协议，在公共网络上为企业建立安全的虚拟专网。企业驻外机构和出差人员可从远程经由公共网络，通过虚拟加密隧道实现和企业总部之间的网络连接，而公共网络上其它用户则无法穿过虚拟隧道访问企业网内部的资源。VPDN隧道协议有多种，目前使用最广泛的是L2TP。</p>
<p>•LAC是网络上具有PPP和L2TP协议处理能力的设备。LAC负责和LNS建立L2TP隧道连接。在不同的组网环境中，LAC可以是不同的设备，可以是一台网关设备，也可以是一台终端设备。LAC可以发起建立多条L2TP隧道使数据流之间相互隔离。</p>
<p>•LNS是LAC的对端设备，即LAC和LNS建立了L2TP隧道；LNS位于企业总部私网与公网边界，通常是企业总部的网关设备。</p>
</blockquote>
<h2 id="L2TP消息"><a href="#L2TP消息" class="headerlink" title="L2TP消息"></a>L2TP消息</h2><p>L2TP协议包含两种类型的消息，控制消息和数据消息，消息的传输在LAC和LNS之间进行。</p>
<p>​    ▫控制消息用于L2TP隧道和会话连接的建立、维护和拆除。</p>
<p>​    ▫数据消息用于封装PPP数据帧并在隧道上传输。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/15.png"></p>
<blockquote>
<p>•控制消息</p>
<ul>
<li><p>用于L2TP隧道和会话连接的建立、维护和拆除。在控制消息的传输过程中，使用消息丢失重传和定时检测隧道连通性等机制来保证控制消息传输的可靠性，支持对控制消息的流量控制和拥塞控制。</p>
</li>
<li><p>控制消息承载在L2TP控制通道上，控制通道实现了控制消息的可靠传输，将控制消息封装在L2TP报头内，再经过IP网络传输。</p>
</li>
</ul>
<p>•数据消息</p>
<ul>
<li><p>用于封装PPP数据帧并在隧道上传输。数据消息是不可靠的传输，不重传丢失的数据报文，不支持对数据消息的流量控制和拥塞控制。</p>
</li>
<li><p>数据消息携带PPP帧承载在不可靠的数据通道上，对PPP帧进行L2TP封装，再经过IP网络传输。</p>
</li>
</ul>
</blockquote>
<h2 id="L2TP工作过程"><a href="#L2TP工作过程" class="headerlink" title="L2TP工作过程"></a>L2TP工作过程</h2><p>L2TP主要可分为以下三种工作场景，其工作过程并不相同：</p>
<p>​    ▫NAS-Initiated场景：拨号用户通过NAS访问企业内网</p>
<p>​    ▫Client-Initiated场景：移动办公用户访问企业内网</p>
<p>​    ▫Call-LNS场景：通过LAC自主拨号实现企业内网互连</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/16.png"></p>
<blockquote>
<p>•NAS-Initiated场景：由远程拨号用户发起，远程系统通过PSTN/ISDN拨入LAC，由LAC通过Internet向LNS发起建立隧道连接请求。拨号用户地址由LNS分配；对远程拨号用户的验证与计费既可由LAC侧的代理完成，也可在LNS完成。</p>
<ul>
<li><p>用户必须采用PPP的方式接入到Internet，也可以是PPPoE等协议。</p>
</li>
<li><p>运营商的接入设备（主要是BAS设备）需要开通相应的VPN服务。用户需要到运营商处申请该业务。</p>
</li>
<li><p>L2TP隧道两端分别驻留在LAC侧和LNS侧，且一个L2TP隧道可以承载多个会话。</p>
</li>
</ul>
<p>•Client-Initialized场景：直接由LAC客户（指可在本地支持L2TP协议的用户）发起。客户需要知道LNS的IP地址。LAC客户可直接向LNS发起隧道连接请求，无需再经过一个单独的LAC设备。在LNS设备上收到了LAC客户的请求之后，根据用户名、密码进行验证，并且给LAC客户分配私有IP地址。</p>
<ul>
<li>用户需要安装L2TP的拔号软件。部分操作系统自带L2TP客户端软件。</li>
<li>用户上网的方式和地点没有限制，不需ISP介入。</li>
<li>L2TP隧道两端分别驻留在用户侧和LNS侧，一个L2TP隧道承载一个L2TP会话。</li>
<li>该场景建立过程如下：</li>
</ul>
<ol>
<li><p>移动办公用户与LNS建立L2TP隧道。</p>
</li>
<li><p>移动办公用户与LNS建立L2TP会话：移动办公用户在第3步会与LNS间建立PPP连接，L2TP会话用来记录和管理它们之间的PPP连接状态。因此，在建立PPP连接以前，隧道双方需要为PPP连接预先协商出一个L2TP会话。会话中携带了移动办公用户的LCP协商信息和用户认证信息，LNS对收到的信息认证通过后，通知移动办公用户会话建立成功。L2TP会话连接由会话ID进行标识。</p>
</li>
<li><p>移动办公用户与LNS建立PPP连接。移动办公用户通过与LNS建立PPP连接获取LNS分配的企业内网IP地址。</p>
</li>
<li><p>移动办公用户发送业务报文访问企业总部服务器。</p>
</li>
</ol>
<p>•Call-LNS场景：L2TP除了可以为出差员工提供远程接入服务以外，还可以进行企业分支与总部的内网互联，实现分支用户与总部用户的互访。一般是由分支路由器充当LAC与LNS建立L2TP隧道，这样就可实现分支与总部网络之间的数据通过L2TP隧道互通。</p>
</blockquote>
<h2 id="L2TP-Over-IPSec"><a href="#L2TP-Over-IPSec" class="headerlink" title="L2TP Over IPSec"></a>L2TP Over IPSec</h2><p>当企业对数据和网络的安全性要求较高时，L2TP无法为报文传输提供足够的保护。这时可以和IPSec功能结合使用，保护传输的数据，有效避免数据被截取或攻击。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/17.png"></p>
<blockquote>
<p>•企业出差用户和总部通信，使用L2TP功能建立VPN连接，总部部署为LNS对接入的用户进行认证。当出差用户需要向总部传输高机密信息时，L2TP无法为报文传输提供足够的保护，这时可以和IPSec功能结合使用，保护传输的数据。在出差用户的PC终端上运行拨号软件，将数据报文先进行L2TP封装，再进行IPSec封装，发往总部。在总部网关，部署IPSec策略，最终还原数据。这种方式IPSec功能会对所有源地址为LAC、目的地址为LNS的报文进行保护。</p>
</blockquote>
<h2 id="MPLS-VPN概述"><a href="#MPLS-VPN概述" class="headerlink" title="MPLS VPN概述"></a>MPLS VPN概述</h2><p>•MPLS是一种利用标签（Label）进行转发的技术，最初为了提高IP报文转发速率而被提出，现主要应用于VPN和流量工程、QoS等场景。 </p>
<p>•根据部署的不同，MPLS VPN可分为MPLS L2 VPN或者MPLS L3 VPN。</p>
<p>•企业可以自建MPLS专网也可以通过租用运营商MPLS专网的方式获得MPLS VPN接入服务。</p>
<p><img src="/2021/05/17/IP-VPN%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0/18.png"></p>
<blockquote>
<p>•MPLS VPN网络一般由运营商搭建，VPN用户购买VPN服务来实现用户网络之间（图中的分公司和总公司）的路由传递、数据互通等。</p>
<p>•基本的MPLS VPN网络架构由CE（Customer Edge）、PE（Provider Edge）和P（Provider）三部分组成：</p>
<ul>
<li><p>CE：用户网络边缘设备，有接口直接与运营商网络相连。CE可以是路由器或交换机，也可以是一台主机。通常情况下，CE“感知”不到VPN的存在，也不需要支持MPLS。</p>
</li>
<li><p>PE：运营商边缘路由器，是运营商网络的边缘设备，与CE直接相连。在MPLS网络中，对VPN的所有处理都发生在PE上，对PE性能要求较高。</p>
</li>
<li><p>P：运营商网络中的骨干路由器，不与CE直接相连。P设备只需要具备基本MPLS转发能力，不维护VPN相关信息。</p>
</li>
</ul>
<p>•更多MPLS及MPLS VPN的相关内容，参考HCIP-Datacom-Advance相应课程。</p>
</blockquote>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（判断题）L2TP VPN工作在网络层。</p>
<p>A. 正确</p>
<p><strong>B. 错误</strong></p>
<p>2.（多选题）IPSec SA包含以下哪些内容？</p>
<p><strong>A. SPI</strong></p>
<p><strong>B. 安全协议</strong></p>
<p>C. 源地址</p>
<p><strong>D. 目的地址</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•VPN技术拥有安全、廉价、支持移动业务、灵活等一系列优势，已经成为现网中部署最为广泛的一类技术。</p>
<p>•本课程从VPN基本概念与分类出发，简单介绍了如下几类常见VPN技术：</p>
<ul>
<li><p>IPSec VPN：是一系列为IP网络提供安全性的协议和服务的集合，为IP网络提供安全的传输。</p>
</li>
<li><p>GRE VPN：提供了将一种协议的报文封装在另一种协议报文中的机制，解决异种网络的传输问题。</p>
</li>
<li><p>L2TP VPN：是一种能够提供移动用户远程接入服务的二层VPN技术。</p>
</li>
<li><p>MPLS VPN：一种通过标签交换技术，实现站点与站点之间互联的VPN技术。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/" itemprop="url">IP-网络设备安全特性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T20:03:25+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•由于IP网络规模庞大，导致网络设备数量众多、通信协议层出不穷。同时，IP网络的管理也变得极其复杂，安全性和业务灵活性以及安全性和管理维护便利性之间存在着矛盾。不同技术能力、管理水平的管理人员，对这些矛盾的处理能力也参差不齐。管理员往往追求业务可用性，而忽略了安全防御能力，导致必要的安全措施没有得到妥善的配置，设备本身的安全能力无法发挥。</p>
<p>•本课程主要介绍常见的网络设备安全加固策略，对一些常见的安全配置进行了举例说明。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述常见的设备安全加固策略。</p>
<p>▫实现Stelnet的配置。</p>
<p>▫实现本机防攻击的配置。</p>
<h1 id="1-常见设备安全加固策略"><a href="#1-常见设备安全加固策略" class="headerlink" title="1.常见设备安全加固策略"></a>1.<strong>常见设备安全加固策略</strong></h1><h2 id="为什么需要网络设备安全"><a href="#为什么需要网络设备安全" class="headerlink" title="为什么需要网络设备安全"></a>为什么需要网络设备安全</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/1.png"></p>
<h2 id="常见设备安全加固策略"><a href="#常见设备安全加固策略" class="headerlink" title="常见设备安全加固策略"></a>常见设备安全加固策略</h2><p>常见的设备安全加固策略主要可以从以下方面部署：</p>
<p>​    ▫关闭不使用的业务和协议端口</p>
<p>​    ▫废弃不安全的访问通道</p>
<p>​    ▫基于可信路径的访问控制</p>
<p>​    ▫本机防攻击</p>
<h2 id="关闭不使用的业务和协议端口"><a href="#关闭不使用的业务和协议端口" class="headerlink" title="关闭不使用的业务和协议端口"></a>关闭不使用的业务和协议端口</h2><p>在分析业务需求的基础上，按照最小授权原则，关闭不使用的业务和协议端口。</p>
<ul>
<li><p>不使用的物理端口，应该默认配置为关闭，即使插上网线也不能通信</p>
</li>
<li><p>不使用的协议端口，应该默认配置为关闭，不对外提供访问。如常见的telnet、FTP、HTTP等端口。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/2.png"></p>
<h2 id="废弃不安全的访问通道"><a href="#废弃不安全的访问通道" class="headerlink" title="废弃不安全的访问通道"></a>废弃不安全的访问通道</h2><p>在业务需求分析的基础上，优先满足业务的访问需求。在同一个访问需求有多种访问通道服务的情况下，废弃不安全的访问通道，而选择安全的访问通道。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/3.png"></p>
<blockquote>
<p>•通过命令行、WEB、网管等方式登录设备时，建议采用安全加密的通道SSH、HTTPS、SNMPv3。</p>
<p>•设备之间，以及设备和终端之间数据传输，也建议采用加密的数据传输协议SFTP。</p>
</blockquote>
<h2 id="安全的数据访问通道"><a href="#安全的数据访问通道" class="headerlink" title="安全的数据访问通道"></a>安全的数据访问通道</h2><p>•为保证设备安全，尽量选择安全的访问通道。</p>
<p>•设备数据传输安全常见场景及采用协议：</p>
<p>▫用户远程登录：</p>
<ul>
<li><p>Telnet：采用TCP协议进行明文传输。</p>
</li>
<li><p>STelnet：基于SSH协议，提供安全的信息保障和强大的认证功能。</p>
</li>
</ul>
<p>▫设备文件操作：</p>
<ul>
<li>FTP：支持文件传输以及文件目录的操作，具有授权和认证功能，明文传输数据。</li>
<li>TFTP：只支持文件传输，不支持授权和认证，明文传输数据。</li>
<li>SFTP：支持文件传输及文件目录的操作，数据进行了严格加密和完整性保护。</li>
</ul>
<h2 id="SSH概述"><a href="#SSH概述" class="headerlink" title="SSH概述"></a>SSH概述</h2><p>•SSH(Secure Shell，安全外壳协议)，在非安全网络上提供了安全的远程登录、安全文件传输以及TCP/IP安全隧道。不仅在登陆过程中对密码进行加密传送，而且对登陆后执行的命令的数据也进行加密。</p>
<p>•合法用户通过客户端登录，完成用户名以及对应的密码验证后，客户端会尝试和服务端建立会话，每个会话是一个独立的逻辑通道，可以提供给不同的上层应用使用。</p>
<p>•STelnet和SFTP各自利用了其中的一个逻辑通道，通过SSH对数据进行加密，从而实现数据的安全传输。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/4.png"></p>
<blockquote>
<p>•SSH协议由IETF制订，最新版本是V2.0，1.3和1.5版本存在安全隐患，已经逐步被淘汰。</p>
<p>•SSH支持服务端和客户端的双向认证，提供保密性和完整性等安全服务。</p>
</blockquote>
<h2 id="SSH协议结构"><a href="#SSH协议结构" class="headerlink" title="SSH协议结构"></a>SSH协议结构</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/5.png"></p>
<p>SSH协议框架中最主要的部分是三个协议：传输层协议、用户认证协议和连接协议。</p>
<ul>
<li><p>传输层协议：提供版本协商，加密算法协商，密钥交换，服务端认证以及信息完整性支持。</p>
</li>
<li><p>用户认证协议：为服务器提供客户端的身份鉴别。</p>
</li>
<li><p>连接协议：将加密的信息隧道复用为多个逻辑通道，提供给高层的应用协议（STelnet、SFTP）使用；各种高层应用协议可以相对地独立于SSH基本体系之外，并依靠这个基本框架，通过连接协议使用SSH的安全机制。</p>
</li>
</ul>
<blockquote>
<p>•SSH中用到的算法主要有几类：</p>
<ul>
<li><p>用于数据完整性保护的MAC算法，如hmac-md5、hmac-md5-96等；</p>
</li>
<li><p>用于数据信息加密的算法，如3des-cbc、aes128-cbc、des-cbc等；</p>
</li>
<li><p>用于产生会话密钥的密钥交换算法，如diffle-hellman-group-exchange-sha1等；</p>
</li>
<li><p>用于进行数字签名和认证的主机公钥算法，如RSA、DSA等；</p>
</li>
</ul>
<p>•RSA（Rivest-Shamir-Adleman）加密算法，一种非对称加密算法。RSA是1977年由罗纳德·李维斯特（Ron Rivest）、阿迪·萨莫尔（Adi Shamir）和伦纳德·阿德曼（Leonard Adleman）一起提出的。RSA就是他们三人姓氏开头字母拼在一起组成的。</p>
<p>•DES（Data Encryption Standard）数据加密标准。DES使用一个56比特的密钥。</p>
<p>•3DES（Triple Data Encryption Standard），是DES的一个更安全的变形。它使用3条56位的密钥对数据进行三次加密。</p>
<p>•DSA（Digital Signature Algorithm）数字签名算法。</p>
<p>•对称密钥技术：</p>
<ul>
<li>对称密钥加密又叫专用密钥加密，即发送和接收数据的双方必使用相同的密钥对明文进行加密和解密运算。对称密钥加密算法主要包括：DES、3DES等。</li>
</ul>
<p>•公开密钥技术：</p>
<ul>
<li>公钥加密算法也称非对称密钥算法，用两对密钥：一个公共密钥和一个专用密钥。用户要保障专用密钥的安全；公共密钥则可以发布出去。公共密钥与专用密钥是有紧密关系的，用公共密钥加密的信息只能用专用密钥解密，反之亦然。由于公钥算法不需要联机密钥服务器，密钥分配协议简单，所以极大简化了密钥管理。除加密功能外，公钥系统还可以提供数字签名。</li>
</ul>
<p>•机密性（Confidentiality）：指信息在存储、传输、使用的过程中，不会被泄漏给非授权用户或实体；</p>
<p>•完整性（Integrity）：指信息在存储、传输、使用的过程中，不会被非授权用户篡改或防止授权用户对信息进行不恰当的篡改；</p>
<p>•可用性（Availability）：指确保授权用户或实体对信息资源的正常使用不会被异常拒绝，允许其可靠而及时地访问信息资源。</p>
</blockquote>
<h2 id="基于可信路径的访问控制"><a href="#基于可信路径的访问控制" class="headerlink" title="基于可信路径的访问控制"></a>基于可信路径的访问控制</h2><p>•可以在设备上部署基于可信路径的访问控制策略，以提升网络的安全性。</p>
<p>•部署URPF，可以判定某个报文的源地址是否合法，如果该报文的路径与URPF学习的路径不符，丢弃该报文，用URPF可以有效防范IP地址欺骗。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/6.png"></p>
<blockquote>
<p>•IP网络的开放性决定了，只要路由可达，任何人都可以对目标主机进行访问或者攻击。</p>
<p>•对于某一个主机而言，访问它的客户端的报文历经的路径通常是固定的，尤其是在网络边缘，这种路径的固定特性表现得更加明显。</p>
<p>•URPF（Unicast Reverse Path Forwarding，单播逆向路径转发）分为严格模式和松散模式以及允许匹配缺省路由的方式。其原理是当设备转发IP报文时，检查数据报文的源IP地址是否合法，检查的原理是根据数据包的源IP地址查路由表。</p>
<ul>
<li>对于严格模式：如果报文能匹配明细路由，并且入接口跟匹配路由的出接口一致，则允许报文上送，否则丢弃报文。</li>
<li>对于松散模式：如果报文匹配上明细路由，则运行报文上送，否则丢弃报文，不检查接口是否匹配。默认情况下，会认为缺省路由不存在，不会去匹配缺省路由，只有进行了配置时候，才会去匹配缺省路由的。</li>
<li>对允许匹配缺省路由的模式，必须和严格模式一起配置，报文匹配明细路由或者缺省路由，并且报文入接口跟匹配路由的出接口一致才上送，否则丢弃。不支持缺省路由与松散模式一起配置，因为这样无法达到防攻击的效果。松散模式和严格模式互斥，只能配置一种模式。</li>
</ul>
</blockquote>
<h2 id="本机防攻击"><a href="#本机防攻击" class="headerlink" title="本机防攻击"></a>本机防攻击</h2><p>•在网络中，存在着大量针对CPU的恶意攻击报文以及需要正常上送CPU的各类报文。针对CPU的恶意攻击报文会导致CPU长时间繁忙的处理攻击报文，从而引发其他业务的断续甚至系统的中断；大量正常的报文也会导致CPU占用率过高，性能下降，从而影响正常的业务。</p>
<p>•为了保护CPU，保证CPU对正常业务的处理和响应，设备提供了本机防攻击功能。本机防攻击针对的是上送CPU的报文，主要用于保护设备自身安全，保证已有业务在发生攻击时的正常运转，避免设备遭受攻击时各业务的相互影响。</p>
<p>•本机防攻击包括CPU防攻击和攻击溯源两部分。</p>
<ul>
<li><p>CPU防攻击针对上送CPU的报文进行限制和约束，使单位时间内上送CPU报文的数量限制在一定的范围之内，从而保护CPU的安全，保证CPU对业务的正常处理。</p>
</li>
<li><p>攻击溯源针对DoS（Denial of Service，拒绝服务）攻击进行防御。设备通过对上送CPU的报文进行分析统计，然后对统计的报文设置一定的阈值，将超过阈值的报文判定为攻击报文，再对这些攻击报文根据报文信息找出攻击源用户或者攻击源接口，最后通过日志、告警等方式提醒管理员以便管理员采用一定的措施来保护设备，或者直接丢弃攻击报文以对攻击源进行惩罚。</p>
</li>
</ul>
<h2 id="CPU防攻击"><a href="#CPU防攻击" class="headerlink" title="CPU防攻击"></a>CPU防攻击</h2><p>•多级安全机制，保证设备的安全，实现了对设备的分级保护。设备通过以下策略实现对设备的分级保护：</p>
<ul>
<li><p>第一级：通过黑名单来过滤上送CPU的非法报文。</p>
</li>
<li><p>第二级：CPCAR（Control Plane Committed Access Rate）。对上送CPU的报文按照协议类型进行速率限制，保证每种协议上送CPU的报文不会过多。</p>
</li>
<li><p>第三级：对上送CPU的报文，按照协议优先级进行调度，保证优先级高的协议先得到处理。</p>
</li>
<li><p>第四级：对上送CPU的报文统一限速，对超过统一限速值的报文随机丢弃，保证整体上送CPU的报文不会过多，保护CPU安全。 </p>
</li>
</ul>
<p>•动态链路保护功能的CPU报文限速，是指当设备检测到SSH Session数据、Telnet Session数据、HTTP Session数据、FTP Session数据以及BGP Session数据建立时，会启动对此Session的动态链路保护功能，后续上送报文如匹配此Session特征信息，此类数据将会享受高速率上送的权利，由此保证了此Session相关业务的运行可靠性、稳定性。</p>
<h2 id="攻击溯源原理"><a href="#攻击溯源原理" class="headerlink" title="攻击溯源原理"></a>攻击溯源原理</h2><p>•攻击溯源包括报文解析、流量分析、攻击源识别和发送日志告警通知管理员以及实施惩罚四个过程。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/7.png"></p>
<p>•通过图中所示的四个过程，找出攻击源，然后管理员通过ACL或配置黑名单的方式限制攻击源，以保护设备CPU。 </p>
<h1 id="2-网络设备安全加固部署示例"><a href="#2-网络设备安全加固部署示例" class="headerlink" title="2.网络设备安全加固部署示例"></a>2.网络设备安全加固部署示例</h1><h2 id="STelnet配置"><a href="#STelnet配置" class="headerlink" title="STelnet配置"></a>STelnet配置</h2><h3 id="SSH基本配置-1"><a href="#SSH基本配置-1" class="headerlink" title="SSH基本配置 (1)"></a>SSH基本配置 (1)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/8.png"></p>
<h3 id="SSH基本配置-2"><a href="#SSH基本配置-2" class="headerlink" title="SSH基本配置 (2)"></a>SSH基本配置 (2)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/9.png"></p>
<h3 id="SSH配置示例"><a href="#SSH配置示例" class="headerlink" title="SSH配置示例"></a>SSH配置示例</h3><p>•用户希望安全的远程登录设备，因此配置STelnet方式进行远程的安全登录。</p>
<p>•在R3上配置两个登录用户client001和client002，R1使用client001通过password认证方式登录R3，R2使用client002通过RSA认证方式登录R3。配置安全策略，保证只有R1和R2才能登录设备。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/10.png"></p>
<h3 id="SSH配置命令-1"><a href="#SSH配置命令-1" class="headerlink" title="SSH配置命令 (1)"></a>SSH配置命令 (1)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/11.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/12.png"></p>
<h3 id="SSH配置命令-2"><a href="#SSH配置命令-2" class="headerlink" title="SSH配置命令 (2)"></a>SSH配置命令 (2)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/13.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/14.png"></p>
<h3 id="SSH配置命令-3"><a href="#SSH配置命令-3" class="headerlink" title="SSH配置命令 (3)"></a>SSH配置命令 (3)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/15.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/16.png"></p>
<h3 id="SSH配置命令-4"><a href="#SSH配置命令-4" class="headerlink" title="SSH配置命令 (4)"></a>SSH配置命令 (4)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/15.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/17.png"></p>
<h3 id="SSH配置命令-5"><a href="#SSH配置命令-5" class="headerlink" title="SSH配置命令 (5)"></a>SSH配置命令 (5)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/15.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/18.png"></p>
<h3 id="SSH配置验证"><a href="#SSH配置验证" class="headerlink" title="SSH配置验证"></a>SSH配置验证</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/19.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/20.png"></p>
<h2 id="本机防攻击配置"><a href="#本机防攻击配置" class="headerlink" title="本机防攻击配置"></a>本机防攻击配置</h2><h3 id="本机防攻击基本配置-1"><a href="#本机防攻击基本配置-1" class="headerlink" title="本机防攻击基本配置 (1)"></a>本机防攻击基本配置 (1)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/21.png"></p>
<h3 id="本机防攻击基本配置-2"><a href="#本机防攻击基本配置-2" class="headerlink" title="本机防攻击基本配置 (2)"></a>本机防攻击基本配置 (2)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/22.png"></p>
<blockquote>
<p>•缺省情况下，SSH报文、Telnet报文、SSHv6报文、Telnetv6报文、HTTP报文、BGP报文的动态链路保护功能的限制速率是512pps，FTP报文的动态链路保护功能的限制速率是1024pps。</p>
</blockquote>
<h3 id="本机防攻击配置示例"><a href="#本机防攻击配置示例" class="headerlink" title="本机防攻击配置示例"></a>本机防攻击配置示例</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/23.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/24.png"></p>
<blockquote>
<p>•Net：Network。</p>
</blockquote>
<h3 id="本机防攻击配置命令-1"><a href="#本机防攻击配置命令-1" class="headerlink" title="本机防攻击配置命令 (1)"></a>本机防攻击配置命令 (1)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/25.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/26.png"></p>
<h3 id="本机防攻击配置命令-2"><a href="#本机防攻击配置命令-2" class="headerlink" title="本机防攻击配置命令 (2)"></a>本机防攻击配置命令 (2)</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/27.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/28.png"></p>
<blockquote>
<p>•应用层联动不需要使能，只要关闭Router的Telnet服务器功能，Router会丢弃收到的Telnet报文。</p>
</blockquote>
<h3 id="本机防攻击配置验证"><a href="#本机防攻击配置验证" class="headerlink" title="本机防攻击配置验证"></a>本机防攻击配置验证</h3><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/29.png"></p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7/30.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（判断题）当远程登录设备时，采用Stelnet的方式比Telnet的方式更加安全，因为Stelnet的方式登录采用TCP封装，而Telnet的方式登录设备采用UDP封装。</p>
<p>A 对</p>
<p><strong>B 错</strong></p>
<p>2.（判断题）本机防攻击包括CPU防攻击和攻击溯源两部分。</p>
<p><strong>A 对</strong></p>
<p>B 错</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•设备的安全加固，需要从管理平面、控制平面和转发平面多个维度进行考虑。从设备本身的脆弱点出发，进行网络安全风险的评估，从而梳理出设备整体的安全架构和安全加固策略。</p>
<p>•在设备支持的情况下，尽量采用SSH、SFTP等安全协议进行设备访问和数据传输。设备的CPU容易成为被攻击的对象，本机防攻击的部署至关重要。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/" itemprop="url">IP-华为防火墙技术</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T19:42:33+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•“防火墙”一词起源于建筑领域，用来隔离火灾，阻止火势从一个区域蔓延到另一个区域。引入到通信领域，防火墙这一具体设备通常用于两个网络之间有针对性的、逻辑意义上的隔离。这种隔离是选择性的，隔离“火”的蔓延，而又保证“人”可以穿墙而过。这里的“火”是指网络中的各种攻击，而“人”是指正常的通信报文。</p>
<p>•本课程将介绍在通信领域中什么是防火墙，为什么需要防火墙，以及防火墙的基本工作原理和配置。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述防火墙的定义、类型和发展历史</p>
<p>▫区分防火墙与路由器和交换机</p>
<p>▫阐明防火墙的基本概念，例如安全区域、安全策略、会话表和Server-map等</p>
<p>▫实现防火墙的基本配置</p>
<h1 id="1-防火墙概述"><a href="#1-防火墙概述" class="headerlink" title="1.防火墙概述"></a>1.防火墙概述</h1><h2 id="为什么需要防火墙？"><a href="#为什么需要防火墙？" class="headerlink" title="为什么需要防火墙？"></a>为什么需要防火墙？</h2><p>•安全无处不在。路由器和交换机构建了互联互通的网络，带来便利的同时也带来了安全隐患。</p>
<p>•例如在网络边界，企业有了如下安全诉求：</p>
<p>▫外部网络安全隔离</p>
<p>▫内部网络安全管控</p>
<p>▫内容安全过滤</p>
<p>▫入侵防御</p>
<p>▫防病毒</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/1.png"></p>
<h2 id="什么是防火墙？"><a href="#什么是防火墙？" class="headerlink" title="什么是防火墙？"></a>什么是防火墙？</h2><p>•在通信领域，防火墙是一种安全设备。它用于保护一个网络区域免受来自另一个网络区域的攻击和入侵，通常被应用于网络边界，例如企业互联网出口、企业内部业务边界、数据中心边界等。</p>
<p>•防火墙根据设备形态分为，框式防火墙、盒式防火墙和软件防火墙，支持在云上云下灵活部署。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/2.png"></p>
<blockquote>
<p>•严格意义上，防火墙还有更多的部署形态，例如桌面型防火墙（盒式防火墙的一种）。桌面型防火墙适用于小型企业、行业分支、连锁商业机构等场景。华为盒式防火墙同时支持传统模式和云管理模式。云管理模式由云端统一管理分支机构的安全接入，支持设备即插即用、业务配置自动化、运维可视化和网络大数据分析。</p>
<p>•本课程不过多介绍桌面型防火墙和软件防火墙，后续内容聚焦的框式/盒式硬件防火墙。</p>
</blockquote>
<h2 id="防火墙与交换机、路由器功能对比"><a href="#防火墙与交换机、路由器功能对比" class="headerlink" title="防火墙与交换机、路由器功能对比"></a>防火墙与交换机、路由器功能对比</h2><p>•以园区网为例，交换机作用是接入终端和汇聚内部路由，组建内部互联互通的局域网。</p>
<p>•路由器作用是路由的分发、寻址和转发，构建外部连接网络。</p>
<p>•防火墙作用是流量控制和安全防护，区分和隔离不同安全区域。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/3.png"></p>
<h2 id="防火墙与路由器转发流程对比"><a href="#防火墙与路由器转发流程对比" class="headerlink" title="防火墙与路由器转发流程对比"></a>防火墙与路由器转发流程对比</h2><p>•防火墙的转发流程比路由器复杂。以框式设备为例，硬件上除了接口、LPU（Line Processing Unit）、交换网板等外，防火墙还特有SPU（Service Processing Unit），用于实现防火墙的安全功能。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/4.png"></p>
<h2 id="防火墙的典型应用场景"><a href="#防火墙的典型应用场景" class="headerlink" title="防火墙的典型应用场景"></a>防火墙的典型应用场景</h2><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/5.png"></p>
<blockquote>
<p>•DMZ（Demilitarized Zone）起源于军方，是介于严格的军事管制区和松散的公共区域之间的一种有着部分管制的区域。防火墙设备引用了这一术语，指代一个逻辑上和物理上都与内部网络和外部网络分离的安全区域。在企业中一般用于服务器的放置。</p>
<p>•数据中心网络一般采用Spine-Leaf架构。Spine为骨干节点负责流量高速转发，Leaf为叶子节点负责服务器、防火墙或其他设备接入。Spine-Leaf之间全三层互联。</p>
</blockquote>
<h2 id="防火墙的发展历程"><a href="#防火墙的发展历程" class="headerlink" title="防火墙的发展历程"></a>防火墙的发展历程</h2><p>•纵观防火墙的发展历史，防火墙经历了从低级到高级、从功能简单到功能复杂的过程。网络技术的不断发展和新需求的不断提出，推动着防火墙的发展。</p>
<p>•防火墙从包过滤防火墙发展起经历了状态检测、统一威胁管理、NGFW等到AI防火墙，有以下特点：</p>
<ul>
<li><p>访问控制越来越精细</p>
</li>
<li><p>防护能力越来越强</p>
</li>
<li><p>性能越来越高</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/6.png"></p>
<blockquote>
<p>•更多防火墙发展历史，请参考《强叔侃墙》</p>
</blockquote>
<h2 id="包过滤防火墙"><a href="#包过滤防火墙" class="headerlink" title="包过滤防火墙"></a>包过滤防火墙</h2><p>•包过滤是指基于五元组对每个数据包进行检测，根据配置的安全策略转发或丢弃数据包。</p>
<p>•包过滤防火墙的基本原理是：通过配置访问控制列表（Access Control List，ACL）实施数据包的过滤。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/7.png"></p>
<blockquote>
<p>•包过滤防火墙主要基于数据包中的源/目的IP地址、源/目的端口号、IP 标识和报文传递的方向等信息。</p>
<p>•包过滤防火墙的设计简单，非常易于实现，而且价格便宜。</p>
<p>•包过滤防火墙的缺点主要表现以下几点：</p>
<ul>
<li><p>随着ACL复杂度和长度的增加，其过滤性能呈指数下降；</p>
</li>
<li><p>静态的ACL规则难以适应动态的安全要求；</p>
</li>
<li><p>包过滤不检查会话状态也不分析数据，这很容易让黑客蒙混过关。例如，攻击者可以使用假冒地址进行欺骗，通过把自己主机IP地址设成一个合法主机IP地址，就能很轻易地通过报文过滤器。</p>
</li>
</ul>
</blockquote>
<h2 id="状态检测防火墙"><a href="#状态检测防火墙" class="headerlink" title="状态检测防火墙"></a>状态检测防火墙</h2><p>•状态检测是包过滤技术的发展，它考虑报文前后的关联性，检测的是连接状态而非单个报文。</p>
<p>•状态检测防火墙就是支持状态检测功能的防火墙。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/8.png"></p>
<blockquote>
<p>•状态检测防火墙通过对连接的首个数据包（后续简称首包）检测而确定一条连接的状态。后续数据包根据所属连接的状态进行控制（转发或阻塞）。</p>
</blockquote>
<h2 id="AI防火墙"><a href="#AI防火墙" class="headerlink" title="AI防火墙"></a>AI防火墙</h2><p>•AI防火墙是结合AI技术的新一代防火墙。它通过结合AI算法或AI芯片等多种方式，进一步提高了防火墙的安全防护能力和性能。</p>
<p>•华为AI防火墙，内置的恶意文件检测引擎CDE、诱捕Sensor、APT检测引擎和探针，支持与沙箱和华为大数据分析平台CIS联动检测，打造智能防御体系。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/9.png"></p>
<blockquote>
<p>•华为HiSecEngine USG6000E系列是业界首批推出的AI防火墙。AI防火墙没有统一的标准，例如通过用大量数据和算法“训练”防火墙，让其学会自主识别威胁；通过内置AI芯片，提高应用识别和转发性能，都可以被称为AI防火墙。</p>
<p>•APT（Advanced Persistent Threat，高级持续性威胁）是指用先进的攻击手段对特定目标进行长期持续性攻击的攻击形式。</p>
<p>•沙箱（Sandbox）是一个用于检测病毒的安全设备，它为疑似病毒构建虚拟环境，通过观察其后续行为检测病毒。沙箱是APT检测的重要设备。华为的沙箱产品为Firehunter。</p>
<p>•CIS（Cybersecurity Intelligence System）能够对网络中的流量及各类设备的网络、安全日志等海量网络基础数据执行有效采集，通过大数据实时及离线分析，结合机器学习技术、专家信誉、情报驱动，有效的发现网络中的潜在威胁和高级威胁，实现企业内部的全网安全态势感知，同时可以结合华为HiSec解决方案高效地完成威胁的处置闭环，防患未然。</p>
<p>•自研恶意文件检测引擎（CDE）引入PE Class 2.0 AI算法，对全文件进行还原，对文件内容进行深度检测。（业界主流基于流检测。流检测的检测速度快，但只还原文件头，不对文件内容进行检查。</p>
<p>•华为独创的AIE APT检测引擎，引入AI算法，持续防御最新威胁。</p>
<p>•更多AI防火墙相关内容请参考<a target="_blank" rel="noopener" href="https://e.huawei.com/cn/products/enterprise-networking/security%E5%92%8Chttps://e.huawei.com/cn/material/networking/e1869bfff9ca42c1b4f6a83f69118215%E3%80%82">https://e.huawei.com/cn/products/enterprise-networking/security和https://e.huawei.com/cn/material/networking/e1869bfff9ca42c1b4f6a83f69118215。</a></p>
</blockquote>
<h2 id="本节小结"><a href="#本节小结" class="headerlink" title="本节小结"></a>本节小结</h2><p>•本章节主要介绍防火墙的基本概念、应用场景和发展历史：</p>
<p>▫防火墙是一种安全设备，有灵活的设备形态包括框式、盒式、桌面型和软件防火墙。</p>
<p>▫防火墙可被用于但不仅限于企业边界防护、内网管控与安全隔离、数据中心边界防护和数据中心安全联动。</p>
<p>▫防火墙技术不断的发展，从早期的包过滤防火墙发展到当前的AI防火墙。</p>
<h1 id="2-防火墙的基本概念"><a href="#2-防火墙的基本概念" class="headerlink" title="2.防火墙的基本概念"></a>2.防火墙的基本概念</h1><h2 id="防火墙基本概念：安全区域"><a href="#防火墙基本概念：安全区域" class="headerlink" title="防火墙基本概念：安全区域"></a>防火墙基本概念：安全区域</h2><p>•安全区域（Security Zone），简称为区域（Zone），是防火墙的重要概念。防火墙大部分的安全策略都基于安全区域实施。</p>
<p>•一个安全区域是防火墙若干接口所连网络的集合，一个区域内的用户具有相同的安全属性。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/10.png"></p>
<h2 id="默认安全区域"><a href="#默认安全区域" class="headerlink" title="默认安全区域"></a>默认安全区域</h2><p>•华为防火墙确认已创建四个区域，untrust、dmz、trust和local区域。安全区域有以下特性：</p>
<ul>
<li><p>默认的安全区域不能删除，也不允许修改安全优先级。</p>
</li>
<li><p>每个Zone都必须设置一个安全优先级（Priority），值越大，则Zone的安全优先级越高。</p>
</li>
<li><p>用户可根据自己的需求创建自定义的Zone。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/11.png"></p>
<blockquote>
<p>防火墙默认安全区域均为小写字母，且大小写敏感，包括：</p>
<p>•非受信区域（untrust）：通常用于定义Internet等不安全的网络。</p>
<p>•非军事化区域（dmz）：通常用于定义内网服务器所在区域。因为这种设备虽然部署在内网，但是经常需要被外网访问，存在较大安全隐患，同时一般又不允许其主动访问外网，所以将其部署一个优先级比trust低，但是比untrust高的安全区域中。</p>
<ul>
<li><p>DMZ（Demilitarized Zone）起源于军方，是介于严格的军事管制区和松散的公共区域之间的一种有着部分管制的区域。防火墙设备引用了这一术语，指代一个逻辑上和物理上都与内部网络和外部网络分离的安全区域。</p>
</li>
<li><p>DMZ安全区域很好地解决了服务器的放置问题。该安全区域可以放置需要对外提供网络服务的设备，如WWW服务器、FTP服务器等。上述服务器如果放置于内部网络，外部恶意用户则有可能利用某些服务的安全漏洞攻击内部网络；如果放置于外部网络，则无法保障它们的安全。</p>
</li>
</ul>
<p>•受信区域（trust）：通常用于定义内网终端用户所在区域。</p>
<p>•本地区域（local）：local区域定义的是设备本身，包括设备的各接口本身。凡是由设备构造并主动发出的报文均可认为是从Local区域中发出，凡是需要设备响应并处理（而不仅是检测或直接转发）的报文均可认为是由local区域接收。用户不能改变local区域本身的任何配置，包括向其中添加接口。</p>
<ul>
<li>由于local区域的特殊性，在很多需要设备本身进行报文收发的应用中，需要开放对端所在安全区域与local区域之间的安全策略。</li>
</ul>
</blockquote>
<h2 id="区域间（Interzone）示例"><a href="#区域间（Interzone）示例" class="headerlink" title="区域间（Interzone）示例"></a>区域间（Interzone）示例</h2><p>流量的源、目的地址决定了互访的区域。本例1中PC访问防火墙的接口的流量实际上是从trust zone到达local zone；本例2中PC访问Internet的流量实际上是从trust zone到达untrust zone。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/12.png"></p>
<h2 id="防火墙基本概念：安全策略"><a href="#防火墙基本概念：安全策略" class="headerlink" title="防火墙基本概念：安全策略"></a>防火墙基本概念：安全策略</h2><p>•安全策略是控制防火墙对流量转发以及对流量进行内容安全一体化检测的策略。</p>
<p>•当防火墙收到流量后，对流量的属性（五元组、用户、时间段等）进行识别，然后与安全策略的条件进行匹配。如果条件匹配，则此流量被执行对应的动作。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/13.png"></p>
<h2 id="安全策略组成"><a href="#安全策略组成" class="headerlink" title="安全策略组成"></a>安全策略组成</h2><p>•安全策略的组成有匹配条件、动作和安全配置文件（可选）。安全配置文件实现内容安全。</p>
<p>•安全策略动作如果为“允许”则可配置安全配置文件，如果为“禁止”则可配置反馈报文。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/14.png"></p>
<blockquote>
<p>•动作说明：</p>
<p>▫允许：如果动作为“允许”，则对流量进行如下处理：</p>
<ul>
<li><p>如果没有配置内容安全检测，则允许流量通过。</p>
</li>
<li><p>如果配置内容安全检测，最终根据内容安全检测的结论来判断是否对流量进行放行。内容安全检测包括反病毒、入侵防御等，它是通过在安全策略中引用安全配置文件实现的。如果其中一个安全配置文件阻断该流量，则防火墙阻断该流量。如果所有的安全配置文件都允许该流量转发，则防火墙允许该流量转发。</p>
</li>
</ul>
<p>▫禁止：表示拒绝符合条件的流量通过。</p>
<ul>
<li>如果动作为“禁止”，防火墙不仅可以将报文丢弃，还可以针对不同的报文类型选择发送对应的反馈报文。发起连接请求的客户端/服务器收到防火墙发送的阻断报文后，可以快速结束会话并让用户感知到请求被阻断。<ul>
<li>Reset客户端：防火墙向TCP客户端发送TCP reset报文。</li>
<li>Reset服务器：防火墙向TCP服务器发送TCP reset报文。</li>
<li>ICMP不可达：FW向报文客户端发送ICMP不可达报文。</li>
</ul>
</li>
</ul>
<p>•更多详细信息，可以参考文档，“安全策略”章节，<a target="_blank" rel="noopener" href="https://support.huawei.com/hedex/hdx.do?docid=EDOC1100084128&amp;lang=zh&amp;idPath=24030814%7C9856724%7C21430823%7C22984765%7C23176238%E3%80%82">https://support.huawei.com/hedex/hdx.do?docid=EDOC1100084128&amp;lang=zh&amp;idPath=24030814%7C9856724%7C21430823%7C22984765%7C23176238。</a></p>
</blockquote>
<h2 id="安全策略的匹配过程"><a href="#安全策略的匹配过程" class="headerlink" title="安全策略的匹配过程"></a>安全策略的匹配过程</h2><p>•当配置多条安全策略规则时，安全策略的匹配按照策略列表的顺序执行，即从策略列表顶端开始逐条向下匹配。如果流量匹配了某个安全策略，将不再进行下一个策略的匹配。</p>
<p>•安全策略的配置顺序很重要，需要先配置条件精确的策略，再配置宽泛的策略。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/15.png"></p>
<blockquote>
<p>•系统默认存在一条缺省安全策略default。缺省安全策略位于策略列表的最底部，优先级最低，所有匹配条件均为any，动作默认为禁止。如果所有配置的策略都未匹配，则将匹配缺省安全策略default。</p>
</blockquote>
<h2 id="防火墙基本概念：会话表"><a href="#防火墙基本概念：会话表" class="headerlink" title="防火墙基本概念：会话表"></a>防火墙基本概念：会话表</h2><p>•会话表是用来记录TCP、UDP、ICMP等协议连接状态的表项，是防火墙转发报文的重要依据。</p>
<p>•防火墙采用了基于“状态”的报文控制机制：只对首包或者少量报文进行检测就确定一条连接的状态，大量报文直接根据所属连接的状态进行控制。这种状态检测机制迅速提高了防火墙的检测和转发效率。会话表就是为了记录连接的状态而存在的。设备在转发TCP、UDP和ICMP报文时都需要查询会话表，来判断该报文所属的连接并采取相应的处理措施。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/16.png"></p>
<blockquote>
<p>•本例中PC1向PC2发起HTTP连接，所以在防火墙会话表中标示出“http”协议和连接信息，并识别出此流量在公共路由表中被转发（图中VPN:public）。</p>
</blockquote>
<h2 id="会话表的创建和包处理过程"><a href="#会话表的创建和包处理过程" class="headerlink" title="会话表的创建和包处理过程"></a>会话表的创建和包处理过程</h2><p>•防火墙状态检测开启情况下，流量的首包会创建会话表项，后续包即可直接匹配会话表项。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/17.png"></p>
<blockquote>
<p>•本流程只是一个示意图，展示了华为防火墙各个模块的基本处理顺序。实际不同的报文处理并非严格按照此流程图依次进行（若无对应配置），且与具体产品实现相关。</p>
<p>•更多详细信息，可以参考指定型号防火墙产品文档，“报文转发流程”章节。</p>
</blockquote>
<h2 id="会话表的老化时间与长连接"><a href="#会话表的老化时间与长连接" class="headerlink" title="会话表的老化时间与长连接"></a>会话表的老化时间与长连接</h2><p>•防火墙为各种协议设定了会话老化机制。当一条会话在老化时间内没有被任何报文匹配，则会被从会话表中删除。这种机制可以避免防火墙的设备资源被大量无用、陈旧的会话表项消耗。</p>
<p>•但是对于某些特殊业务中，一条会话的两个连续报文可能间隔时间很长。例如：</p>
<ul>
<li><p>用户通过FTP下载大文件，需要间隔很长时间才会在控制通道继续发送控制报文。</p>
</li>
<li><p>用户需要查询数据库服务器上的数据，这些查询操作的时间间隔远大于TCP的会话老化时间。</p>
</li>
</ul>
<p>•此时如果其会话表项被删除，则该业务会中断。长连接（Long Link）机制可以给部分连接设定超长的老化时间，有效解决这个问题。</p>
<h2 id="多通道协议在防火墙上的问题"><a href="#多通道协议在防火墙上的问题" class="headerlink" title="多通道协议在防火墙上的问题"></a>多通道协议在防火墙上的问题</h2><p>•如果在防火墙上配置严格的单向安全策略，那么防火墙将只允许业务单方向发起访问。这会导致一些特殊的协议无法工作，例如FTP。</p>
<p>•FTP主动模式传输文件时，首先需要客户端主动向服务器端发起控制连接，然后需要服务器端向客户端发起数据连接。如果设备上配置的安全策略仅允许客户端报文单方向通过，则FTP文件传输不能成功。</p>
<p>•同FTP，通信过程中需占用两个或两个以上端口的协议被称为多通道协议。多通道协议都需要考虑此类问题。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/18.png"></p>
<blockquote>
<p>•单通道协议：通信过程中只需占用一个端口的协议。如：WWW只需占用80端口。</p>
<p>•多通道协议：通信过程中需占用两个或两个以上端口的协议。</p>
<p>•FTP协议是一个典型的多通道协议，在其工作过程中，FTP Client和FTP Server之间将会建立两条连接：控制连接和数据连接。控制连接用来传输FTP指令和参数，其中就包括建立数据连接所需要的信息。数据连接用来获取服务器目录及传输数据。数据连接使用的端口号是在控制连接中临时协商的。根据数据连接的发起方式FTP协议分为两种工作模式：主动模式（PORT模式）和被动模式（PASV模式）。主动模式中，FTP Server 20号端口主动向FTP Client随机端口发起数据连接；被动模式中，FTP Server被动接收FTP Client发起的数据连接。模式在一般的FTP客户端中都是可以设置的，这里我们以主动模式为例。</p>
<p>•多通道协议存在时，防火墙配置较为宽泛的安全策略也可以解决协议不可用问题，但是存在安全隐患。</p>
</blockquote>
<h2 id="多通道协议-–-FTP过程详解"><a href="#多通道协议-–-FTP过程详解" class="headerlink" title="多通道协议 – FTP过程详解"></a>多通道协议 – FTP过程详解</h2><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/19.png"></p>
<blockquote>
<p>•大部分多媒体应用协议（如H.323、SIP）、FTP、netmeeting等协议使用约定的固定端口来初始化一个控制连接，再动态的协商出端口用于数据传输。端口的选择是不可预测的。其中的某些应用甚至可能要同时用到多个端口。传统的包过滤防火墙可以通过配置ACL过滤规则匹配单通道协议的应用传输，保障内部网络不受攻击，但只能阻止一些使用固定端口的应用，无法匹配使用协商出随机端口传输数据的多通道协议应用，留下了许多安全隐患。</p>
</blockquote>
<h2 id="ASPF与Server-map"><a href="#ASPF与Server-map" class="headerlink" title="ASPF与Server-map"></a>ASPF与Server-map</h2><p>•为了解决多通道协议的问题，防火墙需要识别协议在应用层协商的地址和端口。这需要开启ASPF （Application Specific Packet Filter，针对应用层的包过滤）功能。</p>
<p>•ASPF也称作基于状态的报文过滤，ASPF功能可以自动检测某些报文的应用层信息并根据应用层信息放开相应的访问规则，即生成Server-map表。</p>
<p>•Server-map表也记录了类似会话表中连接的状态。Server-map表中的信息相对简单，是简化的会话表，在真实流量到达前生成。在流量真实到达防火墙时，防火墙会基于Server-map表生成会话表，然后执行转发。</p>
<p>•开启ASPF解决多通道协议问题，是生成Server-map表的一种方式。</p>
<blockquote>
<p>•在防火墙配置了ASPF、NAT Server和No-PAT方式的源NAT时，都会生成相应的Server-map表项。</p>
</blockquote>
<h2 id="ASPF与Server-map示例"><a href="#ASPF与Server-map示例" class="headerlink" title="ASPF与Server-map示例"></a>ASPF与Server-map示例</h2><p>•防火墙上配置了ASPF功能后，会检测FTP控制连接中协商的数据连接端口信息，然后生成Server-map表项。Server-map表项包含了FTP控制通道中协商的数据通道的信息。防火墙为命中Server-map表的数据创建会话表。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/20.png"></p>
<blockquote>
<p>Server-map表与会话表的关系如下：</p>
<p>▫Server-map表记录了应用层数据中的关键信息，报文命中该表后，不再受安全策略的控制；</p>
<p>▫会话表是通信双方连接状态的具体体现；</p>
<p>▫Server-map表不是当前的连接信息，而是防火墙对当前连接分析后得到的即将到来报文的预测；</p>
<p>▫防火墙收到报文先检查是否命中会话表；</p>
<p>▫如果没有命中则检查是否命中Server-map表；</p>
<p>▫命中Server-map表的报文不受安全策略控制；</p>
<p>▫防火墙最后为命中Server-map表的数据创建会话表。</p>
</blockquote>
<h2 id="Server-map表与简化的包转发过程"><a href="#Server-map表与简化的包转发过程" class="headerlink" title="Server-map表与简化的包转发过程"></a>Server-map表与简化的包转发过程</h2><p>•当防火墙接收到一个报文且没有命中会话表时，防火墙进入首包处理流程，查询是否有命中的Server-map表。如果有，则会生成会话表转发报文；如果没有，则执行其他包处理过程。</p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/21.png"></p>
<h2 id="本节小结-1"><a href="#本节小结-1" class="headerlink" title="本节小结"></a>本节小结</h2><p>•本章节主要介绍防火墙的基本概念和基础特性，它们有：</p>
<p>​    ▫安全区域</p>
<p>​    ▫安全策略</p>
<p>​    ▫防火墙的会话表</p>
<p>​    ▫防火墙的Server-map</p>
<h1 id="3-防火墙的基础配置"><a href="#3-防火墙的基础配置" class="headerlink" title="3.防火墙的基础配置"></a>3.防火墙的基础配置</h1><h2 id="防火墙基础配置-接口"><a href="#防火墙基础配置-接口" class="headerlink" title="防火墙基础配置 - 接口"></a>防火墙基础配置 - 接口</h2><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/22.png"></p>
<h2 id="防火墙基础配置-安全区域"><a href="#防火墙基础配置-安全区域" class="headerlink" title="防火墙基础配置 - 安全区域"></a>防火墙基础配置 - 安全区域</h2><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/23.png"></p>
<h2 id="防火墙基础配置-安全策略"><a href="#防火墙基础配置-安全策略" class="headerlink" title="防火墙基础配置 - 安全策略"></a>防火墙基础配置 - 安全策略</h2><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/24.png"></p>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/25.png"></p>
<blockquote>
<p>•安全策略规则视图中指定源、目的IP地址可以有很多的可选参数，例如IP地址组、地区和地区组等，本课程不做过多介绍。更多详细内容请参考产品文档。</p>
</blockquote>
<h2 id="防火墙配置案例"><a href="#防火墙配置案例" class="headerlink" title="防火墙配置案例"></a>防火墙配置案例</h2><p>案例描述：</p>
<p>防火墙将网络隔离为三个安全区域，trust、untrust和OM，其中OM区域优先级为95。现有需求如下：</p>
<ul>
<li><p>允许防火墙接口GE1/0/1响应Ping请求。</p>
</li>
<li><p>允许OM区域ICMP流量访问untrust区域。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/26.png"></p>
<h3 id="配置案例-接口"><a href="#配置案例-接口" class="headerlink" title="配置案例 - 接口"></a>配置案例 - 接口</h3><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/27.png"></p>
<h3 id="配置案例-安全区域"><a href="#配置案例-安全区域" class="headerlink" title="配置案例 - 安全区域"></a>配置案例 - 安全区域</h3><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/28.png"></p>
<h3 id="配置案例-安全策略"><a href="#配置案例-安全策略" class="headerlink" title="配置案例 - 安全策略"></a>配置案例 - 安全策略</h3><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/29.png"></p>
<h3 id="配置案例-结果验证-1"><a href="#配置案例-结果验证-1" class="headerlink" title="配置案例 - 结果验证 (1)"></a>配置案例 - 结果验证 (1)</h3><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/30.png"></p>
<h3 id="配置案例-结果验证-2"><a href="#配置案例-结果验证-2" class="headerlink" title="配置案例 - 结果验证 (2)"></a>配置案例 - 结果验证 (2)</h3><p><img src="/2021/05/17/IP-%E5%8D%8E%E4%B8%BA%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF/31.png"></p>
<h2 id="本节小结-2"><a href="#本节小结-2" class="headerlink" title="本节小结"></a>本节小结</h2><p>•本小结主要介绍防火墙的基础配置命令。通过学习你已实现使用命令行：</p>
<p>​    ▫配置防火墙接口</p>
<p>​    ▫划分防火墙安全区域</p>
<p>​    ▫配置安全策略</p>
<p>​    ▫查看防火墙会话信息</p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）缺省情况下，防火墙有几个安全区域？（  ）</p>
<p>A. 1</p>
<p>B. 2      </p>
<p>C. 3     </p>
<p><strong>D. 4</strong></p>
<p>2.（判断题）防火墙在生产会话表之前，都需要先生成Server-map。 （  ）</p>
<p>A.对</p>
<p><strong>B.错</strong></p>
<p>3.（多选题）以下对于华为AI防火墙说法正确的是？ （  ）</p>
<p><strong>A. 内置恶意文件检测引擎（CDE)</strong></p>
<p><strong>B. 内置探针</strong></p>
<p><strong>C. 内置APT检测引擎（AIE）</strong></p>
<p><strong>D. 内置独创诱捕Sensor</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•防火墙是通信领域极为重要的安全设备之一，本章帮助您初步学习防火墙的基本概念、发展历史和基础配置。</p>
<p>•安全区域、安全策略、会话表和Server-map是防火墙基础的、重要的概念，是进一步学习防火墙技术的必要前提。</p>
<p>•防火墙有更多的安全功能，例如内容安全过滤、反病毒和入侵防御等。更多防火墙技术学习请参考华为安全认证。</p>
<h1 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h1><p>•华为HiSecEngine USG6000E系列AI防火墙相关文档。</p>
<p>•<a target="_blank" rel="noopener" href="https://support.huawei.com/enterprise/zh/security/usg6600e-pid-23176231">https://support.huawei.com/enterprise/zh/security/usg6600e-pid-23176231</a></p>
<p>•更多相关教材和视频请关注<a target="_blank" rel="noopener" href="https://e.huawei.com/cn/talent/#/home">https://e.huawei.com/cn/talent/#/home</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/" itemprop="url">IP-IPv6地址配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T13:28:33+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•IPv6是下一代互联网的核心协议，它解决了IPv4所暴露的诸多缺陷，如地址稀缺、路由表庞大、对移动设备支持不足等。</p>
<p>•IPv6的一个突出特点是支持网络节点的地址自动配置，真正实现即插即用，极大地简化网络管理者的工作。</p>
<p>•本课程将介绍IPv6地址自动配置的工作原理与配置实现。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述IPv6无状态地址自动配置的工作原理</p>
<p>▫描述DHCPv6地址自动配置的工作原理</p>
<p>▫实现IPv6地址自动配置</p>
<h1 id="1-IPv6地址配置方式"><a href="#1-IPv6地址配置方式" class="headerlink" title="1.IPv6地址配置方式"></a>1.IPv6地址配置方式</h1><h2 id="IPv6地址配置方式"><a href="#IPv6地址配置方式" class="headerlink" title="IPv6地址配置方式"></a>IPv6地址配置方式</h2><p>IPv6地址配置的方式可以分为静态配置和动态配置。其中，动态地址配置又可以分为无状态地址自动配置（Stateless Address Autoconfiguration, SLAAC）和有状态地址自动配置（Stateful Address Autoconfiguration)。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/1.png"></p>
<h2 id="IPv6地址自动配置的分类"><a href="#IPv6地址自动配置的分类" class="headerlink" title="IPv6地址自动配置的分类"></a>IPv6地址自动配置的分类</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/2.png"></p>
<h1 id="2-IPv6地址无状态自动配置"><a href="#2-IPv6地址无状态自动配置" class="headerlink" title="2.IPv6地址无状态自动配置"></a>2.IPv6地址无状态自动配置</h1><h2 id="IPv6地址无状态自动配置过程"><a href="#IPv6地址无状态自动配置过程" class="headerlink" title="IPv6地址无状态自动配置过程"></a>IPv6地址无状态自动配置过程</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/3.png"></p>
<h2 id="IPv6地址无状态自动配置示例"><a href="#IPv6地址无状态自动配置示例" class="headerlink" title="IPv6地址无状态自动配置示例"></a>IPv6地址无状态自动配置示例</h2><p>IPv6无状态地址配置通过交互RS和RA报文完成。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•基于NDP的IPv6地址无状态自动配置具体过程如下（DAD略）：</p>
<p>1.PC1首先生成链路本地地址FE80::1002，然后向本地链接中所有路由器发送路由器请求（RS）。</p>
<p>2.R1发送RA携带着用于无状态地址自动配置的前缀信息，本例中，该前缀为2001:DB8::/64。</p>
<p>3.PC1收到RA报文后，根据RA报文中携带的前缀信息加上接口ID生成IPv6地址2001:DB8::1002。</p>
</blockquote>
<h2 id="RA报文中的Flags字段"><a href="#RA报文中的Flags字段" class="headerlink" title="RA报文中的Flags字段"></a>RA报文中的Flags字段</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/5.png"></p>
<h2 id="RA报文中的可选信息：地址前缀信息"><a href="#RA报文中的可选信息：地址前缀信息" class="headerlink" title="RA报文中的可选信息：地址前缀信息"></a>RA报文中的可选信息：地址前缀信息</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/6.png"></p>
<h2 id="RA报文中的可选信息：生存周期"><a href="#RA报文中的可选信息：生存周期" class="headerlink" title="RA报文中的可选信息：生存周期"></a>RA报文中的可选信息：生存周期</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/7.png"></p>
<h1 id="3-DHCPv6"><a href="#3-DHCPv6" class="headerlink" title="3.DHCPv6"></a>3.DHCPv6</h1><h2 id="DHCPv6概述"><a href="#DHCPv6概述" class="headerlink" title="DHCPv6概述"></a>DHCPv6概述</h2><p>•DHCPv6针对IPv6编址方案设计，支持对客户端分配IPv6前缀、IPv6地址和其他网络配置参数，并记录这些信息，便于网络管理。</p>
<p>•DHCPv6又分为如下三种：</p>
<ul>
<li><p>DHCPv6有状态自动配置：DHCPv6服务器自动配置IPv6地址/前缀及其他网络配置参数（DNS、NIS、SNTP服务器地址等参数）。</p>
</li>
<li><p>DHCPv6无状态自动配置：主机IPv6地址仍然通过路由通告方式自动生成，DHCPv6服务器只分配除IPv6地址以外的配置参数，包括DNS服务器等参数。</p>
</li>
<li><p>DHCPv6 PD（Prefix Delegation，前缀代理）自动配置：下层网络路由器不需要再手工指定用户侧链路的IPv6地址前缀，它只需要向上层网络路由器提出前缀分配申请，上层网络路由器便可以分配合适的地址前缀给下层路由器，下层路由器把获得的前缀（前缀一般长度小于64）进一步自动细分成64位前缀长度的子网网段，把细分的地址前缀再通过路由通告(RA)至与IPv6主机直连的用户链路上，实现主机的地址自动配置，从而完成整个IPv6网络的层次化布局。</p>
</li>
</ul>
<h2 id="DHCPv6网络构成"><a href="#DHCPv6网络构成" class="headerlink" title="DHCPv6网络构成"></a>DHCPv6网络构成</h2><p>DHCPv6基本协议架构中，主要包括以下三种角色：</p>
<ul>
<li><p>DHCPv6 Client：DHCPv6客户端，通过与DHCPv6服务器进行报文交互，获取IPv6地址/前缀和其他网络配置参数，完成自身的网络配置。</p>
</li>
<li><p>DHCPv6 Server：DHCPv6服务器，负责处理来自客户端或中继的地址分配、地址续租、地址释放等请求，为客户端分配IPv6地址/前缀和其他网络配置参数。</p>
</li>
<li><p>DHCPv6 Relay：DHCPv6中继，负责转发来自客户端或服务器的DHCPv6报文，协助DHCPv6客户端和DHCPv6服务器完成地址配置功能。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/8.png"></p>
<h2 id="DHCPv6中的常用概念"><a href="#DHCPv6中的常用概念" class="headerlink" title="DHCPv6中的常用概念"></a>DHCPv6中的常用概念</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/9.png"></p>
<blockquote>
<p>•有效时间（Valid Lifetime）：地址/前缀的生命周期。用于指定地址/前缀的过期时间，过期后所有使用该地址/前缀的用户下线。此时间必须配置为不小于3小时，且不得小于优先级时间。</p>
<p>•优选时间（Preferred Lifetime）：用于计算续租时间和重绑定时间。此时间必须配置为不小于2小时。</p>
</blockquote>
<h2 id="DHCPv6有状态自动配置-四步交互"><a href="#DHCPv6有状态自动配置-四步交互" class="headerlink" title="DHCPv6有状态自动配置 - 四步交互"></a>DHCPv6有状态自动配置 - 四步交互</h2><p>四步交互是指DHCPv6客户端与服务器交互四次来完成前缀/地址等参数获取的过程。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/10.png"></p>
<h2 id="DHCPv6有状态自动配置-两步交互"><a href="#DHCPv6有状态自动配置-两步交互" class="headerlink" title="DHCPv6有状态自动配置 - 两步交互"></a>DHCPv6有状态自动配置 - 两步交互</h2><p>DHCPv6客户端可以在发送的Solicit消息中携带Rapid Commit选项，标识客户端希望服务器能够快速为其分配地址/前缀和网络配置参数。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/11.png"></p>
<blockquote>
<p>•两步交换可以提高DHCPv6分配过程的效率，但适用在网络中只存在一台DHCPv6服务器的情况下。在有多个DHCPv6服务器的网络中，多个DHCPv6服务器都可以为DHCPv6客户端分配IPv6地址/前缀和其他配置参数，但是客户端实际只能使用其中一个服务器为其分配的IPv6地址/前缀和配置参数。</p>
</blockquote>
<h2 id="地址-前缀租约更新-1"><a href="#地址-前缀租约更新-1" class="headerlink" title="地址/前缀租约更新 (1)"></a>地址/前缀租约更新 (1)</h2><p>DHCPv6服务器分配的IPv6地址/前缀具有有效时间。地址/前缀的租借时间超过有效时间后，DHCPv6客户端不能再使用该地址/前缀。因此，在有效时间超时之前，如果DHCPv6客户端希望继续使用该地址/前缀，则需要更新地址/前缀的租约。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/12.png"></p>
<h2 id="地址-前缀租约更新-2"><a href="#地址-前缀租约更新-2" class="headerlink" title="地址/前缀租约更新 (2)"></a>地址/前缀租约更新 (2)</h2><p>如果DHCPv6服务器未响应T1时刻DHCPv6客户端发出的Renew请求，则客户端会在T2（默认为Preferred Lifetime的0.8倍）向所有DHCPv6服务器组播发送Rebind请求更新租约。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/13.png"></p>
<h2 id="DHCPv6无状态自动配置"><a href="#DHCPv6无状态自动配置" class="headerlink" title="DHCPv6无状态自动配置"></a>DHCPv6无状态自动配置</h2><p>DHCPv6服务器为已经具有IPv6地址/前缀的客户端分配除地址/前缀以外的其他网络配置参数，该过程称为DHCPv6无状态自动配置。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•在主机生成链路本地地址并检测无地址冲突后，会首先发起路由器发现过程，即主机发送RS报文，路由器回应RA报文。如果RA报文中M-bit为0，O-bit为1，则表示主机将通过DHCPv6无状态自动配置来获取除地址/前缀外的其他配置参数，如DNS、SIP、SNTP等服务器配置信息等。</p>
</blockquote>
<h2 id="DHCPv6-PD自动配置"><a href="#DHCPv6-PD自动配置" class="headerlink" title="DHCPv6 PD自动配置"></a>DHCPv6 PD自动配置</h2><p>在一个层次化的网络结构中，不同层次的IPv6地址配置一般是手工指定的。手工配置IPv6地址扩展性不佳，不利于IPv6地址的统一规划管理。DHCPv6 PD可以解决这个问题。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•DHCPv6 PD一般用于网络中存在路由器（如本例中的DHCPv6客户端）需要继续为下连的IPv6主机分配前缀的场景，实现主机的地址自动配置，从而完成整个IPv6网络的层次化布局。</p>
<p>•第1步中，DHCPv6客户端请求DHCPv6服务器为其分配IA_NA地址和IA_PD前缀，IA_NA可以理解为服务器为客户端WAN口分配的地址，IA_PD可以理解为服务器为客户端的LAN侧分配的前缀。</p>
</blockquote>
<h2 id="DHCPv6中继工作过程"><a href="#DHCPv6中继工作过程" class="headerlink" title="DHCPv6中继工作过程"></a>DHCPv6中继工作过程</h2><p>当服务器和客户端不在一个网段时，需要使用到DHCPv6中继来完成IPv6地址/前缀和其他网络配置参数的获取。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/16.png"></p>
<h2 id="DHCPv6地址确认过程"><a href="#DHCPv6地址确认过程" class="headerlink" title="DHCPv6地址确认过程"></a>DHCPv6地址确认过程</h2><p>当客户端有断电、掉线、漫游等情况发生时，客户端会发送Confirm报文确认自己的IPv6地址是否可用。如果客户端确认的地址是合法的，则服务器回应；如果没有回应，则客户端需要重新启动地址申请流程。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/17.png"></p>
<h2 id="DHCPv6地址冲突检测过程"><a href="#DHCPv6地址冲突检测过程" class="headerlink" title="DHCPv6地址冲突检测过程"></a>DHCPv6地址冲突检测过程</h2><p>客户端完成地址申请后，会在开始使用该地址前发起DAD探测。如果DAD检测到地址存在冲突，则客户端发送Decline消息通知服务器，并不再使用该地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/18.png"></p>
<h2 id="DHCPv6地址释放过程"><a href="#DHCPv6地址释放过程" class="headerlink" title="DHCPv6地址释放过程"></a>DHCPv6地址释放过程</h2><p>当客户端不需要再使用某地址时，将发送Release消息至服务器，发起释放地址的交互流程。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/19.png"></p>
<h2 id="DHCPv6报文总结"><a href="#DHCPv6报文总结" class="headerlink" title="DHCPv6报文总结"></a>DHCPv6报文总结</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/20.png"></p>
<h2 id="地址自动配置比较"><a href="#地址自动配置比较" class="headerlink" title="地址自动配置比较"></a>地址自动配置比较</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/21.png"></p>
<h1 id="3-IPv6地址自动配置实现"><a href="#3-IPv6地址自动配置实现" class="headerlink" title="3.IPv6地址自动配置实现"></a>3.IPv6地址自动配置实现</h1><h2 id="IPv6基本配置"><a href="#IPv6基本配置" class="headerlink" title="IPv6基本配置"></a>IPv6基本配置</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/22.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/23.png"></p>
<h2 id="IPv6地址配置举例-–-静态配置"><a href="#IPv6地址配置举例-–-静态配置" class="headerlink" title="IPv6地址配置举例 – 静态配置"></a>IPv6地址配置举例 – 静态配置</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/24.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/25.png"></p>
<h2 id="IPv6地址配置举例-–-无状态自动配置"><a href="#IPv6地址配置举例-–-无状态自动配置" class="headerlink" title="IPv6地址配置举例 – 无状态自动配置"></a>IPv6地址配置举例 – 无状态自动配置</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/26.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/27.png"></p>
<h2 id="IPv6地址配置举例-–-DHCPv6"><a href="#IPv6地址配置举例-–-DHCPv6" class="headerlink" title="IPv6地址配置举例 – DHCPv6"></a>IPv6地址配置举例 – DHCPv6</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/28.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/29.png"></p>
<h2 id="IPv6地址自动配置实现-–-结果验证"><a href="#IPv6地址自动配置实现-–-结果验证" class="headerlink" title="IPv6地址自动配置实现 – 结果验证"></a>IPv6地址自动配置实现 – 结果验证</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/30.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）基于NDP的无状态地址自动配置，以下说法正确的是（    ）。</p>
<p>A.基于NDP的无状态地址自动配置可以为主机分配128位的IPv6地址</p>
<p>B.基于NDP的无状态地址自动配置可以为主机分配IPv6前缀或IPv6地址</p>
<p>C.基于NDP的无状态地址自动配置只能为主机分配IPv6前缀</p>
<p><strong>D.基于NDP的无状态地址自动配置可以为主机分配DNS</strong></p>
<p>2.（多选题）在DHCPv6的工作过程中，以下哪些过程用到了Reply报文（    ）。</p>
<p><strong>A.DHCPv6信息获取过程</strong></p>
<p><strong>B.DHCPv6前缀分配两步交互过程</strong></p>
<p><strong>C.DHCPv6地址分配四步交互过程</strong></p>
<p><strong>D.DHCPv6地址释放过程</strong></p>
<p><strong>E.DHCPv6地址续约过程</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•IPv6地址配置可以分为静态配置和动态配置。网络设备互联IPv6地址、环回接口IPv6地址等往往采用静态配置的方式，而终端通常采用动态自动配置方式。</p>
<p>•本课程重点介绍了IPv6地址动态自动配置的两种方式：基于NDP的无状态地址自动配置和基于DHCPv6的有状态地址自动配置。无状态地址自动配置只支持分配64bit的前缀，扩展性较差，对地址的管控较弱。有状态地址自动配置可以实现更加丰富的功能，如PD前缀分配等。</p>
<p>•客户端采用何种IPv6地址自动配置方式是由路由器RA报文中的M-bit和O-bit的配置决定的，实际网络中，需要结合实际场景决定合理的地址配置方式。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-ICMPv6%E5%92%8CNDP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/" itemprop="url">IP-ICMPv6和NDP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T13:28:03+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/ICMPv6%E5%92%8CNDP.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•在IPv4中，ICMP允许主机或设备报告差错情况。ICMP报文作为IP报文的数据部分，再封装上IP报文首部，组成完整的IP报文发送出去。常用的Ping、Tracert等命令都是基于ICMP实现的。</p>
<p>•IPv6定义了ICMPv6（Internet Control Message Protocol for IPv6），除了提供类似ICMP的功能外，还有诸多扩展。邻居发现协议（Neighbor Discovery Protocol，以下简称NDP）便是基于ICMPv6实现的，作为IPv6的关键协议，NDP提供了如前缀发现、重复地址检测、地址解析、重定向等功能。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述ICMPv6的功能</p>
<p>▫描述ICMPv6的报文格式</p>
<p>▫描述ICMPv6的报文类型</p>
<p>▫描述NDP的功能</p>
<h1 id="1-ICMPv6介绍"><a href="#1-ICMPv6介绍" class="headerlink" title="1.ICMPv6介绍"></a>1.ICMPv6介绍</h1><h2 id="ICMPv6概述"><a href="#ICMPv6概述" class="headerlink" title="ICMPv6概述"></a>ICMPv6概述</h2><h3 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h3><p>Internet控制消息协议ICMP (Internet Control Message Protocol)是IP协议的辅助协议。</p>
<p>ICMP协议用来在网络设备间传递各种差错和控制信息，对于收集各种网络信息、诊断和排除各种网络故障等方面起着至关重要的作用。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/1.png"></p>
<blockquote>
<p>•为了更有效地转发IP数据报文和提高数据报文交互成功的机会，在网络层使用ICMP协议。ICMP允许主机或设备报告差错情况和提供有关异常情况的报告。</p>
<p>•ICMP消息：</p>
<ul>
<li><p>ICMP消息封装在IP报文中，IP报文头部Protocol值为1时表示ICMP协议。</p>
</li>
<li><p>字段解释：</p>
<ul>
<li>ICMP消息的格式取决于Type和Code字段，其中Type字段为消息类型，Code字段包含该消息类型的具体参数。</li>
<li>校验和字段用于检查消息是否完整。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="ICMP差错检测"><a href="#ICMP差错检测" class="headerlink" title="ICMP差错检测"></a>ICMP差错检测</h3><p>ICMP Echo消息常用于诊断源和目的地之间的网络连通性，同时还可以提供其他信息，如报文往返时间等。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/2.png"></p>
<blockquote>
<p>•ICMP的一个典型应用是Ping。Ping是检测网络连通性的常用工具，同时也能够收集其他相关信息。用户可以在Ping命令中指定不同参数，如ICMP报文长度、发送的ICMP报文个数、等待回复响应的超时时间等，设备根据配置的参数来构造并发送ICMP报文，进行Ping测试。</p>
</blockquote>
<h3 id="ICMP错误报告"><a href="#ICMP错误报告" class="headerlink" title="ICMP错误报告"></a>ICMP错误报告</h3><p>ICMP定义了各种错误消息，用于诊断网络连接性问题；根据这些错误消息，源设备可以判断出数据传输失败的原因。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/3.png"></p>
<h3 id="ICMPv6概述-1"><a href="#ICMPv6概述-1" class="headerlink" title="ICMPv6概述"></a>ICMPv6概述</h3><p>•ICMPv6是IPv6的基础协议之一。</p>
<p>•在IPv6报文头部中，Next Header字段值为58则对应为ICMPv6报文。</p>
<p>•ICMPv6报文用于通告相关信息或错误。</p>
<p>•ICMPv6报文被广泛应用于其它协议中，包括NDP、Path MTU发现机制等。</p>
<p>•ICMPv6控制着IPv6中的地址自动配置、地址解析、地址冲突检测、路由选择、以及差错控制等关键环节。</p>
<h2 id="ICMPv6报文格式"><a href="#ICMPv6报文格式" class="headerlink" title="ICMPv6报文格式"></a>ICMPv6报文格式</h2><h3 id="ICMPv6报文格式-1"><a href="#ICMPv6报文格式-1" class="headerlink" title="ICMPv6报文格式"></a>ICMPv6报文格式</h3><p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/4.png"></p>
<blockquote>
<p>•ICMPv6报文载荷由ICMPv6报文类型决定，因报文类型的不同而不同。</p>
<p>•<strong>Type：</strong>表明消息的类型。</p>
<p>•<strong>Code：</strong>表示消息类型的细分。</p>
<p>•<strong>Checksum：</strong>表示ICMPv6报文的校验和。</p>
</blockquote>
<h2 id="ICMPv6报文类型及作用"><a href="#ICMPv6报文类型及作用" class="headerlink" title="ICMPv6报文类型及作用"></a>ICMPv6报文类型及作用</h2><h3 id="ICMPv6报文类型"><a href="#ICMPv6报文类型" class="headerlink" title="ICMPv6报文类型"></a>ICMPv6报文类型</h3><p>ICMPv6报文分为两类：差错报文和信息报文。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/5.png"></p>
<h3 id="ICMPv6差错报文应用-Path-MTU发现"><a href="#ICMPv6差错报文应用-Path-MTU发现" class="headerlink" title="ICMPv6差错报文应用 - Path MTU发现"></a>ICMPv6差错报文应用 - Path MTU发现</h3><p>•在IPv6中，中间转发设备不对IPv6报文进行分片，报文的分片将在源节点进行。</p>
<p>•PMTU（Path MTU）就是路径上的最小接口MTU。</p>
<p>•PMTUD（Path MTU发现机制）的主要目的是发现路径上的MTU，当数据包被从源转发到目的地的过程中避免分段。</p>
<p>•依赖PMTUD，数据的发送方可以使用所发现到的最优PMTU与目的地节点进行通信，这样可以避免数据包在从源传输到目的的过程之中，被中途的路由器分片而导致性能的下降。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/6.png"></p>
<blockquote>
<p>1.首先PC1用1500字节作为MTU向PC2发送IPv6数据包。</p>
<p>2.R1意识到数据包过大，出站接口MTU为1400字节，于是回复一个ICMPv6（Type=2）报文给PC1，指定MTU值为1400字节。</p>
<p>3.然后，PC1开始使用1400作为MTU发送IPv6数据。</p>
<p>4.数据包到达R2后，R2意识到出站接口MTU为1300字节，于是发送一个ICMPv6（Type=2）报文给PC1，指定MTU值为1300字节。</p>
<p>5.PC1开始使用1300作为MTU发送IPv6数据。</p>
</blockquote>
<h3 id="ICMPv6信息报文应用-Ping"><a href="#ICMPv6信息报文应用-Ping" class="headerlink" title="ICMPv6信息报文应用 - Ping"></a>ICMPv6信息报文应用 - Ping</h3><p>Ping基于ICMPv6信息报文实现</p>
<ul>
<li><p>Echo Request：用于发送到目标节点，以使目标节点立即发回一个Echo Reply应答报文。Echo Request报文的Type字段值为128，Code字段的值为0。</p>
</li>
<li><p>Echo Reply：当收到一个Echo Request报文时，ICMPv6会用Echo Reply报文响应。Echo Reply报文的Type字段的值为129，Code字段的值为0。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/7.png"></p>
<h3 id="ICMPv6其它常用的报文"><a href="#ICMPv6其它常用的报文" class="headerlink" title="ICMPv6其它常用的报文"></a>ICMPv6其它常用的报文</h3><p>•邻居发现（RFC2461和RFC4861）</p>
<p>​    ▫Type=133  路由器请求（Router Solicitation）</p>
<p>​    ▫Type=134  路由器公告（Router Advertisement）</p>
<p>​    ▫Type=135  邻居请求（Neighbor Solicitation）</p>
<p>​    ▫Type=136  邻居公告（Neighbor Advertisement）</p>
<p>​    ▫Type=137  重定向 （Redirect）</p>
<p>•组播侦听者发现协议（RFC2710和RFC3810）</p>
<p>​    ▫Type=130  查询消息</p>
<p>​    ▫Type=131  报告消息</p>
<p>​    ▫Type=132  离开消息</p>
<p>​    ▫Type=143  MLDv2报告消息</p>
<h1 id="2-NDP介绍"><a href="#2-NDP介绍" class="headerlink" title="2.NDP介绍"></a>2.NDP介绍</h1><h2 id="NDP概述"><a href="#NDP概述" class="headerlink" title="NDP概述"></a>NDP概述</h2><h3 id="NDP概述-1"><a href="#NDP概述-1" class="headerlink" title="NDP概述"></a>NDP概述</h3><p>RFC2461定义了IPv6邻居发现协议NDP。NDP是IPv6中非常核心的组件。其主要功能如下：</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/8.png"></p>
<h3 id="NDP报文类型及功能"><a href="#NDP报文类型及功能" class="headerlink" title="NDP报文类型及功能"></a>NDP报文类型及功能</h3><p>NDP使用以下几种ICMPv6报文：</p>
<p>▫RS（Router Solicitation）：路由器请求报文</p>
<p>▫RA（Router Advertisement）：路由器通告报文</p>
<p>▫NS（Neighbor Solicitation）：邻居请求报文</p>
<p>▫NA（Neighbor Advertisement）：邻居通告报文</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/9.png"></p>
<h2 id="路由器发现"><a href="#路由器发现" class="headerlink" title="路由器发现"></a>路由器发现</h2><h3 id="路由器发现-1"><a href="#路由器发现-1" class="headerlink" title="路由器发现"></a>路由器发现</h3><p>•路由器发现是指主机发现本地链路上路由器和确定其配置信息的过程。</p>
<p>•路由器发现可以同时实现以下三个功能：</p>
<ul>
<li><p>路由器发现 （Router Discovery）：主机定位邻居路由器以及选择哪一个路由器作为缺省网关的过程。</p>
</li>
<li><p>前缀发现 （Prefix Discovery）：主机发现本地链路上的一组IPv6前缀的过程，用于主机的地址自动配置。</p>
</li>
<li><p>参数发现 （Parameter Discovery）：主机发现相关操作参数的过程，如输出报文的缺省跳数限制、地址配置方式等信息。</p>
</li>
</ul>
<p>•使用报文：</p>
<ul>
<li><p>RS 路由器请求 </p>
</li>
<li><p>RA 路由器通告</p>
</li>
</ul>
<p>•协议交互主要有两种情况：</p>
<ul>
<li><p>主机发送RS触发路由器回应RA</p>
</li>
<li><p>路由器周期发送RA</p>
</li>
</ul>
<h3 id="路由器发现流程-主机请求触发"><a href="#路由器发现流程-主机请求触发" class="headerlink" title="路由器发现流程 - 主机请求触发"></a>路由器发现流程 - 主机请求触发</h3><p>当主机启动时，主机会向本地链路范围内所有的路由器发送RS报文，触发路由器响应RA报文。主机发现本地链路上的路由器后，自动配置缺省路由器，建立缺省路由表、前缀列表和设置其它的配置参数。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/10.png"></p>
<h3 id="路由器发现流程-路由器周期性发送"><a href="#路由器发现流程-路由器周期性发送" class="headerlink" title="路由器发现流程 - 路由器周期性发送"></a>路由器发现流程 - 路由器周期性发送</h3><p>•路由器周期性的发送RA报文，RA发送间隔是一个有范围的随机值，缺省的最大时间间隔是600秒，最小时间间隔是200秒。</p>
<p>•对于定期发送的RA报文，其地址有如下要求：</p>
<p>▫Source Address：必须是发送接口的链路本地地址。</p>
<p>▫Destination Address ：FF02::1。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/11.png"></p>
<blockquote>
<p>•ipv6 nd ra { max-interval maximum-interval | min-interval minimum-interval }命令用来配置发送周期。</p>
</blockquote>
<h2 id="地址解析"><a href="#地址解析" class="headerlink" title="地址解析"></a>地址解析</h2><h3 id="地址解析-1"><a href="#地址解析-1" class="headerlink" title="地址解析"></a>地址解析</h3><p>•IPv6地址解析通过ICMPv6（NS和NA报文）来实现。</p>
<p>•在三层完成地址解析，主要带来以下几个好处：</p>
<ul>
<li>地址解析在三层完成，不同的二层介质可以采用相同的地址解析协议。</li>
<li>可以使用三层的安全机制避免地址解析攻击。</li>
<li>使用组播方式发送请求报文，减少了二层网络的性能压力。</li>
</ul>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/12.png"></p>
<blockquote>
<p>•本例中，当PC1要传送数据包到PC2时，如果不知道PC2的链路层地址，则需要完成以下协议交互过程：</p>
<ul>
<li><p>PC1发送一个NS报文到网络上，目的地址为PC2对应的被请求节点组播地址（FF02::1:FF84:EFDC），选项字段中带上PC1的链路层地址000D-88F8-03B0。</p>
</li>
<li><p>PC2侦听到该NS报文后，由于报文的目的地址FF02::1:FF84:EFDC，自己在该组播组，处理该报文；同时，根据NS报文的源地址和源链路层地址选项更新自己的邻居缓存表项。</p>
</li>
<li><p>PC2发送一个NA报文应答NS，同时在消息的目标链路层地址选项中带上自己的链路层地址0013-7284-EFDC。</p>
</li>
<li><p>PC1接收到NA报文后，获悉了PC2的链路层地址，创建一个目标节点的邻居缓存表项。</p>
</li>
</ul>
<p>•这样通过交互后，PC1和PC2就知道了对方的链路层地址，建立其对方的邻居缓存表项（类似于IPv4的ARP表），就可以相互通信了。</p>
</blockquote>
<h2 id="邻居状态跟踪"><a href="#邻居状态跟踪" class="headerlink" title="邻居状态跟踪"></a>邻居状态跟踪</h2><h3 id="IPv6邻居状态表"><a href="#IPv6邻居状态表" class="headerlink" title="IPv6邻居状态表"></a>IPv6邻居状态表</h3><p>IPv6邻居状态表中缓存了IPv6地址与MAC地址的映射，可以通过display ipv6 neighbors命令来查看IPv6邻居状态表。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/13.png"></p>
<h3 id="IPv6邻居状态"><a href="#IPv6邻居状态" class="headerlink" title="IPv6邻居状态"></a>IPv6邻居状态</h3><p>IPv6节点需要维护一张邻居表，每个邻居都有相应的状态，状态之间可以迁移。5种邻居状态分别是：未完成（Incomplete）、可达（Reachable）、陈旧（Stale）、延迟（Delay）、探查（Probe）。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/14.png"></p>
<h3 id="邻居状态迁移"><a href="#邻居状态迁移" class="headerlink" title="邻居状态迁移"></a>邻居状态迁移</h3><p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/15.png"></p>
<blockquote>
<p>•R1先发送NS报文，并生成缓存条目，此时，邻居状态为Incomplete。</p>
<p>•若收到R2回复的NA报文，则邻居状态由Incomplete变为Reachable，否则固定时间后邻居状态由Incomplete变为Empty。</p>
<p>•经过邻居可达时间（默认30s），邻居状态由Reachable变为Stale，即未知是否可达。</p>
<ul>
<li>如果在Reachable状态，R1收到R2的非请求NA报文，且其中携带的R2的链路层地址和表项中不同，则邻居状态马上变为Stale。</li>
</ul>
<p>•在Stale状态若R1要向R2发送数据，则邻居状态由Stale变为Delay，并发送NS请求。</p>
<p>•在经过一段固定时间后，邻居状态由Delay变为Probe，其间若有NA应答，则邻居状态由Delay变为Reachable。</p>
<p>•在Probe状态，R1每隔一定时间间隔（默认1s）发送单播NS，发送固定次数后，有应答则邻居状态变为Reachable，否则邻居状态变为Empty。</p>
</blockquote>
<h2 id="重复地址检测"><a href="#重复地址检测" class="headerlink" title="重复地址检测"></a>重复地址检测</h2><h3 id="重复地址检测-1"><a href="#重复地址检测-1" class="headerlink" title="重复地址检测 (1)"></a>重复地址检测 (1)</h3><p>•重复地址检测(Duplicate Address Detect，DAD)是指接口在使用某个IPv6地址之前，需要先探测是否有其它的节点使用了该地址，从而确保网络中没有两个相同的单播地址。</p>
<p>•接口在启用任何一个单播IPv6地址前都需要先进行DAD，包括Link-Local地址。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/16.png"></p>
<blockquote>
<p>•重复地址检测是节点确定即将使用的地址是否被另一节点使用的过程。在节点自动配置某个接口的IPv6单播地址之前，必须在本地链路范围内验证要使用的地址是唯一的，并且未被其他节点使用过。只要NS报文发送到本地链路上（缺省发送一次NS报文），如果在规定时间内没有NA报文进行应答，则认为这个临时单播地址在本地链路上是唯一的，可以分配给接口；反之，这个临时地址是重复的，不能配置到接口。</p>
</blockquote>
<h3 id="重复地址检测-2"><a href="#重复地址检测-2" class="headerlink" title="重复地址检测 (2)"></a>重复地址检测 (2)</h3><p>•一个地址在通过重复地址检测之前称为“tentative地址”，即“试验地址”。此时该接口不能使用这个试验地址进行单播通讯。</p>
<p>•若2个节点配置相同地址，同时作重复地址检测时，当一方收到对方发出的DAD NS报文，则接收方将不启用该地址。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/17.png"></p>
<blockquote>
<p>•特殊情况：有两台主机同时分配到同一个IP地址。假设PC1和PC2都想使用2000::1这个地址，那么进一步假设PC1先发送NS，PC2收到以后将不会发送NS了（当然也不会发送NA），直接停止使用2000::1这个地址，等待其他方式生成新的地址。如果同时收到NS报文，则都会放弃使用2000::1地址。</p>
</blockquote>
<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><h3 id="重定向-1"><a href="#重定向-1" class="headerlink" title="重定向"></a>重定向</h3><p>重定向是指网关设备发现报文从其它网关设备转发更优，它就会发送重定向报文告知报文的发送者，让报文发送者选择另一个网关设备。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/18.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）ICMPv6报文类型分为哪几大类？</p>
<p><strong>A.差错报文</strong></p>
<p><strong>B.信息报文</strong></p>
<p>C.其他报文</p>
<p>D.参数报文</p>
<p>2.（多选题） IPv6地址解析通过以下哪种报文实现？</p>
<p>A.RS</p>
<p>B.RA</p>
<p><strong>C.NS</strong></p>
<p><strong>D.NA</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•ICMPv6是IPv6的基础协议之一，具有差错报文和信息报文两种，用于IPv6节点报告报文处理过程中的错误和信息。其中，差错报文用于报告在转发IPv6数据包过程中出现的错误，如常见的目的不可达、超时等等；信息报文则可以实现路由器发现，重复地址检测，组播成员管理等等。</p>
<p>•NDP是5个ICMPv6信息报文的“打包”，Type133、134为RS、RA报文，可以实现路由器发现，实现主机的网关发现，地址的自动配置；Type135、136为NS、NA报文，可以实现邻居链路层地址解析，重复地址检测；Type137为重定向报文，可以实现重定向。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/" itemprop="url">IP-IPv6概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T12:59:24+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/IPv6%E6%A6%82%E8%BF%B0.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•IPv4协议是目前广泛部署的因特网协议。在因特网发展初期，IPv4以其协议简单、易于实现、互操作性好的优势而得到快速发展。但随着因特网的迅猛发展，IPv4设计的不足也日益明显，IPv6的出现，解决了IPv4的一些弊端。</p>
<p>•IPv6（Internet Protocol Version 6）也被称为IPng（IP Next Generation）。它是Internet工程任务组IETF（Internet Engineering Task Force）设计的一套规范，是IPv4（Internet Protocol Version 4）的升级版本。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述IPv6的发展现状</p>
<p>▫阐明IPv6相较于IPv4的优势</p>
<p>▫描述IPv6的基本概念</p>
<p>▫描述IPv6报文头部的格式</p>
<p>▫描述IPv6地址格式和地址类型</p>
<p>▫实现IPv6地址以及IPv6路由的简单配置</p>
<h1 id="1-IPv6概述"><a href="#1-IPv6概述" class="headerlink" title="1.IPv6概述"></a>1.IPv6概述</h1><h2 id="IPv4现状"><a href="#IPv4现状" class="headerlink" title="IPv4现状"></a>IPv4现状</h2><p>2011年2月3日，IANA（Internet Assigned Numbers Authority，因特网地址分配组织）宣布将其最后的468万个IPv4地址平均分配到全球5个RIR（Regional Internet Registry，区域互联网注册管理机构），此后IANA再没有可分配的IPv4地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/1.png"></p>
<blockquote>
<p>•IANA，是负责全球互联网IP地址编号分配的机构。IANA将部分IPv4地址分配给大洲级的RIR，再由各RIR进行所辖区域内地址分配，五大RIR包括：</p>
<ul>
<li><p>RIPE：Reseaux IP Europeans，欧洲IP地址注册中心，服务于欧洲、中东地区和中亚地区；</p>
</li>
<li><p>LACNIC：Latin American and Caribbean Internet Address Registry，拉丁美洲和加勒比海Internet地址注册中心，服务于中美、南美以及加勒比海地区；</p>
</li>
<li><p>ARIN：American Registry for Internet Numbers，美国Internet编号注册中心，服务于北美地区和部分加勒比海地区；</p>
</li>
<li><p>AFRINIC：Africa Network Information Centre，非洲网络信息中心，服务于非洲地区；</p>
</li>
<li><p>APNIC：Asia Pacific Network Information Centre，亚太互联网络信息中心，服务于亚洲和太平洋地区。</p>
</li>
</ul>
<p>•实践证明IPv4是一个非常成功的协议，它本身也经受住了Internet从少量计算机组网发展到目前上亿台计算机互联的考验。但该协议是几十年前基于当时的网络规模而设计的。在今天看来，IPv4的设计者们对于Internet的估计和预想显得很不充分。随着Internet的扩张和新应用的不断推出，IPv4越来越显示出它的局限性。</p>
<p>•Internet规模的快速扩张是当时完全没有预料到的，特别是近十年来，更是爆炸式增长，已经走进了千家万户，人们的日常生活已经离不开它。但正因为发展太快，IP地址空间耗尽的问题迫在眉睫。</p>
<p>•20世纪90年代，IETF推出NAT（Network Address Translation，网络地址转换）与CIDR（Classless Inter Domain Routing，无类别域间路由）等技术来推迟IPv4地址耗尽发生的时间点。但是这些过渡方案只能减缓地址枯竭的速度，并不能从根本上解决问题。</p>
</blockquote>
<h2 id="全球IPv6发展现状"><a href="#全球IPv6发展现状" class="headerlink" title="全球IPv6发展现状"></a>全球IPv6发展现状</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/2.png"></p>
<blockquote>
<p>•数据来源：《2019 IPv6支持度报告》——下一代互联网国家工程中心</p>
<p>•综合IPv6部署率是根据各个国家地区的网络（IPv6 Prefix/Transit IPv6 AS），IPv6网站及IPv6用户等数据按照一定权值并计算得出的IPv6部署综合情况。</p>
</blockquote>
<h2 id="Why-IPv6"><a href="#Why-IPv6" class="headerlink" title="Why IPv6 ?"></a>Why IPv6 ?</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/3.png"></p>
<h2 id="IPv6优势"><a href="#IPv6优势" class="headerlink" title="IPv6优势"></a>IPv6优势</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/4.png"></p>
<blockquote>
<p>•近乎无限的地址空间：与IPv4相比，这是最明显的好处。IPv6地址是由128 bit构成，单从数量级来说，IPv6所拥有的地址容量是IPv4的约8×1028倍，号称可以为全世界的每一粒沙分配一个网络地址。这使得海量终端同时在线，统一编址管理，变为可能，为万物互连提供了强有力的支撑。</p>
<p>•层次化的地址结构：正因为有了近乎无限的地址空间，IPv6在地址规划时就根据使用场景划分了各种地址段。同时严格要求单播IPv6地址段的连续性，便于IPv6路由聚合，缩小IPv6地址表规模。</p>
<p>•即插即用：任何主机或者终端要获取网络资源，传输数据，都必须有明确的IP地址。传统的分配IP地址方式是手工或者DHCP自动获取，除了上述两个方式外，IPv6还支持SLAAC（Stateless Address Autoconfiguration，无状态地址自动配置）。</p>
<p>•端到端网络的完整性：大面积使用NAT技术的IPv4网络，从根本上破坏了端到端连接的完整性。使用IPv6之后，将不再需要NAT网络设备，上网行为管理、网络监管等将变得简单，与此同时，应用程序也不需要开发复杂的NAT适配代码。</p>
<p>•安全性得到增强：IPsec（ Internet Protocol Security，因特网协议安全协议）最初是为IPv6设计的，所以基于IPv6的各种协议报文（路由协议、邻居发现等），都可以端到端地加密，当然该功能目前应用并不多。而IPv6的数据面报文安全性，跟IPv4+IPsec的能力，基本相同。</p>
<p>•可扩展性强：IPv6的扩展属性报文头部，并不是主数据包的一部分，但是在必要的时候，这些扩展头部会插在IPv6基本头部和有效载荷之间，能够协助IPv6完成加密功能、移动功能、最优路径选路、QoS等，并可提高报文转发效率。</p>
<p>•移动性改善：当一个用户从一个网段移动到另外一个网段，传统的网络会产生经典式“三角式路由”，IPv6网络中，这种移动设备的通信，可不再经过原“三角式路由”，而做直接路由转发，降低了流量转发的成本，提升了网络性能和可靠性。</p>
<p>•QoS可得到进一步增强：IPv6保留了IPv4所有的QoS属性，额外定义了20Byte 的流标签字段，可为应用程序或者终端所用，针对特殊的服务和数据流，分配特定的资源，目前该机制并没有得到充分的开发和应用。</p>
</blockquote>
<h2 id="IPv6过渡技术简介-1"><a href="#IPv6过渡技术简介-1" class="headerlink" title="IPv6过渡技术简介 (1)"></a>IPv6过渡技术简介 (1)</h2><p>•由于NAT技术的应用，缓解了IPv4地址不足产生的问题，但是部署IPv6是解决IPv4地址不足的最终方案。当前世界上不同地区对部署IPv6的需求强烈程度不一，且当前IPv4网络仍然占主流地位，因此短时间内IPv6和IPv4将会共存。</p>
<p>•IPv4网络演变为IPv6网络主要有以下三种技术：</p>
<p>​    ▫双栈技术：在一台设备上同时启用IPv4协议栈和IPv6协议栈的技术。</p>
<p>​    ▫隧道技术：将一种协议的数据封装在另一种协议中的技术。</p>
<p>​    ▫转换技术：将IPv6地址和IPv4地址进行转换的一种技术。</p>
<p>•没有最好的过渡技术方案，没有任何一种技术方案能够解决所有问题，通常是多种技术组合成不同的过渡方案，满足不同的网络访问场景。</p>
<h2 id="IPv6过渡技术简介-2"><a href="#IPv6过渡技术简介-2" class="headerlink" title="IPv6过渡技术简介 (2)"></a>IPv6过渡技术简介 (2)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/5.png"></p>
<h2 id="IPv6路由协议简介"><a href="#IPv6路由协议简介" class="headerlink" title="IPv6路由协议简介"></a>IPv6路由协议简介</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/6.png"></p>
<h1 id="2-IPv6地址介绍"><a href="#2-IPv6地址介绍" class="headerlink" title="2.IPv6地址介绍"></a>2.IPv6地址介绍</h1><h2 id="IPv6地址概述"><a href="#IPv6地址概述" class="headerlink" title="IPv6地址概述"></a>IPv6地址概述</h2><h3 id="IPv6地址"><a href="#IPv6地址" class="headerlink" title="IPv6地址"></a>IPv6地址</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/7.png"></p>
<h3 id="地址空间"><a href="#地址空间" class="headerlink" title="地址空间"></a>地址空间</h3><p>•为什么IPv6协议的地址长度是128bit？</p>
<ul>
<li><p>CPU处理字长发展至今分别经历了4bit、8bit、16bit、32bit、64bit等，当数据能用2的指数幂字长的二进制数表示时，CPU对数值的处理效率最高。</p>
</li>
<li><p>IPv4地址长度为32bit，原因之一就是当时互联网上的主机CPU字长为32bit。从处理效率和未来网络扩展性上考虑，将IPv6的地址长度定为128bit是十分合适的。</p>
</li>
</ul>
<p>•IPv6的128bit地址是一个什么概念？</p>
<ul>
<li><p>IPv4有（232）= 4,294,967,296个地址。</p>
</li>
<li><p>IPv6有（2128 = 296x232 ）= 340,282,366,920,938,463,463,374,607,431,768,211,456个地址(340万亿万亿万亿个地址)，相当于地球表面每平方米可以分配到67万亿个地址。</p>
</li>
<li><p>夸张的说，地球上每一粒沙子都可以分配到一个IPv6地址。</p>
</li>
</ul>
<h3 id="IPv6地址格式"><a href="#IPv6地址格式" class="headerlink" title="IPv6地址格式"></a>IPv6地址格式</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/8.png"></p>
<blockquote>
<p>•IPv4地址使用点隔开的4段十进制数加上掩码来表示，例如192.168.1.1/24。IPv6的地址有128位，沿用IPv4的十进制表示方法就显得太笨拙了，所以在RFC2373中定义了不同于IPv4的格式。</p>
</blockquote>
<h3 id="IPv6地址结构"><a href="#IPv6地址结构" class="headerlink" title="IPv6地址结构"></a>IPv6地址结构</h3><p>•一个IPv6地址可以分为如下两部分：</p>
<p>​    ▫网络前缀：nbit，相当于IPv4地址中的网络ID。</p>
<p>​    ▫接口标识：（128-n）bit，相当于IPv4地址中的主机ID。</p>
<p>•IPv6单播地址示例：2001:0DB8:6101:0001:5ED9:98FF:FECA:A298/64。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/9.png"></p>
<h3 id="IPv6地址前缀"><a href="#IPv6地址前缀" class="headerlink" title="IPv6地址前缀"></a>IPv6地址前缀</h3><p>•鉴于IPv4地址在规划和分配上的局限性，IETF对IPv6地址类型进行了精细划分，不同类型的IPv6地址被赋予了不同的前缀，且受地址分配机构的严格管理。</p>
<p>•现阶段，常用的IPv6地址或前缀有：</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/10.png"></p>
<blockquote>
<p>•IPv6前缀 IANA最新定义</p>
</blockquote>
<h3 id="IPv6地址接口标识"><a href="#IPv6地址接口标识" class="headerlink" title="IPv6地址接口标识"></a>IPv6地址接口标识</h3><p>•接口ID可通过三种方式生成：手工配置、系统自动生成，或基于IEEE EUI-64规范生成。</p>
<p>•其中，基于IEEE EUI-64规范自动生成接口ID的方式最为常用，该方式将接口的MAC地址转换为IPv6接口标识。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/11.png"></p>
<blockquote>
<p>目前有三种方式可以产生IPv6接口ID：</p>
<p>▫IEEE EUI-64规范</p>
<ul>
<li><p>接口ID的典型长度是64位，IEEE EUI-64规范给出了一个由48位MAC地址自动生成64位Interface ID的方法。</p>
</li>
<li><p>具体的转换算法为：将上述的第7bit0转换为1，在MAC地址的中间（24bit处）插入两个字节：FFFE。</p>
</li>
<li><p>这种由MAC地址产生IPv6地址接口ID的方法可以减少配置的工作量，只需要获取一个IPv6前缀就可以与接口ID形成IPv6地址。</p>
</li>
<li><p>使用这种方式最大的缺点就是某些恶意者可以通过二层MAC推算出三层IPv6地址。</p>
</li>
</ul>
<p>▫设备随机生成</p>
<ul>
<li>设备采用随机生成的方法产生一个接口ID，目前Windows操作系统使用该方式。</li>
</ul>
<p>▫手动配置</p>
<ul>
<li>顾名思义，手动配置就是人为指定接口ID来实现。</li>
</ul>
</blockquote>
<h2 id="IPv6地址类型"><a href="#IPv6地址类型" class="headerlink" title="IPv6地址类型"></a>IPv6地址类型</h2><h3 id="IPv6地址类型-1"><a href="#IPv6地址类型-1" class="headerlink" title="IPv6地址类型"></a>IPv6地址类型</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/12.png"></p>
<p>•<strong>单播地址（Unicast Address）</strong>：标识一个接口，目的地址为单播地址的报文会被送到被标识的接口。在IPv6中，一个接口拥有多个IPv6地址是非常常见的现象。</p>
<p>•<strong>组播地址（Multicast Address）：</strong>标识多个接口，目的地址为组播地址的报文会被送到被标识的所有接口。只有加入相应组播组的设备接口才会侦听发往该组播地址的报文。</p>
<p>•<strong>任播地址（AnycastAddress）：</strong>任播地址标识一组网络接口（通常属于不同的节点）。目标地址是任播地址的数据包将发送给其中路由意义上最近的一个网络接口。</p>
<p>•<strong>IPv6没有定义广播地址（Broadcast Address）</strong></p>
<h3 id="IPv6常见单播地址-GUA"><a href="#IPv6常见单播地址-GUA" class="headerlink" title="IPv6常见单播地址 - GUA"></a>IPv6常见单播地址 - GUA</h3><p>GUA（Global Unicast Address，全球单播地址），也被称为可聚合全球单播地址。该类地址全球唯一，用于需要有互联网访问需求的主机，相当于IPv4的公网地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/13.png"></p>
<h3 id="IPv6常见单播地址-ULA"><a href="#IPv6常见单播地址-ULA" class="headerlink" title="IPv6常见单播地址 - ULA"></a>IPv6常见单播地址 - ULA</h3><p>ULA（Unique Local Address，唯一本地地址）是IPv6私网地址，只能够在内网中使用。该地址空间在IPv6公网中不可被路由，因此不能直接访问公网。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/14.png"></p>
<h3 id="IPv6常见单播地址-LLA"><a href="#IPv6常见单播地址-LLA" class="headerlink" title="IPv6常见单播地址 - LLA"></a>IPv6常见单播地址 - LLA</h3><p>LLA（Link-Local Address，链路本地地址）是IPv6中另一种应用范围受限制的地址类型。LLA的有效范围是本地链路，前缀为FE80::/10。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/15.png"></p>
<h3 id="IPv6组播地址"><a href="#IPv6组播地址" class="headerlink" title="IPv6组播地址"></a>IPv6组播地址</h3><p>IPv6组播地址标识某个组，目的为组播地址的报文会被送到该组播组内的成员。组播地址由前缀（FF::/8），标志（Flag）字段、范围（Scope）字段以及组播组ID（Group ID）4个部分组成。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/16.png"></p>
<h3 id="IPv6组播MAC"><a href="#IPv6组播MAC" class="headerlink" title="IPv6组播MAC"></a>IPv6组播MAC</h3><p>•组播IPv6报文的目的IP为组播IPv6地址，同样，目的MAC为组播MAC地址。</p>
<p>•组播MAC的前16bit为“33:33”，是专门为IPv6组播预留的MAC地址前缀。后32bit从组播IPv6地址的后32bit直接映射而来。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/17.png"></p>
<blockquote>
<p>•以太网传输单播IP报文的时候，目的MAC地址是下一跳的MAC地址。但是在传输组播数据包时，其目的地不再是一个具体的接收者，而是一个成员不确定的组，所以要使用组播MAC地址。</p>
<p>•IPv4组播MAC地址</p>
<ul>
<li><p>IANA规定，IPv4组播MAC地址的高24bit为0x01005E，第25bit为0，低23bit为IPv4组播地址的低23bit映射。</p>
</li>
<li><p>由于IPv4组播地址的高4bit是1110，代表组播标识，而低28bit中只有23bit被映射到IPv4组播MAC地址，这样IPv4组播地址中就有5bit信息丢失。于是，就有32个IPv4组播地址映射到了同一个IPv4组播MAC地址上，因此在二层处理过程中，设备可能要接收一些本IPv4组播组以外的组播数据，而这些多余的组播数据就需要上层进行过滤了。</p>
</li>
</ul>
<p>•IPv6组播MAC地址</p>
<ul>
<li>在以太网链路上发送IPv6组播数据包时，对应的MAC地址是0x3333-A-A-A-A，其中A-A-A-A是组播IP地址的后32bit的直接映射。</li>
</ul>
</blockquote>
<h3 id="被请求节点组播地址"><a href="#被请求节点组播地址" class="headerlink" title="被请求节点组播地址"></a>被请求节点组播地址</h3><p>当一个节点具有了单播或任播地址，就会对应生成一个被请求节点组播地址，并且加入这个组播组。该地址主要用于邻居发现机制和地址重复检测功能。被请求节点组播地址的有效范围为本地链路范围。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/18.png"></p>
<blockquote>
<p>•被请求节点组播地址的应用场景举例：在IPv6中，ARP及广播都被取消，当设备需要请求某个IPv6地址对应的MAC地址时，设备依然需要发送请求报文，但是该报文是一个组播报文，其目的IPv6地址是目标IPv6单播地址对应的被请求节点组播地址，由于只有目标节点才会侦听这个被请求节点组播地址，所以该组播报文可以被目标节点所接收，同时不会占用其他非目标节点的网络性能。</p>
</blockquote>
<h3 id="被请求节点组播地址-示例"><a href="#被请求节点组播地址-示例" class="headerlink" title="被请求节点组播地址 - 示例"></a>被请求节点组播地址 - 示例</h3><p>PC1发送数据至PC2前，首先需要获取其MAC地址。PC1将发起类似IPv4中ARP的解析流程，IPv6使用ICMPv6的NS及NA报文来实现地址解析过程，NS报文的目的IPv6地址为目标IPv6单播地址对应的被请求节点组播地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/19.png"></p>
<h3 id="IPv6任播地址"><a href="#IPv6任播地址" class="headerlink" title="IPv6任播地址"></a>IPv6任播地址</h3><p>任播地址标识一组网络接口（通常属于不同的节点）。任播地址可以作为IPv6报文的源地址，也可以作为目的地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/20.png"></p>
<blockquote>
<p>•任播过程涉及一个任播报文发起方和一个或多个响应方。</p>
<ul>
<li><p>任播报文的发起方通常为请求某一服务（例如，Web服务）的主机。</p>
</li>
<li><p>任播地址与单播地址在格式上无任何差异，唯一的区别是一台设备可以给多台具有相同地址的设备发送报文。</p>
</li>
</ul>
<p>•网络中运用任播地址有很多优势：</p>
<ul>
<li><p>业务冗余。比如，用户可以通过多台使用相同地址的服务器获取同一个服务（例如，Web服务）。这些服务器都是任播报文的响应方。如果不是采用任播地址通信，当其中一台服务器发生故障时，用户需要获取另一台服务器的地址才能重新建立通信。如果采用的是任播地址，当一台服务器发生故障时，任播报文的发起方能够自动与使用相同地址的另一台服务器通信，从而实现业务冗余。</p>
</li>
<li><p>提供更优质的服务。比如，某公司在A省和B省各部署了一台提供相同Web服务的服务器。基于路由优选规则，A省的用户在访问该公司提供的Web服务时，会优先访问部署在A省的服务器，提高访问速度，降低访问时延，大大提升了用户体验。</p>
</li>
</ul>
</blockquote>
<h3 id="IPv6地址和IPv4地址比较"><a href="#IPv6地址和IPv4地址比较" class="headerlink" title="IPv6地址和IPv4地址比较"></a>IPv6地址和IPv4地址比较</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/21.png"></p>
<h2 id="IPv6地址规划举例"><a href="#IPv6地址规划举例" class="headerlink" title="IPv6地址规划举例"></a>IPv6地址规划举例</h2><h3 id="IPv6地址规划举例-1"><a href="#IPv6地址规划举例-1" class="headerlink" title="IPv6地址规划举例"></a>IPv6地址规划举例</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/22.png"></p>
<blockquote>
<p>•地址规划设计建议：</p>
<ul>
<li>根据获取到的地址前缀，首先确定子网地址划分为几个功能块(如图中的3+3+6+N)，明确各功能块的含义、占用多少bit，避免地址浪费。</li>
</ul>
</blockquote>
<h3 id="IPv6地址使用建议"><a href="#IPv6地址使用建议" class="headerlink" title="IPv6地址使用建议"></a>IPv6地址使用建议</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/23.png"></p>
<h1 id="3-IPv6报文结构"><a href="#3-IPv6报文结构" class="headerlink" title="3.IPv6报文结构"></a>3.IPv6报文结构</h1><h2 id="IPv6报文构成"><a href="#IPv6报文构成" class="headerlink" title="IPv6报文构成"></a>IPv6报文构成</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/24.png"></p>
<p>IPv6报文一般由三个部分组成：</p>
<p><strong>基本报头：</strong>提供报文转发的基本信息，路由器通过解析基本报头就能完成绝大多数的报文转发任务。</p>
<p><strong>扩展报头：</strong>提供一些扩展的报文转发信息，如分段、加密等，该部分不是必需的，也不是每个路由器都需要处理，仅当需要路由器或目的节点做某些特殊处理时，才由发送方添加一个或多个扩展头。</p>
<p><strong>上层协议数据单元：</strong>一般由上层协议报头和它的有效载荷构成，该部分与IPv4的上层协议数据单元相似。</p>
<blockquote>
<p>•从图中可以看出IPv6数据报文由以下几个部分组成：</p>
<p>▫<strong>IPv6基本报头（IPv6 Header）</strong></p>
<ul>
<li><p>每一个IPv6数据报文都必须包含报头，其长度固定为40字节。</p>
</li>
<li><p>基本报头提供报文转发的基本信息，会被转发路径上的所有路由器解析。</p>
</li>
</ul>
<p>▫<strong>扩展报头（Extension Headers）</strong></p>
<ul>
<li>IPv6扩展报头是可能跟在基本IPv6报头后面的可选报头。IPv6数据包中可以包含一个或多个扩展报头，当然也可以没有扩展头，这些扩展报头可以具有不同的长度。IPv6报头和扩展报头代替了IPv4报头及其选项。新的扩展报头格式增强了IPv6的功能，使其具有极大的扩展性。与IPv4报头中的选项不同，IPv6扩展报头没有最大长度的限制，因此可以容纳IPv6通信所需要的所有扩展数据。扩展报头提供报文转发的扩展信息，并不会被路径上所有的路由器解析，一般只会被目的路由器解析处理。</li>
</ul>
<p>▫<strong>上层协议数据单元（Upper Layer Protocol Data Unit）</strong></p>
<ul>
<li>上层协议数据单元一般由上层协议报头和它的有效载荷构成，有效载荷可以是一个ICMPv6报文、一个TCP报文或一个UDP报文。 </li>
</ul>
</blockquote>
<h2 id="IPv6基本报头"><a href="#IPv6基本报头" class="headerlink" title="IPv6基本报头"></a>IPv6基本报头</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/25.png"></p>
<blockquote>
<p>•IPv6基本报头也称之为固定报头。固定报头包含8个字段，总长度为40Byte。这8个字段分别为：版本（Version）、流量类型（Traffic Class）、流标签（Flow Label）、净荷长度（Payload Length）、下一个报头（Next Header）、跳数限制（Hop Limit）、源IPv6地址、目的IPv6地址。</p>
<p>•版本（Version）</p>
<p>​    ▫该字段规定了IP协议的版本，其值为6。长度为4bit。</p>
<p>•流类别（Traffic Class）</p>
<p>​    ▫该字段功能和IPv4中的服务类型功能类似，表示IPv6数据报文的类    或优先级。长度为8bit。</p>
<p>•流标签（Flow Label）</p>
<p>​    ▫与IPv4相比，该字段是新增的。它用来标识这个数据报属于源节    点和目标节点之间的一个特定数据报序列，它需要由中间IPv6路由    器进行特殊处理。该字段长度为20bit。一般来说一个流可以通过    源/目的IPv6地址和流标签来确定。</p>
<p>•有效载荷长度（Payload Length）</p>
<p>​    ▫该字段表示IPv6数据报有效载荷的长度。有效载荷是指紧跟IPv6报    头的数据报的其它部分（即扩展报头和上层协议数据单元）。该字    段长度为16bit，能表示最大长度为65535Byte的有效载荷。如果有    效载荷的长度超过这个值，该字段会置0，而有效载荷的长度用逐    跳选项扩展报头中的超大有效载荷选项来表示。</p>
<p>•下一个报头（Next Header）</p>
<p>​    ▫该字段定义紧跟在IPv6报头后面的第一个扩展报头（如果存在）    的类型，或者上层协议数据单元中的协议类型。该字段长度8bit。</p>
<p>•跳数限制（Hop Limit）</p>
<p>​    ▫该字段类似于IPv4中的TTL（Time to Live）字段。它定义了IP数    据报所能经过的最大跳数。每经过一个路由器，该数值减去1，当    该字段的值为0时，数据报将被丢弃。该字段长度为8bit。</p>
<p>•源地址（Source Address）</p>
<p>​    ▫表示发送方的地址，长度为128bit。</p>
<p>•目的地址（Destination Address）</p>
<p>​    ▫表示接收方的地址，长度为128bit。</p>
</blockquote>
<h2 id="IPv6扩展报头-1"><a href="#IPv6扩展报头-1" class="headerlink" title="IPv6扩展报头 (1)"></a>IPv6扩展报头 (1)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/26.png"></p>
<blockquote>
<p>•IPv6报头设计中对原IPv4报头所做的一项重要改进就是将所有可选字段移出IPv6报头，置于扩展头中。IPv6扩展报头是可能跟在基本IPv6报头后面的可选报头。为什么在IPv6中要设计扩展报头呢？因为在IPv4的报头中包含了所有的选项，每个中间路由器都必须检查这些选项是否存在，如果存在，就必须处理它们。这种设计方法会降低路由器转发IPv4数据包的效率。为了解决转发效率问题，在IPv6中，相关选项被移到了扩展报头中。中间路由器就不需要处理每一个可能出现的选项，这种处理方式提高了路由器处理数据包的速度，也提高了其转发性能。　　</p>
<p>•通常，一个典型的IPv6包，没有扩展头。仅当需要路由器或目的节点做某些特殊处理时，才由发送方添加一个或多个扩展头。与IPv4不同，IPv6扩展头长度任意，不受40Byte限制，以便于日后扩充新增选项，这一特征加上选项的处理方式使得IPv6选项能得以真正的利用。但是为了提高处理选项头和传输层协议的性能，扩展头总是8Byte长度的整数倍。</p>
</blockquote>
<h2 id="IPv6扩展报头-2"><a href="#IPv6扩展报头-2" class="headerlink" title="IPv6扩展报头 (2)"></a>IPv6扩展报头 (2)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/27.png"></p>
<blockquote>
<p>•目前，RFC 2460中定义了以下6个IPv6扩展头：</p>
<ul>
<li><p>逐跳选项报头：该扩展头被每一跳处理，可包含多种选项，如路由器告警选项。</p>
</li>
<li><p>目的选项报头：目的地处理， 可包含多种选项，如Mobile IPv6的家乡地址选项。</p>
</li>
<li><p>路由报头：指定源路由，类似IPv4源路由选项，IPv6源节点用来指定信息报到达目的地的路径上所必须经过的中间节点。IPv6基本报头的目的地址不是分组的最终目的地址，而是路由扩展头中所列的第一个地址。</p>
</li>
<li><p>分段报头：IP报文分片信息，只由目的地处理。</p>
</li>
<li><p>认证报头：IPSec用扩展头， 只由目的地处理。</p>
</li>
<li><p>封装安全净载报头：IPSec用扩展头，只由目的地处理。</p>
</li>
</ul>
<p>•逐跳选项扩展头和目的地选项扩展头内部提供选项功能，支持扩展性（如对移动性支持）。选项采用TLV方式。</p>
<p>•如果数据报中没有扩展报头，也就是说数据包只包含基本报头和上层协议单元，基本报头的下一个报头（Next Header）字段值指明上层协议类型。在上例中，基本报头的下一个报头字段值为6，说明上层协议为TCP；如果报文有一个扩展报头，则基本报头的下一个报头（Next Header）字段值为扩展报头类型（在上例中，指明紧跟在基本报头后面的扩展报头为43，也就是路由报头），扩展报头的下一个报头字段指明上层协议类型；以此类推，如果数据报中报括多个扩展报头，则每一个扩展报头的下一个报头指明紧跟着自己的扩展报头的类型，最后一个扩展报头的下一个报头字段指明上层协议。</p>
</blockquote>
<h1 id="4-IPv6基础配置"><a href="#4-IPv6基础配置" class="headerlink" title="4.IPv6基础配置"></a>4.IPv6基础配置</h1><h2 id="配置介绍-1"><a href="#配置介绍-1" class="headerlink" title="配置介绍 (1)"></a>配置介绍 (1)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/28.png"></p>
<h2 id="配置介绍-2"><a href="#配置介绍-2" class="headerlink" title="配置介绍 (2)"></a>配置介绍 (2)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/29.png"></p>
<h2 id="案例：配置一个双栈网络-1"><a href="#案例：配置一个双栈网络-1" class="headerlink" title="案例：配置一个双栈网络 (1)"></a>案例：配置一个双栈网络 (1)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/30.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/31.png"></p>
<h2 id="案例：配置一个双栈网络-2"><a href="#案例：配置一个双栈网络-2" class="headerlink" title="案例：配置一个双栈网络 (2)"></a>案例：配置一个双栈网络 (2)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/32.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/33.png"></p>
<h2 id="案例：配置一个双栈网络-3"><a href="#案例：配置一个双栈网络-3" class="headerlink" title="案例：配置一个双栈网络 (3)"></a>案例：配置一个双栈网络 (3)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/32.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/34.png"></p>
<h2 id="配置验证"><a href="#配置验证" class="headerlink" title="配置验证"></a>配置验证</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/36.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/37.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）简述IPv6相比于IPv4的优点。</p>
<p><strong>“无限”地址空间，层次化的地址结构，即插即用，简化的报文头部，安全特性，移动性，增强的QoS特性。</strong></p>
<p>2.（简答题）简述IPv6报文头相比于IPv4的不同之处。</p>
<p><strong>IPv6与IPv4的不同之处：</strong></p>
<ul>
<li><p><strong>采用了基本报头+扩展报头的报文形式。</strong></p>
</li>
<li><p><strong>取消了IP的校验：第二层和第四层的校验已经足够健壮了，因此IPv6直接取消了IP的三层校验，节省路由器处理资源。</strong></p>
</li>
<li><p><strong>取消中间节点的分片功能：中间路由器不再处理分片，只在产生数据的源节点处理，省却中间路由器为处理分片而耗费的大量CPU资源。</strong></p>
</li>
<li><p><strong>定义定长的IPv6报头：有利于硬件的快速处理，提高路由器转发效率。</strong></p>
</li>
<li><p><strong>安全选项的支持：IPv6提供了对IPSec的完美支持，如此上层协议可以省去许多安全选项。</strong></p>
</li>
<li><p><strong>增加流标签：提高QoS效率。</strong></p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•IPv6作为下一代互联网协议，具备了IPv4无法比拟的诸多优点，可以完美解决现阶段IPv4无法满足的业务发展的问题。</p>
<p>•IPv6不仅仅具有庞大的地址空间，除此以外，IPv6还简化了报文头，提升了路由器报文转发效率；IPv6地址易于划分与规划，便于路由聚合；IPv6可以实现即插即用，增强了QoS等等……</p>
<p>•通过版本升级（OSPFv3）或者协议扩展（IS-IS、BGP4+），使得在IPv4网络中常用的动态路由协议在IPv6网络中仍然可以使用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/mydog.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">72</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">74</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zsy9959" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zsy9959@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张思宇</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
