<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="my blog">
<meta property="og:type" content="website">
<meta property="og:title" content="zsy&#39;s blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="zsy&#39;s blog">
<meta property="og:description" content="my blog">
<meta property="og:locale">
<meta property="article:author" content="张思宇">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/page/2/"/>





  <title>zsy's blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zsy's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">just simple</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/home" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/" itemprop="url">IP-IPv6地址配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T13:28:33+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•IPv6是下一代互联网的核心协议，它解决了IPv4所暴露的诸多缺陷，如地址稀缺、路由表庞大、对移动设备支持不足等。</p>
<p>•IPv6的一个突出特点是支持网络节点的地址自动配置，真正实现即插即用，极大地简化网络管理者的工作。</p>
<p>•本课程将介绍IPv6地址自动配置的工作原理与配置实现。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述IPv6无状态地址自动配置的工作原理</p>
<p>▫描述DHCPv6地址自动配置的工作原理</p>
<p>▫实现IPv6地址自动配置</p>
<h1 id="1-IPv6地址配置方式"><a href="#1-IPv6地址配置方式" class="headerlink" title="1.IPv6地址配置方式"></a>1.IPv6地址配置方式</h1><h2 id="IPv6地址配置方式"><a href="#IPv6地址配置方式" class="headerlink" title="IPv6地址配置方式"></a>IPv6地址配置方式</h2><p>IPv6地址配置的方式可以分为静态配置和动态配置。其中，动态地址配置又可以分为无状态地址自动配置（Stateless Address Autoconfiguration, SLAAC）和有状态地址自动配置（Stateful Address Autoconfiguration)。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/1.png"></p>
<h2 id="IPv6地址自动配置的分类"><a href="#IPv6地址自动配置的分类" class="headerlink" title="IPv6地址自动配置的分类"></a>IPv6地址自动配置的分类</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/2.png"></p>
<h1 id="2-IPv6地址无状态自动配置"><a href="#2-IPv6地址无状态自动配置" class="headerlink" title="2.IPv6地址无状态自动配置"></a>2.IPv6地址无状态自动配置</h1><h2 id="IPv6地址无状态自动配置过程"><a href="#IPv6地址无状态自动配置过程" class="headerlink" title="IPv6地址无状态自动配置过程"></a>IPv6地址无状态自动配置过程</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/3.png"></p>
<h2 id="IPv6地址无状态自动配置示例"><a href="#IPv6地址无状态自动配置示例" class="headerlink" title="IPv6地址无状态自动配置示例"></a>IPv6地址无状态自动配置示例</h2><p>IPv6无状态地址配置通过交互RS和RA报文完成。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•基于NDP的IPv6地址无状态自动配置具体过程如下（DAD略）：</p>
<p>1.PC1首先生成链路本地地址FE80::1002，然后向本地链接中所有路由器发送路由器请求（RS）。</p>
<p>2.R1发送RA携带着用于无状态地址自动配置的前缀信息，本例中，该前缀为2001:DB8::/64。</p>
<p>3.PC1收到RA报文后，根据RA报文中携带的前缀信息加上接口ID生成IPv6地址2001:DB8::1002。</p>
</blockquote>
<h2 id="RA报文中的Flags字段"><a href="#RA报文中的Flags字段" class="headerlink" title="RA报文中的Flags字段"></a>RA报文中的Flags字段</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/5.png"></p>
<h2 id="RA报文中的可选信息：地址前缀信息"><a href="#RA报文中的可选信息：地址前缀信息" class="headerlink" title="RA报文中的可选信息：地址前缀信息"></a>RA报文中的可选信息：地址前缀信息</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/6.png"></p>
<h2 id="RA报文中的可选信息：生存周期"><a href="#RA报文中的可选信息：生存周期" class="headerlink" title="RA报文中的可选信息：生存周期"></a>RA报文中的可选信息：生存周期</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/7.png"></p>
<h1 id="3-DHCPv6"><a href="#3-DHCPv6" class="headerlink" title="3.DHCPv6"></a>3.DHCPv6</h1><h2 id="DHCPv6概述"><a href="#DHCPv6概述" class="headerlink" title="DHCPv6概述"></a>DHCPv6概述</h2><p>•DHCPv6针对IPv6编址方案设计，支持对客户端分配IPv6前缀、IPv6地址和其他网络配置参数，并记录这些信息，便于网络管理。</p>
<p>•DHCPv6又分为如下三种：</p>
<ul>
<li><p>DHCPv6有状态自动配置：DHCPv6服务器自动配置IPv6地址/前缀及其他网络配置参数（DNS、NIS、SNTP服务器地址等参数）。</p>
</li>
<li><p>DHCPv6无状态自动配置：主机IPv6地址仍然通过路由通告方式自动生成，DHCPv6服务器只分配除IPv6地址以外的配置参数，包括DNS服务器等参数。</p>
</li>
<li><p>DHCPv6 PD（Prefix Delegation，前缀代理）自动配置：下层网络路由器不需要再手工指定用户侧链路的IPv6地址前缀，它只需要向上层网络路由器提出前缀分配申请，上层网络路由器便可以分配合适的地址前缀给下层路由器，下层路由器把获得的前缀（前缀一般长度小于64）进一步自动细分成64位前缀长度的子网网段，把细分的地址前缀再通过路由通告(RA)至与IPv6主机直连的用户链路上，实现主机的地址自动配置，从而完成整个IPv6网络的层次化布局。</p>
</li>
</ul>
<h2 id="DHCPv6网络构成"><a href="#DHCPv6网络构成" class="headerlink" title="DHCPv6网络构成"></a>DHCPv6网络构成</h2><p>DHCPv6基本协议架构中，主要包括以下三种角色：</p>
<ul>
<li><p>DHCPv6 Client：DHCPv6客户端，通过与DHCPv6服务器进行报文交互，获取IPv6地址/前缀和其他网络配置参数，完成自身的网络配置。</p>
</li>
<li><p>DHCPv6 Server：DHCPv6服务器，负责处理来自客户端或中继的地址分配、地址续租、地址释放等请求，为客户端分配IPv6地址/前缀和其他网络配置参数。</p>
</li>
<li><p>DHCPv6 Relay：DHCPv6中继，负责转发来自客户端或服务器的DHCPv6报文，协助DHCPv6客户端和DHCPv6服务器完成地址配置功能。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/8.png"></p>
<h2 id="DHCPv6中的常用概念"><a href="#DHCPv6中的常用概念" class="headerlink" title="DHCPv6中的常用概念"></a>DHCPv6中的常用概念</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/9.png"></p>
<blockquote>
<p>•有效时间（Valid Lifetime）：地址/前缀的生命周期。用于指定地址/前缀的过期时间，过期后所有使用该地址/前缀的用户下线。此时间必须配置为不小于3小时，且不得小于优先级时间。</p>
<p>•优选时间（Preferred Lifetime）：用于计算续租时间和重绑定时间。此时间必须配置为不小于2小时。</p>
</blockquote>
<h2 id="DHCPv6有状态自动配置-四步交互"><a href="#DHCPv6有状态自动配置-四步交互" class="headerlink" title="DHCPv6有状态自动配置 - 四步交互"></a>DHCPv6有状态自动配置 - 四步交互</h2><p>四步交互是指DHCPv6客户端与服务器交互四次来完成前缀/地址等参数获取的过程。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/10.png"></p>
<h2 id="DHCPv6有状态自动配置-两步交互"><a href="#DHCPv6有状态自动配置-两步交互" class="headerlink" title="DHCPv6有状态自动配置 - 两步交互"></a>DHCPv6有状态自动配置 - 两步交互</h2><p>DHCPv6客户端可以在发送的Solicit消息中携带Rapid Commit选项，标识客户端希望服务器能够快速为其分配地址/前缀和网络配置参数。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/11.png"></p>
<blockquote>
<p>•两步交换可以提高DHCPv6分配过程的效率，但适用在网络中只存在一台DHCPv6服务器的情况下。在有多个DHCPv6服务器的网络中，多个DHCPv6服务器都可以为DHCPv6客户端分配IPv6地址/前缀和其他配置参数，但是客户端实际只能使用其中一个服务器为其分配的IPv6地址/前缀和配置参数。</p>
</blockquote>
<h2 id="地址-前缀租约更新-1"><a href="#地址-前缀租约更新-1" class="headerlink" title="地址/前缀租约更新 (1)"></a>地址/前缀租约更新 (1)</h2><p>DHCPv6服务器分配的IPv6地址/前缀具有有效时间。地址/前缀的租借时间超过有效时间后，DHCPv6客户端不能再使用该地址/前缀。因此，在有效时间超时之前，如果DHCPv6客户端希望继续使用该地址/前缀，则需要更新地址/前缀的租约。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/12.png"></p>
<h2 id="地址-前缀租约更新-2"><a href="#地址-前缀租约更新-2" class="headerlink" title="地址/前缀租约更新 (2)"></a>地址/前缀租约更新 (2)</h2><p>如果DHCPv6服务器未响应T1时刻DHCPv6客户端发出的Renew请求，则客户端会在T2（默认为Preferred Lifetime的0.8倍）向所有DHCPv6服务器组播发送Rebind请求更新租约。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/13.png"></p>
<h2 id="DHCPv6无状态自动配置"><a href="#DHCPv6无状态自动配置" class="headerlink" title="DHCPv6无状态自动配置"></a>DHCPv6无状态自动配置</h2><p>DHCPv6服务器为已经具有IPv6地址/前缀的客户端分配除地址/前缀以外的其他网络配置参数，该过程称为DHCPv6无状态自动配置。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•在主机生成链路本地地址并检测无地址冲突后，会首先发起路由器发现过程，即主机发送RS报文，路由器回应RA报文。如果RA报文中M-bit为0，O-bit为1，则表示主机将通过DHCPv6无状态自动配置来获取除地址/前缀外的其他配置参数，如DNS、SIP、SNTP等服务器配置信息等。</p>
</blockquote>
<h2 id="DHCPv6-PD自动配置"><a href="#DHCPv6-PD自动配置" class="headerlink" title="DHCPv6 PD自动配置"></a>DHCPv6 PD自动配置</h2><p>在一个层次化的网络结构中，不同层次的IPv6地址配置一般是手工指定的。手工配置IPv6地址扩展性不佳，不利于IPv6地址的统一规划管理。DHCPv6 PD可以解决这个问题。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•DHCPv6 PD一般用于网络中存在路由器（如本例中的DHCPv6客户端）需要继续为下连的IPv6主机分配前缀的场景，实现主机的地址自动配置，从而完成整个IPv6网络的层次化布局。</p>
<p>•第1步中，DHCPv6客户端请求DHCPv6服务器为其分配IA_NA地址和IA_PD前缀，IA_NA可以理解为服务器为客户端WAN口分配的地址，IA_PD可以理解为服务器为客户端的LAN侧分配的前缀。</p>
</blockquote>
<h2 id="DHCPv6中继工作过程"><a href="#DHCPv6中继工作过程" class="headerlink" title="DHCPv6中继工作过程"></a>DHCPv6中继工作过程</h2><p>当服务器和客户端不在一个网段时，需要使用到DHCPv6中继来完成IPv6地址/前缀和其他网络配置参数的获取。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/16.png"></p>
<h2 id="DHCPv6地址确认过程"><a href="#DHCPv6地址确认过程" class="headerlink" title="DHCPv6地址确认过程"></a>DHCPv6地址确认过程</h2><p>当客户端有断电、掉线、漫游等情况发生时，客户端会发送Confirm报文确认自己的IPv6地址是否可用。如果客户端确认的地址是合法的，则服务器回应；如果没有回应，则客户端需要重新启动地址申请流程。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/17.png"></p>
<h2 id="DHCPv6地址冲突检测过程"><a href="#DHCPv6地址冲突检测过程" class="headerlink" title="DHCPv6地址冲突检测过程"></a>DHCPv6地址冲突检测过程</h2><p>客户端完成地址申请后，会在开始使用该地址前发起DAD探测。如果DAD检测到地址存在冲突，则客户端发送Decline消息通知服务器，并不再使用该地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/18.png"></p>
<h2 id="DHCPv6地址释放过程"><a href="#DHCPv6地址释放过程" class="headerlink" title="DHCPv6地址释放过程"></a>DHCPv6地址释放过程</h2><p>当客户端不需要再使用某地址时，将发送Release消息至服务器，发起释放地址的交互流程。</p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/19.png"></p>
<h2 id="DHCPv6报文总结"><a href="#DHCPv6报文总结" class="headerlink" title="DHCPv6报文总结"></a>DHCPv6报文总结</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/20.png"></p>
<h2 id="地址自动配置比较"><a href="#地址自动配置比较" class="headerlink" title="地址自动配置比较"></a>地址自动配置比较</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/21.png"></p>
<h1 id="3-IPv6地址自动配置实现"><a href="#3-IPv6地址自动配置实现" class="headerlink" title="3.IPv6地址自动配置实现"></a>3.IPv6地址自动配置实现</h1><h2 id="IPv6基本配置"><a href="#IPv6基本配置" class="headerlink" title="IPv6基本配置"></a>IPv6基本配置</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/22.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/23.png"></p>
<h2 id="IPv6地址配置举例-–-静态配置"><a href="#IPv6地址配置举例-–-静态配置" class="headerlink" title="IPv6地址配置举例 – 静态配置"></a>IPv6地址配置举例 – 静态配置</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/24.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/25.png"></p>
<h2 id="IPv6地址配置举例-–-无状态自动配置"><a href="#IPv6地址配置举例-–-无状态自动配置" class="headerlink" title="IPv6地址配置举例 – 无状态自动配置"></a>IPv6地址配置举例 – 无状态自动配置</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/26.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/27.png"></p>
<h2 id="IPv6地址配置举例-–-DHCPv6"><a href="#IPv6地址配置举例-–-DHCPv6" class="headerlink" title="IPv6地址配置举例 – DHCPv6"></a>IPv6地址配置举例 – DHCPv6</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/28.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/29.png"></p>
<h2 id="IPv6地址自动配置实现-–-结果验证"><a href="#IPv6地址自动配置实现-–-结果验证" class="headerlink" title="IPv6地址自动配置实现 – 结果验证"></a>IPv6地址自动配置实现 – 结果验证</h2><p><img src="/2021/05/17/IP-IPv6%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE/30.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）基于NDP的无状态地址自动配置，以下说法正确的是（    ）。</p>
<p>A.基于NDP的无状态地址自动配置可以为主机分配128位的IPv6地址</p>
<p>B.基于NDP的无状态地址自动配置可以为主机分配IPv6前缀或IPv6地址</p>
<p>C.基于NDP的无状态地址自动配置只能为主机分配IPv6前缀</p>
<p><strong>D.基于NDP的无状态地址自动配置可以为主机分配DNS</strong></p>
<p>2.（多选题）在DHCPv6的工作过程中，以下哪些过程用到了Reply报文（    ）。</p>
<p><strong>A.DHCPv6信息获取过程</strong></p>
<p><strong>B.DHCPv6前缀分配两步交互过程</strong></p>
<p><strong>C.DHCPv6地址分配四步交互过程</strong></p>
<p><strong>D.DHCPv6地址释放过程</strong></p>
<p><strong>E.DHCPv6地址续约过程</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•IPv6地址配置可以分为静态配置和动态配置。网络设备互联IPv6地址、环回接口IPv6地址等往往采用静态配置的方式，而终端通常采用动态自动配置方式。</p>
<p>•本课程重点介绍了IPv6地址动态自动配置的两种方式：基于NDP的无状态地址自动配置和基于DHCPv6的有状态地址自动配置。无状态地址自动配置只支持分配64bit的前缀，扩展性较差，对地址的管控较弱。有状态地址自动配置可以实现更加丰富的功能，如PD前缀分配等。</p>
<p>•客户端采用何种IPv6地址自动配置方式是由路由器RA报文中的M-bit和O-bit的配置决定的，实际网络中，需要结合实际场景决定合理的地址配置方式。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-ICMPv6%E5%92%8CNDP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/" itemprop="url">IP-ICMPv6和NDP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T13:28:03+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•在IPv4中，ICMP允许主机或设备报告差错情况。ICMP报文作为IP报文的数据部分，再封装上IP报文首部，组成完整的IP报文发送出去。常用的Ping、Tracert等命令都是基于ICMP实现的。</p>
<p>•IPv6定义了ICMPv6（Internet Control Message Protocol for IPv6），除了提供类似ICMP的功能外，还有诸多扩展。邻居发现协议（Neighbor Discovery Protocol，以下简称NDP）便是基于ICMPv6实现的，作为IPv6的关键协议，NDP提供了如前缀发现、重复地址检测、地址解析、重定向等功能。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述ICMPv6的功能</p>
<p>▫描述ICMPv6的报文格式</p>
<p>▫描述ICMPv6的报文类型</p>
<p>▫描述NDP的功能</p>
<h1 id="1-ICMPv6介绍"><a href="#1-ICMPv6介绍" class="headerlink" title="1.ICMPv6介绍"></a>1.ICMPv6介绍</h1><h2 id="ICMPv6概述"><a href="#ICMPv6概述" class="headerlink" title="ICMPv6概述"></a>ICMPv6概述</h2><h3 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h3><p>Internet控制消息协议ICMP (Internet Control Message Protocol)是IP协议的辅助协议。</p>
<p>ICMP协议用来在网络设备间传递各种差错和控制信息，对于收集各种网络信息、诊断和排除各种网络故障等方面起着至关重要的作用。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/1.png"></p>
<blockquote>
<p>•为了更有效地转发IP数据报文和提高数据报文交互成功的机会，在网络层使用ICMP协议。ICMP允许主机或设备报告差错情况和提供有关异常情况的报告。</p>
<p>•ICMP消息：</p>
<ul>
<li><p>ICMP消息封装在IP报文中，IP报文头部Protocol值为1时表示ICMP协议。</p>
</li>
<li><p>字段解释：</p>
<ul>
<li>ICMP消息的格式取决于Type和Code字段，其中Type字段为消息类型，Code字段包含该消息类型的具体参数。</li>
<li>校验和字段用于检查消息是否完整。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="ICMP差错检测"><a href="#ICMP差错检测" class="headerlink" title="ICMP差错检测"></a>ICMP差错检测</h3><p>ICMP Echo消息常用于诊断源和目的地之间的网络连通性，同时还可以提供其他信息，如报文往返时间等。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/2.png"></p>
<blockquote>
<p>•ICMP的一个典型应用是Ping。Ping是检测网络连通性的常用工具，同时也能够收集其他相关信息。用户可以在Ping命令中指定不同参数，如ICMP报文长度、发送的ICMP报文个数、等待回复响应的超时时间等，设备根据配置的参数来构造并发送ICMP报文，进行Ping测试。</p>
</blockquote>
<h3 id="ICMP错误报告"><a href="#ICMP错误报告" class="headerlink" title="ICMP错误报告"></a>ICMP错误报告</h3><p>ICMP定义了各种错误消息，用于诊断网络连接性问题；根据这些错误消息，源设备可以判断出数据传输失败的原因。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/3.png"></p>
<h3 id="ICMPv6概述-1"><a href="#ICMPv6概述-1" class="headerlink" title="ICMPv6概述"></a>ICMPv6概述</h3><p>•ICMPv6是IPv6的基础协议之一。</p>
<p>•在IPv6报文头部中，Next Header字段值为58则对应为ICMPv6报文。</p>
<p>•ICMPv6报文用于通告相关信息或错误。</p>
<p>•ICMPv6报文被广泛应用于其它协议中，包括NDP、Path MTU发现机制等。</p>
<p>•ICMPv6控制着IPv6中的地址自动配置、地址解析、地址冲突检测、路由选择、以及差错控制等关键环节。</p>
<h2 id="ICMPv6报文格式"><a href="#ICMPv6报文格式" class="headerlink" title="ICMPv6报文格式"></a>ICMPv6报文格式</h2><h3 id="ICMPv6报文格式-1"><a href="#ICMPv6报文格式-1" class="headerlink" title="ICMPv6报文格式"></a>ICMPv6报文格式</h3><p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/4.png"></p>
<blockquote>
<p>•ICMPv6报文载荷由ICMPv6报文类型决定，因报文类型的不同而不同。</p>
<p>•<strong>Type：</strong>表明消息的类型。</p>
<p>•<strong>Code：</strong>表示消息类型的细分。</p>
<p>•<strong>Checksum：</strong>表示ICMPv6报文的校验和。</p>
</blockquote>
<h2 id="ICMPv6报文类型及作用"><a href="#ICMPv6报文类型及作用" class="headerlink" title="ICMPv6报文类型及作用"></a>ICMPv6报文类型及作用</h2><h3 id="ICMPv6报文类型"><a href="#ICMPv6报文类型" class="headerlink" title="ICMPv6报文类型"></a>ICMPv6报文类型</h3><p>ICMPv6报文分为两类：差错报文和信息报文。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/5.png"></p>
<h3 id="ICMPv6差错报文应用-Path-MTU发现"><a href="#ICMPv6差错报文应用-Path-MTU发现" class="headerlink" title="ICMPv6差错报文应用 - Path MTU发现"></a>ICMPv6差错报文应用 - Path MTU发现</h3><p>•在IPv6中，中间转发设备不对IPv6报文进行分片，报文的分片将在源节点进行。</p>
<p>•PMTU（Path MTU）就是路径上的最小接口MTU。</p>
<p>•PMTUD（Path MTU发现机制）的主要目的是发现路径上的MTU，当数据包被从源转发到目的地的过程中避免分段。</p>
<p>•依赖PMTUD，数据的发送方可以使用所发现到的最优PMTU与目的地节点进行通信，这样可以避免数据包在从源传输到目的的过程之中，被中途的路由器分片而导致性能的下降。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/6.png"></p>
<blockquote>
<p>1.首先PC1用1500字节作为MTU向PC2发送IPv6数据包。</p>
<p>2.R1意识到数据包过大，出站接口MTU为1400字节，于是回复一个ICMPv6（Type=2）报文给PC1，指定MTU值为1400字节。</p>
<p>3.然后，PC1开始使用1400作为MTU发送IPv6数据。</p>
<p>4.数据包到达R2后，R2意识到出站接口MTU为1300字节，于是发送一个ICMPv6（Type=2）报文给PC1，指定MTU值为1300字节。</p>
<p>5.PC1开始使用1300作为MTU发送IPv6数据。</p>
</blockquote>
<h3 id="ICMPv6信息报文应用-Ping"><a href="#ICMPv6信息报文应用-Ping" class="headerlink" title="ICMPv6信息报文应用 - Ping"></a>ICMPv6信息报文应用 - Ping</h3><p>Ping基于ICMPv6信息报文实现</p>
<ul>
<li><p>Echo Request：用于发送到目标节点，以使目标节点立即发回一个Echo Reply应答报文。Echo Request报文的Type字段值为128，Code字段的值为0。</p>
</li>
<li><p>Echo Reply：当收到一个Echo Request报文时，ICMPv6会用Echo Reply报文响应。Echo Reply报文的Type字段的值为129，Code字段的值为0。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/7.png"></p>
<h3 id="ICMPv6其它常用的报文"><a href="#ICMPv6其它常用的报文" class="headerlink" title="ICMPv6其它常用的报文"></a>ICMPv6其它常用的报文</h3><p>•邻居发现（RFC2461和RFC4861）</p>
<p>​    ▫Type=133  路由器请求（Router Solicitation）</p>
<p>​    ▫Type=134  路由器公告（Router Advertisement）</p>
<p>​    ▫Type=135  邻居请求（Neighbor Solicitation）</p>
<p>​    ▫Type=136  邻居公告（Neighbor Advertisement）</p>
<p>​    ▫Type=137  重定向 （Redirect）</p>
<p>•组播侦听者发现协议（RFC2710和RFC3810）</p>
<p>​    ▫Type=130  查询消息</p>
<p>​    ▫Type=131  报告消息</p>
<p>​    ▫Type=132  离开消息</p>
<p>​    ▫Type=143  MLDv2报告消息</p>
<h1 id="2-NDP介绍"><a href="#2-NDP介绍" class="headerlink" title="2.NDP介绍"></a>2.NDP介绍</h1><h2 id="NDP概述"><a href="#NDP概述" class="headerlink" title="NDP概述"></a>NDP概述</h2><h3 id="NDP概述-1"><a href="#NDP概述-1" class="headerlink" title="NDP概述"></a>NDP概述</h3><p>RFC2461定义了IPv6邻居发现协议NDP。NDP是IPv6中非常核心的组件。其主要功能如下：</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/8.png"></p>
<h3 id="NDP报文类型及功能"><a href="#NDP报文类型及功能" class="headerlink" title="NDP报文类型及功能"></a>NDP报文类型及功能</h3><p>NDP使用以下几种ICMPv6报文：</p>
<p>▫RS（Router Solicitation）：路由器请求报文</p>
<p>▫RA（Router Advertisement）：路由器通告报文</p>
<p>▫NS（Neighbor Solicitation）：邻居请求报文</p>
<p>▫NA（Neighbor Advertisement）：邻居通告报文</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/9.png"></p>
<h2 id="路由器发现"><a href="#路由器发现" class="headerlink" title="路由器发现"></a>路由器发现</h2><h3 id="路由器发现-1"><a href="#路由器发现-1" class="headerlink" title="路由器发现"></a>路由器发现</h3><p>•路由器发现是指主机发现本地链路上路由器和确定其配置信息的过程。</p>
<p>•路由器发现可以同时实现以下三个功能：</p>
<ul>
<li><p>路由器发现 （Router Discovery）：主机定位邻居路由器以及选择哪一个路由器作为缺省网关的过程。</p>
</li>
<li><p>前缀发现 （Prefix Discovery）：主机发现本地链路上的一组IPv6前缀的过程，用于主机的地址自动配置。</p>
</li>
<li><p>参数发现 （Parameter Discovery）：主机发现相关操作参数的过程，如输出报文的缺省跳数限制、地址配置方式等信息。</p>
</li>
</ul>
<p>•使用报文：</p>
<ul>
<li><p>RS 路由器请求 </p>
</li>
<li><p>RA 路由器通告</p>
</li>
</ul>
<p>•协议交互主要有两种情况：</p>
<ul>
<li><p>主机发送RS触发路由器回应RA</p>
</li>
<li><p>路由器周期发送RA</p>
</li>
</ul>
<h3 id="路由器发现流程-主机请求触发"><a href="#路由器发现流程-主机请求触发" class="headerlink" title="路由器发现流程 - 主机请求触发"></a>路由器发现流程 - 主机请求触发</h3><p>当主机启动时，主机会向本地链路范围内所有的路由器发送RS报文，触发路由器响应RA报文。主机发现本地链路上的路由器后，自动配置缺省路由器，建立缺省路由表、前缀列表和设置其它的配置参数。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/10.png"></p>
<h3 id="路由器发现流程-路由器周期性发送"><a href="#路由器发现流程-路由器周期性发送" class="headerlink" title="路由器发现流程 - 路由器周期性发送"></a>路由器发现流程 - 路由器周期性发送</h3><p>•路由器周期性的发送RA报文，RA发送间隔是一个有范围的随机值，缺省的最大时间间隔是600秒，最小时间间隔是200秒。</p>
<p>•对于定期发送的RA报文，其地址有如下要求：</p>
<p>▫Source Address：必须是发送接口的链路本地地址。</p>
<p>▫Destination Address ：FF02::1。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/11.png"></p>
<blockquote>
<p>•ipv6 nd ra { max-interval maximum-interval | min-interval minimum-interval }命令用来配置发送周期。</p>
</blockquote>
<h2 id="地址解析"><a href="#地址解析" class="headerlink" title="地址解析"></a>地址解析</h2><h3 id="地址解析-1"><a href="#地址解析-1" class="headerlink" title="地址解析"></a>地址解析</h3><p>•IPv6地址解析通过ICMPv6（NS和NA报文）来实现。</p>
<p>•在三层完成地址解析，主要带来以下几个好处：</p>
<ul>
<li>地址解析在三层完成，不同的二层介质可以采用相同的地址解析协议。</li>
<li>可以使用三层的安全机制避免地址解析攻击。</li>
<li>使用组播方式发送请求报文，减少了二层网络的性能压力。</li>
</ul>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/12.png"></p>
<blockquote>
<p>•本例中，当PC1要传送数据包到PC2时，如果不知道PC2的链路层地址，则需要完成以下协议交互过程：</p>
<ul>
<li><p>PC1发送一个NS报文到网络上，目的地址为PC2对应的被请求节点组播地址（FF02::1:FF84:EFDC），选项字段中带上PC1的链路层地址000D-88F8-03B0。</p>
</li>
<li><p>PC2侦听到该NS报文后，由于报文的目的地址FF02::1:FF84:EFDC，自己在该组播组，处理该报文；同时，根据NS报文的源地址和源链路层地址选项更新自己的邻居缓存表项。</p>
</li>
<li><p>PC2发送一个NA报文应答NS，同时在消息的目标链路层地址选项中带上自己的链路层地址0013-7284-EFDC。</p>
</li>
<li><p>PC1接收到NA报文后，获悉了PC2的链路层地址，创建一个目标节点的邻居缓存表项。</p>
</li>
</ul>
<p>•这样通过交互后，PC1和PC2就知道了对方的链路层地址，建立其对方的邻居缓存表项（类似于IPv4的ARP表），就可以相互通信了。</p>
</blockquote>
<h2 id="邻居状态跟踪"><a href="#邻居状态跟踪" class="headerlink" title="邻居状态跟踪"></a>邻居状态跟踪</h2><h3 id="IPv6邻居状态表"><a href="#IPv6邻居状态表" class="headerlink" title="IPv6邻居状态表"></a>IPv6邻居状态表</h3><p>IPv6邻居状态表中缓存了IPv6地址与MAC地址的映射，可以通过display ipv6 neighbors命令来查看IPv6邻居状态表。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/13.png"></p>
<h3 id="IPv6邻居状态"><a href="#IPv6邻居状态" class="headerlink" title="IPv6邻居状态"></a>IPv6邻居状态</h3><p>IPv6节点需要维护一张邻居表，每个邻居都有相应的状态，状态之间可以迁移。5种邻居状态分别是：未完成（Incomplete）、可达（Reachable）、陈旧（Stale）、延迟（Delay）、探查（Probe）。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/14.png"></p>
<h3 id="邻居状态迁移"><a href="#邻居状态迁移" class="headerlink" title="邻居状态迁移"></a>邻居状态迁移</h3><p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/15.png"></p>
<blockquote>
<p>•R1先发送NS报文，并生成缓存条目，此时，邻居状态为Incomplete。</p>
<p>•若收到R2回复的NA报文，则邻居状态由Incomplete变为Reachable，否则固定时间后邻居状态由Incomplete变为Empty。</p>
<p>•经过邻居可达时间（默认30s），邻居状态由Reachable变为Stale，即未知是否可达。</p>
<ul>
<li>如果在Reachable状态，R1收到R2的非请求NA报文，且其中携带的R2的链路层地址和表项中不同，则邻居状态马上变为Stale。</li>
</ul>
<p>•在Stale状态若R1要向R2发送数据，则邻居状态由Stale变为Delay，并发送NS请求。</p>
<p>•在经过一段固定时间后，邻居状态由Delay变为Probe，其间若有NA应答，则邻居状态由Delay变为Reachable。</p>
<p>•在Probe状态，R1每隔一定时间间隔（默认1s）发送单播NS，发送固定次数后，有应答则邻居状态变为Reachable，否则邻居状态变为Empty。</p>
</blockquote>
<h2 id="重复地址检测"><a href="#重复地址检测" class="headerlink" title="重复地址检测"></a>重复地址检测</h2><h3 id="重复地址检测-1"><a href="#重复地址检测-1" class="headerlink" title="重复地址检测 (1)"></a>重复地址检测 (1)</h3><p>•重复地址检测(Duplicate Address Detect，DAD)是指接口在使用某个IPv6地址之前，需要先探测是否有其它的节点使用了该地址，从而确保网络中没有两个相同的单播地址。</p>
<p>•接口在启用任何一个单播IPv6地址前都需要先进行DAD，包括Link-Local地址。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/16.png"></p>
<blockquote>
<p>•重复地址检测是节点确定即将使用的地址是否被另一节点使用的过程。在节点自动配置某个接口的IPv6单播地址之前，必须在本地链路范围内验证要使用的地址是唯一的，并且未被其他节点使用过。只要NS报文发送到本地链路上（缺省发送一次NS报文），如果在规定时间内没有NA报文进行应答，则认为这个临时单播地址在本地链路上是唯一的，可以分配给接口；反之，这个临时地址是重复的，不能配置到接口。</p>
</blockquote>
<h3 id="重复地址检测-2"><a href="#重复地址检测-2" class="headerlink" title="重复地址检测 (2)"></a>重复地址检测 (2)</h3><p>•一个地址在通过重复地址检测之前称为“tentative地址”，即“试验地址”。此时该接口不能使用这个试验地址进行单播通讯。</p>
<p>•若2个节点配置相同地址，同时作重复地址检测时，当一方收到对方发出的DAD NS报文，则接收方将不启用该地址。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/17.png"></p>
<blockquote>
<p>•特殊情况：有两台主机同时分配到同一个IP地址。假设PC1和PC2都想使用2000::1这个地址，那么进一步假设PC1先发送NS，PC2收到以后将不会发送NS了（当然也不会发送NA），直接停止使用2000::1这个地址，等待其他方式生成新的地址。如果同时收到NS报文，则都会放弃使用2000::1地址。</p>
</blockquote>
<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><h3 id="重定向-1"><a href="#重定向-1" class="headerlink" title="重定向"></a>重定向</h3><p>重定向是指网关设备发现报文从其它网关设备转发更优，它就会发送重定向报文告知报文的发送者，让报文发送者选择另一个网关设备。</p>
<p><img src="/2021/05/17/IP-ICMPv6%E5%92%8CNDP/18.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）ICMPv6报文类型分为哪几大类？</p>
<p><strong>A.差错报文</strong></p>
<p><strong>B.信息报文</strong></p>
<p>C.其他报文</p>
<p>D.参数报文</p>
<p>2.（多选题） IPv6地址解析通过以下哪种报文实现？</p>
<p>A.RS</p>
<p>B.RA</p>
<p><strong>C.NS</strong></p>
<p><strong>D.NA</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•ICMPv6是IPv6的基础协议之一，具有差错报文和信息报文两种，用于IPv6节点报告报文处理过程中的错误和信息。其中，差错报文用于报告在转发IPv6数据包过程中出现的错误，如常见的目的不可达、超时等等；信息报文则可以实现路由器发现，重复地址检测，组播成员管理等等。</p>
<p>•NDP是5个ICMPv6信息报文的“打包”，Type133、134为RS、RA报文，可以实现路由器发现，实现主机的网关发现，地址的自动配置；Type135、136为NS、NA报文，可以实现邻居链路层地址解析，重复地址检测；Type137为重定向报文，可以实现重定向。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/" itemprop="url">IP-IPv6概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T12:59:24+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•IPv4协议是目前广泛部署的因特网协议。在因特网发展初期，IPv4以其协议简单、易于实现、互操作性好的优势而得到快速发展。但随着因特网的迅猛发展，IPv4设计的不足也日益明显，IPv6的出现，解决了IPv4的一些弊端。</p>
<p>•IPv6（Internet Protocol Version 6）也被称为IPng（IP Next Generation）。它是Internet工程任务组IETF（Internet Engineering Task Force）设计的一套规范，是IPv4（Internet Protocol Version 4）的升级版本。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述IPv6的发展现状</p>
<p>▫阐明IPv6相较于IPv4的优势</p>
<p>▫描述IPv6的基本概念</p>
<p>▫描述IPv6报文头部的格式</p>
<p>▫描述IPv6地址格式和地址类型</p>
<p>▫实现IPv6地址以及IPv6路由的简单配置</p>
<h1 id="1-IPv6概述"><a href="#1-IPv6概述" class="headerlink" title="1.IPv6概述"></a>1.IPv6概述</h1><h2 id="IPv4现状"><a href="#IPv4现状" class="headerlink" title="IPv4现状"></a>IPv4现状</h2><p>2011年2月3日，IANA（Internet Assigned Numbers Authority，因特网地址分配组织）宣布将其最后的468万个IPv4地址平均分配到全球5个RIR（Regional Internet Registry，区域互联网注册管理机构），此后IANA再没有可分配的IPv4地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/1.png"></p>
<blockquote>
<p>•IANA，是负责全球互联网IP地址编号分配的机构。IANA将部分IPv4地址分配给大洲级的RIR，再由各RIR进行所辖区域内地址分配，五大RIR包括：</p>
<ul>
<li><p>RIPE：Reseaux IP Europeans，欧洲IP地址注册中心，服务于欧洲、中东地区和中亚地区；</p>
</li>
<li><p>LACNIC：Latin American and Caribbean Internet Address Registry，拉丁美洲和加勒比海Internet地址注册中心，服务于中美、南美以及加勒比海地区；</p>
</li>
<li><p>ARIN：American Registry for Internet Numbers，美国Internet编号注册中心，服务于北美地区和部分加勒比海地区；</p>
</li>
<li><p>AFRINIC：Africa Network Information Centre，非洲网络信息中心，服务于非洲地区；</p>
</li>
<li><p>APNIC：Asia Pacific Network Information Centre，亚太互联网络信息中心，服务于亚洲和太平洋地区。</p>
</li>
</ul>
<p>•实践证明IPv4是一个非常成功的协议，它本身也经受住了Internet从少量计算机组网发展到目前上亿台计算机互联的考验。但该协议是几十年前基于当时的网络规模而设计的。在今天看来，IPv4的设计者们对于Internet的估计和预想显得很不充分。随着Internet的扩张和新应用的不断推出，IPv4越来越显示出它的局限性。</p>
<p>•Internet规模的快速扩张是当时完全没有预料到的，特别是近十年来，更是爆炸式增长，已经走进了千家万户，人们的日常生活已经离不开它。但正因为发展太快，IP地址空间耗尽的问题迫在眉睫。</p>
<p>•20世纪90年代，IETF推出NAT（Network Address Translation，网络地址转换）与CIDR（Classless Inter Domain Routing，无类别域间路由）等技术来推迟IPv4地址耗尽发生的时间点。但是这些过渡方案只能减缓地址枯竭的速度，并不能从根本上解决问题。</p>
</blockquote>
<h2 id="全球IPv6发展现状"><a href="#全球IPv6发展现状" class="headerlink" title="全球IPv6发展现状"></a>全球IPv6发展现状</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/2.png"></p>
<blockquote>
<p>•数据来源：《2019 IPv6支持度报告》——下一代互联网国家工程中心</p>
<p>•综合IPv6部署率是根据各个国家地区的网络（IPv6 Prefix/Transit IPv6 AS），IPv6网站及IPv6用户等数据按照一定权值并计算得出的IPv6部署综合情况。</p>
</blockquote>
<h2 id="Why-IPv6"><a href="#Why-IPv6" class="headerlink" title="Why IPv6 ?"></a>Why IPv6 ?</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/3.png"></p>
<h2 id="IPv6优势"><a href="#IPv6优势" class="headerlink" title="IPv6优势"></a>IPv6优势</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/4.png"></p>
<blockquote>
<p>•近乎无限的地址空间：与IPv4相比，这是最明显的好处。IPv6地址是由128 bit构成，单从数量级来说，IPv6所拥有的地址容量是IPv4的约8×1028倍，号称可以为全世界的每一粒沙分配一个网络地址。这使得海量终端同时在线，统一编址管理，变为可能，为万物互连提供了强有力的支撑。</p>
<p>•层次化的地址结构：正因为有了近乎无限的地址空间，IPv6在地址规划时就根据使用场景划分了各种地址段。同时严格要求单播IPv6地址段的连续性，便于IPv6路由聚合，缩小IPv6地址表规模。</p>
<p>•即插即用：任何主机或者终端要获取网络资源，传输数据，都必须有明确的IP地址。传统的分配IP地址方式是手工或者DHCP自动获取，除了上述两个方式外，IPv6还支持SLAAC（Stateless Address Autoconfiguration，无状态地址自动配置）。</p>
<p>•端到端网络的完整性：大面积使用NAT技术的IPv4网络，从根本上破坏了端到端连接的完整性。使用IPv6之后，将不再需要NAT网络设备，上网行为管理、网络监管等将变得简单，与此同时，应用程序也不需要开发复杂的NAT适配代码。</p>
<p>•安全性得到增强：IPsec（ Internet Protocol Security，因特网协议安全协议）最初是为IPv6设计的，所以基于IPv6的各种协议报文（路由协议、邻居发现等），都可以端到端地加密，当然该功能目前应用并不多。而IPv6的数据面报文安全性，跟IPv4+IPsec的能力，基本相同。</p>
<p>•可扩展性强：IPv6的扩展属性报文头部，并不是主数据包的一部分，但是在必要的时候，这些扩展头部会插在IPv6基本头部和有效载荷之间，能够协助IPv6完成加密功能、移动功能、最优路径选路、QoS等，并可提高报文转发效率。</p>
<p>•移动性改善：当一个用户从一个网段移动到另外一个网段，传统的网络会产生经典式“三角式路由”，IPv6网络中，这种移动设备的通信，可不再经过原“三角式路由”，而做直接路由转发，降低了流量转发的成本，提升了网络性能和可靠性。</p>
<p>•QoS可得到进一步增强：IPv6保留了IPv4所有的QoS属性，额外定义了20Byte 的流标签字段，可为应用程序或者终端所用，针对特殊的服务和数据流，分配特定的资源，目前该机制并没有得到充分的开发和应用。</p>
</blockquote>
<h2 id="IPv6过渡技术简介-1"><a href="#IPv6过渡技术简介-1" class="headerlink" title="IPv6过渡技术简介 (1)"></a>IPv6过渡技术简介 (1)</h2><p>•由于NAT技术的应用，缓解了IPv4地址不足产生的问题，但是部署IPv6是解决IPv4地址不足的最终方案。当前世界上不同地区对部署IPv6的需求强烈程度不一，且当前IPv4网络仍然占主流地位，因此短时间内IPv6和IPv4将会共存。</p>
<p>•IPv4网络演变为IPv6网络主要有以下三种技术：</p>
<p>​    ▫双栈技术：在一台设备上同时启用IPv4协议栈和IPv6协议栈的技术。</p>
<p>​    ▫隧道技术：将一种协议的数据封装在另一种协议中的技术。</p>
<p>​    ▫转换技术：将IPv6地址和IPv4地址进行转换的一种技术。</p>
<p>•没有最好的过渡技术方案，没有任何一种技术方案能够解决所有问题，通常是多种技术组合成不同的过渡方案，满足不同的网络访问场景。</p>
<h2 id="IPv6过渡技术简介-2"><a href="#IPv6过渡技术简介-2" class="headerlink" title="IPv6过渡技术简介 (2)"></a>IPv6过渡技术简介 (2)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/5.png"></p>
<h2 id="IPv6路由协议简介"><a href="#IPv6路由协议简介" class="headerlink" title="IPv6路由协议简介"></a>IPv6路由协议简介</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/6.png"></p>
<h1 id="2-IPv6地址介绍"><a href="#2-IPv6地址介绍" class="headerlink" title="2.IPv6地址介绍"></a>2.IPv6地址介绍</h1><h2 id="IPv6地址概述"><a href="#IPv6地址概述" class="headerlink" title="IPv6地址概述"></a>IPv6地址概述</h2><h3 id="IPv6地址"><a href="#IPv6地址" class="headerlink" title="IPv6地址"></a>IPv6地址</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/7.png"></p>
<h3 id="地址空间"><a href="#地址空间" class="headerlink" title="地址空间"></a>地址空间</h3><p>•为什么IPv6协议的地址长度是128bit？</p>
<ul>
<li><p>CPU处理字长发展至今分别经历了4bit、8bit、16bit、32bit、64bit等，当数据能用2的指数幂字长的二进制数表示时，CPU对数值的处理效率最高。</p>
</li>
<li><p>IPv4地址长度为32bit，原因之一就是当时互联网上的主机CPU字长为32bit。从处理效率和未来网络扩展性上考虑，将IPv6的地址长度定为128bit是十分合适的。</p>
</li>
</ul>
<p>•IPv6的128bit地址是一个什么概念？</p>
<ul>
<li><p>IPv4有（232）= 4,294,967,296个地址。</p>
</li>
<li><p>IPv6有（2128 = 296x232 ）= 340,282,366,920,938,463,463,374,607,431,768,211,456个地址(340万亿万亿万亿个地址)，相当于地球表面每平方米可以分配到67万亿个地址。</p>
</li>
<li><p>夸张的说，地球上每一粒沙子都可以分配到一个IPv6地址。</p>
</li>
</ul>
<h3 id="IPv6地址格式"><a href="#IPv6地址格式" class="headerlink" title="IPv6地址格式"></a>IPv6地址格式</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/8.png"></p>
<blockquote>
<p>•IPv4地址使用点隔开的4段十进制数加上掩码来表示，例如192.168.1.1/24。IPv6的地址有128位，沿用IPv4的十进制表示方法就显得太笨拙了，所以在RFC2373中定义了不同于IPv4的格式。</p>
</blockquote>
<h3 id="IPv6地址结构"><a href="#IPv6地址结构" class="headerlink" title="IPv6地址结构"></a>IPv6地址结构</h3><p>•一个IPv6地址可以分为如下两部分：</p>
<p>​    ▫网络前缀：nbit，相当于IPv4地址中的网络ID。</p>
<p>​    ▫接口标识：（128-n）bit，相当于IPv4地址中的主机ID。</p>
<p>•IPv6单播地址示例：2001:0DB8:6101:0001:5ED9:98FF:FECA:A298/64。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/9.png"></p>
<h3 id="IPv6地址前缀"><a href="#IPv6地址前缀" class="headerlink" title="IPv6地址前缀"></a>IPv6地址前缀</h3><p>•鉴于IPv4地址在规划和分配上的局限性，IETF对IPv6地址类型进行了精细划分，不同类型的IPv6地址被赋予了不同的前缀，且受地址分配机构的严格管理。</p>
<p>•现阶段，常用的IPv6地址或前缀有：</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/10.png"></p>
<blockquote>
<p>•IPv6前缀 IANA最新定义</p>
</blockquote>
<h3 id="IPv6地址接口标识"><a href="#IPv6地址接口标识" class="headerlink" title="IPv6地址接口标识"></a>IPv6地址接口标识</h3><p>•接口ID可通过三种方式生成：手工配置、系统自动生成，或基于IEEE EUI-64规范生成。</p>
<p>•其中，基于IEEE EUI-64规范自动生成接口ID的方式最为常用，该方式将接口的MAC地址转换为IPv6接口标识。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/11.png"></p>
<blockquote>
<p>目前有三种方式可以产生IPv6接口ID：</p>
<p>▫IEEE EUI-64规范</p>
<ul>
<li><p>接口ID的典型长度是64位，IEEE EUI-64规范给出了一个由48位MAC地址自动生成64位Interface ID的方法。</p>
</li>
<li><p>具体的转换算法为：将上述的第7bit0转换为1，在MAC地址的中间（24bit处）插入两个字节：FFFE。</p>
</li>
<li><p>这种由MAC地址产生IPv6地址接口ID的方法可以减少配置的工作量，只需要获取一个IPv6前缀就可以与接口ID形成IPv6地址。</p>
</li>
<li><p>使用这种方式最大的缺点就是某些恶意者可以通过二层MAC推算出三层IPv6地址。</p>
</li>
</ul>
<p>▫设备随机生成</p>
<ul>
<li>设备采用随机生成的方法产生一个接口ID，目前Windows操作系统使用该方式。</li>
</ul>
<p>▫手动配置</p>
<ul>
<li>顾名思义，手动配置就是人为指定接口ID来实现。</li>
</ul>
</blockquote>
<h2 id="IPv6地址类型"><a href="#IPv6地址类型" class="headerlink" title="IPv6地址类型"></a>IPv6地址类型</h2><h3 id="IPv6地址类型-1"><a href="#IPv6地址类型-1" class="headerlink" title="IPv6地址类型"></a>IPv6地址类型</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/12.png"></p>
<p>•<strong>单播地址（Unicast Address）</strong>：标识一个接口，目的地址为单播地址的报文会被送到被标识的接口。在IPv6中，一个接口拥有多个IPv6地址是非常常见的现象。</p>
<p>•<strong>组播地址（Multicast Address）：</strong>标识多个接口，目的地址为组播地址的报文会被送到被标识的所有接口。只有加入相应组播组的设备接口才会侦听发往该组播地址的报文。</p>
<p>•<strong>任播地址（AnycastAddress）：</strong>任播地址标识一组网络接口（通常属于不同的节点）。目标地址是任播地址的数据包将发送给其中路由意义上最近的一个网络接口。</p>
<p>•<strong>IPv6没有定义广播地址（Broadcast Address）</strong></p>
<h3 id="IPv6常见单播地址-GUA"><a href="#IPv6常见单播地址-GUA" class="headerlink" title="IPv6常见单播地址 - GUA"></a>IPv6常见单播地址 - GUA</h3><p>GUA（Global Unicast Address，全球单播地址），也被称为可聚合全球单播地址。该类地址全球唯一，用于需要有互联网访问需求的主机，相当于IPv4的公网地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/13.png"></p>
<h3 id="IPv6常见单播地址-ULA"><a href="#IPv6常见单播地址-ULA" class="headerlink" title="IPv6常见单播地址 - ULA"></a>IPv6常见单播地址 - ULA</h3><p>ULA（Unique Local Address，唯一本地地址）是IPv6私网地址，只能够在内网中使用。该地址空间在IPv6公网中不可被路由，因此不能直接访问公网。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/14.png"></p>
<h3 id="IPv6常见单播地址-LLA"><a href="#IPv6常见单播地址-LLA" class="headerlink" title="IPv6常见单播地址 - LLA"></a>IPv6常见单播地址 - LLA</h3><p>LLA（Link-Local Address，链路本地地址）是IPv6中另一种应用范围受限制的地址类型。LLA的有效范围是本地链路，前缀为FE80::/10。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/15.png"></p>
<h3 id="IPv6组播地址"><a href="#IPv6组播地址" class="headerlink" title="IPv6组播地址"></a>IPv6组播地址</h3><p>IPv6组播地址标识某个组，目的为组播地址的报文会被送到该组播组内的成员。组播地址由前缀（FF::/8），标志（Flag）字段、范围（Scope）字段以及组播组ID（Group ID）4个部分组成。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/16.png"></p>
<h3 id="IPv6组播MAC"><a href="#IPv6组播MAC" class="headerlink" title="IPv6组播MAC"></a>IPv6组播MAC</h3><p>•组播IPv6报文的目的IP为组播IPv6地址，同样，目的MAC为组播MAC地址。</p>
<p>•组播MAC的前16bit为“33:33”，是专门为IPv6组播预留的MAC地址前缀。后32bit从组播IPv6地址的后32bit直接映射而来。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/17.png"></p>
<blockquote>
<p>•以太网传输单播IP报文的时候，目的MAC地址是下一跳的MAC地址。但是在传输组播数据包时，其目的地不再是一个具体的接收者，而是一个成员不确定的组，所以要使用组播MAC地址。</p>
<p>•IPv4组播MAC地址</p>
<ul>
<li><p>IANA规定，IPv4组播MAC地址的高24bit为0x01005E，第25bit为0，低23bit为IPv4组播地址的低23bit映射。</p>
</li>
<li><p>由于IPv4组播地址的高4bit是1110，代表组播标识，而低28bit中只有23bit被映射到IPv4组播MAC地址，这样IPv4组播地址中就有5bit信息丢失。于是，就有32个IPv4组播地址映射到了同一个IPv4组播MAC地址上，因此在二层处理过程中，设备可能要接收一些本IPv4组播组以外的组播数据，而这些多余的组播数据就需要上层进行过滤了。</p>
</li>
</ul>
<p>•IPv6组播MAC地址</p>
<ul>
<li>在以太网链路上发送IPv6组播数据包时，对应的MAC地址是0x3333-A-A-A-A，其中A-A-A-A是组播IP地址的后32bit的直接映射。</li>
</ul>
</blockquote>
<h3 id="被请求节点组播地址"><a href="#被请求节点组播地址" class="headerlink" title="被请求节点组播地址"></a>被请求节点组播地址</h3><p>当一个节点具有了单播或任播地址，就会对应生成一个被请求节点组播地址，并且加入这个组播组。该地址主要用于邻居发现机制和地址重复检测功能。被请求节点组播地址的有效范围为本地链路范围。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/18.png"></p>
<blockquote>
<p>•被请求节点组播地址的应用场景举例：在IPv6中，ARP及广播都被取消，当设备需要请求某个IPv6地址对应的MAC地址时，设备依然需要发送请求报文，但是该报文是一个组播报文，其目的IPv6地址是目标IPv6单播地址对应的被请求节点组播地址，由于只有目标节点才会侦听这个被请求节点组播地址，所以该组播报文可以被目标节点所接收，同时不会占用其他非目标节点的网络性能。</p>
</blockquote>
<h3 id="被请求节点组播地址-示例"><a href="#被请求节点组播地址-示例" class="headerlink" title="被请求节点组播地址 - 示例"></a>被请求节点组播地址 - 示例</h3><p>PC1发送数据至PC2前，首先需要获取其MAC地址。PC1将发起类似IPv4中ARP的解析流程，IPv6使用ICMPv6的NS及NA报文来实现地址解析过程，NS报文的目的IPv6地址为目标IPv6单播地址对应的被请求节点组播地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/19.png"></p>
<h3 id="IPv6任播地址"><a href="#IPv6任播地址" class="headerlink" title="IPv6任播地址"></a>IPv6任播地址</h3><p>任播地址标识一组网络接口（通常属于不同的节点）。任播地址可以作为IPv6报文的源地址，也可以作为目的地址。</p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/20.png"></p>
<blockquote>
<p>•任播过程涉及一个任播报文发起方和一个或多个响应方。</p>
<ul>
<li><p>任播报文的发起方通常为请求某一服务（例如，Web服务）的主机。</p>
</li>
<li><p>任播地址与单播地址在格式上无任何差异，唯一的区别是一台设备可以给多台具有相同地址的设备发送报文。</p>
</li>
</ul>
<p>•网络中运用任播地址有很多优势：</p>
<ul>
<li><p>业务冗余。比如，用户可以通过多台使用相同地址的服务器获取同一个服务（例如，Web服务）。这些服务器都是任播报文的响应方。如果不是采用任播地址通信，当其中一台服务器发生故障时，用户需要获取另一台服务器的地址才能重新建立通信。如果采用的是任播地址，当一台服务器发生故障时，任播报文的发起方能够自动与使用相同地址的另一台服务器通信，从而实现业务冗余。</p>
</li>
<li><p>提供更优质的服务。比如，某公司在A省和B省各部署了一台提供相同Web服务的服务器。基于路由优选规则，A省的用户在访问该公司提供的Web服务时，会优先访问部署在A省的服务器，提高访问速度，降低访问时延，大大提升了用户体验。</p>
</li>
</ul>
</blockquote>
<h3 id="IPv6地址和IPv4地址比较"><a href="#IPv6地址和IPv4地址比较" class="headerlink" title="IPv6地址和IPv4地址比较"></a>IPv6地址和IPv4地址比较</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/21.png"></p>
<h2 id="IPv6地址规划举例"><a href="#IPv6地址规划举例" class="headerlink" title="IPv6地址规划举例"></a>IPv6地址规划举例</h2><h3 id="IPv6地址规划举例-1"><a href="#IPv6地址规划举例-1" class="headerlink" title="IPv6地址规划举例"></a>IPv6地址规划举例</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/22.png"></p>
<blockquote>
<p>•地址规划设计建议：</p>
<ul>
<li>根据获取到的地址前缀，首先确定子网地址划分为几个功能块(如图中的3+3+6+N)，明确各功能块的含义、占用多少bit，避免地址浪费。</li>
</ul>
</blockquote>
<h3 id="IPv6地址使用建议"><a href="#IPv6地址使用建议" class="headerlink" title="IPv6地址使用建议"></a>IPv6地址使用建议</h3><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/23.png"></p>
<h1 id="3-IPv6报文结构"><a href="#3-IPv6报文结构" class="headerlink" title="3.IPv6报文结构"></a>3.IPv6报文结构</h1><h2 id="IPv6报文构成"><a href="#IPv6报文构成" class="headerlink" title="IPv6报文构成"></a>IPv6报文构成</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/24.png"></p>
<p>IPv6报文一般由三个部分组成：</p>
<p><strong>基本报头：</strong>提供报文转发的基本信息，路由器通过解析基本报头就能完成绝大多数的报文转发任务。</p>
<p><strong>扩展报头：</strong>提供一些扩展的报文转发信息，如分段、加密等，该部分不是必需的，也不是每个路由器都需要处理，仅当需要路由器或目的节点做某些特殊处理时，才由发送方添加一个或多个扩展头。</p>
<p><strong>上层协议数据单元：</strong>一般由上层协议报头和它的有效载荷构成，该部分与IPv4的上层协议数据单元相似。</p>
<blockquote>
<p>•从图中可以看出IPv6数据报文由以下几个部分组成：</p>
<p>▫<strong>IPv6基本报头（IPv6 Header）</strong></p>
<ul>
<li><p>每一个IPv6数据报文都必须包含报头，其长度固定为40字节。</p>
</li>
<li><p>基本报头提供报文转发的基本信息，会被转发路径上的所有路由器解析。</p>
</li>
</ul>
<p>▫<strong>扩展报头（Extension Headers）</strong></p>
<ul>
<li>IPv6扩展报头是可能跟在基本IPv6报头后面的可选报头。IPv6数据包中可以包含一个或多个扩展报头，当然也可以没有扩展头，这些扩展报头可以具有不同的长度。IPv6报头和扩展报头代替了IPv4报头及其选项。新的扩展报头格式增强了IPv6的功能，使其具有极大的扩展性。与IPv4报头中的选项不同，IPv6扩展报头没有最大长度的限制，因此可以容纳IPv6通信所需要的所有扩展数据。扩展报头提供报文转发的扩展信息，并不会被路径上所有的路由器解析，一般只会被目的路由器解析处理。</li>
</ul>
<p>▫<strong>上层协议数据单元（Upper Layer Protocol Data Unit）</strong></p>
<ul>
<li>上层协议数据单元一般由上层协议报头和它的有效载荷构成，有效载荷可以是一个ICMPv6报文、一个TCP报文或一个UDP报文。 </li>
</ul>
</blockquote>
<h2 id="IPv6基本报头"><a href="#IPv6基本报头" class="headerlink" title="IPv6基本报头"></a>IPv6基本报头</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/25.png"></p>
<blockquote>
<p>•IPv6基本报头也称之为固定报头。固定报头包含8个字段，总长度为40Byte。这8个字段分别为：版本（Version）、流量类型（Traffic Class）、流标签（Flow Label）、净荷长度（Payload Length）、下一个报头（Next Header）、跳数限制（Hop Limit）、源IPv6地址、目的IPv6地址。</p>
<p>•版本（Version）</p>
<p>​    ▫该字段规定了IP协议的版本，其值为6。长度为4bit。</p>
<p>•流类别（Traffic Class）</p>
<p>​    ▫该字段功能和IPv4中的服务类型功能类似，表示IPv6数据报文的类    或优先级。长度为8bit。</p>
<p>•流标签（Flow Label）</p>
<p>​    ▫与IPv4相比，该字段是新增的。它用来标识这个数据报属于源节    点和目标节点之间的一个特定数据报序列，它需要由中间IPv6路由    器进行特殊处理。该字段长度为20bit。一般来说一个流可以通过    源/目的IPv6地址和流标签来确定。</p>
<p>•有效载荷长度（Payload Length）</p>
<p>​    ▫该字段表示IPv6数据报有效载荷的长度。有效载荷是指紧跟IPv6报    头的数据报的其它部分（即扩展报头和上层协议数据单元）。该字    段长度为16bit，能表示最大长度为65535Byte的有效载荷。如果有    效载荷的长度超过这个值，该字段会置0，而有效载荷的长度用逐    跳选项扩展报头中的超大有效载荷选项来表示。</p>
<p>•下一个报头（Next Header）</p>
<p>​    ▫该字段定义紧跟在IPv6报头后面的第一个扩展报头（如果存在）    的类型，或者上层协议数据单元中的协议类型。该字段长度8bit。</p>
<p>•跳数限制（Hop Limit）</p>
<p>​    ▫该字段类似于IPv4中的TTL（Time to Live）字段。它定义了IP数    据报所能经过的最大跳数。每经过一个路由器，该数值减去1，当    该字段的值为0时，数据报将被丢弃。该字段长度为8bit。</p>
<p>•源地址（Source Address）</p>
<p>​    ▫表示发送方的地址，长度为128bit。</p>
<p>•目的地址（Destination Address）</p>
<p>​    ▫表示接收方的地址，长度为128bit。</p>
</blockquote>
<h2 id="IPv6扩展报头-1"><a href="#IPv6扩展报头-1" class="headerlink" title="IPv6扩展报头 (1)"></a>IPv6扩展报头 (1)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/26.png"></p>
<blockquote>
<p>•IPv6报头设计中对原IPv4报头所做的一项重要改进就是将所有可选字段移出IPv6报头，置于扩展头中。IPv6扩展报头是可能跟在基本IPv6报头后面的可选报头。为什么在IPv6中要设计扩展报头呢？因为在IPv4的报头中包含了所有的选项，每个中间路由器都必须检查这些选项是否存在，如果存在，就必须处理它们。这种设计方法会降低路由器转发IPv4数据包的效率。为了解决转发效率问题，在IPv6中，相关选项被移到了扩展报头中。中间路由器就不需要处理每一个可能出现的选项，这种处理方式提高了路由器处理数据包的速度，也提高了其转发性能。　　</p>
<p>•通常，一个典型的IPv6包，没有扩展头。仅当需要路由器或目的节点做某些特殊处理时，才由发送方添加一个或多个扩展头。与IPv4不同，IPv6扩展头长度任意，不受40Byte限制，以便于日后扩充新增选项，这一特征加上选项的处理方式使得IPv6选项能得以真正的利用。但是为了提高处理选项头和传输层协议的性能，扩展头总是8Byte长度的整数倍。</p>
</blockquote>
<h2 id="IPv6扩展报头-2"><a href="#IPv6扩展报头-2" class="headerlink" title="IPv6扩展报头 (2)"></a>IPv6扩展报头 (2)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/27.png"></p>
<blockquote>
<p>•目前，RFC 2460中定义了以下6个IPv6扩展头：</p>
<ul>
<li><p>逐跳选项报头：该扩展头被每一跳处理，可包含多种选项，如路由器告警选项。</p>
</li>
<li><p>目的选项报头：目的地处理， 可包含多种选项，如Mobile IPv6的家乡地址选项。</p>
</li>
<li><p>路由报头：指定源路由，类似IPv4源路由选项，IPv6源节点用来指定信息报到达目的地的路径上所必须经过的中间节点。IPv6基本报头的目的地址不是分组的最终目的地址，而是路由扩展头中所列的第一个地址。</p>
</li>
<li><p>分段报头：IP报文分片信息，只由目的地处理。</p>
</li>
<li><p>认证报头：IPSec用扩展头， 只由目的地处理。</p>
</li>
<li><p>封装安全净载报头：IPSec用扩展头，只由目的地处理。</p>
</li>
</ul>
<p>•逐跳选项扩展头和目的地选项扩展头内部提供选项功能，支持扩展性（如对移动性支持）。选项采用TLV方式。</p>
<p>•如果数据报中没有扩展报头，也就是说数据包只包含基本报头和上层协议单元，基本报头的下一个报头（Next Header）字段值指明上层协议类型。在上例中，基本报头的下一个报头字段值为6，说明上层协议为TCP；如果报文有一个扩展报头，则基本报头的下一个报头（Next Header）字段值为扩展报头类型（在上例中，指明紧跟在基本报头后面的扩展报头为43，也就是路由报头），扩展报头的下一个报头字段指明上层协议类型；以此类推，如果数据报中报括多个扩展报头，则每一个扩展报头的下一个报头指明紧跟着自己的扩展报头的类型，最后一个扩展报头的下一个报头字段指明上层协议。</p>
</blockquote>
<h1 id="4-IPv6基础配置"><a href="#4-IPv6基础配置" class="headerlink" title="4.IPv6基础配置"></a>4.IPv6基础配置</h1><h2 id="配置介绍-1"><a href="#配置介绍-1" class="headerlink" title="配置介绍 (1)"></a>配置介绍 (1)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/28.png"></p>
<h2 id="配置介绍-2"><a href="#配置介绍-2" class="headerlink" title="配置介绍 (2)"></a>配置介绍 (2)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/29.png"></p>
<h2 id="案例：配置一个双栈网络-1"><a href="#案例：配置一个双栈网络-1" class="headerlink" title="案例：配置一个双栈网络 (1)"></a>案例：配置一个双栈网络 (1)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/30.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/31.png"></p>
<h2 id="案例：配置一个双栈网络-2"><a href="#案例：配置一个双栈网络-2" class="headerlink" title="案例：配置一个双栈网络 (2)"></a>案例：配置一个双栈网络 (2)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/32.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/33.png"></p>
<h2 id="案例：配置一个双栈网络-3"><a href="#案例：配置一个双栈网络-3" class="headerlink" title="案例：配置一个双栈网络 (3)"></a>案例：配置一个双栈网络 (3)</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/32.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/34.png"></p>
<h2 id="配置验证"><a href="#配置验证" class="headerlink" title="配置验证"></a>配置验证</h2><p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/36.png"></p>
<p><img src="/2021/05/17/IP-IPv6%E6%A6%82%E8%BF%B0/37.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）简述IPv6相比于IPv4的优点。</p>
<p><strong>“无限”地址空间，层次化的地址结构，即插即用，简化的报文头部，安全特性，移动性，增强的QoS特性。</strong></p>
<p>2.（简答题）简述IPv6报文头相比于IPv4的不同之处。</p>
<p><strong>IPv6与IPv4的不同之处：</strong></p>
<ul>
<li><p><strong>采用了基本报头+扩展报头的报文形式。</strong></p>
</li>
<li><p><strong>取消了IP的校验：第二层和第四层的校验已经足够健壮了，因此IPv6直接取消了IP的三层校验，节省路由器处理资源。</strong></p>
</li>
<li><p><strong>取消中间节点的分片功能：中间路由器不再处理分片，只在产生数据的源节点处理，省却中间路由器为处理分片而耗费的大量CPU资源。</strong></p>
</li>
<li><p><strong>定义定长的IPv6报头：有利于硬件的快速处理，提高路由器转发效率。</strong></p>
</li>
<li><p><strong>安全选项的支持：IPv6提供了对IPSec的完美支持，如此上层协议可以省去许多安全选项。</strong></p>
</li>
<li><p><strong>增加流标签：提高QoS效率。</strong></p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•IPv6作为下一代互联网协议，具备了IPv4无法比拟的诸多优点，可以完美解决现阶段IPv4无法满足的业务发展的问题。</p>
<p>•IPv6不仅仅具有庞大的地址空间，除此以外，IPv6还简化了报文头，提升了路由器报文转发效率；IPv6地址易于划分与规划，便于路由聚合；IPv6可以实现即插即用，增强了QoS等等……</p>
<p>•通过版本升级（OSPFv3）或者协议扩展（IS-IS、BGP4+），使得在IPv4网络中常用的动态路由协议在IPv6网络中仍然可以使用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IP-PIM原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T12:21:24+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•组播网络由组播源，组播组成员与组播路由器组成。</p>
<ul>
<li><p>组播源的主要作用是发送组播数据。</p>
</li>
<li><p>组播组成员的主要作用是接收组播数据，因此需要通过IGMP让组播网络感知组成员位置与加组信息。</p>
</li>
<li><p>组播路由器的主要作用是<strong>将数据从组播源发送到组播组成员</strong>。组播数据转发需要<strong>依赖组播分发树</strong>，因此组播路由器需要通过协议来<strong>构建组播分发树</strong>。</p>
</li>
</ul>
<p>•PIM（Protocol Independent Multicast，协议无关组播）协议的主要作用就是<strong>构建组播分发树</strong>。</p>
<p>•本章主要讲解PIM协议的基本概念，PIM-DM模式的工作原理与PIM-SM模式的工作原理。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述PIM的基本概念</p>
<p>▫描述PIM-DM的基本工作原理</p>
<p>▫实现PIM-DM的基本配置</p>
<p>▫描述PIM-SM的基本工作原理</p>
<p>▫实现PIM-SM的基本配置</p>
<h1 id="1-PIM基础介绍"><a href="#1-PIM基础介绍" class="headerlink" title="1.PIM基础介绍"></a>1.PIM基础介绍</h1><h2 id="组播网络基本架构回顾"><a href="#组播网络基本架构回顾" class="headerlink" title="组播网络基本架构回顾"></a>组播网络基本架构回顾</h2><p>•组播网络大体可以分为三个部分：</p>
<p>▫源端网络：将组播源产生的组播数据发送至组播网络。</p>
<p>▫组播转发网络：<strong>形成无环的组播转发路径</strong>，该转发路径也被称为<strong>组播分发树（Multicast Distribution Tree）</strong>。</p>
<p>▫成员端网络：通过<strong>IGMP</strong>协议，让组播网络<strong>感知组播组成员</strong>位置与加入的组播组。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<blockquote>
<p>•成员端网络通过IGMP协议可以让组播网络感知组播组成员位置与加入的组播组。</p>
<p>•组播转发网络形成组播分发树，需要组播路由协议的支持。</p>
<p>•通过组播路由协议有多种，最常用的是PIM协议，也就是本节课的重点。</p>
</blockquote>
<h2 id="组播数据转发流程回顾"><a href="#组播数据转发流程回顾" class="headerlink" title="组播数据转发流程回顾"></a>组播数据转发流程回顾</h2><p>•组播数据转发基本流程如下：</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•《IGMP原理与配置》课程介绍了组播网络如何感知组播组成员的位置和所加组播组。</p>
<p>•本课程将主要介绍如何形成组播分发树。</p>
</blockquote>
<h2 id="组播协议介绍回顾"><a href="#组播协议介绍回顾" class="headerlink" title="组播协议介绍回顾"></a>组播协议介绍回顾</h2><p>•组播网络需要基于多种组播协议才能建立转发路径：</p>
<p>▫工作在成员端网络的主要是IGMP（Internet Group Management Protocol，因特网组管理协议）协议，用于告知组播网络，组成员的位置与所加组播组。</p>
<p>▫工作在组播转发网络的协议主要是PIM，MSDP，MBGP。</p>
<p>▪<strong>PIM</strong>（Protocol Independent Multicast，协议无关组播）协议主要作用是<strong>生成AS域内的组播分发树</strong>。</p>
<p>▪MSDP（Multicast Source Discovery Protocol，组播源发现协议）主要作用是帮助生成AS域间的组播分发树。</p>
<p>▪MBGP（Multicast BGP，组播BGP）主要作用是帮助跨域组播流进行RPF校验。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<blockquote>
<p>•本课程主要介绍PIM协议的工作原理。</p>
</blockquote>
<h2 id="PIM协议介绍"><a href="#PIM协议介绍" class="headerlink" title="PIM协议介绍"></a>PIM协议介绍</h2><p>•PIM称为协议无关组播。协议无关指的是与单播路由协议无关，即PIM不需要维护专门的单播路由信息。作为组播路由解决方案，它直接利用单播路由表的路由信息，对组播报文执行RPF检查，检查通过后创建组播路由表项，从而转发组播报文。</p>
<p>•目前在实际网络中，PIM主要有两种模式：</p>
<p>▫**PIM-DM（PIM-Dense Mode，PIM密集模式）。</p>
<p>▫<strong>PIM-SM（PIM-Sparse Mode，PIM稀疏模式）</strong> ，PIM-SM模式根据组播服务模型又可以分为：</p>
<p>▪<strong>PIM-SM（ASM）</strong>：为任意源组播建立组播分发树。</p>
<p>▪<strong>PIM-SM（SSM）</strong>：为指定源组播建立组播分发树。</p>
<blockquote>
<p>•PIM（Protocol Independent Multicast）协议无关组播，目前常用版本是PIMv2，PIM报文直接封装在IP报文中，协议号为103，PIMv2组播地址为224.0.0.13。</p>
<p>•在PIM组播域中，以组播组为单位建立从组播源到组成员的点到多点的组播转发路径。由于组播转发路径呈现树型结构，也称为组播分发树（MDT，Multicast Distribution Tree）。</p>
<p>•组播分发树的特点：</p>
<p>▫无论网络中的组成员有多少，每条链路上相同的组播数据最多只有一份。被传递的组播数据在距离组播源尽可能远的分叉路口才开始复制和分发。</p>
</blockquote>
<h2 id="PIM-DM与PIM-SM使用场景"><a href="#PIM-DM与PIM-SM使用场景" class="headerlink" title="PIM-DM与PIM-SM使用场景"></a>PIM-DM与PIM-SM使用场景</h2><p>•PIM形成组播分发树主要有两种模式，即PIM-DM模式与PIM-SM模式，这两种模式分别用在不同的场景下：</p>
<p>▫<strong>PIM-DM模式</strong>主要用在<strong>组成员较少且相对密集的组播网络中</strong>，该模式建立组播分发树的基本思路是“扩散-剪枝”，即将组播流量全网扩散，然后剪枝没有组成员的路径，最终形成组播分发树。</p>
<p>▫<strong>PIM-SM模式</strong>主要用在<strong>组成员较多且相对稀疏的组播网络中</strong>，该模式建立组播分发树的基本思路是先收集组成员信息，然后再形成组播分发树。使用PIM-SM模式不需要全网泛洪组播，对现网的影响较小，因此<strong>现网多使用PIM-SM模式</strong>。</p>
<h2 id="组播分发树的分类"><a href="#组播分发树的分类" class="headerlink" title="组播分发树的分类"></a>组播分发树的分类</h2><p>•通过PIM形成的组播分发树主要分为以下两种：</p>
<p>▫以组播源为根，组播组成员为叶子的组播分发树称为<strong>SPT</strong>（Shortest Path Tree），<strong>在PIM-DM与PIM-SM中均有使用</strong>。</p>
<p>▫以RP（Rendezvous Point）为根，组播组成员为叶子的组播分发树称为<strong>RPT</strong>（RP Tree），<strong>在PIM-SM中使用</strong>。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•SPT又被称为源树，SPT在PIM-DM模式与PIM-SM模式的组播网络中均有使用。</p>
<p>•RPT又被称为共享树，RPT主要在PIM-SM模式的组播网络中被使用。</p>
<p>•RP的作用将在《PIM-SM》章节讲解。</p>
</blockquote>
<h2 id="PIM路由表项"><a href="#PIM路由表项" class="headerlink" title="PIM路由表项"></a>PIM路由表项</h2><p>•PIM路由表项即通过PIM协议建立的组播协议路由表项。</p>
<p>•PIM网络中存在两种路由表项：</p>
<p>▫（S，G）路由表项主要用于在PIM网络中<strong>建立SPT</strong>。对于PIM-DM网络和PIM-SM网络适用。</p>
<p>▫（*，G）路由表项主要用于在PIM网络中<strong>建立RPT</strong>。对于PIM-SM网络适用。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<blockquote>
<p>•S表示组播源，G表示组播组，*表示任意。</p>
<p>•PIM路由器上可能同时存在两种路由表项。当收到源地址为S，组地址为G的组播报文，且RPF检查通过的情况下，按照如下的规则转发：</p>
<ul>
<li><p>如果存在（S，G）路由表项，则由（S，G）路由表项指导报文转发。</p>
</li>
<li><p>如果不存在（S，G）路由表项，只存在（<em>，G）路由表项，则先依照（</em>，G）路由表项创建（S，G）路由表项，再由（S，G）路由表项指导报文转发。</p>
</li>
</ul>
<p>▫Flag值：PIM路由表象的标志。</p>
<p>D：以PIM-DM模式转发；<br> S：以PIM-SM模式转发；<br> P：该条目已经被Prune；<br> C：DST直连，指该RT为收到IGMP report的路由器；<br>  J：（仅用于PIM-SM）RPT-〉SPT，指通过本RT的multicast已从RPT转为SPT进行转发。当该条目用于（*，G）里面，代表SPT-Threshold已经超过预定值（Cisco默认1min0字节），下一个包将引发建立SPT；当条目用于（S，G）里面，表示SPT-Threshold已经低于预定值，将删除SPT重新使用RPT；<br> T：SPT，使用SPT进行转发；<br> L：RT本身就是组播成员；<br> F： Register flag 。</p>
</blockquote>
<h2 id="PIM路由表项与组播路由表项"><a href="#PIM路由表项与组播路由表项" class="headerlink" title="PIM路由表项与组播路由表项"></a>PIM路由表项与组播路由表项</h2><p>•在不同的组播路由器上，组播路由表项会基于不同的表项汇总形成。</p>
<p>▫最后一跳路由器的组播路由表项主要基于PIM路由表项，IGMP组表项和IGMP路由表项汇总形成。</p>
<p>▫其余组播路由器的组播路由表项主要<strong>基于PIM路由表项形成</strong>。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<h1 id="2-PIM-DM介绍"><a href="#2-PIM-DM介绍" class="headerlink" title="2.PIM-DM介绍"></a>2.PIM-DM介绍</h1><h2 id="PIM-DM工作原理"><a href="#PIM-DM工作原理" class="headerlink" title="PIM-DM工作原理"></a>PIM-DM工作原理</h2><h3 id="PIM-DM基本概念"><a href="#PIM-DM基本概念" class="headerlink" title="PIM-DM基本概念"></a>PIM-DM基本概念</h3><p>•PIM-DM主要用在组成员较少且相对密集的网络中，通过“<strong>扩散-剪枝</strong>”的方式形成组播转发树（SPT）。</p>
<p>•PIM-DM在形成SPT的过程中，除了扩散（Flooding），剪枝（Prune）机制外，还会涉及邻居发现（Neighbor Discovery），嫁接（Graft），断言（Assert）和状态刷新（State Refresh）机制。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<h3 id="PIM-DM协议报文"><a href="#PIM-DM协议报文" class="headerlink" title="PIM-DM协议报文"></a>PIM-DM协议报文</h3><p>•PIM协议报文直接采用IP封装，<strong>目的地址224.0.0.13，IP协议号103</strong>。</p>
<p>•PIM-DM与PIM-SM使用的协议报文类型有所不同。</p>
<p>•PIM-DM使用报文主要是以下几类：</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h3 id="邻居发现"><a href="#邻居发现" class="headerlink" title="邻居发现"></a>邻居发现</h3><p>•<strong>组播转发路径只能在PIM邻居之间建立</strong>，因此邻居发现是形成组播分发树的先决条件。</p>
<p>•邻居发现主要通过PIM Hello包完成。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<blockquote>
<p>•Hello报文中携带多项PIM协议报文参数，主要用于PIM邻居之间PIM协议报文的控制。具体如下：</p>
<p>▫DR_Priority：表示各路由器接口竞选DR的优先级，优先级越高越容易获胜。</p>
<p>▫Holdtime：表示保持邻居为可达状态的超时时间。如果在超时时间内没有收到PIM邻居发送的Hello报文，路由器则认为邻居不可达。</p>
<p>▫LAN_Delay：表示共享网段内传输Prune报文的延迟时间。</p>
<p>▫Neighbor-Tracking：表示邻居跟踪功能。</p>
<p>▫Override-Interval：表示Hello报文中携带的否决剪枝的时间间隔。</p>
</blockquote>
<h3 id="首次形成组播分发树"><a href="#首次形成组播分发树" class="headerlink" title="首次形成组播分发树"></a>首次形成组播分发树</h3><p>•PIM-DM模式首次形成组播分发树主要依赖扩散机制、剪枝机制、断言机制与DR选举机制。</p>
<ul>
<li><p>扩散机制：组播数据包向所有的PIM邻居泛洪，同时组播路由器产生组播路由表项。</p>
</li>
<li><p>断言机制：当组播转发过程中存在多路访问网络，则需要选举出一个组播转发路由器，避免重复组播报文。</p>
</li>
<li><p>剪枝机制：如果组播路由器下没有组成员，则将源到该组播路由器的组播转发路径剪枝。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<h3 id="扩散机制"><a href="#扩散机制" class="headerlink" title="扩散机制"></a>扩散机制</h3><p>•组播源发送的组播报文会在全网内扩散。当PIM路由器接收到组播报文，先进行<strong>RPF检查</strong>，通过后会在该路由器上<strong>创建（S，G）表项</strong>，之后会向所有PIM邻居发送。</p>
<p>•PIM-DM形成的（S，G）表项有老化时间（默认210s），如果老化时间超时前没有收到新的组播报文，则删除（S，G）表项。</p>
<p>•扩散具体过程如下：</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<blockquote>
<p>•扩散机制会周期性（默认180s）全网扩散组播数据，周期性扩散的主要目的是探测是否有新成员加组，但是由于全网扩散组播数据会浪费大量带宽，所以现在的组播网络一般使用“状态刷新机制”加上“嫁接机制”来实现周期性全网扩散感知新成员加组的目的。</p>
</blockquote>
<h3 id="断言机制"><a href="#断言机制" class="headerlink" title="断言机制"></a>断言机制</h3><p>•当一个网段内有多个相连的PIM路由器向该网段转发组播报文时，需要通过断言机制（Assert）来保证<strong>只有一个PIM路由器向该网段转发组播报文</strong>。</p>
<p>•通过断言机制的选举规则将决定组播路由器的转发行为：</p>
<p>▫获胜一方的下游接口称为<strong>Assert Winner</strong>，将负责后续对该网段组播报文的<strong>转发</strong>。</p>
<p>▫落败一方的下游接口称为<strong>Assert Loser</strong>，后续<strong>不会</strong>对该网段<strong>转发</strong>组播报文，PIM路由器也会将其从（S，G）表项<strong>下游接口列表中删除</strong>。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<blockquote>
<p>•断言机制由组播数据触发。</p>
</blockquote>
<h3 id="断言机制选举规则"><a href="#断言机制选举规则" class="headerlink" title="断言机制选举规则"></a>断言机制选举规则</h3><p>•PIM路由器在<strong>接收到</strong>邻居路由器发送的<strong>相同组播报文</strong>后，会向该网段<strong>发送断言（Assert）报文</strong>，进行Assert选举。Assert报文内会携带到组播源的单播路由前缀，路由优先级与开销。选举规则如下：</p>
<p>▫单播路由协议优先级较高者获胜。</p>
<p>▫如果优先级相同，则到组播源的开销较小者获胜。</p>
<p>▫如果以上都相同，则下游接口IP地址最大者获胜。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<blockquote>
<p>•Assert选举失败的设备会抑制转发，并将这种抑制转发的状态保持一段时间，这段时间就被称为Assert保持时间，默认180s。</p>
<p>•Assert保持时间超时后，竞选失败的设备会恢复转发从而触发新一轮竞选。</p>
</blockquote>
<h3 id="剪枝机制"><a href="#剪枝机制" class="headerlink" title="剪枝机制"></a>剪枝机制</h3><p>•对于没有组成员连接的组播路由器，组播网络无需再将组播流量继续放往该设备。通过剪枝机制，组播网络可以将此类路径剪枝。</p>
<p>•剪枝机制工作原理如下：</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•路由器为被裁剪的下游接口启动一个剪枝定时器（默认210s），定时器超时后接口恢复转发。组播报文重新在全网范围内扩散，新加入的组成员可以接收到组播报文。随后，下游不存在组成员的叶子路由器将向上发起剪枝操作。通过这种周期性的扩散-剪枝，PIM-DM周期性的刷新SPT。</p>
<p>•当下游接口被剪枝后：</p>
<ul>
<li><p>如果下游叶子路由器有组成员加入，并且希望在下次“扩散-剪枝”前就恢复组播报文转发，则执行嫁接动作。</p>
</li>
<li><p>如果下游叶子路由器一直没有组成员加入，希望该接口保持抑制转发状态，则执行状态刷新动作。</p>
</li>
</ul>
</blockquote>
<h3 id="维护组播分发树"><a href="#维护组播分发树" class="headerlink" title="维护组播分发树"></a>维护组播分发树</h3><p>•组播分发树形成后不会一直存在，也不会一直不变。</p>
<p>•在PIM邻居关系稳定，组成员没有变化的情况下，维护组播分发树一般有两种方式：</p>
<p>​    ▫持续发送组播报文，保证组播路由表项能一直存在。</p>
<p>​    ▫发送状态刷新报文，保证组播路由表项的下行接口状态不发生变化。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<h3 id="状态刷新机制"><a href="#状态刷新机制" class="headerlink" title="状态刷新机制"></a>状态刷新机制</h3><p>•在PIM-DM网络中，为了避免被裁剪的接口因为“剪枝定时器”超时而恢复转发，离组播源最近的第一跳路由器会周期性地触发State Refresh报文在全网内扩散。</p>
<p>•收到State Refresh报文的PIM路由器会刷新剪枝定时器的状态。被裁剪接口的下游叶子路由器如果一直没有组成员加入，该接口将一直处于抑制转发状态。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<h3 id="新成员加组"><a href="#新成员加组" class="headerlink" title="新成员加组"></a>新成员加组</h3><p>•当有新成员加入组播组后，组播网络需要<strong>更新组播分发树</strong>，才能将组播数据发往组成员。PIM-DM模式在使用“扩散-剪枝”的方式建立组播分发树后，通过<strong>状态刷新机制</strong>，使<strong>下行接口一旦被抑制就无法自动恢复</strong>。</p>
<p>•因此需要一些机制来更新组播分发树，一般PIM-DM模式更新组播分发树的方法有两种：</p>
<p>▫等待组播路由表超时后，全网重新泛洪。该方法不可控，在现网中无法实现</p>
<p>▫使用嫁接（Graft）机制，当新成员加组后，<strong>主动反向建立组播分发路径</strong>。现网中一般使用嫁接机制来实现新成员加组。</p>
<h3 id="嫁接机制"><a href="#嫁接机制" class="headerlink" title="嫁接机制"></a>嫁接机制</h3><p>•PIM-DM通过嫁接机制，使有新组成员加入的网段快速得到组播报文。</p>
<p>•叶子路由器通过IGMP了解到与其相连的用户网段上，组播组G有新的组成员加入。随后叶子路由器会<strong>基于本地的组播路由表</strong>向上游发送Graft报文，请求上游路由器<strong>恢复相应出接口</strong>转发，将其添加在（S，G）表项下游接口列表中。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<h2 id="PIM-DM基本配置"><a href="#PIM-DM基本配置" class="headerlink" title="PIM-DM基本配置"></a>PIM-DM基本配置</h2><h3 id="PIM-DM的基本配置"><a href="#PIM-DM的基本配置" class="headerlink" title="PIM-DM的基本配置"></a>PIM-DM的基本配置</h3><p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<h3 id="PIM-DM基础实验"><a href="#PIM-DM基础实验" class="headerlink" title="PIM-DM基础实验"></a>PIM-DM基础实验</h3><p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<h4 id="查看参数"><a href="#查看参数" class="headerlink" title="查看参数"></a>查看参数</h4><p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"> </p>
<h1 id="3-PM-SM介绍"><a href="#3-PM-SM介绍" class="headerlink" title="3.PM-SM介绍"></a>3.PM-SM介绍</h1><h2 id="PIM-SM-ASM-工作原理"><a href="#PIM-SM-ASM-工作原理" class="headerlink" title="PIM-SM(ASM)工作原理"></a>PIM-SM(ASM)工作原理</h2><h3 id="PIM-DM的局限性"><a href="#PIM-DM的局限性" class="headerlink" title="PIM-DM的局限性"></a>PIM-DM的局限性</h3><p>•中大型组播网络中由于网络较大，如果依然使用PIM-DM会遇到组多问题：</p>
<p>▫使用“扩散-剪枝”方式需要全网扩散组播报文，对于<strong>网络有一定冲击</strong>。</p>
<p>▫所有组播路由器<strong>均需要维护组播路由表</strong>，即使该组播路由器无需转发组播数据。</p>
<p>▫对于组成员较为稀疏的组播网络，使用“扩散-剪枝”形成组播分发树的<strong>效率不高</strong>。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<h3 id="PIM-SM-ASM-介绍"><a href="#PIM-SM-ASM-介绍" class="headerlink" title="PIM-SM(ASM)介绍"></a>PIM-SM(ASM)介绍</h3><p>•PIM-DM模型使用“扩散-剪枝”形成组播分发树的原因是：组播网络中大部分组播路由器无法得知组成员的位置。</p>
<p>•PIM-SM（ASM）模型形成组播分发树的方法是：</p>
<p>▫将组成员的位置事先告知某台组播路由器（Rendezvous Point，RP），形成<strong>RPT（RP Tree）</strong>。</p>
<p>▫组播源在发送组播数据时，组播网络先将组播数据<strong>发送至RP</strong>，然后由RP再将组播数据转发给组成员。</p>
<p>▫对于部分次优的组播转发路径，PIM-SM（ASM）能<strong>自动优化为最优路径（SPT）</strong>。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<blockquote>
<p>•通过PIM-SM（ASM）模式形成组播分发树有如下好处：</p>
<p>​    ▫只有组播转发路劲上的组播路由器需要维护组播路由表。</p>
<p>​    ▫通过RP可以让所有组播路由器获知组成员的位置。</p>
<p>​    ▫避免“扩散-剪枝”机制，提高组播分发树的形成效率。</p>
</blockquote>
<h3 id="PIM-SM-ASM-协议报文"><a href="#PIM-SM-ASM-协议报文" class="headerlink" title="PIM-SM(ASM)协议报文"></a>PIM-SM(ASM)协议报文</h3><p>•PIM协议报文直接采用IP封装，目的地址224.0.0.13，IP协议号103。</p>
<p>•PIM-SM使用报文主要是以下几类：</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<h3 id="RP介绍"><a href="#RP介绍" class="headerlink" title="RP介绍"></a>RP介绍</h3><p>•汇聚点RP（Rendezvous Point）为网络中一台重要的PIM路由器，用于处理源端DR注册信息及组成员加入请求，网络中的<strong>所有PIM路由器都必须知道RP的地址</strong>，类似于一个供求信息的汇聚中心。</p>
<p>•目前可以通过以下方式配置RP：</p>
<p>▫<strong>静态RP</strong>：在网络中的所有PIM路由器上配置相同的RP地址，静态指定RP的位置。</p>
<p>▫<strong>动态RP</strong>：通过选举机制在多个C-RP（Candidate-RP，候选RP）之间选举出RP。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<blockquote>
<p>•静态RP或者是动态RP在设置时均可以指定该RP为哪些组播组提供服务。</p>
</blockquote>
<h3 id="动态选举RP"><a href="#动态选举RP" class="headerlink" title="动态选举RP"></a>动态选举RP</h3><p>•动态选举RP会涉及两类角色C-BSR（Candidate-Bootstrap Router）与C-RP（Candidate-RP）：</p>
<p>▫C-BSR通过竞选能选举出一个唯一的BSR。</p>
<p>▫BSR的作用是收集C-RP的信息并形成RP-Set信息，BSR通过PIM报文将RP-Set信息扩散给所有PIM路由器。</p>
<p>▫PIM路由器收到RP-Set消息后，根据RP选举规则选举出合适的RP。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<blockquote>
<p>•BSR竞选规则如下：</p>
<p>​    ▫优先级较高者获胜（优先级数值越大优先级越高）。</p>
<p>​    ▫如果优先级相同，IP地址较大者获胜。</p>
<p>•RP竞选规则如下：</p>
<p>​    ▫与用户加入的组地址匹配的C-RP服务的组范围掩码最长者获胜。</p>
<p>​    ▫如果以上比较结果相同，则C-RP优先级较高者获胜（优先级数值    越小优先级越高）。</p>
<p>​    ▫如果以上比较结果都相同，则执行Hash函数，计算结果较大者获    胜。</p>
<p>​    ▫如果以上比较结果都相同，则C-RP的IP地址较大者获胜。</p>
</blockquote>
<h3 id="首次形成组播分发树-1"><a href="#首次形成组播分发树-1" class="headerlink" title="首次形成组播分发树"></a>首次形成组播分发树</h3><p>•PIM-SM（ASM）模式首次形成组播分发树主要依赖RPT构建机制，组播源注册机制与DR选举机制。</p>
<p>▫RPT构建机制：组播叶子路由器主动建立到RP的组播分发树（RPT）</p>
<p>▫组播源注册机制：通过该机制形成组播源到RP的组播分发树（SPT）</p>
<p>▫DR选举机制：DR负责源端或组成员端组播报文的收发，避免重复组播报文，同时成员端DR还负责发送Join加组消息。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<blockquote>
<p>•DR选举机制与PIM-DM中的DR选举机制一致，不再赘述。</p>
</blockquote>
<h3 id="RPT构建"><a href="#RPT构建" class="headerlink" title="RPT构建"></a>RPT构建</h3><p>•RPT（RP Tree）是一棵<strong>以RP为根</strong>，以存在组成员关系的<strong>PIM路由器为叶子</strong>的组播分发树。</p>
<p>•当网络中出现组成员（形成IGMP表项）时，组成员端DR向RP发送Join报文，在通向RP的路径上逐跳创建<strong>（*，*G）表项</strong>，生成一棵以RP为根的RPT。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/29.png"></p>
<h3 id="组播源注册机制-–-形成SPT"><a href="#组播源注册机制-–-形成SPT" class="headerlink" title="组播源注册机制 – 形成SPT"></a>组播源注册机制 – 形成SPT</h3><p>•PIM-SM（ASM）模型中，源端DR到RP的组播分发树无法使用Join报文创建，因此需要<strong>组播源注册机制</strong>帮助形成源端DR到RP的组播分发树（SPT）。</p>
<p>•形成SPT需要基于Register报文与Join报文，具体过程如下：</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/30.png"></p>
<blockquote>
<p>•组播源与源端DR之间没有IGMP协议，无法通过IGMP生成PIM（*，G）表项，进而无法发送Join消息形成组播分发树。</p>
</blockquote>
<h3 id="组播源注册机制-–-转发组播数据"><a href="#组播源注册机制-–-转发组播数据" class="headerlink" title="组播源注册机制 – 转发组播数据"></a>组播源注册机制 – 转发组播数据</h3><p>•组播源信息注册到RP后，就形成了组播源到RP的SPT，但源端DR此时仍然会将组播数据包封装入Register报文，该方式会造成一些问题：</p>
<ul>
<li><p>源端DR最初发送的是单播Register报文，但是该方式会<strong>加重源端DR与RP的工作量</strong>。</p>
</li>
<li><p>源端DR形成到RP的SPT后，<strong>会同时发送单播Register报文</strong>和<strong>组播报文</strong>，造成重复组播包的问题。</p>
</li>
</ul>
<p>•SPT建立后，RP使用Register-Stop报文通知源端DR后续报文可以以组播报文形式发送。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/31.png"></p>
<h3 id="源-末端网络中的重复组播报文"><a href="#源-末端网络中的重复组播报文" class="headerlink" title="源/末端网络中的重复组播报文"></a>源/末端网络中的重复组播报文</h3><p>•在<strong>源端网络或者成员端网络中</strong>，有可能有多台组播路由器转发组播流量，从而造成<strong>重复组播报文</strong>的问题。</p>
<p>•PIM DR（Designated Router）是源端网络或者成员端网络的<strong>唯一组播转发者</strong>，由于不存在别的组播转发路由器就避免了重复组播报文的问题。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/32.png"></p>
<h3 id="PIM-DR选举"><a href="#PIM-DR选举" class="headerlink" title="PIM DR选举"></a>PIM DR选举</h3><p>•PIM DR的选举：</p>
<ul>
<li><p>在PIM-SM（ASM）中各路由器通过比较<strong>Hello</strong>消息上携带的<strong>优先级</strong>和<strong>IP地址</strong>，为多路访问网络选举指定路由器DR。</p>
</li>
<li><p><strong>接口DR优先级高</strong>的路由器将成为该MA网络的DR，在优先级相同的情况下，<strong>接口IP地址大</strong>的路由器将成为DR。</p>
</li>
<li><p>当DR出现故障后，邻居路由器之间会重新选举DR。</p>
</li>
</ul>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/33.png"></p>
<blockquote>
<p>•DR优先级默认为1，数值越大越优。</p>
<p>•对于成员端网络，如果有多台组播路由器，则组播路由器的下行接口需要同时开启IGMP与PIM。</p>
<p>•DR还可充当IGMPv1的查询器。</p>
</blockquote>
<h3 id="RPT次优路径问题"><a href="#RPT次优路径问题" class="headerlink" title="RPT次优路径问题"></a>RPT次优路径问题</h3><p>•在PIM-SM网络中，一个组播组只对应一个RP。因此组播数据最初都会发往RP，由RP进行转发，这会导致两个问题：</p>
<p>​    ▫过大的组播流量会对RP形成巨大的负担。</p>
<p>​    ▫组播转发路径有可能是次优路径。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/34.png"></p>
<h3 id="SPT切换机制"><a href="#SPT切换机制" class="headerlink" title="SPT切换机制"></a>SPT切换机制</h3><p>•当数据发送至RP后，RP会沿RPT将数据发送给成员端DR。为了解决RPT潜在的次优路径问题，<strong>成员端DR</strong>会基于组播数据包中的源IP，反向建立从成员端DR到源的SPT。</p>
<p>•具体过程如下：</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/35.png"></p>
<blockquote>
<p>•设备沿最短路径发送Join消息，该最短路径基于RPF选举规则决定。设备将Join消息从RPF选举得出的上行接口发出。</p>
<p>•多路访问网络在SPT切换的过程中可能会存在重复报文，需要利用断言机制快速选定下行接口。</p>
<p>•SPT切换的触发条件</p>
</blockquote>
<h3 id="维护组播分发树-1"><a href="#维护组播分发树-1" class="headerlink" title="维护组播分发树"></a>维护组播分发树</h3><p>•当组播分发树（<strong>SPT或RPT</strong>）稳定后，成员端DR会周期性发送Join/Prune报文，用于维护组播分发树。</p>
<p>•如果组播在一段时间后（默认210s）没有流量则SPT树会消失，成员端DR恢复到RP的RPT树。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/36.png"></p>
<h2 id="PIM-SM-SSM-工作原理"><a href="#PIM-SM-SSM-工作原理" class="headerlink" title="PIM-SM(SSM)工作原理"></a>PIM-SM(SSM)工作原理</h2><h3 id="SSM概念回顾"><a href="#SSM概念回顾" class="headerlink" title="SSM概念回顾"></a>SSM概念回顾</h3><p>•SSM模型针对特定源和组的绑定数据流提供服务，接收者主机在加入组播组时，可以<strong>指定只接收</strong>哪些源的数据或<strong>指定拒绝接收</strong>来自哪些源的数据。加入组播组以后，主机<strong>只会收到指定源</strong>发送到该组的数据。</p>
<p>•<strong>SSM模型对组地址不再要求全网唯一</strong>，<strong>只需要每个组播源保持唯一</strong>。这里的“唯一”指的是同一个源上不同的组播应用必须使用不同的SSM地址来区分。不同的源之间可以使用相同的组地址，因为SSM模型中针对每一个（源，组）信息都会生成表项。这样一方面节省了组播组地址，另一方面也不会造成网络拥塞。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/37.png"></p>
<h3 id="PIM-SM-SSM-基本概述"><a href="#PIM-SM-SSM-基本概述" class="headerlink" title="PIM-SM(SSM)基本概述"></a>PIM-SM(SSM)基本概述</h3><p>•由于SSM提前定义了组播的源地址，所以PIM-SM（SSM）可以在成员端DR上基于组播源地址直接反向建立SPT。</p>
<p>•PIM-SM（SSM）<strong>无需维护RP</strong>、<strong>无需构建RPT</strong>、<strong>无需注册组播源</strong>，可以直接在组播源与组成员之间建立SPT。</p>
<p>•在PIM-SM（SSM）模型中，关键机制包括邻居发现、DR竞选、构建SPT。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/38.png"></p>
<blockquote>
<p>•PIM-SM（SSM）无需Assert机制</p>
</blockquote>
<h3 id="组播分发树形成与维护"><a href="#组播分发树形成与维护" class="headerlink" title="组播分发树形成与维护"></a>组播分发树形成与维护</h3><p>•PIM-SM（SSM）模型构建组播分发树的形成主要依赖IGMPv3报文与Join报文。</p>
<p>•PIM-SM（SSM）模型形成的<strong>组播分发树会一直存在</strong>，不会因为没有组播流量而消失。</p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/39.png"></p>
<blockquote>
<p>•DR与邻居发现机制与PIM-DM模式一样，此处不再赘述。</p>
</blockquote>
<h3 id="PIM模型比较"><a href="#PIM模型比较" class="headerlink" title="PIM模型比较"></a>PIM模型比较</h3><p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/40.png"></p>
<h2 id="PIM-SM基本配置"><a href="#PIM-SM基本配置" class="headerlink" title="PIM-SM基本配置"></a>PIM-SM基本配置</h2><h3 id="PIM-SM的基本配置"><a href="#PIM-SM的基本配置" class="headerlink" title="PIM-SM的基本配置"></a>PIM-SM的基本配置</h3><p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/41.png"></p>
<h3 id="PIM-SM基础实验"><a href="#PIM-SM基础实验" class="headerlink" title="PIM-SM基础实验"></a>PIM-SM基础实验</h3><p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/42.png"></p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/43.png"></p>
<p><img src="/2021/05/17/IP-PIM%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/44.png"></p>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>1.（单选题）PIM组播报文的目的IP地址是？</p>
<p>A.224.0.0.2</p>
<p>B.224.0.0.1</p>
<p>C.224.0.0.5</p>
<p><strong>D.224.0.0.13</strong></p>
<p>2.（多选题）组播防止重复报文的机制有？</p>
<p><strong>A.RPF机制</strong></p>
<p><strong>B.Assert选举机制</strong></p>
<p><strong>C.DR选举机制</strong></p>
<p>D.IGMP查询者选举机制</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•PIM模型有两种：</p>
<ul>
<li><p>PIM-DM主要使用在网络规模较小，用户集中的组播网络中。</p>
</li>
<li><p>PIM-SM主要使用在网络规模较大，用户较为分散的组播网络中。PIM-SM基于组播模型又可以分为PIM-SM（ASM）于PIM-SM（SSM）模型，PIM-SM（SSM）模型主要为SSM组播服务。</p>
</li>
</ul>
<p>•PIM-DM使用“扩散-剪枝”的方式形成组播分发树，在形成分发树时使用Assert选举于DR选举机制防止环路产生，在组播转发时使用PRF机制防止环路产生。</p>
<p>•PIM-SM（ASM）将组成员加组信息发送给RP，形成RPT，组播源再发送组播报文时先将组播报文发送至RP，然后由RP再将组播数据发送至组成员，形成SPT+RPT的组播分发树。为了防止RPT次优路径的问题，PIM-SM（ASM）会发起SPT切换的机制，优化组播分发树。</p>
<p>•PIM-SM（SSM）主要为SSM组播模型服务，由于SSM组播模型预先知道组播源的地址，因此可以直接反向建立组播分发树。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IP-IGMP原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T11:52:35+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•组播通信中，组播网络需要将组播数据发送给特定的组播组成员，因此组播网络需要知道组成员的位置与组成员所加的组播组。</p>
<p>•通过<strong>IGMP（Internet Group Management Protocol，因特网组管理协议）</strong>，组成员可以将加组消息发送给组播网络，从而让组播网络<strong>感知</strong>到<strong>组成员的位置</strong>和<strong>所加组播组</strong>。</p>
<p>•本课程主要讲解IGMP的作用和基本原理，包括IGMPv1、IGMPv2和IGMPv3三个版本的原理与区别，和IGMP Snooping的工作机制、IGMP SSM Mapping工作机制、IGMP代理的工作机制。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述IGMP的基本原理和配置</p>
<p>▫描述IGMP不同版本间的区别</p>
<p>▫描述IGMP Snooping的基本原理</p>
<p>▫描述IGMP SSM Mapping的基本原理</p>
<p>▫描述IGMP代理的基本原理</p>
<h1 id="1-IGMP介绍"><a href="#1-IGMP介绍" class="headerlink" title="1.IGMP介绍"></a>1.IGMP介绍</h1><h2 id="IGMP简介"><a href="#IGMP简介" class="headerlink" title="IGMP简介"></a>IGMP简介</h2><h3 id="组播网络的转发困境"><a href="#组播网络的转发困境" class="headerlink" title="组播网络的转发困境"></a>组播网络的转发困境</h3><p>•IP组播通信的特点是报文从一个源发出，被转发到一组特定的组播组成员。在组播通信模型中，组播源不关注接收者的位置信息，组播数据转发需要依赖组播网络才能将数据发送至组播组成员。</p>
<p>•组播数据在进行传递时，组播网络为了将组播数据转发至组播组成员，需要知道<strong>组播组成员的位置</strong>与<strong>所加组播组</strong>。</p>
<p>•组播网络<strong>如何感知组播组成员？</strong></p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h3 id="感知组播组成员"><a href="#感知组播组成员" class="headerlink" title="感知组播组成员"></a>感知组播组成员</h3><p>•组播网络感知组播组成员有两种方法：</p>
<p>▫手工静态配置：在组播路由器上静态指定连接组播组成员的接口，静态配置组成员加组信息。</p>
<p>▪手工静态方式灵活性差，配置工作量大，但相对比较稳定，对于新上线的组成员能够快速建立组播转发通路。</p>
<p>▫动态感知：通过<strong>IGMP</strong>协议通知组播网络，组播网络根据IGMP消息感知组播组成员所在接口，以及组成员加组信息。</p>
<p>▪动态感知方式较为灵活，且配置简单，<strong>现网一般使用动态感知方式</strong>。</p>
<p>•当组播网络获得组成员位置与加组信息后，可以基于这些信息转发组播报文。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•组播网络转发报文时需要依赖组播分发树，该分发树的形成将在《PIM原理与配置》课程讲解。</p>
</blockquote>
<h3 id="IGMP协议的概述"><a href="#IGMP协议的概述" class="headerlink" title="IGMP协议的概述"></a>IGMP协议的概述</h3><p>•IGMP是TCP/IP协议族中负责IPv4组播成员管理的协议，用来在接收者主机和与其直接相邻的组播路由器之间<strong>建立</strong>和<strong>维护组播组成员关系</strong>。</p>
<p>•IGMP通过在组播组成员和组播路由器之间交互IGMP报文实现组成员管理功能，IGMP报文封装在IP报文中。</p>
<p>•到目前位置，IGMP有三个版本：</p>
<p>▫IGMPv1</p>
<p>▫IGMPv2</p>
<p>▫IGMPv3</p>
<p>•组播路由器与组成员间交互报文后会生成<strong>IGMP路由表项</strong>与<strong>IGMP组表项</strong>。</p>
<p>•IGMP路由表项与IGMP组表项将帮助设备生成组播路由表项。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<h3 id="IGMP组表项与路由表项"><a href="#IGMP组表项与路由表项" class="headerlink" title="IGMP组表项与路由表项"></a>IGMP组表项与路由表项</h3><p>•IGMP协议会生成IGMP路由表项与IGMP组表项，组播路由表项需要基于IGMP路由表项与IGMP组表项的信息生成。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<h3 id="IGMP表项与组播路由表项"><a href="#IGMP表项与组播路由表项" class="headerlink" title="IGMP表项与组播路由表项"></a>IGMP表项与组播路由表项</h3><p>•在<strong>最后一跳组播路由器（组播叶子路由器）</strong>上，组播路由表可以基于IGMP路由表项，IGMP组表项与组播协议路由表（PIM路由表）汇总后形成。</p>
<p>•IGMP路由表项与IGMP组表项能为组播协议路由表提供<strong>组播组地址信息</strong>与<strong>出接口信息</strong>。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<h2 id="IGMP工作原理"><a href="#IGMP工作原理" class="headerlink" title="IGMP工作原理"></a>IGMP工作原理</h2><h3 id="IGMPv1基本概念"><a href="#IGMPv1基本概念" class="headerlink" title="IGMPv1基本概念"></a>IGMPv1基本概念</h3><p>•IGMPv1主要基于查询和响应机制完成组播组管理。</p>
<p>•查询和响应机制由两种报文实现：</p>
<ul>
<li><p><strong>普遍组查询报文（General Query</strong>）：查询器向共享网络上所有主机和路由器发送的查询报文，用于查询<strong>哪些组播组存在成员。</strong></p>
</li>
<li><p><strong>成员关系报告报文（Report）</strong>：主机向查询器发送的报告报文，用于<strong>申请加入某个组播组</strong>或者<strong>应答查询报文</strong>。</p>
</li>
</ul>
<p>•由于IGMP报文是组播报文，因此一个多路访问网络里只需要<strong>一个组播路由器发送查询报文即可</strong>，该组播路由器被称为<strong>IGMP查询器（Querier）</strong>。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<h3 id="IGMPv1报文格式"><a href="#IGMPv1报文格式" class="headerlink" title="IGMPv1报文格式"></a>IGMPv1报文格式</h3><p>•IGMPv1普遍组查询报文与成员关系报告报文均为组播报文，<strong>目的地址为224.0.0.1</strong>。</p>
<p>•IGMPv1普遍组查询报文与成员关系报告报文格式类似，其中最主要的是Version，Type，Group Address这三个字段：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h3 id="IGMPv1组成员加组机制"><a href="#IGMPv1组成员加组机制" class="headerlink" title="IGMPv1组成员加组机制"></a>IGMPv1组成员加组机制</h3><p>•通过普遍组查询报文与成员关系报告报文，IGMP查询器可以了解到该网段内哪些组播组存在成员。</p>
<p>•IGMPv1组成员加组基本流程如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<blockquote>
<p>IGMPv1普遍组查询和响应过程如下：</p>
<p>▫IGMP查询器发送目的地址为224.0.0.1（表示同一网段内所有主机和路由器）的普遍组查询报文；收到该查询报文的组成员启动定时器。普遍组查询报文是周期性发送的，发送周期可以通过命令配置，缺省情况下每隔60秒发送一次。组成员1和组成员2是组播组G1的成员，则在本地启动定时器Timer-G1。缺省情况下，定时器的范围为0～10秒之间的随机值。</p>
<p>▫第一个定时器超时的组成员发送针对该组的报告报文。</p>
<p>▫IGMP查询器接收到组播组成员1的报告报文后，了解到本网段内存在组播组G1的成员，则由生成IGMP组表项与（<em>，G1）IGMP路由表项，“</em>”代表任意组播源。网络中一旦有组播组G1的数据到达路由器，将向该网段转发。</p>
<p>成员关系报告报文抑制机制：</p>
<p>▫普遍组查询报文是周期性发送的，发送周期可以通过命令配置，缺省情况下每隔60秒发送一次。组成员1和组成员2是组播组G1的成员，则在本地启动定时器Timer-G1。缺省情况下，定时器的范围为0～10秒之间的随机值。</p>
<p>▫假设组成员1上的Timer-G1首先超时，组成员1向该网段发送目的地址为G1的报告报文。也想加入组G1的组成员2收到此报告报文，则停止定时器Timer-G1，不再发送针对G1的报告报文。这样报告报文被抑制，可以减少网段上的流量。</p>
</blockquote>
<h3 id="IGMPv1查询器选举机制"><a href="#IGMPv1查询器选举机制" class="headerlink" title="IGMPv1查询器选举机制"></a>IGMPv1查询器选举机制</h3><p>•普遍组查询是组播报文，因此同一网段内只需要一台查询器即可查询所有组成员的加组信息。</p>
<p>•IGMPv1<strong>没有基于IGMP的查询器选举机制</strong>，所以需要依赖组播路由协议（PIM）进行IGMP查询器选举。</p>
<p>•IGMPv1将组播路由协议（PIM）选举出唯一的<strong>组播信息转发者（Assert Winner或DR）作为IGMPv1的查询器</strong>，负责该网段的组成员关系查询。</p>
<p>•查询器和非查询器均能收到成员关系报告（目的地址224.0.0.1），因此均能形成IGMP路由表与IGMP组表项。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<blockquote>
<p>•Assert Winner或DR用于转发组播流量。</p>
<p>•关于Assert Winner或DR的具体作用，将在《PIM原理与配置》课程介绍。</p>
</blockquote>
<h3 id="IGMPv1组成员离组机制"><a href="#IGMPv1组成员离组机制" class="headerlink" title="IGMPv1组成员离组机制"></a>IGMPv1组成员离组机制</h3><p>•IGMPv1没有专门定义离开组消息，当组播组成员离开组播组时，将不会再对普遍组查询报文做出回应。</p>
<p>•当网段内不存在特定组的组成员，IGMP查询器不会收到特定组成员的报告报文，则在一定时间（缺省值为130s）后，删除特定组所对应的组播转发表项。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<blockquote>
<p>•组成员离开机制：</p>
<p>▫假设组成员2想要退出组播组G2</p>
<ul>
<li><p>组成员2收到IGMP查询器发送的普遍组查询报文时，不再发送针对G2的报告报文。由于网段内不存在组G2的其他成员，IGMP查询器不会收到G2组成员的报告报文，则在一定时间（缺省值为130秒）后，删除G2所对应的IGMP表项。</p>
</li>
<li><p>组成员1收到IGMP查询器发送的普遍组查询报文时，反馈针对G1的报告报文，IGMP查询器不删除G1相应IGMP表项</p>
</li>
</ul>
</blockquote>
<h3 id="IGMPv2介绍"><a href="#IGMPv2介绍" class="headerlink" title="IGMPv2介绍"></a>IGMPv2介绍</h3><p>•IGMPv1在离组机制与查询器选举机制上有一定缺陷：</p>
<p>​    ▫IGMPv1离组使用超时机制，组成员只能静默离组。在未超时的时间内，组播流量依然会被组播路由器转发。</p>
<p>​    ▫IGMPv1查询器选举必须要依赖PIM协议，导致查询器选举不够灵活。</p>
<p>•IGMPv2改善了IGMPv1的缺陷：</p>
<p>​    ▫IGMPv2组成员加组机制与IGMPv1基本相同</p>
<p>​    ▫IGMPv2增加了离开组机制</p>
<p>​    ▫IGMPv2增加了查询器选举机制</p>
<p>•IGMPv2能与IGMPv1兼容。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<h3 id="IGMPv2报文格式"><a href="#IGMPv2报文格式" class="headerlink" title="IGMPv2报文格式"></a>IGMPv2报文格式</h3><p>•为了改善组成员离开机制，IGMPv2新增了两种报文：</p>
<p>▫<strong>成员离开报文（Leave）</strong>：成员离开组播组时主动向查询器发送的报文，用于宣告自己离开了某个组播组。成员离开报文目的地址为224.0.0.2。</p>
<p>▫<strong>特定组查询报文（Group-Specific Query）</strong>：查询器向共享网段内指定组播组发送的查询报文，用于查询该组播组是否存在成员。特定组查询报文目的地址为所查询组播组的组地址。</p>
<p>•IGMPv2对普遍组查询报文格式也做了改进，添加了最大响应时间（Max Response Time）字段。此字段取值可以通过命令配置，用于控制成员对于查询报文的响应速度。</p>
<p>•IGMPv2报文格式如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<blockquote>
<p>IGMPv2报文各字段说明：</p>
<ul>
<li><p>Type：</p>
<p>▪报文类型。该字段有以下四种取值：</p>
<p>▪0x11:表示查询报文。IGMPv2的查询报文包括普遍组查询报文和特定组查询报文两类。</p>
<p>▪0x12:表示IGMPv1成员关系报告报文。</p>
<p>▪0x16:表示IGMPv2成员关系报告报文。</p>
<p>▪0x17:表示成员离开报文。</p>
</li>
<li><p>Max Response Time：表示主机响应查询返回报告的最大时间。</p>
<p>▪对于普遍组查询，最大响应时间默认为10秒。</p>
<p>▪对于特定组查询，最大响应时间默认为1秒。</p>
</li>
<li><p>Group Address：</p>
<p>▪普遍组查询报文中，组地址设置为0。</p>
<p>▪特定组查询报文中，组地址为需要查询的组地址。</p>
<p>▪在成员关系报告或离开组的消息中，组地址为需要报告或离开的组地址。</p>
</li>
</ul>
</blockquote>
<h3 id="IGMPv2查询器选举机制"><a href="#IGMPv2查询器选举机制" class="headerlink" title="IGMPv2查询器选举机制"></a>IGMPv2查询器选举机制</h3><p>•IGMPv2组成员<strong>加组机制与IGMPv1一致</strong>，不再赘述。</p>
<p>•IGMPv2查询器选举机制与IGMPv1有较大差异。IGMPv2使用<strong>独立的查询器选举机制</strong>，当共享网段上存在多个组播路由器时，IP地址最小的路由器成为查询器。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•非查询器上都会启动一个定时器（即其他查询器存在时间定时器Other Querier Present Timer）。在该定时器超时前，如果收到了来自查询器的查询报文，则重置该定时器；否则，就认为原查询器失效，并发起新的查询器选举过程。</p>
</blockquote>
<h3 id="IGMPv2组成员离开机制"><a href="#IGMPv2组成员离开机制" class="headerlink" title="IGMPv2组成员离开机制"></a>IGMPv2组成员离开机制</h3><p>•IGMPv2使用成员离开报文与特定组查询报文加速感知IGMPv2组成员离开。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•组播组成员向本地网段内的所有组播路由器（目的地址为224.0.0.2）发送针对组G1的离开报文。</p>
<ul>
<li><p>查询器收到离开报文，会发送针对组G1的特定组查询报文。发送间隔和发送次数可以通过命令配置，缺省情况下每隔1秒发送一次，共发送两次。同时查询器启动组成员关系定时器（Timer-Membership=发送间隔x发送次数）。</p>
</li>
<li><p>如果该网段内还存在组G1的其他成员，这些成员在收到查询器发送的特定组查询报文后，会立即发送针对组G1的报告报文。查询器收到针对组G1的报告报文后将继续维护该组成员关系。</p>
</li>
<li><p>如果该网段内不存在组G1的其他成员，查询器将不会收到针对组G1的报告报文。在Timer-Membership超时后，查询器将删除（*，G1）对应的IGMP组表项。当有组G1的组播数据到达查询器时，查询器将不会向下游转发。</p>
</li>
</ul>
</blockquote>
<h3 id="SSM模型带来的挑战"><a href="#SSM模型带来的挑战" class="headerlink" title="SSM模型带来的挑战"></a>SSM模型带来的挑战</h3><p>•出于安全考虑，组播组成员可以只选择接收从特定组播源发来的组播数据。组成员需要告知组播网络，接收来自哪些特定组播源的组播流量。</p>
<p>•IGMPv1与IGMPv2的报文中均<strong>无法携带组播源的信息</strong>，因此<strong>无法配合SSM使用</strong>（可使用SSM Mapping功能解决这个问题）。</p>
<p>•IGMPv3主要是为了配合SSM（Source-Specific Multicast）模型发展起来的，提供了在报文中携带组播源信息的能力，即主机可以对组播源进行选择。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<blockquote>
<p>•SSM模型的组播地址范围：232.0.0.0~232.255.255.255</p>
<p>•SSM Mapping功能将在IGMP特性章节介绍。</p>
</blockquote>
<h3 id="IGMPv3介绍"><a href="#IGMPv3介绍" class="headerlink" title="IGMPv3介绍"></a>IGMPv3介绍</h3><p>•IGMPv3大部分工作机制与IGMPv2类似：</p>
<p>▫查询器选举机制一致：IP地址小的为查询器。</p>
<p>▫使用普遍组查询报文查询组成员加组信息。</p>
<p>▫使用特定组查询报文查询特定组播的成员存活情况。</p>
<p>•IGMPv3需要支持上报组播源信息，与IGMPv2相比IGMPv3的变化如下：</p>
<p>▫IGMPv3查询报文除了包含普遍组查询报文和特定组查询报文，还新增了特定源组查询报文（Group-and-Source-Specific Query）。</p>
<p>▫IGMPv3成员关系报告报文不仅包含主机想要加入的组播组，而且包含主机想要接收来自哪些组播源的数据。</p>
<p>▫由于同个组播组的不同成员可能希望接收来自不同源的组播，因此IGMPv3<strong>无需成员关系报告报文抑制机制。</strong></p>
<p>▫IGMPv3<strong>没有定义专门的成员离开报文</strong>，成员离开通过特定类型的报告报文来传达。</p>
<h3 id="IGMPv3报文格式-–-查询报文"><a href="#IGMPv3报文格式-–-查询报文" class="headerlink" title="IGMPv3报文格式 – 查询报文"></a>IGMPv3报文格式 – 查询报文</h3><p>•IGMPv3的查询报文共有三类：</p>
<p>▫<strong>普遍组查询报文（General Query）</strong>。该报文作用与IGMPv1,IGMPv2中的普遍组查询报文作用一致。</p>
<p>▫<strong>特定组查询报文（Group-Specific Query）</strong> 。该报文作用与IGMPv2中的特定组查询报文作用一致。</p>
<p>▫<strong>特定源组查询报文（Group-and-Source-Specific Query）</strong>。该报文用于查询该组成员是否愿意接收特定源发送的数据。特定源组查询通过在报文中携带一个或多个组播源地址来达到这一目的。</p>
<p>•IGMPv3查询报文格式如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<blockquote>
<p>IGMPv3查询报文重要字段说明：</p>
<p>▫Type：报文类型，取值为0x11。</p>
<p>▫Max Response Code：最大响应时间。成员主机在收到IGMP查询器发送的普遍组查询报文后，需要在最大响应时间内做出回应。</p>
<p>▫Group Address：组播组地址。在普遍组查询报文中，该字段设为0；在特定组查询报文和特定源组查询报文中，该字段为要查询的组播组地址。</p>
<p>▫Number of Sources：报文中包含的组播源的数量。对于普遍组查询报文和特定组查询报文，该字段为0；对于特定源组查询报文，该字段非0。此参数的大小受到所在网络MTU大小的限制。</p>
<p>▫Source Address：组播源地址，其数量受到Number of Sources字段值大小的限制。</p>
</blockquote>
<h3 id="IGMPv3报文格式-–-成员关系报告报文"><a href="#IGMPv3报文格式-–-成员关系报告报文" class="headerlink" title="IGMPv3报文格式 – 成员关系报告报文"></a>IGMPv3报文格式 – 成员关系报告报文</h3><p>•IGMPv3成员关系报告报文除了通告组成员的加组信息外，还能通告组成员希望接收的组播源信息。通告组播源主要有两种模式：</p>
<p>▫INCLUDE：希望<strong>接收</strong>来自特定组播源的组播流量</p>
<p>▫EXCLUDE：希望<strong>过滤</strong>来自特定组播源的组播流量</p>
<p>•成员关系报告报文中的组播组信息和组播源信息的关系会记录在组记录（Group Record）字段，发送给IGMP查询器。IGMPv3成员关系报告报文的目的地址为224.0.0.22，报文格式如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<blockquote>
<p>•在IGMPv3中一个成员关系报告报文可以携带多个组播组信息，而之前的版本一个成员关系报告只能携带一个组播组。这样在IGMPv3中报文数量大大减少。</p>
<p>•IGMPv3成员关系报告报文重要字段说明：</p>
<ul>
<li><p>Type：报文类型，取值为0x22。</p>
</li>
<li><p>Number of Group Records：报文中包含的组记录的数量。</p>
</li>
<li><p>Group Record：组记录。</p>
</li>
</ul>
<p>•Group Record重要字段说明：</p>
<ul>
<li>Record Type：组记录的类型。共分为三大类。<ul>
<li>当前状态报告。用于对查询报文进行响应，通告自己目前的状态，共两种：一种是MODE_IS_INCLUDE，表示接收源地址列表包含的源发往该组的组播数据。如果指定源地址列表为空，该报文无效；另一种是MODE_IS_EXCLUDE，表示不接收源地址列表包含的源发往该组的组播数据。</li>
<li>过滤模式改变报告。当组和源的关系在INCLUDE和EXCLUDE之间切换时，会通告过滤模式发生变化，共两种：一种是CHANGE_TO_INCLUDE_MODE，表示过滤模式由EXCLUDE转换到INCLUDE，接收源地址列表包含的新组播源发往该组播组的数据。如果指定源地址列表为空，主机将离开组播组；另一种是CHANGE_TO_EXCLUDE_MODE，表示过滤模式由INCLUDE转换到EXCLUDE，拒绝源地址列表包含的新组播源发往该组的组播数据。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="IGMPv3报文格式-–-成员关系报告报文-1"><a href="#IGMPv3报文格式-–-成员关系报告报文-1" class="headerlink" title="IGMPv3报文格式 – 成员关系报告报文"></a>IGMPv3报文格式 – 成员关系报告报文</h3><p>•IGMPv3成员关系报告报文除了通告组成员的加组信息外，还能通告组成员希望接收的组播源信息。通告组播源有两种模式：</p>
<p>▫INCLUDE：希望接收来自特定组播源的组播流量</p>
<p>▫EXCLUDE：希望过滤来自特定组播源的组播流量</p>
<p>•组播组信息和组播源信息的关系会记录在组记录（Group Record）字段，发送给IGMP查询器。</p>
<p>•IGMPv3成员关系报告报文格式如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<blockquote>
<p>▪源列表改变报告。当指定源发生改变时，会通告源列表发生变化，共两种：一种是ALLOW_NEW_SOURCES，表示在现有的基础上，需要接收源地址列表包含的组播源发往该组播组的组播数据。如果当前对应关系为INCLUDE，则向现有源列表中添加这些组播源；如果当前对应关系为EXCLUDE，则从现有阻塞源列表中删除这些组播源；另一种是BLOCK_OLD_SOURCES，表示在现有的基础上，不再接收源地址列表包含的组播源发往该组播组的组播数据。如果当前对应关系为INCLUDE，则从现有源列表中删除这些组播源；如果当前对应关系为EXCLUDE，则向现有源列表中添加这些组播源。</p>
<p>▫Number of Sources：本记录中包含的源地址数量。</p>
<p>▫Multicast Address：组播组地址。</p>
<p>▫Sources Address：组播源地址。</p>
</blockquote>
<h3 id="IGMPv3组成员加组机制"><a href="#IGMPv3组成员加组机制" class="headerlink" title="IGMPv3组成员加组机制"></a>IGMPv3组成员加组机制</h3><p>•IGMPv3组成员加组机制与IGMPv2类似，但有以下不同：</p>
<p>▫IGMPv3的成员关系报告报文能够携带组播源信息。</p>
<p>▫IGMPv3成员关系报告报文<strong>没有成员关系报告报文抑制机制</strong>。</p>
<p>•IGMPv3组成员加组流程如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<h3 id="IGMPv3组成员离组机制"><a href="#IGMPv3组成员离组机制" class="headerlink" title="IGMPv3组成员离组机制"></a>IGMPv3组成员离组机制</h3><p>•IGMPv3没有专门的成员离开报文，成员离开需要借助组成员关系报告实现。</p>
<p>•IGMP查询器在收到<strong>改变源组对应关系的成员关系报告</strong>后，会发送特定源组查询报文，确认是否还有组成员存在。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<blockquote>
<p>•改变源组关系的成员关系报告报文很多，比如：</p>
<ul>
<li>设备原来接收来自S1的组播数据，那么通过发布（G1，EXCLUDE，S1）报文或（G1，CHANGE_TO_EXCLUDE_MODE，S1）报文都可以改变源组关系。</li>
</ul>
</blockquote>
<h3 id="IGMP各版本间的差异"><a href="#IGMP各版本间的差异" class="headerlink" title="IGMP各版本间的差异"></a>IGMP各版本间的差异</h3><p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<h1 id="2-IGMP特性介绍"><a href="#2-IGMP特性介绍" class="headerlink" title="2.IGMP特性介绍"></a>2.IGMP特性介绍</h1><h2 id="IGMP-Snooping介绍"><a href="#IGMP-Snooping介绍" class="headerlink" title="IGMP Snooping介绍"></a>IGMP Snooping介绍</h2><h3 id="以太网的组播转发问题"><a href="#以太网的组播转发问题" class="headerlink" title="以太网的组播转发问题"></a>以太网的组播转发问题</h3><p>•当组播数据从最后一跳路由器发往组播组成员时，往往会经过交换机。由于组播数据的<strong>目的MAC地址是组播MAC地址</strong>，默认情况下交换机将泛洪此类数据帧，有可能导致不同组的组播流量会被别组的成员接收。</p>
<p>•IGMP Snooping功能可以控制组播流量在以太网的泛洪范围，避免不同组的组播流量被别组成员接收。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<blockquote>
<p>•当Router将组播报文转发至Switch以后，Switch负责将组播报文转发给组播用户。由于组播报文的目的地址为组播组地址，在二层设备上是学习不到这一类MAC表项的，因此组播报文就会在所有接口进行广播，和它在同一广播域内的组播成员和非组播成员都能收到组播报文。这样不但浪费了网络带宽，而且影响了网络信息安全。</p>
<p>•IGMP Snooping有效地解决了这个问题。配置IGMP Snooping后，二层组播设备可以侦听和分析组播用户和上游路由器之间的IGMP报文，根据这些信息建立二层组播转发表项，控制组播数据报文转发。这样就防止了组播数据在二层网络中的广播。</p>
</blockquote>
<h3 id="IGMP-Snooping介绍-1"><a href="#IGMP-Snooping介绍-1" class="headerlink" title="IGMP Snooping介绍"></a>IGMP Snooping介绍</h3><p>•IGMP Snooping可以实现组播数据在数据链路层的转发和控制。</p>
<p>•当主机和上游三层设备之间传递的IGMP协议报文通过二层组播设备时，IGMP Snooping分析报文携带的信息，根据这些信息建立和维护<strong>二层组播转发表</strong>，从而指导组播数据在数据链路层按需转发。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<blockquote>
<p>•Router Port：路由器端口</p>
</blockquote>
<h3 id="IGMP-Snooping端口与转发表介绍"><a href="#IGMP-Snooping端口与转发表介绍" class="headerlink" title="IGMP Snooping端口与转发表介绍"></a>IGMP Snooping端口与转发表介绍</h3><p>•二层组播转发表项中存在两类接口：</p>
<p>▫<strong>路由器端口（Router Port）</strong>：二层组播设备上朝向三层组播设备（DR或IGMP查询器）一侧的接口，二层组播设备从此接口接收组播数据报文。</p>
<p>▫<strong>成员端口（Member Port）</strong>：又称组播组成员端口，表示二层组播设备上朝向组播组成员一侧的端口，二层组播设备往此接口发送组播数据报文。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<blockquote>
<p>•路由器端口生成过程：</p>
<ul>
<li><p>由协议生成的路由器端口叫做动态路由器端口。收到源地址不为0.0.0.0的IGMP普遍组查询报文或PIM Hello报文（三层组播设备的PIM接口向外发送的用于发现并维持邻居关系的报文）的接口都将被视为动态路由器端口。</p>
</li>
<li><p>手工配置的路由器端口叫做静态路由器端口。</p>
</li>
</ul>
<p>•成员端口生成过程：</p>
<ul>
<li><p>由协议生成的成员端口叫做动态成员端口。收到IGMP Report报文的接口，二层组播设备会将其标识为动态成员端口。</p>
</li>
<li><p>手工配置的成员端口叫做静态成员端口。</p>
</li>
</ul>
</blockquote>
<h3 id="IGMP-Snooping工作原理-–-形成转发表项"><a href="#IGMP-Snooping工作原理-–-形成转发表项" class="headerlink" title="IGMP Snooping工作原理 – 形成转发表项"></a>IGMP Snooping工作原理 – 形成转发表项</h3><p>•IGMP Snooping设备通过监听IGMP报文，形成二层组播转发表，并决定接口类型，具体过程如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<blockquote>
<p>•路由器端口形成后会启动老化计时器（默认180s）,当路由器端口收到新的普遍组查询后刷新该计时器。</p>
<p>•成员端口形成后会启动老化计时器（默认180s）,当成员端口收到新的成员关系报告报文后刷新该计时器。</p>
<p>•IGMP Snooping不再使用成员关系报告报文抑制机制：</p>
<ul>
<li><p>由于IGMP Snooping需要监听IGMP报文才能决定端口角色，进而指导转发，所以所有组成员都需要发送IGMP组成员关系报告报文。</p>
</li>
<li><p>当IGMP Snooping设备收到成员关系报告报文后，只将成员关系报告报文从路由器接口发送出去，从而避免其余组成员收到成员关系报告报文，不触发成员关系报告报文抑制机制。</p>
</li>
</ul>
</blockquote>
<h3 id="IGMP-Snooping工作原理-–-维护转发表项"><a href="#IGMP-Snooping工作原理-–-维护转发表项" class="headerlink" title="IGMP Snooping工作原理 – 维护转发表项"></a>IGMP Snooping工作原理 – 维护转发表项</h3><p>•IGMP Snooping设备通过监听IGMP离开报文，IGMP成员关系报告报文决定特定端口是否还需要发送特定组播，具体过程如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<blockquote>
<p>•收到IGMP离开报文后，成员端口的老化定时器 = 健壮系数（默认2） x 特定组查询间隔（默认1s）。</p>
</blockquote>
<h2 id="IGMP-SSM-Mapping介绍"><a href="#IGMP-SSM-Mapping介绍" class="headerlink" title="IGMP SSM Mapping介绍"></a>IGMP SSM Mapping介绍</h2><h3 id="IGMP-SSM-Mapping介绍-1"><a href="#IGMP-SSM-Mapping介绍-1" class="headerlink" title="IGMP SSM Mapping介绍"></a>IGMP SSM Mapping介绍</h3><p>•现网中存在部分只能运行IGMPv1与IGMPv2的老旧终端，在部署SSM模式的组播时，由于IGMPv1与IGMPv2报文中无法携带组播源信息，因此无法使用SSM模式的组播网络。</p>
<p>•IGMP SSM Mapping通过静态的将组播源与组播组进行绑定，使得IGMPv1与IGMPv2的组成员也能接入SSM组播网络。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<h3 id="IGMP-SSM-Mapping工作原理"><a href="#IGMP-SSM-Mapping工作原理" class="headerlink" title="IGMP SSM Mapping工作原理"></a>IGMP SSM Mapping工作原理</h3><p>•在IGMP查询器上静态配置SSM地址的映射规则，将IGMPv1或IGMPv2成员关系报告中的<strong>组信息</strong>映射为<strong>源组信息</strong>。</p>
<p>•IGMP SSM Mapping工作原理如下：</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/29.png"></p>
<blockquote>
<p>•配置了SSM Mapping规则后，当IGMP查询器收到来自成员主机的IGMPv1或IGMPv2报告报文时，首先检查该报文中所携带的组播组地址G，然后根据检查结果的不同分别进行处理。</p>
<ul>
<li>如果G在ASM（Any-Source Multicast）范围内，则只提供ASM服务。</li>
<li>如果G在SSM组地址范围内（缺省情况下为232.0.0.0～232.255.255.255）：<ul>
<li>如果路由器上没有G对应的SSM Mapping规则，则无法提供SSM服务，丢弃该报文。</li>
<li>如果路由器上有G对应的SSM Mapping规则，则依据规则将报告报文中所包含的(*, G)信息映射为(G, INCLUDE, (S1, S2…))信息，提供SSM服务。</li>
</ul>
</li>
</ul>
<p>•IGMP SSM Mapping不处理IGMPv3的报告报文。为了保证同一网段运行任意版本IGMP的主机都能得到SSM服务，需要在与成员主机所在网段相连的组播路由器接口上运行IGMPv3。</p>
</blockquote>
<h2 id="IGMP代理介绍"><a href="#IGMP代理介绍" class="headerlink" title="IGMP代理介绍"></a>IGMP代理介绍</h2><h3 id="IGMP-Proxy介绍"><a href="#IGMP-Proxy介绍" class="headerlink" title="IGMP Proxy介绍"></a>IGMP Proxy介绍</h3><p>•现网中可能存在一台IGMP查询器需要管理大量组成员的情况，大量成员主机频繁加入/离开组播组时，会产生大量的IGMP成员关系报告/离开报文，从而给IGMP查询器带来较大的处理压力。</p>
<p>•通过IGMP Proxy功能可<strong>减少</strong>IGMP查询器接收<strong>IGMP成员关系报告/离开报文的数量</strong>，减轻IGMP查询器压力。</p>
<p>•IGMP Proxy通常被部署在IGMP查询器和成员主机之间的三层设备上。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/30.png"></p>
<h3 id="IGMP-Proxy基本概念"><a href="#IGMP-Proxy基本概念" class="headerlink" title="IGMP Proxy基本概念"></a>IGMP Proxy基本概念</h3><p>•为了缓解IGMP查询器压力，IGMP Proxy设备将成员关系报告/离开报文汇聚后统一上送给IGMP查询器。</p>
<p>•IGMP Proxy设备也可以代理IGMP查询器向成员主机发送查询报文，维护组成员关系，基于组成员关系进行组播转发。</p>
<p>•为了实现以上功能，IGMP Proxy定义了两类接口：</p>
<p>▫<strong>主机接口（Host Interface）</strong>：IGMP Proxy设备上配置IGMP Proxy功能的接口，该接口一般<strong>面向IGMP查询器</strong>。</p>
<p>▫<strong>路由器接口（Router Interface）</strong>：IGMP Proxy设备上配置IGMP功能的接口，该接口一般<strong>面向组成员</strong>。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/31.png"></p>
<h3 id="IGMP-Proxy工作机制-–-成员加组"><a href="#IGMP-Proxy工作机制-–-成员加组" class="headerlink" title="IGMP Proxy工作机制 – 成员加组"></a>IGMP Proxy工作机制 – 成员加组</h3><p>•IGMP Proxy减少成员关系报告报文的工作机制如下：</p>
<p>▫路由器接口作为IGMP接口，对下呈现为IGMP查询器，发送查询报文，处理成员关系报告报文，形成IGMP表项，并将成员关系报告<strong>从主机接口发送给上游的IGMP查询器</strong>。</p>
<p>▫当新用户<strong>加入同一个组播组</strong>时，IGMP Proxy设备<strong>不会再向IGMP查询器反馈成员关系报告报文</strong>，因此减少了成员关系报告报文数量。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/32.png"></p>
<blockquote>
<p>•IGMP代理设备收到某组播组的报告报文后，会在IGMP组表项中查找该组播组：</p>
<ul>
<li><p>如果没有找到相应的组播组，IGMP代理设备会向接入设备发送针对该组播组的报告报文，并在组播转发表中添加该组播组；</p>
</li>
<li><p>如果找到相应的组播组，IGMP代理设备就不需要向接入设备发送报告报文。</p>
</li>
</ul>
<p>•IGMPv1/IGMPv2/IGMPv3成员加组机制不再赘述</p>
</blockquote>
<h3 id="IGMP-Proxy工作机制-–-成员离组"><a href="#IGMP-Proxy工作机制-–-成员离组" class="headerlink" title="IGMP Proxy工作机制 – 成员离组"></a>IGMP Proxy工作机制 – 成员离组</h3><p>•IGMP Proxy减少离组报文的工作机制如下：</p>
<p>▫当组成员离开时，IGMP Proxy通过IGMP离组机制确定是否有特定组播组的组成员，当<strong>确定已经没有组成员</strong>后才<strong>发送离开报文</strong>给上游IGMP查询器。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/33.png"></p>
<blockquote>
<p>•IGMP代理设备收到某组播组G1的离开报文后，会向接收到该离开报文的接口发送一个特定组查询报文，检查该接口下是否还存在组播组G1的其他成员：</p>
<ul>
<li><p>如果没有其他成员，在组播转发表中将该接口删除，然后判断组播组G1是否还有其他接口。</p>
<ul>
<li>如果没有，IGMP代理设备再会向接入设备发送针对该组播组的离开报文；</li>
<li>如果有，IGMP代理设备不向接入设备发送针对该组播组的离开报文；</li>
</ul>
</li>
<li><p>如果有其他成员，IGMP代理设备会继续向该接口转发组播数据。</p>
</li>
</ul>
<p>•IGMPv1/IGMPv2/IGMPv3成员离组机制不再赘述。</p>
</blockquote>
<h1 id="3-IGMP配置"><a href="#3-IGMP配置" class="headerlink" title="3.IGMP配置"></a>3.IGMP配置</h1><h2 id="IGMP协议的基本配置"><a href="#IGMP协议的基本配置" class="headerlink" title="IGMP协议的基本配置"></a>IGMP协议的基本配置</h2><p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/34.png"></p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/35.png"></p>
<h2 id="IGMP基础实验"><a href="#IGMP基础实验" class="headerlink" title="IGMP基础实验"></a>IGMP基础实验</h2><p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/36.png"></p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/37.png"></p>
<h3 id="IGMP配置验证"><a href="#IGMP配置验证" class="headerlink" title="IGMP配置验证"></a>IGMP配置验证</h3><p>在路由器RTA上查看查看接口的IGMP配置和运行信息。</p>
<p><img src="/2021/05/17/IP-IGMP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/38.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）在IGMPv1中，当最后一个组播成员离开后该组后，组播路由器将在多长时间后删除所对应的组播转发表项？</p>
<p><strong>60*2 + 10 = 130s。</strong></p>
<p>2.（简答题）在IGMPv2中，特定组查询的目的IP是224.0.0.1吗？</p>
<p><strong>否，特定组查询的目的IP是所查询组播组的组播IP地址。</strong></p>
<p>3.（单选题）IGMP协议支持哪些版本？</p>
<p>A. IGMPv1、IGMPv2</p>
<p>B. IGMPv3</p>
<p>C. IGMPv2、IGMPv3</p>
<p><strong>D. IGMPv1、IGMPv2、IGMPv3</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•IGMP的主要作用是让组播网络感知组播组成员的位置和所加组播组，同时也能维护组成员的加组状态。</p>
<p>•IGMP有三种版本：</p>
<ul>
<li>IGMPv1：有基本的加组机制，但是组成员离开机制较为落后，同时没有独立的IGMP查询器选举机制。</li>
<li>IGMPv2：在IGMPv1的基础上改善了组成员离开机制，同时拥有了独立的IGMP查询器选举机制。</li>
<li>IGMPv3：在IGMPv2的基础上增加了对SSM组播的支持能力，可以告知组播网络需要接收来自哪个组播源的组播数据。</li>
</ul>
<p>•IGMP有诸多特性帮助IGMP在网络中高效运行：</p>
<ul>
<li><p>IGMP Snooping：解决在以太网络中组播数据跨组播组泛洪的问题。</p>
</li>
<li><p>IGMP SSM Mapping：解决IGMPv1与IGMPv2组成员不能接入SSM组播网络的问题。</p>
</li>
<li><p>IGMP Proxy：解决大量组播组成员频繁上下线导致，IGMP查询器压力过大的问题。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/" itemprop="url">IP-IP组播基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T11:18:10+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•网络中存在各种各样的业务，从流量模型看一般可以将业务分为两类：</p>
<p>▫点到点业务：比如FTP，WEB业务，此类业务主要特点是不同的用户有不同的需求，比如用户A需要下载资料A，用户B需要下载资料B。此类业务一般由单播承载，服务器对于不同用户发送不同的点到点数据流。</p>
<p>▫点到多点业务：比如IPTV，视频会议等，此类业务的特点是用户对于业务有相同的需求，比如用户A，B，C，D都需要收看视频X，此类业务可以使用单播，组播，广播承载。但使用单播或广播承载点到多点业务时存在一定问题。</p>
<p>▫组播技术能够较好的解决单播或广播在承载点到多点业务时存在的问题。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述组播的定义及组播的地址结构</p>
<p>▫描述组播数据的转发原理</p>
<p>▫描述反向路径转发的原理</p>
<h1 id="1-IP组播基本概念"><a href="#1-IP组播基本概念" class="headerlink" title="1.IP组播基本概念"></a>1.IP组播基本概念</h1><h2 id="点到多点业务的困境"><a href="#点到多点业务的困境" class="headerlink" title="点到多点业务的困境"></a>点到多点业务的困境</h2><p>点到多点业务可以由单播，组播，广播进行承载，现网中也有各种各样的实现方式。但使用单播或者广播承载点到多点业务时存在一些固有的问题。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/1.png"></p>
<blockquote>
<p>•单播（Unicast）是在一台源IP主机和一台目的IP主机之间进行。网络上绝大部分的数据都是以单播的形式传输的，例如电子邮件收发、网上银行都是采用单播实现的。</p>
<ul>
<li>在单播通信中每一个数据包都有确切的目的IP地址；对于同一份数据，如果存在多个接收者，Server需发送与接收者数目相同的单播数据包；当接收者增加到成百上千时，将极大加重Server创建相同数据和发送多份相同拷贝后所产生的消耗，网络中的设备性能及链路带宽都会面临一定程度的浪费；单播方式较适合用户稀少的网络，当用户量较大时很难保证网络传输质量。</li>
</ul>
<p>•广播（Broadcast）是在一台源IP主机和网络中所有其它的IP主机之间进行，属于一对所有的通讯方式，所有主机都可以接收到（不管是否需要）。</p>
<ul>
<li>广播数据包被限制在广播域中；一旦有设备发送广播数据，则广播域内所有设备都会收到这个数据包，并且不得不耗费资源去处理，大量的广播数据包将消耗网络的带宽及设备资源；广播方式只适合共享网段，且信息安全性和有偿服务得不到保障。</li>
</ul>
</blockquote>
<h2 id="使用组播承载点到多点业务"><a href="#使用组播承载点到多点业务" class="headerlink" title="使用组播承载点到多点业务"></a>使用组播承载点到多点业务</h2><p>•组播方式下，单一的信息流沿组播分发树被同时发送给一组用户，相同的组播数据流在每一条链路上最多仅有一份。相比单播和广播，使用组播的好处如下：</p>
<p>▫相比单播，用户的增加不会导致信息源负载的加重，不会导致网络资源消耗的显著增加。</p>
<p>▫相比广播，不会造成网络资源的浪费，并能提高信息传输的安全性，而且组播可以实现跨网段的传输。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/2.png"></p>
<blockquote>
<p>•组播（Multicast）是在一台源IP主机和多台（一组）IP主机之间进行，中间的网络设备根据接收者的需要，有选择性地对数据进行复制和转发。</p>
<p>•组播技术有效地满足了单点发送、多点接收的需求，实现了IP网络中点到多点业务数据的高效传送，能够大量节约网络带宽、降低网络负载。</p>
<p>•组播分发树：组播流量的转发路径。</p>
</blockquote>
<h2 id="组播数据报文结构"><a href="#组播数据报文结构" class="headerlink" title="组播数据报文结构"></a>组播数据报文结构</h2><p>•组播数据报文的结构与单播报文类似，但组播数据报文的目的MAC地址与目的IP地址与单播报文有很大差异。</p>
<p>​    ▫组播目的IP地址：目的IP地址为组播IP地址，地址范围从224.0.0.0到239.255.255.255</p>
<p>​    ▫组播目的MAC地址：目的MAC地址为组播MAC地址，组播MAC地址由组播IP地址映射而来</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/3.png"></p>
<h2 id="组播IP地址"><a href="#组播IP地址" class="headerlink" title="组播IP地址"></a>组播IP地址</h2><p>•在IPv4地址空间中，D类地址（224.0.0.0/4）被用于组播。一个组播地址就表示一个点到多点的数据流，比如IPTV数据流，语音会议数据流。</p>
<p>•大多数情况下，同一个组播网络里不同的业务（比如，IPTV，语音会议）就需要使用不同的组播IP地址。</p>
<p>•IANA对D类地址做了进一步的定义，几种主要的组播地址如下表所示：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/4.png"></p>
<blockquote>
<p>•IPv4组播地址：</p>
<p>▫IPv4地址空间分为五类，即A类、B类、C类、D类和E类。D类地址为IPv4组播地址，范围是从224.0.0.0到239.255.255.255，用于标识组播组，且仅能作为组播报文的目的地址使用，不能作为源地址使用。</p>
<p>▫IPv4组播报文的源地址字段为IPv4单播地址，可使用A、B或C类地址，不能是D类、E类地址。</p>
<p>▫在网络层上，加入同一组播组的所有用户主机能够识别同一个IPv4组播组地址。一旦网络中某用户加入该组播组，则此用户就能接收以该组地址为目的地址的IP组播报文。</p>
</blockquote>
<h2 id="组播MAC地址"><a href="#组播MAC地址" class="headerlink" title="组播MAC地址"></a>组播MAC地址</h2><p>•以太网传输IPv4单播报文的时候，目的MAC地址使用的是接收者的MAC地址。但是在传输组播数据时，其目的地不再是一个具体的接收者，而是一个成员不确定的组，所以要使用IPv4组播MAC地址。</p>
<p>•IANA规定，IPv4组播MAC地址的高24位为0x01005e，第25位为0，低23位为IPv4组播地址的低23位，例如组播组地址224.0.1.1对应的组播MAC地址为01-00-5e-00-01-01。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/5.png"></p>
<blockquote>
<p>•IPv4组播地址的前4位是固定的1110，对应组播MAC地址的高25位，后28位中只有23位被映射到MAC地址，因此丢失了5位的地址信息，直接结果是有32个IPv4组播地址映射到同一MAC地址上。例如IP地址为224.0.1.1、224.128.1.1、225.0.1.1、239.128.1.1等组播组的组播MAC地址都为01-00-5e-00-01-01。网络管理员在分配地址时必须考虑这种情况。</p>
<p>•IETF认为同一个局域网中两个或多个组地址生成相同的MAC地址的几率非常低，不会造成太大的影响。</p>
<p>•组播MAC地址标识了一组设备，这种MAC地址第1个字节的最低比特位为1，例如0100-5e-00ab。</p>
<p>•一个组播MAC地址所标识的一组设备有着共同的特点，那就是它们都加入了相同的组播组，这些设备将会侦听目的MAC地址为该组播MAC地址的数据帧。只有单播MAC地址才能够被分配给一个以太网接口，组播或广播MAC地址是不能被分配给任何一个以太网接口的，换句话说，这两种类型的MAC地址不能作为数据帧的源MAC地址，而只能作为目的MAC地址。</p>
<p>•对于组播MAC地址，相信大家并不会太陌生，例如STP协议的BPDU载荷便是被直接封装在以太网数据帧中的，并且数据帧的目的MAC地址为0180-c200-0000，这就是一个组播MAC地址，类似这样的例子还有很多，此处不再一一列举，这些组播MAC地址并不与组播IP地址存在关联。</p>
<p>•除此之外，还有一类组播MAC地址是我们需要格外关注的，那就是与组播IP地址存在映射关系的组播MAC地址。本课程介绍的组播MAC地址对应该类型。</p>
</blockquote>
<h2 id="组播网络基本架构"><a href="#组播网络基本架构" class="headerlink" title="组播网络基本架构"></a>组播网络基本架构</h2><p>•组播网络大体可以分为三个部分：</p>
<p>▫源端网络：将组播源产生的组播数据发送至组播网络。</p>
<p>▫组播转发网络：形成无环的组播转发路径，该转发路径也被称为组播分发树（Multicast Distribution Tree）。</p>
<p>▫成员端网络：让组播网络感知组播组成员位置与加入的组播组。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/6.png"></p>
<blockquote>
<p>•组播源（Source）：组播流量的发送者，例如多媒体服务器。组播源无需运行任何组播协议，只需简单 地将组播数据发送出来即可。 </p>
<p>•组播接收者（Receiver）：也被称为组播组成员，是期望接收特定组播组流量的设备，例如运行多媒体 直播客户端软件的PC。</p>
<p>•组播组（Multicast Group）：用IP组播地址进行标识的一个集合。任何用户主机（或其他接收设备），加入一个组播组，就成为了该组成员，可以识别并接收发往该组播组的组播数据。</p>
<p>•组播路由器（Multicast Router）：支持组播、运行组播协议的网络设备，实际上不仅仅路由器能够支持 组播，交换机、防火墙等设备也能够支持组播（取决于设备型号），路由器仅是一个代表。</p>
<p>•第一跳路由器（First-Hop Router）：组播转发路径上，与组播源相连且负责转发该组播源发出的组播数据的PIM路由器。</p>
<p>•最后一跳路由器（Last-Hop Router）：组播转发路径上，与组播组成员相连且负责向该组成员转发组播数据的PIM路由器。</p>
<p>•IGMP（Internet Group Management Protocol，因特网组管理协议），是TCP/IP协议族中负责IP组播成员管理的协议，它用来在接收者和与其直接相邻的组播路由器之间建立、维护组播组成员关系。</p>
</blockquote>
<h2 id="组播服务模型"><a href="#组播服务模型" class="headerlink" title="组播服务模型"></a>组播服务模型</h2><p>•组播组成员在接收组播数据时可以对于组播数据源进行选择，因此产生了ASM（Any-Source Multicast，任意源组播）和SSM（Source-Specific Multicast，指定源组播）两种组播服务模型。</p>
<p>▫ASM：组成员加入组播组以后，组成员可以接收到任意源发送到该组的数据。</p>
<p>▫SSM：组成员加入组播组以后，组成员只会收到指定源发送到该组的数据。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/7.png"></p>
<blockquote>
<p>•ASM特点：</p>
<p>▫ASM为了提高安全性，可以在路由器上配置针对组播源的过滤策略，允许或禁止来自某些组播源的报文通过。最终从接收者角度看，数据是经过筛选的。</p>
<p>▫ASM模型要求组地址必须整个组播网络中唯一。“唯一”指的是同一时刻一个ASM地址只能被一种组播应用使用。如果有两种不同的应用程序使用了同一个ASM组地址发送数据，它们的接收者会同时收到来自两个源的数据。这样一方面会导致网络流量拥塞，另一方面也会给接收者主机造成困扰。</p>
<p>•SSM特点：</p>
<p>▫SSM模型对组地址不再要求全网唯一，只需要每个组播源保持唯一。这里的“唯一”指的是同一个源上不同的组播应用必须使用不同的SSM地址来区分。不同的源之间可以使用相同的组地址，因为SSM模型中针对每一个（源，组）信息都会生成表项。这样一方面节省了组播组地址，另一方面也不会造成网络拥塞。</p>
</blockquote>
<h1 id="2-组播数据转发原理"><a href="#2-组播数据转发原理" class="headerlink" title="2.组播数据转发原理"></a>2.组播数据转发原理</h1><h2 id="组播数据转发的困局"><a href="#组播数据转发的困局" class="headerlink" title="组播数据转发的困局"></a>组播数据转发的困局</h2><p>组播数据转发需要依赖路由表项。但是基于目的网络的路由表在转发组播数据时存在一定问题：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/8.png"></p>
<h2 id="组播路由与RPF检查"><a href="#组播路由与RPF检查" class="headerlink" title="组播路由与RPF检查"></a>组播路由与RPF检查</h2><p>•由于组播转发容易产生环路，次优，重复报文，所以组播路由表项除了目的网络和出接口外还需要添加组播源和入接口的信息。设备仅转发从特定唯一的入接口收到的组播数据，从而避免组播转发时产生环路，次优，重复报文（部分解决）等问题。</p>
<p>•对于相同的组播源，设备通过RPF（Reverse Path Forwarding，反向路径转发）检查可以确定设备上唯一的组播流量入接口。</p>
<p>•组播路由表项以及与RPF检查的关系如下：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/9.png"></p>
<blockquote>
<p>•组播路由表项出接口一般需要通过组播路由协议确定。</p>
<p>•组播路由协议将在《PIM原理与配置》课程介绍。</p>
<p>•组播路由表项包含组播源与组播组，因此有事又被称为（S，G）表项。</p>
</blockquote>
<h2 id="RPF检查工作原理"><a href="#RPF检查工作原理" class="headerlink" title="RPF检查工作原理"></a>RPF检查工作原理</h2><p>•RPF检查过程如下：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/10.png"></p>
<blockquote>
<p>•组播路由器根据报文的源地址通过路由表（单播路由表、MBGP路由表或组播静态路由表）查找到达“报文源”的路由，查看到“报文源”的路由表项的出接口是否与收到组播报文的入接口一致。如果一致，则认为该组播报文从正确的接口到达，从而保证了整个转发路径的正确性和唯一性。这个过程就被称为RPF检查。</p>
</blockquote>
<h2 id="RPF路由选举规则"><a href="#RPF路由选举规则" class="headerlink" title="RPF路由选举规则"></a>RPF路由选举规则</h2><p>RPF路由可以从单播路由、MBGP路由、组播静态路由中选举产生。当路由器收到一份组播报文后，如果这三种路由表都存在，具体检查过程如下：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/11.png"></p>
<blockquote>
<p>•根据以下原则从这三条最优路由中选择一条作为RPF路由：</p>
<ul>
<li><p>如果配置了按照最长匹配选择路由，则从这三条路由中选出最长匹配的那条路由；</p>
</li>
<li><p>如果这三条路由的掩码一样，则选择优先级最高的那条路由；</p>
</li>
<li><p>如果它们的优先级也相同，则按照组播静态路由、MBGP路由、单播路由的顺序进行选择。</p>
</li>
</ul>
<p>•MBGP：</p>
<ul>
<li>MBGP（Multicast BGP，组播BGP）主要用于传递组播源相关的路由条目。</li>
</ul>
<p>•组播静态路由表：</p>
<ul>
<li>手工配置组播源与出接口的对应关系。</li>
</ul>
</blockquote>
<h2 id="组播分发树"><a href="#组播分发树" class="headerlink" title="组播分发树"></a>组播分发树</h2><p>•组播数据转发需要保证转发路径无环，无次优路径且无重复包。</p>
<p>•通过RPF机制与组播路由协议，组播网络可以最终形成无环、无次优且无重复包的组播转发路径，该路径可以被称为<strong>组播分发树</strong>。</p>
<p>•组播分发树以<strong>组播源为根</strong>，<strong>以组成员为叶子</strong>形成转发路径，组播数据在转发时都基于组播分发树进行转发。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/12.png"></p>
<h2 id="组播数据转发流程"><a href="#组播数据转发流程" class="headerlink" title="组播数据转发流程"></a>组播数据转发流程</h2><p>组播数据转发基本流程如下：</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/13.png"></p>
<blockquote>
<p>•组播路由表项出接口与组播转发路径由组播路由协议决定。</p>
<p>​    ▫组播路由协议主要有：PIM，MBGP，MSDP。</p>
<p>​    ▫关于组播路由协议的内容将在《PIM原理与配置》课程讲解。</p>
<p>•组播组成员位置由IGMP通告。</p>
<p>​    ▫关于IGMP的内容将在《IGMP原理与配置》课程讲解。</p>
</blockquote>
<h2 id="组播协议介绍"><a href="#组播协议介绍" class="headerlink" title="组播协议介绍"></a>组播协议介绍</h2><p>•组播网络需要基于多种组播协议才能建立转发路径：</p>
<p>▫工作在成员端网络的主要是IGMP（Internet Group Management Protocol，因特网组管理协议）协议，用于<strong>告知组播网络，组成员的位置与所加组播组。</strong></p>
<p>▫工作在组播转发网络的协议主要有PIM，MSDP，MBGP。</p>
<p>▪PIM（Protocol Independent Multicast，协议无关组播）协议主要作用是<strong>生成AS域内的组播分发树</strong>。</p>
<p>▪MSDP（Multicast Source Discovery Protocol，组播源发现协议）主要作用是<strong>帮助生成AS域间的组播分发树</strong>。</p>
<p>▪MBGP（Multicast BGP，组播BGP）主要作用是帮助<strong>跨域组播流进行RPF校验</strong>。</p>
<p><img src="/2021/05/17/IP-IP%E7%BB%84%E6%92%AD%E5%9F%BA%E7%A1%80/14.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）IPv4组播地址的范围是什么？</p>
<p>A.192.168.0.0~192.168.255.255</p>
<p>B.172.21.0.0~172.21.255.255</p>
<p><strong>C.224.0.0.0~239.255.255.255</strong></p>
<p>D.240.0.0.0~255.255.255.255</p>
<blockquote>
<p>IANA（Internet Assigned Numbers Authority，互联网编号分配委员会）将D类地址空间分配给IPv4组播使用。IPv4地址一共32位，D类地址最高4位为1110，因此地址范围从224.0.0.0到239.255.255.255。</p>
</blockquote>
<p>2.（多选题）下面描述RPF作用正确的是？</p>
<p><strong>A. 避免重复的组播报文</strong></p>
<p>B. 加速组播流量转发速度</p>
<p><strong>C. 防环</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•组播主要解决单播或广播在承载点到多点流量时存在的问题：</p>
<ul>
<li><p>使用单播承载点到多点流量时，随着点到多点业务客户端的增加，可能会引起带宽占用过高或源服务器压力过大等问题。</p>
</li>
<li><p>使用广播承载点到多点流量时，虽然不存在单播承载点到多点流量时的问题，但缺乏安全性。</p>
</li>
</ul>
<p>•组播网络一般由三部分组成：源端网络，组播转发网络，成员端网络。</p>
<ul>
<li>组播转发网络负责组播数据在组播路由器之间转发，但是在转发过程中可能存在环路，次优路径，重复报文等问题。这些问题可以通过RPF检查部分或全部解决。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/" itemprop="url">IP-交换机堆叠与集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T11:17:56+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•随着企业的发展，企业网络的规模越来越大，这对企业网络提出了更高的要求：更高的可靠性、更低的故障恢复时间、设备更加易于管理等。</p>
<p>•传统的园区网高可靠性技术出现故障时切换时间很难做到毫秒级别、实现可靠性的方案通常为一主一备，存在着严重的资源浪费。同时随着网络设备的越来越多，管理将会变得越加复杂。为构建可靠、易管理、资源利用率高、易于扩展的交换网络，引入了交换机堆叠、集群技术。</p>
<p>•本章节中将介绍交换机堆叠、集群技术的技术原理、组网方式等。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述交换机堆叠、集群的基本概念</p>
<p>▫阐述堆叠、集群的建立过程</p>
<p>▫阐述堆叠、集群的分裂检测技术原理</p>
<h1 id="1-堆叠、集群技术概述"><a href="#1-堆叠、集群技术概述" class="headerlink" title="1.堆叠、集群技术概述"></a>1.堆叠、集群技术概述</h1><h2 id="堆叠、集群简介"><a href="#堆叠、集群简介" class="headerlink" title="堆叠、集群简介"></a>堆叠、集群简介</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/1.png"></p>
<blockquote>
<p>•堆叠（iStack），将多台支持堆叠特性的交换机通过堆叠线缆连接在一起，从逻辑上虚拟成一台交换设备，作为一个整体参与数据转发。</p>
<p>•集群（Cluster Switch System，CSS），将两台支持集群特性的交换机设备组合在一起，从逻辑上虚拟成一台交换设备。</p>
<p>•集群只支持两台设备，一般高端框式交换机支持CSS、盒式设备支持iStack。</p>
<p>•通过使用堆叠、集群技术结合链路聚合技术可以简单构建高可靠、无环的园区网络。</p>
</blockquote>
<h2 id="堆叠、集群架构"><a href="#堆叠、集群架构" class="headerlink" title="堆叠、集群架构"></a>堆叠、集群架构</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/2.png"></p>
<p>•使用堆叠、集群技术将独立的交换机虚拟化成一台逻辑的交换机，一般接入、汇聚层盒式交换机采用堆叠技术，汇聚、核心层交换机采用集群技术。</p>
<p>•在逻辑交换机之间使用链路聚合技术，无需部署STP、VRRP实现高可靠性。</p>
<p>•实现高可靠性的同时设备之间的链路可以同时传输流量，链路利用率得以提升。</p>
<h2 id="堆叠、集群的优势-1"><a href="#堆叠、集群的优势-1" class="headerlink" title="堆叠、集群的优势 (1)"></a>堆叠、集群的优势 (1)</h2><p>使用堆叠、集群可有效提高资源利用率，获得更高的转发性能、链路带宽。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/3.png"></p>
<h2 id="堆叠、集群的优势-2"><a href="#堆叠、集群的优势-2" class="headerlink" title="堆叠、集群的优势 (2)"></a>堆叠、集群的优势 (2)</h2><p>使用堆叠、集群可以降低网络规划的复杂度，方便对于网络的管理。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/4.png"></p>
<h2 id="堆叠、集群的优势-3"><a href="#堆叠、集群的优势-3" class="headerlink" title="堆叠、集群的优势 (3)"></a>堆叠、集群的优势 (3)</h2><p>使用堆叠、集群可以大大降低故障导致的业务中断时间。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/5.png"></p>
<h1 id="2-堆叠技术原理"><a href="#2-堆叠技术原理" class="headerlink" title="2.堆叠技术原理"></a>2.堆叠技术原理</h1><h2 id="堆叠基本概念"><a href="#堆叠基本概念" class="headerlink" title="堆叠基本概念"></a>堆叠基本概念</h2><p>•堆叠系统中所有的单台交换机都称为成员交换机，按照功能不同，可以分为三种角色：</p>
<ul>
<li><p>主交换机（Master）：主交换机负责管理整个堆叠。堆叠系统中只有一台主交换机。</p>
</li>
<li><p>备交换机（Standby）：备交换机是主交换机的备份交换机。堆叠系统中只有一台备交换机。当主交换机故障时，备交换机会接替原主交换机的所有业务。</p>
</li>
<li><p>从交换机（Slave）：从交换机用于业务转发，堆叠系统中可以有多台从交换机。从交换机数量越多，堆叠系统的转发带宽越大。除主交换机和备交换机外，堆叠中其他所有的成员交换机都是从交换机。当备交换机不可用时，从交换机承担备交换机的角色。</p>
</li>
</ul>
<p>•堆叠优先级：堆叠优先级是成员交换机的一个属性，主要用于角色选举过程中确定成员交换机的角色，优先级值越大表示优先级越高，优先级越高当选为主交换机的可能性越大。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/6.png"></p>
<h2 id="堆叠ID"><a href="#堆叠ID" class="headerlink" title="堆叠ID"></a>堆叠ID</h2><p>•堆叠ID，即成员交换机的槽位号（Slot ID），用来标识和管理成员交换机，堆叠中所有成员交换机的堆叠ID都是唯一的。</p>
<p>•设备堆叠ID缺省为0。堆叠时由堆叠主交换机对设备的堆叠ID进行管理，当堆叠系统有新成员加入时，如果新成员与已有成员堆叠ID冲突，则堆叠主交换机从0～最大的堆叠ID进行遍历，找到第一个空闲的ID分配给该新成员。</p>
<p>•在建立堆叠时，建议提前规划好设备的堆叠ID。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/7.png"></p>
<h2 id="堆叠逻辑接口"><a href="#堆叠逻辑接口" class="headerlink" title="堆叠逻辑接口"></a>堆叠逻辑接口</h2><p>•堆叠逻辑接口：交换机之间用于建立堆叠的逻辑接口，每台交换机支持两个逻辑堆叠端口，分别为stack-port n/1和stack-port n/2，其中n为成员交换机的堆叠ID。</p>
<p>•一个逻辑堆叠端口可以绑定多个物理成员端口，用来提高堆叠的可靠性和堆叠带宽。</p>
<p>•堆叠成员设备之间，本端设备的逻辑堆叠端口stack-port n/1必须与对端设备的逻辑堆叠端口stack-port m/2相连。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/8.png"></p>
<blockquote>
<p>•如果两端设备对应的逻辑堆叠端口（本端的stack-port n/1与对端的stack-port m/2）内包含多个物理成员端口，对物理成员端口的连接无对应端口号的要求。</p>
</blockquote>
<h2 id="堆叠系统组建过程"><a href="#堆叠系统组建过程" class="headerlink" title="堆叠系统组建过程"></a>堆叠系统组建过程</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/9.png"></p>
<h2 id="堆叠方式"><a href="#堆叠方式" class="headerlink" title="堆叠方式"></a>堆叠方式</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/10.png"></p>
<blockquote>
<p>•每台交换机支持两个逻辑堆叠端口，分别为stack-port n/1和stack-port n/2，其中n为成员交换机的堆叠ID。</p>
</blockquote>
<h2 id="堆叠连接拓扑"><a href="#堆叠连接拓扑" class="headerlink" title="堆叠连接拓扑"></a>堆叠连接拓扑</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/11.png"></p>
<h2 id="主交换机选举"><a href="#主交换机选举" class="headerlink" title="主交换机选举"></a>主交换机选举</h2><p>•确定出堆叠的连接方式和连接拓扑，完成成员交换机之间的物理连接之后，所有成员交换机上电。此时，堆叠系统开始进行主交换机的选举。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/12.png"></p>
<h2 id="备交换机选举"><a href="#备交换机选举" class="headerlink" title="备交换机选举"></a>备交换机选举</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/13.png"></p>
<h2 id="软件、配置同步"><a href="#软件、配置同步" class="headerlink" title="软件、配置同步"></a>软件、配置同步</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/14.png"></p>
<h2 id="堆叠管理与配置文件"><a href="#堆叠管理与配置文件" class="headerlink" title="堆叠管理与配置文件"></a>堆叠管理与配置文件</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/15.png"></p>
<blockquote>
<p>•堆叠系统的配置文件包括：</p>
<p>​    ▫全局配置：例如IP地址、STP、VLAN、SNMP等，适用于所有堆叠成员交换机。新加入堆叠系统的交换机使用堆叠系统的全局配置，不再使用交换机自己的全局配置。交换机离开堆叠系统时，将继续使用堆叠系统的配置直到加入新的堆叠系统。</p>
<p>​    ▫接口配置：适用于接口所在成员交换机。接口上的配置和堆叠ID有关，当堆叠ID改变时：</p>
<p>▪如果新ID在配置文件中不存在对应的接口配置，则新ID的接口配置使用默认配置。</p>
<p>▪如果新ID在配置文件中存在对应的接口配置，则新ID的接口配置使用对应的配置。</p>
<p>•堆叠相关配置不会丢失，即从设备离开堆叠之后，堆叠相关配置仍会继续存在，同样会进行堆叠的选举，如果需要彻底清除堆叠配置需要通过命令手动清除，清除的配置内容包括：</p>
<p>​    ▫交换机槽位号</p>
<p>​    ▫堆叠优先级</p>
<p>​    ▫堆叠保留VLAN</p>
<p>​    ▫系统MAC切换时间</p>
<p>​    ▫堆叠口配置</p>
<p>​    ▫堆叠口速率配置</p>
<p>​    执行该命令会导致设备重启</p>
</blockquote>
<h2 id="堆叠成员退出"><a href="#堆叠成员退出" class="headerlink" title="堆叠成员退出"></a>堆叠成员退出</h2><p>堆叠成员退出是指成员交换机从堆叠系统中离开。根据退出成员交换机角色的不同，对堆叠系统的影响也有所不同：</p>
<p>▫当主交换机退出，备份交换机升级为主交换机，重新计算堆叠拓扑并同步到其他成员交换机，指定新的备交换机，之后进入稳定运行状态。</p>
<p>▫当备交换机退出，主交换机重新指定备交换机，重新计算堆叠拓扑并同步到其他成员交换机，之后进入稳定运行状态。</p>
<p>▫当从交换机退出，主交换机重新计算堆叠拓扑并同步到其他成员交换机，之后进入稳定运行状态。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/16.png"></p>
<blockquote>
<p>•堆叠成员交换机退出的过程，主要就是拆除堆叠线缆和移除交换机的过程：</p>
<ul>
<li><p>对于环形堆叠：成员交换机退出后，为保证网络的可靠性还需要把退出交换机连接的两个端口通过堆叠线缆进行连接。</p>
</li>
<li><p>对于链形堆叠：拆除中间交换机会造成堆叠分裂。这时需要在拆除前进行业务分析，尽量减少对业务的影响。</p>
</li>
</ul>
</blockquote>
<h2 id="堆叠成员加入"><a href="#堆叠成员加入" class="headerlink" title="堆叠成员加入"></a>堆叠成员加入</h2><p>堆叠成员加入是指向已经稳定运行的堆叠系统添加一台新的交换机：</p>
<p>▫将未上电的交换机连线加入堆叠之后再上电启动，新加入的交换机会选举为从交换机，堆叠系统中原有主备从角色不变。</p>
<p>▫角色选举结束后，主交换机更新堆叠拓扑信息，同步到其他成员交换机上，并向新加入的交换机分配堆叠ID（新加入的交换机没有配置堆叠ID或配置的堆叠ID与原堆叠系统的冲突时）。</p>
<p>▫新加入的交换机更新堆叠ID，并同步主交换机的配置文件和系统软件，之后进入稳定运行状态。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/17.png"></p>
<blockquote>
<p>•未上电的交换机加入堆叠：</p>
<p>​    ▫如果是链形连接，新加入的交换机建议添加到链形的两端，这样对现有的业务影响最小。</p>
<p>​    ▫如果是环形连接，需要把当前环形拆成链形，然后在链形的两端添加设备。</p>
</blockquote>
<h2 id="堆叠合并"><a href="#堆叠合并" class="headerlink" title="堆叠合并"></a>堆叠合并</h2><p>•堆叠合并是指稳定运行的两个堆叠系统合并成一个新的堆叠系统。</p>
<p>•例如：已上电的一台交换机并且配置了堆叠（已形成单机堆叠），通过堆叠线缆与已经在运行的堆叠系统连接。该过程为堆叠合并，与堆叠加入不同。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/18.png"></p>
<blockquote>
<p>•单机堆叠：单机堆叠就是一台交换机使能了堆叠功能，整个堆叠系统中只有一台主交换机。只有使能了堆叠功能的交换机才可以加入堆叠系统或与其他使能了堆叠功能的交换机组建堆叠。</p>
<p>•堆叠合并过程如下：</p>
<p>▫两个堆叠系统的主交换机通过竞争，选举出一个更优的作为新堆叠系统的主交换机。</p>
<p>▫竞争成功的主交换机所在的堆叠系统将保持原有主备从角色和配置不变，业务也不会受到影响</p>
<p>▫而另外一个堆叠系统的所有成员交换机将重新启动，以从交换机的角色加入到新堆叠系统，其堆叠ID将由新主交换机重新分配，并将同步新主交换机的配置文件和系统软件，该堆叠系统的原有业务也将中断。</p>
</blockquote>
<h2 id="堆叠分裂"><a href="#堆叠分裂" class="headerlink" title="堆叠分裂"></a>堆叠分裂</h2><p>堆叠分裂是指稳定运行的堆叠系统中带电移出部分成员交换机，或者堆叠线缆多点故障导致一个堆叠系统变成多个堆叠系统。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/19.png"></p>
<h2 id="堆叠分裂引起的问题"><a href="#堆叠分裂引起的问题" class="headerlink" title="堆叠分裂引起的问题"></a>堆叠分裂引起的问题</h2><p>由于堆叠系统中所有成员交换机都使用同一个IP地址（VLANIF接口地址）和MAC地址（堆叠系统MAC），一个堆叠系统分裂后，可能产生多个具有相同IP地址和MAC地址的堆叠系统，从而引起网络故障，为此必须进行IP地址和MAC地址的冲突检查。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/20.png"></p>
<blockquote>
<p> •堆叠系统作为一台设备与网络中其他设备通信，具有唯一的MAC地址，称为堆叠系统MAC地址。通常情况下使用主交换机的MAC地址作为堆叠系统MAC地址。</p>
<p>•当堆叠系统的MAC地址是主交换机的MAC地址，主交换机故障或者离开堆叠系统，在默认情况下堆叠系统MAC地址会延时10分钟切换，即在10分钟内两个分裂的堆叠系统的MAC相同。</p>
</blockquote>
<h2 id="MAD"><a href="#MAD" class="headerlink" title="MAD"></a>MAD</h2><p>•多主检测MAD（Multi-Active Detection）：一种检测和处理堆叠分裂的协议，链路故障导致堆叠系统分裂后，MAD可以实现堆叠分裂的检测、冲突处理和故障恢复，降低堆叠分裂对业务的影响。</p>
<p>•MAD检测方式有两种：直连检测方式和代理检测方式。在同一个堆叠系统中，两种检测方式互斥，不可以同时配置。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/21.png"></p>
<blockquote>
<p>•分裂后的堆叠系统通过MAD检测线缆（普通线缆，手动配置为MAD检测链路）发送MAD检测报文进行竞选，竞选失败的堆叠系统会关闭所有的物理端口（手动配置的保留端口除外）以保证不会因IP、MAC冲突对业务产生影响。</p>
<p>•MAD检测过程如下：</p>
<p>▫堆叠分裂之后，分裂后的堆叠系统存在相同的IP地址、MAC地址（堆叠系统MAC），将会导致网络中表项错误，如下游设备的ARP表项、MAC地址表项，从而导致业务异常。</p>
<p>▫为此分类后的堆叠系统会通过MAC检测线缆进行竞选。</p>
<p>▫竞选失败者关闭自身物理接口，从而不会和竞选成功地堆叠系统产生IP地址、MAC地址冲突。</p>
</blockquote>
<h2 id="MAD检测-直连检测"><a href="#MAD检测-直连检测" class="headerlink" title="MAD检测 - 直连检测"></a>MAD检测 - 直连检测</h2><p>直连检测方式是指堆叠成员交换机间通过普通线缆直连的专用链路进行多主检测。在直连检测方式中，堆叠系统正常运行时，不发送MAD报文；堆叠系统分裂后，分裂后的两台交换机以1秒为周期通过检测链路发送MAD报文进行多主冲突处理。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/22.png"></p>
<blockquote>
<p>•通过中间设备直连可以实现通过中间设备缩短堆叠成员交换机之间的检测链路长度，适用于成员交换机相距较远的场景。与通过中间设备直连相比，Full-mesh方式直连可以避免由中间设备故障导致的MAD检测失败，但是每两台成员交换机之间都建立全连接会占用较多的接口，所以该方式适用于成员交换机数目较少的场景。</p>
</blockquote>
<h2 id="MAD检测-代理检测"><a href="#MAD检测-代理检测" class="headerlink" title="MAD检测 - 代理检测"></a>MAD检测 - 代理检测</h2><p>代理检测方式是在堆叠系统Eth-Trunk上启用代理检测，在代理设备上启用MAD检测功能。此种检测方式要求堆叠系统中的所有成员交换机都与代理设备连接，并将这些链路加入同一个Eth-Trunk内。与直连检测方式相比，代理检测方式无需占用额外的接口，Eth-Trunk接口可同时运行MAD代理检测和其他业务。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/22.png"></p>
<blockquote>
<p>•在代理检测方式中，堆叠系统正常运行时，堆叠成员交换机以30s为周期通过检测链路发送MAD报文。堆叠成员交换机对在正常工作状态下收到的MAD报文不做任何处理；堆叠分裂后，分裂后的两个堆叠系统以1s为周期通过检测链路发送MAD报文进行多主冲突处理。</p>
</blockquote>
<h2 id="MAD冲突处理-1"><a href="#MAD冲突处理-1" class="headerlink" title="MAD冲突处理 (1)"></a>MAD冲突处理 (1)</h2><p>堆叠分裂后，MAD冲突处理机制使用MAD报文进行MAD竞争，竞争结果为堆叠系统处于Detect状态或者Recovery状态：</p>
<p>▫Detect：竞争成功，堆叠系统将处于正常工作状态。</p>
<p>▫Recovery：竞争失败，堆叠系统将状态处于禁用状态，关闭除手动配置的保留端口以外的其它所有物理端口。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/24.png"></p>
<h2 id="MAD冲突处理-2"><a href="#MAD冲突处理-2" class="headerlink" title="MAD冲突处理 (2)"></a>MAD冲突处理 (2)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/25.png"></p>
<h2 id="堆叠主备倒换"><a href="#堆叠主备倒换" class="headerlink" title="堆叠主备倒换"></a>堆叠主备倒换</h2><p>•如果堆叠系统当前的主交换机不是用户期望的，此时可以通过配置主备倒换实现将堆叠备交换机升为堆叠主交换机。</p>
<p>•除了用户通过命令执行的主备倒换之外，主交换机故障重启也会引起主备倒换。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/26.png"></p>
<blockquote>
<p>•原来的备交换机升为主交换机</p>
<p>•新主交换机重新指定备交换机</p>
<p>•原来的主交换机重启后重新加入堆叠系统，并被选举为从交换机。</p>
</blockquote>
<h2 id="堆叠升级"><a href="#堆叠升级" class="headerlink" title="堆叠升级"></a>堆叠升级</h2><p>堆叠升级方式有三种：智能升级、传统升级和平滑升级。</p>
<p>▫智能升级：堆叠建立或者新的交换机加入堆叠时会自动和主交换机的版本进行同步。</p>
<p>▫传统升级：和普通设备升级一样，指定下次启动版本，重启整个堆叠系统进行升级，会造成较长时间的业务中断。</p>
<p>▫平滑升级：将堆叠系统划分成为active、backup区域，可以分区域升级，整个堆叠系统的上下行采用备份组网，主、备链路分别处于active、backup区域，可以实现升级时的业务不中断。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/27.png"></p>
<blockquote>
<p>•Active区域：主交换机所在的区域</p>
<p>•平滑升级的三个阶段：</p>
<p>▫主交换机下发命令触发整个堆叠系统进入平滑升级状态，backup区各个成员交换机以新的系统软件进行启动。</p>
<p>▫backup区以新版本建立一个独立的堆叠系统，并通知active区进入升级阶段，主控权由active区的主交换机转移到backup区的主交换机，backup区负责流量传输，active区进入升级过程。</p>
<p>▫active区以新系统软件重新启动并加入backup区的堆叠系统，backup区的主交换机根据最终堆叠建立的结果发布升级的结果。</p>
</blockquote>
<h2 id="跨设备链路聚合-1"><a href="#跨设备链路聚合-1" class="headerlink" title="跨设备链路聚合 (1)"></a>跨设备链路聚合 (1)</h2><p>•堆叠支持跨设备链路聚合技术，堆叠后成为逻辑上的一台交换机，支持将Eth-Trunk的成员接口分布在不同的成员交换机上。</p>
<p>•当其中一条聚合链路故障或堆叠中某台成员交换机故障时，Eth-Trunk接口通过堆叠线缆将流量重新分布到其他聚合链路上，实现了链路间和设备间的备份，保证了数据流量的可靠传输。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/28.png"></p>
<h2 id="跨设备链路聚合-2"><a href="#跨设备链路聚合-2" class="headerlink" title="跨设备链路聚合 (2)"></a>跨设备链路聚合 (2)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/29.png"></p>
<blockquote>
<p>•如上图所时，在上行链路出现故障时跨设备链路聚合技术能够通过堆叠线缆将流量负载分担到其他成员交换机上的成员接口，从而提高网络可靠性。</p>
<p>•跨成员设备的流量会经过堆叠线缆，如果跨成员设备流量较大，将会大大增加堆叠线缆的带宽压力。</p>
</blockquote>
<h2 id="流量本地优先转发-1"><a href="#流量本地优先转发-1" class="headerlink" title="流量本地优先转发 (1)"></a>流量本地优先转发 (1)</h2><p>链路聚合的负载分担算法根据流量特征将报文分担在不同的成员链路上，对于跨设备链路聚合极有可能出现报文的出接口和入接口不在同一台成员设备之上的情况，此时堆叠成员之间将会通过堆叠线缆转发流量，这增加了堆叠线缆的流量负担，同时也降低了转发效率。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/30.png"></p>
<blockquote>
<p>•如上图所示，当链路聚合将流量分担到其他成员设备上时，部分流量将会经过堆叠线缆转发，这会大大增加堆叠线缆的带宽承载压力。如果通过堆叠线缆需要转发的流量甚至超过了堆叠线缆的带宽，报文将无法及时得到传输。</p>
</blockquote>
<h2 id="流量本地优先转发-2"><a href="#流量本地优先转发-2" class="headerlink" title="流量本地优先转发 (2)"></a>流量本地优先转发 (2)</h2><p>为保证流量转发效率、降低堆叠线缆带宽负载，设备可以开启流量本地优先转发，从本设备进入的流量优先从本地转发出去，当本设备无出接口或者出接口全部故障，才会从其它成员交换机的接口转发出去。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/31.png"></p>
<h1 id="3-集群技术原理"><a href="#3-集群技术原理" class="headerlink" title="3.集群技术原理"></a>3.<strong>集群技术原理</strong></h1><h2 id="集群介绍"><a href="#集群介绍" class="headerlink" title="集群介绍"></a>集群介绍</h2><p>•集群交换机系统CSS（Cluster Switch System），又称为集群，是指将两台支持集群特性的交换机设备组合在一起，从逻辑上虚拟成一台交换设备。</p>
<p>•CSS与iStack的区别在于，一般框式交换机堆叠称为CSS，盒式交换机称为堆叠，堆叠与集群两者只是叫法和实现有些差异，但是功能是一样的。</p>
<p>•本小节着重介绍集群与堆叠存在的差异之处。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/32.png"></p>
<h2 id="集群基本概念"><a href="#集群基本概念" class="headerlink" title="集群基本概念"></a>集群基本概念</h2><p>•集群中的单台交换机称为集群成员交换机，按照功能不同，可以分为两种角色：</p>
<p>▫主交换机（Master）：主交换机，即Master，负责管理整个集群。</p>
<p>▫备交换机（Standby）：备交换机，即Standby，是主交换机的备份交换机。</p>
<p>•集群ID：即CSS ID，用来标识成员交换机，集群中成员交换机的集群ID是唯一的。</p>
<p>•CSS Link：集群链路，专门用于组建集群，实现主交换机和备交换机之间数据通信。</p>
<p>•集群优先级：即CSS Priority，主要用于角色选举过程中确定成员交换机的角色。优先级值越大优先级越高。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/33.png"></p>
<blockquote>
<p>•备交换机，即Standby，是主交换机的备份交换机。当主交换机故障时，备交换机会接替原主交换机的所有业务。集群中只有一台备交换机。</p>
<p>•集群链路可以是一条链路，也可以是捆绑在一起的多条链路。</p>
<p>•缺省情况下，交换机的集群ID为1。相同ID的两台交换机不能建立集群，所以在建立集群前，需要手工配置集群中一台交换机的集群ID为2。</p>
<p>•交换机的集群优先级越高当选为主交换机的可能性越大，但选举主交换机比较的不止优先级。</p>
</blockquote>
<h2 id="集群控制平面"><a href="#集群控制平面" class="headerlink" title="集群控制平面"></a>集群控制平面</h2><p>•两台交换机使用集群线缆连接好，分别使能集群功能并完成配置后重启，集群系统会自动建立。</p>
<p>•集群系统建立后，在控制平面上，主交换机的主用主控板成为集群系统的控制平面，作为整个系统的管理主角色。备交换机的主用主控板成为集群系统的备用控制平面，作为系统的管理备角色。主交换机和备交换机的备用主控板作为集群系统候选备用主控板。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/34.png"></p>
<blockquote>
<p>•集群主交换机选举规则与堆叠选举规则一致，另外一台交换机则是备交换机。</p>
</blockquote>
<h2 id="集群物理连接"><a href="#集群物理连接" class="headerlink" title="集群物理连接"></a>集群物理连接</h2><p>根据集群技术发展阶段不同，集群物理连接方式也存在区别：</p>
<p>▫传统CSS：使用主控板上的集群卡建立集群连接，或者使用业务口建立集群连接。</p>
<p>▫CSS2：第二代集群交换机系统，专指使用交换网板上的集群卡方式建立集群连接的集群。</p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/35.png"></p>
<blockquote>
<p>•使用业务口连接时两端成员接口数量、类型相同，接线顺序无限制。</p>
<p>•业务口集群按照链路的分布，有两种组网形式：</p>
<ul>
<li><p>1+0组网：每台成员交换机配置一个逻辑集群端口，物理成员端口分布在一块业务板上，依靠一块业务板上物理成员端口与对框的物理成员端口实现集群连接。</p>
</li>
<li><p>1+1组网：每台成员交换机配置两个逻辑集群端口，物理成员端口分布在两块业务板上，如图所示，不同业务板上的集群链路形成备份。</p>
</li>
</ul>
<p>•CSS2：专指交换网板上通过集群卡方式建立的交换网硬件集群，并且在原有集群技术的基础上，增加了集群主控1+N备份等技术。</p>
</blockquote>
<h2 id="传统CSS"><a href="#传统CSS" class="headerlink" title="传统CSS"></a>传统CSS</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/36.png"></p>
<p>•对于只支持CSS构架的框式交换机，框内接口板之间流量、跨框流量必须经过主控板。</p>
<p>•单框上没有正常工作的主控板时流量无法从一个接口板转发到另外一个接口板，同时也无法跨框转发到另一个框。</p>
<h2 id="CSS2"><a href="#CSS2" class="headerlink" title="CSS2"></a>CSS2</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/37.png"></p>
<p>•支持CSS2构架的框式交换机采用转控分离的构架，单框内接口板之间流量、跨框流量无需经过主控板，集群系统内单台框无能够正常工作的主控板不影响该框的流量转发。</p>
<p>•CSS2支持任意一个框式交换机内存在一个主控板运行正常，集群的两个框式交换机上的接口板都可以正常转发报文，该特性被称为“集群主控1+N备份”。</p>
<h1 id="4-基本配置"><a href="#4-基本配置" class="headerlink" title="4.基本配置"></a>4.基本配置</h1><h2 id="堆叠配置-1"><a href="#堆叠配置-1" class="headerlink" title="堆叠配置 (1)"></a>堆叠配置 (1)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/38.png"></p>
<h2 id="堆叠配置-2"><a href="#堆叠配置-2" class="headerlink" title="堆叠配置 (2)"></a>堆叠配置 (2)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/39.png"></p>
<h2 id="堆叠配置-3"><a href="#堆叠配置-3" class="headerlink" title="堆叠配置 (3)"></a>堆叠配置 (3)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/40.png"></p>
<h2 id="堆叠配置-4"><a href="#堆叠配置-4" class="headerlink" title="堆叠配置 (4)"></a>堆叠配置 (4)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/41.png"></p>
<h2 id="堆叠配置案例"><a href="#堆叠配置案例" class="headerlink" title="堆叠配置案例"></a>堆叠配置案例</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/42.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/43.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/44.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/45.png"></p>
<h2 id="集群配置-1"><a href="#集群配置-1" class="headerlink" title="集群配置 (1)"></a>集群配置 (1)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/46.png"></p>
<h2 id="集群配置-2"><a href="#集群配置-2" class="headerlink" title="集群配置 (2)"></a>集群配置 (2)</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/47.png"></p>
<blockquote>
<p>•集群的MAD检测功能，配置方式、配置命令与堆叠一致。</p>
</blockquote>
<h2 id="集群配置案例"><a href="#集群配置案例" class="headerlink" title="集群配置案例"></a>集群配置案例</h2><p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/48.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/49.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/50.png"></p>
<p><img src="/2021/05/17/IP-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%A0%86%E5%8F%A0%E4%B8%8E%E9%9B%86%E7%BE%A4/51.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）堆叠加入与堆叠合并有什么区别？</p>
<p><strong>堆叠加入是交换机未上电之前已经通过堆叠线缆连接到了已有的堆叠系统，当上电启动之后因为堆叠系统已经存在主交换机，所以该交换机只会竞选成为从交换机。堆叠合并是两个堆叠系统通过堆叠线缆连在一起，此时两个堆叠系统会竞选新的主交换机并更新拓扑。<br> 一台交换机已经上电之后自身会成为一个堆叠系统并且由于没有竞争者自己会成为主交换机，这种情况下把该交换机通过堆叠线缆与另外一个堆叠系统相连就属于堆叠合并，这是一种典型的堆叠合并与堆叠加入的差异性场景。</strong></p>
<p>2.（简答题）多主检测的目的是？多主检测失败的一方会采取什么操作？</p>
<p><strong>防止堆叠、集群分裂之后相同的IP地址、MAC地址造成网络中其他网络设备的表项冲突，从而导致转发异常。检测失败的一方将会关闭除保留端口之外的所有端口，从而避免相同IP地址、相同MAC地址对其他网络设备造成表项冲突。</strong></p>
<p>3.（简答题） CSS2相比较于传统CSS区别在于？</p>
<p><strong>CSS2支持1+N主控备份，整个集群系统中只要有一个主控板处于工作状态，整个集群系统的控制平面可以正常工作的情况下，集群系统整体的数据平面就可以正常转发报文。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•堆叠、集群技术大大简化了网络部署的复杂化、降低了网络管理的复杂度，实现了快速部署高可靠、无环的园区网络，同时也极大地降低了网络故障的影响时间。</p>
<p>•为防止相同的IP地址、MAC地址造成的转发异常，可以配置MAD检测，MAD检测分为直接连接的检测方式以及代理设备检测，MAD竞争失败的一方会关闭除保留端口之外的所有物理端口。</p>
<p>•为保证报文的转发效率，在堆叠、集群上部署Eth-Trunk时尽量开启本地优先转发尽量避免跨框流量的产生。</p>
<p>•CSS2技术通过交换网板上的集群卡进行集群，结合交换机转控分离的构架，可以实现主控的1+N备份。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/" itemprop="url">IP-园区网典型技术应用概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-16T20:09:50+08:00">
                2021-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•工厂、政府机关、商场、写字楼、校园、公园等，这些场所内为了实现数据互通而搭建的网络都可以称之为园区网。园区有大有小，有行业属性的不同，相应地，园区网络也变化多样。但是，无论如何变化，园区网络一般划分为出口层、核心层、汇聚层及接入层。</p>
<p>•本课程主要介绍园区网络的总体架构、网络各层次中所使用的常用技术及协议、典型的组网场景。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述大型园区网络的典型架构。</p>
<p>▫描述常用以太网交换技术。</p>
<p>▫描述WLAN常见应用场景。</p>
<p>▫描述园区网络可靠性的常用技术。</p>
<p>▫描述园区网络网络服务与管理的常用技术。</p>
<p>▫描述园区网络安全的常用技术。</p>
<p>▫描述园区网络常用的VPN技术。</p>
<h1 id="1-园区网络架构与常见技术概述"><a href="#1-园区网络架构与常见技术概述" class="headerlink" title="1.园区网络架构与常见技术概述"></a>1.<strong>园区网络架构与常见技术概述</strong></h1><h2 id="“城市，除了马路，都是园区”"><a href="#“城市，除了马路，都是园区”" class="headerlink" title="“城市，除了马路，都是园区”"></a>“城市，除了马路，都是园区”</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/1.png"></p>
<h2 id="什么是园区网络？"><a href="#什么是园区网络？" class="headerlink" title="什么是园区网络？"></a>什么是园区网络？</h2><p>•园区网络一般是指企业或者机构的内部网络。</p>
<p>•园区网络的主要目的是使企业或者机构的各项业务运作更有效率。</p>
<p>•按规模可以将园区网络划分成：</p>
<p>▫大型园区网络：终端用户数量/个 &gt; 2000；网元数量/个 &gt; 100。</p>
<p>▫中型园区网络：2000 &gt; 终端用户数量/个 &gt; 200；100 &gt;网元数量/个 &gt; 25。</p>
<p>▫小型园区网络：终端用户数量/个 &lt; 200；网元数量/个 &lt; 25。</p>
<p>•有些企业还存在不同地域的办公分支机构，每个分支机构网络可看做一个单园区网络。</p>
<h2 id="常见的行业园区网"><a href="#常见的行业园区网" class="headerlink" title="常见的行业园区网"></a>常见的行业园区网</h2><p>•企业园区网络</p>
<p>▫关注网络可靠性、先进性，持续提升员工的办公体验，保障运营生产的效率和质量。</p>
<p>•校园网络</p>
<p>▫分为普教园区和高教园区。</p>
<p>▫高教园区相对复杂，通常存在教研网、学生网，还可能有运营性的宿舍网络。</p>
<p>▫网络可管理性、安全性要求高；对网络先进性亦有要求。</p>
<p>•政务园区网络</p>
<p>▫通常指政府机构的内部网络。</p>
<p>▫安全要求极高，通常采用内网和外网隔离的措施保障涉密信息的绝对安全。</p>
<p>•商业园区网络</p>
<p>▫商场、超市、酒店、公园等。</p>
<p>▫网络主要用于服务消费者，此外还包含服务内部办公的子网。</p>
<p>▫提供上网服务，并构建商业智能化系统提升用户体验，降低运维成本，提升商业效率，实现价值转移。</p>
<blockquote>
<p>•为了满足不同行业园区的需求，园区网络架构会根据其服务的行业特点进行设计， 最终打造的是带有行业属性的园区网络方案。</p>
</blockquote>
<h2 id="园区网络典型架构"><a href="#园区网络典型架构" class="headerlink" title="园区网络典型架构"></a>园区网络典型架构</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/2.png"></p>
<p>•<strong>核心层</strong>：是园区网骨干，是园区数据交换的核心，联接园区网的各个组成部分，如数据中心、管理中心、园区出口等。</p>
<p>•<strong>汇聚层</strong>：处于园区网的中间层次，完成数据汇聚或交换的功能，可以提供一些关键的网络基本功能，如路由、安全等。</p>
<p>•<strong>接入层</strong>：为终端用户提供园区网接入功能，是园区网的边界。</p>
<p>•<strong>出口区</strong>：园区内部网络到外部网络的边界，用于实现内部用户接入到公网，外部用户（包括客户、合作伙伴、分支机构、远程用户等）接入到内部网络。</p>
<p>•<strong>数据中心区</strong>：部署服务器和应用系统的区域，为企业内部和外部用户提供数据和应用服务。</p>
<h2 id="园区网络主要协议-技术"><a href="#园区网络主要协议-技术" class="headerlink" title="园区网络主要协议/技术"></a>园区网络主要协议/技术</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/3.png"></p>
<blockquote>
<p>•NAT：Network Address Translation，网络地址转换。</p>
<p>•LLDP：Link Layer Discovery Protocol，链路层发现协议。链路层发现协议是IEEE 802.1ab中定义的第二层发现协议。通过采用LLDP技术，在网络规模迅速扩大时，网管系统可以快速掌握二层网络拓扑信息、拓扑变化信息。</p>
<p>•NETCONF：Network Configuration Protocol，网络配置协议。NETCONF是一种提供网络设备配置管理的协议，采用基于数据编码的可扩展标记语言配置数据以及协议信息，提供了安装、操作和删除网元配置的机制。</p>
<p>•YANG：Yet Another Next Generation，通过NETCONF网络配置协议发送的数据的数据建模语言，可以用来建模网元的配置数据和状态数据。</p>
<p>•SNMP：Simple Network Management Protocol，简单网络管理协议。</p>
<p>•VRRP：Virtual Router Redundancy Protocol，虚拟路由冗余协议。</p>
<p>•MSTP：Multiple Spanning Tree Protocol，多生成树协议。</p>
</blockquote>
<h1 id="2-以太网交换基础"><a href="#2-以太网交换基础" class="headerlink" title="2.以太网交换基础"></a>2.以太网交换基础</h1><h2 id="从TCP-IP对等模型说起"><a href="#从TCP-IP对等模型说起" class="headerlink" title="从TCP/IP对等模型说起"></a>从TCP/IP对等模型说起</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/4.png"></p>
<p>•将网络的通信过程划分为小一些、简单一些的部件，有助于各个部件的开发、设计和故障排除。</p>
<p>•通过网络组件的标准化，允许多个供应商进行开发。</p>
<p>•通过定义在模型的每一层实现什么功能，鼓励产业的标准化。</p>
<p>•允许各种类型的网络硬件和软件相互通信。</p>
<h2 id="从园区网络到以太网二层交换"><a href="#从园区网络到以太网二层交换" class="headerlink" title="从园区网络到以太网二层交换"></a>从园区网络到以太网二层交换</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/5.png"></p>
<p>•接入层为用户提供各种接入方式，是终端接入网络的第一层。</p>
<p>•接入层通常由接入交换机组成，接入层交换机在网络中数量众多，安装位置分散，通常是简单的二层交换机。</p>
<p>•如果终端层存在无线终端设备，接入层需要无线接入点AP设备，AP设备通过接入交换机接入网络。</p>
<h2 id="什么是二层交换"><a href="#什么是二层交换" class="headerlink" title="什么是二层交换"></a>什么是二层交换</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/6.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/7.png"></p>
<p>•二层交换是以太网交换机的基本功能。</p>
<p>•二层交换指的是交换机根据数据帧的第二层头部中的目的MAC地址进行帧转发的行为。</p>
<p>•每台交换机都维护一个MAC地址表，用于指导数据帧转发。</p>
<p>•当交换机收到数据帧时，将在其MAC地址表中查询该帧的目的MAC地址，并根据匹配的表项执行相应的操作。此外，交换机收到数据帧时，还会进行源MAC地址学习。</p>
<blockquote>
<p>•二层交换设备工作在OSI模型的第二层，即数据链路层，它对数据包的转发是建立在MAC（Media Access Control ）地址基础之上的。</p>
<p>•二层交换设备通过解析和学习以太网帧的源MAC来维护MAC地址与接口的对应关系（保存MAC与接口对应关系的表称为MAC表），通过其目的MAC来查找MAC表决定向哪个接口转发。</p>
<p>•二层交换设备不同的接口发送和接收数据独立，各接口属于不同的冲突域，因此有效地隔离了网络中物理层冲突域，使得通过它互连的主机（或网络）之间不必再担心流量大小对于数据发送冲突的影响。</p>
</blockquote>
<h2 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/8.png"></p>
<p>•VLAN（Virtual Local Area Network）即虚拟局域网，是将一个物理的LAN在逻辑上划分成多个广播域的通信技术。</p>
<p>•一个VLAN中所有设备都是在同一广播域内，不同的VLAN为不同的广播域。</p>
<p>•VLAN内的设备间可以直接通信，而VLAN间不能直接互通。</p>
<p>•VLAN之间互相隔离，不同VLAN间需通过三层设备实现相互通信。</p>
<p>•一个VLAN一般为一个逻辑子网。</p>
<p>•VLAN中成员多基于交换机的端口分配，所谓的VLAN划分，通常指的是将交换机的接口添加到特定的VLAN中，从而该接口所连接的设备也加入到了该VLAN。</p>
<h2 id="以太网二层接口类型概述"><a href="#以太网二层接口类型概述" class="headerlink" title="以太网二层接口类型概述"></a>以太网二层接口类型概述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/9.png"></p>
<p>交换机的以太网二层接口主要存在以下三种类型：</p>
<p>•<strong>Access</strong>：常用来连接用户PC、服务器等终端设备的接口。Access接口所连接的这些设备的网卡往往只收发无标记帧。Access接口只能加入一个VLAN。</p>
<p>•<strong>Trunk</strong>：Trunk接口允许多个VLAN的数据帧通过，这些数据帧通过802.1Q Tag实现区分。Trunk接口常用于交换机之间的互联，也用于连接路由器、防火墙等设备的子接口。</p>
<p>•<strong>Hybrid</strong>：Hybrid接口与Trunk接口类似，也允许多个VLAN的数据帧通过，这些数据帧通过802.1Tag实现区分。用户可以灵活指定Hybrid接口在发送某个（或某些）VLAN的数据帧时是否携带Tag。</p>
<h3 id="Access接口"><a href="#Access接口" class="headerlink" title="Access接口"></a>Access接口</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/10.png"></p>
<blockquote>
<p>•所有的二层接口无论其类型如何，都有一个缺省VLAN ID，这个缺省VLAN ID被称为PVID（Port Default VLAN ID），在华为的交换机上，PVID缺省为1。另外，出于提高数据帧处理效率的考虑，在交换机内部，数据帧一律携带Tag。 </p>
</blockquote>
<h3 id="Trunk接口"><a href="#Trunk接口" class="headerlink" title="Trunk接口"></a>Trunk接口</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/11.png"></p>
<h3 id="Hybrid接口"><a href="#Hybrid接口" class="headerlink" title="Hybrid接口"></a>Hybrid接口</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/12.png"></p>
<p>•Hybrid接口也能承载多个VLAN的数据，它与Trunk接口在数据帧的接收行为上大体相同，这里不再赘述。Trunk接口在发送数据帧时，仅当待发送的数据帧与发送接口的PVID相同时，数据帧的Tag才会被移除，除此之外，该接口发送出去的其他VLAN的数据帧都是携带Tag的。而Hybrid接口发送数据帧的行为则与Trunk接口不同。我们可以通过命令指定Hybrid接口在发送某个，或者某些VLAN的数据帧时不携带Tag。</p>
<h3 id="VLAN划分方式总览"><a href="#VLAN划分方式总览" class="headerlink" title="VLAN划分方式总览"></a>VLAN划分方式总览</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/13.png"></p>
<h3 id="实现VLAN之间的IP可达性"><a href="#实现VLAN之间的IP可达性" class="headerlink" title="实现VLAN之间的IP可达性"></a>实现VLAN之间的IP可达性</h3><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/14.png"></p>
<h2 id="以太网链路聚合"><a href="#以太网链路聚合" class="headerlink" title="以太网链路聚合"></a>以太网链路聚合</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/15.png"></p>
<p>•<strong>链路聚合（Link Aggregation,LAG）</strong>是将多条物理链路捆绑在一起成为一条逻辑链路，从而增加链路带宽的技术。</p>
<p>•完成聚合后的链路称为以太网聚合链路。</p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/16.png"></p>
<blockquote>
<p>•随着网络规模不断扩大，用户对骨干链路的带宽和可靠性提出越来越高的要求。在传统技术中，常用更换高速率的接口板或更换支持高速率接口板的设备的方式来增加带宽，但这种方案需要付出高额的费用，而且不够灵活。</p>
<p>•采用链路聚合技术可以在不进行硬件升级的条件下，通过将多个物理接口捆绑为一个逻辑接口，达到增加链路带宽的目的。在实现增大带宽目的的同时，链路聚合采用备份链路的机制，可以有效的提高设备之间链路的可靠性。</p>
<p>•LAG是指将若干条以太链路捆绑在一起所形成的逻辑链路，简写为Eth-Trunk。每个聚合组唯一对应着一个逻辑接口，这个逻辑接口称之为聚合接口或Eth-Trunk接口。</p>
<p>•链路聚合技术主要有以下三个优势：</p>
<p>▫增加带宽：链路聚合接口的最大带宽可以达到各成员接口带宽之和。</p>
<p>▫提高可靠性：当某条活动链路出现故障时，流量可以切换到其他可用的成员链路上。</p>
<p>▫负载分担：在一个链路聚合组内，可以实现在各成员活动链路上的负载分担。</p>
</blockquote>
<h2 id="生成树技术：防环-保证二层网络可靠性"><a href="#生成树技术：防环-保证二层网络可靠性" class="headerlink" title="生成树技术：防环+保证二层网络可靠性"></a>生成树技术：防环+保证二层网络可靠性</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/17.png"></p>
<p>•解决交换网络中的环路问题</p>
<p>•动态地适应根据网络拓扑变更</p>
<p>•配合冗余链路，保证二层网络可靠性</p>
<h1 id="3-无线接入"><a href="#3-无线接入" class="headerlink" title="3.无线接入"></a>3.无线接入</h1><h2 id="WLAN与主要网元"><a href="#WLAN与主要网元" class="headerlink" title="WLAN与主要网元"></a>WLAN与主要网元</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/18.png"></p>
<h2 id="WLAN组网架构综述"><a href="#WLAN组网架构综述" class="headerlink" title="WLAN组网架构综述"></a>WLAN组网架构综述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/19.png"></p>
<blockquote>
<p>无线接入点 (AP, Access Point)</p>
<p>▫一般支持FAT AP（胖AP）、FIT AP（瘦AP）和云管理AP三种工作模式，根据网络规划的需求，可以灵活地在多种模式下切换。</p>
<p>▫FAT AP：适用于家庭，独立工作，需单独配置，功能较为单一，成本低。独立完成用户接入、认证、数据安全、业务转发和QoS等功能。</p>
<p>▫FIT AP：适用于大中型企业，需要配合AC使用，由AC统一管理和配置，功能丰富，对网络维护人员的技能要求高。用户接入、AP上线、认证、路由、AP管理、安全协议、QoS等功能需要同AC配合完成。</p>
<p>▫云管理：适用于中小型企业，需要配合云管理平台使用，由云管理平台统一管理和配置，功能丰富，即插即用，对网络维护人员的技能要求低。</p>
<p>无线接入控制器 (AC, Access Controller)</p>
<p>▫一般位于整个网络的汇聚层，提供高速、安全、可靠的WLAN业务。</p>
<p>▫提供大容量、高性能、高可靠性、易安装、易维护的无线数据控制业务，具有组网灵活、绿色节能等优势。</p>
</blockquote>
<h2 id="AC-FIT-AP架构"><a href="#AC-FIT-AP架构" class="headerlink" title="AC+FIT AP架构"></a>AC+FIT AP架构</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/20.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/21.png"></p>
<blockquote>
<p>•AC和AP之间使用的通信协议是无线接入点控制和配置（Control And Provisioning of Wireless Access Points，CAPWAP）。CAPWAP协议定义的主要内容有：AP自动发现AC，AC对AP进行安全认证，AP从AC获取软件，AP从AC获得初始和动态配置等。通过该协议，AP和AC之间建立起CAPWAP隧道。CAPWAP隧道有两种：控制隧道和数据隧道。控制隧道主要传输控制报文（也称管理报文，是AC管理控制AP的报文）；数据隧道主要传输数据报文。CAPWAP隧道可以进行数据传输层安全（Datagram Transport Layer Security，DTLS）加密，因此传输的报文更加安全。</p>
<p>•相比于FAT AP架构，AC+FIT AP架构的优点如下。</p>
<p>▫配置与部署：通过AC进行集中地网络配置和管理，不再需要对每个AP进行单独配置操作，同时对整网AP进行信道、功率的自动调整，免去了烦琐的人工调整过程。</p>
<p>▫安全性：由于FAT AP无法进行统一的升级操作，无法保证所有AP版本都有最新的安全补丁，而AC+FIT AP架构主要的安全能力是在AC上的，软件更新和安全配置仅需在AC上进行，从而可以快速进行全局安全设置；同时，为了防止加载恶意代码，设备会对软件进行数字签名认证，增强了更新过程的安全性。AC也实现了FAT AP架构无法支持的一些安全功能，包括病毒检测、统一资源定位地址（Uniform Resource Locater，URL）过滤、状态检测防火墙等高级安全特性。</p>
<p>▫更新与扩展：架构的集中管理模式使得同一AC下的AP有着相同的软件版本。当需要更新时，先由AC获取更新包或补丁，然后由AC统一更新AP版本。AP和AC的功能拆分也减少了对AP版本的频繁更新，有关用户认证、网管和安全等功能的更新只需在AC上进行。</p>
</blockquote>
<h2 id="AC-FIT-AP架构-1"><a href="#AC-FIT-AP架构-1" class="headerlink" title="AC+FIT AP架构"></a>AC+FIT AP架构</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/22.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/23.png"></p>
<h1 id="4-网络可靠性"><a href="#4-网络可靠性" class="headerlink" title="4.网络可靠性"></a>4.网络可靠性</h1><h2 id="使用VRRP实现网关冗余"><a href="#使用VRRP实现网关冗余" class="headerlink" title="使用VRRP实现网关冗余"></a>使用VRRP实现网关冗余</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/24.png"></p>
<blockquote>
<p>•虚拟路由冗余协议VRRP（Virtual Router Redundancy Protocol）通过把几台路由设备联合组成一台虚拟的路由设备，将虚拟路由设备的IP地址作为用户的默认网关实现与外部网络通信。当网关设备发生故障时，VRRP机制能够选举新的网关设备承担数据流量，从而保障网络的可靠通信。</p>
<p>•通常，同一网段内的所有主机上都设置一条相同的、以网关为下一跳的缺省路由。主机发往其他网段的报文将通过缺省路由发往网关，再由网关进行转发，从而实现主机与外部网络的通信。当网关发生故障时，本网段内所有以网关为缺省路由的主机将无法与外部网络通信。增加出口网关是提高系统可靠性的常见方法，此时如何在多个出口之间进行选路就成为需要解决的问题。</p>
<p>•VRRP的出现很好的解决了这个问题。VRRP能够在不改变组网的情况下，将多台路由设备组成一个虚拟路由器，通过配置虚拟路由器的IP地址为默认网关，实现默认网关的备份。</p>
<ul>
<li><strong>冗余备份</strong>：VRRP可以将多台路由设备配置为缺省网关路由器，当出现单点故障的时候通过备份链路进行业务传输，从而降低网络故障的可能性，保证用户的各种业务不中断传输。</li>
<li><strong>负载分担</strong>：VRRP可以实现多台设备同时承担业务流量，从而减轻主用设备上数据流量的承载压力，在路由设备之间更均衡地分担流量。</li>
<li><strong>联动功能</strong>：VRRP联动可以监视上行链路的故障。当上行接口或链路故障时，VRRP备份组的Master设备降低优先级，重新进行选举，确保Master路由器为最佳的VRRP路由设备，保证流量的正常转发。VRRP与BFD联动可以提高VRRP备份组中主备设备的切换速度。利用BFD检测速度快的特点，在Master设备和Backup设备之间建立BFD会话并与VRRP备份组进行绑定，实现Master设备和Backup设备之间的链路出现故障时，Backup设备迅速切换为Master，承担网络流量。</li>
</ul>
</blockquote>
<h2 id="集群-堆叠简介"><a href="#集群-堆叠简介" class="headerlink" title="集群/堆叠简介"></a>集群/堆叠简介</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/25.png"></p>
<p>•iStack（Intelligent Stack，智能堆叠），简称堆叠，是指将多台支持堆叠特性的交换机设备组合在一起，从逻辑上组合成一台交换设备。iStack针对华为盒式交换机。</p>
<p>•CSS（Cluster Switch System，集群交换机系统），又称为集群，是指将两台支持集群特性的交换机设备组合在一起，从逻辑上组合成一台交换设备。CSS针对华为框式交换机。</p>
<h2 id="堆叠与园区网络树形结构组网形态"><a href="#堆叠与园区网络树形结构组网形态" class="headerlink" title="堆叠与园区网络树形结构组网形态"></a>堆叠与园区网络树形结构组网形态</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/26.png"></p>
<p>•堆叠iStack（Intelligent Stack），是指将多台支持堆叠特性的交换机设备组合在一起，从逻辑上组合成一台整体交换设备。</p>
<p>•堆叠系统建立之前，每台交换机都是单独的实体，有自己独立的IP地址和MAC地址，对外体现为多台交换机，用户需要独立的管理所有的交换机；堆叠建立后堆叠成员对外体现为一个统一的逻辑实体，用户使用一个IP地址对堆叠中的所有交换机进行管理和维护，如图所示。通过交换机堆叠，可以实现网络大数据量转发和网络高可靠性，同时简化网络管理。</p>
<h1 id="5-网络服务与网络管理"><a href="#5-网络服务与网络管理" class="headerlink" title="5.网络服务与网络管理"></a>5.网络服务与网络管理</h1><h2 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/27.png"></p>
<blockquote>
<p>•动态主机配置协议DHCP（Dynamic Host Configuration Protocol）是一种用于集中对用户IP地址进行动态管理和配置的技术。即使规模较小的网络，通过DHCP也可以使后续增加网络设备变得简单快捷。</p>
<p>•DHCP允许计算机动态地获取IP地址，而不是静态为每台主机指定地址。</p>
<p>•DHCP能够分配其他配置参数，例如客户端的启动配置文件，使客户端仅用一个消息就获取它所需要的所有配置信息。</p>
<p>•DHCP协议由RFC 2131定义，采用客户端/服务器通信模式，由客户端（DHCP Client）向服务器（DHCP Server）提出配置申请，服务器返回为客户端分配的配置信息。</p>
<p>•DHCP可以提供两种地址分配机制，网络管理员可以根据网络需求为不同的主机选择不同的分配策略。</p>
<p>▫动态分配机制：通过DHCP为主机分配一个有使用期限（这个使用期限通常叫做租期）的IP地址。这种分配机制适用于主机需要临时接入网络或者空闲地址数小于网络主机总数且主机不需要永久连接网络的场景。</p>
<p>▫静态分配机制：网络管理员通过DHCP为指定的主机分配固定的IP地址。相比手工静态配置IP地址，通过DHCP方式静态分配机制避免人工配置发生错误，方便管理员统一维护管理。</p>
<p>•DHCP受益主要有以下两点：</p>
<p>▫降低客户端的配置和维护成本</p>
<p>▫集中管理</p>
</blockquote>
<h2 id="NTP"><a href="#NTP" class="headerlink" title="NTP"></a>NTP</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/28.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/29.png"></p>
<blockquote>
<p>•网络时间协议NTP（Network Time Protocol）是TCP/IP协议族里面的一个应用层协议。NTP用于在一系列分布式时间服务器与客户端之间同步时钟。NTP的实现基于IP和UDP。NTP报文通过UDP传输，端口号是123。</p>
<p>•随着网络拓扑的日益复杂，整个网络内设备的时钟同步将变得十分重要。如果依靠管理员手工修改系统时钟，不仅工作量巨大，而且时钟的准确性也无法得到保证。NTP的出现就是为了解决网络内设备系统时钟的同步问题。</p>
<p>•NTP主要应用于网络中所有设备时钟需要保持一致的场合，比如：网络管理：对从不同路由器采集来的日志信息、调试信息进行分析时，需要以时间作为参照依据。</p>
<p>▫计费系统：要求所有设备的时钟保持一致。</p>
<p>▫多个系统协同处理同一个复杂事件：为保证正确的执行顺序，多个系统必须参考同一时钟。</p>
<p>▫备份服务器和客户机之间进行增量备份：要求备份服务器和所有客户机之间的时钟同步。</p>
<p>▫系统时间：某些应用程序需要知道用户登录系统的时间以及文件修改的时间。</p>
<p>•交换机既可以作为NTP的服务器，也可以作为NTP的客户端。</p>
</blockquote>
<h2 id="LLDP"><a href="#LLDP" class="headerlink" title="LLDP"></a>LLDP</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/30.png"></p>
<blockquote>
<p>•LLDP（Link Layer Discovery Protocol）是IEEE 802.1ab中定义的链路层发现协议。LLDP是一种标准的二层发现方式，可以将本端设备的管理地址、设备标识、接口标识等信息组织起来，并发布给自己的邻居设备，邻居设备收到这些信息后将其以标准的管理信息库MIB（Management Information Base）的形式保存起来，以供网络管理系统查询及判断链路的通信状况。</p>
<p>•随着网络规模越来越大，网络设备种类繁多，并且各自的配置错综复杂，对网络管理能力的要求也越来越高。传统网络管理系统多数只能分析到三层网络拓扑结构，无法确定网络设备的详细拓扑信息、是否存在配置冲突等。因此需要有一个标准的二层信息交流协议。</p>
<p>•LLDP提供了一种标准的链路层发现方式。通过LLDP获取的设备二层信息能够快速获取相连设备的拓扑状态；显示出客户端、交换机、路由器、应用服务器以及网络服务器之间的路径；检测设备间的配置冲突、查询网络失败的原因。企业网用户可以通过使用网管系统，对支持运行LLDP协议的设备进行链路状态监控，在网络发生故障的时候快速进行故障定位。</p>
</blockquote>
<h2 id="SNMP"><a href="#SNMP" class="headerlink" title="SNMP"></a>SNMP</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/31.png"></p>
<h2 id="NETCONF-YANG"><a href="#NETCONF-YANG" class="headerlink" title="NETCONF/YANG"></a>NETCONF/YANG</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/32.png"></p>
<h1 id="6-网络安全"><a href="#6-网络安全" class="headerlink" title="6.网络安全"></a>6.网络安全</h1><h2 id="园区网络安全概述"><a href="#园区网络安全概述" class="headerlink" title="园区网络安全概述"></a>园区网络安全概述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/33.png"></p>
<h2 id="基于防火墙的安全区域划分及安全策略"><a href="#基于防火墙的安全区域划分及安全策略" class="headerlink" title="基于防火墙的安全区域划分及安全策略"></a>基于防火墙的安全区域划分及安全策略</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/34.png"></p>
<p>•安全区域（Security Zone），或者简称为区域（Zone），是一个安全的概念，大部分的安全策略都基于安全区域实施。</p>
<p>•一个安全区域是防火墙若干接口所连网络的集合，这些网络中的用户具有相同的安全属性。</p>
<p>•将企业员工网络、公司服务器网络、外部网络划分到不同安全区域，对安全区域间的流量进行检测和保护。</p>
<blockquote>
<p>•在一台防火墙上不允许创建两个相同安全级别（Priority）的安全区域；</p>
<p>•防火墙的接口必须加入一个安全区域，否则不能正常转发流量。</p>
<p>•防火墙的一个接口只能属于一个安全区域。</p>
<p>•防火墙的一个安全区域可以拥有多个接口。</p>
<p>•系统自带的缺省安全区域不能删除，用户可以根据实际需求创建自定义的安全区域。</p>
</blockquote>
<h2 id="防火墙双机热备概述"><a href="#防火墙双机热备概述" class="headerlink" title="防火墙双机热备概述"></a>防火墙双机热备概述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/35.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/36.png"></p>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/37.png"></p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/38.png"></p>
<h1 id="7-VPN"><a href="#7-VPN" class="headerlink" title="7.VPN"></a>7.VPN</h1><h2 id="VPN技术应用场景"><a href="#VPN技术应用场景" class="headerlink" title="VPN技术应用场景"></a>VPN技术应用场景</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/39.png"></p>
<p>•对于规模较大的企业来说，网络访问需求不仅仅局限于公司总部网络内，分公司、出差员工、合作单位等也需要访问公司总部的网络资源，一般采用VPN（Virtual Private Network，虚拟专用网络）技术来实现这一需求。</p>
<p>•VPN可以在不改变现有网络结构的情况下，建立虚拟专用连接。因其具有廉价、专用和虚拟等多种优势，在现网中应用非常广泛。</p>
<p>•VPN是一类技术的统称，不同的VPN技术拥有不同的特性和实现方式，常见的VPN技术包括IPSec VPN、GRE VPN、L2TP VPN、MPLS VPN等。</p>
<blockquote>
<p>•IPSec：IP Security， 因特网协议安全协议。</p>
<p>•GRE：Generic Routing Encapsulation， 通用路由封装协议。</p>
<p>•L2TP：Layer 2 Tunneling Protocol， 二层隧道协议。</p>
<p>•MPLS：Multiprotocol Label Switching，多协议标签交换协议。</p>
</blockquote>
<h1 id="8-组播"><a href="#8-组播" class="headerlink" title="8.组播"></a>8.组播</h1><h2 id="组播应用场景"><a href="#组播应用场景" class="headerlink" title="组播应用场景"></a>组播应用场景</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/40.png"></p>
<p>•企业存在一些公告信息，例如天气、值班表、机房注意事项、宣传视频等，为方便公司员工和来访人员及时获取这些信息，通常采用在公司人员密集处布置显示屏的方式。</p>
<p>•每一块显示屏显示的内容一致，这是典型的点到多点通信的场景。如果采用单播的方式传递信息，网络中的设备性能及链路带宽都会面临一定程度的浪费。</p>
<p>•组播技术有效地满足了单点发送、多点接收的需求，实现了IP网络中点到多点业务数据的高效传送，能够大量节约网络带宽、降低网络负载。</p>
<blockquote>
<p>•单播（Unicast）是在一台源IP主机和一台目的IP主机之间进行。网络上绝大部分的数据都是以单播的形式传输的，例如电子邮件收发、网上银行都是采用单播实现的。</p>
<ul>
<li>在单播通信中每一个数据包都有确切的目的IP地址；对于同一份数据，如果存在多个接收者，Server需发送与接收者数目相同的单播数据包；当接收者增加到成百上千时，将极大加重Server创建相同数据和发送多份相同拷贝后所产生的消耗，网络中的设备性能及链路带宽都会面临一定程度的浪费；单播方式较适合用户稀少的网络，当用户量较大时很难保证网络传输质量。</li>
</ul>
<p>•广播（Broadcast）是在一台源IP主机和网络中所有其它的IP主机之间进行，属于一对所有的通讯方式，所有主机都可以接收到（不管是否需要）。</p>
<ul>
<li>广播数据包被限制在广播域中；一旦有设备发送广播数据，则广播域内所有设备都会收到这个数据包，并且不得不耗费资源去处理，大量的广播数据包将消耗网络的带宽及设备资源；广播方式只适合共享网段，且信息安全性和有偿服务得不到保障。</li>
</ul>
<p>•组播（Multicast）是在一台源IP主机和多台（一组）IP主机之间进行，中间的网络设备根据接收者的需要，有选择性地对数据进行复制和转发。</p>
</blockquote>
<h2 id="组播网络基本架构"><a href="#组播网络基本架构" class="headerlink" title="组播网络基本架构"></a>组播网络基本架构</h2><p>组播网络大体可以分为三个部分：</p>
<p>▫源端网络：将组播源产生的组播数据发送至组播网络。</p>
<p>▫组播转发网络：形成无环的组播转发路径，该转发路径也被称为组播分发树（Multicast Distribution Tree）。</p>
<p>▫成员端网络：让组播网络感知组播组成员位置与加入的组播组。</p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/41.png"></p>
<blockquote>
<p>•组播源（Source）：组播流量的发送者，例如多媒体服务器。组播源无需运行任何组播协议，只需简单 地将组播数据发送出来即可。 </p>
<p>•组播接收者（Receiver）：也被称为组播组成员，是期望接收特定组播组流量的设备，例如运行多媒体直播客户端软件的PC。</p>
<p>•组播组（Multicast Group）：用IP组播地址进行标识的一个集合。任何用户主机（或其他接收设备），加入一个组播组，就成为了该组成员，可以识别并接收发往该组播组的组播数据。</p>
<p>•组播路由器（Multicast Router）：支持组播、运行组播协议的网络设备，实际上不仅仅路由器能够支持 组播，交换机、防火墙等设备也能够支持组播（取决于设备型号），路由器仅是一个代表。</p>
<p>•第一跳路由器（First-Hop Router）：组播转发路径上，与组播源相连且负责转发该组播源发出的组播数据的PIM路由器。</p>
<p>•最后一跳路由器（Last-Hop Router）：组播转发路径上，与组播组成员相连且负责向该组成员转发组播数据的PIM路由器。</p>
<p>•IGMP（Internet Group Management Protocol，因特网组管理协议），是TCP/IP协议族中负责IP组播成员管理的协议，它用来在接收者和与其直接相邻的组播路由器之间建立、维护组播组成员关系。</p>
</blockquote>
<h1 id="9-IPv6"><a href="#9-IPv6" class="headerlink" title="9.IPv6"></a>9.IPv6</h1><h2 id="IPv6概述"><a href="#IPv6概述" class="headerlink" title="IPv6概述"></a>IPv6概述</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/42.png"></p>
<p>•IPv4协议是目前广泛部署的因特网协议。在因特网发展初期，IPv4以其协议简单、易于实现、互操作性好的优势而得到快速发展。但随着因特网的迅猛发展， IPv4地址空间不足的问题日趋明显，IPv6取代IPv4势在必行。</p>
<p>•IPv6（Internet Protocol Version 6）是网络层协议的第二代标准协议，也被称为IPng（IP Next Generation）。它是Internet工程任务组IETF（Internet Engineering Task Force）设计的一套规范，是IPv4（Internet Protocol Version 4）的升级版本。</p>
<p>•IPv6地址长度为128 bit，海量的地址空间，满足物联网等新兴业务、有利于业务演进及扩展。</p>
<h2 id="ICMPv6"><a href="#ICMPv6" class="headerlink" title="ICMPv6"></a>ICMPv6</h2><p>•ICMPv6 （Internet Control Message Protocol for IPv6）是IPv6的基础协议之一。</p>
<p>•ICMPv6报文被广泛应用于其它协议中，包括NDP、PathMTU发现机制等。</p>
<p>•ICMPv6控制着IPv6中的地址自动配置、地址解析、地址冲突检测、路由选择、以及差错控制等关键环节。</p>
<p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/43.png"></p>
<blockquote>
<p>•NDP：Neighbor Discovery Protocol，邻居发现协议。</p>
</blockquote>
<h2 id="IPv6路由"><a href="#IPv6路由" class="headerlink" title="IPv6路由"></a>IPv6路由</h2><p><img src="/2021/05/16/IP-%E5%9B%AD%E5%8C%BA%E7%BD%91%E5%85%B8%E5%9E%8B%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E6%A6%82%E8%BF%B0/44.png"></p>
<p>IPv6网络支持静态路由和动态路由协议：</p>
<ul>
<li><p>静态路由：</p>
<ul>
<li>IPv6静态路由的配置方式和IPv4静态路由的配置方式相同。</li>
</ul>
</li>
<li><p>动态路由协议：</p>
<ul>
<li>OSPFv3</li>
<li>IS-IS</li>
<li>BGP4+</li>
</ul>
</li>
</ul>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）以下关于交换机二层接口的描述，正确的是？(   )</p>
<p><strong>A.交换机的二层接口类型有Access、Trunk、Hybrid。</strong></p>
<p><strong>B.Access接口只能加入一个VLAN。</strong></p>
<p><strong>C.缺省情况下，Trunk接口允许VLAN1的流量通过，而且在发送时不携带VLAN Tag。</strong></p>
<p>**D.在Hybrid接口上可通过命令指定接口在发送特定VLAN的流量时，是否携带VLAN Tag。 **</p>
<p>2.（多选题）以太网链路聚合技术有哪些优势？(   )</p>
<p><strong>A.增加带宽：链路聚合接口的最大带宽可以达到各成员接口带宽之和。</strong></p>
<p><strong>B.提高可靠性：当某条活动链路出现故障时，流量可以切换到其他可用的成员链路上。</strong></p>
<p><strong>C.负载分担：在一个链路聚合组内，可以实现在各成员活动链路上的负载分担。</strong></p>
<p>D.智能调优：可根据流量大小自动调整活动接口数量。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本章系统地介绍了园区网络典型技术场景化应用：以太网交换基础、无线接入、网络可靠性、网络服务与网络管理、路由与网络可达性、网络安全、VPN。</p>
<p>•受限于课程篇幅，本文无法将园区网络中所用的技术一一列举。通过本章的学习，读者已经了解园区网络的典型架构，以及典型技术在园区网络中的应用，有助于读者继续学习后续课程。</p>
<p>•在后续的课程中，我们将深入探讨园区网络的关键技术，为将来学习园区网络解决方案打下扎实基础。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/" itemprop="url">IP-流量过滤与转发路径控制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-16T20:09:21+08:00">
                2021-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•传统的路由转发原理是首先根据报文的目的地址查找路由表，然后进行报文转发。随着业务的发展，用户更加希望能够在传统路由转发的基础上根据自己定义的策略进行报文转发和选路。</p>
<p>•为提高网络安全性，用户希望能够控制进入网络的报文，将没有权限进入网络或存在安全隐患的报文隔离在网络边界。</p>
<p>•本课程将会学习流量过滤技术、策略路由以及使用MQC（Modular QoS Command-Line Interface，模块化QoS命令行）的方式控制报文的转发路径和进行流量过滤。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述策略路由的使用场景</p>
<p>▫阐明策略路由的分类</p>
<p>▫描述如何使用MQC配置策略路由</p>
<p>▫描述如何使用MQC过滤报文</p>
<h1 id="1-策略路由"><a href="#1-策略路由" class="headerlink" title="1.策略路由"></a>1.策略路由</h1><h2 id="策略路由技术背景"><a href="#策略路由技术背景" class="headerlink" title="策略路由技术背景"></a>策略路由技术背景</h2><p>在某些场景中我们希望一些特定用户、特定业务的流量走指定的转发路径，而其余用户或业务的流量则依旧根据路由表进行转发。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/1.png"></p>
<h2 id="PBR介绍-基本概念"><a href="#PBR介绍-基本概念" class="headerlink" title="PBR介绍 - 基本概念"></a>PBR介绍 - 基本概念</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/2.png"></p>
<p>•PBR（Policy-Based Routing，策略路由）：PBR使得网络设备不仅能够基于报文的目的IP地址进行数据转发，更能基于其他元素进行数据转发，例如源IP地址、源MAC地址、目的MAC地址、源端口号、目的端口号、VLAN-ID等等。</p>
<p>•用户还可以使用ACL匹配特定的报文，然后针对该ACL进行PBR部署。</p>
<p>•若设备部署了PBR，则被匹配的报文优先根据PBR的策略进行转发，即PBR策略的优先级高于传统路由表。</p>
<h2 id="PBR介绍-结构"><a href="#PBR介绍-结构" class="headerlink" title="PBR介绍 - 结构"></a>PBR介绍 - 结构</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/3.png"></p>
<p>•PBR与Route-Policy类似，由多个节点组成，每个节点由匹配条件（条件语句）和执行动作（执行语句）组成。</p>
<p>•每个节点内可包含多个条件语句。</p>
<p>•节点内的多个条件语句之间的关系为“与”，即匹配所有条件语句才会执行本节点内的动作。</p>
<p>•节点之间的关系为“或”，PBR根据节点编号从小到大顺序执行，匹配当前节点将不会继续向下匹配。</p>
<h2 id="PBR介绍-命令语法"><a href="#PBR介绍-命令语法" class="headerlink" title="PBR介绍 - 命令语法"></a>PBR介绍 - 命令语法</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/4.png"></p>
<blockquote>
<p>•PBR的节点匹配模式：</p>
<p>​    ▫permit表示对满足匹配条件的报文进行策略路由</p>
<p>​    ▫deny表示对满足匹配条件的报文不进行策略路由</p>
</blockquote>
<h2 id="PBR与路由策略区别"><a href="#PBR与路由策略区别" class="headerlink" title="PBR与路由策略区别"></a>PBR与路由策略区别</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/5.png"></p>
<h2 id="PBR的分类"><a href="#PBR的分类" class="headerlink" title="PBR的分类"></a>PBR的分类</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/6.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/7.png"></p>
<h2 id="PBR典型应用场景-1"><a href="#PBR典型应用场景-1" class="headerlink" title="PBR典型应用场景 (1)"></a>PBR典型应用场景 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/8.png"></p>
<p>•内网防火墙旁挂部署在核心交换机，为防护内网在核心交换机的三层接口上部署PBR，将来自外部网络的流量牵引到防火墙上进行安全检查，检查完的流量再发送回核心交换机，由核心交换机依据路由表转发到内网。</p>
<p>•将流量牵引到别的设备进行安全检查等类似的行为我们称之为“引流”，PBR是一种常见的引流工具。</p>
<h2 id="PBR典型应用场景-2"><a href="#PBR典型应用场景-2" class="headerlink" title="PBR典型应用场景 (2)"></a>PBR典型应用场景 (2)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/9.png"></p>
<p>当企业存在多个网络出口时，若想指定部分网段访问Internet时的网络出口，可以使用PBR：在出口设备的内网接口配置PBR，匹配来自内网的流量，为其指定不同的下一跳公网地址。</p>
<h2 id="配置介绍-1"><a href="#配置介绍-1" class="headerlink" title="配置介绍 (1)"></a>配置介绍 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/10.png"></p>
<blockquote>
<p>•当ACL的rule配置为permit时，设备会对匹配该规则的报文执行本地策略路由的动作：</p>
<ul>
<li><p>本地策略路由中策略点为permit时对满足匹配条件的报文进行策略路由；</p>
</li>
<li><p>本地策略路由中策略点为deny时对满足匹配条件的报文不进行策略路由，即根据目的地址查找路由表转发报文。</p>
</li>
</ul>
<p>•当ACL配置了rule，如果报文未匹配上任何规则，则根据目的地址查找路由表转发报文。</p>
<p>•当ACL的rule配置为deny或ACL未配置规则时，应用该ACL的本地策略路由不生效，即根据目的地址查找路由表转发报文。</p>
</blockquote>
<h2 id="配置介绍-2"><a href="#配置介绍-2" class="headerlink" title="配置介绍 (2)"></a>配置介绍 (2)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/11.png"></p>
<blockquote>
<p>•除了该方式之外，接口策略路由还可以使用MQC的方式进行配置。</p>
</blockquote>
<h2 id="配置案例-1"><a href="#配置案例-1" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/11.png"></p>
<p>需求：</p>
<p>▫内网存在两个网段，网段1：10.1.1.0/24，网段2：10.1.2.0/24，在RTA的GE0/0/0接口部署PBR，实现网段1访问Internet通过ISP1、网段2访问Internet通过ISP2。</p>
<p>▫RTA上旁挂了一台服务器，要求在RTA上部署的策略路由不影响内网用户访问该服务器。</p>
<h2 id="配置案例-2"><a href="#配置案例-2" class="headerlink" title="配置案例 (2)"></a>配置案例 (2)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/13.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/14.png"></p>
<h2 id="配置案例-3"><a href="#配置案例-3" class="headerlink" title="配置案例 (3)"></a>配置案例 (3)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/15.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/16.png"></p>
<h1 id="2-MQC"><a href="#2-MQC" class="headerlink" title="2.MQC"></a>2.MQC</h1><h2 id="MQC介绍-1"><a href="#MQC介绍-1" class="headerlink" title="MQC介绍 (1)"></a>MQC介绍 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/17.png"></p>
<p>•MQC（Modular QoS Command-Line Interface，模块化QoS命令行）是指通过将具有某类共同特征的数据流划分为一类，并为同一类数据流提供相同的服务，也可以对不同类的数据流提供不同的服务。</p>
<p>•MQC包含三个要素：流分类（traffic classifier）、流行为（traffic behavior）和流策略（traffic policy）。</p>
<p>•MQC的流行为支持重定向报文，因此可以使用MQC实现IP单播策略路由。</p>
<h2 id="MQC介绍-2"><a href="#MQC介绍-2" class="headerlink" title="MQC介绍 (2)"></a>MQC介绍 (2)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/18.png"></p>
<p>•流策略：将流分类和流行为绑定，对分类后的报文执行对应流行为中定义的动作。</p>
<p>•一个流策略可以绑定多个流分类和流行为。</p>
<h2 id="MQC-流分类"><a href="#MQC-流分类" class="headerlink" title="MQC - 流分类"></a>MQC - 流分类</h2><p>流分类：定义一组流量匹配规则，以对报文进行分类。流分类支持的匹配项如下所示。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/19.png"></p>
<blockquote>
<p>•流分类中各规则之间的关系分为：and或or，缺省情况下的关系为or。</p>
<ul>
<li><p>and：当流分类中包含ACL规则时，报文必须匹配其中一条ACL规则以及所有非ACL规则；当流分类中没有ACL规则时，报文必须匹配所有非ACL规则。</p>
</li>
<li><p>or：报文只要匹配了流分类中的一个规则，设备就认为报文匹配中该流分类。</p>
</li>
</ul>
</blockquote>
<h2 id="MQC-流行为"><a href="#MQC-流行为" class="headerlink" title="MQC - 流行为"></a>MQC - 流行为</h2><p>流行为：用来定义执行的动作，支持报文过滤、重标记优先级、重定向、流量统计等动作。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/20.png"></p>
<h2 id="MQC-流策略"><a href="#MQC-流策略" class="headerlink" title="MQC - 流策略"></a>MQC - 流策略</h2><p>•流策略：流策略支持在接口上调用。</p>
<p>•流策略存在方向(inbound、outbound)的概念，策略中的流行为匹配入、出方向的报文，对匹配中的报文执行相应的流动作。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/21.png"></p>
<blockquote>
<p>•流策略不同于PBR，PBR只能调用在三层接口，而流策略支持调用在二层接口。</p>
</blockquote>
<h2 id="使用MQC实现策略路由"><a href="#使用MQC实现策略路由" class="headerlink" title="使用MQC实现策略路由"></a>使用MQC实现策略路由</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/22.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/23.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/24.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/25.png"></p>
<h1 id="3-流量过滤"><a href="#3-流量过滤" class="headerlink" title="3.流量过滤"></a>3.流量过滤</h1><h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>为提高网络安全性，管理人员需要控制进入网络的流量，将不信任的报文丢弃在网络边界。所谓的不信任报文是指对用户来说存在安全隐患或者不愿意接收的报文。同时保证数据访问安全性，企业网络中经常会要求一些部门之间不能相互访问。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/26.png"></p>
<h2 id="流量过滤工具"><a href="#流量过滤工具" class="headerlink" title="流量过滤工具"></a>流量过滤工具</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/27.png"></p>
<h2 id="Traffic-Filter部署位置"><a href="#Traffic-Filter部署位置" class="headerlink" title="Traffic-Filter部署位置"></a>Traffic-Filter部署位置</h2><p>使用Traffic-Filter过滤流量可以灵活地选择部署位置，在流量进入设备或者离开设备的接口上执行过滤动作，双向访问的业务禁止其中一个方向即可实现阻断业务的需求。</p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/28.png"></p>
<blockquote>
<p>•Traffic-Filter部署的位置不同，其调用的ACL内容也不相同。</p>
</blockquote>
<h2 id="使用Traffic-Filter过滤流量"><a href="#使用Traffic-Filter过滤流量" class="headerlink" title="使用Traffic-Filter过滤流量"></a>使用Traffic-Filter过滤流量</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/29.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/30.png"></p>
<h2 id="使用MQC过滤流量-1"><a href="#使用MQC过滤流量-1" class="headerlink" title="使用MQC过滤流量 (1)"></a>使用MQC过滤流量 (1)</h2><p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/31.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/32.png"></p>
<p><img src="/2021/05/16/IP-%E6%B5%81%E9%87%8F%E8%BF%87%E6%BB%A4%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%8E%A7%E5%88%B6/33.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）本地策略路由与接口策略路由的区别在于？</p>
<p><strong>本地策略路由对本地始发的流量生效，而接口策略路由只会对接口入方向的流量生效。</strong></p>
<p>2.（简答题）使用MQC方式过滤流量时，流分类中匹配的ACL与Traffic-Filter调用的ACL有何区别？</p>
<p><strong>MQC调用的ACL里permit、deny只代表是否匹配流量，不代表是否放通、拒绝流量，而Traffic-Filter调用的ACL里permit、deny代表放通、拒绝流量。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本课程介绍了PBR的应用场景、PBR的分类以及如何配置本地策略路由、接口策略路由。</p>
<p>•MQC支持多种灵活的流量匹配方式以及执行动作，同时还可以在多种视图下调用，使用MQC可以完成策略路由、流量过滤的功能。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/" itemprop="url">IP-路由策略与路由控制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-16T20:08:48+08:00">
                2021-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•在复杂的数据通信网络中，根据实际组网需求，往往需要实施一些路由策略对路由信息进行过滤、属性设置等操作，通过对路由的控制，可以影响数据流量转发。</p>
<p>•路由策略并非单一的技术或者协议，而是一个技术专题或方法论，里面包含了多种工具及方法。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫使用ACL匹配感兴趣路由</p>
<p>▫使用IP-Prefix匹配感兴趣路由</p>
<p>▫使用Filter-Policy进行路由过滤</p>
<p>▫使用Route-Policy进行路由过滤及路由属性修改</p>
<h1 id="1-路由控制概述"><a href="#1-路由控制概述" class="headerlink" title="1.路由控制概述"></a>1.<strong>路由控制概述</strong></h1><h2 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/1.png"></p>
<p>•R1上将业务A、B、C的网段路由引入时希望不引入业务C网段路由，同时R3上将OSPF路由引入到IS-IS中时，同样只希望引入B业务网段路由。</p>
<p>•此时需要一个工具在引入路由时进行限制。</p>
<h2 id="路由控制概述"><a href="#路由控制概述" class="headerlink" title="路由控制概述"></a>路由控制概述</h2><p>路由控制可以通过路由策略（Route-Policy）实现，路由策略应用灵活而广泛，有以下几种常见方式：</p>
<p>▫控制路由的发布：通过路由策略对发布的路由进行过滤，只发布满足条件的路由。</p>
<p>▫控制路由的接收：通过路由策略对接收的路由进行过滤，只接收满足条件的路由。</p>
<p>▫控制路由的引入：通过路由策略控制从其他路由协议引入的路由条目，只有满足条件的路由才会被引入。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/2.png"></p>
<h1 id="2-路由控制工具"><a href="#2-路由控制工具" class="headerlink" title="2.路由控制工具"></a>2.路由控制工具</h1><h2 id="路由匹配工具"><a href="#路由匹配工具" class="headerlink" title="路由匹配工具"></a>路由匹配工具</h2><h3 id="匹配工具1：访问控制列表"><a href="#匹配工具1：访问控制列表" class="headerlink" title="匹配工具1：访问控制列表"></a>匹配工具1：访问控制列表</h3><p>•访问控制列表（Access Control List，ACL）是一个匹配工具，能够对报文及路由进行匹配和区分。</p>
<p>•ACL由若干条permit或deny语句组成。每条语句就是该ACL的一条规则，每条语句中的permit或deny就是与这条规则相对应的处理动作。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/3.png"></p>
<blockquote>
<p>ACL的组成：</p>
<p>▫ACL编号：在网络设备上配置ACL时，每个ACL都需要分配一个编号，称为ACL编号，用来标识ACL。不同分类的ACL编号范围不同，这个后面具体讲。</p>
<p>▫规则：前面提到了，一个ACL通常由若干条“permit/deny”语句组成，每条语句就是该ACL的一条规则。</p>
<p>▫规则编号：每条规则都有一个相应的编号，称为规则编号，用来标识ACL规则。可以自定义，也可以系统自动分配。ACL规则的编号范围是0～4294967294，所有规则均按照规则编号从小到大进行排序。</p>
<p>▫动作：每条规则中的permit或deny，就是与这条规则相对应的处理动作。permit指“允许”，deny指“拒绝”，但是ACL一般是结合其他技术使用，不同的场景，处理动作的含义也有所不同。</p>
<ul>
<li>比如：ACL如果与流量过滤技术结合使用（即流量过滤中调用ACL），permit就是“允许通行”的意思，deny就是“拒绝通行”的意思。</li>
</ul>
<p>▫匹配项：ACL定义了极其丰富的匹配项。例子中体现的源地址，ACL还支持很多其他规则匹配项。例如，二层以太网帧头信息（如源MAC、目的MAC、以太帧协议类型）、三层报文信息（如目的地址、协议类型）以及四层报文信息（如TCP/UDP端口号）等。</p>
</blockquote>
<h4 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/4.png"></p>
<p>匹配规则：</p>
<ul>
<li>“0”表示“匹配”；“1”表示“无需匹配”</li>
</ul>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/5.png"></p>
<blockquote>
<p>•当进行IP地址匹配的时候，后面会跟着32位掩码位，这32位称为通配符。</p>
<p>•通配符，也是点分十进制格式，换算成二进制后，“0”表示“匹配”，“1”表示“不匹配”。通配符中的1或者0可以不连续。</p>
<p>•具体看下这2条规则：</p>
<ul>
<li><p>rule 5: 拒绝源IP地址为10.1.1.1报文通过——因为通配符为全0，所以每一位都要严格匹配，因此匹配的是主机IP地址10.1.1.1；</p>
</li>
<li><p>rule 15:允许源IP地址为10.1.1.0/24网段地址的报文通过——因为通配符：0.0.0.11111111，后8位为1，表示不关心，因此10.1.1.xxxxxxxx 的后8位可以为任意值，所以匹配的是10.1.1.0/24网段。</p>
</li>
</ul>
<p>•例子：如果要精确匹配192.168.1.1/24这个IP地址对应的网段地址，通配符是多少？</p>
<ul>
<li>可以得出：网络位需要严格匹配，主机位无所谓，因此通配符为“0.0.0.255”。</li>
</ul>
<p>•两个特殊的通配符：</p>
<ul>
<li><p>当通配符全为0来匹配IP地址时，表示精确匹配某个IP地址；</p>
</li>
<li><p>当通配符全为1来匹配0.0.0.0地址时，表示匹配了所有IP地址。</p>
</li>
</ul>
</blockquote>
<h4 id="ACL的分类与基本ACL"><a href="#ACL的分类与基本ACL" class="headerlink" title="ACL的分类与基本ACL"></a>ACL的分类与基本ACL</h4><p>•基于ACL规则定义方式的划分</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/6.png"></p>
<p>•基本ACL</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/7.png"></p>
<blockquote>
<p>•对于使用ACL进行路由匹配的场景，用户只能使用基本ACL。</p>
</blockquote>
<h4 id="ACL的匹配机制"><a href="#ACL的匹配机制" class="headerlink" title="ACL的匹配机制"></a>ACL的匹配机制</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/8.png"></p>
<blockquote>
<p>•ACL的匹配机制概括来说就是：</p>
<ul>
<li><p>配置ACL的设备接收报文后，会将该报文与ACL中的规则逐条进行匹配，如果不能匹配上，就会继续尝试去匹配下一条规则。</p>
</li>
<li><p>一旦匹配上，则设备会对该报文执行这条规则中定义的处理动作，并且不再继续尝试与后续规则匹配。</p>
</li>
</ul>
<p>•匹配流程：首先系统会查找设备上是否配置了ACL。</p>
<ul>
<li><p>如果ACL不存在，则返回ACL匹配结果为：不匹配。</p>
</li>
<li><p>如果ACL存在，则查找设备是否配置了ACL规则。</p>
<ul>
<li>如果规则不存在，则返回ACL匹配结果为：不匹配。</li>
<li>如果规则存在，则系统会从ACL中编号最小的规则开始查找。<ul>
<li>如果匹配上了permit规则，则停止查找规则，并返回ACL匹配结果为：匹配（允许）。</li>
<li>如果匹配上了deny规则，则停止查找规则，并返回ACL匹配结果为：匹配（拒绝）。</li>
<li>如果未匹配上规则，则继续查找下一条规则，以此循环。如果一直查到最后一条规则，报文仍未匹配上，则返回ACL匹配结果为：不匹配。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>•从整个ACL匹配流程可以看出，报文与ACL规则匹配后，会产生两种匹配结果：“匹配”和“不匹配”。</p>
<ul>
<li><p>匹配（命中规则）：指存在ACL，且在ACL中查找到了符合匹配条件的规则。不论匹配的动作是“permit”还是“deny”，都称为“匹配”，而不是只是匹配上permit规则才算“匹配”。</p>
</li>
<li><p>不匹配（未命中规则）：指不存在ACL，或ACL中无规则，再或者在ACL中遍历了所有规则都没有找到符合匹配条件的规则。以上三种情况，都叫做“不匹配”。</p>
</li>
</ul>
<p>•匹配原则：一旦命中即停止匹配。</p>
</blockquote>
<h4 id="ACL的匹配顺序及匹配结果"><a href="#ACL的匹配顺序及匹配结果" class="headerlink" title="ACL的匹配顺序及匹配结果"></a>ACL的匹配顺序及匹配结果</h4><p>配置顺序（config模式）</p>
<p>▫系统按照ACL规则编号从小到大的顺序进行报文匹配，规则编号越小越容易被匹配。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/9.png"></p>
<blockquote>
<p>•一条ACL可以由多条“deny或permit”语句组成，每一条语句描述一条规则，这些规则可能存在包含关系，也可能有重复或矛盾的地方，因此ACL的匹配顺序是十分重要的。</p>
<p>•华为设备支持两种匹配顺序：自动排序（auto模式）和配置顺序（config模式）。缺省的ACL匹配顺序是config模式。</p>
<ul>
<li><p>自动排序，是指系统使用“深度优先”的原则，将规则按照精确度从高到低进行排序，并按照精确度从高到低的顺序进行报文匹配。——这个比较复杂，这里就不具体展开了，</p>
</li>
<li><p>配置顺序，系统按照ACL规则编号从小到大的顺序进行报文匹配，规则编号越小越容易被匹配。——这个就是前面提到的匹配顺序。</p>
<ul>
<li>如果后面又添加了一条规则，则这条规则会被加入到相应的位置，报文仍然会按照从小到大的顺序进行匹配。</li>
</ul>
</li>
</ul>
<p>•注意：ACL技术总是与其他技术结合在一起使用的，因此，所结合的技术不同，“允许 (permit)”及“拒绝 (deny)”的实际作用也会不同。例如，当ACL技术与路由过滤技术结合使用时，permit就是“匹配该条路由条目”的意思，deny就是“不匹配该条路由条目”的意思。</p>
</blockquote>
<h4 id="常用匹配举例"><a href="#常用匹配举例" class="headerlink" title="常用匹配举例"></a>常用匹配举例</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/10.png"></p>
<h4 id="基本ACL的基础配置命令"><a href="#基本ACL的基础配置命令" class="headerlink" title="基本ACL的基础配置命令"></a>基本ACL的基础配置命令</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/11.png"></p>
<blockquote>
<p>•创建基本ACL</p>
<p>•[Huawei] <strong>acl</strong> [ <strong>number</strong> ] <em>acl-number</em> [ <strong>match-order</strong> <strong>config</strong> ]</p>
<ul>
<li><p><em>acl-number</em>：指定访问控制列表的编号。</p>
</li>
<li><p><strong>match-order</strong> <strong>config</strong>：指定ACL规则的匹配顺序，config表示配置顺序。</p>
</li>
</ul>
<p>•[Huawei] <strong>acl</strong> <strong>name</strong> <em>acl-name</em> { <strong>basic</strong> | <em>acl-number</em> } [ <strong>match-order</strong> <strong>config</strong> ]</p>
<ul>
<li><p><em>acl-name</em>：指定创建的ACL的名称。</p>
</li>
<li><p><strong>basic</strong>：指定ACL的类型为基本ACL。</p>
</li>
</ul>
<p>•配置基本ACL规则</p>
<p>•[Huawei-acl-basic-2000] <strong>rule</strong> [ <em>rule-id</em> ] { <strong>deny</strong> | <strong>permit</strong> } [ <strong>source</strong> { <em>source-address source-wildcard</em> | <strong>any</strong> } | <strong>time-range</strong> <em>time-name</em> ] </p>
<ul>
<li><p><em>rule-id</em>：指定ACL的规则ID。</p>
</li>
<li><p><strong>deny</strong>：指定拒绝符合条件的报文。</p>
</li>
<li><p><strong>permit</strong>：指定允许符合条件的报文。</p>
</li>
<li><p><strong>source</strong> { <em>source-address source-wildcard</em> | <strong>any</strong> }：指定ACL规则匹配报文的源地址信息。如果不配置，表示报文的任何源地址都匹配。其中：</p>
<ul>
<li><em>source-address</em>：指定报文的源地址。</li>
<li><em>source-wildcard</em>：指定源地址通配符。</li>
<li><strong>any</strong>：表示报文的任意源地址。相当于source-address为0.0.0.0或者source-wildcard为255.255.255.255。</li>
</ul>
</li>
<li><p><strong>time-range</strong> <em>time-name</em>：指定ACL规则生效的时间段。其中，time-name表示ACL规则生效时间段名称。如果不指定时间段，表示任何时间都生效。</p>
</li>
</ul>
</blockquote>
<h3 id="匹配工具2：IP前缀列表"><a href="#匹配工具2：IP前缀列表" class="headerlink" title="匹配工具2：IP前缀列表"></a>匹配工具2：IP前缀列表</h3><p>•IP前缀列表（IP-Prefix List）是将路由条目的网络地址、掩码长度作为匹配条件的过滤器，可在各路由协议发布和接收路由时使用。</p>
<p>•不同于ACL，IP-Prefix List能够同时匹配IP地址前缀长度以及掩码长度，增强了匹配的精确度。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/12.png"></p>
<p>1、<strong>ip-prefix-name</strong>：地址前缀列表名称<br>2、<strong>序号</strong>：本匹配项在地址前缀列表中的序号，匹配时根据序号从小到大进行顺序匹配<br>3、<strong>动作</strong>：permit/deny，地址前缀列表的匹配模式为允许/拒绝，表示匹配/不匹配<br>4、<strong>IP网段与掩码</strong>：匹配路由的网络地址，以及限定网络地址的前多少位需严格匹配<br>5、<strong>掩码范围</strong>：匹配路由前缀长度，掩码长度的匹配范围 mask-length&lt;=greater-equal-value&lt;=less-equal-value&lt;=32</p>
<h4 id="IP-Prefix的匹配机制"><a href="#IP-Prefix的匹配机制" class="headerlink" title="IP-Prefix的匹配机制"></a>IP-Prefix的匹配机制</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/13.png"></p>
<h4 id="IP-Prefix的匹配示例"><a href="#IP-Prefix的匹配示例" class="headerlink" title="IP-Prefix的匹配示例"></a>IP-Prefix的匹配示例</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/14.png"></p>
<h4 id="IP-Prefix的基础配置命令"><a href="#IP-Prefix的基础配置命令" class="headerlink" title="IP-Prefix的基础配置命令"></a>IP-Prefix的基础配置命令</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/15.png"></p>
<blockquote>
<p>•<strong>ip-prefix-name</strong>：指定地址前缀列表的名称。字符串形式，长度范围是1～169，不支持空格，区分大小写。</p>
<p>•<strong>index</strong> <em>index-number</em>：指定本匹配项在地址前缀列表中的序号。整数形式，取值范围是1～4294967295。缺省情况下，该序号值按照配置先后顺序依次递增，每次加10，第一个序号值为10。</p>
<p>•<strong>permit</strong>：指定地址前缀列表的匹配模式为允许。在该模式下，如果过滤的IP地址在定义的范围内，则通过过滤，进行相应的设置；否则，必须进行下一节点的测试。</p>
<p>•<strong>deny</strong>：指定地址前缀列表的匹配模式为拒绝。在该模式下，如果过滤的IP地址在定义的范围内，该IP地址不能通过过滤从而不能进入下一节点的测试；否则，将进行下一节点的测试。</p>
<p>•<em>ipv4-address mask-length</em>：指定IP地址和指定掩码长度。其中掩码长度为整数形式，取值范围是0～32。</p>
<p>•<strong>greater-equal</strong> <em>greater-equal-value</em>：指定掩码长度匹配范围的下限。若不配置<strong>greater-equal</strong> <em>greater-equal-value</em>和<strong>less-equal</strong> <em>less-equal-value</em>，则使用mask-length作为掩码长度。 </p>
<ul>
<li><p>参数<em>greater-equal-value</em>的取值限制为：<em>mask-length</em>&lt;=<em>greater-equal-value</em>&lt;=<em>less-equal-value</em>&lt;=32。</p>
</li>
<li><p>如果只配置了<strong>greater-equal</strong>，则掩码长度范围在<em>greater-equal-value</em>和32之间。</p>
</li>
</ul>
<p>•<strong>less-equal</strong> <em>less-equal-value</em>：指定掩码长度匹配范围的上限。若不配置<strong>greater-equal</strong> <em>greater-equal-value</em>和<strong>less-equal</strong> <em>less-equal-value</em>，则使用<em>mask-length</em>作为掩码长度。</p>
<ul>
<li><p>参数less-equal-value的取值限制为：<em>mask-length</em>&lt;=<em>greater-equal-value</em>&lt;=<em>less-equal-value</em>&lt;=32<em>。</em></p>
</li>
<li><p>如果只配置了<strong>less-equal</strong>，则掩码长度范围在<em>mask-length</em>和<em>less-equal-value</em>之间。</p>
</li>
</ul>
</blockquote>
<h4 id="IP-Prefix的配置举例-1"><a href="#IP-Prefix的配置举例-1" class="headerlink" title="IP-Prefix的配置举例 (1)"></a>IP-Prefix的配置举例 (1)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/16.png"></p>
<blockquote>
<p>•Case1说明：这种情况属于单节点的精确匹配，只有目的地址，掩码完全相同的路由才会匹配成功，而且节点的匹配模式为Permit，所以路由10.1.1.0/24被Permit，属于匹配成功并被Permit，其他路由由于未匹配成功被Deny。</p>
<p>•Case2说明：这种情况属于单节点的精确匹配，但节点的匹配模式为deny，所以路由10.1.1.0/24还是被Deny，属于匹配成功但被Deny，其他路由则属于未匹配成功被默认Deny。</p>
</blockquote>
<h4 id="IP-Prefix的配置举例-2"><a href="#IP-Prefix的配置举例-2" class="headerlink" title="IP-Prefix的配置举例 (2)"></a>IP-Prefix的配置举例 (2)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/17.png"></p>
<blockquote>
<p>•Case1说明：这种情况属于多节点的精确匹配。</p>
<ul>
<li><p>路由10.1.1.0/24在匹配index 10时，满足匹配条件，但匹配模式是deny，属于匹配成功但被Deny。</p>
</li>
<li><p>路由10.1.1.1/32在匹配index 10时，不满足匹配条件，则继续匹配index 20，此时匹配成功，且index 20的匹配模式是permit，属于匹配成功并被Permit。</p>
</li>
<li><p>其他路由由于都不符合index 10和20的条件，属于未匹配成功被默认Deny。</p>
</li>
</ul>
<p>•Case2说明：此时<em>greater-equal-value</em>=26，<em>less-equal-value</em>=32。配置时，需满足<em>mask-length</em>&lt;=<em>greater-equal-value</em>&lt;=<em>less-equal-value</em>，否则配置不成功。</p>
</blockquote>
<h4 id="IP-Prefix的配置举例-3"><a href="#IP-Prefix的配置举例-3" class="headerlink" title="IP-Prefix的配置举例 (3)"></a>IP-Prefix的配置举例 (3)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/18.png"></p>
<blockquote>
<p>•Case1说明：此时<em>greater-equal-value</em>=8，<em>less-equal-value</em>=32，前8个bit与10.0.0.0相同，掩码长度在8-32之间的路由全部被匹配。</p>
<p>•Case2说明：</p>
<ul>
<li><p>对于index 10，<em>greater-equal-value</em>=24，<em>less-equal-value</em>=32，前24个bit与10.1.1.0相同，所有掩码长度在24到32的路由全部被Deny；</p>
</li>
<li><p>对于index 20，<em>greater-equal-value</em>=0，<em>less-equal-value</em>=32，前16个bit与10.1.0.0相同，掩码长度在16到32的路由被匹配，此时只有10.1.0.0/16被匹配，剩下的被默认deny。</p>
</li>
</ul>
</blockquote>
<h2 id="路由策略工具"><a href="#路由策略工具" class="headerlink" title="路由策略工具"></a>路由策略工具</h2><h3 id="策略工具1：Filter-Policy"><a href="#策略工具1：Filter-Policy" class="headerlink" title="策略工具1：Filter-Policy"></a>策略工具1：Filter-Policy</h3><p>•Filter-Policy（过滤-策略）是一个很常用的路由信息过滤工具，能够对接收、发布、引入的路由进行过滤，可应用于IS-IS、OSPF、BGP等协议。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/19.png"></p>
<p>•如图所示，R1、R2、R3之间运行BGP路由协议，路由在各个设备之间传递，当需要根据实际需求过滤某些路由信息的时候可以使用Filter-Policy实现。</p>
<h4 id="Filter-Policy在距离矢量路由协议中的应用"><a href="#Filter-Policy在距离矢量路由协议中的应用" class="headerlink" title="Filter-Policy在距离矢量路由协议中的应用"></a>Filter-Policy在距离矢量路由协议中的应用</h4><p>在距离矢量路由协议中，设备之间传递的是路由信息，如果需要对这种路由信息进行某种过滤，可以使用Filter-Policy实现，出方向和入方向的生效位置如图所示。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/20.png"></p>
<blockquote>
<p>•距离矢量协议是基于路由表生成路由的，因此过滤器会影响从邻居接收的路由和向邻居发布的路由。</p>
<p>•如果要过滤掉上游设备到下游设备的路由，只需要在上游设备配置filter-policy export或者在下游设备上配置filter-policy import。</p>
</blockquote>
<h4 id="Filter-Policy在链路状态路由协议中的应用"><a href="#Filter-Policy在链路状态路由协议中的应用" class="headerlink" title="Filter-Policy在链路状态路由协议中的应用"></a>Filter-Policy在链路状态路由协议中的应用</h4><p>在链路状态路由协议中，各路由设备之间传递的是LSA信息，然后设备根据LSA汇总成的LSDB信息计算出路由表。但是Filter-Policy只能过滤路由信息，无法过滤LSA。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/21.png"></p>
<blockquote>
<p>•OSPF把网络中所泛洪的LSA存储到自己的LSDB中，并且运行SPF算法，计算出一颗以自己为根，无环的最短路径树，Filter-Policy对OSPF计算出来的路由（加载到路由表之前）进行过滤，而不会对LSA进行过滤。</p>
<p>•上面的实例以OSPF为例，展示了Filter-Policy在链路状态中的应用。</p>
</blockquote>
<h4 id="Filter-Policy的基础配置命令-1"><a href="#Filter-Policy的基础配置命令-1" class="headerlink" title="Filter-Policy的基础配置命令 (1)"></a>Filter-Policy的基础配置命令 (1)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/22.png"></p>
<blockquote>
<p>命令：[Huawei-ospf-100] <strong>filter-policy</strong> { acl-number | <strong>acl-name</strong> acl-name | <strong>ip-prefix</strong> ip-prefix-name | <strong>route-policy</strong> route-policy-name [ <strong>secondary</strong> ] } <strong>import</strong></p>
<ul>
<li>acl-number：指定基本访问控制列表号。整数形式，取值范围是2000～2999。</li>
<li><strong>acl-name</strong> acl-name：指定访问控制列表名称。字符串形式，不支持空格，区分大小写，长度范围是1～32，以英文字母a～z或A～Z开始。</li>
<li><strong>ip-prefix</strong> ip-prefix-name：指定地址前缀列表名称。字符串形式，长度范围是1～169，不支持空格，区分大小写。当输入的字符串两端使用双引号时，可在字符串中输入空格。</li>
<li><strong>route-policy</strong> route-policy-name：指定路由策略名称。字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</li>
<li><strong>secondary</strong>：设置优选次优路由。</li>
</ul>
<p>命令：[Huawei-ospf-100] <strong>filter-policy</strong> { acl-number | <strong>acl-name</strong> acl-name | <strong>ip-prefix</strong> ip-prefix-name | <em>9</em>route-policy** route-policy-name } <strong>export</strong> [ protocol [ process-id ] ]</p>
<ul>
<li>protocol process-id：指定需要对引入的特定的路由协议进行过滤。目前的协议包括direct、isis、bgp、ospf、unr和static。当指定路由协议为RIP、IS-IS、OSPF时，还可以指定进程号。整数类型，取值范围是1～65535，缺省值是1。</li>
</ul>
</blockquote>
<h4 id="Filter-Policy的基础配置命令-2"><a href="#Filter-Policy的基础配置命令-2" class="headerlink" title="Filter-Policy的基础配置命令 (2)"></a>Filter-Policy的基础配置命令 (2)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/23.png"></p>
<h4 id="Filter-Policy的基础配置命令-3"><a href="#Filter-Policy的基础配置命令-3" class="headerlink" title="Filter-Policy的基础配置命令 (3)"></a>Filter-Policy的基础配置命令 (3)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/24.png"></p>
<h4 id="OSPF中使用Filter-Policy"><a href="#OSPF中使用Filter-Policy" class="headerlink" title="OSPF中使用Filter-Policy"></a>OSPF中使用Filter-Policy</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/25.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/26.png"></p>
<blockquote>
<p>•OSPF的路由信息记录在LSDB中，<strong>filter-policy import</strong>命令实际上是对OSPF计算出来的路由进行过滤，不是对发布和接收的LSA进行过滤。</p>
<p>•<strong>filter-policy export</strong>命令通过指定<em>protocol</em>或<em>process-id</em>对特定的某一种协议或某一进程的路由进行过滤。如果没有指定<em>protocol</em>和<em>process-id</em>，则OSPF将对所有引入的路由信息进行过滤。</p>
</blockquote>
<h4 id="IS-IS中使用Filter-Policy"><a href="#IS-IS中使用Filter-Policy" class="headerlink" title="IS-IS中使用Filter-Policy"></a>IS-IS中使用Filter-Policy</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/27.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/28.png"></p>
<blockquote>
<p>•IS-IS的路由表项需要被成功下发到IP路由表中，才能用来指导IP报文转发。如果IS-IS路由表中有到达某个目的网段的路由，但是并不希望将该路由下发到IP路由表中，可以使用<strong>filter-policy import</strong>命令结合基本ACL、IP-Prefix、路由策略等方式，只将部分IS-IS路由下发到IP路由表中。</p>
</blockquote>
<h4 id="BGP中使用Filter-Policy"><a href="#BGP中使用Filter-Policy" class="headerlink" title="BGP中使用Filter-Policy"></a>BGP中使用Filter-Policy</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/29.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/30.png"></p>
<h3 id="策略工具2：Route-Policy"><a href="#策略工具2：Route-Policy" class="headerlink" title="策略工具2：Route-Policy"></a>策略工具2：Route-Policy</h3><p>•Route-Policy是一个策略工具，用于过滤路由信息，以及为过滤后的路由信息设置路由属性。</p>
<p>•一个Route-Policy由一个或多个节点（Node）构成，每个节点都可以是一系列条件语句（匹配条件）以及执行语句（执行动作）的集合，这些集合按照编号从小到大的顺序排列。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/31.png"></p>
<p>•每个节点内可包含多个条件语句。节点内的多个条件语句之间的关系为“与”，即匹配所有条件语句才会执行本节点内的动作。</p>
<p>•节点之间的关系为“或”，route-policy根据节点编号大小从小到大顺序执行，匹配中一个节点将不会继续向下匹配。</p>
<blockquote>
<p>•当使用Route-Policy时，Node的值小的节点先进行匹配。一个节点匹配成功后，路由将不再匹配其他节点。全部节点匹配失败后，路由将被过滤。</p>
</blockquote>
<h4 id="Route-Policy的组成"><a href="#Route-Policy的组成" class="headerlink" title="Route-Policy的组成"></a>Route-Policy的组成</h4><p>一个Route-Policy由一个或多个节点构成，每个节点包括多个if-match和apply子句。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/32.png"></p>
<p>•permit或deny：指定Route-Policy节点的匹配模式为允许或拒绝。</p>
<p>•node：指定Route-Policy的节点号。整数形式，取值范围是0～65535。</p>
<p>•if-match子句：定义该节点的匹配条件。</p>
<p>•apply子句：定义针对被匹配路由执行的操作。</p>
<h4 id="Route-Policy的匹配顺序"><a href="#Route-Policy的匹配顺序" class="headerlink" title="Route-Policy的匹配顺序"></a>Route-Policy的匹配顺序</h4><p>路由策略使用不同的匹配条件和匹配模式选择路由和改变路由属性。</p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/33.png"></p>
<blockquote>
<p>•一个路由策略中包含N（N&gt;=1）个节点（Node）。路由进入路由策略后，按节点序号从小到大依次检查各个节点是否匹配。匹配条件由If-match子句定义。</p>
<ul>
<li><p>当路由与该节点的所有If-match子句都匹配成功后，进入匹配模式选择，不再匹配其他节点。匹配模式分permit和deny两种：</p>
<ul>
<li><p>permit：路由将被允许通过，并且执行该节点的apply子句对路由信息的一些属性进行设置。</p>
</li>
<li><p>deny：路由将被拒绝通过。</p>
</li>
</ul>
</li>
<li><p>当路由与该节点的任意一个If-match子句匹配失败后，进入下一节点。如果和所有节点都匹配失败，路由信息将被拒绝通过。</p>
</li>
</ul>
</blockquote>
<h4 id="Route-Policy的基础配置命令-1"><a href="#Route-Policy的基础配置命令-1" class="headerlink" title="Route-Policy的基础配置命令 (1)"></a>Route-Policy的基础配置命令 (1)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/34.png"></p>
<blockquote>
<p>•命令：<strong>route-policy</strong> <em>route-policy-name</em> { <strong>permit</strong> | <strong>deny</strong> } <strong>node</strong> <em>node</em></p>
<ul>
<li><p><strong>permit</strong>：指定Route-Policy节点的匹配模式为允许。如果路由与节点所有的if-match子句匹配成功，则执行此节点apply子句；否则，进行下一节点。</p>
</li>
<li><p><strong>deny</strong>：指定Route-Policy节点的匹配模式为拒绝。如果路由与节点所有的if-match子句匹配成功，则该路由将被拒绝通过；否则进行下一节点。</p>
</li>
<li><p><strong>node</strong> <em>node</em>：指定Route-Policy的节点号。当使用Route-Policy时，node的值小的节点先进行匹配。一个节点匹配成功后，路由将不再匹配其他节点。全部节点匹配失败后，路由将被过滤。整数形式，取值范围是0～65535。</p>
</li>
</ul>
</blockquote>
<h4 id="Route-Policy的基础配置命令-2"><a href="#Route-Policy的基础配置命令-2" class="headerlink" title="Route-Policy的基础配置命令 (2)"></a>Route-Policy的基础配置命令 (2)</h4><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/35.png"></p>
<blockquote>
<p>•apply子句用来为路由策略指定动作，用来设置匹配成功的路由的属性。在一个节点中，如果没有配置apply子句，则该节点仅起过滤路由的作用。如果配置一个或多个apply子句，则通过节点匹配的路由将执行所有apply子句。</p>
</blockquote>
<h1 id="3-路由控制案例"><a href="#3-路由控制案例" class="headerlink" title="3.路由控制案例"></a>3.路由控制案例</h1><h2 id="对接收的路由进行过滤"><a href="#对接收的路由进行过滤" class="headerlink" title="对接收的路由进行过滤"></a>对接收的路由进行过滤</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/36.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/37.png"></p>
<blockquote>
<p>•通过Filter-Policy进行路由过滤，只影响本地的路由表，因此R3可以正常学习到192.168.1.0/24网段的路由。</p>
</blockquote>
<h2 id="对发布的路由进行过滤"><a href="#对发布的路由进行过滤" class="headerlink" title="对发布的路由进行过滤"></a>对发布的路由进行过滤</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/38.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/39.png"></p>
<h2 id="修改路由属性"><a href="#修改路由属性" class="headerlink" title="修改路由属性"></a>修改路由属性</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/40.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/41.png"></p>
<h2 id="双点双向路由重发布"><a href="#双点双向路由重发布" class="headerlink" title="双点双向路由重发布"></a>双点双向路由重发布</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/42.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/myblog\zsyblog\source_posts\IP-路由策略与路由控制\43.png"></p>
<h2 id="次优路径问题"><a href="#次优路径问题" class="headerlink" title="次优路径问题"></a>次优路径问题</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/44.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/45.png"></p>
<h2 id="解决次优路径问题-1"><a href="#解决次优路径问题-1" class="headerlink" title="解决次优路径问题 (1)"></a>解决次优路径问题 (1)</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/46.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/47.png"></p>
<h2 id="解决次优路径问题-2"><a href="#解决次优路径问题-2" class="headerlink" title="解决次优路径问题 (2)"></a>解决次优路径问题 (2)</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/48.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/49.png"></p>
<h2 id="路由环路问题"><a href="#路由环路问题" class="headerlink" title="路由环路问题"></a>路由环路问题</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/50.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/51.png"></p>
<h3 id="解决路由环路问题-1"><a href="#解决路由环路问题-1" class="headerlink" title="解决路由环路问题 (1)"></a>解决路由环路问题 (1)</h3><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/52.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/53.png"></p>
<h3 id="解决路由环路问题-2"><a href="#解决路由环路问题-2" class="headerlink" title="解决路由环路问题 (2)"></a>解决路由环路问题 (2)</h3><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/54.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/55.png"></p>
<h3 id="解决路由环路问题-3"><a href="#解决路由环路问题-3" class="headerlink" title="解决路由环路问题 (3)"></a>解决路由环路问题 (3)</h3><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/56.png"></p>
<p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/57.png"></p>
<h2 id="场景思考"><a href="#场景思考" class="headerlink" title="场景思考"></a>场景思考</h2><p><img src="/2021/05/16/IP-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E4%B8%8E%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6/58.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）Filter-Policy export在OSPF、BGP中的作用分别是？</p>
<p><strong>在OSPF中的作用为过滤从其他路由协议引入到OSPF中的路由条目；在BGP中的作用为限制本地对外发布的路由条目。</strong></p>
<p>2.（简答题）Route-Policy多个节点之间的逻辑关系为？一个节点内多个条件语句的逻辑关系为？</p>
<p><strong>节点之间的逻辑关系为或，条件语句间的逻辑关系为与。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•控制路由的发布、接收时需要先将相应的路由使用匹配器进行抓取，最常见的匹配器有ACL、 IP-Prefix List 。</p>
<p>•Filter-Policy、Route-Policy都可用来在发布、接收路由时进行过滤，但需要注意在链路状态路由协议中使用Filter-Policy并不能正常的过滤链路状态信息，只是影响了本地的路由表。</p>
<p>•Route-Policy在发布、接收路由时可以对路由的属性进行灵活地修改，以实现XXX。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/mydog.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zsy9959" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zsy9959@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张思宇</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
