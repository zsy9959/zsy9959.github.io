<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="my blog">
<meta property="og:type" content="website">
<meta property="og:title" content="zsy&#39;s blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="zsy&#39;s blog">
<meta property="og:description" content="my blog">
<meta property="og:locale">
<meta property="article:author" content="张思宇">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/page/2/"/>





  <title>zsy's blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zsy's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">just simple</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/home" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/30/IPadv-%E7%BD%91%E7%BB%9C%E5%89%B2%E6%8E%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/30/IPadv-%E7%BD%91%E7%BB%9C%E5%89%B2%E6%8E%A5/" itemprop="url">IPadv-网络割接</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-30T13:47:55+08:00">
                2021-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/30/IPadv-%E7%BD%91%E7%BB%9C%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/30/IPadv-%E7%BD%91%E7%BB%9C%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4/" itemprop="url">IPadv-网络故障排除</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-30T13:47:46+08:00">
                2021-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/30/IPadv-%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/30/IPadv-%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4/" itemprop="url">IPadv-网络运维</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-30T13:47:37+08:00">
                2021-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/" itemprop="url">IPadv-IPv6路由</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-30T12:56:13+08:00">
                2021-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/IPv6%E8%B7%AF%E7%94%B1.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•随着万物互联时代的到来，IPv4地址空间不足，IPv6取代IPv4势在必行。那么如何实现IPv6网络中各个节点之间的可达性呢？与IPv4网络相同，IPv6网络同样支持静态路由和动态路由协议。</p>
<p>•IPv6静态路由与IPv4静态路由在配置方式上颇为相似。为了实现对IPv6网络的支持，IETF制定了OSPFv3，同时对IS-IS、BGP做了扩展。</p>
<p>•本课程将介绍IPv6静态路由的概念及配置，还会介绍常见的IPv6动态路由协议，包括：OSPFv3，IS-IS（IPv6），以及BGP4+。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫实现IPv6静态路由的配置</p>
<p>▫分析OSPFv3与OSPFv2的不同点</p>
<p>▫实现OSPFv3的基本配置</p>
<p>▫描述IS-IS对IPv6的扩展</p>
<p>▫实现IS-IS（IPv6）的基本配置</p>
<p>▫描述BGP对IPv6的扩展</p>
<p>▫实现BGP4+的基本配置</p>
<h1 id="1-IPv6静态路由"><a href="#1-IPv6静态路由" class="headerlink" title="1.IPv6静态路由"></a>1.IPv6静态路由</h1><h2 id="IPv6静态路由"><a href="#IPv6静态路由" class="headerlink" title="IPv6静态路由"></a>IPv6静态路由</h2><p>•IPv6静态路由与IPv4静态路由类似，也需要管理员手工配置，适合于一些结构比较简单的IPv6网络。</p>
<p>•在创建IPv6静态路由时，可以同时指定出接口和下一跳，或者只指定出接口或只指定下一跳。</p>
<p>​    ▫对于点到点接口：指定出接口。</p>
<p>​    ▫对于广播类型接口：指定下一跳。</p>
<p>•IPv6静态路由负载分担和备份：</p>
<p>​    ▫在创建相同目的地址的多条IPv6静态路由时，如果指定相同优先级，则可实现负载分担，如果指定不同优先级，则可实现路由备份。</p>
<blockquote>
<p>•IPv6静态路由与IPv4静态路由之间的主要区别是目的地址和下一跳地址有所不同，IPv6静态路由使用的是IPv6地址，而IPv4静态路由使用IPv4地址。</p>
</blockquote>
<h2 id="IPv6静态路由的基础配置命令"><a href="#IPv6静态路由的基础配置命令" class="headerlink" title="IPv6静态路由的基础配置命令"></a>IPv6静态路由的基础配置命令</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/1.png"></p>
<blockquote>
<p>•[Huawei] <strong>ipv6</strong> <strong>route-static</strong> <em>dest-ipv6-address</em> <em>prefix-length</em> { <em>interface-type</em> <em>interface-number</em> [ <em>nexthop-ipv6-address</em> ] | <em>nexthop-ipv6-address</em> | <strong>vpn-instance</strong> <em>vpn-destination-name</em> <em>nexthop-ipv6-address</em> } [ <strong>preference</strong> <em>preference</em>]  [ <strong>permanent</strong> | <strong>inherit-cost</strong> ] [ <strong>description</strong> <em>text</em> ]</p>
<ul>
<li><strong>preference</strong> <em>preference</em>：指定路由优先级。整数形式，取值范围为1～255。缺省值是60。</li>
<li><strong>permanent</strong>：指定IPv6静态路由永久发布。</li>
<li><strong>inherit-cost</strong>：指定IPv6静态路由继承迭代路由的开销值。</li>
<li><strong>description</strong> <em>text</em>：指定静态路由的描述信息。字符串形式，支持空格，长度范围是1～80。</li>
</ul>
<p>•[Huawei] <strong>ipv6</strong> <strong>route-static</strong> <strong>vpn-instance</strong> <em>vpn-instance-name</em> <em>dest-ipv6-address</em> <em>prefix-length</em> { [ <em>interface-type</em> <em>interface-number</em> [ <em>nexthop-ipv6-address</em> ] ] | <em>nexthop-ipv6-address</em> [ <strong>public</strong> ] | <strong>vpn**</strong>-instance** <em>vpn*</em>-destination-name* <em>nexthop-ipv6-address</em> } [ <strong>preference</strong> <em>preference</em> ] [ <strong>permanent</strong> | <strong>inherit-cost</strong> ] [ <strong>description</strong> <em>text</em> ]</p>
<ul>
<li><strong>public</strong>：指定<em>nexthop-ipv6-address</em>是公网地址，而不是源VPN中的地址。</li>
</ul>
</blockquote>
<h2 id="IPv6静态路由配置举例"><a href="#IPv6静态路由配置举例" class="headerlink" title="IPv6静态路由配置举例"></a>IPv6静态路由配置举例</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/2.png"></p>
<h1 id="2-OSPFv3原理与配置"><a href="#2-OSPFv3原理与配置" class="headerlink" title="2.OSPFv3原理与配置"></a>2.OSPFv3原理与配置</h1><h2 id="OSPFv3的基本工作原理"><a href="#OSPFv3的基本工作原理" class="headerlink" title="OSPFv3的基本工作原理"></a>OSPFv3的基本工作原理</h2><h3 id="OSPFv3概述"><a href="#OSPFv3概述" class="headerlink" title="OSPFv3概述"></a>OSPFv3概述</h3><p>•OSPF是IETF定义的一种基于链路状态的内部网关路由协议。目前针对IPv4协议使用的是OSPF Version 2（OSPFv2），针对IPv6协议使用OSPF Version 3（OSPFv3）。</p>
<p>•OSPFv3的主要目的是开发一种独立于任何具体网络层的路由协议。为实现这一目的，OSPFv3的内部路由器信息被重新进行了设计。</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/3.png"></p>
<h3 id="OSPFv3与OSPFv2的相同点"><a href="#OSPFv3与OSPFv2的相同点" class="headerlink" title="OSPFv3与OSPFv2的相同点"></a>OSPFv3与OSPFv2的相同点</h3><p>OSPF的基本运行机制没有改变，包括：</p>
<p>▫基本概念：</p>
<p>​    ▪区域划分及路由器类型</p>
<p>​    ▪路由计算影响参数：优先级、度量值</p>
<p>​    ▪支持的网络类型：Broadcast（广播类型）、NBMA、P2P（点到点类型）、P2MP（点到多点类型）</p>
<p>​    ▪报文类型：Hello报文、DD报文、LSR报文、LSU报文和LSAck报文</p>
<p>▫工作原理：</p>
<p>​    ▪邻居关系的建立及邻居状态的转换</p>
<p>​    ▪DR与BDR的选举</p>
<p>​    ▪LSA泛洪机制</p>
<p>​    ▪路由计算过程</p>
<blockquote>
<p>•相同点还包括：对特殊区域、虚连接、多进程的支持等。</p>
<p>•本课程对以上内容不再赘述，详细内容请参考《HCIP-Datacom-Core Technology》课程。</p>
</blockquote>
<h3 id="OSPFv3拓扑和路由器类型"><a href="#OSPFv3拓扑和路由器类型" class="headerlink" title="OSPFv3拓扑和路由器类型"></a>OSPFv3拓扑和路由器类型</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/4.png"></p>
<h3 id="OSPFv3的基本工作原理与OSPFv2相似"><a href="#OSPFv3的基本工作原理与OSPFv2相似" class="headerlink" title="OSPFv3的基本工作原理与OSPFv2相似"></a>OSPFv3的基本工作原理与OSPFv2相似</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/5.png"></p>
<h3 id="OSPFv3与OSPFv2的不同点"><a href="#OSPFv3与OSPFv2的不同点" class="headerlink" title="OSPFv3与OSPFv2的不同点"></a>OSPFv3与OSPFv2的不同点</h3><p>•OSPFv3基于链路运行以及拓扑计算，而不再是网段。</p>
<p>•OSPFv3支持一个链路上多个实例。</p>
<p>•OSPFv3报文和LSA中去掉了IP地址的意义，且重构了报文格式和LSA格式。</p>
<p>​    ▫OSPFv3报文和Router LSA/Network LSA中不包含IP地址。</p>
<p>​    ▫OSPFv3的LSA中定义了LSA的泛洪范围。</p>
<p>​    ▫OSPFv3中创建了新的LSA承载IPv6地址和前缀。</p>
<p>​    ▫OSPFv3邻居不再由IP地址标识，只由Router ID标识。</p>
<h3 id="唯一邻居标识：Router-ID"><a href="#唯一邻居标识：Router-ID" class="headerlink" title="唯一邻居标识：Router ID"></a>唯一邻居标识：Router ID</h3><p>OSPFv3通过Router ID来标识网络设备。</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/6.png"></p>
<blockquote>
<p>•OSPFv2在Broadcast、NBMA、P2P和P2MP网络中是通过IPv4接口地址来标识邻居，而在虚连接网络中是通过Router ID来标识邻居。</p>
</blockquote>
<h3 id="OSPFv3基于链路运行"><a href="#OSPFv3基于链路运行" class="headerlink" title="OSPFv3基于链路运行"></a>OSPFv3基于链路运行</h3><p>OSPFv3是基于链路运行的，设备只要在同一链路，就可以建立邻居关系。</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/7.png"></p>
<blockquote>
<p>•IPv6中重点强调了链路的概念，在IPv6中，一个链路上可以分配多个IP子网，也就是IPv6前缀。和IPv4不同的是，同一个链路上的两个节点即使不具有相同的IPv6前缀，也可以直接通过这个链路通信。这一点极大地改变了OSPF的行为。</p>
<p>•在OSPFv3中我们更多的是使用“链路”和“前缀”这两个术语。但这两个概念是分离的，没有必然的对应关系，所以在讨论路由协议时，OSPFv2的术语“网络”和“子网”在这里应该用“链路”替换掉。</p>
</blockquote>
<h3 id="链路支持多实例"><a href="#链路支持多实例" class="headerlink" title="链路支持多实例"></a>链路支持多实例</h3><p>•一个OSPFv3物理接口可以和多个实例绑定，并用不同的实例标识（Instance ID）区分，即OSPFv3的单个链路支持运行多个OSPFv3实例。</p>
<p>•这些运行在同一条物理链路上的多个OSPFv3实例，分别与链路对端设备建立邻居及发送报文，且互不干扰，这样可以充分共享同一链路资源。</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/8.png"></p>
<blockquote>
<p>•多实例通过在OSPFv3报文头部增加一个Instance ID区别不同的实例来实现。一个分配了给定Instance ID的实例，将会丢弃那些与该Instance ID不匹配的OSPFv3报文。</p>
</blockquote>
<h3 id="OSPFv3对链路本地地址的使用"><a href="#OSPFv3对链路本地地址的使用" class="headerlink" title="OSPFv3对链路本地地址的使用"></a>OSPFv3对链路本地地址的使用</h3><p>•OSPFv3使用链路本地（FE80::/10）地址作为发送报文的源地址和路由的下一跳地址。</p>
<ul>
<li>使用链路本地地址来维持邻居关系，同步LSA数据库。</li>
<li>在虚连接上，必须使用全球单播地址或者站点本地地址作为OSPFv3协议报文的源地址。</li>
</ul>
<p>•优势：</p>
<ul>
<li>不需要配置IPv6全球单播地址，就可以得到OSPFv3拓扑，实现拓扑与地址分离。</li>
<li>OSPFv3报文不会被转发到始发链路范围之外，减少了报文不必要的泛洪，节省了带宽。</li>
</ul>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/9.png"></p>
<blockquote>
<p>•IPv6使用链路本地（Link-Local）地址在同一链路上发现邻居及自动配置。运行IPv6的路由器不转发目的地址为链路本地地址的IPv6报文，此类报文只在同一链路有效。</p>
<p>•OSPFv3是运行在IPv6上的路由协议，使用链路本地地址来发送OSPFv3报文。</p>
<ul>
<li><p>OSPFv3假定每个路由器在每个连接的链路上都已被分配链路本地地址，在除虚连接外的所有OSPFv3接口上使用接口关联的链路本地地址作为源地址发送OSPFv3报文。</p>
</li>
<li><p>路由器学习所有其他连接到该链路上的路由器的链路本地地址，并且使用这些地址作为下一跳进行报文转发。</p>
</li>
<li><p>注意：关于链路本地地址的描述仅出现在Link-LSA（链路LSA，OSPFv3新增LSA）中。</p>
</li>
</ul>
</blockquote>
<h3 id="OSPFv3报文"><a href="#OSPFv3报文" class="headerlink" title="OSPFv3报文"></a>OSPFv3报文</h3><p>•OSPFv3与OSPFv2有相同类型的报文：</p>
<p>​    ▫Hello报文、DD报文、LSR报文、LSU报文和LSAck报文。</p>
<p>•OSPFv3与OSPFv2使用相同的协议号89。</p>
<p>​    ▫OSPFv2：IPv4报文头部中的协议号（Protocol）为89。</p>
<p>​    ▫OSPFv3：IPv6报文头部中的下一报头号（Next Header）为89。</p>
<p>•OSPFv3与OSPFv2类似，使用组播地址作为OSPF报文目的地址。</p>
<p>​    ▫OSPFv2使用IPv4组播地址： </p>
<p>​        ▪OSPF IGP Routers：224.0.0.5；OSPF IGP DR ：224.0.0.6。</p>
<p>​    ▫OSPFv3使用IPv6组播地址：</p>
<p>​        ▪OSPF IGP Routers：FF02::5；OSPF IGP DR：FF02::6。</p>
<blockquote>
<p>•OSPFv3报文作用：</p>
<p>▫Hello报文：周期性发送，用来发现、建立和维持OSPFv3邻居关系。</p>
<p>▫DD报文：描述了本地LSDB的摘要信息，用于两台设备进行数据库同步。</p>
<p>▫LSR报文：用于向对方请求所需的LSA。设备只有在OSPFv3邻居双方成功交换DD报文后，才会向对方发出LSR报文。</p>
<p>▫LSU报文：向对方发送其所需的LSA。</p>
<p>▫LSAck报文：用来对收到的LSA进行确认。</p>
</blockquote>
<h3 id="OSPFv3报文头部"><a href="#OSPFv3报文头部" class="headerlink" title="OSPFv3报文头部"></a>OSPFv3报文头部</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/10.png"></p>
<blockquote>
<p>•Version：1Byte，版本，OSPF的版本号。对于OSPFv3来说，其值为3。 </p>
<p>•Type：1Byte，类型，OSPFv3报文的类型，有下面几种类型：</p>
<p>​    ▫1：Hello报文；</p>
<p>​    ▫2：DD报文；</p>
<p>​    ▫3：LSR报文；</p>
<p>​    ▫4：LSU报文；</p>
<p>​    ▫5：LSAck报文。</p>
<p>•Packet length：2Byte，OSPFv3报文的总长度，包括报文头在内，单位为字节。</p>
<p>•Router ID：4Byte，始发此报文的路由器的Router ID。</p>
<p>•Area ID：4Byte，发送该报文的所属区域。</p>
<p>•Checksum：2Byte，使用IPv6标准16位校验和。</p>
<p>•0：1Byte，保留字段，必须填0。 </p>
</blockquote>
<h3 id="Hello报文"><a href="#Hello报文" class="headerlink" title="Hello报文"></a>Hello报文</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/11.png"></p>
<blockquote>
<p>•Rtr Pri：1Byte，Router Priority，DR优先级。默认为1。如果设置为0，则路由器不能参与DR或BDR的选举。 </p>
<p>•Options：3Byte，可选项。</p>
<ul>
<li>AT：1bit，表示是否支持OSPFv3认证。若AT=1，则在OSPFv3报文后增加认证尾部字段，包含认证信息。</li>
<li>DC：1bit，表示是否具有支持按需电路的能力。</li>
<li>R：1bit，指明始发路由器是否是一台有效的路由器。</li>
<li>NP：1bit，表示是否为NSSA区域。</li>
<li>MC：1bit，表示是否支持转发组播数据报文。</li>
<li>E：1bit，表示是否支持外部路由。</li>
<li>V6：1bit，表示是否参与IPv6路由计算。如果该位为0，表示该路由器或链路不参与IPv6路由计算。</li>
</ul>
<p>•HelloInterval：2Byte，发送Hello报文的时间间隔。</p>
<p>•RouterDeadInterval ：2Byte，失效时间。如果在此时间内未收到邻居发来的Hello报文，则认为邻居失效。</p>
<p>•Designated Router ID：4Byte，DR的Router ID。</p>
<p>•Backup Designated Router ID ：4Byte，BDR的Router ID。</p>
<p>•Neighbor ID：4Byte，邻居，以Router ID标识。</p>
<p>•说明：DD报文、LSR报文、LSU报文和LSAck报文格式与OSPFv2相比变化不大，本课程不再赘述。</p>
</blockquote>
<h3 id="OSPFv3的LSA头部"><a href="#OSPFv3的LSA头部" class="headerlink" title="OSPFv3的LSA头部"></a>OSPFv3的LSA头部</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/12.png"></p>
<blockquote>
<p>•LS Age：2Byte，LSA产生后所经过的时间，以秒为单位。无论LSA是在链路上传送，还是保存在LSDB中，其值都会在不停的增长。</p>
<p>•LS Type：2Byte，LSA的类型。该字段的高3位标识LSA的通用属性，剩下的比特位标识LSA的特定功能。</p>
<ul>
<li><p>U位标识了对未知LSA的处理方法，即标识了不识别LSA功能代码的路由器应如何处理LSA。</p>
<ul>
<li>0：把此LSA当作具有链路本地泛洪范围来对待，从而只能泛洪到本地链路上。</li>
<li>1：把此LSA当作类型已知的LSA来处理，也就是存储下来并泛洪出去。</li>
</ul>
</li>
<li><p>S2/S1位标识了LSA的泛洪范围。</p>
<ul>
<li>S2 S1=0 0：链路本地范围内，即只在始发链路上泛洪。</li>
<li>S2 S1=0 1：区域范围内，即泛洪到始发区域内的所有路由器。</li>
<li>S2 S1=1 0：AS范围内，即泛洪到本AS的所有路由器。</li>
<li>S2 S1=1 1：预留。</li>
</ul>
</li>
</ul>
<p>•Link State ID：4Byte，本地32位标识符，与IPv6地址无关，与LSA中的LS Type和Advertising Router一起在路由域中描述一个LSA。OSPFv3与OSPFv2相比，Link State ID不再包含地址信息。</p>
<p>•Advertising Router：4Byte，产生此LSA的路由器的Router ID。</p>
<p>•LS Sequence Number：4Byte，LSA的序列号。其他路由器根据这个值可以判断哪个LSA是最新的。</p>
<p>•LS Checksum：2Byte，除了LS Age外其它各域的校验和。</p>
<p>•Length：2Byte，LSA的总长度，包括LSA Header，以字节为单位。</p>
</blockquote>
<h3 id="OSPFv3的LSA类型"><a href="#OSPFv3的LSA类型" class="headerlink" title="OSPFv3的LSA类型"></a>OSPFv3的LSA类型</h3><p>•OSPFv3与OSPFv2相比，具有类似的LSA名称，但是功能略有区别。</p>
<p>•OSPFv3新增了两类LSA，包括：链路LSA和区域内前缀LSA。</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/13.png"></p>
<blockquote>
<p>•如表中所示，OSPFv3的LS Type字段，U位缺省为0；除Type5和Type8的LSA外，其余的LSA泛洪范围都是区域范围内（S2 S1=0 1）。</p>
<ul>
<li>链路本地范围。LSA仅在本地链路上泛洪，包括：Link-LSA。</li>
<li>区域范围。LSA在单个OSPF区域内泛洪，包括：Router-LSA、Network-LSA、Inter-Area-Prefix-LSA、Inter-Area-Router-LSA、NSSA LSA和Intra-Area-Prefix-LSA。</li>
<li>AS范围。LSA在整个路由域（自治系统）中扩散，包括：AS-External-LSA。</li>
</ul>
</blockquote>
<h3 id="Type1：Router-LSA"><a href="#Type1：Router-LSA" class="headerlink" title="Type1：Router-LSA"></a>Type1：Router-LSA</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/14.png"></p>
<blockquote>
<p>•OSPFv3的Router-LSA字段解释：</p>
<p>▫W：Wild-Card Receiver，值为1时，表示该路由器支持组播路由。</p>
<p>▫V：Virtual Link，值为1时，表示产生此LSA的路由器是虚连接的一端。</p>
<p>▫E：External，值为1时，表示产生此LSA的路由器是ASBR。</p>
<p>▫B：Border，值为1时，表示产生此LSA的路由器是ABR。</p>
<p>▫Options：3Byte，可选项。</p>
<p>​    ▪DC：1bit，表示是否具有支持按需电路的能力。</p>
<p>​    ▪R：1bit，指明始发路由器是否是一台有效的路由器。</p>
<p>​    ▪NP：1bit，表示是否为NSSA区域。</p>
<p>​    ▪MC：1bit，表示是否支持转发组播数据报文。</p>
<p>​    ▪E：1bit，表示是否支持外部路由。</p>
<p>​    ▪V6：1bit，表示是否参与IPv6路由计算。如果该位为0，表示该路由器或链路不参与IPv6路由计算。</p>
<p>▫Link Type：1Byte，链路类型。</p>
<p>​    ▪1：点到点连接到另一台路由器。</p>
<p>​    ▪2：连接到一个传送网络（Transit Network）。</p>
<p>​    ▪3：保留。</p>
<p>​    ▪4：虚链路。</p>
<p>▫Metric：2Byte，流量出接口的开销值。</p>
</blockquote>
<h3 id="Type2：Network-LSA"><a href="#Type2：Network-LSA" class="headerlink" title="Type2：Network-LSA"></a>Type2：Network-LSA</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/15.png"></p>
<blockquote>
<p>•OSPFv3的Network-LSA字段解释：</p>
<p>​    ▫Options：与Router-LSA中的Options字段相同。</p>
</blockquote>
<h3 id="Type3：Inter-Area-Prefix-LSA"><a href="#Type3：Inter-Area-Prefix-LSA" class="headerlink" title="Type3：Inter-Area-Prefix-LSA"></a>Type3：Inter-Area-Prefix-LSA</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/16.png"></p>
<blockquote>
<p>•OSPFv3的Inter-Area-Prefix-LSA字段解释：</p>
<ul>
<li><p>Metric：3Byte，到目的地址的开销值。</p>
</li>
<li><p>PrefixOptions：由LSA公告的每个前缀都拥有一个自己的PrefixOptions字段。</p>
<ul>
<li>P位: 传播位。如果一个NSSA区域的前缀需要被ABR传播出去，就需要设置这一位。</li>
<li>MC位: 组播位。如果设置为1，则这个前缀应该纳入组播计算中，否则不纳入组播计算。</li>
<li>LA位: 本地地址位。如果设置为1，则这个前缀是路由器的一个接口地址。</li>
<li>NU位: 非单播位。如果设置为1，则这个前缀不会纳入IPv6单播路由计算中。</li>
</ul>
</li>
</ul>
<p>•注意：缺省路由的前缀长度为0。ABR也能够始发一个区域间Type3的LSA向一个末梢区域通告一条缺省路由。</p>
</blockquote>
<h3 id="Type4：Inter-Area-Router-LSA"><a href="#Type4：Inter-Area-Router-LSA" class="headerlink" title="Type4：Inter-Area-Router-LSA"></a>Type4：Inter-Area-Router-LSA</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/17.png"></p>
<blockquote>
<p>•OSPFv3的Inter-Area-Router-LSA字段解释：</p>
<p>​    ▫Options：Options字段描述的不是源路由器的能力，而是目的路由器所支持的能力，所以此字段值应该等于目的路由器的Router-LSA的Options字段值。</p>
<p>​    ▫Metric：3Byte，到目的地址的开销值。</p>
</blockquote>
<h3 id="Type5：AS-External-LSA"><a href="#Type5：AS-External-LSA" class="headerlink" title="Type5：AS-External-LSA"></a>Type5：AS-External-LSA</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/18.png"></p>
<blockquote>
<p>•OSPFv3的AS-External-LSA字段解释：</p>
<p>▫E：1bit，外部路由的Metric类型。</p>
<ul>
<li><p>如果设置为1，表示此为2类外部路由，其Metric不随着路由的传递而增长。</p>
</li>
<li><p>如果设置为0，表示此为1类外部路由，其Metric随着路由的传递而增长。</p>
</li>
</ul>
<p>▫F：1bit，如果设置为1，则表示后面的Forwarding Address可选字段存在。</p>
<p>▫T：1bit，如果设置为1，则表示后面的External Route Tag可选字段存在。</p>
<p>▫Metric：3Byte，到目的地址的开销值。</p>
<p>▫PrefixLength、PrefixOptions和Address Prefix为描述前缀的三元组，与Inter-Area-Prefix-LSA中该字段含义相同。</p>
<p>▫Forwarding Address：4Byte，可选的128位IPv6地址，当前面的F位为1时存在。表示到达目的的数据应该转发到这个地址。</p>
<p>▫External Route Tag：4Byte，可选的标记位。可以用于ASBR之间的通信。一个比较常见的例子是，在OSPF自治系统的两个边界路由器上进行路由引入时，通过对引入的路由进行标记，可以很方便地进行路由过滤。</p>
<p>▫Referenced Link State ID：4Byte，若Referenced LS Type不为0，则该字段存在，表示引用链路状态ID。</p>
</blockquote>
<h3 id="新增Type8：Link-LSA"><a href="#新增Type8：Link-LSA" class="headerlink" title="新增Type8：Link-LSA"></a>新增Type8：Link-LSA</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/19.png"></p>
<blockquote>
<p>•OSPFv3的Link-LSA字段解释：</p>
<ul>
<li>Rtr Pri：1Byte，该路由器在该链路上的优先级(Router Priority)。</li>
<li>Options：3Byte，提供给Network-LSA的Options。</li>
<li>Number of Prefixes：4Byte，该LSA中携带的IPv6地址前缀个数。</li>
<li>PrefixLength、PrefixOptions和Address Prefix为描述前缀的三元组，与Inter-Area-Prefix-LSA中该字段含义相同。</li>
</ul>
</blockquote>
<h3 id="新增Type9：Intra-Area-Prefix-LSA"><a href="#新增Type9：Intra-Area-Prefix-LSA" class="headerlink" title="新增Type9：Intra-Area-Prefix-LSA"></a>新增Type9：Intra-Area-Prefix-LSA</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/20.png"></p>
<blockquote>
<p>OSPFv3的Intra-Area-Prefix-LSA字段解释：</p>
<p>▫Number of Prefixes：4Byte，该LSA中携带的IPv6地址前缀个数。必要的话，可以通过多个Intra-Area-Prefix-LSA来携带前缀，这样可以控制LSA的长度。 </p>
<p>▫Referenced LS type：4Byte，表明这个LSA是参考一个Router-LSA，还是一个Network-LSA。</p>
<ul>
<li><p>1：表示参考一个Router-LSA</p>
</li>
<li><p>2：表示参考一个Network-LSA。 </p>
</li>
</ul>
<p>▫Referenced Link State ID：4Byte。</p>
<ul>
<li><p>设为0：当这个LSA是参考一个Router-LSA时。</p>
</li>
<li><p>设为该链路的DR的Interface ID：当这个LSA是参考一个Network-LSA时。 </p>
</li>
</ul>
<p>▫Referenced Advertising Router：4Byte。</p>
<ul>
<li><p>设为这个路由器的Router ID：当这个LSA是参考一个Router-LSA时。</p>
</li>
<li><p>设为该链路的DR的Router ID：当这个LSA是参考一个Network-LSA时。 </p>
</li>
</ul>
<p>▫PrefixLength、PrefixOptions和Address Prefix为描述前缀的三元组，与Inter-Area-Prefix-LSA中该字段含义相同。</p>
<p>▫Metric：2Byte，前缀开销值。与Router-LSA的接口开销值相同单位。</p>
<p>在OSPFv3中，当一条链路或它的前缀发生变化时，相连的路由器会发送一个Intra-Area-Prefix-LSA。但是，这条LSA不会触发SPF计算。</p>
</blockquote>
<h3 id="OSPFv3的LSA举例"><a href="#OSPFv3的LSA举例" class="headerlink" title="OSPFv3的LSA举例"></a>OSPFv3的LSA举例</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/21.png"></p>
<blockquote>
<p>•如图所示：R1、R2、R3和R4运行OSPFv3路由协议，且均部署在骨干区域。</p>
<p>•网络稳定后，查看R2的LSDB，可以查看到该路由器的Router-LSA（Type1）、Network-LSA（Type2）、Link-LSA（Type8）和Intra-Area-Prefix-LSA（Type9）。</p>
</blockquote>
<h3 id="Link-LSA举例"><a href="#Link-LSA举例" class="headerlink" title="Link-LSA举例"></a>Link-LSA举例</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/22.png"></p>
<blockquote>
<p>•输出信息解释：</p>
<p>▫LS age：LSA的老化时间。</p>
<p>▫LS Type：LSA的类型。有如下类型：</p>
<ul>
<li>Router-LSA、Network-LSA、Inter-Area-Prefix-LSA、Inter-Area-Router-LSA、AS-external-LSA、NSSA-LSA、Link-LSA、Intra-Area-Prefix-LSA</li>
</ul>
<p>▫Link State ID：LSA报文头中的链路状态ID。</p>
<p>▫Originating Router：产生LSA的路由器。</p>
<p>▫LS Seq Number：LSA序列号（来自LSA报头）。</p>
<p>▫Checksum：LSA的校验和。</p>
<p>▫Length：LSA的长度。</p>
<p>▫Priority：该Link对应接口的优先级。</p>
<p>▫Options：该Link的Option值。</p>
<p>▫Link-Local Address：链路本地地址。</p>
<p>▫Number of Prefixes：该LSA中包含的IPv6前缀数目。</p>
<p>▫Prefix：IPv6前缀。</p>
<p>▫Prefix Options：前缀Option值。</p>
</blockquote>
<h3 id="Intra-Area-Prefix-LSA举例"><a href="#Intra-Area-Prefix-LSA举例" class="headerlink" title="Intra-Area-Prefix-LSA举例"></a>Intra-Area-Prefix-LSA举例</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/23.png"></p>
<h2 id="OSPFv3的基本配置"><a href="#OSPFv3的基本配置" class="headerlink" title="OSPFv3的基本配置"></a>OSPFv3的基本配置</h2><h3 id="OSPFv3的基础配置命令-1"><a href="#OSPFv3的基础配置命令-1" class="headerlink" title="OSPFv3的基础配置命令 (1)"></a>OSPFv3的基础配置命令 (1)</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/24.png"></p>
<blockquote>
<p>•OSPFv3的配置命令与配置方式与OSPFv2类似，其他配置命令不再赘述，详细内容请参考《HCIP-Datacom-Core Technology》课程。</p>
</blockquote>
<h3 id="OSPFv3的基础配置命令-2"><a href="#OSPFv3的基础配置命令-2" class="headerlink" title="OSPFv3的基础配置命令 (2)"></a>OSPFv3的基础配置命令 (2)</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/25.png"></p>
<h3 id="检查OSPFv3基本功能的配置结果"><a href="#检查OSPFv3基本功能的配置结果" class="headerlink" title="检查OSPFv3基本功能的配置结果"></a>检查OSPFv3基本功能的配置结果</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/26.png"></p>
<blockquote>
<p>•[Huawei] <strong>display</strong> <strong>ospfv3</strong> [ <em>process-id</em> ] <strong>lsdb</strong> [ <strong>area</strong> <em>area-id</em> ] [ <strong>originate-router</strong> <em>advertising-router-id</em> | <strong>self-originate</strong> ] [ { <strong>router</strong> | <strong>network</strong> | <strong>inter-router</strong> [ <strong>asbr-router</strong> <em>asbr-router-id</em> ] | { <strong>inter-prefix</strong> | <strong>nssa</strong> } [ <em>ipv6-address</em> <em>prefix-length</em> ] | <strong>link</strong> | <strong>intra-prefix</strong> | <strong>grace</strong> } [ <em>link-state-id</em> ] ]</p>
<ul>
<li><p><em>process-id</em>：OSPFv3进程号。整数形式，取值范围是1～65535。</p>
</li>
<li><p><strong>area</strong> <em>area-id</em>：区域的标识。可以是十进制整数或IPv4地址格式。如果是十进制整数，取值范围是0～4294967295。如果是IPv4地址格式，取值是点分十进制。</p>
</li>
<li><p><strong>external</strong>：显示数据库中AS-external LSA的信息。</p>
</li>
<li><p><strong>inter-prefix</strong>：显示数据库中Inter-Area-Prefix LSA的信息。</p>
</li>
<li><p><strong>inter-router</strong>：显示数据库中Inter-Area-Router LSA的信息。</p>
</li>
<li><p><strong>intra-prefix</strong>：显示数据库中Intra-Area-Prefix LSA的信息。</p>
</li>
<li><p><strong>nssa</strong>：显示数据库中NSSA LSA的信息。</p>
</li>
<li><p><strong>link</strong>：显示数据库中Link-LSA的信息。</p>
</li>
<li><p><strong>network</strong>：显示数据库中Network-LSA的信息。</p>
</li>
<li><p><strong>router</strong>：显示数据库中Router-LSA的信息。</p>
</li>
<li><p><em>link-state-id</em>：链路状态ID。点分十进制格式。</p>
</li>
<li><p><strong>originate-router</strong> <em>advertising-router-id</em>：指定发布LSA的路由器的Router ID。点分十进制格式。</p>
</li>
<li><p><strong>asbr-router</strong> <em>asbr-router-id</em>：指定ASBR路由器的Router ID。点分十进制格式。</p>
</li>
<li><p><strong>self-originate</strong>：显示数据库中由本路由器发布的LSA信息。</p>
</li>
<li><p><em>ipv6-address prefix-length</em>：指定IPv6目的地址及前缀长度。</p>
<ul>
<li><em>ipv6-address</em>是32位16进制数，格式为X:X:X:X:X:X:X:X。</li>
<li><em>prefix-length</em>是整数形式，取值范围是0～128。</li>
</ul>
</li>
</ul>
<p>•[Huawei] <strong>display</strong> <strong>ospfv3</strong> [ <em>process-id</em> ] <strong>routing</strong> [ <em>ipv6-address</em> <em>prefix-length</em> | <strong>abr-routes</strong> | <strong>asbr-routes</strong> | <strong>intra-routes</strong> | <strong>inter-routes</strong> | <strong>ase-routes</strong> | <strong>nssa-routes</strong> | [ <strong>statistics</strong> ] ]</p>
<ul>
<li><em>process-id</em>：OSPFv3进程号。整数形式，取值范围是1～65535。</li>
<li><em>ipv6-address</em>：指定IPv6地址。32位16进制数，格式为X:X:X:X:X:X:X:X。</li>
<li><em>prefix-length</em>：指定前缀长度。整数形式，取值范围是0～128。</li>
<li><strong>abr-routes</strong>：显示OSPFv3中所有ABR的路由信息。</li>
<li><strong>asbr-routes</strong>：显示OSPFv3中所有ASBR的路由信息。</li>
<li><strong>intra-routes</strong>：显示OSPFv3中区域内路由的统计信息。</li>
<li><strong>inter-routes</strong>：显示OSPFv3中区域间路由的统计信息。</li>
<li><strong>ase-routes</strong>：显示OSPFv3中AS外部路由的统计信息。**</li>
<li>nssa-routes<strong>：显示OSPFv3中NSSA区域路由的统计信息。</strong></li>
<li>statistics：显示OSPFv3中所有路由表的统计信息。</li>
</ul>
</blockquote>
<h3 id="OSPF双栈配置举例"><a href="#OSPF双栈配置举例" class="headerlink" title="OSPF双栈配置举例"></a>OSPF双栈配置举例</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/27.png"></p>
<h3 id="部署IPv4网络"><a href="#部署IPv4网络" class="headerlink" title="部署IPv4网络"></a>部署IPv4网络</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/28.png"></p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/29.png"></p>
<h3 id="部署IPv6网络"><a href="#部署IPv6网络" class="headerlink" title="部署IPv6网络"></a>部署IPv6网络</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/30.png"></p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/31.png"></p>
<h3 id="查看OSPFv3网络的邻居信息"><a href="#查看OSPFv3网络的邻居信息" class="headerlink" title="查看OSPFv3网络的邻居信息"></a>查看OSPFv3网络的邻居信息</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/32.png"></p>
<blockquote>
<p>•可以通过<strong>display</strong> <strong>ospf peer</strong>查看OSPFv2的邻居信息。</p>
<p>•对比OSPFv2和OSPFv3的邻居信息，发现选出的DR和BDR是一致的，说明DR选举方式相同。</p>
</blockquote>
<h3 id="查看OSPFv3网络的路由信息"><a href="#查看OSPFv3网络的路由信息" class="headerlink" title="查看OSPFv3网络的路由信息"></a>查看OSPFv3网络的路由信息</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/33.png"></p>
<blockquote>
<p>•可以通过<strong>display ospf routing</strong>查看OSPFv2的路由信息。</p>
<p>•对比OSPFv2和OSPFv3的路由信息，发现到“同一”网段的路径一致，说明路由计算方式相同。</p>
</blockquote>
<h3 id="查看OSPFv3网络LSDB信息"><a href="#查看OSPFv3网络LSDB信息" class="headerlink" title="查看OSPFv3网络LSDB信息"></a>查看OSPFv3网络LSDB信息</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/34.png"></p>
<blockquote>
<p>•可以通过<strong>display ospf</strong> <strong>lsdb</strong>查看OSPFv2的LSDB信息，可以看到有Type1、Type2和Type3三种LSA。</p>
</blockquote>
<h1 id="3-IS-IS-IPv6-原理与配置"><a href="#3-IS-IS-IPv6-原理与配置" class="headerlink" title="3.IS-IS (IPv6)原理与配置"></a>3.IS-IS (IPv6)原理与配置</h1><h2 id="IS-IS-IPv6-概述"><a href="#IS-IS-IPv6-概述" class="headerlink" title="IS-IS (IPv6)概述"></a>IS-IS (IPv6)概述</h2><p>•IS-IS最初是为OSI网络设计的一种基于链路状态协议的动态路由协议。之后为了提供对IPv4的路由支持，扩展应用到IPv4网络，称为集成IS-IS。</p>
<p>•IS-IS报文有以下几种类型：Hello PDU（Protocol Data Unit）、LSP和SNP。</p>
<ul>
<li>报文格式为：</li>
</ul>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/35.png"></p>
<ul>
<li>IS-IS报文中的变长字段部分是多个TLV（Type-Length-Value）三元组，使用TLV结构构建报文使IS-IS更具灵活性和扩展性，增加新特性只需要增加新TLV即可。</li>
</ul>
<p>•为了支持IPv6路由的处理和计算，IS-IS新增了两个TLV（Type-Length-Value）和一个NLPID（Network Layer Protocol Identifier，网络层协议标识符）。</p>
<h2 id="新增TLV"><a href="#新增TLV" class="headerlink" title="新增TLV"></a>新增TLV</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/36.png"></p>
<blockquote>
<p>•232号TLV（IPv6 Interface Address）字段解释：</p>
<p>▫Type：8bit，TLV类型，此时值为232（0xE8）。</p>
<p>▫Length：8bit，TLV的Value部分长度。</p>
<p>▫Interface Address：128bit，IPv6地址。</p>
<p>•236号TLV（IPv6 Reachability）字段解释：</p>
<p>▫Type：8bit，TLV类型，此时值为236（0xEC）。</p>
<p>▫Length：8bit，TLV的Value部分长度。</p>
<p>▫Metric：32bit，度量值。</p>
<p>▫U：1bit，Up/Down位，标识这个前缀是否是从高Level通告下来的。</p>
<p>▫X：1bit，External Original位，标识这个前缀是否是从其他路由协议中引入的。</p>
<p>▫S：1bit，Sub-TLV Present位，子TLV标识位（可选）。</p>
<p>▫R：5bit，Reserve位，保留位。</p>
<p>▫Prefix Length：8bit，前缀长度。</p>
<p>▫Prefix：IPv6地址前缀。</p>
<p>▫Sub-TLV Length：8bit，子TLV长度。若S位置1，则存在。</p>
<p>▫Sub-TLV：子TLV。若S位置1，则存在。</p>
</blockquote>
<h2 id="129号TLV中新增NLPID"><a href="#129号TLV中新增NLPID" class="headerlink" title="129号TLV中新增NLPID"></a>129号TLV中新增NLPID</h2><p>•为了支持IPv6路由的处理和计算，IS-IS在129号TLV中新增了一个NLPID。</p>
<p>•129号TLV（Protocol Supported）</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/37.png"></p>
<p>如果IS-IS支持IPv6，那么向外发布IPv6路由时必须携带NLPID值。</p>
<h2 id="IS-IS多拓扑技术背景"><a href="#IS-IS多拓扑技术背景" class="headerlink" title="IS-IS多拓扑技术背景"></a>IS-IS多拓扑技术背景</h2><p>缺省情况下，在运行IS-IS的网络环境中，IPv4和IPv6的混合拓扑被看成是一个集成的拓扑，IS-IS针对IPv4和IPv6经计算形成相同的最短路径树。</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/38.png"></p>
<blockquote>
<p>•IS-IS单拓扑的不足之处：</p>
<p>​    ▫网络部署不适合拓扑分离。</p>
<p>​    ▫为维护相同的拓扑，所有接口都必须同时运行IS-IS（IPv4）和IS-IS（IPv6），部署不够灵活。</p>
<p>​    ▫不能使用IPv4区域来连接不同的IPv6区域，即无法通过IPv4网络解决IPv6孤岛问题。</p>
</blockquote>
<h2 id="IS-IS多拓扑概述"><a href="#IS-IS多拓扑概述" class="headerlink" title="IS-IS多拓扑概述"></a>IS-IS多拓扑概述</h2><p>•IS-IS多拓扑（Multi-Topology，MT）特性是指在一个IS-IS自治域内运行多个独立的IP拓扑。例如IPv4拓扑和IPv6拓扑，而不是将它们视为一个集成的单一拓扑。这有利于IS-IS在路由计算中根据实际组网情况来单独考虑IPv4和IPv6网络。根据链路所支持的IP协议类型，不同拓扑运行各自的SPF计算，实现网络的相互屏蔽。</p>
<p>•IS-IS多拓扑的实现过程</p>
<p>​    ▫建立拓扑：通过报文交互建立邻居，从而建立多拓扑。</p>
<p>​    ▫SPF计算：在不同的拓扑上分别进行SPF计算。</p>
<h2 id="IS-IS多拓扑原理"><a href="#IS-IS多拓扑原理" class="headerlink" title="IS-IS多拓扑原理"></a>IS-IS多拓扑原理</h2><p>•IS-IS定义了新的TLV，该TLV中包含接口所属拓扑信息（MT信息）。MT信息的传播，使得网络按不同的拓扑分别进行SPF计算，最终实现拓扑分离。</p>
<p>•229号多拓扑TLV：</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/39.png"></p>
<blockquote>
<p>•IS-IS为了支持多拓扑特性，定义了多种TLV，包括：多拓扑TLV、多拓扑中间系统TLV、多拓扑可达的IPv4前缀TLV和多拓扑可达的IPv6前缀TLV。其中本课程将对多拓扑TLV进行讲解，其他内容不详细展开。</p>
<p>•多拓扑TLV：</p>
<ul>
<li><p>多拓扑TLV仅包含在IIH报文和LSP的0分片报文中。</p>
</li>
<li><p>预留的MT ID字段：</p>
<ul>
<li>MT ID=0，用于标准IPv4拓扑。</li>
<li>MT ID=2，预留给IPv6拓扑。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="IS-IS-IPv6-的基础配置命令"><a href="#IS-IS-IPv6-的基础配置命令" class="headerlink" title="IS-IS (IPv6)的基础配置命令"></a>IS-IS (IPv6)的基础配置命令</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/40.png"></p>
<blockquote>
<p>•IS-IS（IPv6）的基础配置命令与配置方式与IS-IS（IPv4）一致，其他配置命令不再赘述，详细内容请参考《HCIP-Datacom-Core Technology》课程。</p>
<p>•[Huawei-isis-1] <strong>ipv6</strong> <strong>enable</strong> [ <strong>topology</strong> { <strong>ipv6</strong> | <strong>standard</strong> } ]</p>
<ul>
<li><strong>topology</strong>：用于指定网络的拓扑类型。</li>
<li><strong>ipv6</strong>：指定拓扑类型为IPv6拓扑，即在IPv6拓扑上使能IS-IS进程的IPv6。网络中的链路可以配置成IPv4或IPv6，但SPF计算在各自的拓扑中单独进行。</li>
<li><strong>standard</strong>：指定拓扑类型为标准模式，即在集成拓扑上使能IS-IS进程的IPv6。网络管理员必须保证网络中所有的链路支持一致的拓扑模式。缺省情况下，使能IPv6选择standard参数。</li>
</ul>
<p>•[ Huawei-GigabitEthernet0/0/1] <strong>isis</strong> <strong>ipv6</strong> <strong>cost</strong> { <em>cost</em> | <strong>maximum</strong> } [ <strong>level-1</strong> | <strong>level-2</strong> ]</p>
<ul>
<li><p><em>cost</em>：指定IPv6接口的链路开销值。整数形式，取值范围根据开销类型而定。</p>
<ul>
<li>当开销类型为narrow、narrow-compatible或compatible时，取值范围是1～63。</li>
<li>当开销类型为wide或wide-compatible时，取值范围是1～16777214。</li>
<li>缺省值为10。</li>
</ul>
</li>
<li><p><strong>maximum</strong>：指定接口的链路开销值为16777215。</p>
</li>
<li><p><strong>level-1</strong>：指定配置level-1链路的开销值。如果不指定配置链路开销的接口级别，则同时为Level-1和Level-2级别的接口设置链路开销。</p>
</li>
<li><p><strong>level-2</strong>：指定配置level-2链路的开销值。如果不指定配置链路开销的接口级别，则同时为Level-1和Level-2级别的接口设置链路开销。</p>
</li>
</ul>
</blockquote>
<h2 id="检查IS-IS-IPv6-基本功能的配置结果"><a href="#检查IS-IS-IPv6-基本功能的配置结果" class="headerlink" title="检查IS-IS (IPv6)基本功能的配置结果"></a>检查IS-IS (IPv6)基本功能的配置结果</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/41.png"></p>
<h2 id="IS-IS双栈配置举例"><a href="#IS-IS双栈配置举例" class="headerlink" title="IS-IS双栈配置举例"></a>IS-IS双栈配置举例</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/42.png"></p>
<h3 id="部署IPv4网络-1"><a href="#部署IPv4网络-1" class="headerlink" title="部署IPv4网络"></a>部署IPv4网络</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/43.png"></p>
<h3 id="部署IPv6网络-1"><a href="#部署IPv6网络-1" class="headerlink" title="部署IPv6网络"></a>部署IPv6网络</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/44.png"></p>
<h3 id="查看IS-IS-IPv4-网络路由信息"><a href="#查看IS-IS-IPv4-网络路由信息" class="headerlink" title="查看IS-IS (IPv4)网络路由信息"></a>查看IS-IS (IPv4)网络路由信息</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/45.png"></p>
<h3 id="查看IS-IS-IPv6-网络路由信息"><a href="#查看IS-IS-IPv6-网络路由信息" class="headerlink" title="查看IS-IS (IPv6)网络路由信息"></a>查看IS-IS (IPv6)网络路由信息</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/46.png"></p>
<h1 id="4-BGP4-原理与配置"><a href="#4-BGP4-原理与配置" class="headerlink" title="4.BGP4+原理与配置"></a>4.BGP4+原理与配置</h1><h2 id="BGP4-概述"><a href="#BGP4-概述" class="headerlink" title="BGP4+概述"></a>BGP4+概述</h2><p>•传统的BGP-4只能管理IPv4单播路由信息，BGP多协议扩展（MultiProtocol BGP，MP-BGP）提供了对多种网络层协议的支持。目前的MP-BGP，使用扩展属性和地址族来实现对IPv6、组播和VPN相关内容的支持，BGP协议原有的报文机制和路由机制并没有改变。</p>
<p>•其中，MP-BGP对IPv6单播网络的支持特性称为BGP4+。BGP4+为IPv6单播网络建立独立的拓扑结构，并将路由信息储存在独立的路由表中，保持单播IPv4网络和单播IPv6网络之间路由信息相互隔离。</p>
<blockquote>
<p>•为了实现对IPv6协议的支持，BGP需要将IPv6协议的信息反映到NLRI属性中。</p>
</blockquote>
<h2 id="MP-BGP支持的地址族"><a href="#MP-BGP支持的地址族" class="headerlink" title="MP-BGP支持的地址族"></a>MP-BGP支持的地址族</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/47.png"></p>
<h2 id="BGP路径属性"><a href="#BGP路径属性" class="headerlink" title="BGP路径属性"></a>BGP路径属性</h2><p>•BGP的Update报文在对等体之间传递路由信息，可以用于发布和撤销路由。</p>
<p>•Update报文格式：</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/48.png"></p>
<p>•BGP4+中引入了两个NLRI属性，分别是：</p>
<ul>
<li><p>MP_REACH_NLRI：Multiprotocol Reachable NLRI，多协议可达NLRI。用于发布可达路由及下一跳信息。</p>
</li>
<li><p>MP_UNREACH_NLRI：Multiprotocol Unreachable NLRI，多协议不可达NLRI。用于撤销不可达路由。</p>
</li>
</ul>
<blockquote>
<p>•Update报文：</p>
<ul>
<li>一个Update报文可以通告具有相同路径属性的多条路由，这些路由保存在NLRI（Network Layer Reachable Information，网络层可达信息）中。同时Update还可以携带多条不可达路由，用于告知对方撤销路由，这些保存在Withdrawn Routes字段中。</li>
</ul>
</blockquote>
<h2 id="NLRI属性"><a href="#NLRI属性" class="headerlink" title="NLRI属性"></a>NLRI属性</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/49.png"></p>
<blockquote>
<p>•MP_REACH_NLRI字段解释：</p>
<ul>
<li>地址族信息（Address Family Information）：由2Byte的地址族标识（Address Family Identifier，AFI）和1Byte的子地址族标识（Subsequent Address Family Identifier，SAFI）组成。</li>
<li>下一跳长度（Length of Next Hop Network Address）：1Byte，表示下一跳地址的长度，通常情况下为16。</li>
<li>下一跳地址（Network Address of Next Hop）：长度由上一个字段决定，一般情况下为全球单播地址。</li>
<li>保留字段（Reserved）：1Byte，必须为0 。</li>
<li>网络层可达信息（Network Layer Reachability Information）：表示含有匹配相同属性的路由信息。当此字段为0时，表示为缺省路由。</li>
</ul>
<p>•MP_UNREACH_NLRI字段解释：</p>
<ul>
<li>撤销路由（Withdrawn Routes）：表示撤销的路由条目。格式为&lt;掩码长度，路由前缀&gt; ，当此掩码长度为0时，表示为缺省路由。</li>
</ul>
</blockquote>
<h2 id="BGP4-的基础配置命令"><a href="#BGP4-的基础配置命令" class="headerlink" title="BGP4+的基础配置命令"></a>BGP4+的基础配置命令</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/50.png"></p>
<blockquote>
<p>•BGP4+的基础配置命令与配置方式与BGP一致，其他配置命令不再赘述，详细内容请参考《HCIP-Datacom-Core Technology》课程。</p>
<p>•[Huawei-bgp] <strong>ipv6-family</strong> [ <strong>unicast</strong> | <strong>vpnv6</strong> | <strong>vpn-instance</strong> <em>vpn*</em>-instance-name* ]</p>
<ul>
<li><strong>unicast</strong>：进入IPv6单播地址族视图。</li>
<li><strong>vpnv6</strong>：进入BGP-VPNv6地址族视图。</li>
<li><strong>vpn-instance</strong> <em>vpn-instance-name</em>：将指定的VPN实例与IPv6地址族进行关联，进入BGP-VPN实例IPv6地址族视图。字符串形式，区分大小写，不支持空格，长度范围是1～31。当输入的字符串两端使用双引号时，可在字符串中输入空格。</li>
</ul>
<p>•[Huawei-bgp-af-ipv6] <strong>network</strong> <em>ipv6-address</em> <em>prefix-length</em> [ <strong>route-policy</strong> <em>route-policy-name</em> ]</p>
<ul>
<li><p><em>ipv6-address</em>：指定BGP发布的IPv6网络地址。32位16进制数，格式为X:X:X:X:X:X:X:X。</p>
</li>
<li><p><em>prefix-length</em>：指定BGP发布的IPv6网络地址的前缀长度。整数形式，取值范围是0～128。</p>
</li>
<li><p><strong>route-policy</strong> <em>route-policy-name</em>：指定发布路由应用的Route-Policy。字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
</li>
</ul>
</blockquote>
<h2 id="检查BGP4-基本功能的配置结果"><a href="#检查BGP4-基本功能的配置结果" class="headerlink" title="检查BGP4+基本功能的配置结果"></a>检查BGP4+基本功能的配置结果</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/51.png"></p>
<h2 id="BGP双栈配置举例"><a href="#BGP双栈配置举例" class="headerlink" title="BGP双栈配置举例"></a>BGP双栈配置举例</h2><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/52.png"></p>
<h3 id="部署IPv4网络-2"><a href="#部署IPv4网络-2" class="headerlink" title="部署IPv4网络"></a>部署IPv4网络</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/53.png"></p>
<h3 id="部署IPv6网络-2"><a href="#部署IPv6网络-2" class="headerlink" title="部署IPv6网络"></a>部署IPv6网络</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/54.png"></p>
<h3 id="查看BGP对等体信息"><a href="#查看BGP对等体信息" class="headerlink" title="查看BGP对等体信息"></a>查看BGP对等体信息</h3><p>•通过<strong>display</strong> <strong>bgp</strong> <strong>[ipv6] peer</strong>，分别查看IPv4和IPv6网络中的BGP对等体信息。</p>
<p>•发现除建立对等体的地址不同，其他信息基本一致。</p>
<p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/55.png"></p>
<h3 id="查看BGP4-路由信息"><a href="#查看BGP4-路由信息" class="headerlink" title="查看BGP4+路由信息"></a>查看BGP4+路由信息</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/56.png"></p>
<h3 id="查看BGP4-中的NLRI属性"><a href="#查看BGP4-中的NLRI属性" class="headerlink" title="查看BGP4+中的NLRI属性"></a>查看BGP4+中的NLRI属性</h3><p><img src="/2021/06/30/IPadv-IPv6%E8%B7%AF%E7%94%B1/57.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）以下LSA，属于OSPFv3的有哪些？(   )</p>
<p><strong>A.Router-LSA</strong></p>
<p><strong>B.Network-LSA</strong></p>
<p>C.Network-Summary-LSA</p>
<p><strong>D.Link-LSA</strong></p>
<p>2.（判断题）IS-IS支持IPv4网络和IPv6网络分别计算自己的最短路径树。(   )</p>
<p><strong>A.正确</strong></p>
<p>B.错误</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•通过IPv6静态路由能够满足网络互通要求，但随着网络的增大，就需要借助动态路由协议。因此要求动态路由协议能够支持IPv6，并能够携带IPv6地址进行路由通告。</p>
<p>•IETF为了支持IPv6网络，对OSPFv2进行了增强与改进，创建了一个新的协议：OSPFv3。</p>
<p>•IS-IS则是利用自己扩展性强的特点，通过新增TLV，实现对IPv6的支持。</p>
<p>•同样的，BGP利用自己的扩展路径属性以及多协议地址族实现对IPv6的支持。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" itemprop="url">IPadv-BGP高级特性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-30T12:22:57+08:00">
                2021-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•在大型网络中通常会部署BGP，相比于IGP，BGP拥有更加灵活的路由控制能力。每一条BGP路由都可以携带多个路径属性，针对其属性也有特有的路由匹配工具，包括：AS_Path Filter和Community Filter。根据实际组网需求，可以实施路由策略，控制路由的接收和发布。</p>
<p>•同时，为了提升网络性能，BGP提供了各种高级特性以及多种组网部署方案。</p>
<p>•本课程将介绍BGP路由控制的原理与配置，介绍常用的BGP高级特性，包括：ORF、对等体组、安全特性，还会介绍BGP路由反射器的组网部署方式。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫在配置AS_Path Filter和Community Filter过程中使用正则表达式</p>
<p>▫使用AS_Path Filter和Community Filter实现BGP路由控制</p>
<p>▫应用BGP的ORF功能、对等体组功能</p>
<p>▫实现BGP安全的基本配置</p>
<p>▫描述BGP路由反射器的组网方式</p>
<h1 id="1-BGP路由控制"><a href="#1-BGP路由控制" class="headerlink" title="1.BGP路由控制"></a>1.BGP路由控制</h1><h2 id="BGP路由控制概述"><a href="#BGP路由控制概述" class="headerlink" title="BGP路由控制概述"></a>BGP路由控制概述</h2><p>BGP路由控制包括控制路由的发布和接收。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/1.png"></p>
<blockquote>
<p>•如图所示：</p>
<ul>
<li>R1和R2在AS101中，建立IBGP邻居关系；R3和R4在AS102中，分别与R2建立EBGP邻居关系。</li>
<li>R1有三个直连网段Net1、Net2和Net3，并将三个网段通告进BGP路由中。</li>
<li>在R2可以通过BGP路由控制，过滤Net2的路由，则R2的BGP路由表中就没有Net2的路由条目。</li>
<li>在R3和R4可以通过BGP路由控制，分别修改Net1和Net3的路由属性，控制路由优选，使AS102中设备访问Net1优选R3作为出口设备，访问Net3优选R4作为出口设备。</li>
</ul>
<p>•说明：ACL、IP Prefix List、Filter-Policy、Route-Policy和BGP路径属性等内容本课程不再赘述，详细内容请参考《HCIP-Datacom-Core Technology》课程。</p>
</blockquote>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><p>•正则表达式是按照一定的模板来匹配字符串的公式，由普通字符（例如字符a到z）和特殊字符组成。</p>
<p>•普通字符：匹配的对象是普通字符本身。</p>
<ul>
<li><p>包括所有的大写和小写字母、数字、标点符号以及一些特殊符号。</p>
</li>
<li><p>例如：a匹配abc中的a，10匹配10.113.25.155中的10，@匹配<a href="mailto:&#120;&#120;&#x78;&#x40;&#x78;&#120;&#120;&#46;&#x63;&#x6f;&#x6d;">&#120;&#120;&#x78;&#x40;&#x78;&#120;&#120;&#46;&#x63;&#x6f;&#x6d;</a>中的@。</p>
</li>
</ul>
<p>•特殊字符：配合普通字符匹配复杂或特殊的字符串组合。</p>
<ul>
<li>位于普通字符之前或之后用来限制或扩充普通字符的独立控制字符或占位符。</li>
<li>用来描述它前面的字符的重复使用方式。</li>
<li>限定一个完整的范围。</li>
</ul>
<blockquote>
<p>•正则表达式一般具有以下功能：</p>
<p>▫检查字符串中符合某个规则的子字符串，并可以获取该子字符串。</p>
<p>▫根据匹配规则对字符串进行替换操作。</p>
</blockquote>
<h2 id="特殊字符举例-1"><a href="#特殊字符举例-1" class="headerlink" title="特殊字符举例 (1)"></a>特殊字符举例 (1)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/2.png"></p>
<blockquote>
<p>•说明：圆括号()可以用来定义操作符的范围和优先度。例如，gr(a|e)y等价于gray|grey。</p>
</blockquote>
<h2 id="特殊字符举例-2"><a href="#特殊字符举例-2" class="headerlink" title="特殊字符举例 (2)"></a>特殊字符举例 (2)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/3.png"></p>
<blockquote>
<p>•思考题：</p>
<p>•类型1：</p>
<p>▫**^a.$**：匹配一个以字符a开始，以任意单一字符结束的字符串，如a0，a!，ax等。</p>
<p>▫**^100_**：匹配以100为起始的字符串，如：100、100 200、100 300 400等。</p>
<p>▫**^100$**：只匹配100。</p>
<p>▫**100$|400$**：匹配以100或400结束的字符串，如：100、1400、300 400等。</p>
<p>▫**^(65000)$**：只匹配(65000)。</p>
<p>•类型2：</p>
<p>▫<strong>abc*d</strong>：匹配c字符0次或多次，如：abd、abcd、abccd、abcccd、abccccdef等。</p>
<p>▫<strong>abc+d</strong>：匹配c字符1次或多次，如：abcd、abccd、abcccd、abccccdef等。</p>
<p>▫<strong>abc?d</strong>：匹配c字符0次或1次，如：abd、abcd、abcdef等。</p>
<p>▫<strong>a(bc)?d</strong>：匹配bc字符串0次或1次，如：ad、abcd、aaabcdef等。</p>
<p>•类型3：</p>
<p>▫**[abcd]**：匹配abcd中任意一个字符，即只要出现了a、b、c、d中的任意字符即可，如：ax、b！、abc、d0等。</p>
<p>▫**[a-c 1-2]$**：匹配以字符a、b、c、1、2结束的字符串，如：a、a1、62、xb、7ac等。</p>
<p>▫**[^act]$**：匹配不以字符a、c、t结束的字符串，如：ax、b！、d等。</p>
<p>▫**[123].[7-9]**：匹配如：1 7、2x9、348等。</p>
</blockquote>
<h2 id="路由匹配工具：AS-Path-Filter"><a href="#路由匹配工具：AS-Path-Filter" class="headerlink" title="路由匹配工具：AS_Path Filter"></a>路由匹配工具：AS_Path Filter</h2><p>•AS_Path Filter是将BGP中的AS_Path属性作为匹配条件的过滤器，利用BGP路由携带的AS_Path列表对路由进行过滤。</p>
<p>•在不希望接收某些AS的路由时，可以利用AS_Path Filter对携带这些AS号的路由进行过滤，从而实现拒绝某些路由。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/4.png"></p>
<blockquote>
<p>•AS_Path属性是BGP的公认必遵属性，所有的BGP路由都必须携带该属性。这个属性记录了BGP路由在传递过程中所经过的所有AS的号码。</p>
<p>•AS_Path属性值可以是0个、1个或多个AS号码的集合。</p>
</blockquote>
<h2 id="使用正则表达式匹配AS-Path"><a href="#使用正则表达式匹配AS-Path" class="headerlink" title="使用正则表达式匹配AS_Path"></a>使用正则表达式匹配AS_Path</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/5.png"></p>
<h2 id="AS-Path-Filter的基础配置命令"><a href="#AS-Path-Filter的基础配置命令" class="headerlink" title="AS_Path Filter的基础配置命令"></a>AS_Path Filter的基础配置命令</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/6.png"></p>
<blockquote>
<p>•在同一个过滤器编号下，可以定义多条过滤规则（permit或deny模式）。在匹配过程中，这些规则之间是“或”的关系，即只要路由信息通过其中一项规则，就认为通过由该过滤器编号标识的这组AS_Path Filter。</p>
<p>•命令：[Huawei] <strong>ip as-path-filter</strong> { <em>as-path-filter-number</em> | <em>as-path-filter-name</em> } { <strong>deny</strong> | <strong>permit</strong> } <em>regular-expression</em></p>
<ul>
<li><em>as-path-filter-number</em>：指定的AS路径过滤器号。整数形式，取值范围1~256。</li>
<li><em>as-path-filter-name</em>：指定的AS路径过滤器名称。字符串形式，区分大小写，不支持空格，长度范围是1~51，且不能都是数字。当输入的字符串两端使用双引号时，可在字符串中输入空格。</li>
<li><strong>deny</strong>：指定AS路径过滤器的匹配模式为拒绝。</li>
<li><strong>permit</strong>：指定AS路径过滤器的匹配模式为允许。</li>
<li><em>regular-expression</em>：指定AS路径正则表达式。字符串形式，支持空格，取值范围是1~255个字符。</li>
</ul>
<p>•AS路径过滤器的默认行为是deny，即路由如果没有在某一次过滤中被permit则最终不能通过该过滤器的过滤。如果一个过滤器中的所有过滤规则都是deny，则没有路由能通过该过滤器的过滤，这种情况下需要在多次（或一次）deny之后设置一次permit，允许其余所有路由通过过滤器的过滤。</p>
</blockquote>
<h2 id="AS-Path-Filter的配置举例-1"><a href="#AS-Path-Filter的配置举例-1" class="headerlink" title="AS_Path Filter的配置举例 (1)"></a>AS_Path Filter的配置举例 (1)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/7.png"></p>
<h2 id="AS-Path-Filter的配置举例-2"><a href="#AS-Path-Filter的配置举例-2" class="headerlink" title="AS_Path Filter的配置举例 (2)"></a>AS_Path Filter的配置举例 (2)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/8.png"></p>
<h2 id="查看AS-Path-Filter相关信息"><a href="#查看AS-Path-Filter相关信息" class="headerlink" title="查看AS_Path Filter相关信息"></a>查看AS_Path Filter相关信息</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/9.png"></p>
<h2 id="路由匹配工具：Community-Filter"><a href="#路由匹配工具：Community-Filter" class="headerlink" title="路由匹配工具：Community Filter"></a>路由匹配工具：Community Filter</h2><p>•Community Filter与Community属性配合使用，可以在不便使用IP Prefix List和AS_Path Filter时，降低路由管理难度。</p>
<p>•团体属性过滤器有两种类型：</p>
<p>​    ▫基本Community Filter。匹配团体号或公认Community属性。</p>
<p>​    ▫高级Community Filter。使用正则表达式匹配团体号。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/10.png"></p>
<blockquote>
<p>•Community属性为可选过渡属性，可以标识具有相同特征的路由，而不用考虑零散路由前缀和繁多的AS号。即可以将某些路由分配特定的Community属性值，之后就可以基于Community值而不是网络号/掩码来匹配路由并执行相应的路由策略。</p>
</blockquote>
<h2 id="Community属性"><a href="#Community属性" class="headerlink" title="Community属性"></a>Community属性</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/11.png"></p>
<h2 id="设置Community的基础配置命令"><a href="#设置Community的基础配置命令" class="headerlink" title="设置Community的基础配置命令"></a>设置Community的基础配置命令</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/12.png"></p>
<blockquote>
<p>•命令：[Huawei-route-policy] <strong>apply community</strong> { <em>community-number</em> | <em>aa:nn</em> | <strong>internet</strong> | <strong>no-advertise</strong> | <strong>no-export</strong> | <strong>no-export-subconfed</strong> } [ <strong>additive</strong> ]</p>
<p>▫<em>community-number</em> | <em>aa:nn</em>：指定团体属性中的团体号。一条命令中最多可以配置32个团体号。整数形式，community-number的取值范围是0<del>4294967295，aa和nn的取值范围都是0</del>65535。</p>
<p>▫<strong>internet</strong>：表示可以向任何对等体发送匹配的路由。缺省情况下，所有的路由都属于Internet团体。</p>
<p>▫<strong>no-advertise</strong>：表示不向任何对等体发送匹配的路由。即收到具有此属性的路由后，不能发布给任何其他的BGP对等体。</p>
<p>▫<strong>no-export</strong>：表示不向AS外发送匹配的路由，但发布给其它子自治系统。即收到具有此属性的路由后，不能发布到本地AS之外。</p>
<p>▫<strong>no-export-subconfed</strong>：表示不向AS外发送匹配的路由，也不发布给其它子自治系统，即收到具有此属性的路由后，不能发布给任何其他的子自治系统。</p>
<p>▫<strong>additive</strong>：表示追加路由的团体属性。</p>
</blockquote>
<h2 id="Community-Filter的基础配置命令-1"><a href="#Community-Filter的基础配置命令-1" class="headerlink" title="Community Filter的基础配置命令 (1)"></a>Community Filter的基础配置命令 (1)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/13.png"></p>
<blockquote>
<p>•命令：[Huawei] <strong>ip community-filter</strong> { <strong>basic</strong> <em>comm-filter-name</em> | <em>basic-<strong>comm</strong>-filter-num</em> } { <strong>permit</strong> | <strong>deny</strong> } [ <em>community-number</em> | <em>aa:nn</em> | <strong>internet</strong> | <strong>no-export-subconfed</strong> | <strong>no-advertise</strong> | <strong>no-export</strong> ]</p>
<p>▫<strong>basic</strong> <em>comm-filter-name</em>：指定基本团体属性过滤器名称。字符串形式，区分大小写，取值范围是1~51个字符，且不能都是数字。</p>
<p>▫<em>basic-<strong>comm</strong>-filter-num</em>：指定基本团体属性过滤器号。整数形式，取值范围1~99。</p>
<p>▫<strong>deny</strong>：指定团体属性过滤器的匹配模式为拒绝。</p>
<p>▫<strong>permit</strong>：指定团体属性过滤器的匹配模式为允许。</p>
<p>▫<em>community-number</em>：指定团体号。整数形式，取值范围0~4294967295。</p>
<p>▫<em>aa:nn</em>：指定团体号。一条命令最多可以指定20个团体属性号。aa和nn都是整数形式，取值范围都是0~65535。</p>
<p>▫<strong>internet</strong>：表示可以向任何对等体发送匹配的路由。</p>
<p>▫<strong>no-export-subconfed</strong>：指定不向自治系统外部通告路由。如果使用了联盟，则不会向联盟中的其他子自治系统通告路由。</p>
<p>▫<strong>no-advertise</strong>：指定不通告给其他对等体。</p>
<p>▫<strong>no-export</strong>：指定不向自治系统外部通告路由。如果使用了联盟，则不向联盟外部通告路由，但会通告给联盟中的其他子自治系统。</p>
<p>•命令：[Huawei] <strong>ip community-filter</strong> { <strong>advanced</strong> <em>comm*</em>-filter-name* | <em>adv*</em>-<strong>comm</strong>-filter-*<em>num</em> } { <strong>permit</strong> | <strong>deny</strong> } <em>regular-expression</em></p>
<p>▫<strong>advanced</strong> <em>comm*</em>-filter-name*：指定高级团体属性过滤器名称。字符串形式，区分大小写，取值范围是1~51个字符，且不能都是数字。</p>
<p>▫<em>adv*</em>-<strong>comm</strong>-filter-*<em>num</em>：指定高级团体属性过滤器号。整数形式，取值范围100~199。</p>
<p>▫<em>regular-expression</em>：指定团体属性正则表达式。字符串形式，支持空格，区分大小写，取值范围是1~255。</p>
</blockquote>
<h2 id="Community-Filter的基础配置命令-2"><a href="#Community-Filter的基础配置命令-2" class="headerlink" title="Community Filter的基础配置命令 (2)"></a>Community Filter的基础配置命令 (2)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/14.png"></p>
<blockquote>
<p>•命令：[Huawei-route-policy] <strong>if-match community-filter</strong> { <em>basic-<strong>comm</strong>-filter-num</em> [ <strong>whole-match</strong> ] | <em>adv*</em>-<strong>comm</strong>-filter-*<em>num</em> }</p>
<p>•命令：[Huawei-route-policy] <strong>if-match community-filter</strong> <em>comm-filter-name</em> [ <strong>whole-match</strong> ]</p>
<ul>
<li><em>basic-<strong>comm</strong>-filter-num</em>：指定基本团体属性过滤器号。整数形式，取值范围是1~99。</li>
<li><em>adv*</em>-<strong>comm</strong>-filter-*<em>num</em>：指定高级团体属性过滤器号。整数形式，取值范围是100~199。</li>
<li><em>comm-filter-name</em>：指定团体属性过滤器名称。字符串形式，区分大小写，不支持空格，长度范围是1~51，且不能都是数字。当输入的字符串两端使用双引号时，可在字符串中输入空格。</li>
<li><strong>whole-match</strong>：表示完全匹配，即所有的团体都必须出现。仅对基本团体属性过滤器生效。</li>
</ul>
</blockquote>
<h2 id="Community-Filter的配置举例"><a href="#Community-Filter的配置举例" class="headerlink" title="Community Filter的配置举例"></a>Community Filter的配置举例</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/15.png"></p>
<h2 id="配置Community属性-1"><a href="#配置Community属性-1" class="headerlink" title="配置Community属性 (1)"></a>配置Community属性 (1)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/16.png"></p>
<blockquote>
<p>•命令：[R1] <strong>route-policy</strong> Community <strong>permit node</strong> 20</p>
<p>•通过配置该命令允许10.1.2.2/32路由被正常通告。</p>
</blockquote>
<h2 id="配置Community属性-2"><a href="#配置Community属性-2" class="headerlink" title="配置Community属性 (2)"></a>配置Community属性 (2)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/17.png"></p>
<h2 id="配置Community属性-3"><a href="#配置Community属性-3" class="headerlink" title="配置Community属性 (3)"></a>配置Community属性 (3)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/18.png"></p>
<h2 id="配置Community-Filter-1"><a href="#配置Community-Filter-1" class="headerlink" title="配置Community Filter (1)"></a>配置Community Filter (1)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/19.png"></p>
<h2 id="配置Community-Filter-2"><a href="#配置Community-Filter-2" class="headerlink" title="配置Community Filter (2)"></a>配置Community Filter (2)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/20.png"></p>
<h2 id="配置Community-Filter-3"><a href="#配置Community-Filter-3" class="headerlink" title="配置Community Filter (3)"></a>配置Community Filter (3)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/21.png"></p>
<h1 id="2-BGP特性介绍"><a href="#2-BGP特性介绍" class="headerlink" title="2.BGP特性介绍"></a>2.BGP特性介绍</h1><h2 id="邻居按需发布路由"><a href="#邻居按需发布路由" class="headerlink" title="邻居按需发布路由"></a>邻居按需发布路由</h2><p>•如果设备希望只接收自己需要的路由，但对端设备又无法针对每个与它连接的设备维护不同的出口策略。此时，可以通过配置BGP基于前缀的ORF（Outbound Route Filters，出口路由过滤器）来满足两端设备的需求。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/22.png"></p>
<h2 id="ORF的基础配置命令"><a href="#ORF的基础配置命令" class="headerlink" title="ORF的基础配置命令"></a>ORF的基础配置命令</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/23.png"></p>
<blockquote>
<p>•命令：[Huawei-bgp-af-ipv4] <strong>peer</strong> { <em>group-name</em> | <em>ipv4-address</em> } <strong>ip-prefix</strong> <em>ip-prefix-name</em> { <strong>import</strong> | <strong>export</strong> }</p>
<p>​    ▫<strong>import</strong>：对由指定对等体（组）接收的路由应用过滤策略。</p>
<p>​    ▫<strong>export</strong>：对向指定对等体（组）发送的路由应用过滤策略。</p>
<p>•命令：[Huawei-bgp] <strong>peer</strong> { <em>group-name</em> | <em>ipv4-address</em> } <strong>capability-advertise</strong> <strong>orf</strong> [ <strong>non-standard-compatible</strong> ] <strong>ip-prefix</strong> { <strong>both</strong> | <strong>receive</strong> | <strong>send</strong> } [ <strong>standard-match</strong> ]</p>
<p>​    ▫<strong>non-standard-compatible</strong>：指定与非标准设备兼容。</p>
<p>​    ▫<strong>both</strong>：表示允许发送和接收ORF报文。</p>
<p>​    ▫<strong>receive</strong>：表示只允许接收ORF报文。</p>
<p>​    ▫<strong>send</strong>：表示只允许发送ORF报文。</p>
<p>​    ▫<strong>standard-match</strong>：指定按照RFC标准规定的前缀匹配规则来匹配路由。</p>
</blockquote>
<h2 id="ORF配置举例"><a href="#ORF配置举例" class="headerlink" title="ORF配置举例"></a>ORF配置举例</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/24.png"></p>
<h2 id="查看ORF配置"><a href="#查看ORF配置" class="headerlink" title="查看ORF配置"></a>查看ORF配置</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/25.png"></p>
<h2 id="BGP对等体组"><a href="#BGP对等体组" class="headerlink" title="BGP对等体组"></a>BGP对等体组</h2><p>•对等体组（Peer Group）是一些具有某些相同策略的对等体的集合。当一个对等体加入对等体组中时，该对等体将获得与所在对等体组相同的配置。当对等体组的配置改变时，组内成员的配置也相应改变。</p>
<p>•在大型BGP网络中，对等体的数量会很多，其中很多对等体具有相同的策略，在配置时会重复使用一些命令，利用对等体组可以简化配置。</p>
<blockquote>
<p>•对等体组中的单个对等体也可以配置自己的发布路由与接收路由的策略。</p>
</blockquote>
<h2 id="BGP对等体组的基础配置命令"><a href="#BGP对等体组的基础配置命令" class="headerlink" title="BGP对等体组的基础配置命令"></a>BGP对等体组的基础配置命令</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/26.png"></p>
<blockquote>
<p>•命令：[Huawei-bgp] <strong>group</strong> <em>group-name</em> [ <strong>external</strong> | <strong>internal</strong> ]</p>
<p>​    ▫<em>group-name</em>：指定对等体组的名称。字符串形式，区分大小写，不支持空格，长度范围是1~47。当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
<p>​    ▫<strong>external</strong>：表示创建EBGP对等体组。</p>
<p>​    ▫<strong>internal</strong>：表示创建IBGP对等体组。</p>
</blockquote>
<h2 id="BGP对等体组配置举例"><a href="#BGP对等体组配置举例" class="headerlink" title="BGP对等体组配置举例"></a>BGP对等体组配置举例</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/27.png"></p>
<blockquote>
<p>•如图所示：假设AS102内，通过静态路由或OSPF实现AS102内部网络可达，配置省略。</p>
</blockquote>
<h2 id="查看BGP对等体组配置"><a href="#查看BGP对等体组配置" class="headerlink" title="查看BGP对等体组配置"></a>查看BGP对等体组配置</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/28.png"></p>
<h2 id="BGP安全性"><a href="#BGP安全性" class="headerlink" title="BGP安全性"></a>BGP安全性</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/29.png"></p>
<h2 id="BGP认证"><a href="#BGP认证" class="headerlink" title="BGP认证"></a>BGP认证</h2><p>BGP认证分为MD5认证和Keychain认证，对BGP对等体关系进行认证可以预防非法BGP邻居建立。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/30.png"></p>
<blockquote>
<p>•BGP使用TCP作为传输协议，只要TCP数据包的源地址、目的地址、源端口、目的端口和TCP序号是正确的，BGP就会认为这个数据包有效，但数据包的大部分参数对于攻击者来说是不难获得的。为了保证BGP免受攻击，可以在BGP邻居之间使用MD5认证或者Keychain认证来降低被攻击的可能性。</p>
<ul>
<li><p>MD5算法配置简单，配置后生成单一密码，需要人为干预才可以更换密码。</p>
</li>
<li><p>Keychain具有一组密码，可以根据配置自动切换，但是配置过程较为复杂，适用于对安全性能要求比较高的网络。</p>
</li>
</ul>
<p>•注意：BGP的MD5认证与BGP的Keychain认证互斥。</p>
</blockquote>
<h2 id="BGP的GTSM"><a href="#BGP的GTSM" class="headerlink" title="BGP的GTSM"></a>BGP的GTSM</h2><p>BGP的GTSM功能检测IP报文头中的TTL（Time-to-Live）值是否在一个预先设置好的特定范围内，并对不符合TTL值范围的报文进行丢弃，这样就避免了网络攻击者模拟“合法”BGP报文攻击设备。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/31.png"></p>
<blockquote>
<p>•如图所示：如果没有使能BGP的GTSM功能，设备收到大量非法BGP报文后，发现是发送给本机的报文，会直接上送控制层面处理。这时将会因为控制层面处理大量攻击报文，导致设备CPU占用率高，系统异常繁忙。</p>
</blockquote>
<h2 id="BGP认证的基础配置命令"><a href="#BGP认证的基础配置命令" class="headerlink" title="BGP认证的基础配置命令"></a>BGP认证的基础配置命令</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/32.png"></p>
<blockquote>
<p>•命令：[Huawei-bgp] <strong>peer</strong> { <em>group-name</em> | <em>ipv4-address</em> | <em>ipv6-address</em> } <strong>keychain</strong> <em>keychain-name</em></p>
<p>▫<em>keychain-name</em>：指定Keychain名称。字符串形式，长度范围是1~47，不区分大小写。字符不包括问号和空格，但是当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
</blockquote>
<h2 id="GTSM功能的基础配置命令"><a href="#GTSM功能的基础配置命令" class="headerlink" title="GTSM功能的基础配置命令"></a>GTSM功能的基础配置命令</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/33.png"></p>
<blockquote>
<p>•命令：[Huawei-bgp] <strong>peer</strong> { <em>group-name</em> | <em>ipv4-address</em> | <em>ipv6-address</em> } <strong>valid-ttl-hops</strong> [ <em>hops</em> ]</p>
<ul>
<li><em>hops</em>：指定需要检测的TTL跳数值。整数形式，取值范围是1~255，缺省值是255。如果配置为hops，则被检测的报文的TTL值有效范围为[255–hops+1, 255]</li>
</ul>
<p>•命令：[Huawei] <strong>gtsm</strong> <strong>default-action</strong> { <strong>drop</strong> | <strong>pass</strong> }</p>
<ul>
<li><p><strong>drop</strong>：未匹配GTSM策略的报文不能通过过滤，报文被丢弃。</p>
</li>
<li><p><strong>pass</strong>：未匹配GTSM策略的报文可以通过过滤。</p>
</li>
</ul>
<p>•命令：[Huawei] <strong>gtsm</strong> <strong>log drop-packet</strong> <strong>all</strong></p>
<ul>
<li><strong>all</strong>：所有单板。</li>
</ul>
</blockquote>
<h2 id="GTSM配置举例-1"><a href="#GTSM配置举例-1" class="headerlink" title="GTSM配置举例 (1)"></a>GTSM配置举例 (1)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/34.png"></p>
<blockquote>
<p>•如图所示：</p>
<p>▫假设AS101内，通过静态路由或OSPF实现AS101内部网络可达，配置省略。</p>
<p>▫R1通告Loopback0接口地址到BGP中。</p>
</blockquote>
<h2 id="GTSM配置举例-2"><a href="#GTSM配置举例-2" class="headerlink" title="GTSM配置举例 (2)"></a>GTSM配置举例 (2)</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/35.png"></p>
<h2 id="查看GTSM配置"><a href="#查看GTSM配置" class="headerlink" title="查看GTSM配置"></a>查看GTSM配置</h2><p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/36.png"></p>
<h1 id="3-BGP路由反射器组网方式"><a href="#3-BGP路由反射器组网方式" class="headerlink" title="3.BGP路由反射器组网方式"></a>3.BGP路由反射器组网方式</h1><h2 id="路由反射器"><a href="#路由反射器" class="headerlink" title="路由反射器"></a>路由反射器</h2><p>引入路由反射器，可以简化IBGP全互联的需求，也可以减轻网络和CPU的负担。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/37.png"></p>
<blockquote>
<p>•路由反射器相关角色：</p>
<p>▫RR：允许把从IBGP对等体学到的路由反射到其他IBGP对等体的BGP设备，类似OSPF网络中的DR。</p>
<p>▫Client：与RR形成反射邻居关系的IBGP设备。在AS内部客户机只需要与RR直连。</p>
<p>▫Non-Client：既不是RR也不是客户机的IBGP设备。在AS内部非客户机与RR之间，以及所有的非客户机之间仍然必须建立全互联关系。</p>
<p>▫Originator（始发者）：在AS内部始发路由的设备。Originator_ID属性用于防止集群内产生路由环路。</p>
<p>▫Cluster（集群）：路由反射器及其客户机的集合。Cluster_List属性用于防止集群间产生路由环路。</p>
<p>•将一台BGP路由器指定为RR的同时，还需要指定其Client。至于Client本身，无需做任何配置，它并不知晓网络中存在RR。</p>
<p>•RR发布路由规则：</p>
<ul>
<li>从非客户机IBGP对等体学到的路由，发布给此RR的所有客户机。</li>
<li>从客户机学到的路由，发布给此RR的所有非客户机和客户机。</li>
<li>从EBGP对等体学到的路由，发布给所有的非客户机和客户机。</li>
</ul>
</blockquote>
<h2 id="常见组网：备份RR组网"><a href="#常见组网：备份RR组网" class="headerlink" title="常见组网：备份RR组网"></a>常见组网：备份RR组网</h2><p>•为增加网络的可靠性，防止单点故障对网络造成影响，有时需要在一个集群中配置一个以上的RR。</p>
<p>•转发路径上的路由器与所有RR均建立IBGP关系，任意一个RR均有完整的BGP路由。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/38.png"></p>
<h2 id="常见组网：多集群RR组网-1"><a href="#常见组网：多集群RR组网-1" class="headerlink" title="常见组网：多集群RR组网 (1)"></a>常见组网：多集群RR组网 (1)</h2><p>•一个AS中可以存在多个集群，各个集群的RR之间建立IBGP对等体。</p>
<p>•当RR所处的网络层相同时，可以将不同集群的RR全互联，形成同级RR。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/39.png"></p>
<h2 id="常见组网：多集群RR组网-2"><a href="#常见组网：多集群RR组网-2" class="headerlink" title="常见组网：多集群RR组网 (2)"></a>常见组网：多集群RR组网 (2)</h2><p>•一个AS中可以存在多个集群，各个集群的RR之间建立IBGP对等体。</p>
<p>•当RR所处的网络层不同时，可以将较低网络层次的RR配成客户机，形成分级RR。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/40.png"></p>
<blockquote>
<p>•分级RR与单级RR的路由发布规则相同。</p>
<p>•分级RR设计需要考虑两个因素：</p>
<ul>
<li>顶层全互联的拓扑大小：如果IBGP全互联数量已经多到难以管理了，则可考虑引入RR分级部署。</li>
<li>可替代路径的数量：该因素影响负载分担和资源消耗。越多的层次越会减少负载分担链路的数量，但需要的路由器资源更少。</li>
</ul>
</blockquote>
<h2 id="单集群问题"><a href="#单集群问题" class="headerlink" title="单集群问题"></a>单集群问题</h2><p>为了在基于RR的架构中提供所期望的冗余，正确的集群划分是非常重要的。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/41.png"></p>
<h2 id="多集群设计"><a href="#多集群设计" class="headerlink" title="多集群设计"></a>多集群设计</h2><p>多集群设计不仅提供了针对链路失效的物理冗余，同时提供了针对客户机与RR之间的IBGP会话失效的逻辑冗余。</p>
<p><img src="/2021/06/30/IPadv-BGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/42.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）命令**“ip as-path-filter 1 permit ^(100|200)$**”中匹配到的AS_Path是什么？(   )</p>
<p>A.AS_Path 100</p>
<p>B.AS_Path 200</p>
<p>C.AS_Path 100 200</p>
<p><strong>D.AS_Path 100 或 AS_Path 200</strong></p>
<p>2.（判断题）BGP的GTSM功能，可以预防非法BGP邻居建立。(   )</p>
<p>A.正确</p>
<p><strong>B.错误</strong></p>
<p>3.（判断题）BGP的备份RR组网中，主备RR收到对方反射的路由会丢弃，避免路由环路。(   )</p>
<p><strong>A.正确</strong></p>
<p>B.错误</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•AS_Path Filter和Community Filter都是BGP专有的路由匹配工具，可以使用这两种工具匹配AS_Path属性或Community属性来匹配BGP路由，再与路由策略相结合，从而实现BGP的路由控制。</p>
<p>•BGP还支持各种高级特性，包括：通过ORF功能实现邻居按需发布路由，通过对等体组简化配置，通过BGP安全特性预防非法邻居建立以及非法BGP报文攻击。</p>
<p>•BGP通过RR打破了IBGP水平分割规则，简化了IBGP全互联的需求，也减轻了网络和CPU的负担。常见的RR组网方式包括：备份RR组网和多集群RR组网。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/" itemprop="url">IPadv-MPLSVPN部署与应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T15:17:09+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•BGP/MPLS IP VPN因其支持地址空间重叠、组网方式灵活、可扩展性好，并能够方便地支持MPLS TE等一系列优点，已经在广域IP承载网络得到了广泛的应用。</p>
<p>•针对不同客户的业务需求以及组网情况，MPLS VPN的部署方式不尽相同。</p>
<p>•本课程将介绍几种常见的MPLS VPN应用场景与这些场景下MPLS VPN的部署方法，此外还将介绍OSPF对MPLS VPN的扩展特性与功能。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述MPLS VPN的应用场景与组网类型</p>
<p>▫部署MPLS VPN的Intranet方案</p>
<p>▫部署MPLS VPN的Hub&amp;Spoke方案</p>
<p>▫描述OSPF对MPLS VPN扩展功能与特性</p>
<h1 id="1-MPLS-VPN应用与组网概述"><a href="#1-MPLS-VPN应用与组网概述" class="headerlink" title="1.MPLS VPN应用与组网概述"></a>1.MPLS VPN应用与组网概述</h1><h2 id="MPLS-VPN典型应用"><a href="#MPLS-VPN典型应用" class="headerlink" title="MPLS VPN典型应用"></a>MPLS VPN典型应用</h2><p>•目前，MPLS VPN的主要应用包括企业互连和虚拟业务网络。</p>
<p>▫企业互连应用：可通过MPLS VPN将分布在各地的分支机构、出差员工和合作伙伴的IP网络连接在一起；</p>
<p>▫虚拟业务网络：可在同一物理网络上运行多种业务，如VoIP、IPTV等，为每个业务建立一个VPN，实现业务隔离。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/1.png"></p>
<blockquote>
<p>•MPLS VPN的主要优点包括但不限于以下几项：</p>
<ul>
<li>可以实现“一点接入，全网连通”，支持异种介质的互连。而不像传统专线那样在每一对用户设备间采用同样的介质连接，可方便地提供普遍服务。</li>
<li>可以实现“弹性带宽”，采用流量监管技术，在保证用户基本带宽的同时，对突发流量尽力而为，同时基本带宽也可以“软扩容”，即根据用户的需求在一个范围内连续选择。</li>
<li>在资源隔离或隧道绑定的MPLS VPN技术保证下，充分保证每个VPN的专有带宽，满足各类业务有不同的用户，不同的流量模型，不同的QoS要求。</li>
</ul>
</blockquote>
<h2 id="MPLS-VPN基本组网-Intranet"><a href="#MPLS-VPN基本组网-Intranet" class="headerlink" title="MPLS VPN基本组网 - Intranet"></a>MPLS VPN基本组网 - Intranet</h2><p>当采用Intranet组网方案时，一个VPN中的所有用户形成闭合用户群，相互之间能够进行流量转发，VPN中的用户不能与任何本VPN以外的用户通信，其站点通常是属于同一个组织。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/2.png"></p>
<h2 id="MPLS-VPN基本组网-Extranet"><a href="#MPLS-VPN基本组网-Extranet" class="headerlink" title="MPLS VPN基本组网 - Extranet"></a>MPLS VPN基本组网 - Extranet</h2><p>当采用Extranet组网方案时，VPN用户可将部分站点中的网络资源给其他VPN用户进行访问。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/3.png"></p>
<h2 id="MPLS-VPN基本组网-Hub-amp-Spoke-1"><a href="#MPLS-VPN基本组网-Hub-amp-Spoke-1" class="headerlink" title="MPLS VPN基本组网 - Hub&amp;Spoke (1)"></a>MPLS VPN基本组网 - Hub&amp;Spoke (1)</h2><p>当采用Hub&amp;Spoke方案时，可以将多个站点中的一个站点设置为Hub站点，其余站点为Spoke站点。站点间的互访必须通过Hub站点，通过Hub站点集中管控站点间的数据传输。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/4.png"></p>
<h2 id="MPLS-VPN基本组网-Hub-amp-Spoke-2"><a href="#MPLS-VPN基本组网-Hub-amp-Spoke-2" class="headerlink" title="MPLS VPN基本组网 - Hub&amp;Spoke (2)"></a>MPLS VPN基本组网 - Hub&amp;Spoke (2)</h2><p>从Site1到Site2的路由发布过程如下：</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/5.png"></p>
<h2 id="MCE组网"><a href="#MCE组网" class="headerlink" title="MCE组网"></a>MCE组网</h2><p>•当一个私网需要根据业务或者网络划分VPN时，不同VPN用户间的业务需要完全隔离。此时，为每个VPN单独配置一台CE将增加用户的设备开支和维护成本。</p>
<p>•具有MCE（Multi-VPN-Instance，CE多实例CE）功能的CE设备可以在MPLS VPN组网应用中承担多个VPN实例的CE功能，减少用户网络设备的投入。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/6.png"></p>
<h2 id="MPLS-VPN跨域组网"><a href="#MPLS-VPN跨域组网" class="headerlink" title="MPLS VPN跨域组网"></a>MPLS VPN跨域组网</h2><p>•随着MPLS VPN解决方案的广泛应用，服务的终端用户的规格和范围也在增长，在一个企业内部的站点数目越来越大，某个地理位置与另外一个服务提供商相连的需求变得非常的普遍，例如国内运营商的不同城域网之间，或相互协作的运营商的骨干网之间都存在着跨越不同自治系统（AS，Autonomous System）的情况。</p>
<p>•一般的MPLS VPN体系结构都是在一个AS内运行，任何VPN的路由信息都是只能在一个AS内按需扩散。AS之间的MPLS VPN部署需要通过跨域（Inter-AS） MPLS VPN解决方案来实现。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/7.png"></p>
<blockquote>
<p>•RFC2547中提出了三种跨域VPN解决方案，分别是：</p>
<ul>
<li>跨域VPN-OptionA（Inter-Provider Backbones Option A）方式：需要跨域的VPN在ASBR（AS Boundary Router）间通过专用的接口管理自己的VPN路由，也称为VRF-to-VRF；</li>
<li>跨域VPN-OptionB（Inter-Provider Backbones Option B）方式：ASBR间通过MP-EBGP发布标签VPN-IPv4路由，也称为EBGP redistribution of labeled VPN-IPv4 routes；</li>
<li>跨域VPN-OptionC（Inter-Provider Backbones Option C）方式：PE间通过Multi-hop MP-EBGP发布标签VPN-IPv4路由，也称为Multihop EBGP redistribution of labeled VPN-IPv4 routes。</li>
</ul>
<p>•更多跨域MPLS VPN相关内容，请参考HCIE-Datacom相关课程。</p>
</blockquote>
<h1 id="2-MPLS-VPN典型场景部署介绍"><a href="#2-MPLS-VPN典型场景部署介绍" class="headerlink" title="2.MPLS VPN典型场景部署介绍"></a>2.MPLS VPN典型场景部署介绍</h1><h2 id="Intranet场景"><a href="#Intranet场景" class="headerlink" title="Intranet场景"></a>Intranet场景</h2><h3 id="部署Intranet场景的MPLS-VPN"><a href="#部署Intranet场景的MPLS-VPN" class="headerlink" title="部署Intranet场景的MPLS VPN"></a>部署Intranet场景的MPLS VPN</h3><p>•如图所示，客户X及Y各自有2个站点，现需要通过MPLS VPN实现站点之间的互联，分别对应VPNX和VPNY；</p>
<p>•互联接口、AS号及IP地址信息，CE与PE通过如图的协议或方法交换路由信息；</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/8.png"></p>
<blockquote>
<p>•注：本课程仅讨论非跨域的MPLS VPN部署场景。</p>
</blockquote>
<h3 id="部署思路"><a href="#部署思路" class="headerlink" title="部署思路"></a>部署思路</h3><p>1.MPLS VPN骨干网配置</p>
<p>1.1 IGP配置，实现骨干网的IP连通性。</p>
<p>1.2 MPLS与MPLS LDP配置，建立MPLS LSP公网隧道，传输VPN数据。</p>
<p>1.3 MP-BGP配置，建立后续传递VPNv4路由的MP-BGP对等体关系。</p>
<p>2.VPN用户接入配置</p>
<p>2.1 创建VPN实例并配置参数（RT、RD）</p>
<p>2.2 将接口加入VPN实例</p>
<p><strong>2.3</strong> <strong>配置PE与CE之间的路由交换</strong></p>
<h3 id="PE-CE之间部署OSPF-1"><a href="#PE-CE之间部署OSPF-1" class="headerlink" title="PE-CE之间部署OSPF (1)"></a>PE-CE之间部署OSPF (1)</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/9.png"></p>
<h3 id="PE-CE之间部署OSPF-2"><a href="#PE-CE之间部署OSPF-2" class="headerlink" title="PE-CE之间部署OSPF (2)"></a>PE-CE之间部署OSPF (2)</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/10.png"></p>
<h3 id="PE-CE之间部署静态路由"><a href="#PE-CE之间部署静态路由" class="headerlink" title="PE-CE之间部署静态路由"></a>PE-CE之间部署静态路由</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/11.png"></p>
<h3 id="PE-CE之间部署EBGP"><a href="#PE-CE之间部署EBGP" class="headerlink" title="PE-CE之间部署EBGP"></a>PE-CE之间部署EBGP</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/12.png"></p>
<h3 id="特殊场景下的BGP配置-AS号替换"><a href="#特殊场景下的BGP配置-AS号替换" class="headerlink" title="特殊场景下的BGP配置 - AS号替换"></a>特殊场景下的BGP配置 - AS号替换</h3><p>在MPLS VPN场景中，若PE与CE之间运行EBGP交互路由信息，则可能会出现两个站点的AS号相同的情况。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/13.png"></p>
<h3 id="特殊场景下的BGP配置-SoO"><a href="#特殊场景下的BGP配置-SoO" class="headerlink" title="特殊场景下的BGP配置 - SoO"></a>特殊场景下的BGP配置 - SoO</h3><p>•在CE多归属场景，若使能了BGP的AS号替换功能，可能会引起路由环路，需要SoO（Site of Origin）特性来避免环路。</p>
<ul>
<li><p>CE1与CE3处于同一个VPN站点1，CE2位于站点Site2，Site1和Site2站点所在的AS号都为65001。PE与CE之间运行的都是EBGP路由协议，为了Site 1和Site 2之间的路由可以正常学习，需要在PE1和PE2上配置AS号替换功能。</p>
</li>
<li><p>CE1传递站点内的路由给PE1，PE1传递该路由给CE3，由于配置AS号替换，CE3会接收该路由，可能会导致产生路由环路。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/14.png"></p>
<blockquote>
<p>•注：192.168.100.1和192.168.200.1分别是CE1和CE3上和PE1建立BGP对等体的接口地址。</p>
</blockquote>
<h3 id="PE-CE之间部署IS-IS"><a href="#PE-CE之间部署IS-IS" class="headerlink" title="PE-CE之间部署IS-IS"></a>PE-CE之间部署IS-IS</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/15.png"></p>
<h2 id="Hub-amp-Spoke场景"><a href="#Hub-amp-Spoke场景" class="headerlink" title="Hub&amp;Spoke场景"></a>Hub&amp;Spoke场景</h2><h3 id="部署Hub-amp-Spoke场景的MPLS-VPN"><a href="#部署Hub-amp-Spoke场景的MPLS-VPN" class="headerlink" title="部署Hub&amp;Spoke场景的MPLS VPN"></a>部署Hub&amp;Spoke场景的MPLS VPN</h3><p>•Hub&amp;Spoke有以下组网方案：</p>
<p>​    ▫方式一：Hub-CE与Hub-PE，Spoke-PE与Spoke-CE使用EBGP</p>
<p>​    ▫方式二：Hub-CE与Hub-PE，Spoke-PE与Spoke-CE使用IGP</p>
<p>​    ▫方式三：Hub-CE与Hub-PE使用EBGP，Spoke-PE与Spoke-CE使用IGP</p>
<p>•<strong>无法</strong>通过Hub-CE与Hub-PE使用IGP，Spoke-PE与Spoke-CE使用EBGP来部署Hub&amp;Spoke组网的MPLS VPN。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/16.png"></p>
<h3 id="VRF配置"><a href="#VRF配置" class="headerlink" title="VRF配置"></a>VRF配置</h3><p>•Spoke-PE上创建一个VPN实例，RT配置如图。</p>
<p>•Hub-PE上创建VPN_in和VPN_out两个VPN实例，分别用于从Spoke-PE接收私网路由或向Spoke-PE发布私网路由，RT配置如图。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/17.png"></p>
<h3 id="方式一部署-路由发布过程"><a href="#方式一部署-路由发布过程" class="headerlink" title="方式一部署 - 路由发布过程"></a>方式一部署 - 路由发布过程</h3><p>•Spoke-CE与Spoke-PE之间通过EBGP交互路由信息，建立EBGP连接后，把相关的路由发布到BGP即可。</p>
<p>•Hub-PE与Hub-CE之间建立两条EBGP连接，分别用来发布和接收私网路由。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/18.png"></p>
<blockquote>
<p>•以路由从Spoke-CE1发布到Spoke-CE2为例，大体过程如下：</p>
<p>1.Spoke-CE1通过EBGP将路由发布给Spoke-PE1。</p>
<p>2.Spoke-PE1通过IBGP将该路由发布给Hub-PE。</p>
<p>3.Hub-PE通过VPN实例（VPN_in）的Import Target属性将该路由引入VPN_in路由表，并通过EBGP发布给Hub-CE。</p>
<p>4.Hub-CE通过EBGP连接学习到该路由，并通过另一个EBGP连接将该路由发布给Hub-PE的VPN实例（VPN_out）。</p>
<p>5.Hub-PE发布携带VPN_out的Export Target属性的路由给所有Spoke-PE。</p>
<p>6.Spoke-PE2通过EBGP将该路由发布给Spoke-CE2。</p>
</blockquote>
<h3 id="方式一部署-Hub-PE与Hub-CE间配置"><a href="#方式一部署-Hub-PE与Hub-CE间配置" class="headerlink" title="方式一部署 - Hub-PE与Hub-CE间配置"></a>方式一部署 - Hub-PE与Hub-CE间配置</h3><p>•Hub-PE通过VPN_in对应的EBGP连接将从Spoke站点学习的路由发布到Hub站点。</p>
<p>•Hub-CE通过VPN_out对应的EBGP将这些路由发布到Spoke站点。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/19.png"></p>
<h3 id="方式二部署-路由发布过程"><a href="#方式二部署-路由发布过程" class="headerlink" title="方式二部署 - 路由发布过程"></a>方式二部署 - 路由发布过程</h3><p>•以选用OSPF作为IGP协议为例：</p>
<p>▫Spoke-CE与Spoke-PE之间通过OSPF（进程100）邻居关系交互路由信息。</p>
<p>▫Hub-PE通过两个OSPF进程与Hub-CE建立OSPF邻居，分别负责私网路由的发送和接收。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/20.png"></p>
<blockquote>
<p>•以路由从Spoke-CE1发布到Spoke-CE2为例，大体过程如下：</p>
<p>1.Spoke-CE1通过OSPF100将路由发布给Spoke-PE1。</p>
<p>2.Spoke-PE1通过IBGP将路由发布给Hub-PE。</p>
<p>3.Hub-PE通过VPN实例（VPN_in）的Import Target属性将该路由引入VPN_in路由表；通过将BGP引入OSPF100的配置进而将从Spoke-PE1传递来的路由发布给Hub-CE。</p>
<p>4.Hub-CE通过OSPF100接收该路由；并通过配置路由引入将路由发布到OSPF200，OSPF200再将路由发布给Hub-PE。</p>
<p>5.Hub-PE的BGP-VPN实例（VPN_out）引入OSPF200多实例的路由，将携带Export Target属性的路由发布给所有Spoke-PE。</p>
<p>6.Spoke-PE2通过OSPF100将该路由发布给Spoke-CE2。</p>
</blockquote>
<h3 id="方式二部署-Hub-PE与Hub-CE间配置"><a href="#方式二部署-Hub-PE与Hub-CE间配置" class="headerlink" title="方式二部署 - Hub-PE与Hub-CE间配置"></a>方式二部署 - Hub-PE与Hub-CE间配置</h3><p>•Hub-PE通过VPN_in对应的OSPF（进程100）将从Spoke站点学习的路由发布到Hub站点。</p>
<p>•Hub-CE通过VPN_out对应的OSPF（进程200）将这些路由发布到Hub-PE，进而发布给所有Spoke站点。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/21.png"></p>
<h3 id="方式三部署-路由发布过程"><a href="#方式三部署-路由发布过程" class="headerlink" title="方式三部署 - 路由发布过程"></a>方式三部署 - 路由发布过程</h3><p>•以选用OSPF作为IGP协议为例，Spoke-CE与Spoke-PE之间通过OSPF（进程100）邻居关系交互路由信息。</p>
<p>•Hub-PE与Hub-CE之间建立两条EBGP连接，分别用来发布和接收私网路由，Hub-PE与Hub-CE的配置与方式一相同。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/22.png"></p>
<blockquote>
<p>•以路由从Spoke-CE1发布到Spoke-CE2为例，大体过程如下：</p>
<p>1.Spoke-CE1通过OSPF100将路由发布给Spoke-PE1。</p>
<p>2.Spoke-PE1通过IBGP将路由发布给Hub-PE。</p>
<p>3.Hub-PE通过VPN实例（VPN_in）的Import Target属性将该路由引入VPN_in路由表，并通过EBGP发布给Hub-CE。</p>
<p>4.Hub-CE通过EBGP连接学习到该路由，并通过另一个EBGP连接将该路由发布给Hub-PE的VPN实例（VPN_out）。</p>
<p>5.Hub-PE发布携带VPN_out的Export Target属性的路由给Spoke-PE2。</p>
<p>6.Spoke-PE2通过OSPF100将该路由发布给Spoke-CE2。</p>
</blockquote>
<h3 id="为什么没有方式四？"><a href="#为什么没有方式四？" class="headerlink" title="为什么没有方式四？"></a>为什么没有方式四？</h3><p>•<strong>无法</strong>通过Hub-CE与Hub-PE使用IGP，Spoke-PE与Spoke-CE使用EBGP来部署Hub&amp;Spoke组网的MPLS VPN</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/23.png"></p>
<blockquote>
<p>•以从Spoke-CE1向Spoke-CE2发布路由（目的地址为192.168.1.0/24）为例，大体过程如下：</p>
<p>1.Spoke-CE1通过EBGP将路由发布给Spoke-PE1。</p>
<p>2.Spoke-PE1通过IBGP将路由发布给Hub-PE。</p>
<p>3.Hub-PE通过BGP-VPN实例（VPN_in）的Import Target属性将该路由引入VPN_in路由表；并通过OSPF100多实例发布给Hub-CE。</p>
<p>4.Hub-CE通过OSPF100学习到该路由；并通过OSPF200将路由发布给Hub-PE。</p>
<p>5.Hub-PE的BGP-VPN实例（VPN_out）引入OSPF200多实例路由，并将携带VPN_out的Export Target属性的路由发布给所有Spoke-PE。</p>
<p>6.Spoke-PE2的VPN实例根据Import Target属性引入该路由；Spoke-PE2通过EBGP发布给本地Spoke-CE2。</p>
<p>•Hub-PE的BGP-VPN实例（VPN_out）通过Export Target属性将路由发布给Spoke-PE2的同时，也会将该路由发布给Spoke-PE1。此时，这条路由是Hub-PE通过IGP（OSPF200多实例）引入的，由于IGP路由不携带AS-PATH属性，AS_Path为空；而原来从Spoke-CE1来的192.168.1.0/24路由，其AS_Path不为空，所以从Hub-PE返回的路由会优于从Spoke-CE1来的路由。这样会引起路由振荡，其过程如下：</p>
<p>1.Spoke-CE1发来的路由因为AS_Path变成非最佳路由</p>
<p>2.Spoke-PE1发布Update撤销路由的报文给Hub-PE来撤销192.168.1.0/24路由</p>
<p>3.Hub-PE（通过撤销相应的OSPF LSA）撤销发给Hub-CE的路由</p>
<p>4.Hub-CE（原理同上）撤销发给Hub-PE的路由</p>
<p>5.Hub-PE发布Update撤销路由撤销发给Spoke-PE1的路由</p>
<p>•于是在Spoke-PE1上从Spoke-CE1来的路由又变成最佳路由。Spoke-PE1又通过IBGP将路由发布给Hub-PE。Hub-PE又会返回该路由，从Spoke-CE1来的路由又变成非最佳路由。如此反复。</p>
</blockquote>
<h1 id="3-OSPF-VPN拓展"><a href="#3-OSPF-VPN拓展" class="headerlink" title="3.OSPF VPN拓展"></a>3.OSPF VPN拓展</h1><h2 id="OSPF与BGP互操作"><a href="#OSPF与BGP互操作" class="headerlink" title="OSPF与BGP互操作"></a>OSPF与BGP互操作</h2><h3 id="MPLS-VPN中的OSPF-BGP"><a href="#MPLS-VPN中的OSPF-BGP" class="headerlink" title="MPLS VPN中的OSPF/BGP"></a>MPLS VPN中的OSPF/BGP</h3><p>•当PE-CE间部署OSPF交互路由信息时，若在PE上使用标准BGP/OSPF过程（简称为BGP/OSPF互操作）互来传递路由信息，则远端PE在将BGP引入VPN实例的OSPF进程时，会直接产生Type5 LSA，不同站点都会将其他站点的路由视为自治系统外部路由（AS_external）。</p>
<p>•为了解决标准BGP/OSPF的互操作导致的OSPF路由信息丢失的问题，BGP和OSPF都做了相应的拓展。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/24.png"></p>
<blockquote>
<p>•在实际应用中，如果两个要互通的Site都在相同的AS内，那么每个Site都应该将另一个Site的路由看成区域间路由，而不是AS外部路由。</p>
</blockquote>
<h3 id="BGP扩展团体属性"><a href="#BGP扩展团体属性" class="headerlink" title="BGP扩展团体属性"></a>BGP扩展团体属性</h3><p>•为了保留OSPF的路由信息，BGP新增了部分可携带OSPF路由信息的团体属性：</p>
<ul>
<li><p>Domain ID：域标识符用来标识和区分不同的域。</p>
</li>
<li><p>Route Type：包含被引入到BGP的OSPF路由的 Area-ID 以及Route Type</p>
<ul>
<li>Area-ID：PE 的VPN实例的OSPF进程与CE建立邻接关系的区域号</li>
<li>Route Type：被引入的 OSPF 路由的类型<ul>
<li>1 或 2：表示路由的类型为区域内部路由， 也就是 PE 根据 Type-1 及 Type-2 LSA 所计算出来的路由。</li>
<li>3：表示路由的类型为区域间路由。</li>
<li>5：表示路由的类型为 OSPF 外部路由，也就是 PE 通过 Type-5 LSA 计算得出的路由。当 Route-Type 字段的值为 5 时， Area-ID 字段的值需为 0.0.0.0。</li>
<li>7：表示路由的类型为 NSSA 路由，也就是 PE 通过 Type-7 LSA 计算得出的路由。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Domain-ID"><a href="#Domain-ID" class="headerlink" title="Domain ID"></a>Domain ID</h3><p>•在PE上将OSPF引入BGP时，PE将根据本地的配置为BGP路由增加域ID属性，域ID作为BGP的扩展团体属性传播。</p>
<p>•在PE将BGP路由引入OSPF时，若BGP路由携带的Domain ID与本地相同，则认为两个站点属于同一个OSPF路由域。若不相同，则认为不在同一个路由域。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/27.png"></p>
<blockquote>
<p>•Domain ID需要在绑定到VRF的OSPF进程视图下使用命令<strong>domain-id</strong>配置。</p>
<ul>
<li><p>缺省情况下，Domain ID的值为0（NULL）。如果不同OSPF域都使用NULL作为Domain ID，将无法区分OSPF域，因此它们之间的路由将被当作区域内路由。</p>
</li>
<li><p>如果一个OSPF域配置了非0（即非NULL）的Domain ID，NULL不再是该OSPF域的Domain ID。</p>
</li>
</ul>
<p>•建议与同一个VPN相关的所有OSPF实例都使用相同的Domain ID，或者都使用缺省的Domain ID。</p>
</blockquote>
<h3 id="Domain-ID与Route-Type"><a href="#Domain-ID与Route-Type" class="headerlink" title="Domain ID与Route Type"></a>Domain ID与Route Type</h3><p>根据BGP路由中的Domain ID与Route Type属性，PE将产生不同类型的OSPF LSA类型发布到VRF的OSPF进程中</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/28.png"></p>
<h2 id="OSPF防环"><a href="#OSPF防环" class="headerlink" title="OSPF防环"></a>OSPF防环</h2><h3 id="Type3路由防环-案例"><a href="#Type3路由防环-案例" class="headerlink" title="Type3路由防环 - 案例"></a>Type3路由防环 - 案例</h3><p>•如图是Type3 LSA路由产生环路的一个例子：</p>
<p>​    ▫其中站点1和站点2都属于VPN1。</p>
<p>​    ▫站点1通过OSPF Area0接入骨干网的PE1；</p>
<p>​    ▫站点2通过OSPF Area0分别接入骨干网的PE2和PE3（双归属负载分担场景）。</p>
<blockquote>
<p>•环路产生过程如下：</p>
<p>1.Site1的CE1通过Type3 LSA发布到192.168.1.0/24的路由给PE1。</p>
<p>2.PE1向BGP引入OSPF VPN1进程，通过MP-IBGP将该路由发布给PE2和PE3。</p>
<p>3.由于PE2上配置了BGP到OSPF的路由引入，故PE2将产生Type3 LSA给CE2，CE2将来自PE2的Type3 LSA发布给PE3。</p>
<p>4.此时PE3收到两条到达192.168.1.0/24的路由：一条是PE1发布的，另一条是PE2上路由引入产生的。由于缺省情况下，IGP（OSPF）路由优先级高于IBGP路由，PE3将选择OSPF路由。</p>
<p>5.PE3将优选的学自OSPF通过MP-IBGP发布给PE1。</p>
<p>▫此时，PE1上存在两条到达目的地192.168.1.0/24网段的路由，一条通过OSPF学习自CE1，另一条通过MP-IBGP学习自PE3。可能会导致以下问题：</p>
<ul>
<li>PE1撤销192.168.1.0/24这条路由，但由于PE1与PE2之间的链路阻塞，BGP Update（撤销报文）无法及时发送给PE2，导致PE3发给PE1的路由依然存在（正常情况下会随着PE1发送给PE2的Update报文被撤销），PE1上到达目的地192.168.1.0/24的下一跳为PE3。此时路由环路产生。</li>
<li>若PE1上MP-IBGP的路由优先级高于OSPF，则PE1会优选PE3通告的BGP路由，此时PE1需要撤销发给PE2的BGP路由，导致PE3撤销发布给PE1的路由，PE1上的OSPF再次被优选。如此反复，形成路由震荡。</li>
</ul>
</blockquote>
<h3 id="Type3路由防环-DN位"><a href="#Type3路由防环-DN位" class="headerlink" title="Type3路由防环 - DN位"></a>Type3路由防环 - DN位</h3><p>•为了防止3类LSA环路，OSPF多实例进程使用LSA Options域中一个原先未使用的比特作为标志位，称为DN位。使用DN位可以防止Type3 LSA环路。</p>
<p>•PE路由器的OSPF实例进程在进行SPF计算时，忽略DN置位的Type3 LSA。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/29.png"></p>
<h3 id="Type5-7路由防环-案例"><a href="#Type5-7路由防环-案例" class="headerlink" title="Type5/7路由防环 - 案例"></a>Type5/7路由防环 - 案例</h3><p>•如图是Type5 LSA路由产生环路的一个例子：</p>
<p>​    ▫其中站点1和站点2都属于VPN1。</p>
<p>​    ▫站点1通过EBGP接入骨干网的PE1；</p>
<p>​    ▫站点2通过OSPF分别接入骨干网的PE2和PE3。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/30.png"></p>
<blockquote>
<p>•环路产生过程如下：</p>
<p>1.CE1通过EBGP发布到192.168.1.0/24的路由给PE1，AS_Path为65001。</p>
<p>2.PE1通过MP-IBGP将该路由发布给PE2和PE3。</p>
<p>3.PE2在OSPF VPN1实例进程中引入BGP路由，发布到192.168.1.0/24的Type5 LSA给CE2；</p>
<p>4.CE2将该Type5 LSA发布给PE3。</p>
<p>5.PE3将优选择OSPF路由（OSPF优先级高于IBGP），并通过MP-IBGP发布Update消息给PE1。</p>
<p>6.PE1收到PE3发送的MP-IBGP Update消息。由于其中的路由是PE3的BGP引入的IGP（OSPF）路由，其AS_Path为空，因此PE3发布的MP-IBGP路由优先级比从CE1发布的EBGP路由优先级高，PE1将优选用PE3发布的路由。</p>
<p>7.此时形成一条路由环路：PE3—&gt;CE2—&gt;PE2—&gt;PE1—&gt;PE3。</p>
<p>•由于PE1不再优选CE1学来的路由，故PE1会撤销发给PE2的路由，PE2中的OSPF VPN实例进程进程中也要对应撤销引入的BGP路由，继而CE2、PE3都相继撤销该OSPF路由。PE3向PE1发布的BGP路由也被撤销，在PE1上，从CE1学来的路由又变成最优路由。这样，形成了路由振荡。</p>
<p>•Type7 LSA环路的产生和消除的过程与Type5类似，此处不再赘述。</p>
</blockquote>
<h3 id="Type5-7路由防环-VPN-Route-Tag"><a href="#Type5-7路由防环-VPN-Route-Tag" class="headerlink" title="Type5/7路由防环 - VPN Route Tag"></a>Type5/7路由防环 - VPN Route Tag</h3><p>•可以使用VPN Route Tag（VPN路由标记）来防止此5类或7类路由环路。</p>
<p>•PE在根据收到的BGP的私网路由生成5/7类LSA时，携带VPN路由标记。当PE发现LSA的VPN路由标记和本地配置的一样，就会忽略这条LSA，因此可以避免上述环路。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/31.png"></p>
<blockquote>
<p>•VPN路由标记不在BGP的扩展团体属性中传递，只是本地概念，只在收到BGP路由并且产生OSPF LSA的PE设备上有意义。</p>
<p>•缺省情况下，VPN的路由标记是根据BGP的AS号计算得到的。如果没有配置BGP，则默认值为0。</p>
<p>•可以通过指令<strong>route-tag</strong>配置VPN的路由标记。</p>
</blockquote>
<h2 id="OSPF-sham-link"><a href="#OSPF-sham-link" class="headerlink" title="OSPF sham link"></a>OSPF sham link</h2><h3 id="Sham-link的应用场景"><a href="#Sham-link的应用场景" class="headerlink" title="Sham link的应用场景"></a>Sham link的应用场景</h3><p>•通常情况下，BGP对等体之间通过BGP扩展团体属性在MPLS VPN骨干网上承载路由信息。另一端PE上运行的OSPF可利用这些信息来生成PE到CE的Type 3 LSA，这些路由是区域间路由（Inter_Area route）。</p>
<p>•若在CE1和CE2之间增加一条后门（Backdoor）链路，并且直接运行OSPF交互路由。通过后门链路学习到的路由类型为区域内路由（Intra_Area route）。</p>
<p>•由于区域内路由优于区域间路由，故后门链路会被优选，若想实现后门链路作为备份链路，可采用sham link实现。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/32.png"></p>
<h3 id="Sham-link的工作机制"><a href="#Sham-link的工作机制" class="headerlink" title="Sham link的工作机制"></a>Sham link的工作机制</h3><p>•Sham link在两台PE之间创建了一条区域内链路。当LSA在伪装链路中泛洪，所有的OSPF路由类型都不会改变，不会转换成LSA3或者LSA5的类型。</p>
<p>•Sham link被看成是两个VPN实例之间的链路，链路的两端是PE上的端点地址，分别作为建立连接时的源和目的地址。伪连接的源地址和目的地址使用32位掩码的Loopback接口地址，该Loopback接口需要绑定到VPN实例中，并通过BGP发布。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/33.png"></p>
<blockquote>
<p>•同一个OSPF进程的多条Sham link可以共用端点地址，但不同OSPF进程不能拥有两条端点地址完全相同的Sham link。</p>
</blockquote>
<h3 id="Sham-link的配置示例"><a href="#Sham-link的配置示例" class="headerlink" title="Sham link的配置示例"></a>Sham link的配置示例</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/34.png"></p>
<blockquote>
<p>•在配置Sham link时可以指定Sham link的路由开销。缺省值为1。</p>
</blockquote>
<h3 id="sham-link的配置验证"><a href="#sham-link的配置验证" class="headerlink" title="sham link的配置验证"></a>sham link的配置验证</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/35.png"></p>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>1.（多选题）在MPLS VPN组网中，当PE向OSPF引入从其他PE学习来的VPN路由时，可能会产生以下哪几类LSA（    ）。</p>
<p>A.Type 1 LSA</p>
<p><strong>B.Type 3 LSA</strong></p>
<p><strong>C.Type 5 LSA</strong></p>
<p><strong>D.Type 7 LSA</strong></p>
<p>2.（判断）CE通过BGP传递路由给PE时，可能会携带SoO属性。（    ）。</p>
<p>A. 正确</p>
<p><strong>B. 错误</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MPLS VPN在针对不同类型的场景下有不同的组网方案，常见的有Intranet组网、Extranet组网以及Hub&amp;Spoke组网。此外，根据MPLS VPN骨干网是否跨域又可以分为跨域组网和单域组网。</p>
<p>•PE-CE之间进行路由信息交互时，可以使用静态路由、OSPF、IS-IS或BGP中的任何一种。其中OSPF为MPLS VPN做了许多扩展特性，如：</p>
<p>​    ▫Domain ID：用来区分VPN实例中引入的路由是否来自同一个OSPF域</p>
<p>​    ▫DN位：用来防止因为3类LSA产生的路由环路</p>
<p>​    ▫VPN Route Tag：用来方式因为5类或7类LSA产生的路由环路</p>
<p>​    ▫sham link：用于特殊场景下的OSPF路由选路控制</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IPadv-MPLSVPN原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T14:29:37+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•VPN（Virtual Private Network，虚拟专用网络）指的是在一个公共网络中实现虚拟的专用网络，从而使得用户能够基于该专用网络实现通信的技术。</p>
<p>•MPLS VPN也是VPN技术中的一种。需要强调的是，本课程所介绍的MPLS VPN指的是BGP/MPLS IP VPN，这是一种被业界广泛使用的三层VPN。</p>
<p>•本课程将介绍MPLS VPN的基本概念、工作过程以及典型配置方法。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述MPLS VPN的模型</p>
<p>▫描述MPLS VPN中的基本概念</p>
<p>▫描述MPLS VPN路由传递和标签分发</p>
<p>▫描述MPLS VPN数据转发流程</p>
<p>▫执行MPLS VPN的基本配置</p>
<h1 id="1-MPLS-VPN概述"><a href="#1-MPLS-VPN概述" class="headerlink" title="1.MPLS VPN概述"></a>1.MPLS VPN概述</h1><h2 id="MPLS-VPN定义"><a href="#MPLS-VPN定义" class="headerlink" title="MPLS VPN定义"></a>MPLS VPN定义</h2><p>•BGP/MPLS IP VPN网络一般由<strong>运营商</strong>搭建，<strong>VPN用户购买</strong>VPN服务来实现用户网络之间的路由传递、数据互通等。</p>
<p>•MPLS VPN使用<strong>BGP</strong>在运营商骨干网（<strong>IP网络</strong>）上发布VPN路由，使用<strong>MPLS</strong>在运营商骨干网上转发VPN报文。BGP/MPLS IP VPN又被简称为MPLS VPN，是一种常见的L3VPN（Layer 3 VPN）技术。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h2 id="MPLS-VPN网络架构"><a href="#MPLS-VPN网络架构" class="headerlink" title="MPLS VPN网络架构"></a>MPLS VPN网络架构</h2><p>•MPLS VPN网络架构由三部分组成：CE（Customer Edge）、PE（Provider Edge）和P（Provider），其中PE和P是运营商设备，CE是MPLS VPN用户设备。</p>
<p>•站点（site）就是MPLS VPN的用户，由CE和其他用户设备构成。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•CE：用户网络边缘设备，有接口直接与运营商网络相连。CE可以是路由器或交换机，也可以是一台主机。通常情况下，CE“感知”不到VPN的存在，也不需要支持MPLS。</p>
<p>•PE：运营商边缘路由器，是运营商网络的边缘设备，与CE直接相连。在MPLS网络中，对VPN的所有处理都发生在PE上，对PE性能要求较高。</p>
<p>•P：运营商网络中的骨干路由器，不与CE直接相连。P设备只需要具备基本MPLS转发能力，不维护VPN相关信息。</p>
<p>•站点的含义可以从下述几个方面理解：</p>
<ul>
<li><p>站点是指相互之间具备IP连通性的一组IP系统，并且这组IP系统的IP连通性不需通过运营商网络实现。</p>
</li>
<li><p>站点的划分是根据设备的拓扑关系，而不是地理位置。如图所示，公司A的X省网络和公司A的Y省网络需要通过运营商的骨干网进行互联，所以它们被划分为两个站点。若在当前X省网络和Y省网络的CE之间增加一条物理专线，不需要通过运营商网络就可以互通，那么这两张网络就是一个站点。</p>
</li>
</ul>
<p>•站点与VPN的关系：</p>
<ul>
<li><p>对于多个连接到同一服务提供商网络的站点，通过制定策略，可以将它们划分为不同的集合，只有属于相同集合的站点之间才能通过服务提供商网络互访，这种集合就是VPN。</p>
</li>
<li><p>一个Site中的设备可以属于多个VPN，换言之，一个Site可以属于多个VPN。</p>
</li>
</ul>
<p>•注：也有可能出现站点为一台主机的情况，此时该主机就是CE设备。本课程仅讨论站点是一个或多个子网，用路由器或交换机作为CE的情况。</p>
</blockquote>
<h2 id="MPLS-VPN技术架构"><a href="#MPLS-VPN技术架构" class="headerlink" title="MPLS VPN技术架构"></a>MPLS VPN技术架构</h2><p>•MPLS VPN不是单一的一种VPN技术，是多种技术结合的综合解决方案，主要包含下列技术：</p>
<p>​    ▫MP-BGP：负责在PE与PE之间传递站点内的路由信息。</p>
<p>​    ▫LDP：负责PE与PE之间的隧道建立</p>
<p>​    ▫VRF：负责PE的VPN用户管理。</p>
<p>​    ▫静态路由、IGP、BGP：负责PE与CE之间的路由信息交换。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<blockquote>
<p>•MP-BGP（MultiProtocol BGP）：拓展的BGP协议，可提供对多种地址族的支持，后续课程将会详细介绍。</p>
</blockquote>
<h2 id="为什么要选择MPLS-VPN"><a href="#为什么要选择MPLS-VPN" class="headerlink" title="为什么要选择MPLS VPN"></a>为什么要选择MPLS VPN</h2><p>•对VPN客户而言：</p>
<ul>
<li>“感知”不到VPN的存在，不需要部署和维护VPN，降低企业运维难度和成本。</li>
<li>一般部署在运营商的MPLS VPN专网上，有一定的安全性保障。</li>
</ul>
<p>•对于运营商而言：</p>
<ul>
<li>MPLS在无连接的IP网络中增加了面向连接的控制平面，为IP网络增添了管理和运营的手段。</li>
<li>支持地址空间重叠、支持重叠VPN、组网方式灵活、可扩展性好。</li>
<li>能够方便地支持MPLS TE合理调控现有网络资源，最大限度的节省运营商成本。</li>
</ul>
<blockquote>
<p>•MPLS TE（MPLS Traffic Engineering，MPLS流量工程）：基于一定约束条件LSP隧道，并将流量引入到这些隧道中进行转发，使网络流量按照指定的路径进行传输。可以在不进行硬件升级的情况下对现有网络资源进行合理调配和利用，并对网络流量提供带宽和QoS保证，最大限度的节省成本。</p>
</blockquote>
<h2 id="MPLS-VPN常见组网"><a href="#MPLS-VPN常见组网" class="headerlink" title="MPLS VPN常见组网"></a>MPLS VPN常见组网</h2><p>•根据VPN用户的需求不同，可采用以下几种常见的组网方案：</p>
<ul>
<li>Intranet：一个VPN中的所有用户形成闭合用户群，同一VPN站点之间可以互访，不同VPN站点间不能互访。</li>
<li>Extranet：适用于一个VPN用户希望提供部分本VPN的站点资源给其他VPN的用户访问的场景。</li>
<li>Hub&amp;Spoke：如果希望在VPN中设置中心访问控制设备，其它用户的互访都通过中心访问控制设备进行，可采用Hub&amp;Spoke组网方案。</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•Intranet组网是最简单也是最典型的MPLS VPN组网方案，后续课程将基于该组网方案对MPLS VPN技术原理展开介绍。</p>
</blockquote>
<h1 id="2-MPLS-VPN路由交互"><a href="#2-MPLS-VPN路由交互" class="headerlink" title="2.MPLS VPN路由交互"></a>2.MPLS VPN路由交互</h1><h2 id="MPLS-VPN路由发布概述"><a href="#MPLS-VPN路由发布概述" class="headerlink" title="MPLS VPN路由发布概述"></a>MPLS VPN路由发布概述</h2><p>•若想实现同一个VPN的不同站点之间的通信，首先需要完成不同站点之间的路由交互。在基本MPLS VPN组网中，VPN路由信息的发布涉及CE和PE，P路由器只维护骨干网的路由，不需要了解任何VPN路由信息。VPN路由信息的发布过程包括三部分：</p>
<p>​    ▫本地CE到入口PE</p>
<p>​    ▫入口PE到出口PE</p>
<p>​    ▫出口PE到远端CE</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<h2 id="CE与PE之间的路由信息交换"><a href="#CE与PE之间的路由信息交换" class="headerlink" title="CE与PE之间的路由信息交换"></a>CE与PE之间的路由信息交换</h2><p>•如图，客户X和客户Y属于不同的VPN，分别拥有两个站点，现需要实现站点间的路由信息交互。</p>
<p>•CE与PE之间可以使用静态路由、OSPF、IS-IS或BGP交换路由信息。无论使用哪种路由协议，CE和PE之间交换的都是<strong>标准的IPv4</strong>路由。</p>
<p>•本地CE到入口PE和出口PE到远端CE的路由信息交换原理完全相同。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<h2 id="入口PE到出口PE路由传递-1"><a href="#入口PE到出口PE路由传递-1" class="headerlink" title="入口PE到出口PE路由传递 (1)"></a>入口PE到出口PE路由传递 (1)</h2><p>PE在接收到CE传递来的路由之后，需要独立保存不同VPN的路由，且需要解决不同的客户使用重叠IP地址空间的问题。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<blockquote>
<p>•VPN是一种私有网络，不同的VPN独立管理自己的地址范围，也称为地址空间（address space）。不同VPN的地址空间可能会在一定范围内重合，例如图中用户X和用户Y都使用192.168.1.0/24网段地址，这就发生了地址空间的重叠（address spaces overlapping）。以下两种情况允许VPN使用重叠的地址空间：</p>
<ul>
<li><p>两个VPN没有共同的站点；</p>
</li>
<li><p>两个VPN有共同的站点，但此共同站点中的设备不与两个VPN中使用重叠地址空间的设备互访。</p>
</li>
</ul>
</blockquote>
<h2 id="VRF"><a href="#VRF" class="headerlink" title="VRF"></a>VRF</h2><p>•VRF（Virtual Routing and Forwarding，虚拟路由转发），又称VPN实例，是MPLS VPN架构中的关键技术，每个VPN实例使用独立的路由转发表项，实现VPN之间的逻辑隔离。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h2 id="RD"><a href="#RD" class="headerlink" title="RD"></a>RD</h2><p>•PE收到不同VPN的CE发来的IPv4地址前缀，本地根据VPN实例配置去区分这些地址前缀。但是VPN实例只是一个<strong>本地</strong>的概念，PE无法将VPN实例信息传递到对端PE，故有了RD（Route Distinguisher，路由标识符）。</p>
<p>▫RD长8字节，用于区分使用相同地址空间的IPv4前缀。</p>
<p>▫PE从CE接收到IPv4路由后，在IPv4前缀前加上RD，转换为<strong>全局唯一</strong>的<strong>VPN-IPv4</strong>路由。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<blockquote>
<p>•配置RD时，只需要指定RD的Administrator子字段和Assigned Number子字段。</p>
<p>•RD的配置格式有四种，常用的两种如下：</p>
<p>​    ▫16bits自治系统号:32bits用户自定义数字（例如：100:1）。</p>
<p>​    ▫32bits IPv4地址:16bits用户自定义数字（例如：172.1.1.1:1）。</p>
<p>•RD的结构使得每个运营商可以独立地分配RD，但为了在某些应用场景下保证路由正常，必须保证RD全局唯一。</p>
</blockquote>
<h2 id="VPN-IPv4地址"><a href="#VPN-IPv4地址" class="headerlink" title="VPN-IPv4地址"></a>VPN-IPv4地址</h2><p>VPN-IPv4地址又被称为VPNv4地址：VPNv4地址共有12个字节，包括8字节的路由标识符RD（Route Distinguisher）和4字节的IPv4地址前缀。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<h2 id="入口PE到出口PE路由传递-2"><a href="#入口PE到出口PE路由传递-2" class="headerlink" title="入口PE到出口PE路由传递 (2)"></a>入口PE到出口PE路由传递 (2)</h2><p>•PE之间建立BGP邻居关系，并通过BGP进行路由传递。为什么采用BGP呢？</p>
<p>▫BGP使用TCP作为其传输层协议，提高了协议的可靠性。可以跨路由器的两个PE设备之间直接交换路由。</p>
<p>▫BGP拓展性强，为PE间传播VPN路由提供了便利。</p>
<p>▫PE之间需要传送的路由条目可能较大，BGP只发送更新的路由，提高传递路由数量的同时不占用过多链路带宽。</p>
<p>•传统的BGP-4<strong>不支持</strong>处理VPNv4路由。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<h2 id="MP-BGP"><a href="#MP-BGP" class="headerlink" title="MP-BGP"></a>MP-BGP</h2><p>•为了正确处理VPN路由，MPLS VPN使用RFC2858（Multiprotocol Extensions for BGP-4）中规定的MP-BGP，即BGP-4的多协议扩展。</p>
<p>•MP-BGP采用地址族（Address Family）来区分不同的网络层协议，既可以支持传统的IPv4地址族，又可以支持其它地址族（比如VPN-IPv4地址族、IPv6地址族等）。</p>
<p>•MP-BGP新增了两种路径属性：</p>
<ul>
<li><p>MP_REACH_NLRI：Multiprotocol Reachable NLRI，多协议可达NLRI。用于发布可达路由及下一跳信息。</p>
</li>
<li><p>MP_UNREACH_NLRI：Multiprotocol Unreachable NLRI，多协议不可达NLRI。用于撤销不可达路由。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<blockquote>
<p>•NLRI：Network Layer Reachability Information，网络层可达信息。</p>
<p>•关于地址族的一些取值请参考RFC3232（Assigned Numbers）。</p>
<p>•MP_REACH_NLRI用于发布可达路由及下一跳信息。该属性由一个或多个三元组&lt;地址族信息、下一跳信息、网络可达性信息&gt;组成，格式如下：</p>
<p>▫地址族信息（Address Family Information）域：由2字节的地址族标识AFI（Address Family Identifier）和1字节的子地址族标识SAFI（Subsequent Address Family Identifier）组成。</p>
<p>▪AFI标识网络层协议，对应RFC3232的“Address Family Number”所定义的地址族值。例如IPv4的值是1，IPv6的值是2。</p>
<p>▪SAFI表示NLRI的类型。AFI值为1，SAFI值为128表示NLRI中的地址为MPLS-labeled VPN-IPv4地址。</p>
<ul>
<li><p>下一跳信息（Next Hop Network Address Information）域：由一字节的下一跳网络地址长度和可变长度的下一跳网络地址组成。</p>
</li>
<li><p>网络层可达性信息（NLRI）域：由一个或多个三元组&lt;长度、标签、前缀&gt;组成，该部分内容将在后面的课程里详细介绍。</p>
</li>
</ul>
<p>•MP_UNREACH_NLRI用于通知对等体删除不可达的路由。该属性的格式如下：</p>
<ul>
<li><p>地址族标识AFI：与MP_REACH_NLRI属性中的相同。</p>
</li>
<li><p>子地址族标识SAFI：与MP_REACH_NLRI属性中的相同，表示NLRI的类型。</p>
</li>
<li><p>撤销路由（Withdrawn Routes）：不可达路由列表，也是由一个或多个NLRI组成。BGP发言者可以通过在撤销路由域中携带与之前发布的可达路由中相同的NLRI来撤销路由。</p>
</li>
</ul>
<p>•MP-BGP的报文类型、VPNv4路由发布策略仍与普通BGP相同。</p>
</blockquote>
<h2 id="入口PE到出口PE路由传递-3"><a href="#入口PE到出口PE路由传递-3" class="headerlink" title="入口PE到出口PE路由传递 (3)"></a>入口PE到出口PE路由传递 (3)</h2><p>•MP-BGP将VPNv4传递到远端PE之后，远端PE需要将VPNv4路由导入正确的VPN实例。</p>
<p>•MPLS VPN使用32位的BGP扩展团体属性－VPN Target（也称为Route Target）来控制VPN路由信息的发布与接收。</p>
<p>•本地PE在发布VPNv4路由前附上RT属性，对端RT在接到到VPNv4路由后根据RT将路由导入对应的VPN实例。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<h2 id="RT"><a href="#RT" class="headerlink" title="RT"></a>RT</h2><p>•在PE上，每一个VPN实例都会与<strong>一个或多个</strong>VPN Target属性绑定，有两类VPN Target属性：</p>
<ul>
<li><p>Export Target（ERT）：本地PE从直接相连站点学到IPv4路由后，转换为VPN IPv4路由，并为这些路由添加Export Target属性。Export Target属性作为BGP的扩展团体属性随路由发布。</p>
</li>
<li><p>Import Target（IRT）：PE收到其它PE发布的VPN-IPv4路由时，检查其Export Target属性。当此属性与PE上某个VPN实例的Import Target匹配时，PE就把路由加入到该VPN实例的路由表。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•与RD相同，RT由Type、Administrator和Assigned Number三个字段构成，长度也是8字节。 </p>
<p>•配置VPN-Target时，只需要指定VPN-Target的Administrator子字段和Assigned Number子字段。VPN-Target的配置格式与RD格式一致。</p>
</blockquote>
<h2 id="入口PE到出口PE路由传递-4"><a href="#入口PE到出口PE路由传递-4" class="headerlink" title="入口PE到出口PE路由传递 (4)"></a>入口PE到出口PE路由传递 (4)</h2><p>•PE根据VPNv4路由所携带的RT将路由导入正确的VPN实例之后，VPNv4路由的RD值剥除，将<strong>IPv4路由</strong>通告给相应的客户的CE设备。</p>
<p>•站点B和站点D的CE设备就能学习到去往各自远端站点的路由。同理，通过一系列的操作，可以实现同一用户（同一VPN）不同站点之间的路由互通。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<h2 id="数据转发时遇到的问题"><a href="#数据转发时遇到的问题" class="headerlink" title="数据转发时遇到的问题"></a>数据转发时遇到的问题</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<h2 id="通过标签解决问题"><a href="#通过标签解决问题" class="headerlink" title="通过标签解决问题"></a>通过标签解决问题</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<h2 id="入口PE到出口PE路由传递-5"><a href="#入口PE到出口PE路由传递-5" class="headerlink" title="入口PE到出口PE路由传递 (5)"></a>入口PE到出口PE路由传递 (5)</h2><p>•PE和P设备之间运行LDP，交换公网标签，建立PE之间的LSP隧道（公网隧道）。</p>
<p>•入口PE在通过MP-BGP传递VPNv4路由时，会携带私网标签，用于区分不同VPN的数据。</p>
<p>•出口PE在接收到VPNv4路由后，需要执行私网路由交叉和隧道迭代来选择路由。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<blockquote>
<p>•PE上分配私网标签的方法有如下两种：</p>
<ul>
<li>基于路由的MPLS标签分配：为VPN路由表的每一条路由分配一个标签（one label per route）。这种方式的缺点是：当路由数量比较多时，设备入标签映射表ILM（Incoming Label Map）需要维护的表项也会增多，从而提高了对设备容量的要求。</li>
<li>基于VPN实例的MPLS标签分配：为整个VPN实例分配一个标签，该VPN实例里的所有路由都共享一个标签。使用这种分配方法的好处是节约了标签。</li>
</ul>
<p>•私网路由交叉：VPNv4路由与本地VPN实例的VPN-Target进行匹配的过程称为私网路由交叉。PE在收到VPNv4路由后，既不进行优选，也不检查隧道是否存在，直接将其与本地的VPN实例进行交叉。</p>
<p>•隧道迭代：为了将私网流量通过公网传递到另一端，需要有一条公网隧道承载这个私网流量。因此私网路由交叉完成后，需要根据目的IPv4前缀进行路由迭代，即该IPv4路由的下一跳有对应的LSP存在；只有隧道迭代成功，该路由才被放入对应的VPN实例路由表。</p>
</blockquote>
<h2 id="MPLS-VPN中的路由交互全过程"><a href="#MPLS-VPN中的路由交互全过程" class="headerlink" title="MPLS VPN中的路由交互全过程"></a>MPLS VPN中的路由交互全过程</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>•在MPLS VPN中，PE与CE，PE与PE之间需要进行VPN路由信息的传递。</p>
<ul>
<li>PE与CE之间可以采用BGP、IGP以及静态路由方式交互<strong>IPv4</strong>路由信息。</li>
<li>PE与PE之间通过MP-BGP交互<strong>VPNv4</strong>路由信息，包含<ul>
<li>RD：与IPv4前缀组合组成VPNv4前缀。</li>
<li>RT：用于控制PE之间路由信息的接收和发布。</li>
<li>标签：数据转发时的内层（私网）标签，在PE上用来区分不同VPN的数据。</li>
</ul>
</li>
</ul>
<h1 id="3-MPLS-VPN报文转发"><a href="#3-MPLS-VPN报文转发" class="headerlink" title="3.MPLS VPN报文转发"></a>3.MPLS VPN报文转发</h1><h2 id="报文转发过程"><a href="#报文转发过程" class="headerlink" title="报文转发过程"></a>报文转发过程</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/29.png"></p>
<h1 id="4-MPLS-VPN配置与实现"><a href="#4-MPLS-VPN配置与实现" class="headerlink" title="4.MPLS VPN配置与实现"></a>4.MPLS VPN配置与实现</h1><h2 id="配置命令-VPN实例配置"><a href="#配置命令-VPN实例配置" class="headerlink" title="配置命令 - VPN实例配置"></a>配置命令 - VPN实例配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/30.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/31.png"></p>
<h2 id="配置命令-MP-BGP配置"><a href="#配置命令-MP-BGP配置" class="headerlink" title="配置命令 - MP-BGP配置"></a>配置命令 - MP-BGP配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/32.png"></p>
<h2 id="配置命令-PE与CE间路由配置"><a href="#配置命令-PE与CE间路由配置" class="headerlink" title="配置命令 - PE与CE间路由配置"></a>配置命令 - PE与CE间路由配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/33.png"></p>
<h2 id="MPLS-VPN配置示例-背景介绍"><a href="#MPLS-VPN配置示例-背景介绍" class="headerlink" title="MPLS VPN配置示例 - 背景介绍"></a>MPLS VPN配置示例 - 背景介绍</h2><p>•客户X及Y各自有2个站点，现需要通过MPLS VPN实现站点之间的互联，分别对应VPNX和VPNY；</p>
<p>•互联接口、AS号及IP地址信息如图；</p>
<p>•客户X站点与PE之间采用OSPF交互路由信息，客户Y站点与PE之间采用BGP交互路由信息。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/34.png"></p>
<h2 id="MPLS-VPN配置示例-配置思路"><a href="#MPLS-VPN配置示例-配置思路" class="headerlink" title="MPLS VPN配置示例 - 配置思路"></a>MPLS VPN配置示例 - 配置思路</h2><p>1.MPLS VPN骨干网配置</p>
<p>​    1.1 IGP配置，实现骨干网的IP连通性。</p>
<p>​    1.2 MPLS与MPLS LDP配置，建立MPLS LSP公网隧道，传输VPN数据。</p>
<p>​    1.3 MP-BGP配置，建立后续传递VPNv4路由的MP-BGP对等体关系。</p>
<p>2.VPN用户接入配置</p>
<p>​    2.1 创建VPN实例并配置参数（RT、RD）</p>
<p>​    2.2 将接口加入VPN实例</p>
<p>​    2.3 配置PE与CE之间的路由交换</p>
<h2 id="MPLS-VPN配置示例-数据规划"><a href="#MPLS-VPN配置示例-数据规划" class="headerlink" title="MPLS VPN配置示例 - 数据规划"></a>MPLS VPN配置示例 - 数据规划</h2><p>•MPLS骨干网采用单区域OSPF实现路由互通，所有PE和P互联接口均使能MPLS LDP功能。</p>
<p>•PE上的VPN相关配置如表格：</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/35.png"></p>
<h2 id="MPLS-VPN骨干网配置"><a href="#MPLS-VPN骨干网配置" class="headerlink" title="MPLS VPN骨干网配置"></a>MPLS VPN骨干网配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/36.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/37.png"></p>
<blockquote>
<p>•缺省情况下，只有BGP-IPv4单播地址族的对等体是自动使能的。即在BGP视图下配置peer as-number命令后，系统会自动配置相应的peer enable命令。其他地址族视图下都必须手动使能。</p>
</blockquote>
<h2 id="MPLS-VPN骨干网配置-配置验证"><a href="#MPLS-VPN骨干网配置-配置验证" class="headerlink" title="MPLS VPN骨干网配置 - 配置验证"></a>MPLS VPN骨干网配置 - 配置验证</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/38.png"></p>
<h2 id="VPN用户接入配置"><a href="#VPN用户接入配置" class="headerlink" title="VPN用户接入配置"></a>VPN用户接入配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/39.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/40.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/41.png"></p>
<h2 id="配置验证"><a href="#配置验证" class="headerlink" title="配置验证"></a>配置验证</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/42.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/43.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/44.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选）MP-BGP在传递VPNv4路由时，携带哪种Route Target ？ （ ）</p>
<p><strong>A. Export RT</strong></p>
<p>B. Implied RT</p>
<p>C. Import RT</p>
<p>D. Extended RT</p>
<p>2.（多选）基本MPLS VPN组网中，需要对VPN实例做哪些配置（ ）</p>
<p><strong>A.Import RT</strong></p>
<p><strong>B.Export RT</strong></p>
<p><strong>C.配置RD</strong></p>
<p><strong>D.配置与VPN实例绑定的接口</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MPLS VPN网络一般由运营商搭建，用于向不同的客户提供VPN服务，使得用户的路由和数据能够通过该网络进行传递，且不同的用户之间的路由和数据完全隔离，互不影响。</p>
<p>•MPLS VPN控制层面：</p>
<p>​    ▫通过VRF和RD隔离不同用户的私网路由信息并构建唯一的VPNv4路由</p>
<p>​    ▫通过RT值控制VPNv4路由的发布和接收</p>
<p>​    ▫通过MP-BGP传递VPNv4路由前缀、标签以及RT等信息</p>
<p>​    ▫通过MPLS LDP构建公网标签转发路径</p>
<p>•MPLS转发层面：通过内外两层标签进行数据转发，内层标签区分私网数据，外层标签穿通公网网络。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IPadv-MPLSLDP原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T13:37:44+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•MPLS是一种根根据标签报文中携带的短而定长的标签来转发数据的技术。</p>
<p>•MPLS的一个基本概念就是两台LSR必须对在它们之间转发的数据的标签使用上“达成共识”。LSR之间可以运行标签分发协议（Label Distribution Protocol，LDP）来告知其他LSR本设备上的标签绑定信息，从而实现标签报文的正确转发。</p>
<p>•本课程将介绍LDP基本工作原理与特性，以及LDP的基本配置。</p>
<blockquote>
<p>•本课程的标签分发协议特指由RFC3036首次定义的标签分发协议，当前该标准已被RFC5036废弃。</p>
<p>•除了LDP外，标签分发协议也可以指MP-BGP、RSVP等可执行标签分发的一类协议。</p>
</blockquote>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述LDP的基本概念及工作机制</p>
<p>▫描述MPLS标签分发控制模式、通告模式及保留模式</p>
<p>▫实现LDP的基础配置</p>
<h1 id="1-LDP基本概念"><a href="#1-LDP基本概念" class="headerlink" title="1.LDP基本概念"></a>1.LDP基本概念</h1><h2 id="LDP协议概述"><a href="#LDP协议概述" class="headerlink" title="LDP协议概述"></a>LDP协议概述</h2><p>•LDP是MPLS的一种控制协议，相当于传统网络中的信令协议，负责FEC的分类、标签的分配以及LSP的建立和维护等操作。LDP规定了标签分发过程中的各种消息以及相关处理过程。</p>
<p>•LDP的工作过程主要分为两部分：</p>
<p>​    1.LSR之间建立LDP会话。</p>
<p>​    2.LSR之间基于LDP会话动态交换标签与FEC的映射信息，并根据标签信息建立LSP。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h2 id="LDP会话、LDP邻接体、LDP对等体"><a href="#LDP会话、LDP邻接体、LDP对等体" class="headerlink" title="LDP会话、LDP邻接体、LDP对等体"></a>LDP会话、LDP邻接体、LDP对等体</h2><p>•LSR之间交互标签绑定消息之前必须建立LDP会话。LDP会话可以分为：</p>
<p>​    ▫本地LDP会话（Local LDP Session）：建立会话的两个LSR之间是直连的；</p>
<p>​    ▫远程LDP会话（Remote LDP Session）：建立会话的两个LSR之间可以是直连的，也可以是非直连的。</p>
<p>•两台LSR之间交互Hello消息之后，即建立起邻接体（Adjacency）关系；</p>
<p>•在建立邻接体关系的基础上，两台LSR之间交互LDP会话消息，建立起LDP会话，两台设备之间形成LDP对等体关系；</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<h2 id="LSR-ID与LDP-ID"><a href="#LSR-ID与LDP-ID" class="headerlink" title="LSR ID与LDP ID"></a>LSR ID与LDP ID</h2><p>•每一台运行了LDP的LSR除了必须配置LSR ID，还必须拥有LDP ID。</p>
<ul>
<li><p>LDP ID的长度为48bit，由32bit的LSR ID与16bit的标签空间标识符（Label Space ID）构成。</p>
</li>
<li><p>LDP ID以“LSR ID : 标签空间标识”的形式呈现。例如2.2.2.2:0。</p>
</li>
</ul>
<p>•标签空间标识一般存在两种形态：</p>
<ul>
<li><p>值为0：表示基于设备（或基于平台）的标签空间；</p>
</li>
<li><p>值非0：表示基于接口的标签空间。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<blockquote>
<p>•在本课程中，均使用基于设备（或基于平台）的标签空间。</p>
</blockquote>
<h2 id="LDP消息"><a href="#LDP消息" class="headerlink" title="LDP消息"></a>LDP消息</h2><p>运行LDP协议的LSR之间通过交换LDP消息来实现邻居发现、会话建立与维护以及标签管理等功能。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•按照消息的功能，LDP消息一共可以分为四大类型：发现消息（Discovery Message），会话消息（Session Message），通告消息（Advertisement Message）和通知消息（Notification Message）。</p>
<p>▫发现消息：用来宣告和维护网络中一个LSR的存在；用于通告和维护网络中LSR的存在，如Hello报文。</p>
<p>▫会话消息：用于建立、维护和终止LDP对等体之间的会话，如Initialization报文、KeepAlive报文。</p>
<p>▫通告消息：用来生成、改变和删除FEC的标签映射；</p>
<p>▫通知消息：用来宣告告警和错误信息。</p>
<p>•LDP消息承载在UDP或TCP之上，端口号均为646 。其中发现消息用来发现邻居，承载在UDP报文上。其他消息的传递要求可靠而有序，所以LDP使用TCP建立会话，会话、通告和通知消息都基于TCP传递。</p>
</blockquote>
<h2 id="LDP报文封装"><a href="#LDP报文封装" class="headerlink" title="LDP报文封装"></a>LDP报文封装</h2><p>•LDP协议报文包括了LDP头部和LDP消息两部分。</p>
<p>​    ▫LDP头部中携带了LDP版本、报文长度等信息；</p>
<p>​    ▫LDP消息中携带了消息类型、消息长度等信息。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<blockquote>
<p>•LDP头部长度为10Byte，包括Version，PDU Length和LDP Identifier三部分。</p>
<ul>
<li>Version占用2Byte，表示LDP版本号，当前版本号为1。</li>
<li>PDU Length占用2Byte，以字节为单位表示除了Version和PDU Length以外的其他部分的总长度。</li>
<li>LDP Identifier，即LDP ID，长度6Byte，其中前4Byte用来唯一标识一个LSR，后2Byte用来表示LSR的标签空间。</li>
</ul>
<p>•LDP消息包含五个部分。</p>
<ul>
<li>U占用1个bit，为Unknown Message bit。当LSR收到一个无法识别的消息时，该消息的U=0时，LSR会返回给该消息的生成者一个通告，当U=1时，忽略该无法识别的消息，不发送通告给生成者。</li>
<li>Message Length占用2个bytes，以字节为单位表示Message ID、Mandatory Parameters和Optional Parameters的总长度。</li>
<li>Message ID占用32个bit，用来标识一个消息。</li>
<li>Mandatory Parameters和Optional Parameters分别为可变长的该消息的必须的参数和可选的参数。</li>
<li>Message Type表示具体的消息类型，目前LDP定义的常用的消息有Notification，Hello，Initialization，KeepAlive，Address，Address Withdraw，Label Mapping，Label Request，Label Abort Request，Label Withdraw，Label Release。</li>
</ul>
</blockquote>
<h1 id="2-LDP工作原理"><a href="#2-LDP工作原理" class="headerlink" title="2.LDP工作原理"></a>2.LDP工作原理</h1><h2 id="LDP会话建立"><a href="#LDP会话建立" class="headerlink" title="LDP会话建立"></a>LDP会话建立</h2><h3 id="LDP会话状态机"><a href="#LDP会话状态机" class="headerlink" title="LDP会话状态机"></a>LDP会话状态机</h3><p>LDP使用5种状态描述LDP会话状态机。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<blockquote>
<p>•LDP Session协商过程可以通过状态机来描述。如图所示，有5种状态。分别是Non-Existent，Initialized，OpenRec，OpenSent，Operational。</p>
<p>▫Non-Existent状态：该状态为LDP Session最初的状态，在此状态双方发送HELLO消息，选举主动方，在收到TCP连接建立成功事件的触发后变为Initialized状态。</p>
<p>▫Initialized状态：该状态下分为主动方和被动方两种情况，主动方将主动发送Initialization消息，转向OpenSent 状态，等待回应的Initialization消息；被动方在此状态等待主动方发给自己的Initialization消息，如果收到的Initialization消息的参数可以接受，则发送Initialization和KeepAlive转向OpenRec状态。主动方和被动方在此状态下收到任何非Initialization消息或等待超时时，都会转向Non-Existent状态。</p>
<p>▫OpenSent 状态：此状态为主动方发送Initialization消息后的状态，在此状态等待被动方回答Initialization消息和KeepAlive消息，如果收到的Initialization消息中的参数可以接受则转向OpenRec状态，如果参数不能接受或Initialization消息超时则断开TCP连接转向Non-Existent状态。</p>
<p>▫OpenRec状态：在此状态不管主动方还是被动方都是发出KeepAlive后的状态，在等待对方回应KeepAlive，只要收到KeepAlive消息就转向Operational状态；如果收到其它消息或KeepAlive超时则转向Non-Existent状态。</p>
<p>▫Operational状态：该状态是LDP Session成功建立的标志。在此状态下可以发送和接收所有其它的LDP消息。在此状态如果KeepAlive超时或收到致命错误的Notification消息（Shutdown消息）或者自己主动发送Shutdown消息主动结束会话，都会转向Non-Existent状态。</p>
<p>•LDP状态切换信息可以通过指令<strong>debug</strong> <strong>mpls</strong> <strong>ldp</strong> <strong>session</strong>看到。</p>
</blockquote>
<h3 id="LDP会话建立-发现阶段与TCP连接建立"><a href="#LDP会话建立-发现阶段与TCP连接建立" class="headerlink" title="LDP会话建立 - 发现阶段与TCP连接建立"></a>LDP会话建立 - 发现阶段与TCP连接建立</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<blockquote>
<p>•除了基本发现机制外，可以通过拓展发现机制发现非直连的远端邻接体，该内容不属于课程的重点，详细内容可以查阅RFC5036相关内容。</p>
<p>•LDP的传输地址用于与邻居建立TCP连接。</p>
<ul>
<li>两台LSR之间在建立LDP会话之前，需要先建立TCP连接，以便进行LDP协议报文的交换。</li>
<li>设备的传输地址被包含在LDP Hello报文中，LSR通过Hello报文知晓邻居的传输地址。</li>
<li>在使用Hello报文发现邻居并且知道了对方的传输地址后，邻居之间就会开始尝试TCP三次握手（基于传输地址），并且交互LDP的初始化报文、标签映射报文等，这些报文都使用双方的传输地址作为源、目的IP地址。</li>
<li>LSR必须拥有到达邻居的传输地址的路由。</li>
<li>缺省情况下，公网的LDP传输地址等于设备的LSR ID，私网的传输地址等于接口的主IP地址。 </li>
<li>在接口视图下，使用<strong>mpls</strong> <strong>ldp</strong> <strong>transport-address</strong>命令，可以修改传输地址。</li>
</ul>
</blockquote>
<h3 id="LDP会话建立-会话建立与保持"><a href="#LDP会话建立-会话建立与保持" class="headerlink" title="LDP会话建立 - 会话建立与保持"></a>LDP会话建立 - 会话建立与保持</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h3 id="LDP邻居状态"><a href="#LDP邻居状态" class="headerlink" title="LDP邻居状态"></a>LDP邻居状态</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<h3 id="LDP会话状态"><a href="#LDP会话状态" class="headerlink" title="LDP会话状态"></a>LDP会话状态</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<blockquote>
<p>•LDP会话的状态：</p>
<p>▫NonExistent：表示LDP会话的最初状态。在此状态双方互相发送Hello消息，在收到TCP连接建立成功事件的触发后变为Initialized状态。 </p>
<p>▫Initialized：表示LDP会话处于初始化状态。</p>
<p>▫Open Sent：表示LDP会话进入初始化状态后，主动方给被动方发送了Initialized消息，并等待对方的回应。</p>
<p>▫Open Recv：表示LDP会话进入初始化状态后，当双方都收到了对方发送的KeepAlive消息后，LDP会话进入Operational状态。 </p>
<p>▫Operational：表示LDP会话建立成功。</p>
</blockquote>
<h2 id="LDP标签分发"><a href="#LDP标签分发" class="headerlink" title="LDP标签分发"></a>LDP标签分发</h2><h3 id="标签的发布和管理"><a href="#标签的发布和管理" class="headerlink" title="标签的发布和管理"></a>标签的发布和管理</h3><p>•在MPLS网络中，下游LSR决定标签和FEC的绑定关系，并将这种绑定关系发布给上游LSR。</p>
<p>•LDP通过发送标签请求和标签映射消息，在LDP对等体之间通告FEC和标签的绑定关系来建立LSP</p>
<p>•标签的发布和管理由标签发布方式、标签分配控制方式和标签保持方式来决定。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<h3 id="上游与下游"><a href="#上游与下游" class="headerlink" title="上游与下游"></a>上游与下游</h3><p>•MPLS根据数据的转发方向确定上、下游关系。标签报文从上游LSR发出，被下游LSR接收并处理。</p>
<p>•如图所示，对于到达192.168.3.0/24的LSP而言，R3是R2的下游LSR，R1是R2的上游LSR。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<h3 id="标签发布方式-DU模式"><a href="#标签发布方式-DU模式" class="headerlink" title="标签发布方式 - DU模式"></a>标签发布方式 - DU模式</h3><p>•DU模式</p>
<ul>
<li><p>对于一个特定的FEC，LSR无需从上游获得标签请求消息即进行标签分配与分发。</p>
</li>
<li><p>LSR会主动将自己为FEC捆绑的标签通告给上游邻居，无需邻居先发起请求再通告。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<blockquote>
<p>•标签分配：LSR从本地标签空间中取出一个标签与FEC绑定。</p>
<p>•标签分发：LSR将标签与FEC的绑定关系通知给上游LSR。</p>
<p>•标签发布方式为DU时，系统默认支持LDP为所有对等体分标签，即每个节点都可以向所有的对等体发布标签映射关系，不再区分上下游关系。因为在只给上游对等体分标签情况下，发送标签映射消息的时候，要根据路由信息对会话的上下游关系进行确认。</p>
</blockquote>
<h3 id="标签发布方式-DoD模式"><a href="#标签发布方式-DoD模式" class="headerlink" title="标签发布方式 - DoD模式"></a>标签发布方式 - DoD模式</h3><p>•DoD模式</p>
<p>​    ▫对于一个特定的FEC，LSR获得标签请求消息之后才进行标签分配与分发。</p>
<p>​    ▫一般情况下，对特定FEC的访问需求会触发标签请求消息。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•只有上游邻居向自己请求标签映射时，LSR才会通告标签映射给该邻居</p>
</blockquote>
<h3 id="标签分配控制方式-独立模式"><a href="#标签分配控制方式-独立模式" class="headerlink" title="标签分配控制方式 - 独立模式"></a>标签分配控制方式 - 独立模式</h3><p>独立（Independent）模式</p>
<p>▫本地LSR可以自主地分配一个标签绑定到某个FEC，并通告给上游LSR，而无需等待下游的标签。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•标签分配控制方式需要与标签发布方式结合使用：</p>
<ul>
<li><p>在使用DU作为标签分发方式的情况下，如图所示，R2和R3对192.168.4.0/24这条FEC，可以在上游LSR无请求，且自身没有收到下游LSR的标签绑定信息的情况下，主动向上游LSR通告标签绑定信息。</p>
</li>
<li><p>采用DoD作为标签发布方式时，如图所示，R2和R3对192.168.4.0/24这条FEC，只要收到上游LSR的标签请求消息，可以在自身没有收到下游LSR的标签绑定信息的情况下，向上游LSR通告标签绑定信息。</p>
</li>
</ul>
</blockquote>
<h3 id="标签分配控制方式-有序模式"><a href="#标签分配控制方式-有序模式" class="headerlink" title="标签分配控制方式 - 有序模式"></a>标签分配控制方式 - 有序模式</h3><p>•有序（Ordered）模式</p>
<p>▫对于LSR上某个FEC的标签映射，只有当该LSR已经具有此FEC下一跳的标签映射消息、或者该LSR就是此FEC的出节点时，该LSR才可以向上游发送此FEC的标签映射。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<blockquote>
<p>•当标签控制方式为Ordered，只有当LSR收到特定FEC下一跳发送的特定FEC标签映射消息或者LSR是LSP的出口节点时，LSR才可以向上游发送标签映射消息。</p>
<ul>
<li><p>当标签分发方式为DU时，如图所示，对于192.168.4.0/24这条FEC，不论上游LSR是否有请求，必须收到下游LSR对此FEC的标签绑定信息才向上游LSR发布标签绑定信息，所以必须由Egress LSR，也就是R4作为LSP建立的“起点”。</p>
</li>
<li><p>当标签发布方式采用DoD时，如图所示，对于192.168.4.0/24这条FEC，只有收到上游LSR请求的请求，且自身已经收到下游LSR的标签绑定信息的情况下，才向上游LSR通告标签绑定信息。因此，必须由Ingress LSR（R1）发起请求，逐跳请求到Egress LSR（R4），最终由R4开始，向上游建立LSP。</p>
</li>
</ul>
</blockquote>
<h3 id="标签保留-自由模式"><a href="#标签保留-自由模式" class="headerlink" title="标签保留 - 自由模式"></a>标签保留 - 自由模式</h3><p>自由（Liberal）模式</p>
<p>▫LSR收到的标签映射可能来自下一跳，也可能来自非下一跳。</p>
<p>▫对于从邻居LSR收到的标签映射，无论邻居LSR是不是自己的下一跳都保留。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<blockquote>
<p>•当基于IP网络部署MPLS时，LSR根据IP路由表判断接收到的标签映射是否来自下一跳。</p>
<p>•Liberal方式的最大优点在于路由发生变化时能够快速建立新的LSP进行数据转发，因为Liberal方式保留了所有的标签。缺点是需要分发和维护不必要的标签映射。</p>
<ul>
<li><p>DU标签分发方式下，如果采用Liberal保持方式，则R3保留所有LDP邻居 R2和R5发来的关于192.168.1.0/24这个FEC的标签，无论该R2和R5是否是IP路由表中到达192.168.1.0/24的下一跳。</p>
</li>
<li><p>DoD标签分发方式下，如果采用Liberal保持方式， LSR会向所有LDP邻居请求标签。但通常来说，DoD分发方式都会和Conservative保持方式搭配使用。</p>
</li>
</ul>
</blockquote>
<h3 id="标签保留-保守模式"><a href="#标签保留-保守模式" class="headerlink" title="标签保留 - 保守模式"></a>标签保留 - 保守模式</h3><p>•保守（Conservative）模式</p>
<p>▫对于从邻居LSR收到的标签映射，只有当邻居LSR是自己的下一跳时才保留。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<blockquote>
<p>•Conservative方式的优点在于只需保留和维护用于转发数据的标签，以达到节约标签的目的。</p>
<ul>
<li>当使用DU标签分发方式时，LSR可能从多个LDP邻居收到到同一网段的标签映射消息，如图中R3会分别从R2和R5收到网段192.168.1.0/24的标签映射消息。如果采用Conservative保持方式，则R3只保留下一跳R2发来的标签，丢弃非下一跳R5发来的标签。</li>
<li>当使用DoD标签分发方式时， LSR根据路由信息只向它的下一跳请求标签。</li>
</ul>
<p>•当网络拓扑变化引起下一跳邻居改变时：</p>
<ul>
<li>使用自由标签保持方式，LSR可以直接利用原来非下一跳邻居发来的标签，迅速重建LSP，但需要更多的内存和标签空间。</li>
<li>使用保守标签保持方式，LSR只保留来自下一跳邻居的标签，节省了内存和标签空间，但LSP的重建会比较慢。</li>
<li>保守标签保持方式通常与DoD方式一起，用于标签空间有限的LSR。</li>
</ul>
</blockquote>
<h3 id="PHP特性"><a href="#PHP特性" class="headerlink" title="PHP特性"></a>PHP特性</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<p>•PHP（Penultimate Hop Popping，次末跳弹出），如果激活了PHP特性，那么egress节点在为本地路由分配标签的时候，会分配一个特殊标签—<strong>3</strong>，该标签被称为隐式空标签（Implicit NULL Label）。当LSR转发一个标签报文时，如果发现对应的出标签值为3，则LSR会将栈顶标签弹出，并将里面所封装的数据转发给下游LSR。</p>
<blockquote>
<p>•在标签发布时，R3为作为192.168.3.0/24这条FEC的Egress LSR。分配标签时，R3为该FEC分配了标签3，并将该标签绑定信息通告给R2。</p>
<p>•在数据转发时，R2作为到达192.168.3.0的次末跳（倒数第二跳），发现出标签值为3，于是将标签头部弹出，将IP报文转发给R3，而R3则仅需执行一次查询操作（查询FIB表）即可获得相应的转发信息，转发效率得到了提升。</p>
</blockquote>
<h3 id="隐式空标签与显式空标签-1"><a href="#隐式空标签与显式空标签-1" class="headerlink" title="隐式空标签与显式空标签 (1)"></a>隐式空标签与显式空标签 (1)</h3><p>•缺省情况下，Egress节点向倒数第二跳分配隐式空标签（implicit-null），即特殊标签3。</p>
<p>•但在部署QoS的场景下，标签被弹出后，其中的优先级也会一并丢失。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<h3 id="隐式空标签与显式空标签-2"><a href="#隐式空标签与显式空标签-2" class="headerlink" title="隐式空标签与显式空标签 (2)"></a>隐式空标签与显式空标签 (2)</h3><p>•显式空标签机制，Egress节点向倒数第二跳分配特殊标签0。</p>
<p>•R3在转发标签报文时，若出标签封装为0，则不会将标签头部弹出，标签头部中的QoS信息得以保存。R4在收到带0标签的报文的时候，直接弹出标签，不用去查找ILM表项。</p>
<p>•缺省情况下，Egress分配的是隐式空标签，通过label advertise explicit-null使能Egress节点向倒数第二跳分配显式空标签。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<blockquote>
<p>•在MPLS视图下，执行命令<strong>label advertise</strong> { <strong>explicit-null</strong> | <strong>implicit-null</strong> | <strong>non-null</strong> }，配置向倒数第二跳分配的标签。</p>
<p>•根据参数的不同，可以配置Egress向倒数第二跳分配不同的标签。</p>
<p>▫缺省情况下，使用的是<strong>implicit-null</strong>，Egress向倒数第二跳节点分配隐式空标签，值为3。</p>
<p>▫如果配置的是<strong>explicit-null</strong>，Egress节点向倒数第二跳分配显式空标签，值为0。当需要支持MPLS QoS属性时，可以选用<strong>explicit-null</strong>。</p>
<p>▫如果配置的是<strong>non-null</strong>，Egress向倒数第二跳正常分配标签，即分配的标签值不小于16。</p>
</blockquote>
<h2 id="LDP工作过程详解"><a href="#LDP工作过程详解" class="headerlink" title="LDP工作过程详解"></a>LDP工作过程详解</h2><h3 id="组网介绍"><a href="#组网介绍" class="headerlink" title="组网介绍"></a>组网介绍</h3><p>•网络中已经部署OSPF路由协议且各设备之间能够正常学习到对方的路由信息。</p>
<p>•已在各设备及相应接口上激活MPLS及LDP，且在相邻的设备之间已正常建立本地LDP会话。</p>
<p>•所有LSR均采用DU + Independent +Liberal方式。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<blockquote>
<p>•华为设备目前缺省模式为下游自主方式（DU）＋ 有序标签分配控制方式（Ordered）＋ 自由标签保持方式（Liberal）。</p>
<p>•对于从R1进入，到达192.168.4.0/24的数据，R1为Ingress LSR，R4为Egress LSR。</p>
</blockquote>
<h3 id="标签分发-Egress-LSR"><a href="#标签分发-Egress-LSR" class="headerlink" title="标签分发 - Egress LSR"></a>标签分发 - Egress LSR</h3><p>•R4直连网段192.168.4.0/24，R4将主动为到达该网段的路由分配标签，如1041，并主动通过LDP协议报文将标签映射通告给LDP对等体R2和R3。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<blockquote>
<p>•注：缺省情况下，根据32位的主机IP路由触发LDP建立LSP。可以通过手工配置触发非32位路由的LSP建立。</p>
</blockquote>
<h3 id="标签分发-Transit-LSR"><a href="#标签分发-Transit-LSR" class="headerlink" title="标签分发 - Transit LSR"></a>标签分发 - Transit LSR</h3><p>•以R2为例，在其路由表中，192.168.4.0/24路由的下一跳为R4，当它从R4收到关于192.168.4.0/24的标签映射通告时，由于该通告来自下游LDP邻居，因此这将触发它自己为该路由分配标签1021，并将标签映射通告给LDP邻居（如R1）。R3同理。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<h3 id="标签分发-Ingress-LSR"><a href="#标签分发-Ingress-LSR" class="headerlink" title="标签分发 - Ingress LSR"></a>标签分发 - Ingress LSR</h3><p>•R1收到LDP邻居R2及R3通告过来的关于192.168.4.0/24路由的标签映射后，将这两个标签都<strong>存储</strong>起来，但是由于在自己的路由表中，到达192.168.4.0/24的下一跳是R2，因此当前它只会<strong>使用</strong>R2所通告的标签1021。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<blockquote>
<p>•注：当R2发生故障时，OSPF路由将会重新收敛，此时R1的路由表中192.168.4.0/24路由的下一跳将会切换至R3，此时R1将启用R3所通告的、关于192.168.4.0/24的标签。</p>
</blockquote>
<h3 id="标签转发-Ingress-LSR"><a href="#标签转发-Ingress-LSR" class="headerlink" title="标签转发 - Ingress LSR"></a>标签转发 - Ingress LSR</h3><p>R1作为Ingress LSR，需要对接收的IP报文执行Push操作压入标签，并进行标签转发。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<blockquote>
<p>•当R1收到发往192.168.4.1的IP报文时，首先在其FIB表中查询该目的IP地址，它发现所匹配的表项的Tunnel ID为非0，因此继续在NHLFE中查询该Tunnel ID，然后意识到需要将对该IP报文压入标签并进行标签转发，出接口为GE0/0/0、下一跳为R2、出站标签为1021，于是为报文插入标签头部并转发出去。</p>
</blockquote>
<h3 id="标签转发-Transit-LSR"><a href="#标签转发-Transit-LSR" class="headerlink" title="标签转发 - Transit LSR"></a>标签转发 - Transit LSR</h3><p>•R2作为Transit LSR，需要对接收的IP报文执行Swap操作交换标签，并进行标签转发。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<blockquote>
<p>•当R2收到携带1021标签的标签报文时，查询ILM，根据ILM对应到NHLFE中的表项。于是，R2对该标签报文通过swap操作将标签更换为1041，并从相应的接口转发出去。</p>
</blockquote>
<h3 id="标签转发-Egress-LSR"><a href="#标签转发-Egress-LSR" class="headerlink" title="标签转发 - Egress LSR"></a>标签转发 - Egress LSR</h3><p>R4作为Egress LSR，需要对接收的IP报文执行Pop操作交换标签，并进行IP转发。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<blockquote>
<p>•当R4收到携带1041标签的标签报文时，查询ILM，根据ILM查询到操作为Pop。于是，R4对该标签报文通过Pop操作将最外层标签剥离，此时该报文已经变成了标准IP报文，R4将对该IP报文执行标准的IP转发流程。</p>
<p>•R4在转发该报文时分别查询了LFIB和FIB表，作为最后Egress LSR，其存在转发效率提升的可能性，怎么做？</p>
</blockquote>
<h3 id="在MPLS中，运行LDP协议的LSR的操作小结"><a href="#在MPLS中，运行LDP协议的LSR的操作小结" class="headerlink" title="在MPLS中，运行LDP协议的LSR的操作小结"></a>在MPLS中，运行LDP协议的LSR的操作小结</h3><p>•LSR首先通过运行IGP协议（例如OSPF、IS-IS等）来构建路由表、FIB表；</p>
<p>•LDP根据相应的模式，为路由表中的路由前缀（FEC）分配标签；</p>
<p>•LDP根据相应的模式，将自己为路由前缀分配的标签，通过LDP标签映射报文通告给LDP邻居；</p>
<p>•LSR将自己为路由前缀分配的标签，以及LDP邻居为该路由前缀通告的标签存储起来，并与出接口、下一跳地址等信息形成关联（标签转发表项）；</p>
<p>•当LSR转发到达目的网络的标签报文时，所使用的出站标签总是下游LDP邻居所通告的标签，此处所指的下游邻居，是设备的路由表中到达该目的网络的下一跳设备。</p>
<h1 id="3-LDP基础配置"><a href="#3-LDP基础配置" class="headerlink" title="3.LDP基础配置"></a>3.LDP基础配置</h1><h2 id="LDP基本配置命令-1"><a href="#LDP基本配置命令-1" class="headerlink" title="LDP基本配置命令 (1)"></a>LDP基本配置命令 (1)</h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/29.png"></p>
<h2 id="LDP基本配置命令-2"><a href="#LDP基本配置命令-2" class="headerlink" title="LDP基本配置命令 (2)"></a><strong>LDP基本配置命令 (2)</strong></h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/30.png"></p>
<blockquote>
<p>•BGP路由也可以触发LDP LSP的建立，但此部分内容不在本课程的讨论范围内。</p>
</blockquote>
<h2 id="LDP基本配置命令-3"><a href="#LDP基本配置命令-3" class="headerlink" title="LDP基本配置命令 (3)"></a>LDP基本配置命令 (3)</h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/31.png"></p>
<h2 id="配置案例"><a href="#配置案例" class="headerlink" title="配置案例"></a>配置案例</h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/32.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/33.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/34.png"></p>
<h2 id="检查配置-查看LSP"><a href="#检查配置-查看LSP" class="headerlink" title="检查配置 - 查看LSP"></a>检查配置 - 查看LSP</h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/35.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选）以下哪条命令用于查看已经为特定FEC分配的标签？（    ）</p>
<p>A、display mpls ldp</p>
<p>B、display mpls ldp interface</p>
<p><strong>C、display mpls lsp</strong></p>
<p>D、display mpls ldp session</p>
<p>2.（单选）华为设备默认的标签发布方式、标签分配控制方式和标签保持方式的组合是（   ）</p>
<p>A、DU + Independent + Conservative</p>
<p><strong>B、DU + Ordered+ Liberal</strong></p>
<p>C、DoD + Independent+ Liberal</p>
<p>D、DoD + Ordered + Conservative</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MPLS体系有多种标签分配协议，LDP标签分配协议是这些协议中使用较广的一种。</p>
<p>•LDP是LSR之间协商标签含义的过程。LDP协议使用发现、会话、通告、通知四类报文进行会话的建立和标签的分发。</p>
<p>•LDP通过标签发布方式、标签分配控制方式和标签保持方式来决定标签的发布和管理。华为数通产品默认的方式为：下游自主标签发布方式+有序标签分配控制方式+自由标签保持方式。</p>
<p>•利用LDP可以实现将网络层的路由信息直接映射到标签信息，进而建立起标签交换路径（LSP）。LSR之间将依据本地转发表中对应于一个特定FEC的入标签、下一跳节点、出标签等信息连接在一起，从而形成跨越整个MPLS域的标签交换路径。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IPadv-MPLS原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T13:09:54+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•90年代中期，互联网流量的快速增长。传统IP报文依赖路由器查询路由表转发，但由于硬件技术存在限制导致转发性能低，路由器的查表转发成为了网络数据转发的瓶颈。 </p>
<p>•因此，旨在提高路由器转发速度的MPLS（Multi-Protocol Label Switching，多协议标签交换）被提出。与传统IP路由方式相比，MPLS在数据转发时，只在网络边缘分析IP报文头，在网络内部采用更为高效的标签（Label）转发，节约了处理时间。</p>
<p>•随着设备硬件性能不断提升，MPLS在提高数据转发速度上的优势逐渐弱化，但其支持多层标签嵌套和设备内转控分离的特点，使其在VPN（Virtual Private Network，虚拟私有网络）、QoS（Quality of Service，服务质量）等新兴应用中得到广泛应用。</p>
<p>•本课程主要介绍MPLS的工作原理以及标签的转发流程，静态标签交换路径的配置方法等。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述MPLS的基本概念及术语</p>
<p>▫描述MPLS的工作原理</p>
<p>▫实现静态LSP的配置</p>
<p>▫描述MPLS的转发流程</p>
<h1 id="1-MPLS基础"><a href="#1-MPLS基础" class="headerlink" title="1.MPLS基础"></a>1.MPLS基础</h1><h2 id="MPLS概述"><a href="#MPLS概述" class="headerlink" title="MPLS概述"></a>MPLS概述</h2><h3 id="传统IP路由转发"><a href="#传统IP路由转发" class="headerlink" title="传统IP路由转发"></a>传统IP路由转发</h3><p>•传统的IP转发采用的是逐跳转发。数据报文经过每一台路由器，都要被解封装查看报文网络层信息，然后根据路由最长匹配原则查找路由表指导报文转发。各路由器重复进行解封装查找路由表和再封装的过程，所以转发性能低。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h3 id="MPLS基本概念"><a href="#MPLS基本概念" class="headerlink" title="MPLS基本概念"></a>MPLS基本概念</h3><p>•MPLS位于TCP/IP协议栈中的数据链路层和网络层之间，可以向所有网络层提供服务。</p>
<p>•通过在数据链路层和网络层之间增加额外的MPLS头部，基于MPLS头部实现数据快速转发。</p>
<p>•本课程仅介绍MPLS在IP网络中的应用。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•MPLS起源于IPv4（Internet Protocol version 4），其核心技术可扩展到多种网络协议，包括IPv6（Internet Protocol version 6）、IPX（Internet Packet Exchange）、Appletalk、DECnet、CLNP（Connectionless Network Protocol）等。MPLS中的“Multiprotocol”指的就是支持多种网络协议。</p>
<p>•MPLS以标签交换替代IP转发。标签是一个短而定长的、只具有本地意义的标识符。</p>
</blockquote>
<h2 id="MPLS术语"><a href="#MPLS术语" class="headerlink" title="MPLS术语"></a>MPLS术语</h2><h3 id="MPLS术语介绍-LSR与MPLS域"><a href="#MPLS术语介绍-LSR与MPLS域" class="headerlink" title="MPLS术语介绍 - LSR与MPLS域"></a>MPLS术语介绍 - LSR与MPLS域</h3><p>•MPLS域（MPLS Domain）：一系列连续的运行MPLS的网络设备构成了一个MPLS域。</p>
<p>•LSR（Label Switching Router，标签交换路由器）：支持MPLS的路由器（实际上也指支持MPLS的交换机或其他网络设备）。位于MPLS域边缘、连接其它网络的LSR称为边沿路由器LER（Label Edge Router），区域内部的LSR称为核心LSR（Core LSR）。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<h3 id="MPLS术语介绍-LSR分类"><a href="#MPLS术语介绍-LSR分类" class="headerlink" title="MPLS术语介绍 - LSR分类"></a>MPLS术语介绍 - LSR分类</h3><p>•除了根据LSR在MPLS域中的位置进行分类之外，还可以根据对数据处理方式的不同进行分类：</p>
<p>▫入站LSR（Ingress LSR）：通常是向IP报文中压入MPLS头部并生成MPLS报文的LSR。</p>
<p>▫中转LSR（Transit LSR）：通常是将MPLS报文进行例如标签置换操作，并将报文继续在MPLS域中转发的LSR。</p>
<p>▫出站LSR（Egress LSR）：通常是将MPLS报文中MPLS头部移除，还原为IP报文的LSR。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<h3 id="MPLS术语介绍-FEC"><a href="#MPLS术语介绍-FEC" class="headerlink" title="MPLS术语介绍 - FEC"></a>MPLS术语介绍 - FEC</h3><p>•FEC（Forwarding Equivalence Class，转发等价类）是一组具有某些共性的数据流的集合，这些数据流在转发过程中被网络节点以相同方式处理。</p>
<ul>
<li>在MPLS网络中，FEC可以通过多种方式划分，例如基于目的IP地址及网络掩码、DSCP等特征来划分。</li>
<li>数据属于哪一个LSP，由数据进入MPLS域时的Ingress LSR决定。</li>
<li>MPLS标签通常是与FEC相对应的，必须有某种机制使得网络中的LSR获得关于某FEC的标签信息。</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<blockquote>
<p>•在传统的采用最长匹配算法的IP转发中，匹配到同一条路由的所有报文就是一个转发等价类。</p>
<p>•在MPLS中，关于FEC最常见的例子是：目的IP地址匹配同一条IP路由的报文被认为属于同一个FEC。</p>
</blockquote>
<h3 id="MPLS术语介绍-LSP"><a href="#MPLS术语介绍-LSP" class="headerlink" title="MPLS术语介绍 - LSP"></a>MPLS术语介绍 - LSP</h3><p>•LSP（Label Switched Path，标签交换路径）是标签报文穿越MPLS网络到达目的地所走的路径。</p>
<p>•同一个FEC的报文通常采用相同的LSP穿越MPLS域，所以对同一个FEC，LSR总是用相同的标签转发。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<blockquote>
<p>•一条LSP包含一台入站LSR、一台出站LSR以及数量可变的中转LSR，因此LSP也可以看做是这些LSR的有序集合。</p>
<p>•LSP需要在数据转发开始前建立完成，只有这样报文才能顺利穿越MPLS域。</p>
<p>•LSP可通过静态和动态两种方式建立。</p>
<p>•需要注意的是，LSP是一个从“起点”到“终点”的单向路径，若需要双向数据互通，则需要在双方之间建立双向的LSP。</p>
</blockquote>
<h2 id="MPLS标签"><a href="#MPLS标签" class="headerlink" title="MPLS标签"></a>MPLS标签</h2><h3 id="MPLS标签-1"><a href="#MPLS标签-1" class="headerlink" title="MPLS标签"></a>MPLS标签</h3><p>•IP报文进入MPLS域之前，会被入站LSR压入MPLS头部（又叫MPLS标签），形成一个MPLS标签报文。一个标签报文可以包含一个或多个MPLS标签。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<blockquote>
<p>•EXP字段在早期的MPLS标准中被定义，意为试验性的字段，但实际上该字段主要被用于CoS。为了避免歧义，RFC5462重新定义了该字段，命名为流分类（Traffic Class）。</p>
</blockquote>
<h3 id="MPLS标签栈"><a href="#MPLS标签栈" class="headerlink" title="MPLS标签栈"></a>MPLS标签栈</h3><p>•MPLS支持一层或多层标签头部，这些标签头部的有序集合被称为标签栈（Label Stack）。</p>
<p>•当标签栈中存在多个标签时，这些标签的顺序是非常讲究的：</p>
<p>​    ▫最靠近二层头部的标签是栈顶标签，标签中的S字段为0。</p>
<p>​    ▫最靠近IP头部的标签是栈底标签，标签中的S字段为1。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<blockquote>
<p>•当上层为MPLS标签栈时，以太网头部中的Type字段为0x8847，PPP头部中的Protocol字段为0x8281。</p>
</blockquote>
<h3 id="标签空间"><a href="#标签空间" class="headerlink" title="标签空间"></a>标签空间</h3><p>•标签是一个短而定长的、只具有本地意义的标识符。标签空间就是指标签的取值范围。标签值的范围及规划如下：</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h3 id="MPLS标签的处理"><a href="#MPLS标签的处理" class="headerlink" title="MPLS标签的处理"></a>MPLS标签的处理</h3><p>LSR对标签的操作类型包括标签压入（Push）、标签交换（Swap）和标签弹出（Pop）。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<h1 id="2-MPLS转发"><a href="#2-MPLS转发" class="headerlink" title="2.MPLS转发"></a>2.MPLS转发</h1><h2 id="MPLS转发概述"><a href="#MPLS转发概述" class="headerlink" title="MPLS转发概述"></a>MPLS转发概述</h2><p>•MPLS转发的本质就是将数据归到对应的FEC并按照提前建立好的LSP进行转发。</p>
<ul>
<li><p>对于整个MPLS域，LSP是某一给定的FEC进入域和离开域的路径，可以看成是LSR的有序集合。</p>
</li>
<li><p>对于单台LSR，需要建立标签转发表，用标签来标识FEC，并绑定相应的标签处理和转发等行为。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<blockquote>
<p>•同一个FEC，若进入MPLS域的Ingress LSR（入站LSR）不同，转发时的LSP也不相同。</p>
<p>•同一个FEC，LSR的处理方式相同，不论这个FEC来自哪里（进入设备的接口）。</p>
<p>•LSR的转发动作决定了LSP，而标签转发表确定转发动作，所以建立标签转发表也可以理解为建立LSP。</p>
<p>•如图所示，因为有着相同的目的地，所以这三份数据属于同一个转发等价类FEC1。同时由于入站LSR不同，这些数据将分别在LSP1、LSP2和LSP3上被转发。因为标签仅具有本地意义，所以每台LSR上给同一FEC分配的标签，可以相同，也可以不同。</p>
</blockquote>
<h2 id="MPLS体系结构"><a href="#MPLS体系结构" class="headerlink" title="MPLS体系结构"></a>MPLS体系结构</h2><p>MPLS的体系结构由控制平面 (Control Plane)和转发平面 (Forwarding Plane)组成。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<blockquote>
<p>•控制平面：</p>
<ul>
<li><p>控制平面是无连接的，主要功能是负责产生和维护路由信息以及标签信息。</p>
</li>
<li><p>控制平面包括：</p>
<ul>
<li>路由信息表RIB（Routing Information Base）：由IP路由协议（IP Routing Protocol）、静态路由和直连路由共同生成，用于选择路由。</li>
<li>标签信息表LIB（Label Information Base）：用于管理标签信息，LIB中的表项可由标签交换协议（LDP、RSVP等协议）或静态配置生成。</li>
</ul>
</li>
</ul>
<p>•转发平面：</p>
<ul>
<li><p>转发平面也称为数据平面，是面向连接的， 主要功能是负责普通IP报文的转发以及带MPLS标签报文的转发。</p>
</li>
<li><p>转发平面包括：</p>
<ul>
<li>转发信息表FIB（Forwarding Information Base）：从RIB提取必要的路由信息生成，负责普通IP报文的转发。</li>
<li>标签转发信息表LFIB（Label Forwarding Information Base）：简称标签转发表，负责带MPLS标签报文的转发。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="控制平面与转发平面"><a href="#控制平面与转发平面" class="headerlink" title="控制平面与转发平面"></a>控制平面与转发平面</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<h2 id="LSP建立原则"><a href="#LSP建立原则" class="headerlink" title="LSP建立原则"></a>LSP建立原则</h2><p>•当网络层协议为IP协议时，FEC所对应的路由必须存在于LSR的IP路由表中，否则该FEC的标签转发表项不生效。</p>
<p>•LSR用标签标识指定FEC，所以该FEC的数据被发送至LSR时，必须携带正确的标签，才能被LSR正确的处理。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<h2 id="LSP建立方式"><a href="#LSP建立方式" class="headerlink" title="LSP建立方式"></a>LSP建立方式</h2><p>•MPLS需要为报文事先分配好标签，建立一条LSP，才能进行报文转发。LSP分为静态LSP和动态LSP两种。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•静态LSP：</p>
<ul>
<li>由于静态LSP各节点上不能相互感知到整个LSP的情况，因此静态LSP是一个本地的概念。</li>
</ul>
<p>•动态LSP：</p>
<ul>
<li>其他标签分布协议：<ul>
<li>RSVP-TE：Resource Reservation Protocol Traffic Engineering，它是对RSVP的扩展，用于建立基于约束的LSP。它拥有普通LDP LSP没有的功能，如发布带宽预留请求、带宽约束、链路颜色和显式路径等。</li>
<li>MP-BGP：Multiprotocol Border Gateway Protocol，MP-BGP是在BGP协议基础上扩展的协议。MP-BGP支持为MPLS VPN业务中私网路由和跨域VPN的标签路由分配标签。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="MPLS标签转发"><a href="#MPLS标签转发" class="headerlink" title="MPLS标签转发"></a>MPLS标签转发</h2><p>LSR处理报文时主要根据FTN、 NHLFE和ILM。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•Tunnel ID：为了给使用隧道的上层应用（如VPN、路由管理）提供统一的接口，系统自动为隧道分配了一个ID，也称为Tunnel ID。该Tunnel ID的长度为32比特，只是本地有效。在MPLS转发过程中，FIB、ILM和NHLFE表项是通过Tunnel ID关联的。</p>
</blockquote>
<h2 id="Ingress-LSR的处理"><a href="#Ingress-LSR的处理" class="headerlink" title="Ingress LSR的处理"></a>Ingress LSR的处理</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<blockquote>
<p>•在Ingress LSR，通过查询FIB表（得到FTN信息）和NHLFE表指导报文的转发。</p>
<p>•当IP报文进入MPLS域时，首先查看FIB表，检查目的IP地址对应的Tunnel ID值是否为0x0。</p>
<p>​    ▫如果Tunnel ID值为0x0，则进入正常的IP转发流程。</p>
<p>​    ▫如果Tunnel ID值不为0x0，则进入MPLS转发流程。</p>
</blockquote>
<h2 id="Transit-LSR的处理"><a href="#Transit-LSR的处理" class="headerlink" title="Transit LSR的处理"></a>Transit LSR的处理</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<blockquote>
<p>•在Transit LSR，通过查询ILM表和NHLFE表指导MPLS报文的转发。</p>
</blockquote>
<h2 id="Egress-LSR的处理"><a href="#Egress-LSR的处理" class="headerlink" title="Egress LSR的处理"></a>Egress LSR的处理</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<blockquote>
<p>•在Egress LSR，通过查询ILM表指导MPLS报文的转发。</p>
</blockquote>
<h2 id="MPLS详细转发过程"><a href="#MPLS详细转发过程" class="headerlink" title="MPLS详细转发过程"></a>MPLS详细转发过程</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<h1 id="3-静态LSP配置"><a href="#3-静态LSP配置" class="headerlink" title="3.静态LSP配置"></a>3.静态LSP配置</h1><h2 id="MPLS基本配置命令"><a href="#MPLS基本配置命令" class="headerlink" title="MPLS基本配置命令"></a>MPLS基本配置命令</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<h2 id="静态LSP配置命令-1"><a href="#静态LSP配置命令-1" class="headerlink" title="静态LSP配置命令 (1)"></a>静态LSP配置命令 (1)</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<blockquote>
<p>•out-label占用的是下游LSR的标签空间，而下游空间采用的标签分发方式不确定，所以out-label的标签空间为16~1048575。</p>
<p>•in-label占用的是当前LSR的标签空间，采用静态LSP时，标签空间为16~1023。</p>
</blockquote>
<h2 id="静态LSP配置命令-2"><a href="#静态LSP配置命令-2" class="headerlink" title="静态LSP配置命令 (2)"></a>静态LSP配置命令 (2)</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<h2 id="静态LSP配置案例"><a href="#静态LSP配置案例" class="headerlink" title="静态LSP配置案例"></a>静态LSP配置案例</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<h2 id="静态LSP配置案例-检查配置"><a href="#静态LSP配置案例-检查配置" class="headerlink" title="静态LSP配置案例 - 检查配置"></a>静态LSP配置案例 - 检查配置</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<h2 id="静态LSP配置案例-抓包分析"><a href="#静态LSP配置案例-抓包分析" class="headerlink" title="静态LSP配置案例 - 抓包分析"></a>静态LSP配置案例 - 抓包分析</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选）下面对MPLS头部的描述正确的是 （   )</p>
<p><strong>A.MPLS头部的长度为32比特</strong></p>
<p>B.MPLS头部中的Label字段取值范围为0~65535</p>
<p><strong>C.MPLS可以实现多层MPLS头部的嵌套</strong></p>
<p>D.可以通过MPLS头部中的max_hop字段防止标签报文被无限制转发</p>
<p>2.（单选）在配置Transit LSR上的静态LSP时，入标签和出标签的取值均为16~1023 </p>
<p>A.正确</p>
<p><strong>B.错误</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MPLS最初是为了解决传统IP路由器查表转发速度慢而被提出的，是一种通过标签头部实现快速转发的技术。</p>
<p>•MPLS标签是一个短而定长的、只具有本地意义的标识符，用于唯一标识一个分组所属的FEC。LSR对标签的操作类型包括标签压入、标签交换和标签弹出。</p>
<p>•MPLS包含控制平面和数据平面，控制平面主要负责路由信息的传递和标签的分发，数据平面主要负责数据的转发。</p>
<p>•随着技术的发展，MPLS在数据转发速度上的优势逐渐弱化，但其特性使其在VPN领域得到广泛应用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" itemprop="url">IPadv-IGP高级特性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-31T11:38:08+08:00">
                2021-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•OSPF和IS-IS都是基于链路状态的内部网关路由协议，运行这两种协议的路由器通过同步LSDB，采用SPF算法计算最优路由。</p>
<p>•当网络拓扑发生变化时，OSPF和IS-IS支持多种快速收敛和保护机制，能够降低网络故障导致的流量丢失。</p>
<p>•为了实现对路由表规模的控制，OSPF和IS-IS支持路由选路及路由信息的控制，能够减少特定路由器路由表的大小。</p>
<p>•本节课程将介绍OSPF和IS-IS的高级特性，包括：快速收敛机制、路由控制等。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述OSPF和IS-IS的各种快速收敛的技术</p>
<p>▫实现OSPF和IS-IS等价路由的配置</p>
<p>▫实现OSPF和IS-IS发布缺省路由</p>
<p>▫描述OSPF和IS-IS多进程使用场景</p>
<p>▫描述OSPF转发地址的使用场景</p>
<p>▫描述IS-IS的LSP分片扩展的工作原理</p>
<h1 id="1-OSPF快速收敛"><a href="#1-OSPF快速收敛" class="headerlink" title="1.OSPF快速收敛"></a>1.OSPF快速收敛</h1><h2 id="OSPF快速收敛概述"><a href="#OSPF快速收敛概述" class="headerlink" title="OSPF快速收敛概述"></a>OSPF快速收敛概述</h2><p>•OSPF快速收敛是为了提高路由的收敛速度而做的扩展特性，包括：PRC（Partial Route Calculation，部分路由计算）和智能定时器。</p>
<p>•同时，OSPF支持故障恢复快速收敛，例如通过OSPF IP FRR（Fast reroute，快速重路由）实现备份链路的快速切换，也可以与BFD联动实现对故障的快速感知。</p>
<h2 id="PRC"><a href="#PRC" class="headerlink" title="PRC"></a>PRC</h2><p>•PRC的工作原理：当网络上路由发生变化的时候，只对发生变化的路由进行重新计算。</p>
<p>•PRC不计算节点路径，而是根据SPF算法算出来的最短路径树来更新路由。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/1.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/2.png"></p>
<blockquote>
<p>•注意：在华为设备上，OSPF的PRC功能默认开启。</p>
</blockquote>
<h2 id="智能定时器"><a href="#智能定时器" class="headerlink" title="智能定时器"></a>智能定时器</h2><p>•智能定时器是在进行SPF计算和产生LSA的时候用到的一种定时器。</p>
<p>•智能定时器既可以对少量的外界突发事件进行快速响应，又可以避免过度的占用CPU。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/3.png"></p>
<blockquote>
<p>•如果触发路由计算的时间间隔较长，同样会影响网络的收敛速度。</p>
<p>•智能定时器首次超时时间是一个固定的时间。如果在定时器超时前，又有触发定时器的事件发生，则该定时器下一次的超时时间会增加。</p>
</blockquote>
<h2 id="智能定时器的基础配置命令-1"><a href="#智能定时器的基础配置命令-1" class="headerlink" title="智能定时器的基础配置命令 (1)"></a>智能定时器的基础配置命令 (1)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/4.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf] <strong>lsa**</strong>-originate-interval** { <strong>0</strong> | { <strong>intelligent-timer</strong> <em>max-interval</em> <em>start-interval</em> <em>hold-interval</em> | <strong>other-type</strong> <em>interval</em> } }</p>
<p>​    ▫<strong>0</strong>：指定LSA更新的时间间隔为0，即取消LSA的5秒的更新时间间隔。</p>
<p>​    ▫<strong>intelligent-timer</strong>：指定通过智能定时器设置OSPF Router LSA和Network LSA的更新间隔时间。</p>
<p>​    ▫<em>max-interval</em>：指定更新OSPF LSA的最长间隔时间。整数形式，取值范围是1～120000，单位是毫秒。缺省值是5000。</p>
<p>​    ▫<em>start-interval</em>：指定更新OSPF LSA的初始间隔时间。整数形式，取值范围是0～60000，单位是毫秒。缺省值是500。</p>
<p>​    ▫<em>hold-interval</em>：指定更新OSPF LSA的基数间隔时间。整数形式，取值范围是1～60000，单位是毫秒。缺省值是1000。</p>
<p>​    ▫<strong>other-type</strong>：指定设置除OSPF Router LSA和Network LSA外LSA的更新间隔时间。</p>
<p>​    ▫<em>interval</em>：指定LSA更新的时间间隔。整数形式，取值范围是0～10，单位是秒。缺省值是5。</p>
</blockquote>
<h2 id="智能定时器的基础配置命令-2"><a href="#智能定时器的基础配置命令-2" class="headerlink" title="智能定时器的基础配置命令 (2)"></a>智能定时器的基础配置命令 (2)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/5.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>lsa**</strong>-arrival-interval** { <em>interval</em> | <strong>intelligent-timer</strong> <em>max-interval</em> <em>start-interval</em> <em>hold-interval</em> }</p>
<p>​    ▫<em>interval</em>：指定LSA接收的时间间隔。整数形式，取值范围是0～10000，单位是毫秒。</p>
<p>​    ▫<strong>intelligent-timer</strong>：指定通过智能定时器设置LSA接收的间隔时间。</p>
<p>​    ▫<em>max-interval</em>：指定接收OSPF LSA的最长间隔时间。整数形式，取值范围是1～120000，单位是毫秒。缺省值是1000。</p>
<p>​    ▫<em>start-interval</em>：指定接收OSPF LSA的初始间隔时间。整数形式，取值范围是0～60000，单位是毫秒。缺省值是500。</p>
<p>​    ▫<em>hold-interval</em>：指定接收OSPF LSA的基数间隔时间。整数形式，取值范围是1～60000，单位是毫秒。缺省值是500。</p>
</blockquote>
<h2 id="智能定时器的基础配置命令-3"><a href="#智能定时器的基础配置命令-3" class="headerlink" title="智能定时器的基础配置命令 (3)"></a>智能定时器的基础配置命令 (3)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/6.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>spf**</strong>-schedule-interval** { <em>interval1</em> | <strong>intelligent-timer</strong> <em>max-interval</em> <em>start-interval</em> <em>hold-interval</em> | <strong>millisecond</strong> <em>interval2</em> }</p>
<p>​    ▫<em>interval1**：</em>指定OSPF SPF计算间隔时间。整数形式，取值范围是1～10，单位是秒。</p>
<p>​    ▫<strong>intelligent-timer</strong>：指定通过智能定时器设置OSPF SPF计算的间隔时间。</p>
<p>​    ▫<em>max-interval</em>：指定OSPF SPF计算的最长间隔时间。整数形式，取值范围是1～120000，单位是毫秒。缺省值是10000。</p>
<p>​    ▫<em>start-interval</em>：指定OSPF SPF计算的初始间隔时间。整数形式，取值范围是1～60000，单位是毫秒。缺省值是500。</p>
<p>​    ▫<em>hold-interval</em>：指定OSPF SPF计算的基数间隔时间。整数形式，取值范围是1～60000，单位是毫秒。缺省值是1000。</p>
<p>​    ▫<strong>millisecond</strong> <em>interval2</em>：指定OSPF SPF计算间隔时间。整数形式，取值范围是1～10000，单位是毫秒。</p>
</blockquote>
<h2 id="OSPF-IP-FRR"><a href="#OSPF-IP-FRR" class="headerlink" title="OSPF IP FRR"></a>OSPF IP FRR</h2><p>•OSPF IP FRR（Fast reroute，快速重路由）是动态IP FRR，利用LFA（Loop-Free Alternates）算法预先计算出备份路径，保存在转发表中，以备在故障时将流量快速切换到备份链路上，保证流量不中断，从而达到流量保护的目的，该功能可将故障恢复时间降低到50ms以内。</p>
<p>•LFA计算备份链路的基本思路是：</p>
<p>​    ▫以可提供备份链路的邻居为根节点，利用SPF算法计算出到目的节点的最短距离。然后，按照不等式计算出开销最小且无环的备份链路。</p>
<h2 id="OSPF-IP-FRR组网应用"><a href="#OSPF-IP-FRR组网应用" class="headerlink" title="OSPF IP FRR组网应用"></a>OSPF IP FRR组网应用</h2><p>OSPF IP FRR的流量保护分为链路保护和节点链路双保护。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/7.png"></p>
<blockquote>
<p>•节点链路双保护：</p>
<p>​    ▫如图：流量从设备S到D进行转发，网络开销值满足节点链路保护公式，可保证当主链路故障后，设备S将流量切换到备份链路S到N后可以继续向下游转发，确保流量中断小于50ms。</p>
<p>•OSPF IP FRR的流量保护分为链路保护和节点链路双保护。</p>
<p>​    ▫当需要保护的对象是经过特定链路的流量时，流量保护类型为链路保护。</p>
<p>​    ▫当需要保护的对象是经过特定设备的流量时，流量保护类型为节点链路双保护。节点保护优先级高于链路保护。</p>
</blockquote>
<h2 id="OSPF-IP-FRR的基础配置命令"><a href="#OSPF-IP-FRR的基础配置命令" class="headerlink" title="OSPF IP FRR的基础配置命令"></a>OSPF IP FRR的基础配置命令</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/8.png"></p>
<h2 id="OSPF-IP-FRR配置举例"><a href="#OSPF-IP-FRR配置举例" class="headerlink" title="OSPF IP FRR配置举例"></a>OSPF IP FRR配置举例</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/9.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/10.png"></p>
<h3 id="查看OSPF-IP-FRR配置结果"><a href="#查看OSPF-IP-FRR配置结果" class="headerlink" title="查看OSPF IP FRR配置结果"></a>查看OSPF IP FRR配置结果</h3><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/11.png"></p>
<h2 id="OSPF与BFD联动"><a href="#OSPF与BFD联动" class="headerlink" title="OSPF与BFD联动"></a>OSPF与BFD联动</h2><p>•网络上的链路故障或拓扑变化都会导致设备重新进行路由计算，所以缩短路由协议的收敛时间对于提高网络的性能是非常重要的。</p>
<p>•OSPF与BFD联动就是将BFD和OSPF关联起来，一旦与邻居之间的链路出现故障，BFD对链路故障的快速感应能够加快OSPF对于网络拓扑变化的响应。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/12.png"></p>
<blockquote>
<p>•OSPF通过周期性的向邻居发送Hello报文来实现邻居检测，检测到故障所需时间比较长，超过1秒钟（默认通过OSPF Dead Timer超时判断邻居失效，缺省为40s）。随着科技的发展，语音、视频及其它点播业务应用广泛，而这些业务对于丢包和延时非常敏感，当数据达到吉比特速率级时，较长的检测时间会导致大量数据丢失，无法满足电信级网络高可靠性的需求。</p>
<p>•为了解决上述问题，配置指定进程或指定接口的OSPF与BFD联动功能，可以快速检测链路的状态，故障检测时间可以达到毫秒级，提高链路状态变化时OSPF的收敛速度。</p>
</blockquote>
<h2 id="OSPF与BFD联动的基础配置命令"><a href="#OSPF与BFD联动的基础配置命令" class="headerlink" title="OSPF与BFD联动的基础配置命令"></a>OSPF与BFD联动的基础配置命令</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/13.png"></p>
<blockquote>
<p>•配置前提：</p>
<ul>
<li>如果需要使用BFD功能快速检测链路故障，则必须在系统视图下执行<strong>bfd</strong>命令，使能全局BFD功能。</li>
</ul>
<p>•接口配置的BFD特性优先级高于进程配置的BFD特性优先级。如果打开了接口的BFD开关，则按照接口上BFD参数建立BFD会话。</p>
<p>•可以配置OSPF IP FRR与BFD联动：</p>
<ul>
<li><p>配置OSPF IP FRR特性时，需要底层能够快速响应链路变化，以便迅速将流量切换到备份链路。</p>
</li>
<li><p>将OSPF IP FRR与BFD会话绑定可以达到快速感知故障的目的，确保故障后流量切换的及时性。</p>
</li>
</ul>
<p>•命令：[Huawei-ospf-1] <strong>bfd</strong> <strong>all-interfaces</strong> { <strong>min-rx-interval</strong> <em>receive-interval</em> | <strong>min-tx-interval</strong> <em>transmit-interval</em> | <strong>detect-multiplier</strong> <em>multiplier-value</em> | <strong>frr-binding</strong> } </p>
<ul>
<li><p><strong>min-rx-interval</strong> <em>receive-interval</em>：指定期望从对端接收BFD报文的最小接收间隔。整数形式，取值范围是10～2000，单位是毫秒。缺省值是1000毫秒。</p>
</li>
<li><p><strong>min-tx-interval</strong> <em>transmit-interval</em>：指定向对端发送BFD报文的最小发送间隔。整数形式，取值范围是10～2000，单位是毫秒。缺省值是1000毫秒。</p>
</li>
<li><p><strong>detect-multiplier</strong> <em>multiplier-value</em>：指定本地检测倍数。整数形式，取值范围是3～50，缺省值是3。</p>
</li>
<li><p><strong>frr-binding</strong>：将BFD会话状态与接口的链路状态进行绑定。当BFD会话状态变为Down时，接口的物理层链路状态也会变为Down，从而触发流量切换到备份路径。</p>
</li>
</ul>
</blockquote>
<h1 id="2-OSPF路由控制"><a href="#2-OSPF路由控制" class="headerlink" title="2.OSPF路由控制"></a>2.OSPF路由控制</h1><h2 id="OSPF路由控制概述"><a href="#OSPF路由控制概述" class="headerlink" title="OSPF路由控制概述"></a>OSPF路由控制概述</h2><p>OSPF的路由控制包括：</p>
<p>▫调整OSPF的接口开销</p>
<p>▫设置等价路由</p>
<p>▫引入外部路由</p>
<p>▫路由聚合a</p>
<p>▫缺省路由通告</p>
<p>▫Filter-Policy</p>
<p>▫对发送的LSA进行过滤</p>
<p>▫对ABR Type3 LSA进行过滤</p>
<p>▫设置LSDB中External LSA的最大数量</p>
<blockquote>
<p>•本课程只介绍等价路由、缺省路由、对LSA的过滤，其他内容请参考《HCIP-Datacom-Core Technology》课程。</p>
</blockquote>
<h2 id="等价路由"><a href="#等价路由" class="headerlink" title="等价路由"></a>等价路由</h2><p>•当路由表中存在到达同一目的地址，且同一路由协议发现的多条路由时，若这几条路由的开销值也相同，那么这些路由就是等价路由，可以实现负载分担。</p>
<p>•设备将按照负载分担的方式从多条等价路由发送报文到同一目的地址。</p>
<p>   设置进行负载分担的等价路由的最大数量：</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/14.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>maximum load-balancing</strong> <em>number</em></p>
<p>▫<em>number</em>：等价路由的最大数量。设备型号不同，取值范围不同，具体请参考相应设备的产品文档。</p>
</blockquote>
<h2 id="等价路由配置举例"><a href="#等价路由配置举例" class="headerlink" title="等价路由配置举例"></a>等价路由配置举例</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/15.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/16.png"></p>
<h2 id="缺省路由"><a href="#缺省路由" class="headerlink" title="缺省路由"></a>缺省路由</h2><p>•OSPF实际组网应用中，区域边界和自治系统边界通常都是由多个路由器组成的多出口冗余备份或者负载分担。此时，为了减少路由表的容量，可以配置缺省路由，保证网络的高可用性。</p>
<p>•OSPF缺省路由通常应用于下面两种情况：</p>
<p>​    ▫由区域边界路由器（ABR）发布Type3 LSA，用来指导区域内路由器进行区域之间报文的转发。</p>
<p>​    ▫由自治系统边界路由器（ASBR）发布Type5 LSA或Type7 LSA，用来指导OSPF路由域内路由器进行域外报文的转发。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/17.png"></p>
<blockquote>
<p>•缺省路由是指目的地址和掩码都是0的路由。当设备无精确匹配的路由时，就可以通过缺省路由进行报文转发。由于OSPF路由的分级管理，Type3缺省路由的优先级高于Type5或Type7路由。</p>
<p>•普通区域：</p>
<p>​    ▫缺省情况下，普通OSPF区域内的OSPF路由器是不会产生缺省路由的，即使它有缺省路由。当该路由器需要向OSPF发布缺省路由时，必须手工执行<strong>default-route-advertise</strong>命令，配置完成后，路由器会产生一个缺省ASE LSA（Type5 LSA），并且通告到整个OSPF自治系统中。</p>
<p>•Stub区域：</p>
<p>​    ▫Stub区域不允许自治系统外部的路由（Type5 LSA）在区域内传播。区域内的路由器必须通过ABR学到自治系统外部的路由。</p>
<p>​    ▫Stub区域的ABR会自动产生一条缺省的Type3 LSA通告到整个Stub区域。ABR通过该缺省路由，将到达AS外部的流量吸引到自己这里，然后通过ABR转发出去。</p>
<p>•Totally Stub区域：</p>
<p>​    ▫Totally Stub区域既不允许自治系统外部的路由（Type5 LSA）在区域内传播，也不允许区域间路由（Type3 LSA）在区域内传播。区域内的路由器必须通过ABR学到自治系统外部和其他区域的路由。</p>
<p>​    ▫Totally Stub区域的ABR会自动产生一条缺省的Type3 LSA通告到整个Stub区域。ABR通过该缺省路由，将到达AS外部的流量吸引到自己这里，然后通过ABR转发出去。</p>
<p>•NSSA区域：</p>
<p>​    ▫如果希望到达自治系统外部的路由通过本区域（NSSA区域）的ASBR到达，而其它外部路由通过其它区域出去。此时，ABR会产生一条Type7 LSA的缺省路由，通告到整个NSSA区域内。这样，除了某少部分路由通过NSSA的ASBR到达，其它路由都可以通过NSSA的ABR到达其它区域的ASBR出去。这种情况下，在ABR上无论路由表中是否存在缺省路由0.0.0.0，都会产生Type7 LSA的缺省路由。</p>
<p>​    ▫如果希望所有的外部路由只通过本区域（NSSA区域）的ASBR到达，则必须在ASBR上手动执行<strong>nssa</strong> **[default-route-advertise]**命令进行配置，使ASBR产生一条缺省的NSSA LSA（Type7 LSA），通告到整个NSSA区域内。这样，所有的外部路由就只能通过本区域NSSA的ASBR到达。这种情况下，在ASBR上只有当路由表中存在缺省路由0.0.0.0时，才会产生Type7 LSA的缺省路由。</p>
<p>​    ▫注意：因为缺省路由只是在本NSSA区域内泛洪，并没有泛洪到整个OSPF域中，所以本NSSA区域内的路由器在找不到路由之后可以从该NSSA的ASBR出去，但不能实现其他OSPF域的路由从这个出口出去。Type7 LSA缺省路由不会在ABR上转换成Type5 LSA缺省路由泛洪到整个OSPF域。</p>
<p>•Totally NSSA区域：</p>
<p>​    ▫Totally NSSA的ABR会自动向该区域下发使用Type3 LSA描述的缺省路由，而Totally NSSA的ASBR则不会自动下发缺省路由。因此，在该场景下，对于区域内的路由器而言，可以通过ASBR引入的外部路由到达相应的外部网段、通过ABR下发的缺省路由到达其他网段。</p>
<p>​    ▫如果希望Totally NSSA内的路由器选择ASBR作为默认出口，而不是ABR，那么需要让ASBR也下发缺省路由，此时必须在ASBR上手工执行配置。</p>
</blockquote>
<h2 id="将缺省路由通告到OSPF路由区域"><a href="#将缺省路由通告到OSPF路由区域" class="headerlink" title="将缺省路由通告到OSPF路由区域"></a>将缺省路由通告到OSPF路由区域</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/18.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>default-route-advertise</strong> [ [ <strong>always</strong> | <strong>permit-calculate-other</strong> ] | <strong>cost</strong> <em>cost</em> | <strong>type</strong> <em>type</em> | <strong>route-policy</strong> <em>route-policy-name</em> [ <strong>match-any</strong> ] ]</p>
<p>​    ▫<strong>always</strong>：无论本机是否存在激活的非本OSPF缺省路由，都会产生并发布一个描述缺省路由的LSA。</p>
<p>​        ▪如果配置了always参数，设备不再计算来自其他设备的缺省路由。</p>
<p>​        ▪如果没有配置always参数，本机路由表中必须有激活的非本OSPF缺省路由时才生成缺省路由的LSA。</p>
<p>​    ▫<strong>permit-calculate-other</strong>：本机必须存在激活的非本OSPF缺省路由时才会产生并发布一个缺省路由的LSA，且设备仍然计算来自于其他设备的缺省路由。</p>
<p>​    ▫<strong>type</strong> <em>type</em> ：指定外部路由的类型。整数形式，取值为1或2。缺省值是2。</p>
<p>​        ▪1：第一类外部路由</p>
<p>​        ▪2：第二类外部路由</p>
<p>​    ▫<strong>route-policy</strong> <em>route-policy-name</em>：通过路由策略，实现在路由表中有匹配的非OSPF产生的缺省路由表项时，按路由策略所配置的参数发布缺省路由。字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
<p>​    ▫<strong>match-any</strong>：通过路由策略，实现在路由表中有匹配的路由表项时，按路由策略所配置的参数发布缺省路由。</p>
<p>•命令：[Huawei-ospf-1] <strong>default-route-advertise</strong> <strong>summary</strong> <strong>cost</strong> <em>cost</em></p>
<p>​    ▫<strong>summary</strong>：发布指定缺省路由的Type3 LSA。在选用该参数时，必须首先使能VPN，否则路由不能发布。</p>
<p>​    ▫<strong>cost</strong> <em>cost</em>：指定该LSA的开销值。整数形式，取值范围是0～16777214。缺省值是1。</p>
<p>•always参数：</p>
<p>​    ▫ASBR已经有缺省路由，执行default-route-advertise命令，将在整个OSPF区域中通告缺省路由0.0.0.0。</p>
<p>​    ▫ASBR没有缺省路由，执行default-route-advertise命令时按照以下需求选择是否配置always参数。</p>
<p>​        ▪如果配置always参数，无论ASBR是否有缺省路由都将在整个OSPF区域中通告缺省路由0.0.0.0，并且不再计算来自其他设备的缺省路由。</p>
<p>​        ▪如果没有配置always参数，ASBR的路由表中必须有激活的非OSPF（BGP除外）缺省路由时才生成缺省路由的LSA。</p>
<p>•match-any参数：</p>
<p>​    ▫使用带match-any参数的路由策略时，如果有多条路由通过策略，选取最优者来生成缺省LSA。路由通过策略时，选取最优者的原则按照优先级从高到低的顺序如下：</p>
<p>​        ▪路由设置了type的优先于未设置的，如果都设置了type，值越小越优先。</p>
<p>​        ▪路由设置了cost的优先于未设置的，如果都设置了cost，值越小越优先。</p>
<p>​        ▪路由设置了tag的优先于未设置的， 如果都设置了tag，值越小越优先。</p>
</blockquote>
<h2 id="对发送的LSA进行过滤"><a href="#对发送的LSA进行过滤" class="headerlink" title="对发送的LSA进行过滤"></a>对发送的LSA进行过滤</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/19.png"></p>
<blockquote>
<p>•命令：[Huawei-GigabitEthernet0/0/1] <strong>ospf</strong> <strong>filter-lsa-out</strong> { <strong>all</strong> | { <strong>summary</strong> [ <strong>acl</strong> { <em>acl-number</em> | <em>acl-name</em> } ] | <strong>ase</strong> [ <strong>acl</strong> { <em>acl-number</em> | <em>acl-name</em> } ] | <strong>nssa</strong> [ <strong>acl</strong> { <em>acl-number</em> | <em>acl-name</em> } ] } }</p>
<p>​    ▫<strong>all</strong>：对除Grace LSA外的所有LSA进行过滤。</p>
<p>​    ▫<strong>summary</strong>：对Network Summary LSA（Type3 LSA）进行过滤。</p>
<p>​    ▫<strong>ase</strong>：对AS External LSA（Type5 LSA）进行过滤。</p>
<p>​    ▫<strong>nssa</strong>：对NSSA LSA（Type7 LSA）进行过滤。</p>
<p>​    ▫<strong>acl</strong> <em>acl-number</em>：指定基本访问控制列表编号。整数形式，取值范围是2000～2999。</p>
<p>​    ▫<strong>acl</strong> <em>acl-name</em>：指定访问控制列表名称。字符串形式，不支持空格，区分大小写，长度范围是1～32，以英文字母a～z或A～Z开始。</p>
</blockquote>
<h2 id="对ABR-Type3-LSA进行过滤"><a href="#对ABR-Type3-LSA进行过滤" class="headerlink" title="对ABR Type3 LSA进行过滤"></a>对ABR Type3 LSA进行过滤</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/20.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1-area-0.0.0.1] <strong>filter</strong> { <em>acl-number</em> | <strong>acl-name</strong> <em>acl-name</em> | <strong>ip-prefix</strong> <em>ip-prefix-name</em> | <strong>route-policy</strong> <em>route-policy-name</em> } <strong>export</strong></p>
<p>▫<em>acl-number</em>：指定基本访问控制列表号。整数形式，取值范围是2000～2999。</p>
</blockquote>
<h2 id="OSPF-Database-Overflow概述"><a href="#OSPF-Database-Overflow概述" class="headerlink" title="OSPF Database Overflow概述"></a>OSPF Database Overflow概述</h2><p>•OSPF要求同一个区域中的路由器保存相同的LSDB。随着网络上路由数量不断增加，一些路由器由于系统资源有限，不能再承载如此多的路由信息，这种状态就被称为数据库超限（OSPF Database Overflow）。</p>
<p>•对于路由信息不断增加导致路由器系统资源耗尽而失效的问题，可以通过配置Stub或NSSA区域来解决，但Stub或NSSA区域的方案不能解决动态路由增长导致的数据库超限问题。为了解决数据库超限引发的问题，通过设置LSDB中External LSA的最大条目数，可以动态限制链路数据库的规模。</p>
<p>   设置OSPF的LSDB中External LSA的最大条目数</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/21.png"></p>
<blockquote>
<p>•当OSPF引入的外部路由（Type5 LSA和Type7 LSA）数量超过允许的范围，会导致超出的外部路由无法得到正常处理，丢失引入的路由。为了解决上述问题，通过配置OSPF的LSDB中External LSA的最大条目数，保证引入的外部路由在一个合理的范围内，调整和优化OSPF网络。</p>
<p>•命令：[Huawei-ospf-1] <strong>lsdb-overflow-limit</strong> <em>number</em></p>
<p>​    ▫<em>number</em>：指定LSDB中External LSA的最大条目数。整数形式，取值范围是1～1000000。</p>
</blockquote>
<h2 id="避免OSPF-Database-Overflow工作原理"><a href="#避免OSPF-Database-Overflow工作原理" class="headerlink" title="避免OSPF Database Overflow工作原理"></a>避免OSPF Database Overflow工作原理</h2><p>•为了避免数据库超限，可以设置路由器上非缺省外部路由数量的上限。</p>
<p>•OSPF网络中所有路由器都配置相同的上限值，只要路由器上外部路由的数量达到该上限，路由器就进入Overflow状态，并同时启动Overflow状态定时器（默认超时时间为5秒），路由器在定时器超过5秒后自动退出Overflow状态。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/22.png"></p>
<h2 id="OSPF路由控制配置举例-1"><a href="#OSPF路由控制配置举例-1" class="headerlink" title="OSPF路由控制配置举例 (1)"></a>OSPF路由控制配置举例 (1)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/23.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/24.png"></p>
<h2 id="OSPF路由控制配置举例-2"><a href="#OSPF路由控制配置举例-2" class="headerlink" title="OSPF路由控制配置举例 (2)"></a>OSPF路由控制配置举例 (2)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/25.png"></p>
<h2 id="OSPF路由控制案例分析"><a href="#OSPF路由控制案例分析" class="headerlink" title="OSPF路由控制案例分析"></a>OSPF路由控制案例分析</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/26.png"></p>
<blockquote>
<p>•市场部数据转发需求：</p>
<p>​    ▫只要边界-2路由器及其上联链路正常运行，市场部数据流就只会通过边界-2路由器进行数据转发。</p>
<p>​    ▫只要核心-2路由器及其上联链路正常运行，市场部数据流就只会通过核心-2路由器进行数据转发。</p>
<p>•本案例以分析财务部数据转发路径为例，市场部相关内容不再赘述。</p>
</blockquote>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/27.png"></p>
<blockquote>
<p>•第二类外部路由（Type2 External）：</p>
<p>​    ▫这类路由的可信度比较低，所以OSPF认为从ASBR到自治系统之外的开销远远大于在自治系统之内到达ASBR的开销。</p>
<p>​    ▫OSPF计算路由开销时只考虑ASBR到自治系统之外的开销，即到第二类外部路由的开销=ASBR到该路由目的地址的开销。</p>
</blockquote>
<h2 id="控制流量出口"><a href="#控制流量出口" class="headerlink" title="控制流量出口"></a>控制流量出口</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/28.png"></p>
<blockquote>
<p>•控制流量出口时，不考虑到达各ASBR的内部路径开销。</p>
</blockquote>
<h2 id="控制内部路径"><a href="#控制内部路径" class="headerlink" title="控制内部路径"></a>控制内部路径</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/29.png"></p>
<h2 id="控制内部路径：调整汇聚到核心开销"><a href="#控制内部路径：调整汇聚到核心开销" class="headerlink" title="控制内部路径：调整汇聚到核心开销"></a>控制内部路径：调整汇聚到核心开销</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/30.png"></p>
<h2 id="控制内部路径：调整核心到边界开销"><a href="#控制内部路径：调整核心到边界开销" class="headerlink" title="控制内部路径：调整核心到边界开销"></a>控制内部路径：调整核心到边界开销</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/31.png"></p>
<h2 id="OSPF路由控制案例主要配置-1"><a href="#OSPF路由控制案例主要配置-1" class="headerlink" title="OSPF路由控制案例主要配置 (1)"></a>OSPF路由控制案例主要配置 (1)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/32.png"></p>
<h2 id="OSPF路由控制案例主要配置-2"><a href="#OSPF路由控制案例主要配置-2" class="headerlink" title="OSPF路由控制案例主要配置 (2)"></a>OSPF路由控制案例主要配置 (2)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/33.png"></p>
<h2 id="OSPF路由控制案例主要配置-3"><a href="#OSPF路由控制案例主要配置-3" class="headerlink" title="OSPF路由控制案例主要配置 (3)"></a>OSPF路由控制案例主要配置 (3)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/34.png"></p>
<h1 id="3-OSPF其他特性"><a href="#3-OSPF其他特性" class="headerlink" title="3.OSPF其他特性"></a>3.OSPF其他特性</h1><h2 id="OSPF多进程"><a href="#OSPF多进程" class="headerlink" title="OSPF多进程"></a>OSPF多进程</h2><p>•OSPF支持多进程，在同一台路由器上可以运行多个不同的OSPF进程，它们之间互不影响，彼此独立。不同OSPF进程之间的路由交互相当于不同路由协议之间的路由交互。</p>
<p>•路由器的一个接口只能属于某一个OSPF进程。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/35.png"></p>
<blockquote>
<p>•VPN（Virtual Private Network）：虚拟专用网络。</p>
<p>•创建OSPF进程时，如果指定了VPN实例，那么OSPF进程属于此实例，否则属于全局实例。</p>
</blockquote>
<h2 id="OSPF与BGP联动-1"><a href="#OSPF与BGP联动-1" class="headerlink" title="OSPF与BGP联动 (1)"></a>OSPF与BGP联动 (1)</h2><p>当有新的设备加入到网络中，或者设备重启时，可能会出现在BGP收敛期间内网络流量丢失的现象。这是由于IGP收敛速度比BGP快而造成的。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/36.png"></p>
<h2 id="OSPF与BGP联动-2"><a href="#OSPF与BGP联动-2" class="headerlink" title="OSPF与BGP联动 (2)"></a>OSPF与BGP联动 (2)</h2><p>•通过使能OSPF与BGP联动特性，可以解决流量丢失问题。</p>
<p>•使能了OSPF与BGP联动特性的设备会在设定的联动时间内保持为Stub路由器，也就是说，该设备发布的LSA中的链路度量值为最大值（65535），从而告知其它OSPF设备不要使用这个路由器来转发数据。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/37.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>stub-router</strong> [ <strong>on-startup</strong> [ <em>interval</em> ] ]</p>
<ul>
<li><p><strong>on-startup</strong> [ <em>interval</em> ]：设备在发生重启或故障时保持为Stub路由器的时间间隔。整数形式，取值范围是5～65535，单位是s，缺省值是500s。</p>
<ul>
<li><p>如果未配置<strong>on-startup</strong>参数，则表示该设备始终保持为Stub路由器，即所有来自这个设备的路由条目Cost值均设为65535。</p>
</li>
<li><p>如果配置了<strong>on-startup</strong>参数，则表示该设备仅在重启或者故障时保持为Stub路由器，保持时间由<em>interval</em>参数决定。此时若未配置<em>interval</em>参数，则使用<em>interval</em>的缺省值500s。</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="OSPF转发地址"><a href="#OSPF转发地址" class="headerlink" title="OSPF转发地址"></a>OSPF转发地址</h2><p>FA（Forwarding Address，转发地址）：</p>
<ul>
<li><p>到达所通告的目的地的数据包应该被转发到的地址，如果转发地址为0.0.0.0，那么数据包将被转发到始发ASBR上。</p>
</li>
<li><p>Type5 AS-External-LSA 和 Type7 NSSA LSA：</p>
</li>
</ul>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/38.png"></p>
<h2 id="没有FA引发的问题"><a href="#没有FA引发的问题" class="headerlink" title="没有FA引发的问题"></a>没有FA引发的问题</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/39.png"></p>
<p>•R2、R3和R4运行OSPF，均部署在Area0中。其中R2和R3的GE0/0/1接口都激活OSPF并建立邻接关系，但是两者与外部路由器R1并不建立OSPF邻接关系。</p>
<p>​    1.R2配置到达10.1.1.1/32的静态路由，下一跳为10.1.123.1。</p>
<p>​    2.R2将静态路由引入OSPF，产生Type5 LSA在区域内泛洪。</p>
<p>​    3.R3接收到R2产生的5类LSA，计算出到达10.1.1.1/32的外部路由，并且将路由的下一跳指定为R2（10.1.123.2）。 </p>
<p>•OSPF域内的路由器如R4到达10.1.1.1/32的路径是：R4-R3-R2-R1，该路径是次优路径的。</p>
<h2 id="利用FA解决次优路径问题"><a href="#利用FA解决次优路径问题" class="headerlink" title="利用FA解决次优路径问题"></a>利用FA解决次优路径问题</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/40.png"></p>
<p>•R2向OSPF域内通告到达10.1.1.1/32的外部路由时，为对应的Type5 LSA设置FA，值为其自己到达该外部路由的下一跳：10.1.123.1。</p>
<p>•当R3收到该LSA后，计算到达10.1.1.1/32的路由时，发现FA为非0，因此它认为到达目标地址10.1.1.1/32的下一跳为FA所指定的地址，即：10.1.123.1。</p>
<h2 id="FA的取值"><a href="#FA的取值" class="headerlink" title="FA的取值"></a>FA的取值</h2><p>•当ASBR引入外部路由时，若Type5 LSA中的FA字段为0，表示路由器认为到达目的网段的数据包应该发往该ASBR；若Type5 LSA中的FA字段不为0，表示路由器认为到达目的网段的数据包应该发往这个FA所标识的设备。</p>
<p>•当以下条件全部满足时，FA字段才可以被设置为非0：</p>
<p>​    ▫ASBR在其连接外部网络的接口（外部路由的出接口）上激活了OSPF；</p>
<p>​    ▫该接口没有被配置为Silent-Interface；</p>
<p>​    ▫该接口的OSPF网络类型为Broadcast或NBMA；</p>
<p>​    ▫该接口的IP地址在OSPF配置的network命令指定的网段范围内。</p>
<p>•到达FA地址的路由必须是OSPF区域内部路由或区域间路由，这样接收到该外部LSA的路由器才能够加载该LSA进入路由表。加载的外部LSA生成的路由条目下一跳与到达FA地址的下一跳相同。</p>
<blockquote>
<p>•NSSA区域Type7 LSA转化为Type5 LSA：</p>
<p>​    ▫为了将NSSA区域引入的外部路由发布到其它区域，需要把Type7 LSA转化为Type5 LSA以便在整个OSPF网络中通告。缺省情况下，转换路由器是NSSA区域中Router ID最大的区域边界路由器（ABR）。</p>
<p>​    ▫LSA头部Options字段中的P-bit（Propagate bit）用于告知转化路由器该条Type7 LSA是否需要转化为Type5 LSA。只有P-bit置位并且FA不为0的Type7 LSA才能转化为Type5 LSA。</p>
<p>​    ▫区域边界路由器产生的Type7 LSA不会置位P-bit。(防环)</p>
<p>•注意：所有的OSPF LSA有相同的LSA头部，P-bit在LSA头部中的Options字段。</p>
</blockquote>
<h3 id="7类-LSA的FA取值"><a href="#7类-LSA的FA取值" class="headerlink" title="7类 LSA的FA取值"></a>7类 LSA的FA取值</h3><p>若满足以下条件，FA取值同5类LSA</p>
<ol>
<li>接口network</li>
<li>接口不是静默接口</li>
<li>接口的链路类型不是p2p或者是p2mp</li>
</ol>
<p>若不满足，FA取值先后顺序如下</p>
<ol>
<li>配置了loopback口，取loopback口中ip地址最大的作为FA地址</li>
<li>未配置loopback口，取物理接口中ip地址最大的作为FA地址</li>
</ol>
<p>（例如OSPF中router id 的选举）</p>
<h2 id="案例：NSSA场景下FA的典型应用"><a href="#案例：NSSA场景下FA的典型应用" class="headerlink" title="案例：NSSA场景下FA的典型应用"></a>案例：NSSA场景下FA的典型应用</h2><p>•当NSSA区域中有多个ABR时，系统会根据规则自动选择一个ABR作为转换器，将Type7 LSA转换为Type5 LSA，其他ABR不做LSA转换。</p>
<p>•如图所示，如果不考虑FA，由于R3的Router ID比R2大，因此它将执行7转5的动作，如此一来，R1将认为必须经由ABR（R3）到达目的网络。这样，流量便会被引导到低带宽链路，即R1-R3-R4-R5。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/41.png"></p>
<blockquote>
<p>•如图所示：</p>
<ul>
<li><p>R5引入直连外部路由，且将FA设为自己访问目的网段10.1.5.0/24的地址：10.1.45.5。</p>
</li>
<li><p>R3执行Type7 LSA转换Type5 LSA动作，继续携带FA：10.1.45.5。</p>
</li>
<li><p>R1收到后，会在自己的OSPF路由表中查询到达这个FA的路由，发现在OSPF路由表中能够找到匹配这个FA的路由，就使用到达这个FA的下一跳地址作为这条外部路由的下一跳地址。</p>
</li>
<li><p>因此，R1最终会通过R1-R2-R4-R5路径，访问目的网段10.1.5.0/24。</p>
</li>
</ul>
</blockquote>
<h1 id="4-IS-IS高级特性"><a href="#4-IS-IS高级特性" class="headerlink" title="4.IS-IS高级特性"></a>4.IS-IS高级特性</h1><h2 id="IS-IS快速收敛概述"><a href="#IS-IS快速收敛概述" class="headerlink" title="IS-IS快速收敛概述"></a>IS-IS快速收敛概述</h2><p>•IS-IS快速收敛是为了提高路由的收敛速度而做的扩展特性，包括：I-SPF（Incremental SPF，增量最短路径优先算法）、PRC、智能定时器、LSP快速扩散。</p>
<p>•同时，IS-IS支持故障恢复快速收敛，例如通过IS-IS Auto FRR实现备份链路的快速切换，也可以与BFD联动实现对故障的快速感知。</p>
<blockquote>
<p>•IS-IS的PRC、智能定时器、FRR等功能与OSPF类似，不再赘述。</p>
</blockquote>
<h2 id="I-SPF"><a href="#I-SPF" class="headerlink" title="I-SPF"></a>I-SPF</h2><p>I-SPF的工作原理：当网络拓扑改变的时候，只对受影响的节点进行路由计算，而不是对全部节点重新进行路由计算，从而加快了路由的计算。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/42.png"></p>
<blockquote>
<p>•使用SPF算法进行路由计算：当网络拓扑中有一个节点发生变化时，SPF算法需要重新计算网络中的所有节点，计算时间长，占用过多的CPU资源，影响整个网络的收敛速度。</p>
<p>•I-SPF改进了SPF算法，除了第一次SPF计算时需要计算全部节点外，之后每次都通过I-SPF计算受到影响的节点，而最后生成的最短路径树与原来的算法所计算的结果相同，大大降低了CPU的占用率，提高了网络收敛速度。</p>
<p>•在IS-IS网络中，I-SPF和PRC结合使用。</p>
<ul>
<li><p>如果I-SPF计算后的最短路径树改变，PRC会只处理那个变化的节点上的所有叶子（路由）。</p>
</li>
<li><p>如果经过I-SPF计算后的最短路径树并没有变化，则PRC只处理变化的叶子信息。比如一个节点使能一个IS-IS接口，则整个网络拓扑的最短路径树是不变的，这时PRC只更新这个节点的接口路由，从而节省CPU占用率。</p>
</li>
</ul>
</blockquote>
<h2 id="LSP快速扩散"><a href="#LSP快速扩散" class="headerlink" title="LSP快速扩散"></a>LSP快速扩散</h2><p>LSP快速扩散：此特性可以加快LSP的扩散速度。</p>
<p>▫正常情况下，当IS-IS路由器收到其它路由器发来的LSP时，如果此LSP比本地LSDB中相应的LSP要新，则更新LSDB中的LSP，并用一个定时器定期将LSDB内已更新的LSP扩散出去。</p>
<p>▫LSP快速扩散特性改进了这种方式，使能了此特性的设备收到一个或多个较新的LSP时，在路由计算之前，先将小于指定数目的LSP扩散出去，加快LSDB的同步过程。这种方式在很大程度上可以提高整个网络的收敛速度。</p>
<p>   配置LSP快速扩散</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/43.png"></p>
<p>注意：用户可以指定每次扩散的LSP数量，这个数量是针对所有IS-IS接口的。如果需要发送的LSP的数量大于这个数，则就发送<em>lsp-count</em>个LSP。如果配置了定时器，在路由计算之前如果这个定时器未超时，则立即扩散；否则在该定时器超时后发送。</p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>flash-flood</strong> [ <em>lsp-count</em> | <strong>max-timer-interval</strong> <em>interval</em> | [ <strong>level-1</strong> | <strong>level-2</strong> ] ]</p>
<p>​    ▫<em>lsp-count</em>：指定每个接口一次扩散LSP的最大数量。整数形式，取值范围是1～15。缺省值是5。</p>
<p>​    ▫<strong>max-timer-interval</strong> <em>interval</em>：指定LSP扩散的最大间隔时间。整数形式，取值范围是10～50000，单位是毫秒。缺省值是10毫秒。</p>
<p>​    ▫<strong>level-1</strong>：表示在Level-1中使能此特性。如果命令中没有指定级别，则缺省同时在Level-1和Level-2中使能此功能。</p>
<p>​    ▫<strong>level-2</strong>：表示在Level-2中使能此特性。如果命令中没有指定级别，则缺省同时在Level-1和Level-2中使能此功能。</p>
</blockquote>
<h2 id="IS-IS路由控制概述"><a href="#IS-IS路由控制概述" class="headerlink" title="IS-IS路由控制概述"></a>IS-IS路由控制概述</h2><p>在实际应用中，IS-IS根据SPF算法计算出来的路由有时并不能满足网络所需，可能出现如下弊端：如路由表中条目过多降低路由查找的速度、网络中链路利用率不均衡等，这些都不能很好地满足网络规划和流量管理的需要。为了达到优化IS-IS网络和便于流量管理的目的，需要对网络中的路由进行更加精确的控制。IS-IS的路由控制包括：</p>
<p>​    ▫调整IS-IS的优先级</p>
<p>​    ▫调整IS-IS的接口开销</p>
<p>​    ▫设置等价路由</p>
<p>​    ▫IS-IS路由渗透</p>
<p>​    ▫通告缺省路由</p>
<p>​    ▫引入外部路由</p>
<p>​    ▫Filter-Policy</p>
<blockquote>
<p>•本课程只介绍等价路由和缺省路由，其他内容请参考《HCIP-Datacom-Core Technology》课程。</p>
</blockquote>
<h2 id="等价路由-1"><a href="#等价路由-1" class="headerlink" title="等价路由"></a>等价路由</h2><p>当IS-IS网络中有多条冗余链路时，可能会出现多条等价路由，此时可以采取两种方式：</p>
<ul>
<li><p>配置负载分担。流量会被均匀的分配到每条链路上。</p>
<ul>
<li>该方式可以提高网络中链路的利用率及减少某些链路负担过重造成阻塞发生的情况。但是由于对流量转发具有一定的随机性，因此可能不利于对业务流量的管理。</li>
</ul>
</li>
<li><p>配置等价路由优先级。针对等价路由中的每一条路由，明确指定其优先级，优先级高的路由将被优选，优先级低的路由可以作为备用链路。</p>
<ul>
<li>当IS-IS网络中有多条冗余链路时，可能会出现多条等价路由，即达到某一目的网段有多条等开销路径。配置等价路由优先级可以在不修改原有配置的基础上，指定某条路由被优选，便于业务的管理，同时提高网络的可靠性。</li>
<li>注意：配置等价路由优先级后，IS-IS设备在转发到达目的网段的流量时，将不采用负载分担方式，而是将流量转发到优先级最高的下一跳。</li>
</ul>
</li>
</ul>
<h2 id="配置IS-IS对等价路由的处理方式"><a href="#配置IS-IS对等价路由的处理方式" class="headerlink" title="配置IS-IS对等价路由的处理方式"></a>配置IS-IS对等价路由的处理方式</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/44.png"></p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>maximum load-balancing</strong> <em>number</em></p>
<ul>
<li><em>number</em>：指定在负载分担方式下等价路由的最大数量。不同设备型号取值不同。</li>
</ul>
<p>•命令：[Huawei-isis-1] <strong>nexthop</strong> <em>ip-address</em> <strong>weight</strong> <em>value</em></p>
<ul>
<li><p><em>ip-address</em>：指定下一跳的IP地址。点分十进制格式。</p>
</li>
<li><p><strong>weight</strong> <em>value</em>：指定下一跳权重。<em>value</em>越小则优先级越高。<em>value</em>是整数形式，取值范围是1～254。</p>
</li>
</ul>
</blockquote>
<h2 id="等价路由配置举例-1"><a href="#等价路由配置举例-1" class="headerlink" title="等价路由配置举例 (1)"></a>等价路由配置举例 (1)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/45.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/46.png"></p>
<h2 id="等价路由配置举例-2"><a href="#等价路由配置举例-2" class="headerlink" title="等价路由配置举例 (2)"></a>等价路由配置举例 (2)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/47.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/48.png"></p>
<h2 id="缺省路由-1"><a href="#缺省路由-1" class="headerlink" title="缺省路由"></a>缺省路由</h2><p>•在IS-IS中，主要通过以下3种方式控制缺省路由的生成和发布。</p>
<p>​    ▫在Level-1-2设备上，控制其产生的Level-1 LSP中ATT位的置位情况。</p>
<p>​    ▫在Level-1设备上，通过配置使其即使收到ATT位置位的Level-1 LSP也不会自动产生缺省路由。</p>
<p>​    ▫在IS-IS中发布缺省路由。</p>
<p>•LSP的报文格式：</p>
<p>​    ▫ATT（Attachment）：由Level-1-2路由器产生，用来指明始发路由器是否与其它区域相连。此字段有4bit，华为数通产品只使用了其中1bit。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/49.png"></p>
<h2 id="通过设置ATT位控制缺省路由生成"><a href="#通过设置ATT位控制缺省路由生成" class="headerlink" title="通过设置ATT位控制缺省路由生成"></a>通过设置ATT位控制缺省路由生成</h2><p>•IS-IS规定，如果IS-IS Level-1-2设备根据LSDB判断通过Level-2区域比Level-1区域能够到达更多的区域，该设备会在所发布的Level-1 LSP内将ATT位置位。对于收到ATT位置位的LSP报文的Level-1设备，会生成一条目的地为发送该LSP的Level-1-2设备地址的缺省路由。</p>
<p>•以上是协议的默认原则，在实际应用中，可以根据需要对ATT比特位进行手动配置以更好地为网络服务。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/50.png"></p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>attached-bit advertise</strong> { <strong>always</strong> | <strong>never</strong> }</p>
<ul>
<li><p><strong>always</strong>：指定ATT位永远置位，收到该LSP的Level-1设备会生成缺省路由。</p>
</li>
<li><p><strong>never</strong>：指定ATT位永不置位，可以避免Level-1设备生成缺省路由，减小路由表的规模。</p>
</li>
</ul>
<p>•虽然ATT位同时在Level-1 LSP和Level-2 LSP中进行了定义，但是它只会在Level-1 LSP中被置位，并且只有Level-1-2设备会设置这个字段，因此，该命令仅对Level-1-2设备生效。</p>
<p>•配置Level-1设备不将缺省路由下发到路由表，有以下两种方式可以实现：</p>
<ul>
<li><p>在Level-1-2设备上配置<strong>attached-bit advertise never</strong>命令，使得其不会发布ATT位置位的LSP。</p>
</li>
<li><p>在与Level-1-2设备相连的Level-1设备上配置<strong>attached-bit avoid-learning</strong>命令。</p>
</li>
</ul>
<p>•其中，<strong>attached-bit avoid-learning</strong>命令适用于需要针对指定设备配置的情况。</p>
</blockquote>
<h2 id="IS-IS发布缺省路由"><a href="#IS-IS发布缺省路由" class="headerlink" title="IS-IS发布缺省路由"></a>IS-IS发布缺省路由</h2><p>•在具有外部路由的边界设备上配置IS-IS发布缺省路由可以使该设备在IS-IS路由域内发布一条0.0.0.0/0的缺省路由。在执行此配置后，IS-IS域内的其他设备在转发流量时，将所有去往外部路由域的流量首先转发到该设备，然后通过该设备去往外部路由域。</p>
<p>•通常，当网络中部署了IS-IS和其他路由协议时，为了实现IS-IS域内的流量可以到达IS-IS域外，通常有如下两种方式：</p>
<p>​    ▫在边界设备上配置IS-IS设备向IS-IS域发布缺省路由。该方式较为简单，不需要学习外部路由。</p>
<p>​    ▫在边界设备上将其他路由域的路由引入到IS-IS中。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/51.png"></p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>default-route-advertise</strong> [ <strong>always</strong> | <strong>match default</strong> | <strong>route-policy</strong> <em>route-policy-name</em> ] [ <strong>cost</strong> <em>cost</em> | <strong>tag</strong> <em>tag</em> | [ <strong>level-1</strong> | <strong>level-1-2</strong> | <strong>level-2</strong> ] ] [ <strong>avoid-learning</strong> ]</p>
<ul>
<li><p><strong>always</strong>：指定设备无条件的发布缺省路由，且发布的缺省路由中将自己作为下一跳。</p>
</li>
<li><p><strong>match default</strong>：如果在路由表中存在其他路由协议或其它IS-IS进程生成的缺省路由，则在LSP中发布该缺省路由。</p>
</li>
<li><p><strong>route-policy</strong> <em>route-policy-name</em>：指定路由策略名称。当该边界设备的路由表中存在满足路由策略的外部路由时，才向IS-IS域发布缺省路由，避免由于链路故障等原因造成该设备已经不存在某些重要的外部路由时，仍然发布缺省路由从而造成路由黑洞。此处的路由策略不影响IS-IS引入外部路由。字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
</li>
<li><p><strong>cost</strong> <em>cost</em>：指定缺省路由的开销值。整数形式。取值范围根据cost-style而定：当cost-style为narrow、narrow-compatible或compatible时，取值范围是0～63；当cost-style为wide或wide-compatible时，取值范围是0～4261412864。</p>
</li>
<li><p><strong>tag</strong> <em>tag</em>：指定发布的缺省路由的标记值。只有当IS-IS的开销类型为wide、wide-compatible或compatible时，发布的LSP中才会携带tag值。整数形式，取值范围为1～4294967295。</p>
</li>
<li><p><strong>level-1</strong>：指定发布的缺省路由级别为Level-1。如果不指定级别，则默认为生成Level-2级别的缺省路由。</p>
</li>
<li><p><strong>level-2</strong>：指定发布的缺省路由级别为Level-2。如果不指定级别，则默认为生成Level-2级别的缺省路由。</p>
</li>
<li><p><strong>level-1-2</strong>：指定发布的缺省路由级别为Level-1-2。如果不指定级别，则默认为生成Level-2级别的缺省路由。</p>
</li>
<li><p><strong>avoid-learning</strong>：避免IS-IS进程学到其他路由协议或其它IS-IS进程生成的缺省路由并添加到路由表。如果路由表中已存在学到的缺省路由为活跃状态，则将此路由置为不活跃状态。</p>
</li>
</ul>
<p>•配置该命令后，IS-IS域内所有去往外部的流量将首先会被转发到该设备来进行转发。相比于在每台设备上配置静态缺省路由，使用该命令可以简化操作，即只需在边界设备配置即可。此外，该命令是动态发布缺省路由，使用更加灵活，有多种发布缺省路由的方式可供选择。</p>
<p>•如果在Level-1设备上配置了该命令，那么该设备只会向Level-1区域发布缺省路由，不会将缺省路由发布到Level-2区域。</p>
</blockquote>
<h2 id="缺省路由配置举例"><a href="#缺省路由配置举例" class="headerlink" title="缺省路由配置举例"></a>缺省路由配置举例</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/52.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/53.png"></p>
<h2 id="IS-IS多实例和多进程"><a href="#IS-IS多实例和多进程" class="headerlink" title="IS-IS多实例和多进程"></a>IS-IS多实例和多进程</h2><p>•IS-IS多实例是指在同一台路由器上，可以配置多个VPN实例与多个IS-IS进程相关联。</p>
<p>•IS-IS多进程指在同一个VPN下（或者同在公网下）可以创建多个IS-IS进程，每个进程之间互不影响，彼此独立。不同进程之间的路由交互相当于不同路由协议之间的路由交互。</p>
<p>•网络中可能需要同时承载不同的业务，为保证各业务的安全性，需要将业务进行隔离，此时，可以配置与VPN实例绑定。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/54.png"></p>
<blockquote>
<p>•IS-IS多实例和多进程的特点如下：</p>
<ul>
<li><p>IS-IS多进程共用同一个全局路由表。而IS-IS多实例使用VPN中的路由表，并且每个VPN都有自己单独的路由表。</p>
</li>
<li><p>IS-IS多进程允许为一个指定的IS-IS进程关联一组接口，从而保证该进程进行的所有协议操作都仅限于这一组接口。这样，就可以实现一台路由器有多个IS-IS协议进程，每个进程负责唯一的一组接口。</p>
</li>
<li><p>IS-IS进程在创建时可以选择绑定一个VPN实例，于是这个IS-IS进程就与此VPN实例相关联，并且只接收和处理此VPN实例内的事件。当VPN实例删除时，IS-IS进程也会跟着被删除。</p>
</li>
</ul>
<p>•命令：[Huawei] <strong>isis</strong> [ <em>process-id</em> ] [ <strong>vpn-instance</strong> <em>vpn-instance-name</em> ]</p>
<ul>
<li><p><em>process-id</em>：指定IS-IS进程号。如果不指定进程，则启动进程号为1的IS-IS进程。整数形式，取值范围是1～65535。缺省值是1。</p>
</li>
<li><p><strong>vpn-instance</strong> <em>vpn-instance-name</em>：指定VPN实例名。如果不指定此参数，则就不会配置VPN实例与相应的IS-IS进程相关联。字符串形式，区分大小写，不支持空格，长度范围是1～31。当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
</li>
</ul>
</blockquote>
<h2 id="LSP分片"><a href="#LSP分片" class="headerlink" title="LSP分片"></a>LSP分片</h2><p>•当IS-IS要发布的PDU中信息量太大时，IS-IS路由器将会生成多个LSP分片，用来携带更多的IS-IS信息。</p>
<p>•LSP的报文格式为：</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/55.png"></p>
<p>•IS-IS LSP分片由LSP ID中的分片号（LSP Number）字段进行标识，这个字段的长度是1Byte。因此，一个IS-IS进程最多可产生256个LSP分片，携带的信息量有限。</p>
<h2 id="LSP分片扩展基本概念"><a href="#LSP分片扩展基本概念" class="headerlink" title="LSP分片扩展基本概念"></a>LSP分片扩展基本概念</h2><p>•IS-IS可以配置虚拟的系统ID ，并生成虚拟IS-IS的LSP报文来携带路由等信息。</p>
<ul>
<li><p>初始系统（Originating System）：初始系统是实际运行IS-IS的路由器。允许一个单独的IS-IS进程像多个虚拟路由器一样发布LSP，而“Originating System”指的是那个“真正”的IS-IS进程。</p>
</li>
<li><p>系统ID（Normal System-ID）：初始系统的系统ID。</p>
</li>
<li><p>虚拟系统（Virtual System）：由附加系统ID标识的系统，生成扩展LSP分片。这些分片在其LSP ID中携带附加系统ID。</p>
</li>
<li><p>附加系统ID（Additional System-ID）：虚拟系统的系统ID，由网络管理器统一分配。每个附加系统ID都允许生成256个扩展的LSP分片。</p>
</li>
<li><p>24号TLV（IS Alias ID TLV）：LSP分片携带该TLV信息，用来表示初始系统与虚拟系统的关系。</p>
</li>
</ul>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/56.png"></p>
<p>•使能分片扩展功能之后，如果存在由于报文装满而丢失的信息，系统会提醒重启IS-IS。重启之后，初始系统会尽最大能力装载路由信息，装不下的信息将放入虚拟系统的LSP中发送出去，并通过24号TLV来告知其他路由器此虚拟系统和自己的关系。</p>
<blockquote>
<p>•附加系统ID和系统ID都必须在整个路由域中唯一。</p>
</blockquote>
<h2 id="LSP分片扩展工作原理"><a href="#LSP分片扩展工作原理" class="headerlink" title="LSP分片扩展工作原理"></a>LSP分片扩展工作原理</h2><p>•在IS-IS中，每个系统ID都标识一个系统，每个系统都最多可生成256个LSP分片。通过增加附加系统ID，可以最多配置50个虚拟系统，从而使得IS-IS进程最多可生成13056个LSP分片。</p>
<p>•IS-IS路由器可以在两种模式下运行LSP分片扩展特性：</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/57.png"></p>
<blockquote>
<p>•Mode-1工作原理：</p>
<ul>
<li>虚拟系统参与路由SPF计算，初始系统发布的LSP中携带了到每个虚拟系统的链路信息。类似地，虚拟系统发布的LSP也包含到初始系统的链路信息。这样，在网络中虚拟系统看起来与初始系统相连的真实路由器是一样的。</li>
<li>这种方式是为了兼容不支持分片扩展的老版本所做的一个过渡模式。在老版本中，IS-IS无法识别24号TLV，所以虚拟系统的LSP必须表现的像一个普通IS-IS发出的报文。</li>
<li>注意事项：<ul>
<li>虚拟系统的LSP中包含和原LSP中相同的区域地址和过载标志位。如果还有其它特性的TLV，也必须保持一致。</li>
<li>虚拟系统的邻居信息指向初始系统，metric为最大值减1；初始系统的邻居信息指向虚拟系统，metric必须为0。这样就保证了其它路由器在进行路由计算的时候，虚拟系统一定会成为初始系统的下游节点。</li>
</ul>
</li>
</ul>
<p>•Mode-2工作原理：</p>
<ul>
<li><p>虚拟系统不参与路由SPF计算，网络中所有路由器都知道虚拟系统生成的LSP实际属于初始系统。</p>
</li>
<li><p>在该模式下工作的IS-IS，可以识别24号TLV的内容，并作为计算树和路由的依据。</p>
</li>
</ul>
<p>•注意：无论在哪种方式下，初始系统和虚拟系统的LSP零分片中，都必须包含IS Alias ID TLV来表示初始系统是谁。</p>
</blockquote>
<h2 id="LSP分片扩展的基本配置命令"><a href="#LSP分片扩展的基本配置命令" class="headerlink" title="LSP分片扩展的基本配置命令"></a>LSP分片扩展的基本配置命令</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/58.png"></p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>lsp-fragments-extend</strong> [ [ <strong>level-1</strong> | <strong>level-2</strong> | <strong>level-1-2</strong> ] | [ <strong>mode-1</strong> | <strong>mode-2</strong> ] ] </p>
<p>​    ▫<strong>level-1</strong>：指定在Level-1级别使能分片扩展。</p>
<p>​    ▫<strong>level-2</strong>：指定在Level-2级别使能分片扩展。</p>
<p>​    ▫<strong>level-1-2</strong>：指定在Level-1-2级别使能分片扩展。</p>
<p>​    ▫<strong>mode-1</strong>：该模式可以兼容以前老版本不支持LSP分片扩展特性的情况。</p>
<p>​    ▫<strong>mode-2</strong>：该模式要求所有路由器都支持LSP分片扩展特性。</p>
<p>•命令：[Huawei-isis-1] <strong>virtual-system</strong> <em>virtual-system-id</em> </p>
<p>​    ▫<em>virtual-system-id</em>：指定IS-IS进程的虚拟系统ID。长度是6字节（48比特），格式是XXXX.XXXX.XXXX。</p>
</blockquote>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）OSPF有哪些快速收敛机制？(   )</p>
<p>A.I-SPF</p>
<p>B.LSP快速扩散</p>
<p><strong>C.智能定时器</strong></p>
<p><strong>D.OSPF IP FRR</strong></p>
<p>2.（判断题）OSPF的Type5 LSA中FA字段一定为0.0.0.0。(   )</p>
<p>A.正确</p>
<p><strong>B.错误</strong></p>
<p>3.（判断题）在IS-IS网络中，若设备运行Mode-2的LSP分片扩展，则虚拟系统不参与路由SPF计算，网络中所有路由器都知道虚拟系统生成的LSP实际属于初始系统。(   )</p>
<p><strong>A.正确</strong></p>
<p>B.错误</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•为了更好的适应网络拓扑的变化，OSPF和IS-IS支持多种快速收敛方式。通过I-SPF和PRC算法加速路由的计算，通过FRR可以实现备份链路的快速切换，还可以设置智能定时器控制链路状态信息的生成和路由计算的速度。</p>
<p>•为了控制路由表的规模以及提高网络性能，OSPF和IS-IS支持路由信息的过滤，支持等价路由，还支持下发缺省路由。</p>
<p>•为了实现协议路由表隔离，OSPF和IS-IS支持在同一台设备上部署多进程，进程之间的协议路由表互不影响。</p>
<p>•为了避免在外部路由引入时出现次优路径，OSPF通过Type5 LSA或Type7 LSA中的FA指导数据包转发。</p>
<p>•IS-IS为了能够携带更多的路由信息，支持LSP分片扩展。</p>
<p>•OSPF和IS-IS对以上各种特性的支持，使它们在现网中都被广泛灵活应用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/mydog.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">75</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">77</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zsy9959" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zsy9959@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张思宇</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
