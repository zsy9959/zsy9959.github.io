<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="my blog">
<meta property="og:type" content="website">
<meta property="og:title" content="zsy&#39;s blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="zsy&#39;s blog">
<meta property="og:description" content="my blog">
<meta property="og:locale">
<meta property="article:author" content="张思宇">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/page/2/"/>





  <title>zsy's blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zsy's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">just simple</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/home" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/" itemprop="url">IPadv-MPLSVPN部署与应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T15:17:09+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•BGP/MPLS IP VPN因其支持地址空间重叠、组网方式灵活、可扩展性好，并能够方便地支持MPLS TE等一系列优点，已经在广域IP承载网络得到了广泛的应用。</p>
<p>•针对不同客户的业务需求以及组网情况，MPLS VPN的部署方式不尽相同。</p>
<p>•本课程将介绍几种常见的MPLS VPN应用场景与这些场景下MPLS VPN的部署方法，此外还将介绍OSPF对MPLS VPN的扩展特性与功能。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述MPLS VPN的应用场景与组网类型</p>
<p>▫部署MPLS VPN的Intranet方案</p>
<p>▫部署MPLS VPN的Hub&amp;Spoke方案</p>
<p>▫描述OSPF对MPLS VPN扩展功能与特性</p>
<h1 id="1-MPLS-VPN应用与组网概述"><a href="#1-MPLS-VPN应用与组网概述" class="headerlink" title="1.MPLS VPN应用与组网概述"></a>1.MPLS VPN应用与组网概述</h1><h2 id="MPLS-VPN典型应用"><a href="#MPLS-VPN典型应用" class="headerlink" title="MPLS VPN典型应用"></a>MPLS VPN典型应用</h2><p>•目前，MPLS VPN的主要应用包括企业互连和虚拟业务网络。</p>
<p>▫企业互连应用：可通过MPLS VPN将分布在各地的分支机构、出差员工和合作伙伴的IP网络连接在一起；</p>
<p>▫虚拟业务网络：可在同一物理网络上运行多种业务，如VoIP、IPTV等，为每个业务建立一个VPN，实现业务隔离。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/1.png"></p>
<blockquote>
<p>•MPLS VPN的主要优点包括但不限于以下几项：</p>
<ul>
<li>可以实现“一点接入，全网连通”，支持异种介质的互连。而不像传统专线那样在每一对用户设备间采用同样的介质连接，可方便地提供普遍服务。</li>
<li>可以实现“弹性带宽”，采用流量监管技术，在保证用户基本带宽的同时，对突发流量尽力而为，同时基本带宽也可以“软扩容”，即根据用户的需求在一个范围内连续选择。</li>
<li>在资源隔离或隧道绑定的MPLS VPN技术保证下，充分保证每个VPN的专有带宽，满足各类业务有不同的用户，不同的流量模型，不同的QoS要求。</li>
</ul>
</blockquote>
<h2 id="MPLS-VPN基本组网-Intranet"><a href="#MPLS-VPN基本组网-Intranet" class="headerlink" title="MPLS VPN基本组网 - Intranet"></a>MPLS VPN基本组网 - Intranet</h2><p>当采用Intranet组网方案时，一个VPN中的所有用户形成闭合用户群，相互之间能够进行流量转发，VPN中的用户不能与任何本VPN以外的用户通信，其站点通常是属于同一个组织。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/2.png"></p>
<h2 id="MPLS-VPN基本组网-Extranet"><a href="#MPLS-VPN基本组网-Extranet" class="headerlink" title="MPLS VPN基本组网 - Extranet"></a>MPLS VPN基本组网 - Extranet</h2><p>当采用Extranet组网方案时，VPN用户可将部分站点中的网络资源给其他VPN用户进行访问。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/3.png"></p>
<h2 id="MPLS-VPN基本组网-Hub-amp-Spoke-1"><a href="#MPLS-VPN基本组网-Hub-amp-Spoke-1" class="headerlink" title="MPLS VPN基本组网 - Hub&amp;Spoke (1)"></a>MPLS VPN基本组网 - Hub&amp;Spoke (1)</h2><p>当采用Hub&amp;Spoke方案时，可以将多个站点中的一个站点设置为Hub站点，其余站点为Spoke站点。站点间的互访必须通过Hub站点，通过Hub站点集中管控站点间的数据传输。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/4.png"></p>
<h2 id="MPLS-VPN基本组网-Hub-amp-Spoke-2"><a href="#MPLS-VPN基本组网-Hub-amp-Spoke-2" class="headerlink" title="MPLS VPN基本组网 - Hub&amp;Spoke (2)"></a>MPLS VPN基本组网 - Hub&amp;Spoke (2)</h2><p>从Site1到Site2的路由发布过程如下：</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/5.png"></p>
<h2 id="MCE组网"><a href="#MCE组网" class="headerlink" title="MCE组网"></a>MCE组网</h2><p>•当一个私网需要根据业务或者网络划分VPN时，不同VPN用户间的业务需要完全隔离。此时，为每个VPN单独配置一台CE将增加用户的设备开支和维护成本。</p>
<p>•具有MCE（Multi-VPN-Instance，CE多实例CE）功能的CE设备可以在MPLS VPN组网应用中承担多个VPN实例的CE功能，减少用户网络设备的投入。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/6.png"></p>
<h2 id="MPLS-VPN跨域组网"><a href="#MPLS-VPN跨域组网" class="headerlink" title="MPLS VPN跨域组网"></a>MPLS VPN跨域组网</h2><p>•随着MPLS VPN解决方案的广泛应用，服务的终端用户的规格和范围也在增长，在一个企业内部的站点数目越来越大，某个地理位置与另外一个服务提供商相连的需求变得非常的普遍，例如国内运营商的不同城域网之间，或相互协作的运营商的骨干网之间都存在着跨越不同自治系统（AS，Autonomous System）的情况。</p>
<p>•一般的MPLS VPN体系结构都是在一个AS内运行，任何VPN的路由信息都是只能在一个AS内按需扩散。AS之间的MPLS VPN部署需要通过跨域（Inter-AS） MPLS VPN解决方案来实现。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/7.png"></p>
<blockquote>
<p>•RFC2547中提出了三种跨域VPN解决方案，分别是：</p>
<ul>
<li>跨域VPN-OptionA（Inter-Provider Backbones Option A）方式：需要跨域的VPN在ASBR（AS Boundary Router）间通过专用的接口管理自己的VPN路由，也称为VRF-to-VRF；</li>
<li>跨域VPN-OptionB（Inter-Provider Backbones Option B）方式：ASBR间通过MP-EBGP发布标签VPN-IPv4路由，也称为EBGP redistribution of labeled VPN-IPv4 routes；</li>
<li>跨域VPN-OptionC（Inter-Provider Backbones Option C）方式：PE间通过Multi-hop MP-EBGP发布标签VPN-IPv4路由，也称为Multihop EBGP redistribution of labeled VPN-IPv4 routes。</li>
</ul>
<p>•更多跨域MPLS VPN相关内容，请参考HCIE-Datacom相关课程。</p>
</blockquote>
<h1 id="2-MPLS-VPN典型场景部署介绍"><a href="#2-MPLS-VPN典型场景部署介绍" class="headerlink" title="2.MPLS VPN典型场景部署介绍"></a>2.MPLS VPN典型场景部署介绍</h1><h2 id="Intranet场景"><a href="#Intranet场景" class="headerlink" title="Intranet场景"></a>Intranet场景</h2><h3 id="部署Intranet场景的MPLS-VPN"><a href="#部署Intranet场景的MPLS-VPN" class="headerlink" title="部署Intranet场景的MPLS VPN"></a>部署Intranet场景的MPLS VPN</h3><p>•如图所示，客户X及Y各自有2个站点，现需要通过MPLS VPN实现站点之间的互联，分别对应VPNX和VPNY；</p>
<p>•互联接口、AS号及IP地址信息，CE与PE通过如图的协议或方法交换路由信息；</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/8.png"></p>
<blockquote>
<p>•注：本课程仅讨论非跨域的MPLS VPN部署场景。</p>
</blockquote>
<h3 id="部署思路"><a href="#部署思路" class="headerlink" title="部署思路"></a>部署思路</h3><p>1.MPLS VPN骨干网配置</p>
<p>1.1 IGP配置，实现骨干网的IP连通性。</p>
<p>1.2 MPLS与MPLS LDP配置，建立MPLS LSP公网隧道，传输VPN数据。</p>
<p>1.3 MP-BGP配置，建立后续传递VPNv4路由的MP-BGP对等体关系。</p>
<p>2.VPN用户接入配置</p>
<p>2.1 创建VPN实例并配置参数（RT、RD）</p>
<p>2.2 将接口加入VPN实例</p>
<p><strong>2.3</strong> <strong>配置PE与CE之间的路由交换</strong></p>
<h3 id="PE-CE之间部署OSPF-1"><a href="#PE-CE之间部署OSPF-1" class="headerlink" title="PE-CE之间部署OSPF (1)"></a>PE-CE之间部署OSPF (1)</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/9.png"></p>
<h3 id="PE-CE之间部署OSPF-2"><a href="#PE-CE之间部署OSPF-2" class="headerlink" title="PE-CE之间部署OSPF (2)"></a>PE-CE之间部署OSPF (2)</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/10.png"></p>
<h3 id="PE-CE之间部署静态路由"><a href="#PE-CE之间部署静态路由" class="headerlink" title="PE-CE之间部署静态路由"></a>PE-CE之间部署静态路由</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/11.png"></p>
<h3 id="PE-CE之间部署EBGP"><a href="#PE-CE之间部署EBGP" class="headerlink" title="PE-CE之间部署EBGP"></a>PE-CE之间部署EBGP</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/12.png"></p>
<h3 id="特殊场景下的BGP配置-AS号替换"><a href="#特殊场景下的BGP配置-AS号替换" class="headerlink" title="特殊场景下的BGP配置 - AS号替换"></a>特殊场景下的BGP配置 - AS号替换</h3><p>在MPLS VPN场景中，若PE与CE之间运行EBGP交互路由信息，则可能会出现两个站点的AS号相同的情况。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/13.png"></p>
<h3 id="特殊场景下的BGP配置-SoO"><a href="#特殊场景下的BGP配置-SoO" class="headerlink" title="特殊场景下的BGP配置 - SoO"></a>特殊场景下的BGP配置 - SoO</h3><p>•在CE多归属场景，若使能了BGP的AS号替换功能，可能会引起路由环路，需要SoO（Site of Origin）特性来避免环路。</p>
<ul>
<li><p>CE1与CE3处于同一个VPN站点1，CE2位于站点Site2，Site1和Site2站点所在的AS号都为65001。PE与CE之间运行的都是EBGP路由协议，为了Site 1和Site 2之间的路由可以正常学习，需要在PE1和PE2上配置AS号替换功能。</p>
</li>
<li><p>CE1传递站点内的路由给PE1，PE1传递该路由给CE3，由于配置AS号替换，CE3会接收该路由，可能会导致产生路由环路。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/14.png"></p>
<blockquote>
<p>•注：192.168.100.1和192.168.200.1分别是CE1和CE3上和PE1建立BGP对等体的接口地址。</p>
</blockquote>
<h3 id="PE-CE之间部署IS-IS"><a href="#PE-CE之间部署IS-IS" class="headerlink" title="PE-CE之间部署IS-IS"></a>PE-CE之间部署IS-IS</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/15.png"></p>
<h2 id="Hub-amp-Spoke场景"><a href="#Hub-amp-Spoke场景" class="headerlink" title="Hub&amp;Spoke场景"></a>Hub&amp;Spoke场景</h2><h3 id="部署Hub-amp-Spoke场景的MPLS-VPN"><a href="#部署Hub-amp-Spoke场景的MPLS-VPN" class="headerlink" title="部署Hub&amp;Spoke场景的MPLS VPN"></a>部署Hub&amp;Spoke场景的MPLS VPN</h3><p>•Hub&amp;Spoke有以下组网方案：</p>
<p>​    ▫方式一：Hub-CE与Hub-PE，Spoke-PE与Spoke-CE使用EBGP</p>
<p>​    ▫方式二：Hub-CE与Hub-PE，Spoke-PE与Spoke-CE使用IGP</p>
<p>​    ▫方式三：Hub-CE与Hub-PE使用EBGP，Spoke-PE与Spoke-CE使用IGP</p>
<p>•<strong>无法</strong>通过Hub-CE与Hub-PE使用IGP，Spoke-PE与Spoke-CE使用EBGP来部署Hub&amp;Spoke组网的MPLS VPN。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/16.png"></p>
<h3 id="VRF配置"><a href="#VRF配置" class="headerlink" title="VRF配置"></a>VRF配置</h3><p>•Spoke-PE上创建一个VPN实例，RT配置如图。</p>
<p>•Hub-PE上创建VPN_in和VPN_out两个VPN实例，分别用于从Spoke-PE接收私网路由或向Spoke-PE发布私网路由，RT配置如图。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/17.png"></p>
<h3 id="方式一部署-路由发布过程"><a href="#方式一部署-路由发布过程" class="headerlink" title="方式一部署 - 路由发布过程"></a>方式一部署 - 路由发布过程</h3><p>•Spoke-CE与Spoke-PE之间通过EBGP交互路由信息，建立EBGP连接后，把相关的路由发布到BGP即可。</p>
<p>•Hub-PE与Hub-CE之间建立两条EBGP连接，分别用来发布和接收私网路由。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/18.png"></p>
<blockquote>
<p>•以路由从Spoke-CE1发布到Spoke-CE2为例，大体过程如下：</p>
<p>1.Spoke-CE1通过EBGP将路由发布给Spoke-PE1。</p>
<p>2.Spoke-PE1通过IBGP将该路由发布给Hub-PE。</p>
<p>3.Hub-PE通过VPN实例（VPN_in）的Import Target属性将该路由引入VPN_in路由表，并通过EBGP发布给Hub-CE。</p>
<p>4.Hub-CE通过EBGP连接学习到该路由，并通过另一个EBGP连接将该路由发布给Hub-PE的VPN实例（VPN_out）。</p>
<p>5.Hub-PE发布携带VPN_out的Export Target属性的路由给所有Spoke-PE。</p>
<p>6.Spoke-PE2通过EBGP将该路由发布给Spoke-CE2。</p>
</blockquote>
<h3 id="方式一部署-Hub-PE与Hub-CE间配置"><a href="#方式一部署-Hub-PE与Hub-CE间配置" class="headerlink" title="方式一部署 - Hub-PE与Hub-CE间配置"></a>方式一部署 - Hub-PE与Hub-CE间配置</h3><p>•Hub-PE通过VPN_in对应的EBGP连接将从Spoke站点学习的路由发布到Hub站点。</p>
<p>•Hub-CE通过VPN_out对应的EBGP将这些路由发布到Spoke站点。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/19.png"></p>
<h3 id="方式二部署-路由发布过程"><a href="#方式二部署-路由发布过程" class="headerlink" title="方式二部署 - 路由发布过程"></a>方式二部署 - 路由发布过程</h3><p>•以选用OSPF作为IGP协议为例：</p>
<p>▫Spoke-CE与Spoke-PE之间通过OSPF（进程100）邻居关系交互路由信息。</p>
<p>▫Hub-PE通过两个OSPF进程与Hub-CE建立OSPF邻居，分别负责私网路由的发送和接收。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/20.png"></p>
<blockquote>
<p>•以路由从Spoke-CE1发布到Spoke-CE2为例，大体过程如下：</p>
<p>1.Spoke-CE1通过OSPF100将路由发布给Spoke-PE1。</p>
<p>2.Spoke-PE1通过IBGP将路由发布给Hub-PE。</p>
<p>3.Hub-PE通过VPN实例（VPN_in）的Import Target属性将该路由引入VPN_in路由表；通过将BGP引入OSPF100的配置进而将从Spoke-PE1传递来的路由发布给Hub-CE。</p>
<p>4.Hub-CE通过OSPF100接收该路由；并通过配置路由引入将路由发布到OSPF200，OSPF200再将路由发布给Hub-PE。</p>
<p>5.Hub-PE的BGP-VPN实例（VPN_out）引入OSPF200多实例的路由，将携带Export Target属性的路由发布给所有Spoke-PE。</p>
<p>6.Spoke-PE2通过OSPF100将该路由发布给Spoke-CE2。</p>
</blockquote>
<h3 id="方式二部署-Hub-PE与Hub-CE间配置"><a href="#方式二部署-Hub-PE与Hub-CE间配置" class="headerlink" title="方式二部署 - Hub-PE与Hub-CE间配置"></a>方式二部署 - Hub-PE与Hub-CE间配置</h3><p>•Hub-PE通过VPN_in对应的OSPF（进程100）将从Spoke站点学习的路由发布到Hub站点。</p>
<p>•Hub-CE通过VPN_out对应的OSPF（进程200）将这些路由发布到Hub-PE，进而发布给所有Spoke站点。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/21.png"></p>
<h3 id="方式三部署-路由发布过程"><a href="#方式三部署-路由发布过程" class="headerlink" title="方式三部署 - 路由发布过程"></a>方式三部署 - 路由发布过程</h3><p>•以选用OSPF作为IGP协议为例，Spoke-CE与Spoke-PE之间通过OSPF（进程100）邻居关系交互路由信息。</p>
<p>•Hub-PE与Hub-CE之间建立两条EBGP连接，分别用来发布和接收私网路由，Hub-PE与Hub-CE的配置与方式一相同。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/22.png"></p>
<blockquote>
<p>•以路由从Spoke-CE1发布到Spoke-CE2为例，大体过程如下：</p>
<p>1.Spoke-CE1通过OSPF100将路由发布给Spoke-PE1。</p>
<p>2.Spoke-PE1通过IBGP将路由发布给Hub-PE。</p>
<p>3.Hub-PE通过VPN实例（VPN_in）的Import Target属性将该路由引入VPN_in路由表，并通过EBGP发布给Hub-CE。</p>
<p>4.Hub-CE通过EBGP连接学习到该路由，并通过另一个EBGP连接将该路由发布给Hub-PE的VPN实例（VPN_out）。</p>
<p>5.Hub-PE发布携带VPN_out的Export Target属性的路由给Spoke-PE2。</p>
<p>6.Spoke-PE2通过OSPF100将该路由发布给Spoke-CE2。</p>
</blockquote>
<h3 id="为什么没有方式四？"><a href="#为什么没有方式四？" class="headerlink" title="为什么没有方式四？"></a>为什么没有方式四？</h3><p>•<strong>无法</strong>通过Hub-CE与Hub-PE使用IGP，Spoke-PE与Spoke-CE使用EBGP来部署Hub&amp;Spoke组网的MPLS VPN</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/23.png"></p>
<blockquote>
<p>•以从Spoke-CE1向Spoke-CE2发布路由（目的地址为192.168.1.0/24）为例，大体过程如下：</p>
<p>1.Spoke-CE1通过EBGP将路由发布给Spoke-PE1。</p>
<p>2.Spoke-PE1通过IBGP将路由发布给Hub-PE。</p>
<p>3.Hub-PE通过BGP-VPN实例（VPN_in）的Import Target属性将该路由引入VPN_in路由表；并通过OSPF100多实例发布给Hub-CE。</p>
<p>4.Hub-CE通过OSPF100学习到该路由；并通过OSPF200将路由发布给Hub-PE。</p>
<p>5.Hub-PE的BGP-VPN实例（VPN_out）引入OSPF200多实例路由，并将携带VPN_out的Export Target属性的路由发布给所有Spoke-PE。</p>
<p>6.Spoke-PE2的VPN实例根据Import Target属性引入该路由；Spoke-PE2通过EBGP发布给本地Spoke-CE2。</p>
<p>•Hub-PE的BGP-VPN实例（VPN_out）通过Export Target属性将路由发布给Spoke-PE2的同时，也会将该路由发布给Spoke-PE1。此时，这条路由是Hub-PE通过IGP（OSPF200多实例）引入的，由于IGP路由不携带AS-PATH属性，AS_Path为空；而原来从Spoke-CE1来的192.168.1.0/24路由，其AS_Path不为空，所以从Hub-PE返回的路由会优于从Spoke-CE1来的路由。这样会引起路由振荡，其过程如下：</p>
<p>1.Spoke-CE1发来的路由因为AS_Path变成非最佳路由</p>
<p>2.Spoke-PE1发布Update撤销路由的报文给Hub-PE来撤销192.168.1.0/24路由</p>
<p>3.Hub-PE（通过撤销相应的OSPF LSA）撤销发给Hub-CE的路由</p>
<p>4.Hub-CE（原理同上）撤销发给Hub-PE的路由</p>
<p>5.Hub-PE发布Update撤销路由撤销发给Spoke-PE1的路由</p>
<p>•于是在Spoke-PE1上从Spoke-CE1来的路由又变成最佳路由。Spoke-PE1又通过IBGP将路由发布给Hub-PE。Hub-PE又会返回该路由，从Spoke-CE1来的路由又变成非最佳路由。如此反复。</p>
</blockquote>
<h1 id="3-OSPF-VPN拓展"><a href="#3-OSPF-VPN拓展" class="headerlink" title="3.OSPF VPN拓展"></a>3.OSPF VPN拓展</h1><h2 id="OSPF与BGP互操作"><a href="#OSPF与BGP互操作" class="headerlink" title="OSPF与BGP互操作"></a>OSPF与BGP互操作</h2><h3 id="MPLS-VPN中的OSPF-BGP"><a href="#MPLS-VPN中的OSPF-BGP" class="headerlink" title="MPLS VPN中的OSPF/BGP"></a>MPLS VPN中的OSPF/BGP</h3><p>•当PE-CE间部署OSPF交互路由信息时，若在PE上使用标准BGP/OSPF过程（简称为BGP/OSPF互操作）互来传递路由信息，则远端PE在将BGP引入VPN实例的OSPF进程时，会直接产生Type5 LSA，不同站点都会将其他站点的路由视为自治系统外部路由（AS_external）。</p>
<p>•为了解决标准BGP/OSPF的互操作导致的OSPF路由信息丢失的问题，BGP和OSPF都做了相应的拓展。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/24.png"></p>
<blockquote>
<p>•在实际应用中，如果两个要互通的Site都在相同的AS内，那么每个Site都应该将另一个Site的路由看成区域间路由，而不是AS外部路由。</p>
</blockquote>
<h3 id="BGP扩展团体属性"><a href="#BGP扩展团体属性" class="headerlink" title="BGP扩展团体属性"></a>BGP扩展团体属性</h3><p>•为了保留OSPF的路由信息，BGP新增了部分可携带OSPF路由信息的团体属性：</p>
<ul>
<li><p>Domain ID：域标识符用来标识和区分不同的域。</p>
</li>
<li><p>Route Type：包含被引入到BGP的OSPF路由的 Area-ID 以及Route Type</p>
<ul>
<li>Area-ID：PE 的VPN实例的OSPF进程与CE建立邻接关系的区域号</li>
<li>Route Type：被引入的 OSPF 路由的类型<ul>
<li>1 或 2：表示路由的类型为区域内部路由， 也就是 PE 根据 Type-1 及 Type-2 LSA 所计算出来的路由。</li>
<li>3：表示路由的类型为区域间路由。</li>
<li>5：表示路由的类型为 OSPF 外部路由，也就是 PE 通过 Type-5 LSA 计算得出的路由。当 Route-Type 字段的值为 5 时， Area-ID 字段的值需为 0.0.0.0。</li>
<li>7：表示路由的类型为 NSSA 路由，也就是 PE 通过 Type-7 LSA 计算得出的路由。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Domain-ID"><a href="#Domain-ID" class="headerlink" title="Domain ID"></a>Domain ID</h3><p>•在PE上将OSPF引入BGP时，PE将根据本地的配置为BGP路由增加域ID属性，域ID作为BGP的扩展团体属性传播。</p>
<p>•在PE将BGP路由引入OSPF时，若BGP路由携带的Domain ID与本地相同，则认为两个站点属于同一个OSPF路由域。若不相同，则认为不在同一个路由域。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/27.png"></p>
<blockquote>
<p>•Domain ID需要在绑定到VRF的OSPF进程视图下使用命令<strong>domain-id</strong>配置。</p>
<ul>
<li><p>缺省情况下，Domain ID的值为0（NULL）。如果不同OSPF域都使用NULL作为Domain ID，将无法区分OSPF域，因此它们之间的路由将被当作区域内路由。</p>
</li>
<li><p>如果一个OSPF域配置了非0（即非NULL）的Domain ID，NULL不再是该OSPF域的Domain ID。</p>
</li>
</ul>
<p>•建议与同一个VPN相关的所有OSPF实例都使用相同的Domain ID，或者都使用缺省的Domain ID。</p>
</blockquote>
<h3 id="Domain-ID与Route-Type"><a href="#Domain-ID与Route-Type" class="headerlink" title="Domain ID与Route Type"></a>Domain ID与Route Type</h3><p>根据BGP路由中的Domain ID与Route Type属性，PE将产生不同类型的OSPF LSA类型发布到VRF的OSPF进程中</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/28.png"></p>
<h2 id="OSPF防环"><a href="#OSPF防环" class="headerlink" title="OSPF防环"></a>OSPF防环</h2><h3 id="Type3路由防环-案例"><a href="#Type3路由防环-案例" class="headerlink" title="Type3路由防环 - 案例"></a>Type3路由防环 - 案例</h3><p>•如图是Type3 LSA路由产生环路的一个例子：</p>
<p>​    ▫其中站点1和站点2都属于VPN1。</p>
<p>​    ▫站点1通过OSPF Area0接入骨干网的PE1；</p>
<p>​    ▫站点2通过OSPF Area0分别接入骨干网的PE2和PE3（双归属负载分担场景）。</p>
<blockquote>
<p>•环路产生过程如下：</p>
<p>1.Site1的CE1通过Type3 LSA发布到192.168.1.0/24的路由给PE1。</p>
<p>2.PE1向BGP引入OSPF VPN1进程，通过MP-IBGP将该路由发布给PE2和PE3。</p>
<p>3.由于PE2上配置了BGP到OSPF的路由引入，故PE2将产生Type3 LSA给CE2，CE2将来自PE2的Type3 LSA发布给PE3。</p>
<p>4.此时PE3收到两条到达192.168.1.0/24的路由：一条是PE1发布的，另一条是PE2上路由引入产生的。由于缺省情况下，IGP（OSPF）路由优先级高于IBGP路由，PE3将选择OSPF路由。</p>
<p>5.PE3将优选的学自OSPF通过MP-IBGP发布给PE1。</p>
<p>▫此时，PE1上存在两条到达目的地192.168.1.0/24网段的路由，一条通过OSPF学习自CE1，另一条通过MP-IBGP学习自PE3。可能会导致以下问题：</p>
<ul>
<li>PE1撤销192.168.1.0/24这条路由，但由于PE1与PE2之间的链路阻塞，BGP Update（撤销报文）无法及时发送给PE2，导致PE3发给PE1的路由依然存在（正常情况下会随着PE1发送给PE2的Update报文被撤销），PE1上到达目的地192.168.1.0/24的下一跳为PE3。此时路由环路产生。</li>
<li>若PE1上MP-IBGP的路由优先级高于OSPF，则PE1会优选PE3通告的BGP路由，此时PE1需要撤销发给PE2的BGP路由，导致PE3撤销发布给PE1的路由，PE1上的OSPF再次被优选。如此反复，形成路由震荡。</li>
</ul>
</blockquote>
<h3 id="Type3路由防环-DN位"><a href="#Type3路由防环-DN位" class="headerlink" title="Type3路由防环 - DN位"></a>Type3路由防环 - DN位</h3><p>•为了防止3类LSA环路，OSPF多实例进程使用LSA Options域中一个原先未使用的比特作为标志位，称为DN位。使用DN位可以防止Type3 LSA环路。</p>
<p>•PE路由器的OSPF实例进程在进行SPF计算时，忽略DN置位的Type3 LSA。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/29.png"></p>
<h3 id="Type5-7路由防环-案例"><a href="#Type5-7路由防环-案例" class="headerlink" title="Type5/7路由防环 - 案例"></a>Type5/7路由防环 - 案例</h3><p>•如图是Type5 LSA路由产生环路的一个例子：</p>
<p>​    ▫其中站点1和站点2都属于VPN1。</p>
<p>​    ▫站点1通过EBGP接入骨干网的PE1；</p>
<p>​    ▫站点2通过OSPF分别接入骨干网的PE2和PE3。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/30.png"></p>
<blockquote>
<p>•环路产生过程如下：</p>
<p>1.CE1通过EBGP发布到192.168.1.0/24的路由给PE1，AS_Path为65001。</p>
<p>2.PE1通过MP-IBGP将该路由发布给PE2和PE3。</p>
<p>3.PE2在OSPF VPN1实例进程中引入BGP路由，发布到192.168.1.0/24的Type5 LSA给CE2；</p>
<p>4.CE2将该Type5 LSA发布给PE3。</p>
<p>5.PE3将优选择OSPF路由（OSPF优先级高于IBGP），并通过MP-IBGP发布Update消息给PE1。</p>
<p>6.PE1收到PE3发送的MP-IBGP Update消息。由于其中的路由是PE3的BGP引入的IGP（OSPF）路由，其AS_Path为空，因此PE3发布的MP-IBGP路由优先级比从CE1发布的EBGP路由优先级高，PE1将优选用PE3发布的路由。</p>
<p>7.此时形成一条路由环路：PE3—&gt;CE2—&gt;PE2—&gt;PE1—&gt;PE3。</p>
<p>•由于PE1不再优选CE1学来的路由，故PE1会撤销发给PE2的路由，PE2中的OSPF VPN实例进程进程中也要对应撤销引入的BGP路由，继而CE2、PE3都相继撤销该OSPF路由。PE3向PE1发布的BGP路由也被撤销，在PE1上，从CE1学来的路由又变成最优路由。这样，形成了路由振荡。</p>
<p>•Type7 LSA环路的产生和消除的过程与Type5类似，此处不再赘述。</p>
</blockquote>
<h3 id="Type5-7路由防环-VPN-Route-Tag"><a href="#Type5-7路由防环-VPN-Route-Tag" class="headerlink" title="Type5/7路由防环 - VPN Route Tag"></a>Type5/7路由防环 - VPN Route Tag</h3><p>•可以使用VPN Route Tag（VPN路由标记）来防止此5类或7类路由环路。</p>
<p>•PE在根据收到的BGP的私网路由生成5/7类LSA时，携带VPN路由标记。当PE发现LSA的VPN路由标记和本地配置的一样，就会忽略这条LSA，因此可以避免上述环路。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/31.png"></p>
<blockquote>
<p>•VPN路由标记不在BGP的扩展团体属性中传递，只是本地概念，只在收到BGP路由并且产生OSPF LSA的PE设备上有意义。</p>
<p>•缺省情况下，VPN的路由标记是根据BGP的AS号计算得到的。如果没有配置BGP，则默认值为0。</p>
<p>•可以通过指令<strong>route-tag</strong>配置VPN的路由标记。</p>
</blockquote>
<h2 id="OSPF-sham-link"><a href="#OSPF-sham-link" class="headerlink" title="OSPF sham link"></a>OSPF sham link</h2><h3 id="Sham-link的应用场景"><a href="#Sham-link的应用场景" class="headerlink" title="Sham link的应用场景"></a>Sham link的应用场景</h3><p>•通常情况下，BGP对等体之间通过BGP扩展团体属性在MPLS VPN骨干网上承载路由信息。另一端PE上运行的OSPF可利用这些信息来生成PE到CE的Type 3 LSA，这些路由是区域间路由（Inter_Area route）。</p>
<p>•若在CE1和CE2之间增加一条后门（Backdoor）链路，并且直接运行OSPF交互路由。通过后门链路学习到的路由类型为区域内路由（Intra_Area route）。</p>
<p>•由于区域内路由优于区域间路由，故后门链路会被优选，若想实现后门链路作为备份链路，可采用sham link实现。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/32.png"></p>
<h3 id="Sham-link的工作机制"><a href="#Sham-link的工作机制" class="headerlink" title="Sham link的工作机制"></a>Sham link的工作机制</h3><p>•Sham link在两台PE之间创建了一条区域内链路。当LSA在伪装链路中泛洪，所有的OSPF路由类型都不会改变，不会转换成LSA3或者LSA5的类型。</p>
<p>•Sham link被看成是两个VPN实例之间的链路，链路的两端是PE上的端点地址，分别作为建立连接时的源和目的地址。伪连接的源地址和目的地址使用32位掩码的Loopback接口地址，该Loopback接口需要绑定到VPN实例中，并通过BGP发布。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/33.png"></p>
<blockquote>
<p>•同一个OSPF进程的多条Sham link可以共用端点地址，但不同OSPF进程不能拥有两条端点地址完全相同的Sham link。</p>
</blockquote>
<h3 id="Sham-link的配置示例"><a href="#Sham-link的配置示例" class="headerlink" title="Sham link的配置示例"></a>Sham link的配置示例</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/34.png"></p>
<blockquote>
<p>•在配置Sham link时可以指定Sham link的路由开销。缺省值为1。</p>
</blockquote>
<h3 id="sham-link的配置验证"><a href="#sham-link的配置验证" class="headerlink" title="sham link的配置验证"></a>sham link的配置验证</h3><p><img src="/2021/06/23/IPadv-MPLSVPN%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%BA%94%E7%94%A8/35.png"></p>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>1.（多选题）在MPLS VPN组网中，当PE向OSPF引入从其他PE学习来的VPN路由时，可能会产生以下哪几类LSA（    ）。</p>
<p>A.Type 1 LSA</p>
<p><strong>B.Type 3 LSA</strong></p>
<p><strong>C.Type 5 LSA</strong></p>
<p><strong>D.Type 7 LSA</strong></p>
<p>2.（判断）CE通过BGP传递路由给PE时，可能会携带SoO属性。（    ）。</p>
<p>A. 正确</p>
<p><strong>B. 错误</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MPLS VPN在针对不同类型的场景下有不同的组网方案，常见的有Intranet组网、Extranet组网以及Hub&amp;Spoke组网。此外，根据MPLS VPN骨干网是否跨域又可以分为跨域组网和单域组网。</p>
<p>•PE-CE之间进行路由信息交互时，可以使用静态路由、OSPF、IS-IS或BGP中的任何一种。其中OSPF为MPLS VPN做了许多扩展特性，如：</p>
<p>​    ▫Domain ID：用来区分VPN实例中引入的路由是否来自同一个OSPF域</p>
<p>​    ▫DN位：用来防止因为3类LSA产生的路由环路</p>
<p>​    ▫VPN Route Tag：用来方式因为5类或7类LSA产生的路由环路</p>
<p>​    ▫sham link：用于特殊场景下的OSPF路由选路控制</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IPadv-MPLSVPN原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T14:29:37+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•VPN（Virtual Private Network，虚拟专用网络）指的是在一个公共网络中实现虚拟的专用网络，从而使得用户能够基于该专用网络实现通信的技术。</p>
<p>•MPLS VPN也是VPN技术中的一种。需要强调的是，本课程所介绍的MPLS VPN指的是BGP/MPLS IP VPN，这是一种被业界广泛使用的三层VPN。</p>
<p>•本课程将介绍MPLS VPN的基本概念、工作过程以及典型配置方法。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述MPLS VPN的模型</p>
<p>▫描述MPLS VPN中的基本概念</p>
<p>▫描述MPLS VPN路由传递和标签分发</p>
<p>▫描述MPLS VPN数据转发流程</p>
<p>▫执行MPLS VPN的基本配置</p>
<h1 id="1-MPLS-VPN概述"><a href="#1-MPLS-VPN概述" class="headerlink" title="1.MPLS VPN概述"></a>1.MPLS VPN概述</h1><h2 id="MPLS-VPN定义"><a href="#MPLS-VPN定义" class="headerlink" title="MPLS VPN定义"></a>MPLS VPN定义</h2><p>•BGP/MPLS IP VPN网络一般由<strong>运营商</strong>搭建，<strong>VPN用户购买</strong>VPN服务来实现用户网络之间的路由传递、数据互通等。</p>
<p>•MPLS VPN使用<strong>BGP</strong>在运营商骨干网（<strong>IP网络</strong>）上发布VPN路由，使用<strong>MPLS</strong>在运营商骨干网上转发VPN报文。BGP/MPLS IP VPN又被简称为MPLS VPN，是一种常见的L3VPN（Layer 3 VPN）技术。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h2 id="MPLS-VPN网络架构"><a href="#MPLS-VPN网络架构" class="headerlink" title="MPLS VPN网络架构"></a>MPLS VPN网络架构</h2><p>•MPLS VPN网络架构由三部分组成：CE（Customer Edge）、PE（Provider Edge）和P（Provider），其中PE和P是运营商设备，CE是MPLS VPN用户设备。</p>
<p>•站点（site）就是MPLS VPN的用户，由CE和其他用户设备构成。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•CE：用户网络边缘设备，有接口直接与运营商网络相连。CE可以是路由器或交换机，也可以是一台主机。通常情况下，CE“感知”不到VPN的存在，也不需要支持MPLS。</p>
<p>•PE：运营商边缘路由器，是运营商网络的边缘设备，与CE直接相连。在MPLS网络中，对VPN的所有处理都发生在PE上，对PE性能要求较高。</p>
<p>•P：运营商网络中的骨干路由器，不与CE直接相连。P设备只需要具备基本MPLS转发能力，不维护VPN相关信息。</p>
<p>•站点的含义可以从下述几个方面理解：</p>
<ul>
<li><p>站点是指相互之间具备IP连通性的一组IP系统，并且这组IP系统的IP连通性不需通过运营商网络实现。</p>
</li>
<li><p>站点的划分是根据设备的拓扑关系，而不是地理位置。如图所示，公司A的X省网络和公司A的Y省网络需要通过运营商的骨干网进行互联，所以它们被划分为两个站点。若在当前X省网络和Y省网络的CE之间增加一条物理专线，不需要通过运营商网络就可以互通，那么这两张网络就是一个站点。</p>
</li>
</ul>
<p>•站点与VPN的关系：</p>
<ul>
<li><p>对于多个连接到同一服务提供商网络的站点，通过制定策略，可以将它们划分为不同的集合，只有属于相同集合的站点之间才能通过服务提供商网络互访，这种集合就是VPN。</p>
</li>
<li><p>一个Site中的设备可以属于多个VPN，换言之，一个Site可以属于多个VPN。</p>
</li>
</ul>
<p>•注：也有可能出现站点为一台主机的情况，此时该主机就是CE设备。本课程仅讨论站点是一个或多个子网，用路由器或交换机作为CE的情况。</p>
</blockquote>
<h2 id="MPLS-VPN技术架构"><a href="#MPLS-VPN技术架构" class="headerlink" title="MPLS VPN技术架构"></a>MPLS VPN技术架构</h2><p>•MPLS VPN不是单一的一种VPN技术，是多种技术结合的综合解决方案，主要包含下列技术：</p>
<p>​    ▫MP-BGP：负责在PE与PE之间传递站点内的路由信息。</p>
<p>​    ▫LDP：负责PE与PE之间的隧道建立</p>
<p>​    ▫VRF：负责PE的VPN用户管理。</p>
<p>​    ▫静态路由、IGP、BGP：负责PE与CE之间的路由信息交换。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<blockquote>
<p>•MP-BGP（MultiProtocol BGP）：拓展的BGP协议，可提供对多种地址族的支持，后续课程将会详细介绍。</p>
</blockquote>
<h2 id="为什么要选择MPLS-VPN"><a href="#为什么要选择MPLS-VPN" class="headerlink" title="为什么要选择MPLS VPN"></a>为什么要选择MPLS VPN</h2><p>•对VPN客户而言：</p>
<ul>
<li>“感知”不到VPN的存在，不需要部署和维护VPN，降低企业运维难度和成本。</li>
<li>一般部署在运营商的MPLS VPN专网上，有一定的安全性保障。</li>
</ul>
<p>•对于运营商而言：</p>
<ul>
<li>MPLS在无连接的IP网络中增加了面向连接的控制平面，为IP网络增添了管理和运营的手段。</li>
<li>支持地址空间重叠、支持重叠VPN、组网方式灵活、可扩展性好。</li>
<li>能够方便地支持MPLS TE合理调控现有网络资源，最大限度的节省运营商成本。</li>
</ul>
<blockquote>
<p>•MPLS TE（MPLS Traffic Engineering，MPLS流量工程）：基于一定约束条件LSP隧道，并将流量引入到这些隧道中进行转发，使网络流量按照指定的路径进行传输。可以在不进行硬件升级的情况下对现有网络资源进行合理调配和利用，并对网络流量提供带宽和QoS保证，最大限度的节省成本。</p>
</blockquote>
<h2 id="MPLS-VPN常见组网"><a href="#MPLS-VPN常见组网" class="headerlink" title="MPLS VPN常见组网"></a>MPLS VPN常见组网</h2><p>•根据VPN用户的需求不同，可采用以下几种常见的组网方案：</p>
<ul>
<li>Intranet：一个VPN中的所有用户形成闭合用户群，同一VPN站点之间可以互访，不同VPN站点间不能互访。</li>
<li>Extranet：适用于一个VPN用户希望提供部分本VPN的站点资源给其他VPN的用户访问的场景。</li>
<li>Hub&amp;Spoke：如果希望在VPN中设置中心访问控制设备，其它用户的互访都通过中心访问控制设备进行，可采用Hub&amp;Spoke组网方案。</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•Intranet组网是最简单也是最典型的MPLS VPN组网方案，后续课程将基于该组网方案对MPLS VPN技术原理展开介绍。</p>
</blockquote>
<h1 id="2-MPLS-VPN路由交互"><a href="#2-MPLS-VPN路由交互" class="headerlink" title="2.MPLS VPN路由交互"></a>2.MPLS VPN路由交互</h1><h2 id="MPLS-VPN路由发布概述"><a href="#MPLS-VPN路由发布概述" class="headerlink" title="MPLS VPN路由发布概述"></a>MPLS VPN路由发布概述</h2><p>•若想实现同一个VPN的不同站点之间的通信，首先需要完成不同站点之间的路由交互。在基本MPLS VPN组网中，VPN路由信息的发布涉及CE和PE，P路由器只维护骨干网的路由，不需要了解任何VPN路由信息。VPN路由信息的发布过程包括三部分：</p>
<p>​    ▫本地CE到入口PE</p>
<p>​    ▫入口PE到出口PE</p>
<p>​    ▫出口PE到远端CE</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<h2 id="CE与PE之间的路由信息交换"><a href="#CE与PE之间的路由信息交换" class="headerlink" title="CE与PE之间的路由信息交换"></a>CE与PE之间的路由信息交换</h2><p>•如图，客户X和客户Y属于不同的VPN，分别拥有两个站点，现需要实现站点间的路由信息交互。</p>
<p>•CE与PE之间可以使用静态路由、OSPF、IS-IS或BGP交换路由信息。无论使用哪种路由协议，CE和PE之间交换的都是<strong>标准的IPv4</strong>路由。</p>
<p>•本地CE到入口PE和出口PE到远端CE的路由信息交换原理完全相同。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<h2 id="入口PE到出口PE路由传递-1"><a href="#入口PE到出口PE路由传递-1" class="headerlink" title="入口PE到出口PE路由传递 (1)"></a>入口PE到出口PE路由传递 (1)</h2><p>PE在接收到CE传递来的路由之后，需要独立保存不同VPN的路由，且需要解决不同的客户使用重叠IP地址空间的问题。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<blockquote>
<p>•VPN是一种私有网络，不同的VPN独立管理自己的地址范围，也称为地址空间（address space）。不同VPN的地址空间可能会在一定范围内重合，例如图中用户X和用户Y都使用192.168.1.0/24网段地址，这就发生了地址空间的重叠（address spaces overlapping）。以下两种情况允许VPN使用重叠的地址空间：</p>
<ul>
<li><p>两个VPN没有共同的站点；</p>
</li>
<li><p>两个VPN有共同的站点，但此共同站点中的设备不与两个VPN中使用重叠地址空间的设备互访。</p>
</li>
</ul>
</blockquote>
<h2 id="VRF"><a href="#VRF" class="headerlink" title="VRF"></a>VRF</h2><p>•VRF（Virtual Routing and Forwarding，虚拟路由转发），又称VPN实例，是MPLS VPN架构中的关键技术，每个VPN实例使用独立的路由转发表项，实现VPN之间的逻辑隔离。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h2 id="RD"><a href="#RD" class="headerlink" title="RD"></a>RD</h2><p>•PE收到不同VPN的CE发来的IPv4地址前缀，本地根据VPN实例配置去区分这些地址前缀。但是VPN实例只是一个<strong>本地</strong>的概念，PE无法将VPN实例信息传递到对端PE，故有了RD（Route Distinguisher，路由标识符）。</p>
<p>▫RD长8字节，用于区分使用相同地址空间的IPv4前缀。</p>
<p>▫PE从CE接收到IPv4路由后，在IPv4前缀前加上RD，转换为<strong>全局唯一</strong>的<strong>VPN-IPv4</strong>路由。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<blockquote>
<p>•配置RD时，只需要指定RD的Administrator子字段和Assigned Number子字段。</p>
<p>•RD的配置格式有四种，常用的两种如下：</p>
<p>​    ▫16bits自治系统号:32bits用户自定义数字（例如：100:1）。</p>
<p>​    ▫32bits IPv4地址:16bits用户自定义数字（例如：172.1.1.1:1）。</p>
<p>•RD的结构使得每个运营商可以独立地分配RD，但为了在某些应用场景下保证路由正常，必须保证RD全局唯一。</p>
</blockquote>
<h2 id="VPN-IPv4地址"><a href="#VPN-IPv4地址" class="headerlink" title="VPN-IPv4地址"></a>VPN-IPv4地址</h2><p>VPN-IPv4地址又被称为VPNv4地址：VPNv4地址共有12个字节，包括8字节的路由标识符RD（Route Distinguisher）和4字节的IPv4地址前缀。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<h2 id="入口PE到出口PE路由传递-2"><a href="#入口PE到出口PE路由传递-2" class="headerlink" title="入口PE到出口PE路由传递 (2)"></a>入口PE到出口PE路由传递 (2)</h2><p>•PE之间建立BGP邻居关系，并通过BGP进行路由传递。为什么采用BGP呢？</p>
<p>▫BGP使用TCP作为其传输层协议，提高了协议的可靠性。可以跨路由器的两个PE设备之间直接交换路由。</p>
<p>▫BGP拓展性强，为PE间传播VPN路由提供了便利。</p>
<p>▫PE之间需要传送的路由条目可能较大，BGP只发送更新的路由，提高传递路由数量的同时不占用过多链路带宽。</p>
<p>•传统的BGP-4<strong>不支持</strong>处理VPNv4路由。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<h2 id="MP-BGP"><a href="#MP-BGP" class="headerlink" title="MP-BGP"></a>MP-BGP</h2><p>•为了正确处理VPN路由，MPLS VPN使用RFC2858（Multiprotocol Extensions for BGP-4）中规定的MP-BGP，即BGP-4的多协议扩展。</p>
<p>•MP-BGP采用地址族（Address Family）来区分不同的网络层协议，既可以支持传统的IPv4地址族，又可以支持其它地址族（比如VPN-IPv4地址族、IPv6地址族等）。</p>
<p>•MP-BGP新增了两种路径属性：</p>
<ul>
<li><p>MP_REACH_NLRI：Multiprotocol Reachable NLRI，多协议可达NLRI。用于发布可达路由及下一跳信息。</p>
</li>
<li><p>MP_UNREACH_NLRI：Multiprotocol Unreachable NLRI，多协议不可达NLRI。用于撤销不可达路由。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<blockquote>
<p>•NLRI：Network Layer Reachability Information，网络层可达信息。</p>
<p>•关于地址族的一些取值请参考RFC3232（Assigned Numbers）。</p>
<p>•MP_REACH_NLRI用于发布可达路由及下一跳信息。该属性由一个或多个三元组&lt;地址族信息、下一跳信息、网络可达性信息&gt;组成，格式如下：</p>
<p>▫地址族信息（Address Family Information）域：由2字节的地址族标识AFI（Address Family Identifier）和1字节的子地址族标识SAFI（Subsequent Address Family Identifier）组成。</p>
<p>▪AFI标识网络层协议，对应RFC3232的“Address Family Number”所定义的地址族值。例如IPv4的值是1，IPv6的值是2。</p>
<p>▪SAFI表示NLRI的类型。AFI值为1，SAFI值为128表示NLRI中的地址为MPLS-labeled VPN-IPv4地址。</p>
<ul>
<li><p>下一跳信息（Next Hop Network Address Information）域：由一字节的下一跳网络地址长度和可变长度的下一跳网络地址组成。</p>
</li>
<li><p>网络层可达性信息（NLRI）域：由一个或多个三元组&lt;长度、标签、前缀&gt;组成，该部分内容将在后面的课程里详细介绍。</p>
</li>
</ul>
<p>•MP_UNREACH_NLRI用于通知对等体删除不可达的路由。该属性的格式如下：</p>
<ul>
<li><p>地址族标识AFI：与MP_REACH_NLRI属性中的相同。</p>
</li>
<li><p>子地址族标识SAFI：与MP_REACH_NLRI属性中的相同，表示NLRI的类型。</p>
</li>
<li><p>撤销路由（Withdrawn Routes）：不可达路由列表，也是由一个或多个NLRI组成。BGP发言者可以通过在撤销路由域中携带与之前发布的可达路由中相同的NLRI来撤销路由。</p>
</li>
</ul>
<p>•MP-BGP的报文类型、VPNv4路由发布策略仍与普通BGP相同。</p>
</blockquote>
<h2 id="入口PE到出口PE路由传递-3"><a href="#入口PE到出口PE路由传递-3" class="headerlink" title="入口PE到出口PE路由传递 (3)"></a>入口PE到出口PE路由传递 (3)</h2><p>•MP-BGP将VPNv4传递到远端PE之后，远端PE需要将VPNv4路由导入正确的VPN实例。</p>
<p>•MPLS VPN使用32位的BGP扩展团体属性－VPN Target（也称为Route Target）来控制VPN路由信息的发布与接收。</p>
<p>•本地PE在发布VPNv4路由前附上RT属性，对端RT在接到到VPNv4路由后根据RT将路由导入对应的VPN实例。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<h2 id="RT"><a href="#RT" class="headerlink" title="RT"></a>RT</h2><p>•在PE上，每一个VPN实例都会与<strong>一个或多个</strong>VPN Target属性绑定，有两类VPN Target属性：</p>
<ul>
<li><p>Export Target（ERT）：本地PE从直接相连站点学到IPv4路由后，转换为VPN IPv4路由，并为这些路由添加Export Target属性。Export Target属性作为BGP的扩展团体属性随路由发布。</p>
</li>
<li><p>Import Target（IRT）：PE收到其它PE发布的VPN-IPv4路由时，检查其Export Target属性。当此属性与PE上某个VPN实例的Import Target匹配时，PE就把路由加入到该VPN实例的路由表。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•与RD相同，RT由Type、Administrator和Assigned Number三个字段构成，长度也是8字节。 </p>
<p>•配置VPN-Target时，只需要指定VPN-Target的Administrator子字段和Assigned Number子字段。VPN-Target的配置格式与RD格式一致。</p>
</blockquote>
<h2 id="入口PE到出口PE路由传递-4"><a href="#入口PE到出口PE路由传递-4" class="headerlink" title="入口PE到出口PE路由传递 (4)"></a>入口PE到出口PE路由传递 (4)</h2><p>•PE根据VPNv4路由所携带的RT将路由导入正确的VPN实例之后，VPNv4路由的RD值剥除，将<strong>IPv4路由</strong>通告给相应的客户的CE设备。</p>
<p>•站点B和站点D的CE设备就能学习到去往各自远端站点的路由。同理，通过一系列的操作，可以实现同一用户（同一VPN）不同站点之间的路由互通。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<h2 id="数据转发时遇到的问题"><a href="#数据转发时遇到的问题" class="headerlink" title="数据转发时遇到的问题"></a>数据转发时遇到的问题</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<h2 id="通过标签解决问题"><a href="#通过标签解决问题" class="headerlink" title="通过标签解决问题"></a>通过标签解决问题</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<h2 id="入口PE到出口PE路由传递-5"><a href="#入口PE到出口PE路由传递-5" class="headerlink" title="入口PE到出口PE路由传递 (5)"></a>入口PE到出口PE路由传递 (5)</h2><p>•PE和P设备之间运行LDP，交换公网标签，建立PE之间的LSP隧道（公网隧道）。</p>
<p>•入口PE在通过MP-BGP传递VPNv4路由时，会携带私网标签，用于区分不同VPN的数据。</p>
<p>•出口PE在接收到VPNv4路由后，需要执行私网路由交叉和隧道迭代来选择路由。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<blockquote>
<p>•PE上分配私网标签的方法有如下两种：</p>
<ul>
<li>基于路由的MPLS标签分配：为VPN路由表的每一条路由分配一个标签（one label per route）。这种方式的缺点是：当路由数量比较多时，设备入标签映射表ILM（Incoming Label Map）需要维护的表项也会增多，从而提高了对设备容量的要求。</li>
<li>基于VPN实例的MPLS标签分配：为整个VPN实例分配一个标签，该VPN实例里的所有路由都共享一个标签。使用这种分配方法的好处是节约了标签。</li>
</ul>
<p>•私网路由交叉：VPNv4路由与本地VPN实例的VPN-Target进行匹配的过程称为私网路由交叉。PE在收到VPNv4路由后，既不进行优选，也不检查隧道是否存在，直接将其与本地的VPN实例进行交叉。</p>
<p>•隧道迭代：为了将私网流量通过公网传递到另一端，需要有一条公网隧道承载这个私网流量。因此私网路由交叉完成后，需要根据目的IPv4前缀进行路由迭代，即该IPv4路由的下一跳有对应的LSP存在；只有隧道迭代成功，该路由才被放入对应的VPN实例路由表。</p>
</blockquote>
<h2 id="MPLS-VPN中的路由交互全过程"><a href="#MPLS-VPN中的路由交互全过程" class="headerlink" title="MPLS VPN中的路由交互全过程"></a>MPLS VPN中的路由交互全过程</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>•在MPLS VPN中，PE与CE，PE与PE之间需要进行VPN路由信息的传递。</p>
<ul>
<li>PE与CE之间可以采用BGP、IGP以及静态路由方式交互<strong>IPv4</strong>路由信息。</li>
<li>PE与PE之间通过MP-BGP交互<strong>VPNv4</strong>路由信息，包含<ul>
<li>RD：与IPv4前缀组合组成VPNv4前缀。</li>
<li>RT：用于控制PE之间路由信息的接收和发布。</li>
<li>标签：数据转发时的内层（私网）标签，在PE上用来区分不同VPN的数据。</li>
</ul>
</li>
</ul>
<h1 id="3-MPLS-VPN报文转发"><a href="#3-MPLS-VPN报文转发" class="headerlink" title="3.MPLS VPN报文转发"></a>3.MPLS VPN报文转发</h1><h2 id="报文转发过程"><a href="#报文转发过程" class="headerlink" title="报文转发过程"></a>报文转发过程</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/29.png"></p>
<h1 id="4-MPLS-VPN配置与实现"><a href="#4-MPLS-VPN配置与实现" class="headerlink" title="4.MPLS VPN配置与实现"></a>4.MPLS VPN配置与实现</h1><h2 id="配置命令-VPN实例配置"><a href="#配置命令-VPN实例配置" class="headerlink" title="配置命令 - VPN实例配置"></a>配置命令 - VPN实例配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/30.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/31.png"></p>
<h2 id="配置命令-MP-BGP配置"><a href="#配置命令-MP-BGP配置" class="headerlink" title="配置命令 - MP-BGP配置"></a>配置命令 - MP-BGP配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/32.png"></p>
<h2 id="配置命令-PE与CE间路由配置"><a href="#配置命令-PE与CE间路由配置" class="headerlink" title="配置命令 - PE与CE间路由配置"></a>配置命令 - PE与CE间路由配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/33.png"></p>
<h2 id="MPLS-VPN配置示例-背景介绍"><a href="#MPLS-VPN配置示例-背景介绍" class="headerlink" title="MPLS VPN配置示例 - 背景介绍"></a>MPLS VPN配置示例 - 背景介绍</h2><p>•客户X及Y各自有2个站点，现需要通过MPLS VPN实现站点之间的互联，分别对应VPNX和VPNY；</p>
<p>•互联接口、AS号及IP地址信息如图；</p>
<p>•客户X站点与PE之间采用OSPF交互路由信息，客户Y站点与PE之间采用BGP交互路由信息。</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/34.png"></p>
<h2 id="MPLS-VPN配置示例-配置思路"><a href="#MPLS-VPN配置示例-配置思路" class="headerlink" title="MPLS VPN配置示例 - 配置思路"></a>MPLS VPN配置示例 - 配置思路</h2><p>1.MPLS VPN骨干网配置</p>
<p>​    1.1 IGP配置，实现骨干网的IP连通性。</p>
<p>​    1.2 MPLS与MPLS LDP配置，建立MPLS LSP公网隧道，传输VPN数据。</p>
<p>​    1.3 MP-BGP配置，建立后续传递VPNv4路由的MP-BGP对等体关系。</p>
<p>2.VPN用户接入配置</p>
<p>​    2.1 创建VPN实例并配置参数（RT、RD）</p>
<p>​    2.2 将接口加入VPN实例</p>
<p>​    2.3 配置PE与CE之间的路由交换</p>
<h2 id="MPLS-VPN配置示例-数据规划"><a href="#MPLS-VPN配置示例-数据规划" class="headerlink" title="MPLS VPN配置示例 - 数据规划"></a>MPLS VPN配置示例 - 数据规划</h2><p>•MPLS骨干网采用单区域OSPF实现路由互通，所有PE和P互联接口均使能MPLS LDP功能。</p>
<p>•PE上的VPN相关配置如表格：</p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/35.png"></p>
<h2 id="MPLS-VPN骨干网配置"><a href="#MPLS-VPN骨干网配置" class="headerlink" title="MPLS VPN骨干网配置"></a>MPLS VPN骨干网配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/36.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/37.png"></p>
<blockquote>
<p>•缺省情况下，只有BGP-IPv4单播地址族的对等体是自动使能的。即在BGP视图下配置peer as-number命令后，系统会自动配置相应的peer enable命令。其他地址族视图下都必须手动使能。</p>
</blockquote>
<h2 id="MPLS-VPN骨干网配置-配置验证"><a href="#MPLS-VPN骨干网配置-配置验证" class="headerlink" title="MPLS VPN骨干网配置 - 配置验证"></a>MPLS VPN骨干网配置 - 配置验证</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/38.png"></p>
<h2 id="VPN用户接入配置"><a href="#VPN用户接入配置" class="headerlink" title="VPN用户接入配置"></a>VPN用户接入配置</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/39.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/40.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/41.png"></p>
<h2 id="配置验证"><a href="#配置验证" class="headerlink" title="配置验证"></a>配置验证</h2><p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/42.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/43.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSVPN%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/44.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选）MP-BGP在传递VPNv4路由时，携带哪种Route Target ？ （ ）</p>
<p><strong>A. Export RT</strong></p>
<p>B. Implied RT</p>
<p>C. Import RT</p>
<p>D. Extended RT</p>
<p>2.（多选）基本MPLS VPN组网中，需要对VPN实例做哪些配置（ ）</p>
<p><strong>A.Import RT</strong></p>
<p><strong>B.Export RT</strong></p>
<p><strong>C.配置RD</strong></p>
<p><strong>D.配置与VPN实例绑定的接口</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MPLS VPN网络一般由运营商搭建，用于向不同的客户提供VPN服务，使得用户的路由和数据能够通过该网络进行传递，且不同的用户之间的路由和数据完全隔离，互不影响。</p>
<p>•MPLS VPN控制层面：</p>
<p>​    ▫通过VRF和RD隔离不同用户的私网路由信息并构建唯一的VPNv4路由</p>
<p>​    ▫通过RT值控制VPNv4路由的发布和接收</p>
<p>​    ▫通过MP-BGP传递VPNv4路由前缀、标签以及RT等信息</p>
<p>​    ▫通过MPLS LDP构建公网标签转发路径</p>
<p>•MPLS转发层面：通过内外两层标签进行数据转发，内层标签区分私网数据，外层标签穿通公网网络。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IPadv-MPLSLDP原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T13:37:44+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•MPLS是一种根根据标签报文中携带的短而定长的标签来转发数据的技术。</p>
<p>•MPLS的一个基本概念就是两台LSR必须对在它们之间转发的数据的标签使用上“达成共识”。LSR之间可以运行标签分发协议（Label Distribution Protocol，LDP）来告知其他LSR本设备上的标签绑定信息，从而实现标签报文的正确转发。</p>
<p>•本课程将介绍LDP基本工作原理与特性，以及LDP的基本配置。</p>
<blockquote>
<p>•本课程的标签分发协议特指由RFC3036首次定义的标签分发协议，当前该标准已被RFC5036废弃。</p>
<p>•除了LDP外，标签分发协议也可以指MP-BGP、RSVP等可执行标签分发的一类协议。</p>
</blockquote>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述LDP的基本概念及工作机制</p>
<p>▫描述MPLS标签分发控制模式、通告模式及保留模式</p>
<p>▫实现LDP的基础配置</p>
<h1 id="1-LDP基本概念"><a href="#1-LDP基本概念" class="headerlink" title="1.LDP基本概念"></a>1.LDP基本概念</h1><h2 id="LDP协议概述"><a href="#LDP协议概述" class="headerlink" title="LDP协议概述"></a>LDP协议概述</h2><p>•LDP是MPLS的一种控制协议，相当于传统网络中的信令协议，负责FEC的分类、标签的分配以及LSP的建立和维护等操作。LDP规定了标签分发过程中的各种消息以及相关处理过程。</p>
<p>•LDP的工作过程主要分为两部分：</p>
<p>​    1.LSR之间建立LDP会话。</p>
<p>​    2.LSR之间基于LDP会话动态交换标签与FEC的映射信息，并根据标签信息建立LSP。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h2 id="LDP会话、LDP邻接体、LDP对等体"><a href="#LDP会话、LDP邻接体、LDP对等体" class="headerlink" title="LDP会话、LDP邻接体、LDP对等体"></a>LDP会话、LDP邻接体、LDP对等体</h2><p>•LSR之间交互标签绑定消息之前必须建立LDP会话。LDP会话可以分为：</p>
<p>​    ▫本地LDP会话（Local LDP Session）：建立会话的两个LSR之间是直连的；</p>
<p>​    ▫远程LDP会话（Remote LDP Session）：建立会话的两个LSR之间可以是直连的，也可以是非直连的。</p>
<p>•两台LSR之间交互Hello消息之后，即建立起邻接体（Adjacency）关系；</p>
<p>•在建立邻接体关系的基础上，两台LSR之间交互LDP会话消息，建立起LDP会话，两台设备之间形成LDP对等体关系；</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<h2 id="LSR-ID与LDP-ID"><a href="#LSR-ID与LDP-ID" class="headerlink" title="LSR ID与LDP ID"></a>LSR ID与LDP ID</h2><p>•每一台运行了LDP的LSR除了必须配置LSR ID，还必须拥有LDP ID。</p>
<ul>
<li><p>LDP ID的长度为48bit，由32bit的LSR ID与16bit的标签空间标识符（Label Space ID）构成。</p>
</li>
<li><p>LDP ID以“LSR ID : 标签空间标识”的形式呈现。例如2.2.2.2:0。</p>
</li>
</ul>
<p>•标签空间标识一般存在两种形态：</p>
<ul>
<li><p>值为0：表示基于设备（或基于平台）的标签空间；</p>
</li>
<li><p>值非0：表示基于接口的标签空间。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<blockquote>
<p>•在本课程中，均使用基于设备（或基于平台）的标签空间。</p>
</blockquote>
<h2 id="LDP消息"><a href="#LDP消息" class="headerlink" title="LDP消息"></a>LDP消息</h2><p>运行LDP协议的LSR之间通过交换LDP消息来实现邻居发现、会话建立与维护以及标签管理等功能。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•按照消息的功能，LDP消息一共可以分为四大类型：发现消息（Discovery Message），会话消息（Session Message），通告消息（Advertisement Message）和通知消息（Notification Message）。</p>
<p>▫发现消息：用来宣告和维护网络中一个LSR的存在；用于通告和维护网络中LSR的存在，如Hello报文。</p>
<p>▫会话消息：用于建立、维护和终止LDP对等体之间的会话，如Initialization报文、KeepAlive报文。</p>
<p>▫通告消息：用来生成、改变和删除FEC的标签映射；</p>
<p>▫通知消息：用来宣告告警和错误信息。</p>
<p>•LDP消息承载在UDP或TCP之上，端口号均为646 。其中发现消息用来发现邻居，承载在UDP报文上。其他消息的传递要求可靠而有序，所以LDP使用TCP建立会话，会话、通告和通知消息都基于TCP传递。</p>
</blockquote>
<h2 id="LDP报文封装"><a href="#LDP报文封装" class="headerlink" title="LDP报文封装"></a>LDP报文封装</h2><p>•LDP协议报文包括了LDP头部和LDP消息两部分。</p>
<p>​    ▫LDP头部中携带了LDP版本、报文长度等信息；</p>
<p>​    ▫LDP消息中携带了消息类型、消息长度等信息。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<blockquote>
<p>•LDP头部长度为10Byte，包括Version，PDU Length和LDP Identifier三部分。</p>
<ul>
<li>Version占用2Byte，表示LDP版本号，当前版本号为1。</li>
<li>PDU Length占用2Byte，以字节为单位表示除了Version和PDU Length以外的其他部分的总长度。</li>
<li>LDP Identifier，即LDP ID，长度6Byte，其中前4Byte用来唯一标识一个LSR，后2Byte用来表示LSR的标签空间。</li>
</ul>
<p>•LDP消息包含五个部分。</p>
<ul>
<li>U占用1个bit，为Unknown Message bit。当LSR收到一个无法识别的消息时，该消息的U=0时，LSR会返回给该消息的生成者一个通告，当U=1时，忽略该无法识别的消息，不发送通告给生成者。</li>
<li>Message Length占用2个bytes，以字节为单位表示Message ID、Mandatory Parameters和Optional Parameters的总长度。</li>
<li>Message ID占用32个bit，用来标识一个消息。</li>
<li>Mandatory Parameters和Optional Parameters分别为可变长的该消息的必须的参数和可选的参数。</li>
<li>Message Type表示具体的消息类型，目前LDP定义的常用的消息有Notification，Hello，Initialization，KeepAlive，Address，Address Withdraw，Label Mapping，Label Request，Label Abort Request，Label Withdraw，Label Release。</li>
</ul>
</blockquote>
<h1 id="2-LDP工作原理"><a href="#2-LDP工作原理" class="headerlink" title="2.LDP工作原理"></a>2.LDP工作原理</h1><h2 id="LDP会话建立"><a href="#LDP会话建立" class="headerlink" title="LDP会话建立"></a>LDP会话建立</h2><h3 id="LDP会话状态机"><a href="#LDP会话状态机" class="headerlink" title="LDP会话状态机"></a>LDP会话状态机</h3><p>LDP使用5种状态描述LDP会话状态机。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<blockquote>
<p>•LDP Session协商过程可以通过状态机来描述。如图所示，有5种状态。分别是Non-Existent，Initialized，OpenRec，OpenSent，Operational。</p>
<p>▫Non-Existent状态：该状态为LDP Session最初的状态，在此状态双方发送HELLO消息，选举主动方，在收到TCP连接建立成功事件的触发后变为Initialized状态。</p>
<p>▫Initialized状态：该状态下分为主动方和被动方两种情况，主动方将主动发送Initialization消息，转向OpenSent 状态，等待回应的Initialization消息；被动方在此状态等待主动方发给自己的Initialization消息，如果收到的Initialization消息的参数可以接受，则发送Initialization和KeepAlive转向OpenRec状态。主动方和被动方在此状态下收到任何非Initialization消息或等待超时时，都会转向Non-Existent状态。</p>
<p>▫OpenSent 状态：此状态为主动方发送Initialization消息后的状态，在此状态等待被动方回答Initialization消息和KeepAlive消息，如果收到的Initialization消息中的参数可以接受则转向OpenRec状态，如果参数不能接受或Initialization消息超时则断开TCP连接转向Non-Existent状态。</p>
<p>▫OpenRec状态：在此状态不管主动方还是被动方都是发出KeepAlive后的状态，在等待对方回应KeepAlive，只要收到KeepAlive消息就转向Operational状态；如果收到其它消息或KeepAlive超时则转向Non-Existent状态。</p>
<p>▫Operational状态：该状态是LDP Session成功建立的标志。在此状态下可以发送和接收所有其它的LDP消息。在此状态如果KeepAlive超时或收到致命错误的Notification消息（Shutdown消息）或者自己主动发送Shutdown消息主动结束会话，都会转向Non-Existent状态。</p>
<p>•LDP状态切换信息可以通过指令<strong>debug</strong> <strong>mpls</strong> <strong>ldp</strong> <strong>session</strong>看到。</p>
</blockquote>
<h3 id="LDP会话建立-发现阶段与TCP连接建立"><a href="#LDP会话建立-发现阶段与TCP连接建立" class="headerlink" title="LDP会话建立 - 发现阶段与TCP连接建立"></a>LDP会话建立 - 发现阶段与TCP连接建立</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<blockquote>
<p>•除了基本发现机制外，可以通过拓展发现机制发现非直连的远端邻接体，该内容不属于课程的重点，详细内容可以查阅RFC5036相关内容。</p>
<p>•LDP的传输地址用于与邻居建立TCP连接。</p>
<ul>
<li>两台LSR之间在建立LDP会话之前，需要先建立TCP连接，以便进行LDP协议报文的交换。</li>
<li>设备的传输地址被包含在LDP Hello报文中，LSR通过Hello报文知晓邻居的传输地址。</li>
<li>在使用Hello报文发现邻居并且知道了对方的传输地址后，邻居之间就会开始尝试TCP三次握手（基于传输地址），并且交互LDP的初始化报文、标签映射报文等，这些报文都使用双方的传输地址作为源、目的IP地址。</li>
<li>LSR必须拥有到达邻居的传输地址的路由。</li>
<li>缺省情况下，公网的LDP传输地址等于设备的LSR ID，私网的传输地址等于接口的主IP地址。 </li>
<li>在接口视图下，使用<strong>mpls</strong> <strong>ldp</strong> <strong>transport-address</strong>命令，可以修改传输地址。</li>
</ul>
</blockquote>
<h3 id="LDP会话建立-会话建立与保持"><a href="#LDP会话建立-会话建立与保持" class="headerlink" title="LDP会话建立 - 会话建立与保持"></a>LDP会话建立 - 会话建立与保持</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h3 id="LDP邻居状态"><a href="#LDP邻居状态" class="headerlink" title="LDP邻居状态"></a>LDP邻居状态</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<h3 id="LDP会话状态"><a href="#LDP会话状态" class="headerlink" title="LDP会话状态"></a>LDP会话状态</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<blockquote>
<p>•LDP会话的状态：</p>
<p>▫NonExistent：表示LDP会话的最初状态。在此状态双方互相发送Hello消息，在收到TCP连接建立成功事件的触发后变为Initialized状态。 </p>
<p>▫Initialized：表示LDP会话处于初始化状态。</p>
<p>▫Open Sent：表示LDP会话进入初始化状态后，主动方给被动方发送了Initialized消息，并等待对方的回应。</p>
<p>▫Open Recv：表示LDP会话进入初始化状态后，当双方都收到了对方发送的KeepAlive消息后，LDP会话进入Operational状态。 </p>
<p>▫Operational：表示LDP会话建立成功。</p>
</blockquote>
<h2 id="LDP标签分发"><a href="#LDP标签分发" class="headerlink" title="LDP标签分发"></a>LDP标签分发</h2><h3 id="标签的发布和管理"><a href="#标签的发布和管理" class="headerlink" title="标签的发布和管理"></a>标签的发布和管理</h3><p>•在MPLS网络中，下游LSR决定标签和FEC的绑定关系，并将这种绑定关系发布给上游LSR。</p>
<p>•LDP通过发送标签请求和标签映射消息，在LDP对等体之间通告FEC和标签的绑定关系来建立LSP</p>
<p>•标签的发布和管理由标签发布方式、标签分配控制方式和标签保持方式来决定。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<h3 id="上游与下游"><a href="#上游与下游" class="headerlink" title="上游与下游"></a>上游与下游</h3><p>•MPLS根据数据的转发方向确定上、下游关系。标签报文从上游LSR发出，被下游LSR接收并处理。</p>
<p>•如图所示，对于到达192.168.3.0/24的LSP而言，R3是R2的下游LSR，R1是R2的上游LSR。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<h3 id="标签发布方式-DU模式"><a href="#标签发布方式-DU模式" class="headerlink" title="标签发布方式 - DU模式"></a>标签发布方式 - DU模式</h3><p>•DU模式</p>
<ul>
<li><p>对于一个特定的FEC，LSR无需从上游获得标签请求消息即进行标签分配与分发。</p>
</li>
<li><p>LSR会主动将自己为FEC捆绑的标签通告给上游邻居，无需邻居先发起请求再通告。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<blockquote>
<p>•标签分配：LSR从本地标签空间中取出一个标签与FEC绑定。</p>
<p>•标签分发：LSR将标签与FEC的绑定关系通知给上游LSR。</p>
<p>•标签发布方式为DU时，系统默认支持LDP为所有对等体分标签，即每个节点都可以向所有的对等体发布标签映射关系，不再区分上下游关系。因为在只给上游对等体分标签情况下，发送标签映射消息的时候，要根据路由信息对会话的上下游关系进行确认。</p>
</blockquote>
<h3 id="标签发布方式-DoD模式"><a href="#标签发布方式-DoD模式" class="headerlink" title="标签发布方式 - DoD模式"></a>标签发布方式 - DoD模式</h3><p>•DoD模式</p>
<p>​    ▫对于一个特定的FEC，LSR获得标签请求消息之后才进行标签分配与分发。</p>
<p>​    ▫一般情况下，对特定FEC的访问需求会触发标签请求消息。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•只有上游邻居向自己请求标签映射时，LSR才会通告标签映射给该邻居</p>
</blockquote>
<h3 id="标签分配控制方式-独立模式"><a href="#标签分配控制方式-独立模式" class="headerlink" title="标签分配控制方式 - 独立模式"></a>标签分配控制方式 - 独立模式</h3><p>独立（Independent）模式</p>
<p>▫本地LSR可以自主地分配一个标签绑定到某个FEC，并通告给上游LSR，而无需等待下游的标签。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•标签分配控制方式需要与标签发布方式结合使用：</p>
<ul>
<li><p>在使用DU作为标签分发方式的情况下，如图所示，R2和R3对192.168.4.0/24这条FEC，可以在上游LSR无请求，且自身没有收到下游LSR的标签绑定信息的情况下，主动向上游LSR通告标签绑定信息。</p>
</li>
<li><p>采用DoD作为标签发布方式时，如图所示，R2和R3对192.168.4.0/24这条FEC，只要收到上游LSR的标签请求消息，可以在自身没有收到下游LSR的标签绑定信息的情况下，向上游LSR通告标签绑定信息。</p>
</li>
</ul>
</blockquote>
<h3 id="标签分配控制方式-有序模式"><a href="#标签分配控制方式-有序模式" class="headerlink" title="标签分配控制方式 - 有序模式"></a>标签分配控制方式 - 有序模式</h3><p>•有序（Ordered）模式</p>
<p>▫对于LSR上某个FEC的标签映射，只有当该LSR已经具有此FEC下一跳的标签映射消息、或者该LSR就是此FEC的出节点时，该LSR才可以向上游发送此FEC的标签映射。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<blockquote>
<p>•当标签控制方式为Ordered，只有当LSR收到特定FEC下一跳发送的特定FEC标签映射消息或者LSR是LSP的出口节点时，LSR才可以向上游发送标签映射消息。</p>
<ul>
<li><p>当标签分发方式为DU时，如图所示，对于192.168.4.0/24这条FEC，不论上游LSR是否有请求，必须收到下游LSR对此FEC的标签绑定信息才向上游LSR发布标签绑定信息，所以必须由Egress LSR，也就是R4作为LSP建立的“起点”。</p>
</li>
<li><p>当标签发布方式采用DoD时，如图所示，对于192.168.4.0/24这条FEC，只有收到上游LSR请求的请求，且自身已经收到下游LSR的标签绑定信息的情况下，才向上游LSR通告标签绑定信息。因此，必须由Ingress LSR（R1）发起请求，逐跳请求到Egress LSR（R4），最终由R4开始，向上游建立LSP。</p>
</li>
</ul>
</blockquote>
<h3 id="标签保留-自由模式"><a href="#标签保留-自由模式" class="headerlink" title="标签保留 - 自由模式"></a>标签保留 - 自由模式</h3><p>自由（Liberal）模式</p>
<p>▫LSR收到的标签映射可能来自下一跳，也可能来自非下一跳。</p>
<p>▫对于从邻居LSR收到的标签映射，无论邻居LSR是不是自己的下一跳都保留。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<blockquote>
<p>•当基于IP网络部署MPLS时，LSR根据IP路由表判断接收到的标签映射是否来自下一跳。</p>
<p>•Liberal方式的最大优点在于路由发生变化时能够快速建立新的LSP进行数据转发，因为Liberal方式保留了所有的标签。缺点是需要分发和维护不必要的标签映射。</p>
<ul>
<li><p>DU标签分发方式下，如果采用Liberal保持方式，则R3保留所有LDP邻居 R2和R5发来的关于192.168.1.0/24这个FEC的标签，无论该R2和R5是否是IP路由表中到达192.168.1.0/24的下一跳。</p>
</li>
<li><p>DoD标签分发方式下，如果采用Liberal保持方式， LSR会向所有LDP邻居请求标签。但通常来说，DoD分发方式都会和Conservative保持方式搭配使用。</p>
</li>
</ul>
</blockquote>
<h3 id="标签保留-保守模式"><a href="#标签保留-保守模式" class="headerlink" title="标签保留 - 保守模式"></a>标签保留 - 保守模式</h3><p>•保守（Conservative）模式</p>
<p>▫对于从邻居LSR收到的标签映射，只有当邻居LSR是自己的下一跳时才保留。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<blockquote>
<p>•Conservative方式的优点在于只需保留和维护用于转发数据的标签，以达到节约标签的目的。</p>
<ul>
<li>当使用DU标签分发方式时，LSR可能从多个LDP邻居收到到同一网段的标签映射消息，如图中R3会分别从R2和R5收到网段192.168.1.0/24的标签映射消息。如果采用Conservative保持方式，则R3只保留下一跳R2发来的标签，丢弃非下一跳R5发来的标签。</li>
<li>当使用DoD标签分发方式时， LSR根据路由信息只向它的下一跳请求标签。</li>
</ul>
<p>•当网络拓扑变化引起下一跳邻居改变时：</p>
<ul>
<li>使用自由标签保持方式，LSR可以直接利用原来非下一跳邻居发来的标签，迅速重建LSP，但需要更多的内存和标签空间。</li>
<li>使用保守标签保持方式，LSR只保留来自下一跳邻居的标签，节省了内存和标签空间，但LSP的重建会比较慢。</li>
<li>保守标签保持方式通常与DoD方式一起，用于标签空间有限的LSR。</li>
</ul>
</blockquote>
<h3 id="PHP特性"><a href="#PHP特性" class="headerlink" title="PHP特性"></a>PHP特性</h3><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<p>•PHP（Penultimate Hop Popping，次末跳弹出），如果激活了PHP特性，那么egress节点在为本地路由分配标签的时候，会分配一个特殊标签—<strong>3</strong>，该标签被称为隐式空标签（Implicit NULL Label）。当LSR转发一个标签报文时，如果发现对应的出标签值为3，则LSR会将栈顶标签弹出，并将里面所封装的数据转发给下游LSR。</p>
<blockquote>
<p>•在标签发布时，R3为作为192.168.3.0/24这条FEC的Egress LSR。分配标签时，R3为该FEC分配了标签3，并将该标签绑定信息通告给R2。</p>
<p>•在数据转发时，R2作为到达192.168.3.0的次末跳（倒数第二跳），发现出标签值为3，于是将标签头部弹出，将IP报文转发给R3，而R3则仅需执行一次查询操作（查询FIB表）即可获得相应的转发信息，转发效率得到了提升。</p>
</blockquote>
<h3 id="隐式空标签与显式空标签-1"><a href="#隐式空标签与显式空标签-1" class="headerlink" title="隐式空标签与显式空标签 (1)"></a>隐式空标签与显式空标签 (1)</h3><p>•缺省情况下，Egress节点向倒数第二跳分配隐式空标签（implicit-null），即特殊标签3。</p>
<p>•但在部署QoS的场景下，标签被弹出后，其中的优先级也会一并丢失。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<h3 id="隐式空标签与显式空标签-2"><a href="#隐式空标签与显式空标签-2" class="headerlink" title="隐式空标签与显式空标签 (2)"></a>隐式空标签与显式空标签 (2)</h3><p>•显式空标签机制，Egress节点向倒数第二跳分配特殊标签0。</p>
<p>•R3在转发标签报文时，若出标签封装为0，则不会将标签头部弹出，标签头部中的QoS信息得以保存。R4在收到带0标签的报文的时候，直接弹出标签，不用去查找ILM表项。</p>
<p>•缺省情况下，Egress分配的是隐式空标签，通过label advertise explicit-null使能Egress节点向倒数第二跳分配显式空标签。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<blockquote>
<p>•在MPLS视图下，执行命令<strong>label advertise</strong> { <strong>explicit-null</strong> | <strong>implicit-null</strong> | <strong>non-null</strong> }，配置向倒数第二跳分配的标签。</p>
<p>•根据参数的不同，可以配置Egress向倒数第二跳分配不同的标签。</p>
<p>▫缺省情况下，使用的是<strong>implicit-null</strong>，Egress向倒数第二跳节点分配隐式空标签，值为3。</p>
<p>▫如果配置的是<strong>explicit-null</strong>，Egress节点向倒数第二跳分配显式空标签，值为0。当需要支持MPLS QoS属性时，可以选用<strong>explicit-null</strong>。</p>
<p>▫如果配置的是<strong>non-null</strong>，Egress向倒数第二跳正常分配标签，即分配的标签值不小于16。</p>
</blockquote>
<h2 id="LDP工作过程详解"><a href="#LDP工作过程详解" class="headerlink" title="LDP工作过程详解"></a>LDP工作过程详解</h2><h3 id="组网介绍"><a href="#组网介绍" class="headerlink" title="组网介绍"></a>组网介绍</h3><p>•网络中已经部署OSPF路由协议且各设备之间能够正常学习到对方的路由信息。</p>
<p>•已在各设备及相应接口上激活MPLS及LDP，且在相邻的设备之间已正常建立本地LDP会话。</p>
<p>•所有LSR均采用DU + Independent +Liberal方式。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<blockquote>
<p>•华为设备目前缺省模式为下游自主方式（DU）＋ 有序标签分配控制方式（Ordered）＋ 自由标签保持方式（Liberal）。</p>
<p>•对于从R1进入，到达192.168.4.0/24的数据，R1为Ingress LSR，R4为Egress LSR。</p>
</blockquote>
<h3 id="标签分发-Egress-LSR"><a href="#标签分发-Egress-LSR" class="headerlink" title="标签分发 - Egress LSR"></a>标签分发 - Egress LSR</h3><p>•R4直连网段192.168.4.0/24，R4将主动为到达该网段的路由分配标签，如1041，并主动通过LDP协议报文将标签映射通告给LDP对等体R2和R3。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<blockquote>
<p>•注：缺省情况下，根据32位的主机IP路由触发LDP建立LSP。可以通过手工配置触发非32位路由的LSP建立。</p>
</blockquote>
<h3 id="标签分发-Transit-LSR"><a href="#标签分发-Transit-LSR" class="headerlink" title="标签分发 - Transit LSR"></a>标签分发 - Transit LSR</h3><p>•以R2为例，在其路由表中，192.168.4.0/24路由的下一跳为R4，当它从R4收到关于192.168.4.0/24的标签映射通告时，由于该通告来自下游LDP邻居，因此这将触发它自己为该路由分配标签1021，并将标签映射通告给LDP邻居（如R1）。R3同理。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<h3 id="标签分发-Ingress-LSR"><a href="#标签分发-Ingress-LSR" class="headerlink" title="标签分发 - Ingress LSR"></a>标签分发 - Ingress LSR</h3><p>•R1收到LDP邻居R2及R3通告过来的关于192.168.4.0/24路由的标签映射后，将这两个标签都<strong>存储</strong>起来，但是由于在自己的路由表中，到达192.168.4.0/24的下一跳是R2，因此当前它只会<strong>使用</strong>R2所通告的标签1021。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<blockquote>
<p>•注：当R2发生故障时，OSPF路由将会重新收敛，此时R1的路由表中192.168.4.0/24路由的下一跳将会切换至R3，此时R1将启用R3所通告的、关于192.168.4.0/24的标签。</p>
</blockquote>
<h3 id="标签转发-Ingress-LSR"><a href="#标签转发-Ingress-LSR" class="headerlink" title="标签转发 - Ingress LSR"></a>标签转发 - Ingress LSR</h3><p>R1作为Ingress LSR，需要对接收的IP报文执行Push操作压入标签，并进行标签转发。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<blockquote>
<p>•当R1收到发往192.168.4.1的IP报文时，首先在其FIB表中查询该目的IP地址，它发现所匹配的表项的Tunnel ID为非0，因此继续在NHLFE中查询该Tunnel ID，然后意识到需要将对该IP报文压入标签并进行标签转发，出接口为GE0/0/0、下一跳为R2、出站标签为1021，于是为报文插入标签头部并转发出去。</p>
</blockquote>
<h3 id="标签转发-Transit-LSR"><a href="#标签转发-Transit-LSR" class="headerlink" title="标签转发 - Transit LSR"></a>标签转发 - Transit LSR</h3><p>•R2作为Transit LSR，需要对接收的IP报文执行Swap操作交换标签，并进行标签转发。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<blockquote>
<p>•当R2收到携带1021标签的标签报文时，查询ILM，根据ILM对应到NHLFE中的表项。于是，R2对该标签报文通过swap操作将标签更换为1041，并从相应的接口转发出去。</p>
</blockquote>
<h3 id="标签转发-Egress-LSR"><a href="#标签转发-Egress-LSR" class="headerlink" title="标签转发 - Egress LSR"></a>标签转发 - Egress LSR</h3><p>R4作为Egress LSR，需要对接收的IP报文执行Pop操作交换标签，并进行IP转发。</p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<blockquote>
<p>•当R4收到携带1041标签的标签报文时，查询ILM，根据ILM查询到操作为Pop。于是，R4对该标签报文通过Pop操作将最外层标签剥离，此时该报文已经变成了标准IP报文，R4将对该IP报文执行标准的IP转发流程。</p>
<p>•R4在转发该报文时分别查询了LFIB和FIB表，作为最后Egress LSR，其存在转发效率提升的可能性，怎么做？</p>
</blockquote>
<h3 id="在MPLS中，运行LDP协议的LSR的操作小结"><a href="#在MPLS中，运行LDP协议的LSR的操作小结" class="headerlink" title="在MPLS中，运行LDP协议的LSR的操作小结"></a>在MPLS中，运行LDP协议的LSR的操作小结</h3><p>•LSR首先通过运行IGP协议（例如OSPF、IS-IS等）来构建路由表、FIB表；</p>
<p>•LDP根据相应的模式，为路由表中的路由前缀（FEC）分配标签；</p>
<p>•LDP根据相应的模式，将自己为路由前缀分配的标签，通过LDP标签映射报文通告给LDP邻居；</p>
<p>•LSR将自己为路由前缀分配的标签，以及LDP邻居为该路由前缀通告的标签存储起来，并与出接口、下一跳地址等信息形成关联（标签转发表项）；</p>
<p>•当LSR转发到达目的网络的标签报文时，所使用的出站标签总是下游LDP邻居所通告的标签，此处所指的下游邻居，是设备的路由表中到达该目的网络的下一跳设备。</p>
<h1 id="3-LDP基础配置"><a href="#3-LDP基础配置" class="headerlink" title="3.LDP基础配置"></a>3.LDP基础配置</h1><h2 id="LDP基本配置命令-1"><a href="#LDP基本配置命令-1" class="headerlink" title="LDP基本配置命令 (1)"></a>LDP基本配置命令 (1)</h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/29.png"></p>
<h2 id="LDP基本配置命令-2"><a href="#LDP基本配置命令-2" class="headerlink" title="LDP基本配置命令 (2)"></a><strong>LDP基本配置命令 (2)</strong></h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/30.png"></p>
<blockquote>
<p>•BGP路由也可以触发LDP LSP的建立，但此部分内容不在本课程的讨论范围内。</p>
</blockquote>
<h2 id="LDP基本配置命令-3"><a href="#LDP基本配置命令-3" class="headerlink" title="LDP基本配置命令 (3)"></a>LDP基本配置命令 (3)</h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/31.png"></p>
<h2 id="配置案例"><a href="#配置案例" class="headerlink" title="配置案例"></a>配置案例</h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/32.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/33.png"></p>
<p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/34.png"></p>
<h2 id="检查配置-查看LSP"><a href="#检查配置-查看LSP" class="headerlink" title="检查配置 - 查看LSP"></a>检查配置 - 查看LSP</h2><p><img src="/2021/06/23/IPadv-MPLSLDP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/35.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选）以下哪条命令用于查看已经为特定FEC分配的标签？（    ）</p>
<p>A、display mpls ldp</p>
<p>B、display mpls ldp interface</p>
<p><strong>C、display mpls lsp</strong></p>
<p>D、display mpls ldp session</p>
<p>2.（单选）华为设备默认的标签发布方式、标签分配控制方式和标签保持方式的组合是（   ）</p>
<p>A、DU + Independent + Conservative</p>
<p><strong>B、DU + Ordered+ Liberal</strong></p>
<p>C、DoD + Independent+ Liberal</p>
<p>D、DoD + Ordered + Conservative</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MPLS体系有多种标签分配协议，LDP标签分配协议是这些协议中使用较广的一种。</p>
<p>•LDP是LSR之间协商标签含义的过程。LDP协议使用发现、会话、通告、通知四类报文进行会话的建立和标签的分发。</p>
<p>•LDP通过标签发布方式、标签分配控制方式和标签保持方式来决定标签的发布和管理。华为数通产品默认的方式为：下游自主标签发布方式+有序标签分配控制方式+自由标签保持方式。</p>
<p>•利用LDP可以实现将网络层的路由信息直接映射到标签信息，进而建立起标签交换路径（LSP）。LSR之间将依据本地转发表中对应于一个特定FEC的入标签、下一跳节点、出标签等信息连接在一起，从而形成跨越整个MPLS域的标签交换路径。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IPadv-MPLS原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-23T13:09:54+08:00">
                2021-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•90年代中期，互联网流量的快速增长。传统IP报文依赖路由器查询路由表转发，但由于硬件技术存在限制导致转发性能低，路由器的查表转发成为了网络数据转发的瓶颈。 </p>
<p>•因此，旨在提高路由器转发速度的MPLS（Multi-Protocol Label Switching，多协议标签交换）被提出。与传统IP路由方式相比，MPLS在数据转发时，只在网络边缘分析IP报文头，在网络内部采用更为高效的标签（Label）转发，节约了处理时间。</p>
<p>•随着设备硬件性能不断提升，MPLS在提高数据转发速度上的优势逐渐弱化，但其支持多层标签嵌套和设备内转控分离的特点，使其在VPN（Virtual Private Network，虚拟私有网络）、QoS（Quality of Service，服务质量）等新兴应用中得到广泛应用。</p>
<p>•本课程主要介绍MPLS的工作原理以及标签的转发流程，静态标签交换路径的配置方法等。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述MPLS的基本概念及术语</p>
<p>▫描述MPLS的工作原理</p>
<p>▫实现静态LSP的配置</p>
<p>▫描述MPLS的转发流程</p>
<h1 id="1-MPLS基础"><a href="#1-MPLS基础" class="headerlink" title="1.MPLS基础"></a>1.MPLS基础</h1><h2 id="MPLS概述"><a href="#MPLS概述" class="headerlink" title="MPLS概述"></a>MPLS概述</h2><h3 id="传统IP路由转发"><a href="#传统IP路由转发" class="headerlink" title="传统IP路由转发"></a>传统IP路由转发</h3><p>•传统的IP转发采用的是逐跳转发。数据报文经过每一台路由器，都要被解封装查看报文网络层信息，然后根据路由最长匹配原则查找路由表指导报文转发。各路由器重复进行解封装查找路由表和再封装的过程，所以转发性能低。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h3 id="MPLS基本概念"><a href="#MPLS基本概念" class="headerlink" title="MPLS基本概念"></a>MPLS基本概念</h3><p>•MPLS位于TCP/IP协议栈中的数据链路层和网络层之间，可以向所有网络层提供服务。</p>
<p>•通过在数据链路层和网络层之间增加额外的MPLS头部，基于MPLS头部实现数据快速转发。</p>
<p>•本课程仅介绍MPLS在IP网络中的应用。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•MPLS起源于IPv4（Internet Protocol version 4），其核心技术可扩展到多种网络协议，包括IPv6（Internet Protocol version 6）、IPX（Internet Packet Exchange）、Appletalk、DECnet、CLNP（Connectionless Network Protocol）等。MPLS中的“Multiprotocol”指的就是支持多种网络协议。</p>
<p>•MPLS以标签交换替代IP转发。标签是一个短而定长的、只具有本地意义的标识符。</p>
</blockquote>
<h2 id="MPLS术语"><a href="#MPLS术语" class="headerlink" title="MPLS术语"></a>MPLS术语</h2><h3 id="MPLS术语介绍-LSR与MPLS域"><a href="#MPLS术语介绍-LSR与MPLS域" class="headerlink" title="MPLS术语介绍 - LSR与MPLS域"></a>MPLS术语介绍 - LSR与MPLS域</h3><p>•MPLS域（MPLS Domain）：一系列连续的运行MPLS的网络设备构成了一个MPLS域。</p>
<p>•LSR（Label Switching Router，标签交换路由器）：支持MPLS的路由器（实际上也指支持MPLS的交换机或其他网络设备）。位于MPLS域边缘、连接其它网络的LSR称为边沿路由器LER（Label Edge Router），区域内部的LSR称为核心LSR（Core LSR）。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<h3 id="MPLS术语介绍-LSR分类"><a href="#MPLS术语介绍-LSR分类" class="headerlink" title="MPLS术语介绍 - LSR分类"></a>MPLS术语介绍 - LSR分类</h3><p>•除了根据LSR在MPLS域中的位置进行分类之外，还可以根据对数据处理方式的不同进行分类：</p>
<p>▫入站LSR（Ingress LSR）：通常是向IP报文中压入MPLS头部并生成MPLS报文的LSR。</p>
<p>▫中转LSR（Transit LSR）：通常是将MPLS报文进行例如标签置换操作，并将报文继续在MPLS域中转发的LSR。</p>
<p>▫出站LSR（Egress LSR）：通常是将MPLS报文中MPLS头部移除，还原为IP报文的LSR。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<h3 id="MPLS术语介绍-FEC"><a href="#MPLS术语介绍-FEC" class="headerlink" title="MPLS术语介绍 - FEC"></a>MPLS术语介绍 - FEC</h3><p>•FEC（Forwarding Equivalence Class，转发等价类）是一组具有某些共性的数据流的集合，这些数据流在转发过程中被网络节点以相同方式处理。</p>
<ul>
<li>在MPLS网络中，FEC可以通过多种方式划分，例如基于目的IP地址及网络掩码、DSCP等特征来划分。</li>
<li>数据属于哪一个LSP，由数据进入MPLS域时的Ingress LSR决定。</li>
<li>MPLS标签通常是与FEC相对应的，必须有某种机制使得网络中的LSR获得关于某FEC的标签信息。</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<blockquote>
<p>•在传统的采用最长匹配算法的IP转发中，匹配到同一条路由的所有报文就是一个转发等价类。</p>
<p>•在MPLS中，关于FEC最常见的例子是：目的IP地址匹配同一条IP路由的报文被认为属于同一个FEC。</p>
</blockquote>
<h3 id="MPLS术语介绍-LSP"><a href="#MPLS术语介绍-LSP" class="headerlink" title="MPLS术语介绍 - LSP"></a>MPLS术语介绍 - LSP</h3><p>•LSP（Label Switched Path，标签交换路径）是标签报文穿越MPLS网络到达目的地所走的路径。</p>
<p>•同一个FEC的报文通常采用相同的LSP穿越MPLS域，所以对同一个FEC，LSR总是用相同的标签转发。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<blockquote>
<p>•一条LSP包含一台入站LSR、一台出站LSR以及数量可变的中转LSR，因此LSP也可以看做是这些LSR的有序集合。</p>
<p>•LSP需要在数据转发开始前建立完成，只有这样报文才能顺利穿越MPLS域。</p>
<p>•LSP可通过静态和动态两种方式建立。</p>
<p>•需要注意的是，LSP是一个从“起点”到“终点”的单向路径，若需要双向数据互通，则需要在双方之间建立双向的LSP。</p>
</blockquote>
<h2 id="MPLS标签"><a href="#MPLS标签" class="headerlink" title="MPLS标签"></a>MPLS标签</h2><h3 id="MPLS标签-1"><a href="#MPLS标签-1" class="headerlink" title="MPLS标签"></a>MPLS标签</h3><p>•IP报文进入MPLS域之前，会被入站LSR压入MPLS头部（又叫MPLS标签），形成一个MPLS标签报文。一个标签报文可以包含一个或多个MPLS标签。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<blockquote>
<p>•EXP字段在早期的MPLS标准中被定义，意为试验性的字段，但实际上该字段主要被用于CoS。为了避免歧义，RFC5462重新定义了该字段，命名为流分类（Traffic Class）。</p>
</blockquote>
<h3 id="MPLS标签栈"><a href="#MPLS标签栈" class="headerlink" title="MPLS标签栈"></a>MPLS标签栈</h3><p>•MPLS支持一层或多层标签头部，这些标签头部的有序集合被称为标签栈（Label Stack）。</p>
<p>•当标签栈中存在多个标签时，这些标签的顺序是非常讲究的：</p>
<p>​    ▫最靠近二层头部的标签是栈顶标签，标签中的S字段为0。</p>
<p>​    ▫最靠近IP头部的标签是栈底标签，标签中的S字段为1。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<blockquote>
<p>•当上层为MPLS标签栈时，以太网头部中的Type字段为0x8847，PPP头部中的Protocol字段为0x8281。</p>
</blockquote>
<h3 id="标签空间"><a href="#标签空间" class="headerlink" title="标签空间"></a>标签空间</h3><p>•标签是一个短而定长的、只具有本地意义的标识符。标签空间就是指标签的取值范围。标签值的范围及规划如下：</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h3 id="MPLS标签的处理"><a href="#MPLS标签的处理" class="headerlink" title="MPLS标签的处理"></a>MPLS标签的处理</h3><p>LSR对标签的操作类型包括标签压入（Push）、标签交换（Swap）和标签弹出（Pop）。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<h1 id="2-MPLS转发"><a href="#2-MPLS转发" class="headerlink" title="2.MPLS转发"></a>2.MPLS转发</h1><h2 id="MPLS转发概述"><a href="#MPLS转发概述" class="headerlink" title="MPLS转发概述"></a>MPLS转发概述</h2><p>•MPLS转发的本质就是将数据归到对应的FEC并按照提前建立好的LSP进行转发。</p>
<ul>
<li><p>对于整个MPLS域，LSP是某一给定的FEC进入域和离开域的路径，可以看成是LSR的有序集合。</p>
</li>
<li><p>对于单台LSR，需要建立标签转发表，用标签来标识FEC，并绑定相应的标签处理和转发等行为。</p>
</li>
</ul>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<blockquote>
<p>•同一个FEC，若进入MPLS域的Ingress LSR（入站LSR）不同，转发时的LSP也不相同。</p>
<p>•同一个FEC，LSR的处理方式相同，不论这个FEC来自哪里（进入设备的接口）。</p>
<p>•LSR的转发动作决定了LSP，而标签转发表确定转发动作，所以建立标签转发表也可以理解为建立LSP。</p>
<p>•如图所示，因为有着相同的目的地，所以这三份数据属于同一个转发等价类FEC1。同时由于入站LSR不同，这些数据将分别在LSP1、LSP2和LSP3上被转发。因为标签仅具有本地意义，所以每台LSR上给同一FEC分配的标签，可以相同，也可以不同。</p>
</blockquote>
<h2 id="MPLS体系结构"><a href="#MPLS体系结构" class="headerlink" title="MPLS体系结构"></a>MPLS体系结构</h2><p>MPLS的体系结构由控制平面 (Control Plane)和转发平面 (Forwarding Plane)组成。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<blockquote>
<p>•控制平面：</p>
<ul>
<li><p>控制平面是无连接的，主要功能是负责产生和维护路由信息以及标签信息。</p>
</li>
<li><p>控制平面包括：</p>
<ul>
<li>路由信息表RIB（Routing Information Base）：由IP路由协议（IP Routing Protocol）、静态路由和直连路由共同生成，用于选择路由。</li>
<li>标签信息表LIB（Label Information Base）：用于管理标签信息，LIB中的表项可由标签交换协议（LDP、RSVP等协议）或静态配置生成。</li>
</ul>
</li>
</ul>
<p>•转发平面：</p>
<ul>
<li><p>转发平面也称为数据平面，是面向连接的， 主要功能是负责普通IP报文的转发以及带MPLS标签报文的转发。</p>
</li>
<li><p>转发平面包括：</p>
<ul>
<li>转发信息表FIB（Forwarding Information Base）：从RIB提取必要的路由信息生成，负责普通IP报文的转发。</li>
<li>标签转发信息表LFIB（Label Forwarding Information Base）：简称标签转发表，负责带MPLS标签报文的转发。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="控制平面与转发平面"><a href="#控制平面与转发平面" class="headerlink" title="控制平面与转发平面"></a>控制平面与转发平面</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<h2 id="LSP建立原则"><a href="#LSP建立原则" class="headerlink" title="LSP建立原则"></a>LSP建立原则</h2><p>•当网络层协议为IP协议时，FEC所对应的路由必须存在于LSR的IP路由表中，否则该FEC的标签转发表项不生效。</p>
<p>•LSR用标签标识指定FEC，所以该FEC的数据被发送至LSR时，必须携带正确的标签，才能被LSR正确的处理。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<h2 id="LSP建立方式"><a href="#LSP建立方式" class="headerlink" title="LSP建立方式"></a>LSP建立方式</h2><p>•MPLS需要为报文事先分配好标签，建立一条LSP，才能进行报文转发。LSP分为静态LSP和动态LSP两种。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•静态LSP：</p>
<ul>
<li>由于静态LSP各节点上不能相互感知到整个LSP的情况，因此静态LSP是一个本地的概念。</li>
</ul>
<p>•动态LSP：</p>
<ul>
<li>其他标签分布协议：<ul>
<li>RSVP-TE：Resource Reservation Protocol Traffic Engineering，它是对RSVP的扩展，用于建立基于约束的LSP。它拥有普通LDP LSP没有的功能，如发布带宽预留请求、带宽约束、链路颜色和显式路径等。</li>
<li>MP-BGP：Multiprotocol Border Gateway Protocol，MP-BGP是在BGP协议基础上扩展的协议。MP-BGP支持为MPLS VPN业务中私网路由和跨域VPN的标签路由分配标签。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="MPLS标签转发"><a href="#MPLS标签转发" class="headerlink" title="MPLS标签转发"></a>MPLS标签转发</h2><p>LSR处理报文时主要根据FTN、 NHLFE和ILM。</p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•Tunnel ID：为了给使用隧道的上层应用（如VPN、路由管理）提供统一的接口，系统自动为隧道分配了一个ID，也称为Tunnel ID。该Tunnel ID的长度为32比特，只是本地有效。在MPLS转发过程中，FIB、ILM和NHLFE表项是通过Tunnel ID关联的。</p>
</blockquote>
<h2 id="Ingress-LSR的处理"><a href="#Ingress-LSR的处理" class="headerlink" title="Ingress LSR的处理"></a>Ingress LSR的处理</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<blockquote>
<p>•在Ingress LSR，通过查询FIB表（得到FTN信息）和NHLFE表指导报文的转发。</p>
<p>•当IP报文进入MPLS域时，首先查看FIB表，检查目的IP地址对应的Tunnel ID值是否为0x0。</p>
<p>​    ▫如果Tunnel ID值为0x0，则进入正常的IP转发流程。</p>
<p>​    ▫如果Tunnel ID值不为0x0，则进入MPLS转发流程。</p>
</blockquote>
<h2 id="Transit-LSR的处理"><a href="#Transit-LSR的处理" class="headerlink" title="Transit LSR的处理"></a>Transit LSR的处理</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<blockquote>
<p>•在Transit LSR，通过查询ILM表和NHLFE表指导MPLS报文的转发。</p>
</blockquote>
<h2 id="Egress-LSR的处理"><a href="#Egress-LSR的处理" class="headerlink" title="Egress LSR的处理"></a>Egress LSR的处理</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<blockquote>
<p>•在Egress LSR，通过查询ILM表指导MPLS报文的转发。</p>
</blockquote>
<h2 id="MPLS详细转发过程"><a href="#MPLS详细转发过程" class="headerlink" title="MPLS详细转发过程"></a>MPLS详细转发过程</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<h1 id="3-静态LSP配置"><a href="#3-静态LSP配置" class="headerlink" title="3.静态LSP配置"></a>3.静态LSP配置</h1><h2 id="MPLS基本配置命令"><a href="#MPLS基本配置命令" class="headerlink" title="MPLS基本配置命令"></a>MPLS基本配置命令</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<h2 id="静态LSP配置命令-1"><a href="#静态LSP配置命令-1" class="headerlink" title="静态LSP配置命令 (1)"></a>静态LSP配置命令 (1)</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<blockquote>
<p>•out-label占用的是下游LSR的标签空间，而下游空间采用的标签分发方式不确定，所以out-label的标签空间为16~1048575。</p>
<p>•in-label占用的是当前LSR的标签空间，采用静态LSP时，标签空间为16~1023。</p>
</blockquote>
<h2 id="静态LSP配置命令-2"><a href="#静态LSP配置命令-2" class="headerlink" title="静态LSP配置命令 (2)"></a>静态LSP配置命令 (2)</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<h2 id="静态LSP配置案例"><a href="#静态LSP配置案例" class="headerlink" title="静态LSP配置案例"></a>静态LSP配置案例</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<h2 id="静态LSP配置案例-检查配置"><a href="#静态LSP配置案例-检查配置" class="headerlink" title="静态LSP配置案例 - 检查配置"></a>静态LSP配置案例 - 检查配置</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<h2 id="静态LSP配置案例-抓包分析"><a href="#静态LSP配置案例-抓包分析" class="headerlink" title="静态LSP配置案例 - 抓包分析"></a>静态LSP配置案例 - 抓包分析</h2><p><img src="/2021/06/23/IPadv-MPLS%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选）下面对MPLS头部的描述正确的是 （   )</p>
<p><strong>A.MPLS头部的长度为32比特</strong></p>
<p>B.MPLS头部中的Label字段取值范围为0~65535</p>
<p><strong>C.MPLS可以实现多层MPLS头部的嵌套</strong></p>
<p>D.可以通过MPLS头部中的max_hop字段防止标签报文被无限制转发</p>
<p>2.（单选）在配置Transit LSR上的静态LSP时，入标签和出标签的取值均为16~1023 </p>
<p>A.正确</p>
<p><strong>B.错误</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•MPLS最初是为了解决传统IP路由器查表转发速度慢而被提出的，是一种通过标签头部实现快速转发的技术。</p>
<p>•MPLS标签是一个短而定长的、只具有本地意义的标识符，用于唯一标识一个分组所属的FEC。LSR对标签的操作类型包括标签压入、标签交换和标签弹出。</p>
<p>•MPLS包含控制平面和数据平面，控制平面主要负责路由信息的传递和标签的分发，数据平面主要负责数据的转发。</p>
<p>•随着技术的发展，MPLS在数据转发速度上的优势逐渐弱化，但其特性使其在VPN领域得到广泛应用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" itemprop="url">IPadv-IGP高级特性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-31T11:38:08+08:00">
                2021-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•OSPF和IS-IS都是基于链路状态的内部网关路由协议，运行这两种协议的路由器通过同步LSDB，采用SPF算法计算最优路由。</p>
<p>•当网络拓扑发生变化时，OSPF和IS-IS支持多种快速收敛和保护机制，能够降低网络故障导致的流量丢失。</p>
<p>•为了实现对路由表规模的控制，OSPF和IS-IS支持路由选路及路由信息的控制，能够减少特定路由器路由表的大小。</p>
<p>•本节课程将介绍OSPF和IS-IS的高级特性，包括：快速收敛机制、路由控制等。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述OSPF和IS-IS的各种快速收敛的技术</p>
<p>▫实现OSPF和IS-IS等价路由的配置</p>
<p>▫实现OSPF和IS-IS发布缺省路由</p>
<p>▫描述OSPF和IS-IS多进程使用场景</p>
<p>▫描述OSPF转发地址的使用场景</p>
<p>▫描述IS-IS的LSP分片扩展的工作原理</p>
<h1 id="1-OSPF快速收敛"><a href="#1-OSPF快速收敛" class="headerlink" title="1.OSPF快速收敛"></a>1.OSPF快速收敛</h1><h2 id="OSPF快速收敛概述"><a href="#OSPF快速收敛概述" class="headerlink" title="OSPF快速收敛概述"></a>OSPF快速收敛概述</h2><p>•OSPF快速收敛是为了提高路由的收敛速度而做的扩展特性，包括：PRC（Partial Route Calculation，部分路由计算）和智能定时器。</p>
<p>•同时，OSPF支持故障恢复快速收敛，例如通过OSPF IP FRR（Fast reroute，快速重路由）实现备份链路的快速切换，也可以与BFD联动实现对故障的快速感知。</p>
<h2 id="PRC"><a href="#PRC" class="headerlink" title="PRC"></a>PRC</h2><p>•PRC的工作原理：当网络上路由发生变化的时候，只对发生变化的路由进行重新计算。</p>
<p>•PRC不计算节点路径，而是根据SPF算法算出来的最短路径树来更新路由。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/1.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/2.png"></p>
<blockquote>
<p>•注意：在华为设备上，OSPF的PRC功能默认开启。</p>
</blockquote>
<h2 id="智能定时器"><a href="#智能定时器" class="headerlink" title="智能定时器"></a>智能定时器</h2><p>•智能定时器是在进行SPF计算和产生LSA的时候用到的一种定时器。</p>
<p>•智能定时器既可以对少量的外界突发事件进行快速响应，又可以避免过度的占用CPU。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/3.png"></p>
<blockquote>
<p>•如果触发路由计算的时间间隔较长，同样会影响网络的收敛速度。</p>
<p>•智能定时器首次超时时间是一个固定的时间。如果在定时器超时前，又有触发定时器的事件发生，则该定时器下一次的超时时间会增加。</p>
</blockquote>
<h2 id="智能定时器的基础配置命令-1"><a href="#智能定时器的基础配置命令-1" class="headerlink" title="智能定时器的基础配置命令 (1)"></a>智能定时器的基础配置命令 (1)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/4.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf] <strong>lsa**</strong>-originate-interval** { <strong>0</strong> | { <strong>intelligent-timer</strong> <em>max-interval</em> <em>start-interval</em> <em>hold-interval</em> | <strong>other-type</strong> <em>interval</em> } }</p>
<p>​    ▫<strong>0</strong>：指定LSA更新的时间间隔为0，即取消LSA的5秒的更新时间间隔。</p>
<p>​    ▫<strong>intelligent-timer</strong>：指定通过智能定时器设置OSPF Router LSA和Network LSA的更新间隔时间。</p>
<p>​    ▫<em>max-interval</em>：指定更新OSPF LSA的最长间隔时间。整数形式，取值范围是1～120000，单位是毫秒。缺省值是5000。</p>
<p>​    ▫<em>start-interval</em>：指定更新OSPF LSA的初始间隔时间。整数形式，取值范围是0～60000，单位是毫秒。缺省值是500。</p>
<p>​    ▫<em>hold-interval</em>：指定更新OSPF LSA的基数间隔时间。整数形式，取值范围是1～60000，单位是毫秒。缺省值是1000。</p>
<p>​    ▫<strong>other-type</strong>：指定设置除OSPF Router LSA和Network LSA外LSA的更新间隔时间。</p>
<p>​    ▫<em>interval</em>：指定LSA更新的时间间隔。整数形式，取值范围是0～10，单位是秒。缺省值是5。</p>
</blockquote>
<h2 id="智能定时器的基础配置命令-2"><a href="#智能定时器的基础配置命令-2" class="headerlink" title="智能定时器的基础配置命令 (2)"></a>智能定时器的基础配置命令 (2)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/5.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>lsa**</strong>-arrival-interval** { <em>interval</em> | <strong>intelligent-timer</strong> <em>max-interval</em> <em>start-interval</em> <em>hold-interval</em> }</p>
<p>​    ▫<em>interval</em>：指定LSA接收的时间间隔。整数形式，取值范围是0～10000，单位是毫秒。</p>
<p>​    ▫<strong>intelligent-timer</strong>：指定通过智能定时器设置LSA接收的间隔时间。</p>
<p>​    ▫<em>max-interval</em>：指定接收OSPF LSA的最长间隔时间。整数形式，取值范围是1～120000，单位是毫秒。缺省值是1000。</p>
<p>​    ▫<em>start-interval</em>：指定接收OSPF LSA的初始间隔时间。整数形式，取值范围是0～60000，单位是毫秒。缺省值是500。</p>
<p>​    ▫<em>hold-interval</em>：指定接收OSPF LSA的基数间隔时间。整数形式，取值范围是1～60000，单位是毫秒。缺省值是500。</p>
</blockquote>
<h2 id="智能定时器的基础配置命令-3"><a href="#智能定时器的基础配置命令-3" class="headerlink" title="智能定时器的基础配置命令 (3)"></a>智能定时器的基础配置命令 (3)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/6.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>spf**</strong>-schedule-interval** { <em>interval1</em> | <strong>intelligent-timer</strong> <em>max-interval</em> <em>start-interval</em> <em>hold-interval</em> | <strong>millisecond</strong> <em>interval2</em> }</p>
<p>​    ▫<em>interval1**：</em>指定OSPF SPF计算间隔时间。整数形式，取值范围是1～10，单位是秒。</p>
<p>​    ▫<strong>intelligent-timer</strong>：指定通过智能定时器设置OSPF SPF计算的间隔时间。</p>
<p>​    ▫<em>max-interval</em>：指定OSPF SPF计算的最长间隔时间。整数形式，取值范围是1～120000，单位是毫秒。缺省值是10000。</p>
<p>​    ▫<em>start-interval</em>：指定OSPF SPF计算的初始间隔时间。整数形式，取值范围是1～60000，单位是毫秒。缺省值是500。</p>
<p>​    ▫<em>hold-interval</em>：指定OSPF SPF计算的基数间隔时间。整数形式，取值范围是1～60000，单位是毫秒。缺省值是1000。</p>
<p>​    ▫<strong>millisecond</strong> <em>interval2</em>：指定OSPF SPF计算间隔时间。整数形式，取值范围是1～10000，单位是毫秒。</p>
</blockquote>
<h2 id="OSPF-IP-FRR"><a href="#OSPF-IP-FRR" class="headerlink" title="OSPF IP FRR"></a>OSPF IP FRR</h2><p>•OSPF IP FRR（Fast reroute，快速重路由）是动态IP FRR，利用LFA（Loop-Free Alternates）算法预先计算出备份路径，保存在转发表中，以备在故障时将流量快速切换到备份链路上，保证流量不中断，从而达到流量保护的目的，该功能可将故障恢复时间降低到50ms以内。</p>
<p>•LFA计算备份链路的基本思路是：</p>
<p>​    ▫以可提供备份链路的邻居为根节点，利用SPF算法计算出到目的节点的最短距离。然后，按照不等式计算出开销最小且无环的备份链路。</p>
<h2 id="OSPF-IP-FRR组网应用"><a href="#OSPF-IP-FRR组网应用" class="headerlink" title="OSPF IP FRR组网应用"></a>OSPF IP FRR组网应用</h2><p>OSPF IP FRR的流量保护分为链路保护和节点链路双保护。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/7.png"></p>
<blockquote>
<p>•节点链路双保护：</p>
<p>​    ▫如图：流量从设备S到D进行转发，网络开销值满足节点链路保护公式，可保证当主链路故障后，设备S将流量切换到备份链路S到N后可以继续向下游转发，确保流量中断小于50ms。</p>
<p>•OSPF IP FRR的流量保护分为链路保护和节点链路双保护。</p>
<p>​    ▫当需要保护的对象是经过特定链路的流量时，流量保护类型为链路保护。</p>
<p>​    ▫当需要保护的对象是经过特定设备的流量时，流量保护类型为节点链路双保护。节点保护优先级高于链路保护。</p>
</blockquote>
<h2 id="OSPF-IP-FRR的基础配置命令"><a href="#OSPF-IP-FRR的基础配置命令" class="headerlink" title="OSPF IP FRR的基础配置命令"></a>OSPF IP FRR的基础配置命令</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/8.png"></p>
<h2 id="OSPF-IP-FRR配置举例"><a href="#OSPF-IP-FRR配置举例" class="headerlink" title="OSPF IP FRR配置举例"></a>OSPF IP FRR配置举例</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/9.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/10.png"></p>
<h3 id="查看OSPF-IP-FRR配置结果"><a href="#查看OSPF-IP-FRR配置结果" class="headerlink" title="查看OSPF IP FRR配置结果"></a>查看OSPF IP FRR配置结果</h3><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/11.png"></p>
<h2 id="OSPF与BFD联动"><a href="#OSPF与BFD联动" class="headerlink" title="OSPF与BFD联动"></a>OSPF与BFD联动</h2><p>•网络上的链路故障或拓扑变化都会导致设备重新进行路由计算，所以缩短路由协议的收敛时间对于提高网络的性能是非常重要的。</p>
<p>•OSPF与BFD联动就是将BFD和OSPF关联起来，一旦与邻居之间的链路出现故障，BFD对链路故障的快速感应能够加快OSPF对于网络拓扑变化的响应。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/12.png"></p>
<blockquote>
<p>•OSPF通过周期性的向邻居发送Hello报文来实现邻居检测，检测到故障所需时间比较长，超过1秒钟（默认通过OSPF Dead Timer超时判断邻居失效，缺省为40s）。随着科技的发展，语音、视频及其它点播业务应用广泛，而这些业务对于丢包和延时非常敏感，当数据达到吉比特速率级时，较长的检测时间会导致大量数据丢失，无法满足电信级网络高可靠性的需求。</p>
<p>•为了解决上述问题，配置指定进程或指定接口的OSPF与BFD联动功能，可以快速检测链路的状态，故障检测时间可以达到毫秒级，提高链路状态变化时OSPF的收敛速度。</p>
</blockquote>
<h2 id="OSPF与BFD联动的基础配置命令"><a href="#OSPF与BFD联动的基础配置命令" class="headerlink" title="OSPF与BFD联动的基础配置命令"></a>OSPF与BFD联动的基础配置命令</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/13.png"></p>
<blockquote>
<p>•配置前提：</p>
<ul>
<li>如果需要使用BFD功能快速检测链路故障，则必须在系统视图下执行<strong>bfd</strong>命令，使能全局BFD功能。</li>
</ul>
<p>•接口配置的BFD特性优先级高于进程配置的BFD特性优先级。如果打开了接口的BFD开关，则按照接口上BFD参数建立BFD会话。</p>
<p>•可以配置OSPF IP FRR与BFD联动：</p>
<ul>
<li><p>配置OSPF IP FRR特性时，需要底层能够快速响应链路变化，以便迅速将流量切换到备份链路。</p>
</li>
<li><p>将OSPF IP FRR与BFD会话绑定可以达到快速感知故障的目的，确保故障后流量切换的及时性。</p>
</li>
</ul>
<p>•命令：[Huawei-ospf-1] <strong>bfd</strong> <strong>all-interfaces</strong> { <strong>min-rx-interval</strong> <em>receive-interval</em> | <strong>min-tx-interval</strong> <em>transmit-interval</em> | <strong>detect-multiplier</strong> <em>multiplier-value</em> | <strong>frr-binding</strong> } </p>
<ul>
<li><p><strong>min-rx-interval</strong> <em>receive-interval</em>：指定期望从对端接收BFD报文的最小接收间隔。整数形式，取值范围是10～2000，单位是毫秒。缺省值是1000毫秒。</p>
</li>
<li><p><strong>min-tx-interval</strong> <em>transmit-interval</em>：指定向对端发送BFD报文的最小发送间隔。整数形式，取值范围是10～2000，单位是毫秒。缺省值是1000毫秒。</p>
</li>
<li><p><strong>detect-multiplier</strong> <em>multiplier-value</em>：指定本地检测倍数。整数形式，取值范围是3～50，缺省值是3。</p>
</li>
<li><p><strong>frr-binding</strong>：将BFD会话状态与接口的链路状态进行绑定。当BFD会话状态变为Down时，接口的物理层链路状态也会变为Down，从而触发流量切换到备份路径。</p>
</li>
</ul>
</blockquote>
<h1 id="2-OSPF路由控制"><a href="#2-OSPF路由控制" class="headerlink" title="2.OSPF路由控制"></a>2.OSPF路由控制</h1><h2 id="OSPF路由控制概述"><a href="#OSPF路由控制概述" class="headerlink" title="OSPF路由控制概述"></a>OSPF路由控制概述</h2><p>OSPF的路由控制包括：</p>
<p>▫调整OSPF的接口开销</p>
<p>▫设置等价路由</p>
<p>▫引入外部路由</p>
<p>▫路由聚合a</p>
<p>▫缺省路由通告</p>
<p>▫Filter-Policy</p>
<p>▫对发送的LSA进行过滤</p>
<p>▫对ABR Type3 LSA进行过滤</p>
<p>▫设置LSDB中External LSA的最大数量</p>
<blockquote>
<p>•本课程只介绍等价路由、缺省路由、对LSA的过滤，其他内容请参考《HCIP-Datacom-Core Technology》课程。</p>
</blockquote>
<h2 id="等价路由"><a href="#等价路由" class="headerlink" title="等价路由"></a>等价路由</h2><p>•当路由表中存在到达同一目的地址，且同一路由协议发现的多条路由时，若这几条路由的开销值也相同，那么这些路由就是等价路由，可以实现负载分担。</p>
<p>•设备将按照负载分担的方式从多条等价路由发送报文到同一目的地址。</p>
<p>   设置进行负载分担的等价路由的最大数量：</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/14.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>maximum load-balancing</strong> <em>number</em></p>
<p>▫<em>number</em>：等价路由的最大数量。设备型号不同，取值范围不同，具体请参考相应设备的产品文档。</p>
</blockquote>
<h2 id="等价路由配置举例"><a href="#等价路由配置举例" class="headerlink" title="等价路由配置举例"></a>等价路由配置举例</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/15.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/16.png"></p>
<h2 id="缺省路由"><a href="#缺省路由" class="headerlink" title="缺省路由"></a>缺省路由</h2><p>•OSPF实际组网应用中，区域边界和自治系统边界通常都是由多个路由器组成的多出口冗余备份或者负载分担。此时，为了减少路由表的容量，可以配置缺省路由，保证网络的高可用性。</p>
<p>•OSPF缺省路由通常应用于下面两种情况：</p>
<p>​    ▫由区域边界路由器（ABR）发布Type3 LSA，用来指导区域内路由器进行区域之间报文的转发。</p>
<p>​    ▫由自治系统边界路由器（ASBR）发布Type5 LSA或Type7 LSA，用来指导OSPF路由域内路由器进行域外报文的转发。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/17.png"></p>
<blockquote>
<p>•缺省路由是指目的地址和掩码都是0的路由。当设备无精确匹配的路由时，就可以通过缺省路由进行报文转发。由于OSPF路由的分级管理，Type3缺省路由的优先级高于Type5或Type7路由。</p>
<p>•普通区域：</p>
<p>​    ▫缺省情况下，普通OSPF区域内的OSPF路由器是不会产生缺省路由的，即使它有缺省路由。当该路由器需要向OSPF发布缺省路由时，必须手工执行<strong>default-route-advertise</strong>命令，配置完成后，路由器会产生一个缺省ASE LSA（Type5 LSA），并且通告到整个OSPF自治系统中。</p>
<p>•Stub区域：</p>
<p>​    ▫Stub区域不允许自治系统外部的路由（Type5 LSA）在区域内传播。区域内的路由器必须通过ABR学到自治系统外部的路由。</p>
<p>​    ▫Stub区域的ABR会自动产生一条缺省的Type3 LSA通告到整个Stub区域。ABR通过该缺省路由，将到达AS外部的流量吸引到自己这里，然后通过ABR转发出去。</p>
<p>•Totally Stub区域：</p>
<p>​    ▫Totally Stub区域既不允许自治系统外部的路由（Type5 LSA）在区域内传播，也不允许区域间路由（Type3 LSA）在区域内传播。区域内的路由器必须通过ABR学到自治系统外部和其他区域的路由。</p>
<p>​    ▫Totally Stub区域的ABR会自动产生一条缺省的Type3 LSA通告到整个Stub区域。ABR通过该缺省路由，将到达AS外部的流量吸引到自己这里，然后通过ABR转发出去。</p>
<p>•NSSA区域：</p>
<p>​    ▫如果希望到达自治系统外部的路由通过本区域（NSSA区域）的ASBR到达，而其它外部路由通过其它区域出去。此时，ABR会产生一条Type7 LSA的缺省路由，通告到整个NSSA区域内。这样，除了某少部分路由通过NSSA的ASBR到达，其它路由都可以通过NSSA的ABR到达其它区域的ASBR出去。这种情况下，在ABR上无论路由表中是否存在缺省路由0.0.0.0，都会产生Type7 LSA的缺省路由。</p>
<p>​    ▫如果希望所有的外部路由只通过本区域（NSSA区域）的ASBR到达，则必须在ASBR上手动执行<strong>nssa</strong> **[default-route-advertise]**命令进行配置，使ASBR产生一条缺省的NSSA LSA（Type7 LSA），通告到整个NSSA区域内。这样，所有的外部路由就只能通过本区域NSSA的ASBR到达。这种情况下，在ASBR上只有当路由表中存在缺省路由0.0.0.0时，才会产生Type7 LSA的缺省路由。</p>
<p>​    ▫注意：因为缺省路由只是在本NSSA区域内泛洪，并没有泛洪到整个OSPF域中，所以本NSSA区域内的路由器在找不到路由之后可以从该NSSA的ASBR出去，但不能实现其他OSPF域的路由从这个出口出去。Type7 LSA缺省路由不会在ABR上转换成Type5 LSA缺省路由泛洪到整个OSPF域。</p>
<p>•Totally NSSA区域：</p>
<p>​    ▫Totally NSSA的ABR会自动向该区域下发使用Type3 LSA描述的缺省路由，而Totally NSSA的ASBR则不会自动下发缺省路由。因此，在该场景下，对于区域内的路由器而言，可以通过ASBR引入的外部路由到达相应的外部网段、通过ABR下发的缺省路由到达其他网段。</p>
<p>​    ▫如果希望Totally NSSA内的路由器选择ASBR作为默认出口，而不是ABR，那么需要让ASBR也下发缺省路由，此时必须在ASBR上手工执行配置。</p>
</blockquote>
<h2 id="将缺省路由通告到OSPF路由区域"><a href="#将缺省路由通告到OSPF路由区域" class="headerlink" title="将缺省路由通告到OSPF路由区域"></a>将缺省路由通告到OSPF路由区域</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/18.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>default-route-advertise</strong> [ [ <strong>always</strong> | <strong>permit-calculate-other</strong> ] | <strong>cost</strong> <em>cost</em> | <strong>type</strong> <em>type</em> | <strong>route-policy</strong> <em>route-policy-name</em> [ <strong>match-any</strong> ] ]</p>
<p>​    ▫<strong>always</strong>：无论本机是否存在激活的非本OSPF缺省路由，都会产生并发布一个描述缺省路由的LSA。</p>
<p>​        ▪如果配置了always参数，设备不再计算来自其他设备的缺省路由。</p>
<p>​        ▪如果没有配置always参数，本机路由表中必须有激活的非本OSPF缺省路由时才生成缺省路由的LSA。</p>
<p>​    ▫<strong>permit-calculate-other</strong>：本机必须存在激活的非本OSPF缺省路由时才会产生并发布一个缺省路由的LSA，且设备仍然计算来自于其他设备的缺省路由。</p>
<p>​    ▫<strong>type</strong> <em>type</em> ：指定外部路由的类型。整数形式，取值为1或2。缺省值是2。</p>
<p>​        ▪1：第一类外部路由</p>
<p>​        ▪2：第二类外部路由</p>
<p>​    ▫<strong>route-policy</strong> <em>route-policy-name</em>：通过路由策略，实现在路由表中有匹配的非OSPF产生的缺省路由表项时，按路由策略所配置的参数发布缺省路由。字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
<p>​    ▫<strong>match-any</strong>：通过路由策略，实现在路由表中有匹配的路由表项时，按路由策略所配置的参数发布缺省路由。</p>
<p>•命令：[Huawei-ospf-1] <strong>default-route-advertise</strong> <strong>summary</strong> <strong>cost</strong> <em>cost</em></p>
<p>​    ▫<strong>summary</strong>：发布指定缺省路由的Type3 LSA。在选用该参数时，必须首先使能VPN，否则路由不能发布。</p>
<p>​    ▫<strong>cost</strong> <em>cost</em>：指定该LSA的开销值。整数形式，取值范围是0～16777214。缺省值是1。</p>
<p>•always参数：</p>
<p>​    ▫ASBR已经有缺省路由，执行default-route-advertise命令，将在整个OSPF区域中通告缺省路由0.0.0.0。</p>
<p>​    ▫ASBR没有缺省路由，执行default-route-advertise命令时按照以下需求选择是否配置always参数。</p>
<p>​        ▪如果配置always参数，无论ASBR是否有缺省路由都将在整个OSPF区域中通告缺省路由0.0.0.0，并且不再计算来自其他设备的缺省路由。</p>
<p>​        ▪如果没有配置always参数，ASBR的路由表中必须有激活的非OSPF（BGP除外）缺省路由时才生成缺省路由的LSA。</p>
<p>•match-any参数：</p>
<p>​    ▫使用带match-any参数的路由策略时，如果有多条路由通过策略，选取最优者来生成缺省LSA。路由通过策略时，选取最优者的原则按照优先级从高到低的顺序如下：</p>
<p>​        ▪路由设置了type的优先于未设置的，如果都设置了type，值越小越优先。</p>
<p>​        ▪路由设置了cost的优先于未设置的，如果都设置了cost，值越小越优先。</p>
<p>​        ▪路由设置了tag的优先于未设置的， 如果都设置了tag，值越小越优先。</p>
</blockquote>
<h2 id="对发送的LSA进行过滤"><a href="#对发送的LSA进行过滤" class="headerlink" title="对发送的LSA进行过滤"></a>对发送的LSA进行过滤</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/19.png"></p>
<blockquote>
<p>•命令：[Huawei-GigabitEthernet0/0/1] <strong>ospf</strong> <strong>filter-lsa-out</strong> { <strong>all</strong> | { <strong>summary</strong> [ <strong>acl</strong> { <em>acl-number</em> | <em>acl-name</em> } ] | <strong>ase</strong> [ <strong>acl</strong> { <em>acl-number</em> | <em>acl-name</em> } ] | <strong>nssa</strong> [ <strong>acl</strong> { <em>acl-number</em> | <em>acl-name</em> } ] } }</p>
<p>​    ▫<strong>all</strong>：对除Grace LSA外的所有LSA进行过滤。</p>
<p>​    ▫<strong>summary</strong>：对Network Summary LSA（Type3 LSA）进行过滤。</p>
<p>​    ▫<strong>ase</strong>：对AS External LSA（Type5 LSA）进行过滤。</p>
<p>​    ▫<strong>nssa</strong>：对NSSA LSA（Type7 LSA）进行过滤。</p>
<p>​    ▫<strong>acl</strong> <em>acl-number</em>：指定基本访问控制列表编号。整数形式，取值范围是2000～2999。</p>
<p>​    ▫<strong>acl</strong> <em>acl-name</em>：指定访问控制列表名称。字符串形式，不支持空格，区分大小写，长度范围是1～32，以英文字母a～z或A～Z开始。</p>
</blockquote>
<h2 id="对ABR-Type3-LSA进行过滤"><a href="#对ABR-Type3-LSA进行过滤" class="headerlink" title="对ABR Type3 LSA进行过滤"></a>对ABR Type3 LSA进行过滤</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/20.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1-area-0.0.0.1] <strong>filter</strong> { <em>acl-number</em> | <strong>acl-name</strong> <em>acl-name</em> | <strong>ip-prefix</strong> <em>ip-prefix-name</em> | <strong>route-policy</strong> <em>route-policy-name</em> } <strong>export</strong></p>
<p>▫<em>acl-number</em>：指定基本访问控制列表号。整数形式，取值范围是2000～2999。</p>
</blockquote>
<h2 id="OSPF-Database-Overflow概述"><a href="#OSPF-Database-Overflow概述" class="headerlink" title="OSPF Database Overflow概述"></a>OSPF Database Overflow概述</h2><p>•OSPF要求同一个区域中的路由器保存相同的LSDB。随着网络上路由数量不断增加，一些路由器由于系统资源有限，不能再承载如此多的路由信息，这种状态就被称为数据库超限（OSPF Database Overflow）。</p>
<p>•对于路由信息不断增加导致路由器系统资源耗尽而失效的问题，可以通过配置Stub或NSSA区域来解决，但Stub或NSSA区域的方案不能解决动态路由增长导致的数据库超限问题。为了解决数据库超限引发的问题，通过设置LSDB中External LSA的最大条目数，可以动态限制链路数据库的规模。</p>
<p>   设置OSPF的LSDB中External LSA的最大条目数</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/21.png"></p>
<blockquote>
<p>•当OSPF引入的外部路由（Type5 LSA和Type7 LSA）数量超过允许的范围，会导致超出的外部路由无法得到正常处理，丢失引入的路由。为了解决上述问题，通过配置OSPF的LSDB中External LSA的最大条目数，保证引入的外部路由在一个合理的范围内，调整和优化OSPF网络。</p>
<p>•命令：[Huawei-ospf-1] <strong>lsdb-overflow-limit</strong> <em>number</em></p>
<p>​    ▫<em>number</em>：指定LSDB中External LSA的最大条目数。整数形式，取值范围是1～1000000。</p>
</blockquote>
<h2 id="避免OSPF-Database-Overflow工作原理"><a href="#避免OSPF-Database-Overflow工作原理" class="headerlink" title="避免OSPF Database Overflow工作原理"></a>避免OSPF Database Overflow工作原理</h2><p>•为了避免数据库超限，可以设置路由器上非缺省外部路由数量的上限。</p>
<p>•OSPF网络中所有路由器都配置相同的上限值，只要路由器上外部路由的数量达到该上限，路由器就进入Overflow状态，并同时启动Overflow状态定时器（默认超时时间为5秒），路由器在定时器超过5秒后自动退出Overflow状态。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/22.png"></p>
<h2 id="OSPF路由控制配置举例-1"><a href="#OSPF路由控制配置举例-1" class="headerlink" title="OSPF路由控制配置举例 (1)"></a>OSPF路由控制配置举例 (1)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/23.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/24.png"></p>
<h2 id="OSPF路由控制配置举例-2"><a href="#OSPF路由控制配置举例-2" class="headerlink" title="OSPF路由控制配置举例 (2)"></a>OSPF路由控制配置举例 (2)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/25.png"></p>
<h2 id="OSPF路由控制案例分析"><a href="#OSPF路由控制案例分析" class="headerlink" title="OSPF路由控制案例分析"></a>OSPF路由控制案例分析</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/26.png"></p>
<blockquote>
<p>•市场部数据转发需求：</p>
<p>​    ▫只要边界-2路由器及其上联链路正常运行，市场部数据流就只会通过边界-2路由器进行数据转发。</p>
<p>​    ▫只要核心-2路由器及其上联链路正常运行，市场部数据流就只会通过核心-2路由器进行数据转发。</p>
<p>•本案例以分析财务部数据转发路径为例，市场部相关内容不再赘述。</p>
</blockquote>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/27.png"></p>
<blockquote>
<p>•第二类外部路由（Type2 External）：</p>
<p>​    ▫这类路由的可信度比较低，所以OSPF认为从ASBR到自治系统之外的开销远远大于在自治系统之内到达ASBR的开销。</p>
<p>​    ▫OSPF计算路由开销时只考虑ASBR到自治系统之外的开销，即到第二类外部路由的开销=ASBR到该路由目的地址的开销。</p>
</blockquote>
<h2 id="控制流量出口"><a href="#控制流量出口" class="headerlink" title="控制流量出口"></a>控制流量出口</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/28.png"></p>
<blockquote>
<p>•控制流量出口时，不考虑到达各ASBR的内部路径开销。</p>
</blockquote>
<h2 id="控制内部路径"><a href="#控制内部路径" class="headerlink" title="控制内部路径"></a>控制内部路径</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/29.png"></p>
<h2 id="控制内部路径：调整汇聚到核心开销"><a href="#控制内部路径：调整汇聚到核心开销" class="headerlink" title="控制内部路径：调整汇聚到核心开销"></a>控制内部路径：调整汇聚到核心开销</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/30.png"></p>
<h2 id="控制内部路径：调整核心到边界开销"><a href="#控制内部路径：调整核心到边界开销" class="headerlink" title="控制内部路径：调整核心到边界开销"></a>控制内部路径：调整核心到边界开销</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/31.png"></p>
<h2 id="OSPF路由控制案例主要配置-1"><a href="#OSPF路由控制案例主要配置-1" class="headerlink" title="OSPF路由控制案例主要配置 (1)"></a>OSPF路由控制案例主要配置 (1)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/32.png"></p>
<h2 id="OSPF路由控制案例主要配置-2"><a href="#OSPF路由控制案例主要配置-2" class="headerlink" title="OSPF路由控制案例主要配置 (2)"></a>OSPF路由控制案例主要配置 (2)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/33.png"></p>
<h2 id="OSPF路由控制案例主要配置-3"><a href="#OSPF路由控制案例主要配置-3" class="headerlink" title="OSPF路由控制案例主要配置 (3)"></a>OSPF路由控制案例主要配置 (3)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/34.png"></p>
<h1 id="3-OSPF其他特性"><a href="#3-OSPF其他特性" class="headerlink" title="3.OSPF其他特性"></a>3.OSPF其他特性</h1><h2 id="OSPF多进程"><a href="#OSPF多进程" class="headerlink" title="OSPF多进程"></a>OSPF多进程</h2><p>•OSPF支持多进程，在同一台路由器上可以运行多个不同的OSPF进程，它们之间互不影响，彼此独立。不同OSPF进程之间的路由交互相当于不同路由协议之间的路由交互。</p>
<p>•路由器的一个接口只能属于某一个OSPF进程。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/35.png"></p>
<blockquote>
<p>•VPN（Virtual Private Network）：虚拟专用网络。</p>
<p>•创建OSPF进程时，如果指定了VPN实例，那么OSPF进程属于此实例，否则属于全局实例。</p>
</blockquote>
<h2 id="OSPF与BGP联动-1"><a href="#OSPF与BGP联动-1" class="headerlink" title="OSPF与BGP联动 (1)"></a>OSPF与BGP联动 (1)</h2><p>当有新的设备加入到网络中，或者设备重启时，可能会出现在BGP收敛期间内网络流量丢失的现象。这是由于IGP收敛速度比BGP快而造成的。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/36.png"></p>
<h2 id="OSPF与BGP联动-2"><a href="#OSPF与BGP联动-2" class="headerlink" title="OSPF与BGP联动 (2)"></a>OSPF与BGP联动 (2)</h2><p>•通过使能OSPF与BGP联动特性，可以解决流量丢失问题。</p>
<p>•使能了OSPF与BGP联动特性的设备会在设定的联动时间内保持为Stub路由器，也就是说，该设备发布的LSA中的链路度量值为最大值（65535），从而告知其它OSPF设备不要使用这个路由器来转发数据。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/37.png"></p>
<blockquote>
<p>•命令：[Huawei-ospf-1] <strong>stub-router</strong> [ <strong>on-startup</strong> [ <em>interval</em> ] ]</p>
<ul>
<li><p><strong>on-startup</strong> [ <em>interval</em> ]：设备在发生重启或故障时保持为Stub路由器的时间间隔。整数形式，取值范围是5～65535，单位是s，缺省值是500s。</p>
<ul>
<li><p>如果未配置<strong>on-startup</strong>参数，则表示该设备始终保持为Stub路由器，即所有来自这个设备的路由条目Cost值均设为65535。</p>
</li>
<li><p>如果配置了<strong>on-startup</strong>参数，则表示该设备仅在重启或者故障时保持为Stub路由器，保持时间由<em>interval</em>参数决定。此时若未配置<em>interval</em>参数，则使用<em>interval</em>的缺省值500s。</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="OSPF转发地址"><a href="#OSPF转发地址" class="headerlink" title="OSPF转发地址"></a>OSPF转发地址</h2><p>FA（Forwarding Address，转发地址）：</p>
<ul>
<li><p>到达所通告的目的地的数据包应该被转发到的地址，如果转发地址为0.0.0.0，那么数据包将被转发到始发ASBR上。</p>
</li>
<li><p>Type5 AS-External-LSA 和 Type7 NSSA LSA：</p>
</li>
</ul>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/38.png"></p>
<h2 id="没有FA引发的问题"><a href="#没有FA引发的问题" class="headerlink" title="没有FA引发的问题"></a>没有FA引发的问题</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/39.png"></p>
<p>•R2、R3和R4运行OSPF，均部署在Area0中。其中R2和R3的GE0/0/1接口都激活OSPF并建立邻接关系，但是两者与外部路由器R1并不建立OSPF邻接关系。</p>
<p>​    1.R2配置到达10.1.1.1/32的静态路由，下一跳为10.1.123.1。</p>
<p>​    2.R2将静态路由引入OSPF，产生Type5 LSA在区域内泛洪。</p>
<p>​    3.R3接收到R2产生的5类LSA，计算出到达10.1.1.1/32的外部路由，并且将路由的下一跳指定为R2（10.1.123.2）。 </p>
<p>•OSPF域内的路由器如R4到达10.1.1.1/32的路径是：R4-R3-R2-R1，该路径是次优路径的。</p>
<h2 id="利用FA解决次优路径问题"><a href="#利用FA解决次优路径问题" class="headerlink" title="利用FA解决次优路径问题"></a>利用FA解决次优路径问题</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/40.png"></p>
<p>•R2向OSPF域内通告到达10.1.1.1/32的外部路由时，为对应的Type5 LSA设置FA，值为其自己到达该外部路由的下一跳：10.1.123.1。</p>
<p>•当R3收到该LSA后，计算到达10.1.1.1/32的路由时，发现FA为非0，因此它认为到达目标地址10.1.1.1/32的下一跳为FA所指定的地址，即：10.1.123.1。</p>
<h2 id="FA的取值"><a href="#FA的取值" class="headerlink" title="FA的取值"></a>FA的取值</h2><p>•当ASBR引入外部路由时，若Type5 LSA中的FA字段为0，表示路由器认为到达目的网段的数据包应该发往该ASBR；若Type5 LSA中的FA字段不为0，表示路由器认为到达目的网段的数据包应该发往这个FA所标识的设备。</p>
<p>•当以下条件全部满足时，FA字段才可以被设置为非0：</p>
<p>​    ▫ASBR在其连接外部网络的接口（外部路由的出接口）上激活了OSPF；</p>
<p>​    ▫该接口没有被配置为Silent-Interface；</p>
<p>​    ▫该接口的OSPF网络类型为Broadcast或NBMA；</p>
<p>​    ▫该接口的IP地址在OSPF配置的network命令指定的网段范围内。</p>
<p>•到达FA地址的路由必须是OSPF区域内部路由或区域间路由，这样接收到该外部LSA的路由器才能够加载该LSA进入路由表。加载的外部LSA生成的路由条目下一跳与到达FA地址的下一跳相同。</p>
<blockquote>
<p>•NSSA区域Type7 LSA转化为Type5 LSA：</p>
<p>​    ▫为了将NSSA区域引入的外部路由发布到其它区域，需要把Type7 LSA转化为Type5 LSA以便在整个OSPF网络中通告。缺省情况下，转换路由器是NSSA区域中Router ID最大的区域边界路由器（ABR）。</p>
<p>​    ▫LSA头部Options字段中的P-bit（Propagate bit）用于告知转化路由器该条Type7 LSA是否需要转化为Type5 LSA。只有P-bit置位并且FA不为0的Type7 LSA才能转化为Type5 LSA。</p>
<p>​    ▫区域边界路由器产生的Type7 LSA不会置位P-bit。(防环)</p>
<p>•注意：所有的OSPF LSA有相同的LSA头部，P-bit在LSA头部中的Options字段。</p>
</blockquote>
<h3 id="7类-LSA的FA取值"><a href="#7类-LSA的FA取值" class="headerlink" title="7类 LSA的FA取值"></a>7类 LSA的FA取值</h3><p>若满足以下条件，FA取值同5类LSA</p>
<ol>
<li>接口network</li>
<li>接口不是静默接口</li>
<li>接口的链路类型不是p2p或者是p2mp</li>
</ol>
<p>若不满足，FA取值先后顺序如下</p>
<ol>
<li>配置了loopback口，取loopback口中ip地址最大的作为FA地址</li>
<li>未配置loopback口，取物理接口中ip地址最大的作为FA地址</li>
</ol>
<p>（例如OSPF中router id 的选举）</p>
<h2 id="案例：NSSA场景下FA的典型应用"><a href="#案例：NSSA场景下FA的典型应用" class="headerlink" title="案例：NSSA场景下FA的典型应用"></a>案例：NSSA场景下FA的典型应用</h2><p>•当NSSA区域中有多个ABR时，系统会根据规则自动选择一个ABR作为转换器，将Type7 LSA转换为Type5 LSA，其他ABR不做LSA转换。</p>
<p>•如图所示，如果不考虑FA，由于R3的Router ID比R2大，因此它将执行7转5的动作，如此一来，R1将认为必须经由ABR（R3）到达目的网络。这样，流量便会被引导到低带宽链路，即R1-R3-R4-R5。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/41.png"></p>
<blockquote>
<p>•如图所示：</p>
<ul>
<li><p>R5引入直连外部路由，且将FA设为自己访问目的网段10.1.5.0/24的地址：10.1.45.5。</p>
</li>
<li><p>R3执行Type7 LSA转换Type5 LSA动作，继续携带FA：10.1.45.5。</p>
</li>
<li><p>R1收到后，会在自己的OSPF路由表中查询到达这个FA的路由，发现在OSPF路由表中能够找到匹配这个FA的路由，就使用到达这个FA的下一跳地址作为这条外部路由的下一跳地址。</p>
</li>
<li><p>因此，R1最终会通过R1-R2-R4-R5路径，访问目的网段10.1.5.0/24。</p>
</li>
</ul>
</blockquote>
<h1 id="4-IS-IS高级特性"><a href="#4-IS-IS高级特性" class="headerlink" title="4.IS-IS高级特性"></a>4.IS-IS高级特性</h1><h2 id="IS-IS快速收敛概述"><a href="#IS-IS快速收敛概述" class="headerlink" title="IS-IS快速收敛概述"></a>IS-IS快速收敛概述</h2><p>•IS-IS快速收敛是为了提高路由的收敛速度而做的扩展特性，包括：I-SPF（Incremental SPF，增量最短路径优先算法）、PRC、智能定时器、LSP快速扩散。</p>
<p>•同时，IS-IS支持故障恢复快速收敛，例如通过IS-IS Auto FRR实现备份链路的快速切换，也可以与BFD联动实现对故障的快速感知。</p>
<blockquote>
<p>•IS-IS的PRC、智能定时器、FRR等功能与OSPF类似，不再赘述。</p>
</blockquote>
<h2 id="I-SPF"><a href="#I-SPF" class="headerlink" title="I-SPF"></a>I-SPF</h2><p>I-SPF的工作原理：当网络拓扑改变的时候，只对受影响的节点进行路由计算，而不是对全部节点重新进行路由计算，从而加快了路由的计算。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/42.png"></p>
<blockquote>
<p>•使用SPF算法进行路由计算：当网络拓扑中有一个节点发生变化时，SPF算法需要重新计算网络中的所有节点，计算时间长，占用过多的CPU资源，影响整个网络的收敛速度。</p>
<p>•I-SPF改进了SPF算法，除了第一次SPF计算时需要计算全部节点外，之后每次都通过I-SPF计算受到影响的节点，而最后生成的最短路径树与原来的算法所计算的结果相同，大大降低了CPU的占用率，提高了网络收敛速度。</p>
<p>•在IS-IS网络中，I-SPF和PRC结合使用。</p>
<ul>
<li><p>如果I-SPF计算后的最短路径树改变，PRC会只处理那个变化的节点上的所有叶子（路由）。</p>
</li>
<li><p>如果经过I-SPF计算后的最短路径树并没有变化，则PRC只处理变化的叶子信息。比如一个节点使能一个IS-IS接口，则整个网络拓扑的最短路径树是不变的，这时PRC只更新这个节点的接口路由，从而节省CPU占用率。</p>
</li>
</ul>
</blockquote>
<h2 id="LSP快速扩散"><a href="#LSP快速扩散" class="headerlink" title="LSP快速扩散"></a>LSP快速扩散</h2><p>LSP快速扩散：此特性可以加快LSP的扩散速度。</p>
<p>▫正常情况下，当IS-IS路由器收到其它路由器发来的LSP时，如果此LSP比本地LSDB中相应的LSP要新，则更新LSDB中的LSP，并用一个定时器定期将LSDB内已更新的LSP扩散出去。</p>
<p>▫LSP快速扩散特性改进了这种方式，使能了此特性的设备收到一个或多个较新的LSP时，在路由计算之前，先将小于指定数目的LSP扩散出去，加快LSDB的同步过程。这种方式在很大程度上可以提高整个网络的收敛速度。</p>
<p>   配置LSP快速扩散</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/43.png"></p>
<p>注意：用户可以指定每次扩散的LSP数量，这个数量是针对所有IS-IS接口的。如果需要发送的LSP的数量大于这个数，则就发送<em>lsp-count</em>个LSP。如果配置了定时器，在路由计算之前如果这个定时器未超时，则立即扩散；否则在该定时器超时后发送。</p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>flash-flood</strong> [ <em>lsp-count</em> | <strong>max-timer-interval</strong> <em>interval</em> | [ <strong>level-1</strong> | <strong>level-2</strong> ] ]</p>
<p>​    ▫<em>lsp-count</em>：指定每个接口一次扩散LSP的最大数量。整数形式，取值范围是1～15。缺省值是5。</p>
<p>​    ▫<strong>max-timer-interval</strong> <em>interval</em>：指定LSP扩散的最大间隔时间。整数形式，取值范围是10～50000，单位是毫秒。缺省值是10毫秒。</p>
<p>​    ▫<strong>level-1</strong>：表示在Level-1中使能此特性。如果命令中没有指定级别，则缺省同时在Level-1和Level-2中使能此功能。</p>
<p>​    ▫<strong>level-2</strong>：表示在Level-2中使能此特性。如果命令中没有指定级别，则缺省同时在Level-1和Level-2中使能此功能。</p>
</blockquote>
<h2 id="IS-IS路由控制概述"><a href="#IS-IS路由控制概述" class="headerlink" title="IS-IS路由控制概述"></a>IS-IS路由控制概述</h2><p>在实际应用中，IS-IS根据SPF算法计算出来的路由有时并不能满足网络所需，可能出现如下弊端：如路由表中条目过多降低路由查找的速度、网络中链路利用率不均衡等，这些都不能很好地满足网络规划和流量管理的需要。为了达到优化IS-IS网络和便于流量管理的目的，需要对网络中的路由进行更加精确的控制。IS-IS的路由控制包括：</p>
<p>​    ▫调整IS-IS的优先级</p>
<p>​    ▫调整IS-IS的接口开销</p>
<p>​    ▫设置等价路由</p>
<p>​    ▫IS-IS路由渗透</p>
<p>​    ▫通告缺省路由</p>
<p>​    ▫引入外部路由</p>
<p>​    ▫Filter-Policy</p>
<blockquote>
<p>•本课程只介绍等价路由和缺省路由，其他内容请参考《HCIP-Datacom-Core Technology》课程。</p>
</blockquote>
<h2 id="等价路由-1"><a href="#等价路由-1" class="headerlink" title="等价路由"></a>等价路由</h2><p>当IS-IS网络中有多条冗余链路时，可能会出现多条等价路由，此时可以采取两种方式：</p>
<ul>
<li><p>配置负载分担。流量会被均匀的分配到每条链路上。</p>
<ul>
<li>该方式可以提高网络中链路的利用率及减少某些链路负担过重造成阻塞发生的情况。但是由于对流量转发具有一定的随机性，因此可能不利于对业务流量的管理。</li>
</ul>
</li>
<li><p>配置等价路由优先级。针对等价路由中的每一条路由，明确指定其优先级，优先级高的路由将被优选，优先级低的路由可以作为备用链路。</p>
<ul>
<li>当IS-IS网络中有多条冗余链路时，可能会出现多条等价路由，即达到某一目的网段有多条等开销路径。配置等价路由优先级可以在不修改原有配置的基础上，指定某条路由被优选，便于业务的管理，同时提高网络的可靠性。</li>
<li>注意：配置等价路由优先级后，IS-IS设备在转发到达目的网段的流量时，将不采用负载分担方式，而是将流量转发到优先级最高的下一跳。</li>
</ul>
</li>
</ul>
<h2 id="配置IS-IS对等价路由的处理方式"><a href="#配置IS-IS对等价路由的处理方式" class="headerlink" title="配置IS-IS对等价路由的处理方式"></a>配置IS-IS对等价路由的处理方式</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/44.png"></p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>maximum load-balancing</strong> <em>number</em></p>
<ul>
<li><em>number</em>：指定在负载分担方式下等价路由的最大数量。不同设备型号取值不同。</li>
</ul>
<p>•命令：[Huawei-isis-1] <strong>nexthop</strong> <em>ip-address</em> <strong>weight</strong> <em>value</em></p>
<ul>
<li><p><em>ip-address</em>：指定下一跳的IP地址。点分十进制格式。</p>
</li>
<li><p><strong>weight</strong> <em>value</em>：指定下一跳权重。<em>value</em>越小则优先级越高。<em>value</em>是整数形式，取值范围是1～254。</p>
</li>
</ul>
</blockquote>
<h2 id="等价路由配置举例-1"><a href="#等价路由配置举例-1" class="headerlink" title="等价路由配置举例 (1)"></a>等价路由配置举例 (1)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/45.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/46.png"></p>
<h2 id="等价路由配置举例-2"><a href="#等价路由配置举例-2" class="headerlink" title="等价路由配置举例 (2)"></a>等价路由配置举例 (2)</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/47.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/48.png"></p>
<h2 id="缺省路由-1"><a href="#缺省路由-1" class="headerlink" title="缺省路由"></a>缺省路由</h2><p>•在IS-IS中，主要通过以下3种方式控制缺省路由的生成和发布。</p>
<p>​    ▫在Level-1-2设备上，控制其产生的Level-1 LSP中ATT位的置位情况。</p>
<p>​    ▫在Level-1设备上，通过配置使其即使收到ATT位置位的Level-1 LSP也不会自动产生缺省路由。</p>
<p>​    ▫在IS-IS中发布缺省路由。</p>
<p>•LSP的报文格式：</p>
<p>​    ▫ATT（Attachment）：由Level-1-2路由器产生，用来指明始发路由器是否与其它区域相连。此字段有4bit，华为数通产品只使用了其中1bit。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/49.png"></p>
<h2 id="通过设置ATT位控制缺省路由生成"><a href="#通过设置ATT位控制缺省路由生成" class="headerlink" title="通过设置ATT位控制缺省路由生成"></a>通过设置ATT位控制缺省路由生成</h2><p>•IS-IS规定，如果IS-IS Level-1-2设备根据LSDB判断通过Level-2区域比Level-1区域能够到达更多的区域，该设备会在所发布的Level-1 LSP内将ATT位置位。对于收到ATT位置位的LSP报文的Level-1设备，会生成一条目的地为发送该LSP的Level-1-2设备地址的缺省路由。</p>
<p>•以上是协议的默认原则，在实际应用中，可以根据需要对ATT比特位进行手动配置以更好地为网络服务。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/50.png"></p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>attached-bit advertise</strong> { <strong>always</strong> | <strong>never</strong> }</p>
<ul>
<li><p><strong>always</strong>：指定ATT位永远置位，收到该LSP的Level-1设备会生成缺省路由。</p>
</li>
<li><p><strong>never</strong>：指定ATT位永不置位，可以避免Level-1设备生成缺省路由，减小路由表的规模。</p>
</li>
</ul>
<p>•虽然ATT位同时在Level-1 LSP和Level-2 LSP中进行了定义，但是它只会在Level-1 LSP中被置位，并且只有Level-1-2设备会设置这个字段，因此，该命令仅对Level-1-2设备生效。</p>
<p>•配置Level-1设备不将缺省路由下发到路由表，有以下两种方式可以实现：</p>
<ul>
<li><p>在Level-1-2设备上配置<strong>attached-bit advertise never</strong>命令，使得其不会发布ATT位置位的LSP。</p>
</li>
<li><p>在与Level-1-2设备相连的Level-1设备上配置<strong>attached-bit avoid-learning</strong>命令。</p>
</li>
</ul>
<p>•其中，<strong>attached-bit avoid-learning</strong>命令适用于需要针对指定设备配置的情况。</p>
</blockquote>
<h2 id="IS-IS发布缺省路由"><a href="#IS-IS发布缺省路由" class="headerlink" title="IS-IS发布缺省路由"></a>IS-IS发布缺省路由</h2><p>•在具有外部路由的边界设备上配置IS-IS发布缺省路由可以使该设备在IS-IS路由域内发布一条0.0.0.0/0的缺省路由。在执行此配置后，IS-IS域内的其他设备在转发流量时，将所有去往外部路由域的流量首先转发到该设备，然后通过该设备去往外部路由域。</p>
<p>•通常，当网络中部署了IS-IS和其他路由协议时，为了实现IS-IS域内的流量可以到达IS-IS域外，通常有如下两种方式：</p>
<p>​    ▫在边界设备上配置IS-IS设备向IS-IS域发布缺省路由。该方式较为简单，不需要学习外部路由。</p>
<p>​    ▫在边界设备上将其他路由域的路由引入到IS-IS中。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/51.png"></p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>default-route-advertise</strong> [ <strong>always</strong> | <strong>match default</strong> | <strong>route-policy</strong> <em>route-policy-name</em> ] [ <strong>cost</strong> <em>cost</em> | <strong>tag</strong> <em>tag</em> | [ <strong>level-1</strong> | <strong>level-1-2</strong> | <strong>level-2</strong> ] ] [ <strong>avoid-learning</strong> ]</p>
<ul>
<li><p><strong>always</strong>：指定设备无条件的发布缺省路由，且发布的缺省路由中将自己作为下一跳。</p>
</li>
<li><p><strong>match default</strong>：如果在路由表中存在其他路由协议或其它IS-IS进程生成的缺省路由，则在LSP中发布该缺省路由。</p>
</li>
<li><p><strong>route-policy</strong> <em>route-policy-name</em>：指定路由策略名称。当该边界设备的路由表中存在满足路由策略的外部路由时，才向IS-IS域发布缺省路由，避免由于链路故障等原因造成该设备已经不存在某些重要的外部路由时，仍然发布缺省路由从而造成路由黑洞。此处的路由策略不影响IS-IS引入外部路由。字符串形式，区分大小写，不支持空格，长度范围是1～40。当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
</li>
<li><p><strong>cost</strong> <em>cost</em>：指定缺省路由的开销值。整数形式。取值范围根据cost-style而定：当cost-style为narrow、narrow-compatible或compatible时，取值范围是0～63；当cost-style为wide或wide-compatible时，取值范围是0～4261412864。</p>
</li>
<li><p><strong>tag</strong> <em>tag</em>：指定发布的缺省路由的标记值。只有当IS-IS的开销类型为wide、wide-compatible或compatible时，发布的LSP中才会携带tag值。整数形式，取值范围为1～4294967295。</p>
</li>
<li><p><strong>level-1</strong>：指定发布的缺省路由级别为Level-1。如果不指定级别，则默认为生成Level-2级别的缺省路由。</p>
</li>
<li><p><strong>level-2</strong>：指定发布的缺省路由级别为Level-2。如果不指定级别，则默认为生成Level-2级别的缺省路由。</p>
</li>
<li><p><strong>level-1-2</strong>：指定发布的缺省路由级别为Level-1-2。如果不指定级别，则默认为生成Level-2级别的缺省路由。</p>
</li>
<li><p><strong>avoid-learning</strong>：避免IS-IS进程学到其他路由协议或其它IS-IS进程生成的缺省路由并添加到路由表。如果路由表中已存在学到的缺省路由为活跃状态，则将此路由置为不活跃状态。</p>
</li>
</ul>
<p>•配置该命令后，IS-IS域内所有去往外部的流量将首先会被转发到该设备来进行转发。相比于在每台设备上配置静态缺省路由，使用该命令可以简化操作，即只需在边界设备配置即可。此外，该命令是动态发布缺省路由，使用更加灵活，有多种发布缺省路由的方式可供选择。</p>
<p>•如果在Level-1设备上配置了该命令，那么该设备只会向Level-1区域发布缺省路由，不会将缺省路由发布到Level-2区域。</p>
</blockquote>
<h2 id="缺省路由配置举例"><a href="#缺省路由配置举例" class="headerlink" title="缺省路由配置举例"></a>缺省路由配置举例</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/52.png"></p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/53.png"></p>
<h2 id="IS-IS多实例和多进程"><a href="#IS-IS多实例和多进程" class="headerlink" title="IS-IS多实例和多进程"></a>IS-IS多实例和多进程</h2><p>•IS-IS多实例是指在同一台路由器上，可以配置多个VPN实例与多个IS-IS进程相关联。</p>
<p>•IS-IS多进程指在同一个VPN下（或者同在公网下）可以创建多个IS-IS进程，每个进程之间互不影响，彼此独立。不同进程之间的路由交互相当于不同路由协议之间的路由交互。</p>
<p>•网络中可能需要同时承载不同的业务，为保证各业务的安全性，需要将业务进行隔离，此时，可以配置与VPN实例绑定。</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/54.png"></p>
<blockquote>
<p>•IS-IS多实例和多进程的特点如下：</p>
<ul>
<li><p>IS-IS多进程共用同一个全局路由表。而IS-IS多实例使用VPN中的路由表，并且每个VPN都有自己单独的路由表。</p>
</li>
<li><p>IS-IS多进程允许为一个指定的IS-IS进程关联一组接口，从而保证该进程进行的所有协议操作都仅限于这一组接口。这样，就可以实现一台路由器有多个IS-IS协议进程，每个进程负责唯一的一组接口。</p>
</li>
<li><p>IS-IS进程在创建时可以选择绑定一个VPN实例，于是这个IS-IS进程就与此VPN实例相关联，并且只接收和处理此VPN实例内的事件。当VPN实例删除时，IS-IS进程也会跟着被删除。</p>
</li>
</ul>
<p>•命令：[Huawei] <strong>isis</strong> [ <em>process-id</em> ] [ <strong>vpn-instance</strong> <em>vpn-instance-name</em> ]</p>
<ul>
<li><p><em>process-id</em>：指定IS-IS进程号。如果不指定进程，则启动进程号为1的IS-IS进程。整数形式，取值范围是1～65535。缺省值是1。</p>
</li>
<li><p><strong>vpn-instance</strong> <em>vpn-instance-name</em>：指定VPN实例名。如果不指定此参数，则就不会配置VPN实例与相应的IS-IS进程相关联。字符串形式，区分大小写，不支持空格，长度范围是1～31。当输入的字符串两端使用双引号时，可在字符串中输入空格。</p>
</li>
</ul>
</blockquote>
<h2 id="LSP分片"><a href="#LSP分片" class="headerlink" title="LSP分片"></a>LSP分片</h2><p>•当IS-IS要发布的PDU中信息量太大时，IS-IS路由器将会生成多个LSP分片，用来携带更多的IS-IS信息。</p>
<p>•LSP的报文格式为：</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/55.png"></p>
<p>•IS-IS LSP分片由LSP ID中的分片号（LSP Number）字段进行标识，这个字段的长度是1Byte。因此，一个IS-IS进程最多可产生256个LSP分片，携带的信息量有限。</p>
<h2 id="LSP分片扩展基本概念"><a href="#LSP分片扩展基本概念" class="headerlink" title="LSP分片扩展基本概念"></a>LSP分片扩展基本概念</h2><p>•IS-IS可以配置虚拟的系统ID ，并生成虚拟IS-IS的LSP报文来携带路由等信息。</p>
<ul>
<li><p>初始系统（Originating System）：初始系统是实际运行IS-IS的路由器。允许一个单独的IS-IS进程像多个虚拟路由器一样发布LSP，而“Originating System”指的是那个“真正”的IS-IS进程。</p>
</li>
<li><p>系统ID（Normal System-ID）：初始系统的系统ID。</p>
</li>
<li><p>虚拟系统（Virtual System）：由附加系统ID标识的系统，生成扩展LSP分片。这些分片在其LSP ID中携带附加系统ID。</p>
</li>
<li><p>附加系统ID（Additional System-ID）：虚拟系统的系统ID，由网络管理器统一分配。每个附加系统ID都允许生成256个扩展的LSP分片。</p>
</li>
<li><p>24号TLV（IS Alias ID TLV）：LSP分片携带该TLV信息，用来表示初始系统与虚拟系统的关系。</p>
</li>
</ul>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/56.png"></p>
<p>•使能分片扩展功能之后，如果存在由于报文装满而丢失的信息，系统会提醒重启IS-IS。重启之后，初始系统会尽最大能力装载路由信息，装不下的信息将放入虚拟系统的LSP中发送出去，并通过24号TLV来告知其他路由器此虚拟系统和自己的关系。</p>
<blockquote>
<p>•附加系统ID和系统ID都必须在整个路由域中唯一。</p>
</blockquote>
<h2 id="LSP分片扩展工作原理"><a href="#LSP分片扩展工作原理" class="headerlink" title="LSP分片扩展工作原理"></a>LSP分片扩展工作原理</h2><p>•在IS-IS中，每个系统ID都标识一个系统，每个系统都最多可生成256个LSP分片。通过增加附加系统ID，可以最多配置50个虚拟系统，从而使得IS-IS进程最多可生成13056个LSP分片。</p>
<p>•IS-IS路由器可以在两种模式下运行LSP分片扩展特性：</p>
<p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/57.png"></p>
<blockquote>
<p>•Mode-1工作原理：</p>
<ul>
<li>虚拟系统参与路由SPF计算，初始系统发布的LSP中携带了到每个虚拟系统的链路信息。类似地，虚拟系统发布的LSP也包含到初始系统的链路信息。这样，在网络中虚拟系统看起来与初始系统相连的真实路由器是一样的。</li>
<li>这种方式是为了兼容不支持分片扩展的老版本所做的一个过渡模式。在老版本中，IS-IS无法识别24号TLV，所以虚拟系统的LSP必须表现的像一个普通IS-IS发出的报文。</li>
<li>注意事项：<ul>
<li>虚拟系统的LSP中包含和原LSP中相同的区域地址和过载标志位。如果还有其它特性的TLV，也必须保持一致。</li>
<li>虚拟系统的邻居信息指向初始系统，metric为最大值减1；初始系统的邻居信息指向虚拟系统，metric必须为0。这样就保证了其它路由器在进行路由计算的时候，虚拟系统一定会成为初始系统的下游节点。</li>
</ul>
</li>
</ul>
<p>•Mode-2工作原理：</p>
<ul>
<li><p>虚拟系统不参与路由SPF计算，网络中所有路由器都知道虚拟系统生成的LSP实际属于初始系统。</p>
</li>
<li><p>在该模式下工作的IS-IS，可以识别24号TLV的内容，并作为计算树和路由的依据。</p>
</li>
</ul>
<p>•注意：无论在哪种方式下，初始系统和虚拟系统的LSP零分片中，都必须包含IS Alias ID TLV来表示初始系统是谁。</p>
</blockquote>
<h2 id="LSP分片扩展的基本配置命令"><a href="#LSP分片扩展的基本配置命令" class="headerlink" title="LSP分片扩展的基本配置命令"></a>LSP分片扩展的基本配置命令</h2><p><img src="/2021/05/31/IPadv-IGP%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/58.png"></p>
<blockquote>
<p>•命令：[Huawei-isis-1] <strong>lsp-fragments-extend</strong> [ [ <strong>level-1</strong> | <strong>level-2</strong> | <strong>level-1-2</strong> ] | [ <strong>mode-1</strong> | <strong>mode-2</strong> ] ] </p>
<p>​    ▫<strong>level-1</strong>：指定在Level-1级别使能分片扩展。</p>
<p>​    ▫<strong>level-2</strong>：指定在Level-2级别使能分片扩展。</p>
<p>​    ▫<strong>level-1-2</strong>：指定在Level-1-2级别使能分片扩展。</p>
<p>​    ▫<strong>mode-1</strong>：该模式可以兼容以前老版本不支持LSP分片扩展特性的情况。</p>
<p>​    ▫<strong>mode-2</strong>：该模式要求所有路由器都支持LSP分片扩展特性。</p>
<p>•命令：[Huawei-isis-1] <strong>virtual-system</strong> <em>virtual-system-id</em> </p>
<p>​    ▫<em>virtual-system-id</em>：指定IS-IS进程的虚拟系统ID。长度是6字节（48比特），格式是XXXX.XXXX.XXXX。</p>
</blockquote>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）OSPF有哪些快速收敛机制？(   )</p>
<p>A.I-SPF</p>
<p>B.LSP快速扩散</p>
<p><strong>C.智能定时器</strong></p>
<p><strong>D.OSPF IP FRR</strong></p>
<p>2.（判断题）OSPF的Type5 LSA中FA字段一定为0.0.0.0。(   )</p>
<p>A.正确</p>
<p><strong>B.错误</strong></p>
<p>3.（判断题）在IS-IS网络中，若设备运行Mode-2的LSP分片扩展，则虚拟系统不参与路由SPF计算，网络中所有路由器都知道虚拟系统生成的LSP实际属于初始系统。(   )</p>
<p><strong>A.正确</strong></p>
<p>B.错误</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•为了更好的适应网络拓扑的变化，OSPF和IS-IS支持多种快速收敛方式。通过I-SPF和PRC算法加速路由的计算，通过FRR可以实现备份链路的快速切换，还可以设置智能定时器控制链路状态信息的生成和路由计算的速度。</p>
<p>•为了控制路由表的规模以及提高网络性能，OSPF和IS-IS支持路由信息的过滤，支持等价路由，还支持下发缺省路由。</p>
<p>•为了实现协议路由表隔离，OSPF和IS-IS支持在同一台设备上部署多进程，进程之间的协议路由表互不影响。</p>
<p>•为了避免在外部路由引入时出现次优路径，OSPF通过Type5 LSA或Type7 LSA中的FA指导数据包转发。</p>
<p>•IS-IS为了能够携带更多的路由信息，支持LSP分片扩展。</p>
<p>•OSPF和IS-IS对以上各种特性的支持，使它们在现网中都被广泛灵活应用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/" itemprop="url">IP-企业数通解决方案概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-18T21:17:38+08:00">
                2021-05-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•1946年，第一台电子计算机的发明，为人类打开的信息化时代的大门，也为信息通信技术的发展奠定了基础。</p>
<p>•日新月异的信息通信技术，不断地改变着人们的生活方式，在过去的几年，以物联网、大数据、云计算、人工智能为代表的新一代ICT技术逐渐成为驱动社会和经济转型升级的重要引擎，渗透到各行各业中。</p>
<p>•数通网络是实现数据交互的基础设施，是打造数字世界的基石，新的ICT技术导致数据流量以及存储爆发式的增长，也为数通网络带来了更大的挑战，为应对挑战，各大厂商不断优化网络解决方案，以匹配数字化转型诉求。</p>
<p>•企业网络从应用领域可分为园区、WLAN、数据中心、广域等多个领域，本课程将从解决方案角度分别介绍数通网络在各领域的分类、架构、典型应用场景、趋势挑战以及华为在该领域的解决方案。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述数通网络在在数字世界中的功能及作用。</p>
<p>▫描述数通网络解决方案的场景分类以及基本概念。</p>
<p>▫描述华为园区网络、WLAN、数据中心网络以及广域网络解决方案。</p>
<h1 id="1-企业数通网络全景概览"><a href="#1-企业数通网络全景概览" class="headerlink" title="1.企业数通网络全景概览"></a>1.企业数通网络全景概览</h1><h2 id="万物互联，构造数字化世界"><a href="#万物互联，构造数字化世界" class="headerlink" title="万物互联，构造数字化世界"></a>万物互联，构造数字化世界</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/1.png"></p>
<h2 id="数通网络是“万物”-联结的管道"><a href="#数通网络是“万物”-联结的管道" class="headerlink" title="数通网络是“万物” 联结的管道"></a>数通网络是“万物” 联结的管道</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/2.png"></p>
<h2 id="数通网络如“河湖江海”，打造智能世界数字基石"><a href="#数通网络如“河湖江海”，打造智能世界数字基石" class="headerlink" title="数通网络如“河湖江海”，打造智能世界数字基石"></a>数通网络如“河湖江海”，打造智能世界数字基石</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/3.png"></p>
<blockquote>
<p>•数通网络如“河湖江海”，数通产业便是打造智能世界的数字基石。很多数通初学者对于数通的了解可能并不全面，通过与现实世界中的“河湖江海”类比，可以感受数通产业之光，责任之重。 </p>
<ul>
<li><p>数通是联结领域真正成网的产业，部署在网络的各个层级，犹如江河湖海；</p>
</li>
<li><p>5G接入和家宽接入犹如支流，园区网络好比池塘；</p>
</li>
<li><p>城域网好比长江的大型支流，如金沙江；骨干网好比长江；</p>
</li>
<li><p>核心数据中心是太平洋，区域数据中心是大型湖泊，如鄱阳湖，接入数据中心是水库；</p>
</li>
<li><p>华为在园区网络、广域及分支网络、数据中心网络及网络安全都在为客户提供优质服务，华为数通4大引擎，AirEngine是园区网络解决方案，NetEngine是城域和骨干网络解决方案，CloudEngine是DCN解决方案，HisecEngine是安全解决方案。</p>
</li>
</ul>
</blockquote>
<h2 id="河流分支：园区网络"><a href="#河流分支：园区网络" class="headerlink" title="河流分支：园区网络"></a>河流分支：园区网络</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/4.png"></p>
<h2 id="河流分支2：WLAN网络"><a href="#河流分支2：WLAN网络" class="headerlink" title="河流分支2：WLAN网络"></a>河流分支2：WLAN网络</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/5.png"></p>
<h2 id="湖海：数据中心网络"><a href="#湖海：数据中心网络" class="headerlink" title="湖海：数据中心网络"></a>湖海：数据中心网络</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/6.png"></p>
<h2 id="江流主干：广域网络"><a href="#江流主干：广域网络" class="headerlink" title="江流主干：广域网络"></a>江流主干：广域网络</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/7.png"></p>
<h2 id="华为四大引擎构建数通网络"><a href="#华为四大引擎构建数通网络" class="headerlink" title="华为四大引擎构建数通网络"></a>华为四大引擎构建数通网络</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/8.png"></p>
<h2 id="华为企业数通解决方案概览"><a href="#华为企业数通解决方案概览" class="headerlink" title="华为企业数通解决方案概览"></a>华为企业数通解决方案概览</h2><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/9.png"></p>
<h1 id="2-企业数通网络解决方案"><a href="#2-企业数通网络解决方案" class="headerlink" title="2.企业数通网络解决方案"></a>2.企业数通网络解决方案</h1><h2 id="园区网"><a href="#园区网" class="headerlink" title="园区网"></a>园区网</h2><h3 id="园区网络分类"><a href="#园区网络分类" class="headerlink" title="园区网络分类"></a>园区网络分类</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/10.png"></p>
<h3 id="典型园区网络应用：高教园区网"><a href="#典型园区网络应用：高教园区网" class="headerlink" title="典型园区网络应用：高教园区网"></a>典型园区网络应用：高教园区网</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/11.png"></p>
<blockquote>
<p>•<strong>Cernet</strong>一般指中国教育和科研计算机网。中国教育和科研计算机网（China Education and Research Network）简称CERNET，是由国家投资建设，教育部负责管理，清华大学等高等学校承担建设和管理运行的全国性学术计算机互联网络。</p>
</blockquote>
<h3 id="数字化时代，园区网络的特征"><a href="#数字化时代，园区网络的特征" class="headerlink" title="数字化时代，园区网络的特征"></a>数字化时代，园区网络的特征</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/12.png"></p>
<h3 id="园区网络运维面临的挑战"><a href="#园区网络运维面临的挑战" class="headerlink" title="园区网络运维面临的挑战"></a>园区网络运维面临的挑战</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/13.png"></p>
<h3 id="华为园区网络一站式自动驾驶解决方案"><a href="#华为园区网络一站式自动驾驶解决方案" class="headerlink" title="华为园区网络一站式自动驾驶解决方案"></a>华为园区网络一站式自动驾驶解决方案</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/14.png"></p>
<blockquote>
<p>•华为智简园区（CloudCampus）致力于为企业构建一张超宽、智慧、极简、安全、开放的基于业务意图的园区网络，时刻洞察并快速响应网络及业务需求，赋予企业捕捉转瞬即逝的商机能力。</p>
<p>•CloudCampus解决方案是园区网络一站式自动驾驶解决方案。</p>
</blockquote>
<h3 id="解决方案组件1：智简园区网络硬件产品全景"><a href="#解决方案组件1：智简园区网络硬件产品全景" class="headerlink" title="解决方案组件1：智简园区网络硬件产品全景"></a>解决方案组件1：智简园区网络硬件产品全景</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/15.png"> </p>
<h3 id="解决方案组件2：iMaster-NCE-Campus"><a href="#解决方案组件2：iMaster-NCE-Campus" class="headerlink" title="解决方案组件2：iMaster NCE-Campus"></a>解决方案组件2：iMaster NCE-Campus</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/16.png"></p>
<h3 id="解决方案组件3：iMaster-NCE-CampusInsight"><a href="#解决方案组件3：iMaster-NCE-CampusInsight" class="headerlink" title="解决方案组件3：iMaster NCE-CampusInsight"></a>解决方案组件3：iMaster NCE-CampusInsight</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/17.png"></p>
<h2 id="WLAN"><a href="#WLAN" class="headerlink" title="WLAN"></a>WLAN</h2><h3 id="WLAN场景分类"><a href="#WLAN场景分类" class="headerlink" title="WLAN场景分类"></a>WLAN场景分类</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/18.png"></p>
<h3 id="典型WLAN组网场景：大型园区（独立WAC）"><a href="#典型WLAN组网场景：大型园区（独立WAC）" class="headerlink" title="典型WLAN组网场景：大型园区（独立WAC）"></a>典型WLAN组网场景：大型园区（独立WAC）</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/19.png"></p>
<h3 id="典型WLAN组网场景：大型园区（有线无线融合）"><a href="#典型WLAN组网场景：大型园区（有线无线融合）" class="headerlink" title="典型WLAN组网场景：大型园区（有线无线融合）"></a>典型WLAN组网场景：大型园区（有线无线融合）</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/20.png"></p>
<h3 id="典型WLAN组网场景：连锁商超"><a href="#典型WLAN组网场景：连锁商超" class="headerlink" title="典型WLAN组网场景：连锁商超"></a>典型WLAN组网场景：连锁商超</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/21.png"></p>
<h3 id="双轮驱动：技术与应用发展助推Wi-Fi-6时代到来"><a href="#双轮驱动：技术与应用发展助推Wi-Fi-6时代到来" class="headerlink" title="双轮驱动：技术与应用发展助推Wi-Fi 6时代到来"></a>双轮驱动：技术与应用发展助推Wi-Fi 6时代到来</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/22.png"></p>
<h3 id="Wi-Fi-6带来更高性能"><a href="#Wi-Fi-6带来更高性能" class="headerlink" title="Wi-Fi 6带来更高性能"></a>Wi-Fi 6带来更高性能</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/23.png"></p>
<h3 id="WLAN运维挑战-三“难”"><a href="#WLAN运维挑战-三“难”" class="headerlink" title="WLAN运维挑战 三“难”"></a>WLAN运维挑战 三“难”</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/24.png"></p>
<h3 id="解决方案组件1-AirEngine-Wi-Fi-6多元化新产品"><a href="#解决方案组件1-AirEngine-Wi-Fi-6多元化新产品" class="headerlink" title="解决方案组件1: AirEngine Wi-Fi 6多元化新产品"></a>解决方案组件1: AirEngine Wi-Fi 6多元化新产品</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/25.png"></p>
<h3 id="解决方案组件2-iMaster-NCE-CampusInsight"><a href="#解决方案组件2-iMaster-NCE-CampusInsight" class="headerlink" title="解决方案组件2: iMaster NCE CampusInsight"></a>解决方案组件2: iMaster NCE CampusInsight</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/26.png"></p>
<h2 id="数据中心网络"><a href="#数据中心网络" class="headerlink" title="数据中心网络"></a>数据中心网络</h2><h3 id="什么是数据中心？"><a href="#什么是数据中心？" class="headerlink" title="什么是数据中心？"></a>什么是数据中心？</h3><p>•数据中心(Data Center)：是一整套包括机房在内复杂的设施。它不仅包括计算机系统和其它与之配套的设备（例如通信和存储系统），还包含冗余的数据通信连接、环境控制设备、监控设备以及各种安全装置。</p>
<p>•数据中心的使用分层架构。一般L1特指数据中心基础设施，L2指数据中心的ICT设备。</p>
<p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/27.png"></p>
<h3 id="数据中心有什么？"><a href="#数据中心有什么？" class="headerlink" title="数据中心有什么？"></a>数据中心有什么？</h3><p>数据中心设备简单分为三类：计算设备、存储设备和网络设备（不包括数据中心基础设施）。</p>
<p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/28.png"></p>
<h3 id="一个典型的数据中心组网"><a href="#一个典型的数据中心组网" class="headerlink" title="一个典型的数据中心组网"></a>一个典型的数据中心组网</h3><p>一个典型的数据中心组网包括，数据中心网络、存储区域网络（Storage Area Network，SAN）、服务器。</p>
<p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/29.png"></p>
<blockquote>
<p>•数据中心网络：提供数据中心内部计算单元之间互联、数据中心内部计算单元和外部出口之间互联的网络。</p>
<p>•存储区域网络：一般是由存储阵列和光纤交换机组成的存储网络，用于提供块存储（Block Storage）。存储网络使用FC协议的叫做FC SAN，使用IP协议的叫做IP SAN。</p>
<p>•分布式存储：分布式存储的部署形态和阵列不同。它将数据分散存储在多台独立的服务器（存储节点）上。一般也用作云存储。</p>
<p>•服务器（计算节点）：用于提供计算服务的服务器。</p>
</blockquote>
<h3 id="数据中心网络-1"><a href="#数据中心网络-1" class="headerlink" title="数据中心网络"></a>数据中心网络</h3><p>DCN是提供数据中心内部互联，和数据中心内部和外部出口互联的网络。</p>
<p>DCN通常由一系列网络设备组成，根据业务功能分为不同区域。</p>
<p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/30.png"></p>
<blockquote>
<p>•数据中心网络没有固定的区域划分，不同行业不同企业划分方式。例如有某金融数据中心，将数据中心根据功能划分为生产区1区、生产2区、测试区1区、测试2区、大数据区、运营管理区…</p>
<p>•本例中：</p>
<p>​    ▫互联网接入区：用于接入来自用户Internet访问的流量。</p>
<p>​    ▫园区网接入区：用于接入企业园区用户访问的流量。</p>
<p>​    ▫广域网接入区：用于连接企业自建广域网，远端有例如其他城市的数据中心和园区等。</p>
<p>​    ▫生产环境区：用于联通生产环境的网络。</p>
<p>​    ▫测试环境区：用于联通测试环境的网络。</p>
</blockquote>
<h3 id="数据中心网络，SDN和AI应用创新，带来3代演进"><a href="#数据中心网络，SDN和AI应用创新，带来3代演进" class="headerlink" title="数据中心网络，SDN和AI应用创新，带来3代演进"></a>数据中心网络，SDN和AI应用创新，带来3代演进</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/31.png"></p>
<blockquote>
<p>•AI时代的典型特征是关注数据，挖掘数据价值并提升AI运行效率，因此AI对数据中心网络的核心诉求是要快，即低时延。</p>
</blockquote>
<h3 id="新业务特征对数据中心网络提出新挑战"><a href="#新业务特征对数据中心网络提出新挑战" class="headerlink" title="新业务特征对数据中心网络提出新挑战"></a>新业务特征对数据中心网络提出新挑战</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/32.png"></p>
<h3 id="华为CloudFabric数据中心网络解决方案"><a href="#华为CloudFabric数据中心网络解决方案" class="headerlink" title="华为CloudFabric数据中心网络解决方案"></a>华为CloudFabric数据中心网络解决方案</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/33.png"></p>
<h3 id="华为智能无损数据中心网络"><a href="#华为智能无损数据中心网络" class="headerlink" title="华为智能无损数据中心网络"></a>华为智能无损数据中心网络</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/34.png"></p>
<blockquote>
<p>•RDMA是Remote Direct Memory Access的缩写，通俗的说可以看成是远程的DMA技术，为了解决网络传输中服务器端数据处理的延迟而产生的。RDMA允许用户态的应用程序直接读取或写入远程内存，而无内核干预和内存拷贝发生。起初，只应用在高性能计算领域，最近，由于在大规模分布式系统和数据中心中网络瓶颈越来越突出，逐渐走进越来越多人的视野。</p>
<p>•InfiniBand：一种交换结构I/O（Input/Output）技术，其设计思路是通过一套中心机构(中心InfiniBand交换机)在远程存贮器、网络以及服务器等设备之间建立一个单一的连接链路，并由中心InfiniBand交换机来指挥流量，它的结构设计得非常紧密，大大提高了系统的性能、可靠性和有效性，能缓解各硬件设备之间的数据流量拥塞。</p>
<p>•RoCE：Remote Direct Memory Access over Converged Ethernet。 RoCE是一种网络协议，允许通过以太网使用远程直接内存访问（RDMA）。目前存在两个RoCE版本，分别是RoCE v1和v2。RoCE v1是数据链路层协议，允许在同一个以太网广播域内的任意两台主机之间通信。RoCE v2是网络层协议，其报文可以被路由。</p>
</blockquote>
<h3 id="解决方案组件1：华为数据中心交换机"><a href="#解决方案组件1：华为数据中心交换机" class="headerlink" title="解决方案组件1：华为数据中心交换机"></a>解决方案组件1：华为数据中心交换机</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/35.png"></p>
<h3 id="解决方案组件2：iMaster-NCE-Fabric"><a href="#解决方案组件2：iMaster-NCE-Fabric" class="headerlink" title="解决方案组件2：iMaster NCE-Fabric"></a>解决方案组件2：iMaster NCE-Fabric</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/36.png"></p>
<h3 id="解决方案组件3：FabricInsight"><a href="#解决方案组件3：FabricInsight" class="headerlink" title="解决方案组件3：FabricInsight"></a>解决方案组件3：FabricInsight</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/37.png"></p>
<h2 id="SDN-WAN"><a href="#SDN-WAN" class="headerlink" title="SDN-WAN"></a>SDN-WAN</h2><h3 id="从智慧城市通信网络看广域网络"><a href="#从智慧城市通信网络看广域网络" class="headerlink" title="从智慧城市通信网络看广域网络"></a>从智慧城市通信网络看广域网络</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/38.png"></p>
<h3 id="广域IP承载网络与企业WAN"><a href="#广域IP承载网络与企业WAN" class="headerlink" title="广域IP承载网络与企业WAN"></a>广域IP承载网络与企业WAN</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/39.png"></p>
<h3 id="传统IP广域承载网络"><a href="#传统IP广域承载网络" class="headerlink" title="传统IP广域承载网络"></a>传统IP广域承载网络</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/40.png"></p>
<p>•WAN（Wide Area Network）即广域网络，是连接不同地区局域网或城域网计算机通信的远距离通信网。</p>
<p>•从空间上来讲，广域网络大多数情况下是跨区域的，其承载网络建设难度大，成本高，周期长。</p>
<p>•业务部署效率、网络拥塞，时延等，是广域承载网络需要考虑的重要因素。</p>
<h3 id="传统IP广域承载网络面临的挑战"><a href="#传统IP广域承载网络面临的挑战" class="headerlink" title="传统IP广域承载网络面临的挑战"></a>传统IP广域承载网络面临的挑战</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/41.png"></p>
<h3 id="华为IP广域承载网络解决方案"><a href="#华为IP广域承载网络解决方案" class="headerlink" title="华为IP广域承载网络解决方案"></a>华为IP广域承载网络解决方案</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/42.png"></p>
<h3 id="SDN-WAN方案典型应用场景：金融"><a href="#SDN-WAN方案典型应用场景：金融" class="headerlink" title="SDN-WAN方案典型应用场景：金融"></a>SDN-WAN方案典型应用场景：金融</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/43.png"></p>
<h3 id="SDN-WAN方案典型应用场景：电子政务"><a href="#SDN-WAN方案典型应用场景：电子政务" class="headerlink" title="SDN-WAN方案典型应用场景：电子政务"></a>SDN-WAN方案典型应用场景：电子政务</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/44.png"></p>
<h3 id="解决方案组件1：NetEngine-8000"><a href="#解决方案组件1：NetEngine-8000" class="headerlink" title="解决方案组件1：NetEngine 8000"></a>解决方案组件1：NetEngine 8000</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/45.png"></p>
<h3 id="解决方案组件2：iMaster-NCE-IP"><a href="#解决方案组件2：iMaster-NCE-IP" class="headerlink" title="解决方案组件2：iMaster NCE-IP"></a>解决方案组件2：iMaster NCE-IP</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/46.png"></p>
<h2 id="SD-WAN"><a href="#SD-WAN" class="headerlink" title="SD-WAN"></a>SD-WAN</h2><h3 id="传统企业WAN简介"><a href="#传统企业WAN简介" class="headerlink" title="传统企业WAN简介"></a>传统企业WAN简介</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/47.png"></p>
<blockquote>
<p>•WAN（Wide Area Network）即广域网络，一般由运营商提供，是连接不同地区局域网或城域网计算机通信的远距离通信网。WAN所覆盖的范围从几十千米到几万千米，能连接多个不同的地区、城市和国家，提供远距离通信。正是因为通过WAN，企业可以将全球范围内的分支机构连接起来建立互联网络，进而互联互通开展企业的各项日常业务。</p>
<p>•传统企业WAN一般有两种互联方式：</p>
<p>​    ▫企业可以自己铺设或租用运营商光纤线路搭建互联网络。</p>
<p>​    ▫企业可以通过租用运营商的传输或数据网络来实现互联网络。</p>
<p>•一般来说，只有那些财力雄厚、实力超强的企业才使用第一种方式，绝大多数企业都会采用第二种方式，即租用运营商提供的线路或网络来搭建自己的WAN。另外，随着Internet的高速发展，通过Internet实现分支互联也成为一种可能。但是考虑到Internet的不可靠性并缺少端到端的质量保证，一般情况下大型企业不会完全依赖Internet来构建WAN，实现多地分支的互联。Internet更多的时候会作为出差员工远程接入的方式，或者作为分支互联的备份方案，只承担一些非关键业务。</p>
<p>•企业WAN借助运营商提供的WAN网络，将企业分布在跨地域的多个分支、总部和数据中心实现互联。传统企业的关键应用和信息数据一般都存储在企业内部，WAN带宽需求较小、业务变化不频繁；WAN网络的运营和维护也一般依靠本地化的运维团队。这种传统企业WAN技术架构在相当长的时间，为企业的分支互联互通发挥了重要的作用，比较好地满足了企业用户的业务需要。</p>
</blockquote>
<h3 id="传统企业WAN面临挑战"><a href="#传统企业WAN面临挑战" class="headerlink" title="传统企业WAN面临挑战"></a>传统企业WAN面临挑战</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/48.png"></p>
<h3 id="企业WAN相关技术的发展趋势"><a href="#企业WAN相关技术的发展趋势" class="headerlink" title="企业WAN相关技术的发展趋势"></a>企业WAN相关技术的发展趋势</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/49.png"></p>
<h3 id="华为智简SD-WAN，加速企业业务云化转型"><a href="#华为智简SD-WAN，加速企业业务云化转型" class="headerlink" title="华为智简SD-WAN，加速企业业务云化转型"></a>华为智简SD-WAN，加速企业业务云化转型</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/50.png"></p>
<h3 id="SD-WAN方案总体架构"><a href="#SD-WAN方案总体架构" class="headerlink" title="SD-WAN方案总体架构"></a>SD-WAN方案总体架构</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/51.png"></p>
<h3 id="基于SD-WAN思想的EVPN互联方案"><a href="#基于SD-WAN思想的EVPN互联方案" class="headerlink" title="基于SD-WAN思想的EVPN互联方案"></a>基于SD-WAN思想的EVPN互联方案</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/52.png"></p>
<h3 id="解决方案组件1：全系列NetEngine-AR"><a href="#解决方案组件1：全系列NetEngine-AR" class="headerlink" title="解决方案组件1：全系列NetEngine AR"></a>解决方案组件1：全系列NetEngine AR</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/53.png"></p>
<h3 id="解决方案组件2：iMaster-NCE-WAN"><a href="#解决方案组件2：iMaster-NCE-WAN" class="headerlink" title="解决方案组件2：iMaster NCE-WAN"></a>解决方案组件2：iMaster NCE-WAN</h3><p><img src="/2021/05/18/IP-%E4%BC%81%E4%B8%9A%E6%95%B0%E9%80%9A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0/54.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）以下哪个名称对应华为在WLAN领域的产品：</p>
<p><strong>A.AirEngine</strong></p>
<p>B.NetEngine</p>
<p>C.CloudEngine</p>
<p>D.HiSecEngine</p>
<p>2.（问答题）华为CloudCampus解决方案支持业务随行功能，该功能对于用户的价值是？</p>
<p><strong>业务随行：图形化策略配置，用户随时随地接入，漫游权限不变，体验不变。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本课程系统地向读者介绍了数字世界中的数据通信网络全景。</p>
<p>•通过本课程的学习，读者了解了园区网络、WLAN、数据中心网络及广域网络的概念及其重要意义。也了解了典型行业中，上述网络的基本架构及应用。</p>
<p>•通过本课程的学习，读者还系统地了解了华为企业数通解决方案，包括园区网络解决方案、WLAN解决方案、数据中心网络解决方案、广域IP承载网络解决方案和SD-WAN解决方案。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/" itemprop="url">IP-大型WLAN组网介绍与部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-18T20:37:03+08:00">
                2021-05-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•目前，大多数企业办公环境同时使用有线和无线网络来支撑业务。办公区在提供有线网口的同时，也采用全Wi-Fi覆盖，办公环境更为开放和智能。未来，企业云桌面办公、智真会议、4K视频等大带宽业务将从有线网络迁移至无线网络，而VR/AR、虚拟助手、自动化工厂等新技术将直接基于无线网络部署。新的应用场景对企业WLAN的设计与规划提出更高的要求。</p>
<p>•本课程介绍大型WLAN组网的典型应用、关键技术原理以及大型WLAN组网的配置。</p>
<blockquote>
<p>•云桌面又称桌面虚拟化、云电脑，是替代传统电脑的一种新模式；采用云桌面后，用户无需再购买电脑主机，用户安装客户端后通过特有的通信协议访问后端服务器上的虚拟机主机来实现交互式操作，达到与电脑一致的体验效果；同时，云桌面不仅支持用于替换传统电脑，还支持手机、平板等其他智能设备在互联网上访问，也是移动办公的最新解决方案。</p>
<p>•智真会议是通过高分辨率摄像头和语音设备，提供真人大小面对面、眼对眼的视频会议。</p>
<p>•VR：Virtual Reality，虚拟现实，指用计算机模拟三维环境，用户常常借助手套和眼镜就能直接交互操作。</p>
<p>•AR：Augmented Reality，增强现实，在虚拟现实的基础上发展起来的新技术，也被称为混合现实。是通过计算机系统提供的信息增加用户对现实世界感知的技术，将虚拟的信息应用到真实世界，并将计算机生成的虚拟物体、场景或系统提示信息叠加到真实场景中，从而实现对现实的增强。AR通常是以透过式头盔显示系统和注册（AR系统中用户观察点和计算机生成的虚拟物体的定位）系统相结合的形式来实现的。</p>
</blockquote>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫阐述大型WLAN典型组网架构与特点</p>
<p>▫阐述大型WLAN的关键技术</p>
<p>▫实现大型WLAN的组网配置</p>
<h1 id="1-大型WLAN组网概述"><a href="#1-大型WLAN组网概述" class="headerlink" title="1.大型WLAN组网概述"></a>1.大型WLAN组网概述</h1><h2 id="大型WLAN组网的应用"><a href="#大型WLAN组网的应用" class="headerlink" title="大型WLAN组网的应用"></a>大型WLAN组网的应用</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/1.png"></p>
<blockquote>
<p>•高新科技园区会使用大量的新兴技术，比如IoT、5G融合、自动驾驶等等技术。</p>
</blockquote>
<h2 id="大型WLAN组网特点"><a href="#大型WLAN组网特点" class="headerlink" title="大型WLAN组网特点"></a>大型WLAN组网特点</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/2.png"></p>
<h2 id="华为大型WLAN方案功能"><a href="#华为大型WLAN方案功能" class="headerlink" title="华为大型WLAN方案功能"></a>华为大型WLAN方案功能</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/3.png"></p>
<h2 id="WLAN网络解决方案"><a href="#WLAN网络解决方案" class="headerlink" title="WLAN网络解决方案"></a>WLAN网络解决方案</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/4.png"></p>
<h2 id="大型WLAN网络关键技术"><a href="#大型WLAN网络关键技术" class="headerlink" title="大型WLAN网络关键技术"></a>大型WLAN网络关键技术</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/5.png"></p>
<h1 id="2-VLAN-Pool"><a href="#2-VLAN-Pool" class="headerlink" title="2.VLAN Pool"></a>2.<strong>VLAN Pool</strong></h1><h2 id="VLAN-Pool-概念"><a href="#VLAN-Pool-概念" class="headerlink" title="VLAN Pool 概念"></a>VLAN Pool 概念</h2><p>•现有网络面临的挑战</p>
<ul>
<li><p>无线网络终端的移动性导致特定区域IP地址请求较多。</p>
</li>
<li><p>通过情况下，一个SSID只能对应一个业务VLAN，如果通过扩大子网增加IP地址则会导致广播域扩大，大量的广播报文造成网络拥塞。</p>
</li>
</ul>
<p>•VLAN Pool是一种把多个VLAN放在一个池中并提供分配算法的VLAN分配技术，又称为VLAN池。</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/6.png"></p>
<blockquote>
<p>•通过VLAN Pool把接入的用户分配到不同的VLAN，可以减少广播域，减少网络中的广播报文，提升网络性能。</p>
<p>•由于无线终端的移动性，在无线网络中经常有大量用户从某个区域接入后，随着用的移动，再漫游到其他区域，导致该区域的用户接入多，对IP地址数目要求大。比如：场馆入口、酒店的大堂等。目前一个SSID只能对应一个VLAN，一个VLAN对应一个子网，如果大量用户从某一区域接入，只能扩大VLAN的子网，保证用户能够获取到IP地址。这样带来的问题就是广播域扩大，导致大量的广播报文（如：ARP、DHCP等）带来严重的网络拥塞。</p>
<p>•基于此问题考虑，一个SSID需要能够对应多个VLAN，把大量用户分散到不同的VLAN减少广播域。VLAN Pool提供多个VLAN的管理和分配算法，实现SSID对应多个VLAN的方案。</p>
</blockquote>
<h2 id="VLAN-Pool分配VLAN的算法"><a href="#VLAN-Pool分配VLAN的算法" class="headerlink" title="VLAN Pool分配VLAN的算法"></a>VLAN Pool分配VLAN的算法</h2><p>•顺序分配算法：把用户按上线顺序依次划分到不同的VLAN中。</p>
<p>•HASH分配算法：根据用户MAC地址HASH值分配VLAN。</p>
<p>•两种分配方式的比较：</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/7.png"></p>
<blockquote>
<p>•顺序分配算法：把用户按上线顺序依次划分到不同的VLAN中，用户上下线用户VLAN容易变化，IP地址变更。</p>
<p>•HASH分配算法：根据用户MAC地址HASH值分配VLAN，用户分配的VLAN固定，可能导致VLAN间用户划分不均匀，有的VLAN用户较多，有的较少。</p>
</blockquote>
<h2 id="分配VLAN流程"><a href="#分配VLAN流程" class="headerlink" title="分配VLAN流程"></a>分配VLAN流程</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/8.png"></p>
<p>1.用户终端从某个VAP接入，判断VAP是否有判断VLAN Pool。</p>
<p>2.如果该VAP对应的模板绑定了VLAN Pool，使用VLAN Pool的分配算法分配一个VLAN, VLAN Pool有顺序分配和hash分配两种分配算法。</p>
<p>3.给终端分配一个VLAN。</p>
<p>4.终端从VLAN Pool分配的VLAN上线。</p>
<blockquote>
<p>•虚拟接入点VAP（Virtual Access Point）：VAP就是在一个物理实体AP上虚拟出多个AP，每一个被虚拟出的AP就是一个VAP，每个VAP提供和物理实体AP一样的功能。用户可以在一个AP上创建不同的VAP来为不同的用户群体提供无线接入服务。</p>
</blockquote>
<h2 id="VLAN-Pool应用示例"><a href="#VLAN-Pool应用示例" class="headerlink" title="VLAN Pool应用示例"></a>VLAN Pool应用示例</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/9.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/10.png"></p>
<h2 id="配置介绍"><a href="#配置介绍" class="headerlink" title="配置介绍"></a>配置介绍</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/11.png"></p>
<blockquote>
<p>•VLAN pool中可以配置VLAN分配算法。assignment { even | hash }</p>
<ul>
<li><p>VLAN分配算法为even时，VLAN pool根据STA的上线顺序为STA分配业务VLAN，VLAN pool尽量保证所有VLAN分配给STA的IP地址数目相近。但同一个STA如果多次上线，每次获取的地址通常都不相同。</p>
</li>
<li><p>VLAN分配算法为hash时，VLAN pool根据STA的MAC地址进行哈希运算后的结果为STA分配业务VLAN，只要VLAN pool里面的VLAN不发生变化，通常STA都会获取到固定的业务VLAN，STA重新上线时也会被尽量优先分配到之前使用过的IP地址。</p>
</li>
</ul>
</blockquote>
<h2 id="配置案例"><a href="#配置案例" class="headerlink" title="配置案例"></a>配置案例</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/12.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/13.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/14.png"></p>
<h1 id="3-DHCP技术"><a href="#3-DHCP技术" class="headerlink" title="3.DHCP技术"></a>3.DHCP技术</h1><h2 id="DHCP中继"><a href="#DHCP中继" class="headerlink" title="DHCP中继"></a>DHCP中继</h2><p>•DHCP客户端使用IP广播来寻找同一网段上的DHCP服务器。当服务器和客户段处在不同网段，即被路由器分割开来时，路由器是不会转发这样的广播包。</p>
<p>•DHCP中继能够跨网段“透传”DHCP报文，使得一个DHCP服务器同时为多个网段服务成为可能。</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/15.png"></p>
<blockquote>
<p>•随着网络规模的不断扩大，网络设备不断增多，企业内不同的用户可能分布在不同的网段，一台DHCP服务器在正常情况下无法满足多个网段的地址分配需求。企业内网各个网段通常都没有与DHCP Server在同一个二层广播域内，如果还需要通过DHCP服务器分配IP地址，则需要跨网段发送DHCP协议报文。</p>
</blockquote>
<h2 id="配置介绍-1"><a href="#配置介绍-1" class="headerlink" title="配置介绍"></a>配置介绍</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/16.png"></p>
<h2 id="配置案例-1"><a href="#配置案例-1" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/17.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/18.png"></p>
<h2 id="配置案例-2"><a href="#配置案例-2" class="headerlink" title="配置案例 (2)"></a>配置案例 (2)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/19.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/20.png"></p>
<h2 id="配置案例-3"><a href="#配置案例-3" class="headerlink" title="配置案例 (3)"></a>配置案例 (3)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/21.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/22.png"></p>
<h2 id="配置案例-4"><a href="#配置案例-4" class="headerlink" title="配置案例 (4)"></a>配置案例 (4)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/23.png"></p>
<h2 id="WLAN三层组网AC发现机制"><a href="#WLAN三层组网AC发现机制" class="headerlink" title="WLAN三层组网AC发现机制"></a>WLAN三层组网AC发现机制</h2><p>当AC和AP间是三层组网时，AP通过发送广播请求报文的方式无法发现AC，这时需要通过DHCP服务器回应给AP的报文中携带的Option43字段（IPv4）或Option52（IPv6）来通告AC的IP地址。</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/24.png"></p>
<blockquote>
<p>•在AC和AP间是二层组网的情况下，也可以配置Option43，AP会根据Option43的内容先向指定IP地址的AC发送单播请求报文，如果发送十次报文，AP都没有收到回应，则AP会继续以广播的方式来发现同一网段的AC。所以在二层组网的情况下Option 43不是必配的参数，但在三层组网的情况下则是必配的。</p>
<p>•Option 43即为Type值为43（0x2B）的Option字段，又称为厂商特定信息选项，DHCP服务器和DHCP客户端通过Option43交换厂商特定的信息。当DHCP服务器接收到请求Option43信息的DHCP请求报文后，将在回复报文中携带Option43，为DHCP客户端分配厂商指定的信息（本文中特指AC的IP地址）。</p>
</blockquote>
<h2 id="配置介绍-2"><a href="#配置介绍-2" class="headerlink" title="配置介绍"></a>配置介绍</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/25.png"></p>
<blockquote>
<p>•以AC或交换机配置DHCP服务器为例。大型组网中，通常都是使用独立的DHCP服务器，实际上AC或交换机也可以作为DHCP服务器。然后选择下面的一条命令配置Option43就可以了。</p>
<ul>
<li>option 43 sub-option 1 hex C0A80001C0A80002配置设备为AP指定AC的IP地址为192.168.0.1和192.168.0.2。其中，“C0A80001”表示IP地址192.168.0.1的十六进制格式，“C0A80002”表示IP地址192.168.0.2的十六进制格式。</li>
<li>option 43 sub-option 2 ip-address 192.168.0.1 192.168.0.2配置设备为AP指定AC的IP地址为192.168.0.1和192.168.0.2。</li>
<li>option 43 sub-option 3 ascii 192.168.0.1,192.168.0.2配置设备为AP指定AC的IP地址为192.168.0.1和192.168.0.2，选项使用ASCII字符串类型时，如果要配置多个IP地址，IP地址之间要使用“,”隔开。</li>
</ul>
</blockquote>
<h2 id="配置案例-1-1"><a href="#配置案例-1-1" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/26.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/27.png"></p>
<h2 id="配置案例-2-1"><a href="#配置案例-2-1" class="headerlink" title="配置案例 (2)"></a>配置案例 (2)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/28.png"></p>
<h1 id="4-漫游技术"><a href="#4-漫游技术" class="headerlink" title="4.漫游技术"></a>4.漫游技术</h1><h2 id="WLAN漫游概述"><a href="#WLAN漫游概述" class="headerlink" title="WLAN漫游概述"></a>WLAN漫游概述</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/29.png"></p>
<p>•WLAN漫游是指STA在不同AP覆盖范围之间移动且保持用户业务不中断的行为。</p>
<p>•实现WLAN漫游的两个AP必须使用相同的SSID和安全模板（安全模板名称可以不同，但是安全模板下的配置必须相同），认证模板的认证方式和认证参数也要配置相同。</p>
<p>•WLAN漫游策略主要解决以下问题：</p>
<p>​    ▫避免漫游过程中的认证时间过长导致丢包甚至业务中断。</p>
<p>​    ▫保证用户授权信息不变。</p>
<p>​    ▫保证用户IP地址不变。</p>
<blockquote>
<p>•终端在移动过程中，终端在移动过程中， 如果逐渐远离接入AP，则链路的信号质量也会逐步下降。当终端感知到信号质量降低一定程度（漫游门限）时，终端会主动漫游到附近AP来提高信号质量。</p>
<p>•如图所示，漫游一般包括如下动作：</p>
<ul>
<li><p>终端已经与AP1建链，终端在各种信道中发送Probe Request。AP2在信道6（AP2使用的信道）中收到请求后，通过在信道6中发送应答来进行响应。终端收到应答后，对其进行评估，确定同哪个AP关联最合适。此时通过评估，终端与AP2关联最合适。</p>
</li>
<li><p>终端通过信道6向AP2发送关联请求，AP2使用关联响应做出应答，建立用户与AP2间的关联，至此，用户与AP1的关联一直保持。</p>
</li>
<li><p>删除用户与AP1现有的关联。终端通过信道1（AP1使用的信道）向AP1发送802.11解除关联信息，解除用户与AP1间的关联。</p>
</li>
</ul>
</blockquote>
<h2 id="WLAN漫游的相关术语"><a href="#WLAN漫游的相关术语" class="headerlink" title="WLAN漫游的相关术语"></a>WLAN漫游的相关术语</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/30.png"></p>
<blockquote>
<p>•AC内漫游：如果漫游过程中关联的是同一个AC，这次漫游就是AC内漫游。</p>
<p>•AC间漫游：如果漫游过程中关联的不是同一个AC，这次漫游就是AC间漫游。</p>
<p>•AC间隧道：为了支持AC间漫游，漫游组内的所有AC需要同步每个AC管理的STA和AP设备的信息，因此在AC间建立一条隧道作为数据同步和报文转发的通道。AC间隧道也是利用CAPWAP协议创建的。如图所示，AC1和AC2间建立AC间隧道进行数据同步和报文转发。</p>
<p>•漫游组服务器</p>
<ul>
<li><p>STA在AC间进行漫游，通过选定一个AC作为漫游组服务器，在该AC上维护漫游组的成员表，并下发到漫游组内的各AC，使漫游组内的各AC间相互识别并建立AC间隧道。</p>
</li>
<li><p>漫游组服务器既可以是漫游组外的AC，也可以是漫游组内选择的一个AC。</p>
</li>
<li><p>一个AC可以同时作为多个漫游组的漫游组服务器，但是自身只能加入一个漫游组。</p>
</li>
<li><p>漫游组服务器管理其他AC的同时不能被其他的漫游组服务器管理。也就是说如果一个AC是作为漫游组服务器角色负责向其他AC同步漫游配置的，则它无法再作为被管理者接受其他AC向其同步漫游配置（即配置了漫游组就不能再配置漫游组服务器）。</p>
</li>
<li><p>漫游组服务器作为一个集中配置点，不需要有特别强的数据转发能力，只需要能够和各个AC互通即可。</p>
</li>
</ul>
<p>•家乡代理</p>
<ul>
<li>能够和STA家乡网络的网关二层互通的一台设备。为了支持STA漫游后仍能正常访问家乡网络，需要将STA的业务报文通过隧道转发到家乡代理，再由家乡代理中转。STA的家乡代理由HAC或HAP兼任，如图所示，用户可以选取AC1或AP1作为STA的家乡代理。</li>
</ul>
</blockquote>
<h2 id="WLAN漫游类型"><a href="#WLAN漫游类型" class="headerlink" title="WLAN漫游类型"></a>WLAN漫游类型</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/31.png"></p>
<blockquote>
<p>•二层漫游：1个无线客户端在2个AP（或多个AP）之间来回切换连接无线，前提是这些AP都绑定的是同1个SSID并且业务VLAN都在同1个VLAN内（在同一个IP地址段），漫游切换的过程中，无线客户端的接入属性（比如无线客户端所属的业务VLAN、获取的IP地址等属性）不会有任何变化，直接平滑过渡，在漫游的过程中不会有丢包和断线重连的现象。</p>
<p>•三层漫游：漫游前后SSID的业务VLAN不同，AP所提供的业务网络为不同的三层网络，对应不同的网关。此时，为保持漫游用户IP地址不变的特性，需要将用户流量迂回到初始接入网段的AP，实现跨VLAN漫游。</p>
<p>•网络中有时候会出现以下情况：两个业务VLAN的VLAN ID相同，但是这两个子网又属于不同的子网。此时为了避免系统仅仅依据VLAN ID将用户在两个子网间的漫游误判为二层漫游，需要通过漫游域来确定设备是否在同一个子网内，只有当VLAN相同且漫游域也相同的时候才是二层漫游，否则是三层漫游。</p>
</blockquote>
<h2 id="WLAN漫游流量转发模型"><a href="#WLAN漫游流量转发模型" class="headerlink" title="WLAN漫游流量转发模型"></a>WLAN漫游流量转发模型</h2><p>根据WLAN数据转发类型以及跨三层与否，可将漫游流量转发模型划分为四种：</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/32.png"></p>
<h2 id="AC间二层漫游-直接转发"><a href="#AC间二层漫游-直接转发" class="headerlink" title="AC间二层漫游 - 直接转发"></a>AC间二层漫游 - 直接转发</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/33.png"></p>
<p>漫游前：</p>
<p>•STA发送业务报文给HAP。</p>
<p>•HAP接收到业务报文后经由网关（交换机）发送给上层网络。</p>
<p>漫游后：</p>
<p>•STA发送业务报文给FAP。</p>
<p>•FAP接收到业务报文后经由网关（交换机）发送给上层网络。</p>
<blockquote>
<p>•AC间二层漫游隧道转发与直接转发流量走向一致，不再赘述。</p>
</blockquote>
<h2 id="AC间三层漫游-隧道转发"><a href="#AC间三层漫游-隧道转发" class="headerlink" title="AC间三层漫游 - 隧道转发"></a>AC间三层漫游 - 隧道转发</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/34.png"></p>
<p>漫游前： </p>
<p>1.STA发送业务报文给HAP。</p>
<p>2.HAP接收到业务报文后通过CAPWAP隧道发送给HAC。</p>
<p>3.HAC直接将业务报文经过交换机发送给上层网络。</p>
<p>漫游后：</p>
<p>1.STA发送业务报文给FAP。</p>
<p>2.FAP接收到业务报文后通过CAPWAP隧道发送给FAC 。</p>
<p>3.FAC通过HAC和FAC之间的AC间隧道将业务报文转发给HAC。</p>
<p>4.HAC直接将业务报文经由交换机发送给上层网络。</p>
<blockquote>
<p>•三层漫游时，用户漫游前后不在同一个子网中，为了使用户漫游后仍能正常访问漫游前的网络，需要将用户流量通过隧道中转到原来的子网。</p>
<p>•隧道转发模式下，HAP和HAC之间的业务报文通过CAPWAP隧道封装，此时可以将HAP和HAC看作在同一个子网内，报文无需返回到HAP， 直接通过HAC进行中转到上层网络。</p>
</blockquote>
<h2 id="AC间三层漫游-直接转发（HAP为家乡代理）"><a href="#AC间三层漫游-直接转发（HAP为家乡代理）" class="headerlink" title="AC间三层漫游 - 直接转发（HAP为家乡代理）"></a>AC间三层漫游 - 直接转发（HAP为家乡代理）</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/35.png"></p>
<blockquote>
<p>漫游前： </p>
<p>1.STA发送业务报文给HAP。</p>
<p>2.HAP接收到业务报文后直接将业务报文经过交换机发送给上层网络。</p>
<p>漫游后：</p>
<p>1.STA发送业务报文给FAP。</p>
<p>2.FAP接收到STA发送的业务报文并通过CAPWAP隧道发送给FAC。</p>
<p>3.FAC通过HAC和FAC之间的AC间隧道将业务报文转发给HAC。</p>
<p>4.HAC通过CAPWAP隧道将业务报文发送给HAP。</p>
<p>5.HAP直接将业务报文发送给上层网络。</p>
</blockquote>
<blockquote>
<p>•直接转发模式下，HAP和HAC之间的业务报文不通过CAPWAP隧道封装，无法判定HAP和HAC是否在同一个子网内，此时设备默认报文需要返回到HAP进行中转。如果HAP和HAC在同一个子网时，可以将家乡代理设置为性能更强的HAC，减少HAP的负荷并提高转发效率。</p>
</blockquote>
<h2 id="AC间三层漫游-直接转发（HAC为家乡代理）"><a href="#AC间三层漫游-直接转发（HAC为家乡代理）" class="headerlink" title="AC间三层漫游 - 直接转发（HAC为家乡代理）"></a>AC间三层漫游 - 直接转发（HAC为家乡代理）</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/36.png"></p>
<p>漫游前： </p>
<p>1.STA发送业务报文给HAP。</p>
<p>2.HAP接收到业务报文后直接将业务报文经过交换机发送给上层网络。</p>
<p>漫游后：</p>
<p>1.STA发送业务报文给FAP。</p>
<p>2.FAP接收到STA发送的业务报文并通过CAPWAP隧道发送给FAC。</p>
<p>3.FAC通过HAC和FAC之间的AC间隧道将业务报文转发给HAC。</p>
<p>4.HAC直接将业务报文发送给上层网络。</p>
<blockquote>
<p>•直接转发模式下，HAP和HAC之间的业务报文不通过CAPWAP隧道封装，无法判定HAP和HAC是否在同一个子网内，此时设备默认报文需要返回到HAP进行中转。如果HAP和HAC在同一个子网时，可以将家乡代理设置为性能更强的HAC，减少HAP的负荷并提高转发效率。</p>
</blockquote>
<h2 id="AC间漫游配置介绍"><a href="#AC间漫游配置介绍" class="headerlink" title="AC间漫游配置介绍"></a>AC间漫游配置介绍</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/37.png"></p>
<blockquote>
<p>•配置漫游组。</p>
<ul>
<li>如果指定了漫游组服务器，则需要在漫游组服务器上配置漫游组。</li>
<li>如果没有指定漫游组服务器，则各成员AC均需配置漫游组。</li>
</ul>
</blockquote>
<h2 id="配置案例-1"><a href="#配置案例-1" class="headerlink" title="配置案例"></a>配置案例<img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/38.png"></h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/39.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/40.png"></p>
<h1 id="5-高可靠性技术"><a href="#5-高可靠性技术" class="headerlink" title="5.高可靠性技术"></a>5.高可靠性技术</h1><h2 id="AC高可靠性概述"><a href="#AC高可靠性概述" class="headerlink" title="AC高可靠性概述"></a>AC高可靠性概述</h2><p>•在WLAN组网中，为保证组网可靠性，常见的备份技术有：</p>
<p>​    ▫VRRP双机热备份（主备）</p>
<p>​    ▫双链路冷备份</p>
<p>​    ▫双链路热备份（主备&amp;负载分担）</p>
<p>​    ▫N+1备份</p>
<p>•为了保证WLAN业务的稳定运行，热备份（Hot-Standby Backup）机制可以保证在主设备故障时业务能够不中断的顺利切换到备份设备。</p>
<blockquote>
<p>•热备份是指，当两台设备在确定主用（Master）设备和备用（Backup）设备后，由主用设备进行业务的转发，而备用设备处于监控状态，同时主用设备实时向备用设备发送状态信息和需要备份的信息，当主用设备出现故障后，备用设备及时接替主用设备的业务运行。</p>
<p>•VRRP双机热备份</p>
<ul>
<li><p>主备AC两个独立的IP地址，通过VRRP对外虚拟为同一个IP地址，单个AP和虚拟IP建立一条CAPWAP链路。</p>
</li>
<li><p>主AC备份AP信息、STA信息和CAPWAP链路信息，并通过HSB主备服务将信息同步给备AC。主AC故障后，备AC直接接替工作。</p>
</li>
</ul>
<p>•双链路热备份</p>
<ul>
<li><p>单个AP分别和主备AC建立CAPWAP链路，一条主链路，一条备链路。</p>
</li>
<li><p>主AC仅备份STA信息，并通过HSB主备服务将信息同步给备AC。主AC故障后，AP切换到备链路上，备AC接替工作。</p>
</li>
</ul>
<p>•双链路冷备份</p>
<ul>
<li><p>单个AP分别和主备AC建立CAPWAP链路，一条主链路，一条备链路。</p>
</li>
<li><p>AC不备份同步信息。主AC故障后，AP切换到备链路上，备AC接替工作。</p>
</li>
</ul>
<p>•N+1备份</p>
<ul>
<li><p>单个AP只和一个AC建立CAPWAP链路。</p>
</li>
<li><p>AC不备份同步信息。主AC故障后，AP重新与备AC建链CAPWAP链路，备AC接替工作。</p>
</li>
</ul>
</blockquote>
<h2 id="VRRP双机热备"><a href="#VRRP双机热备" class="headerlink" title="VRRP双机热备"></a>VRRP双机热备</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/41.png"></p>
<p>•两台AC组成一个VRRP组，主、备AC对AP始终显示为同一个虚拟IP地址，主AC通过Hot Standby（HSB）主备通道同步业务信息到备AC上。</p>
<p>•两台AC通过VRRP协议产生一台“虚拟AC”，缺省情况下，主AC担任虚拟AC的具体工作，当主AC故障时，备AC接替其工作。所有AP与“虚拟AC”建立CAPWAP隧道。</p>
<p>•AP只看到一个AC的存在，AC间的切换由VRRP决定。</p>
<p>•这种方式一般将主备AC部署在同一地理位置，和其他备份方式比较，其业务切换速度非常快。</p>
<blockquote>
<p>•AC目前支持VRRP单实例整机热备，不支持负载均衡。整机热备具有以下特点:</p>
<ul>
<li><p>上行链路可以互为备份，主备VRRP可以track上行口状态，AC整机主备状态可能与各下行链路通断状态不一致。</p>
</li>
<li><p>下行多条链路(包括有线、无线) 采用MSTP破环，MSTP状态变更时会自动清除链路上的MAC/ARP表。 </p>
</li>
</ul>
</blockquote>
<h2 id="HSB相关概念"><a href="#HSB相关概念" class="headerlink" title="HSB相关概念"></a>HSB相关概念</h2><p>•HSB（Hot Standby，热备份）是华为主备公共机制。</p>
<p>•主备服务（HSB service）：建立和维护主备通道，为各个主备业务模块提供通道通断事件和报文发送/接收接口。</p>
<p>•主备备份组（HSB group）：HSB备份组内部绑定HSB service，为各个主备业务模块提供数据备份通道。HSB备份组与一个VRRP实例绑定，借用VRRP机制协商出主备实例。同时，HSB备份组还负责通知各个业务模块处理批量备份、实时备份、主备切换等事件。</p>
<blockquote>
<p>•基于VRRP 的双机热备，热备相关的业务都注册到同一个HSB备份组，HSB备份组内部绑定HSB服务，同时HSB备份组与一个VRRP实例绑定，从而业务通过HSB备份组获知当前用户的主备状态、以及主备切换等事件，并通过HSB组的接口进行备份数据的接收和发送。</p>
</blockquote>
<h2 id="HSB主备服务"><a href="#HSB主备服务" class="headerlink" title="HSB主备服务"></a>HSB主备服务</h2><p>•HSB主备服务负责在两个互为备份的设备间建立主备备份通道，维护主备通道的链路状态，为其他业务提供报文的收发服务，并在备份链路发生故障时通知主备业务备份组进行相应的处理。</p>
<p>•HSB主备服务主要包括两个方面：</p>
<p>​    ▫建立主备备份通道</p>
<p>​    ▫维护主备通道的链路状态</p>
<blockquote>
<p>•HSB主备服务主要包括两个方面： 建立主备备份通道：通过配置主备服务本端和对端的IP地址和端口号，从而建立主备机制报文发送的TCP通道，为其他业务提供报文的收发以及链路状态变化通知服务。</p>
<p>•维护主备通道的链路状态：通过发送主备服务报文和重传等机制来防止TCP较长时间中断但协议栈没有检测到该连接中断。如果在主备服务报文时间间隔与重传次数乘积的时间内还未收到对端发送的主备服务报文，设备则会收到异常通知，并且准备重建主备备份通道。</p>
</blockquote>
<h2 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h2><p>基于VRRP双机热备备份信息包括用户表项、CAPWAP链路信息以及AP表项等信息，备份的方式有实时备份，批量备份，定时备份。</p>
<ul>
<li><p>批量备份：主用设备会将已有的会话表项一次性同步到新加入的备份设备上，使主备AC信息对齐，这个过程称为批量备份。批量备份会在AC主备确立时进行触发。</p>
</li>
<li><p>实时备份：主用设备在产生新表项或表项变化后会及时备份到备份设备上。</p>
</li>
<li><p>定时同步：备用设备会每隔30分钟检查其已有的会话表项与主用设备是否一致，若不一致则将主用设备上的会话表项同步到备用设备。</p>
</li>
</ul>
<blockquote>
<p>•当主用设备出现故障，流量切换到备份设备时，要求主用设备和备份设备的会话表项完全一致，否则有可能导致会话中断。因此，需要一种机制在主用设备上会话建立或表项变化时将相关信息同步保存到备份设备上。HSB主备服务处理模块可以提供数据的备份功能，它负责在两个互为备份的设备间建立主备通道，并维护主备通道的链路状态，提供报文的收发服务。</p>
<p>•HSB业务实时备份：</p>
<p>​    ▫用户数据信息备份</p>
<p>​    ▫CAPWAP隧道信息备份</p>
<p>​    ▫AP表项备份</p>
<p>​    ▫DHCP地址信息备份</p>
<p>•HSB主备通道，可通过两台AC之间的直连物理链路承载，也可通过交换机承载，例如复用VRRP报文交互所处的物理通道。</p>
</blockquote>
<h2 id="VRRP双机热备配置流程"><a href="#VRRP双机热备配置流程" class="headerlink" title="VRRP双机热备配置流程"></a>VRRP双机热备配置流程</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/42.png"></p>
<h2 id="配置介绍-1"><a href="#配置介绍-1" class="headerlink" title="配置介绍 (1)"></a>配置介绍 (1)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/43.png"></p>
<h2 id="配置介绍-2"><a href="#配置介绍-2" class="headerlink" title="配置介绍 (2)"></a>配置介绍 (2)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/44.png"></p>
<h2 id="配置介绍-3"><a href="#配置介绍-3" class="headerlink" title="配置介绍 (3)"></a>配置介绍 (3)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/45.png"></p>
<h2 id="配置案例-1-2"><a href="#配置案例-1-2" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/46.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/47.png"></p>
<h2 id="配置案例-2-2"><a href="#配置案例-2-2" class="headerlink" title="配置案例 (2)"></a>配置案例 (2)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/48.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/49.png"></p>
<h2 id="配置案例-3-1"><a href="#配置案例-3-1" class="headerlink" title="配置案例 (3)"></a>配置案例 (3)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/50.png"></p>
<h2 id="双链路双机热备"><a href="#双链路双机热备" class="headerlink" title="双链路双机热备"></a>双链路双机热备</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/51.png"></p>
<p>•双链路双机热备场景下，业务直接绑定HSB备份服务，这样HSB对业务仅提供备份数据收发的功能，用户的主备状态由双链路机制进行维护。</p>
<p>•AP同时与主备AC之间分别建立CAPWAP隧道，AC间的业务信息通过HSB主备通道同步。</p>
<p>•当AP和主AC间链路断开，AP会通知备AC切换成主AC。</p>
<blockquote>
<p>•该方案除了支持主备备份之外，还支持负载分担模式。负载分担模式下可以指定一部分AP的主AC为AC1，与其建立CAPWAP主链路，一部分AP的主AC为AC2，与其建立CAPWAP主链路。</p>
<p>•双链路双机热备的主备AC不受地理位置限制，部署灵活，可进行负载分担，有效利用资源，但业务切换速度较慢。</p>
<p>•图中，AC1 和 AC2 经过部署为双链路双机热备，只绑定HSB主备服务，提供双机热备份HSB隧道。AP需依次与两台AC建立CAPWAP隧道，通过AC下发的CAPWAP报文中的优先级判断主用AC与备用AC。</p>
</blockquote>
<h2 id="主备协商-amp-建立主链路"><a href="#主备协商-amp-建立主链路" class="headerlink" title="主备协商&amp;建立主链路"></a>主备协商&amp;建立主链路</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/52.png"></p>
<p>AP与AC建立主链路，在Discovery阶段要优选出主AC。</p>
<p>1.使能双链路备份功能后，AP开始发送Discovery Request报文。</p>
<p>2.AC收到Request报文后回应Discovery Response报文。</p>
<p>3.AP收集到主备AC回应的Discovery Response报文后，根据AC的优先级、设备的负载情况以及AC的IP地址来选择主AC。</p>
<p>4.AP开始与优选出的主AC建立CAPWAP主链路。</p>
<blockquote>
<p>•建立主链路时，除了Discovery阶段要优选出主AC，其他过程跟正常情况下的CAPWAP隧道建立过程一致。</p>
<p>•在Discovery阶段，使能双链路备份功能后，AP开始发送Discovery Request报文，分为单播方式和广播方式：</p>
<ul>
<li><p>如果预先通过静态方式、DHCP服务器方式或DNS方式指定了主备AC的IP地址，AP向AC发送单播Discovery Request报文请求与主备AC关联。</p>
</li>
<li><p>如果没有配置AC的静态IP地址或者单播没有回应时，AP将发送广播Discovery Request报文请求同网段内可关联的AC。</p>
</li>
</ul>
<p>•不管是单播发现还是广播发现，如果主备AC都正常，都会回应Discovery Response报文，并在该报文中携带双链路特性开关、优先级、负载情况以及IP地址。</p>
<p>•AP收集到主备AC回应的Discovery Response报文后，根据AC的优先级、设备的负载情况以及AC IP地址来选择主AC并开始与其建立CAPWAP主链路，优选顺序如下：</p>
<ul>
<li><p>比较AC的优先级，优先级值小的为主AC，默认优先级为0，最大值为7，优先级取值越小，优先级越高。；</p>
</li>
<li><p>优先级相同情况下，比较AC设备的负载情况，即AP个数和STA个数，负载轻的为主AC。优先选择当前可接入AP数大的AC为主AC，如果当前可接入AP数相同，则选择当前可接入STA数大的AC为主AC；</p>
</li>
<li><p>负载相同情况下，比较IP地址，IP地址小的为主AC。</p>
</li>
</ul>
<p>•说明：当前可接入AP数=可接入的最大AP数-当前已接入的AP数，当前可接入STA数=可接入的最大STA数-当前已接入的STA数。</p>
</blockquote>
<h2 id="建立备链路"><a href="#建立备链路" class="headerlink" title="建立备链路"></a>建立备链路</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/53.png"></p>
<p>AP与AC建立备链路，为了避免业务配置重复下发导致错误，在AP和 主AC建立主隧道并且配置下发完成后，才启动备CAPWAP链路的建立。</p>
<p>1.主AC下发配置到AP上；</p>
<p>2.AP开始建立备用隧道，向备AC发送单播CAPWAP Discovery Request报文；</p>
<p>3.备AC收到Request报文后，回应Response报文，在该报文中携带优选AC的IP地址、备选AC的IP地址、双链路特性开关、负载情况及其优先级。</p>
<p>4.AP收到备AC回应的Response报文后，获取到双链路特性开关为打开，并保存其优先级。</p>
<blockquote>
<p>•说明：如果该AC的优先级修改为比步骤1已经建立好CAPWAP链路的AC优先级高，也不进行主备倒换，待建立隧道完成后再进行倒换。</p>
<p>•AP发送的Join Request中，会携带一个自定义消息类型，告诉备AC配置已经下发过了，不需要再下发。AC收到Join Request，获取到该自定义消息时，在配置下发阶段，会跳过配置下发流程，避免对AP重复下发配置。</p>
<p>•备链路建立完成后，AP重新根据两个链路的优先级决策出主备AC。</p>
<p>•缺省情况下，CAPWAP心跳检测的间隔时间为25秒，心跳检测报文次数为6。如果开启了双链路备份功能，则CAPWAP心跳检测的间隔时间为25秒，心跳检测报文次数为3。</p>
<p>•说明： </p>
<ul>
<li><p>如果在配置双链路备份时需要使用WDS或Mesh，建议配置CAPWAP心跳检测的间隔时间为25秒，心跳检测报文次数至少为6次。否则由于双链路备份时缺省的心跳报文间隔时间为25秒，心跳检测报文次数为3次，会导致WDS或Mesh链路不稳定，无法保证用户正常接入。</p>
</li>
<li><p>配置CAPWAP心跳检测间隔时间和次数低于默认值会影响CAPWAP链路可靠性，请谨慎修改，建议使用默认值。</p>
</li>
</ul>
</blockquote>
<h2 id="配置介绍-1-1"><a href="#配置介绍-1-1" class="headerlink" title="配置介绍 (1)"></a>配置介绍 (1)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/54.png"></p>
<h2 id="配置介绍-2-1"><a href="#配置介绍-2-1" class="headerlink" title="配置介绍 (2)"></a>配置介绍 (2)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/55.png"></p>
<h2 id="配置案例-1-3"><a href="#配置案例-1-3" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/56.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/57.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/58.png"></p>
<h2 id="配置案例-2-3"><a href="#配置案例-2-3" class="headerlink" title="配置案例 (2)"></a>配置案例 (2)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/59.png"></p>
<h2 id="AC可靠性：N-1"><a href="#AC可靠性：N-1" class="headerlink" title="AC可靠性：N+1"></a>AC可靠性：N+1</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/60.png"></p>
<p>•N+1备份是指在AC+FIT AP的网络架构中，使用一台AC作为备AC，为多台主AC提供备份服务的一种解决方案。</p>
<p>•网络正常情况下，AP只与各自所属的主AC建立CAPWAP链路。</p>
<p>•当主AC故障或主AC与AP间CAPWAP链路故障时，备AC替代主AC来管理AP，备AC与AP间建立CAPWAP链路，为AP提供业务服务。</p>
<p>•支持主备倒换，支持主备回切。</p>
<blockquote>
<p>•当AP与主用AC之间的CAPWAP隧道中断时，将触发AP与备用AC建立CAPWAP隧道，此时AP会重新与该AC建链、重启并获取配置，在该过程中，业务将会受影响。</p>
</blockquote>
<h2 id="N-1-备份—主备选择"><a href="#N-1-备份—主备选择" class="headerlink" title="N+1 备份—主备选择"></a>N+1 备份—主备选择</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/61.png"></p>
<p>•在Discovery阶段，AP发现AC后，要选择出最高优先级的AC作为主AC接入。</p>
<p>•AC上存在两种优先级：</p>
<p>•全局优先级：针对所有AP配置的AC优先级，默认为0，最大值为7，优先级取值越小，优先级越高。</p>
<p>•个性优先级：针对指定的单个AP或指定AP组中的AP配置的AC优先级，没有默认值。</p>
<p>•AC全局优先级&lt;AP在AC上优先级。</p>
<blockquote>
<p>•当AC收到AP发送的Discovery Request报文时，如果AC没有为该AP配置个性优先级，则在回应的Discovery Response报文中携带全局优先级；</p>
<p>•如果AC已为该AP配置了个性优先级，则在回应的Discovery Response报文中携带个性优先级。</p>
<p>•正确配置主AC和备AC的不同优先级，可以控制AP能够在指定的主AC或备AC上线</p>
<p>•优选顺序如下：</p>
<ul>
<li><p>AP查看优选AC，如果只有一个优选AC，则此AC作为主AC。如果存在多个优选AC，则选择负载最轻的AC作为主AC，如果负载相同选择IP地址最小的作为主AC；</p>
</li>
<li><p>负载的比较方式：比较AC设备的负载情况，即AP个数和STA个数，负载轻的为主AC。优先选择当前可接入AP数大的AC为主AC，如果当前可接入AP数相同，则选择当前可接入STA数大的AC为主AC；</p>
</li>
<li><p>如果没有优选AC，查看备选AC，如果只有一个备选AC，则此AC作为主AC，如果存在多个备选AC，则选择负载最轻的AC作为主AC，如果负载相同选择IP地址最小的作为主AC；</p>
</li>
<li><p>如果没有备选AC，比较AC的优先级，优先级最高的作为主AC。优先级取值越小，优先级越高。优先级的具体判断方式参考主备优先级；</p>
</li>
<li><p>优先级相同情况下，则选择负载最轻的AC作为主AC；</p>
</li>
<li><p>负载相同情况下，继续比较IP地址，IP地址小的为主AC。</p>
</li>
</ul>
</blockquote>
<h2 id="配置介绍-1-2"><a href="#配置介绍-1-2" class="headerlink" title="配置介绍 (1)"></a>配置介绍 (1)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/62.png"></p>
<h2 id="配置介绍-2-2"><a href="#配置介绍-2-2" class="headerlink" title="配置介绍 (2)"></a>配置介绍 (2)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/63.png"></p>
<h2 id="配置案例-1-4"><a href="#配置案例-1-4" class="headerlink" title="配置案例 (1)"></a>配置案例 (1)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/64.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/65.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/66.png"></p>
<h2 id="配置案例-2）"><a href="#配置案例-2）" class="headerlink" title="配置案例 (2）"></a>配置案例 (2）</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/67.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/68.png"></p>
<blockquote>
<p>•缺省情况下，全局回切功能处于使能状态，执行命令undo ac protect restore disable会提示Info。</p>
<p>•缺省情况下，N+1备份功能开启，执行命令undo ac protect enable会提示Info。需要在主AC上继续执行命令ap-reset all重启所有AP，AP重启后，N+1备份功能开始生效。</p>
</blockquote>
<h2 id="配置案例-3-2"><a href="#配置案例-3-2" class="headerlink" title="配置案例 (3)"></a>配置案例 (3)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/69.png"></p>
<h2 id="配置案例-4-1"><a href="#配置案例-4-1" class="headerlink" title="配置案例 (4)"></a>配置案例 (4)</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/70.png"></p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/71.png"></p>
<h2 id="AC可靠性：小结"><a href="#AC可靠性：小结" class="headerlink" title="AC可靠性：小结"></a>AC可靠性：小结</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/72.png"></p>
<h1 id="6-准入控制技术"><a href="#6-准入控制技术" class="headerlink" title="6.准入控制技术"></a>6.准入控制技术</h1><h2 id="NAC概述"><a href="#NAC概述" class="headerlink" title="NAC概述"></a>NAC概述</h2><p>NAC（Network Admission Control）称为网络接入控制，通过对接入网络的客户端和用户的认证保证网络的安全，是一种“端到端”的安全技术。</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/73.png"></p>
<h2 id="RADIUS概述"><a href="#RADIUS概述" class="headerlink" title="RADIUS概述"></a>RADIUS概述</h2><p>•AAA可以通过多种协议来实现，在实际应用中，最常使用RADIUS协议。</p>
<p>•RADIUS是一种分布式的、客户端/服务器结构的信息交互协议，能保护网络不受未授权访问的干扰，常应用在既要求较高安全性、又允许远程用户访问的各种网络环境中。</p>
<p>•该协议定义了基于UDP（User Datagram Protocol）的RADIUS报文格式及其传输机制，并规定UDP端口1812、1813分别作为默认的认证、计费端口。</p>
<p>•RADIUS协议的主要特征如下：</p>
<p>​    ▫客户端/服务器模式</p>
<p>​    ▫安全的消息交互机制</p>
<p>​    ▫良好的扩展性</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/74.png"></p>
<h2 id="802-1X认证"><a href="#802-1X认证" class="headerlink" title="802.1X认证"></a>802.1X认证</h2><p>•802.1X是IEEE制定的关于用户接入网络的认证标准，主要解决以太网内认证和安全方面的问题。</p>
<p>•802.1X认证系统为典型的Client/Server结构，包括3个实体：请求方、认证方和认证服务器。</p>
<p>•认证服务器通常是RADIUS服务器，用于对申请者进行认证、授权和计费。</p>
<p>•对于大中型企业的员工，推荐使用802.1X认证。</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/75.png"></p>
<blockquote>
<p>•802.1X认证系统使用可扩展认证协议（Extensible Authentication Protocol，EAP）来实现申请者、认证者和认证服务器之间的信息交互。常用的802.1X认证协议有防护扩展验证协议（Protected Extensible Authentication Protocol，PEAP）和传输层安全性协议（Transport Layer Security，TLS），其区别如下：</p>
<ul>
<li><p>PEAP：管理员给用户分配用户名、密码。用户在接入WLAN时输入用户名、密码进行认证。</p>
</li>
<li><p>TLS：用户使用证书进行认证，此认证方式一般结合企业App使用，如华为的EasyAccess。</p>
</li>
</ul>
<p>•对于大中型企业的员工，推荐使用802.1X认证。</p>
</blockquote>
<h2 id="MAC认证"><a href="#MAC认证" class="headerlink" title="MAC认证"></a>MAC认证</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/76.png"></p>
<p>•MAC认证是一种基于MAC地址对用户的网络访问权限进行控制的认证方法，它不需要用户安装任何客户端软件。</p>
<p>•接入设备在启动了MAC认证的接口上首次检测到用户的MAC地址后，即启动对该用户的认证操作。</p>
<p>•认证过程中，不需要用户手动输入用户名或者密码。</p>
<p>•MAC认证常用于哑终端（如打印机）的接入认证，或者结合认证服务器完成MAC优先的Portal认证，用户首次认证通过后，一定时间内免认证再次接入。</p>
<h2 id="Portal认证"><a href="#Portal认证" class="headerlink" title="Portal认证"></a>Portal认证</h2><p>•Portal认证通常也称为Web认证，将浏览器作为认证客户端，不需要安装单独的认证客户端。</p>
<p>•用户上网时，必须在Portal页面进行认证，只有认证通过后才可以使用网络资源，同时服务提供商可以在Portal页面上开展业务拓展，如展示商家广告等。</p>
<p>•对于大中型企业的访客、商业会展和公共场所，推荐使用Portal认证。</p>
<p>•常用的Portal认证方式如下：</p>
<ul>
<li><p>用户名和密码方式：由前台管理员给访客申请一个临时账号，访客使用临时账号认证。</p>
</li>
<li><p>短信认证：访客通过手机验证码方式认证。</p>
</li>
</ul>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/77.png"></p>
<blockquote>
<p>•定义</p>
<ul>
<li>Portal认证通常也称为Web认证，一般将Portal认证网站称为门户网站。用户上网时，必须在门户网站进行认证，如果未认证成功，仅可以访问特定的网络资源，认证成功后，才可以访问其他网络资源。</li>
</ul>
<p>•优点</p>
<ul>
<li><p>一般情况下，客户端不需要安装额外的软件，直接在Web页面上认证，简单方便。</p>
</li>
<li><p>便于运营，可以在Portal页面上进行业务拓展，如广告推送、企业宣传等。</p>
</li>
<li><p>技术成熟，被广泛应用于运营商、连锁快餐、酒店、学校等网络。</p>
</li>
<li><p>部署位置灵活，可以在接入层或关键数据的入口作访问控制。</p>
</li>
<li><p>用户管理灵活，可基于用户名与VLAN/IP地址/MAC地址的组合对用户进行认证。</p>
</li>
</ul>
</blockquote>
<h2 id="MAC优先的Portal认证"><a href="#MAC优先的Portal认证" class="headerlink" title="MAC优先的Portal认证"></a>MAC优先的Portal认证</h2><p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/78.png"></p>
<h2 id="三种认证方式比较"><a href="#三种认证方式比较" class="headerlink" title="三种认证方式比较"></a>三种认证方式比较</h2><p>NAC包括三种认证方式：802.1X认证、MAC认证和Portal认证。由于三种认证方式认证原理不同，各自适合的场景也有所差异，实际应用中，可以根据场景部署某一种合适的认证方式，也可以部署几种认证方式组成的混合认证，混合认证的组合方式以设备实际支持为准。</p>
<p><img src="/2021/05/18/IP-%E5%A4%A7%E5%9E%8BWLAN%E7%BB%84%E7%BD%91%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2/79.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（简答题）在部署WLAN三层组网的时候，需要配置DHCP Option43，那么Option43的作用是什么？</p>
<p><strong>AP发送的DHCP广播请求报文是二层报文，不能在三层组网中传输，所以广播发现不了三层组网中AC，必须通过Option43来通告AC的IP地址，否则AP获取不到AC的IP地址，后续AP无法上线。</strong></p>
<p>2.（简答题）二层漫游和三层漫游的最大的区别是什么？</p>
<p><strong>二层漫游和三层漫游的最大的区别是什么？</strong></p>
<p>​    <strong>▫区别在于漫游前后关联的AP的服务集上的VLAN不同。</strong></p>
<p>​    <strong>▫二层漫游是指客户端在同一子网内漫游。</strong></p>
<p>​    <strong>▫三层漫游是指客户端在不同子网间漫游。</strong></p>
<p>3.（简答题）WLAN双机热备份数据同步的方式有几种，分别应用在什么场景下？</p>
<p><strong>数据同步的方式有批量备份、实时备份和定时同步：</strong></p>
<ul>
<li><p><strong>批量备份：在配置双机热备份功能后，先运行的主用设备会将已有的会话表项一次性同步到新加入的备份设备上。</strong></p>
</li>
<li><p><strong>实时备份：主用设备在产生新表项或表项变化后会及时备份到备份设备上。</strong></p>
</li>
<li><p><strong>定时同步：备用设备会每隔30分钟检查其已有的会话表项与主用设备是否一致，若不一致则将主用设备上的会话表项同步到备用设备。</strong></p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•通过大型WLAN组网技术，用户可以更方便、更安全地接入到无线网络，并在无线网络覆盖区域内自由移动，彻底摆脱有线网络的束缚。</p>
<p>•本章主要介绍了企业大型WLAN组网技术，包括：WLAN大型组网架构、WLAN大型组网关键技术、漫游技术、高可靠性技术以及准入控制技术等。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/" itemprop="url">IP-网络管理协议介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T21:39:07+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•随着人工智能、大数据、云计算等新技术快速发展，未来各行业将面临数字化转型，企业业务随着数字化转型也变得丰富多样，使网络管理成为网络管理员面临的最具挑战的问题之一。我们无法仅依赖人手工来完成整个的网络管理的工作，迫切的需要一种自动化和智能化的工具协助我们管理网络中的设备和资源。</p>
<p>•本次课程，将简要介绍网络管理的发展历程及网络管理的相关概念，同时会着重介绍网络管理中使用到的不同的协议以及它们的使用场景。最后，简要介绍网络管理的典型应用案例。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫阐释网络管理的发展趋势及功能特征</p>
<p>▫阐释网络管理协议的功能</p>
<p>▫阐释不同网络管理协议的机制和应用场景的异同点</p>
<p>▫阐释网络管理协议的应用场景</p>
<h1 id="1-网络管理的发展历程"><a href="#1-网络管理的发展历程" class="headerlink" title="1.网络管理的发展历程"></a>1.网络管理的发展历程</h1><h2 id="网络发展的现状"><a href="#网络发展的现状" class="headerlink" title="网络发展的现状"></a>网络发展的现状</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/1.png"></p>
<blockquote>
<p>•随着互联网产业的飞速发展，网络面临巨大变革，多业务融合成为未来网络的主流趋势。网络的融合需要管理的融合，统一网管能实现多业务、多设备的统一集中管理。</p>
</blockquote>
<h2 id="传统网络管理面临的挑战"><a href="#传统网络管理面临的挑战" class="headerlink" title="传统网络管理面临的挑战"></a>传统网络管理面临的挑战</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/2.png"></p>
<blockquote>
<p>•人工智能、大数据、云计算等新技术正在快速发展，未来十年各行业将面临数字化转型，企业业务随着数字化转型也变得丰富多样。因此，数字化带来网络模型的变化，传统的网络管理模式已经不能适应数字化业务带来的新需求。传统网络的建设、管理和运维手段已无法满足数字化带来的新的网络需求。</p>
</blockquote>
<h2 id="网络管理的发展趋势"><a href="#网络管理的发展趋势" class="headerlink" title="网络管理的发展趋势"></a>网络管理的发展趋势</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/3.png"></p>
<blockquote>
<p>•OPEX（Operating Expense，运营支出）：指企业运行付出的各种支出成本，包括维护费用、营销费用、人工成本以及折旧。</p>
<p>•根据行业知名分析机构在2019年4月发布的关于AI和自动化提高网络可靠性的报告中指出，到2022年，将会有65%的企业在园区网络部署网络自动化技术，而今天这个比例只有17%。</p>
<p>•管理自动化：正如家用洗衣机一样，从手动到半自动，到今天的全自动甚至是智能洗衣，让人人都能操作一个复杂的机器完成复杂的任务。对于网络管理也是如此，从基于命名行的逐台设备的配置与管理，到基于图形化界面的管理控制系统，到今天基于业务语言对网络进行自动化配置。从网络管理的视角，企业网络管理将几乎1/3的时间花费在网络的规划、部署上。未来网络自动化有两个层面：</p>
<ul>
<li>全生命周期的自动化：包括自动化工具是否能从网络的规划、部署、策略发放、网络状态监测和维护以及管理的全生命周期，均实现自动化。</li>
<li>整网自动化：包括企业的LAN、WLAN、以及WAN网络是否能够进行集中式地管理和策略配置，是否能从全局视角定义基于用户身份和应用类型的业务策略。</li>
</ul>
<p>•运维智能化：智能化是网络管理运维的更高级别能力。以前，网络运维工作很简单，主要关注网络和设备的KPI指标，无法感知用户体验和业务质量。而今天，网络连接的质量直接影响到了业务的质量，从而影响了企业的运作效率。甚至在部分工业和生产场景，因不同业务的需要，网络质量有了差异化的要求，每终端的带宽、时延、丢包、无线漫游的切换时间仅依托以网元为中心的运维系统是无法完成如此复杂的工作。这就像医生为了检测病人，需要采用更为先进的机器。</p>
</blockquote>
<h1 id="2-网络管理的功能特征"><a href="#2-网络管理的功能特征" class="headerlink" title="2.网络管理的功能特征"></a>2.网络管理的功能特征</h1><h2 id="什么是网络管理？"><a href="#什么是网络管理？" class="headerlink" title="什么是网络管理？"></a>什么是网络管理？</h2><p>•网络管理，简单地说是对网络的管理，是一个网络的基本诉求。当前，用户能够通过各种协议、工具、应用或设备来实现对网络的管理，其管理对象包括网络中的硬件及软件。</p>
<p>•网络管理的目标是实现对网络软硬件的监控、测试、配置、分析、评价及控制等，确保网络运行正常。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/4.png"></p>
<h2 id="网络管理的典型架构"><a href="#网络管理的典型架构" class="headerlink" title="网络管理的典型架构"></a>网络管理的典型架构</h2><p>通常情况下，网络管理系统具有相同的基本体系结构。该体系结构包含两个关键元素：</p>
<p>​    ▫管理设备，也被称为网络管理站。</p>
<p>​    ▫被管理设备，也被称为代理设备。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/5.png"></p>
<h2 id="网络管理的四大模型"><a href="#网络管理的四大模型" class="headerlink" title="网络管理的四大模型"></a>网络管理的四大模型</h2><p>OSI网络管理模型由四个主要的模型组成:</p>
<ul>
<li><p>组织结构模型(Organization Model)：描述网络管理系统组件的功能和基础架构。</p>
</li>
<li><p>信息模型(Information Model)：描述被管理对象及其关系的信息库。</p>
</li>
<li><p>通信模型(Communication Model)：描述管理者与被管理者之间交换信息的方式。</p>
</li>
<li><p>功能模型(Functional Model)：包括配置管理、性能管理、故障管理、安全管理和计费管理五个功能区域。</p>
</li>
</ul>
<blockquote>
<p>•组织结构模型定义管理者，代理和被管理对象。 它描述了网络管理系统的组件，组件的功能和基础架构。</p>
<p>•信息模型与信息结构和存储有关。 它指定用于描述被管理对象及其关系的信息库。 管理信息结构（SMI）定义了存储在管理信息库（MIB）中的管理信息的语法和语义。 代理进程和管理器进程都使用MIB进行管理信息交换和存储。</p>
<p>•通信模型处理代理与管理者之间以及管理者之间交换信息的方式。 通信模型中包含三个关键元素：传输协议，应用程序协议和要传达的实际消息。</p>
<p>•功能模型包括网络管理的五个功能区域：配置管理、性能管理、故障管理、安全管理和计费管理。</p>
</blockquote>
<h2 id="网络管理的五大功能"><a href="#网络管理的五大功能" class="headerlink" title="网络管理的五大功能"></a>网络管理的五大功能</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/6.png"></p>
<p>在网络运维工作中，主要涉及到三个功能：</p>
<p>•配置：许多管理协议都包括对托管项目执行动作的能力。</p>
<p>•性能：这里的想法是获取有关平台行为的数据，该数据使我们可以推断其性能。</p>
<p>•故障：在这一领域中，其思想是拥有检测故障的程序和报告故障的方案。</p>
<blockquote>
<p>•OSI定义网络管理的五大功能模型。</p>
<p>•配置管理（Configuration Management）：</p>
<ul>
<li><p>配置管理涉及初始化网络，提供网络资源和服务以及监视和控制网络。 更具体地说，配置管理的职责包括在网络运行期间设置，维护，添加和更新组件之间的关系以及组件的状态。</p>
</li>
<li><p>配置管理包括设备配置和网络配置。设备配置可以在本地或远程执行。 自动化的网络配置，例如动态主机配置协议（DHCP）和域名服务（DNS）在网络管理中发挥关键作用。</p>
</li>
</ul>
<p>•性能管理（Performance Management）：</p>
<ul>
<li>性能管理与评估和报告被管理网络对象的行为和有效性有关。 网络监视系统可以测量和显示网络状态，例如收集有关流量，网络可用性，响应时间和吞吐量的统计信息。</li>
</ul>
<p>•故障管理（Fault Management）：</p>
<ul>
<li>故障管理涉及检测，隔离和纠正可能导致OSI网络故障的异常操作。 故障管理的主要目标是确保网络始终可用，并在发生故障时尽快将其修复。</li>
</ul>
<p>•安全管理（Security Management）：</p>
<ul>
<li>安全管理可以保护网络和系统免受未经授权的访问和安全攻击。 安全管理机制包括身份验证，加密和授权。 安全管理还涉及加密密钥以及其他与安全相关的信息的生成，分发和存储。 安全管理可以包括提供实时事件监视和事件日志的安全系统，例如防火墙和入侵检测系统。</li>
</ul>
<p>•计费管理（Accounting Management）：</p>
<ul>
<li>计费管理可以计量被管理对象的使用费用，并确定这种使用的成本。 该度量可能包括消耗的资源，用于收集会计数据的设施以及为客户使用的服务设置计费参数，维护用于计费目的的数据库，以及准备资源使用情况和计费报告。</li>
</ul>
</blockquote>
<h1 id="3-网络管理的协议分类"><a href="#3-网络管理的协议分类" class="headerlink" title="3.网络管理的协议分类"></a>3.网络管理的协议分类</h1><h2 id="网络管理概览"><a href="#网络管理概览" class="headerlink" title="网络管理概览"></a>网络管理概览</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/7.png"></p>
<blockquote>
<p>•CLI（Command-Line Interface，命令行界面）既可以支持网络配置管理，也可以支持网络监控管理。</p>
<p>•SNMP（Simple Network Management Protocol，简单网络管理协议）的Set功能可以支持网络配置管理，Trap功能可以支持网络监控管理。</p>
<p>•NETCONF（Network Configuration Protocol，网络配置协议）的Edit功能可以支持网路配置管理，Get功能可以支持网络监控管理。</p>
</blockquote>
<h2 id="CLI（Telnet-SSH）"><a href="#CLI（Telnet-SSH）" class="headerlink" title="CLI（Telnet/SSH）"></a>CLI（Telnet/SSH）</h2><p>CLI是在图形用户界面得到普及之前使用最为广泛的用户界面，它通常不支持鼠标，用户通过键盘输入指令，设备接收到指令后，予以执行。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/8.png"></p>
<blockquote>
<p>•网络管理员可以采用CLI对设备进行配置和网络监控，操作简单便捷，一旦进行大规模部署，就必须借助于自动化工具来进行批量配置。</p>
<p>•Telnet是电信（Telecommunications）和网络（Networks）的联合缩写。</p>
<ul>
<li><p>Telnet使用专用的TCP端口号23，它不是一种安全通信协议，通过网络/互联网传输明文格式的数据，包括密码。</p>
</li>
<li><p>Telnet中没有使用任何验证策略及数据加密方法。</p>
</li>
</ul>
<p>•SSH（Secure Shell，安全外壳）</p>
<ul>
<li><p>SSH使用专用的TCP端口号22，它是一种非常安全的协议，通过网络/互联网传输加密格式的数据，一旦经过加密就极难解压和读取该数据。</p>
</li>
<li><p>SSH还使用公钥用于对访问者的用户身份验证，这种方式提供了更高的安全性。</p>
</li>
</ul>
<p>•Telnet和SSH是两种远程管理设备的方式，其中SSH连接方式较Telnet更为安全，因此目前网络都会要求部署SSH。</p>
</blockquote>
<h2 id="SNMP"><a href="#SNMP" class="headerlink" title="SNMP"></a>SNMP</h2><p>SNMP是广泛用于TCP/IP网络的网络管理标准协议。SNMP提供了一种通过运行网络管理软件的中心计算机（即网络管理工作站NMS）来管理网元的方法。共有三个版本：SNMPv1、SNMPv2c和SNMPv3，用户可以根据实际情况选择配置一个或同时配置多个版本。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/9.png"></p>
<blockquote>
<p>•网络管理站（Network Management Station，NMS）<br> 向被管理设备发送各种查询报文，以及接收被管理设备发送的告警。</p>
<p>•被管理设备（Devices）<br> 也就是网络中的各种接受网管的设备。</p>
<p>•代理（Agent）<br> 驻留在被管理设备上的一个进程。Agent的作用如下：</p>
<ul>
<li><p>接收、解析来自网管站的查询报文。</p>
</li>
<li><p>根据报文类型对管理变量进行Read或Write操作，并生成响应报文，返回给网管站。</p>
</li>
<li><p>根据各协议模块对告警触发条件的定义，当发生某个事件（如端口UP/DOWN，STP拓扑变更、OSPF邻居关系DOWN掉等）的时候，主动触发一个告警，向网管站报告该事件。</p>
</li>
</ul>
<p>•MIB（Management Information Base ）是一个数据库，指明了被管理设备所维护的变量（即能够被Agent查询和设置的信息）。MIB在数据库中定义了被管理设备的一系列属性：对象的名称、对象的状态、对象的访问权限和对象的数据类型等。</p>
<p>•OID（Object IDentifier）：MIB是以树状结构进行存储的，树的节点表示管理对象Object，对象可以用从根Root开始的一条路径来唯一的识别，这就是OID也即对象标示符</p>
</blockquote>
<h2 id="SNMP的应用场景"><a href="#SNMP的应用场景" class="headerlink" title="SNMP的应用场景"></a>SNMP的应用场景</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/10.png"></p>
<h2 id="NETCONF"><a href="#NETCONF" class="headerlink" title="NETCONF"></a>NETCONF</h2><p>NETCONF是一种基于XML的网络配置协议，它存在的目的在于用可编程的方式实现网络配置的自动化，从而简化、加速网络服务地部署。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/11.png"></p>
<blockquote>
<p>•NETCONF使用SSH实现安全传输，使用RPC(Remote Procedure Call)远程调用的机制实现客户端和服务端的通信。</p>
<p>•NETCONF消息以XML格式呈现。</p>
</blockquote>
<h2 id="NETCONF的应用场景"><a href="#NETCONF的应用场景" class="headerlink" title="NETCONF的应用场景"></a>NETCONF的应用场景</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/12.png"></p>
<blockquote>
<p>•NETCONF提供一套管理网络设备的机制。用户可以使用这套机制增加、修改、删除、备份、恢复、锁定、解锁网络设备的配置，同时还具备事务和会话操作功能，从而来获取网络设备的配置和状态信息。</p>
</blockquote>
<h2 id="NetStream"><a href="#NetStream" class="headerlink" title="NetStream"></a>NetStream</h2><p>•NetStream技术是一种基于网络流信息的统计技术，可以对网络中的业务流量情况进行统计和分析。在网络的接入层、汇聚层、核心层上，都可以通过部署NetStream。</p>
<p>•NetStream支持IP报文（UDP、TCP、ICMP报文）和MPLS报文的统计。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/13.png"></p>
<blockquote>
<p>•一个典型的NetStream系统由网络流数据输出器（NetStream Data Exporter, NDE）、网络流数据收集器（NetStream Collector, NSC）和网络流数据分析器（NetStream Data Analyzer, NDA）三部分组成。</p>
<ul>
<li><p>NDE：负责对网络流进行分析处理，提取符合条件的流进行统计，并将统计信息输出给 NDA（NetStream Data Analyzer）设备。 输出前也可对数据进行一些处理， 比如聚合。 配置了NetStream功能的设备在 NetStream 系统中担当 NDE 角色。</p>
</li>
<li><p>NSC：通常为运行于 Unix 或者 Windows 上的一个应用程序，负责解析来自 NDE 的报文，把统计数据收集到数据库中，可供 NDA 进行解析。 NSC 可以采集多个 NDE 设备输出的数据，对数据进行进一步的过滤和聚合。</p>
</li>
<li><p>NDA：是一个网络流量分析工具，它从 NSC 中提取统计数据，进行进一步的加工处理，生成报表，为各种业务提供依据（比如流量计费、网络规划，攻击监测）。通常， NDA 具有图形化用户界面，使用户可以方便地获取、显示和分析收集到的数据。 </p>
</li>
</ul>
<p>•NetStream流输出方式：</p>
<ul>
<li><p>原始流输出方式：在流老化时间超时后，每条流的统计信息都要输出到NSC。原始流输出方式的优点是：NSC可以得到每条流的详细统计信息。</p>
</li>
<li><p>聚合流输出方式：聚合流输出方式是指设备对与聚合关键项完全相同的原始流统计信息进行汇总，从而得到对应的聚合流统计信息。通过对原始流进行聚合后输出，可以明显减少网络带宽。</p>
</li>
</ul>
</blockquote>
<h2 id="NetStream的应用场景"><a href="#NetStream的应用场景" class="headerlink" title="NetStream的应用场景"></a>NetStream的应用场景</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/14.png"></p>
<blockquote>
<p>•在实际的应用中，NSC和NDA一般集成在一台NetStream服务器上。NDE通过NetStream采样获取GE0/0/1接口出方向流量信息，并按照一定条件建立NetStream流，当NetStream缓存区已满或者NetStream流达到老化时间，NDE会将统计的信息封装成NetStream报文发送到NetStream服务器。NetStream服务器对NetStream报文进行分析处理，并显示分析结果。</p>
<p>•传统的流量统计的实现方法和局限性：</p>
<ul>
<li><p>基于IP报文计数：统计的信息简单，无法针对多种信息进行统计。</p>
</li>
<li><p>使用ACL：要求ACL的容量很大，对于ACL规则以外的流没有办法统计。</p>
</li>
<li><p>SNMP协议：功能不强。要不断的通过轮询向网管查询，浪费CPU和网络资源。</p>
</li>
<li><p>端口镜像：成本高，同时消耗设备的一个接口，对于无法镜像的端口无能为力。</p>
</li>
<li><p>物理层复制：成本高，同时还需要购买专用的硬件设备。</p>
</li>
</ul>
</blockquote>
<h2 id="sFlow"><a href="#sFlow" class="headerlink" title="sFlow"></a>sFlow</h2><p>•采样流sFlow（Sampled Flow）是一种基于报文采样的网络流量监控技术，基于Flow采样可以截取原始报文的全部，也可以截取一部分报头。</p>
<p>•sFlow系统包含一个嵌入在设备中的sFlow Agent和远端的sFlow Collector。其中，sFlow Agent通过<strong>sFlow采样</strong>获取接口统计信息和数据信息，将信息封装成<strong>sFlow报文</strong>发送到指定的sFlow Collector。sFlow Collector对sFlow报文进行分析，并显示分析结果。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/15.png"></p>
<blockquote>
<p>•Flow采样是sFlow Agent设备在指定接口上按照特定的采样方向和采样比对报文进行采样分析，用于获取报文数据内容的相关信息。该采样方式主要是关注流量的细节，这样就可以监控和分析网络上的流行为。</p>
<ul>
<li>Flow采样可以截取原始报文的全部，也可以截取一部分报头。</li>
</ul>
<p>•Counter采样是sFlow Agent设备周期性的获取接口上的流量统计信息，Counter采样支持获取的采样信息。与Flow采样相比，Counter采样只关注接口上流量的数量，而不关注流量的详细信息。</p>
</blockquote>
<h2 id="sFlow的应用场景"><a href="#sFlow的应用场景" class="headerlink" title="sFlow的应用场景"></a>sFlow的应用场景</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/16.png"></p>
<blockquote>
<p>•如图所示，只需要在支持sFlow Agent的设备上进行部署，远端连接一个sFlow Collector，就可以对流量进行基于接口的搜集和详细的分析。</p>
<p>•使用 NetStream 也可以对网络流量进行统计分析， 而 NetStream 是一种基于网络流信息的统计技术，网络设备自身需要对网络流进行初步的统计分析，并把统计信息储存在缓存区，当缓存区满或者流统计信息老化后输出统计信息。 与 NetStream 相比， sFlow不需要缓存区，网络设备仅进行报文的采样工作，网络流的统计分析工作由远端的采集器完成。 </p>
<p>•sFlow 与 NetStream 比较具有以下优势：</p>
<ul>
<li><p>节省资源、降低成本：由于不需要缓存区，对网络设备的资源占用少，实现成本低。</p>
</li>
<li><p> 采集器灵活、随需的部署：由于网络流的分析和统计工作由采集器完成，采集器可以灵活的配置网络流特征进行统计分析，实现灵活、随需的部署。</p>
</li>
</ul>
</blockquote>
<h2 id="Telemetry"><a href="#Telemetry" class="headerlink" title="Telemetry"></a>Telemetry</h2><p>•Telemetry，也称为Network Telemetry，即网络遥测技术。主要用于监控网络，包括报文检查和分析，安全侵入和攻击检测，智能收集数据，应用的性能管理等。</p>
<p>•Telemetry优势：</p>
<p>​    ▫支持多种实现方式，满足用户的不同需求。</p>
<p>​    ▫采集数据的精度高，且类型十分丰富，充分反映网络状况。</p>
<p>​    ▫一次订阅，持续上报。</p>
<p>​    ▫故障定位更快速、精准。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/17.png"></p>
<blockquote>
<p>•随着网络的普及和新技术的涌现，网络规模日益增大，部署的复杂度逐步提升，用户对业务的质量要求也不断提高。为了满足用户需求，网络运维务必更加精细化、智能化。当今网络的运维面临着如下挑战：</p>
<ul>
<li><p>超大规模：管理的设备数目众多，监控的信息数量非常庞大。</p>
</li>
<li><p>快速定位：在复杂的网络中，能够快速地定位故障，达到秒级、甚至亚秒级的故障定位速。</p>
</li>
<li><p>精细监控：监控的数据类型更多，且监控粒度更细，以便完整、准确地反应网络状况，据此预估可能发生的故障，并为网络优化提供有力的数据依据。网络运维不仅需要监控接口上的流量统计信息、每条流上的丢包情况、 CPU 和内存占用情况，还需要监控每条流的时延抖动、每个报文在传输路径上的时延、每台设备上的缓冲区占用情况等。</p>
</li>
</ul>
<p>•采集器、分析器和控制器都位于网管侧。</p>
<ul>
<li><p>采集器用于接收和存储网络设备上报的监控数据。</p>
</li>
<li><p>分析器用于分析采集器接收到的监控数据，并对数据进行处理，例如以图形化界面的形式展现给用户。</p>
</li>
<li><p>控制器通过 NETCONF 等方式向设备下发配置，实现对网络设备的管理。控制器可以根据分析器提供的分析数据，为网络设备下发配置，对网络设备的转发行为进行调整；也可以控制网络设备对哪些数据进行采样和上报 。 </p>
</li>
</ul>
</blockquote>
<h2 id="Telemetry的应用场景"><a href="#Telemetry的应用场景" class="headerlink" title="Telemetry的应用场景"></a>Telemetry的应用场景</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/18.png"></p>
<blockquote>
<p>•gRPC（Google Remote Procedure Call， Google 远程过程调用） 是 Google 发布的基于 HTTP 2.0传输层协议承载的高性能开源软件框架，提供了支持多种编程语言的、 对网络设备进行配置和管理的方法。</p>
<p>•传统的网络监控手段（SNMP、CLI、日志）已无法满足网络需要：</p>
<p>•SNMP 和 CLI 主要采用“拉模式”获取数据，即发送请求来获取设备上的数据，限制了可以监控的网络设备数量，且无法快速获取数据。</p>
<p>•SNMP Trap 和日志虽然采用“推模式”获取数据，即设备主动将数据上报给监控设备，但仅上报事件和告警，监控的数据内容极其有限，无法准确地反映网络状况。 </p>
<p>•Telemetry 是一项监控设备性能和故障的远程数据采集技术。它采用“推模式”及时获取丰富的监控数据，可以实现网络故障的快速定位，从而解决上述网络运维问题。</p>
</blockquote>
<h2 id="Syslog"><a href="#Syslog" class="headerlink" title="Syslog"></a>Syslog</h2><p>•Syslog是一种工业标准的协议，可用来记录设备的日志。在UNIX系统，路由器、交换机等网络设备中，系统日志（System Log）记录系统中任何时间发生的大小事件。管理者可以通过查看系统记录，随时掌握系统状况。</p>
<p>•Syslog协议提供了一种通过IP网络传送事件消息的机制，它允许主机将事件消息通过IP网络传输到接收消息的主机上，这些主机通常称为syslog server。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/19.png"></p>
<blockquote>
<p>•该协议从最初的加州大学伯克利分校软件中心整理，后来由于其操作管理的实用性迅速成为很多网络设备操作管理协议的一部分。现在已经有相应的RFC3164,RFC3195进行通用的定义。前者定义的是使用UDP形式传输，后者定义的是使用TCP形式传输。</p>
<p>•几乎所有的网络设备都可以通过syslog protocol将日志信息以UDP方式传送到远端服务器，远端接收日志服务器必须通过syslogd来监听UDP Port 514，并且根据syslog.conf中的配置来处理本机和接收访问系统的日志信息，把指定的事件写入特定档案中，供后台数据库管理和响应之用。</p>
<p>•角色分类</p>
<ul>
<li><p>发送者 sender：产生syslog message的网元；</p>
</li>
<li><p>中继 relay：能接收到后进行转发syslog message的网元或其他设备；</p>
</li>
<li><p>收集者 collector：接收了不再转发syslog message的syslog server；</p>
</li>
</ul>
</blockquote>
<h2 id="其他-LLDP"><a href="#其他-LLDP" class="headerlink" title="其他 - LLDP"></a>其他 - LLDP</h2><p>LLDP（Link Layer Discovery Protocol）是IEEE 802.1ab中定义的链路层发现协议，可以将本端设备的管理地址、设备标识、接口标识等信息组织起来，并发布给自己的邻居设备，邻居设备收到这些信息后将其以标准的管理信息库MIB（Management Information Base）的形式保存起来，以供网络管理系统查询及判断链路的通信状况。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/20.png"></p>
<blockquote>
<p>•LLDP是一种邻近发现协议。它为以太网网络设备，如交换机、路由器和无线局域网接入点定义了一种标准的方法，使其可以向网络中其他节点公告自身的存在，并保存各个邻近设备的发现信息。例如设备配置和设备识别等详细信息都可以用该协议进行公告。</p>
<p>•LLDP信息是定期传输的，并且只在一定的期限内保留。IEEE已经定义了一个建议的传输频率，即每30秒传输一次。LLDP设备在收到邻近网络设备发出的LLDP信息后，将把LLDP信息存储在一个IEEE定义的简单网络管理协议（SNMP）管理信息库（MIB）中，并且在一定的时限内保持有效。定义该时限的LLDP“生存时间”（TTL）值就包含在所收到的数据包内。</p>
<p>•该协议使网络管理系统能够精确地发现和模拟物理网络拓扑结构。由于LLDP设备发送和接收公告，这些设备将会把自己发现的邻近设备信息存储下来。公告数据，如邻近设备的管理地址、设备类型和端口号，都有助于确定邻近设备到底属于什么类型，以及它们通过哪些端口实现互联。</p>
<p>•单邻居组网模式：</p>
<ul>
<li>单邻居组网模式是指交换机设备的接口之间直接相连，而且接口只有一个邻居设备的情况。</li>
</ul>
<p>•链路聚合组网模式：</p>
<ul>
<li>链路聚合组网模式是指交换机设备的接口之间存在链路聚合，接口之间是直接相连，链路聚合之间的每个接口只有一个邻居设备。</li>
</ul>
</blockquote>
<h2 id="LLDP的应用场景"><a href="#LLDP的应用场景" class="headerlink" title="LLDP的应用场景"></a>LLDP的应用场景</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/21.png"></p>
<blockquote>
<p>•Eth-Trunk以太网链路聚合，简称链路聚合，它通过将多条以太网物理链路捆绑在一起成为一条逻辑链路，从而实现增加链路带宽的目的。</p>
</blockquote>
<h2 id="其他-–-镜像"><a href="#其他-–-镜像" class="headerlink" title="其他 – 镜像"></a>其他 – 镜像</h2><p>镜像是指将镜像端口（源端口）的报文复制到观察端口（目的端口）。</p>
<p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/22.png"></p>
<blockquote>
<p>•在网络维护的过程中会遇到需要对报文进行获取和分析的情况，比如怀疑有攻击报文，此时需要在不影响报文转发的情况下，对报文进行获取和分析。镜像可以在不影响报文正常处理流程的情况下，将镜像端口的报文复制一份到观察端口，用户利用数据监控设备来分析复制到观察端口的报文，进行网络监控和故障排除。</p>
<p>•基本概念：</p>
<ul>
<li><p>镜像端口是被监控的端口，从镜像端口流经的所有报文或匹配流分类规则的报文将被复制到观察端口。</p>
</li>
<li><p>观察端口是连接监控设备的端口，用于输出从镜像端口复制过来的报文。</p>
</li>
<li><p>观察端口组是连接多个监控设备的一组端口。观察端口组中的多个成员端口分别连接多个监控设备，当使用观察端口组镜像报文时，镜像到观察端口组的报文将被复制到所有的成员端口。</p>
</li>
</ul>
<p>•端口镜像：是指设备复制一份从镜像端口流经的报文，并将此报文传送到指定的观察端口进行分析和监控</p>
<p>•流镜像：是将镜像端口上特定业务流的报文复制到观察端口进行分析和监控。在流镜像中，镜像端口应用了包含流镜像行为的流策略。如果从镜像端口流经的报文匹配流分类规则，则将被复制到观察端口。</p>
</blockquote>
<h2 id="镜像的应用场景"><a href="#镜像的应用场景" class="headerlink" title="镜像的应用场景"></a>镜像的应用场景</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/23.png"></p>
<blockquote>
<p>•在某些场景中，我们可能需要监控交换机特定端口的入站或出站报文，或者需要针对特定的流量进行分析，例如上图中，GE0/0/2口上承载了许多流量，基于某种需求，我需要对接口的收发报文进行分析从而进行网络的故障定位。那么我可以在交换机的GE0/0/3口接一个PC，在PC上安装协议分析软件，然后部署端口镜像，将GE0/0/2的入、出站流量镜像到GE0/0/3口上来，接下来我只要在PC上通过协议分析软件查看报文即可。</p>
<p>•注意到，如果没有端口镜像技术，除非数据包的目的地是监控PC（所连接的端口），否则报文是不会发向该端口的。因此事实上端口镜像就是将某个特定端口的流量拷贝到某个监控端口。</p>
</blockquote>
<h1 id="4-网络管理的应用场景"><a href="#4-网络管理的应用场景" class="headerlink" title="4.网络管理的应用场景"></a>4.网络管理的应用场景</h1><h2 id="网络管理典型应用场景"><a href="#网络管理典型应用场景" class="headerlink" title="网络管理典型应用场景"></a>网络管理典型应用场景</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/24.png"></p>
<blockquote>
<p>•随着网络的快速发展，数字化转型日益凸显，网络管理逐步从面向网元管理的方式转到面向场景的自动化。</p>
<p>•网络管控系统是自治网络的演进方向，包含了控制器、分析器和管理器。</p>
<p>•SNMP和NETCONF一般用于配置下发，Telemetry、Netstream和sFlow一般用于数据上报。</p>
</blockquote>
<h2 id="什么是iMaster-NCE？"><a href="#什么是iMaster-NCE？" class="headerlink" title="什么是iMaster NCE？"></a>什么是iMaster NCE？</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/25.png"></p>
<h2 id="iMaster-NCE产品架构和客户价值"><a href="#iMaster-NCE产品架构和客户价值" class="headerlink" title="iMaster NCE产品架构和客户价值"></a>iMaster NCE产品架构和客户价值</h2><p><img src="/2021/05/17/IP-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/26.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）网络管理体系结构包含的两个关键元素是什么（ ）</p>
<p><strong>A. 管理设备</strong></p>
<p><strong>B. 被管理设备</strong></p>
<p>C. 代理     </p>
<p>D. 网管协议</p>
<p>2.（多选题）网络管理的基本功能，以下描述正确的是（  ）</p>
<p><strong>A. 配置管理</strong></p>
<p><strong>B. 性能管理</strong>  </p>
<p><strong>C. 故障管理</strong>  </p>
<p><strong>D. 安全管理</strong></p>
<p><strong>E. 计费管理</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•随着数字化技术的快速发展，大数据、AI、云等技术与业务的发展交织在一起，促进了网络管理的变革。网络管理将逐渐向管理自动化和运维智能化方向发展。</p>
<p>•网络管理主要由四个主要模型组成，包括组织结构模型、信息模型、通信模型和功能模型。</p>
<p>•本章节主要从网络管理的配置、性能和故障三大功能来介绍相应的网络管理协议。各个不同协议的讲解主要从角色、数据组织和典型管理方式，三个维度展开。</p>
<h1 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h1><p>•RFC 6241 - Network Configuration Protocol</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6241">https://tools.ietf.org/html/rfc6241</a></li>
</ul>
<p>•Network Telemetry Framework - IETF Tools</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/id/draft-song-opsawg-ntf-02.html">https://tools.ietf.org/id/draft-song-opsawg-ntf-02.html</a></li>
</ul>
<p>•学习推荐</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://e.huawei.com/cn/talent/#/home">https://e.huawei.com/cn/talent/#/home</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IP-DHCP原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T21:07:42+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/DHCP.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•随着网络规模的不断扩大，网络复杂度不断提升，网络中的终端设备例如主机、手机、平板等，位置经常变化。终端设备访问网络时需要配置IP地址、网关地址、DNS服务器地址等。采用手工方式为终端配置这些参数非常低效且不够灵活。</p>
<p>•IETF于1993年发布了DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）。DHCP实现了网络参数配置的自动化，降低客户端的配置和维护成本。</p>
<p>•本课程介绍DHCP工作原理、应用场景和简单配置。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫描述DHCP工作原理</p>
<p>▫描述DHCP地址分配规则</p>
<p>▫区分DHCP与DHCP Relay的应用场景</p>
<p>▫实现DHCP的基本配置</p>
<h1 id="1-DHCP产生背景"><a href="#1-DHCP产生背景" class="headerlink" title="1.DHCP产生背景"></a>1.DHCP产生背景</h1><h2 id="手工配置网络参数存在的问题"><a href="#手工配置网络参数存在的问题" class="headerlink" title="手工配置网络参数存在的问题"></a>手工配置网络参数存在的问题</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<blockquote>
<p>•手工配置主机IP地址、网络掩码、网关地址、DNS服务器地址等网络参数时，需要经过地址规划、地址分配、地址配置、地址维护等复杂的操作流程。这使地址分配灵活性差，IP地址资源利用低，同时较大的工作量导致配置容易出错，对人员素质要求较高。</p>
</blockquote>
<h2 id="DHCP的基本概念"><a href="#DHCP的基本概念" class="headerlink" title="DHCP的基本概念"></a>DHCP的基本概念</h2><p>•DHCP是一种用于集中对用户IP地址进行动态管理和配置的协议。</p>
<p>•DHCP采用C/S(Client/Server，客户端/服务器)通信模式，协议报文基于UDP的方式进行交互，采用67（DHCP服务器）和68（DHCP客户端）两个端口号：</p>
<p>​    ▫正常工作时由客户端向服务器提出配置申请。</p>
<p>​    ▫服务器返回为客户端分配的IP地址等相应的配置信息。</p>
<p>•DHCP相对于手工配置有如下优点：</p>
<p>​    ▫效率高</p>
<p>​    ▫灵活性强</p>
<p>​    易于管理</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•网络终端设备，例如主机、打印机、笔记本电脑、手机和AP，作为DHCP客户端，向DHCP服务器请求分配相关网络参数。DHCP服务器响应DHCP客户端请求进行动态分配。</p>
</blockquote>
<h1 id="2-DHCP工作原理与配置"><a href="#2-DHCP工作原理与配置" class="headerlink" title="2.DHCP工作原理与配置"></a>2.DHCP工作原理与配置</h1><h2 id="DHCP客户端首次接入网络的工作原理"><a href="#DHCP客户端首次接入网络的工作原理" class="headerlink" title="DHCP客户端首次接入网络的工作原理"></a>DHCP客户端首次接入网络的工作原理</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<ol>
<li>发现阶段，即DHCP客户端发现DHCP服务器的阶段。</li>
</ol>
<ul>
<li>DHCP客户端发送DHCP DISCOVER报文来发现DHCP服务器。DHCP DISCOVER报文中携带了客户端的MAC地址、需要请求的参数列表选项、广播标志位等信息。</li>
</ul>
<ol start="2">
<li>提供阶段，即DHCP服务器提供网络配置信息的阶段。</li>
</ol>
<ul>
<li>服务器接收到DHCP DISCOVER报文后，选择跟接收DHCP DISCOVER报文接口的IP地址处于同一网段的地址池，并且从中选择一个可用的IP地址，然后通过DHCP OFFER报文发送给DHCP客户端。</li>
</ul>
<ol start="3">
<li>选择阶段，即DHCP客户端选择IP地址的阶段。</li>
</ol>
<ul>
<li><p>如果有多个DHCP服务器向DHCP客户端回应DHCP OFFER报文，则DHCP客户端一般只接收第一个收到的DHCP OFFER报文，然后以广播方式发送DHCP REQUEST报文，该报文中包含客户端想选择的DHCP服务器标识符和客户端IP地址。</p>
<p>4.确认阶段，即DHCP服务器确认所分配IP地址的阶段。</p>
</li>
<li><p>DHCP客户端收到DHCP ACK报文，会广播发送免费ARP报文，探测本网段是否有其他终端使用服务器分配的IP地址。</p>
</li>
</ul>
<blockquote>
<p>•在确认阶段，两种情况可能出现IP地址的冲突：</p>
<ul>
<li><p>DHCP服务器收到DHCP DISCOVER报文时，给客户端分配IP地址前会发送Ping探测，如果能Ping通则标识该地址不可用，并选择其他IP地址分配给客户端。</p>
</li>
<li><p>DHCP客户端获取IP地址成功后，会立即发送免费ARP报文，如果收到响应，则发送DHCP DECLINE报文通知DHCP服务器该IP地址冲突，DHCP服务器标识该地址不可用，客户端发送DHCP DISCOVER报文重新申请IP地址。</p>
</li>
</ul>
</blockquote>
<h2 id="DHCP报文格式"><a href="#DHCP报文格式" class="headerlink" title="DHCP报文格式"></a>DHCP报文格式</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<blockquote>
<p>•Htype （hardware type）: 表示硬件地址的类型。</p>
<p>•Hlen（hardware length）: 表示硬件地址的长度。</p>
<p>•Hops（hops）: 表示当前DHCP报文经过的DHCP Relay数目。该字段由客户端设置为0，每经过一个DHCP Relay时，该字段加1。此字段的作用是限制DHCP报文所经过的DHCP Relay数目。</p>
<p>•Xid：表示DHCP客户端选取的随机数，使DHCP服务器的回复与DHCP客户端的报文相关联。</p>
<p>•Sname（server host name）: 表示客户端获取配置信息的服务器名字。此字段由DHCP服务器填写，是可选的。如果填写，必须是一个以0结尾的字符串。</p>
<p>•File（file name）: 表示客户端启动DHCP相关配置的文件名。此字段由DHCP服务器填写，随着DHCP地址分配的同时下发至客户端。本字段是可选的，如果填写，必须是一个以0结尾的字符串。</p>
</blockquote>
<h2 id="Options预定义选项字段介绍"><a href="#Options预定义选项字段介绍" class="headerlink" title="Options预定义选项字段介绍"></a>Options预定义选项字段介绍</h2><p>•DHCP报文中Options字段为可变长度字段，最多为312Byte，此字段包含了DHCP报文类型，服务器分配给终端的配置信息，如网关IP地址，DNS服务器的IP地址，客户端可以使用IP地址的有效租期等信息。</p>
<p>•Options字段由Type、Length和Value三部分组成。其中Type字段取值范围1~255。常见的Options如下表所示：</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<h2 id="DHCP的消息类型"><a href="#DHCP的消息类型" class="headerlink" title="DHCP的消息类型"></a>DHCP的消息类型</h2><p>DHCP报文通过Options选项中的Type=53来表示DHCP的报文类型。如下图所示，当Type=53，Length=1，Value取值从01到08分别表示不同的DHCP报文类型。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<blockquote>
<p>•1-DHCP DISCOVER：DHCP客户端首次登录网络时进行DHCP交互过程发送的第一个消息，用来寻找DHCP服务器。</p>
<p>•2-DHCP OFFER：DHCP服务器用来响应DHCP DISCOVER消息，此消息携带了各种配置信息。 </p>
<p>•3-DHCP REQUEST：DHCP客户端广播请求回应DHCP服务器OFFER消息；DHCP客户端重启广播确认之前的IP地址等配置信息；续租。</p>
<p>•4-DHCP DECLINE：当客户端发现服务器分配给它的IP地址发生冲突时会通过发送此消息来通知服务器。</p>
<p>•5-DHCP ACK：DHCP服务器对客户端的DHCP REQUEST消息的确认响应消息。</p>
<p>•6-DHCP NAK：服务器对客户端的DHCP REQUEST消息的拒绝响应消息。</p>
<p>•7-DHCP RELEASE：客户端可通过发送此消息主动释放服务器分配给它的IP地址。</p>
<p>•8-DHCP INFORM：DHCP客户端获取IP地址后，如果需要向DHCP服务器获取更为详细的配置信息（网关地址、DNS服务器地址），则向DHCP服务器发送DHCP INFORM请求消息。</p>
</blockquote>
<h2 id="Options自定义选项字段介绍"><a href="#Options自定义选项字段介绍" class="headerlink" title="Options自定义选项字段介绍"></a>Options自定义选项字段介绍</h2><p>除了标准协议中规定的字段选项外，还有部分选项内容没有统一规定，统称为用户自定义选项，例如Option 82和Option 43。</p>
<ul>
<li>Option 82称为中继代理信息选项。<ul>
<li>Option 82中可以包含最多255个Sub-Option，若定义了Option 82，至少要定义一个Sub-Option。</li>
<li>DHCP中继或DHCP Snooping设备接收到DHCP客户端发送给DHCP服务器的请求报文后，在该报文中添加Option 82，并转发给DHCP服务器。管理员可以从Option 82中获得DHCP客户端的信息，例如DHCP客户端所连接交换机端口的VLAN ID、二层端口号、中继设备的MAC地址等。</li>
</ul>
</li>
</ul>
<p>▫Option 43称为厂商特定信息选项。</p>
<ul>
<li>DHCP服务器和DHCP客户端通过Option 43交换厂商特定的信息。当DHCP服务器接收到请求Option 43信息的DHCP请求报文（Option 55中带有Option 43参数）后，将在回复报文中携带Option 43，为DHCP客户端分配厂商指定的信息。</li>
<li>在WLAN组网中，AP作为DHCP客户端，DHCP服务器可以为AP指定AC的IP地址，以方便AP与AC建立连接。</li>
</ul>
<blockquote>
<p>目前option 82中常用的Sub-Option如下：</p>
<p>▫Sub-Option 1：为代理电路id（即circuit id）子项。子选项通常在DHCP中继设备上配置，定义了在传输报文的时候要携带DHCP客户端所连接交换机端口的vlan-id及二层端口号。通常Sub-Option 1与Sub-Option 2子选项要共同使用来标识DHCP源端的信息。</p>
<p>▫Sub-Option 2：代理远程id（即remote id）子项。该子选项也通常在DHCP中继设备上配置，定义了在传输报文的时候要携带中继设备的mac地址信息。</p>
<p>▫和Sub-Option 5：为链路选择（link selection）子项，该选项中包含了DHCP中继添加的ip地址。这样DHCP server在分配ip地址给DHCP客户端的时候就可以分配与该地址同网段的ip地址。</p>
</blockquote>
<h2 id="Option-43应用举例"><a href="#Option-43应用举例" class="headerlink" title="Option 43应用举例"></a>Option 43应用举例</h2><p>•在WLAN三层组网中，当AP上线时，需要获取AC的IP地址，并与AC之间建立CAPWAP隧道。</p>
<p>•AP的IP地址通过DHCP服务器分配，当AC的IP地址与AP不在同一个广播域，AP无法通过广播的方式获取AC的IP地址，则CAPWAP隧道无法建立成功。</p>
<p>•AP通过DHCP报文中的Option 43选项字段获取AC的IP地址，当AP获取AC的IP地址后，可以进一步完成CAPWAP隧道的建立，从而实现AP上线。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<h2 id="DHCP地址续租"><a href="#DHCP地址续租" class="headerlink" title="DHCP地址续租"></a>DHCP地址续租</h2><p>DHCP客户端根据IP地址的剩余租期的不同而产生不同形式的续租请求。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<p>•当租期达到50%（T1）时，DHCP客户端会自动以单播的方式向DHCP服务器发送DHCP REQUEST报文，请求更新IP地址租期。如果收到DHCP服务器回应的DHCP ACK报文，则租期更新成功。</p>
<p>•当租期达到87.5%（T2）时，如果仍未收到DHCP服务器的应答，DHCP客户端会自动以广播的方式向DHCP服务器发送DHCP REQUEST报文，请求更新IP地址租期。如果收到DHCP服务器回应的DHCP ACK报文，则租期更新成功。</p>
<p>•如果租期时间到时都没有收到服务器的回应，客户端停止使用此IP地址，重新发送DHCP DISCOVER报文请求新的IP地址。</p>
<blockquote>
<p>•DHCP服务器给每个分配给客户端的IP地址定义一个使用期限，该使用期限被称为租期。在租期到期前，DHCP客户端如果仍需要使用该IP地址，可以请求延长租期；如果不需要，可以主动释放该IP地址。在没有其他空闲地址可用的情况下，DHCP服务器会把客户端主动释放的IP地址分配给其他客户端。</p>
<p>•DHCP客户端无论在T1还是T2时刻发送DHCP REQUEST报文后，如果收到DHCP NAK报文，则重新发送DHCP DISCOVER报文请求新的IP地址。</p>
<p>•客户端在租期时间到之前，如果用户不想使用分配的IP地址（例如客户端网络位置需要变更），会触发DHCP客户端向DHCP服务器发送DHCP RELEASE报文，通知DHCP服务器释放IP地址的租期。DHCP服务器会保留这个DHCP客户端的配置信息，将IP地址列为曾经分配过的IP地址中，以便后续重新分配给该客户端或其他客户端。客户端可以通过发送DHCP INFORM报文向服务器请求更新配置信息。</p>
</blockquote>
<h2 id="DHCP客户端重用曾经使用过的地址"><a href="#DHCP客户端重用曾经使用过的地址" class="headerlink" title="DHCP客户端重用曾经使用过的地址"></a>DHCP客户端重用曾经使用过的地址</h2><p>DHCP客户端非首次接入网络时，可以重用曾经使用过的地址。例如，网络中的主机作为DHCP客户端，在关机再开机的过程中，需要重新获取相关网络参数，则可以请求分配曾经使用过的IP地址。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<p>1.选择阶段</p>
<ul>
<li>客户端广播发送包含前一次分配的IP地址的DHCP REQUEST报文，报文中的Option 50（请求的IP地址选项）字段填入曾经使用过的IP地址。</li>
</ul>
<p>2.确认阶段</p>
<ul>
<li>DHCP服务器收到DHCP REQUEST报文后，根据DHCP REQUEST报文中携带的MAC地址来查找有没有相应的租约记录。如果有则返回DHCP ACK报文，通知DHCP客户端可以继续使用这个IP地址，如果没有租约记录，则不响应。</li>
</ul>
<blockquote>
<p>•是否支持重用曾经使用过的IP地址，因不同客户端而异。</p>
</blockquote>
<h2 id="DHCP分配IP地址顺序"><a href="#DHCP分配IP地址顺序" class="headerlink" title="DHCP分配IP地址顺序"></a>DHCP分配IP地址顺序</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<h2 id="DHCP配置命令介绍-1"><a href="#DHCP配置命令介绍-1" class="headerlink" title="DHCP配置命令介绍 (1)"></a>DHCP配置命令介绍 (1)</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<blockquote>
<p>•此处以ip pool的名字为HW举例说明。</p>
<p>•缺省情况下，没有配置为指定DHCP Client分配固定IP地址。</p>
</blockquote>
<h2 id="DHCP配置命令介绍-2"><a href="#DHCP配置命令介绍-2" class="headerlink" title="DHCP配置命令介绍 (2)"></a>DHCP配置命令介绍 (2)</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<blockquote>
<p>•此处以接口GigabitEthernet0/0/1举例说明。</p>
</blockquote>
<h2 id="DHCP配置举例（1）"><a href="#DHCP配置举例（1）" class="headerlink" title="DHCP配置举例（1）"></a>DHCP配置举例（1）</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<h2 id="DHCP配置举例（2）"><a href="#DHCP配置举例（2）" class="headerlink" title="DHCP配置举例（2）"></a>DHCP配置举例（2）</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<h2 id="DHCP配置结果"><a href="#DHCP配置结果" class="headerlink" title="DHCP配置结果"></a>DHCP配置结果</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<h1 id="3-DHCP-Relay工作原理与配置"><a href="#3-DHCP-Relay工作原理与配置" class="headerlink" title="3.DHCP Relay工作原理与配置"></a>3.DHCP Relay工作原理与配置</h1><h2 id="什么是DHCP-Relay"><a href="#什么是DHCP-Relay" class="headerlink" title="什么是DHCP Relay"></a>什么是DHCP Relay</h2><p>•随着网络规模的不断扩大，网络设备不断增多，企业内不同的用户可能分布在不同的网段，一台DHCP服务器在正常情况下无法满足多个网段的地址分配需求。如果还需要通过DHCP服务器分配IP地址，则需要跨网段发送DHCP报文。</p>
<p>•DHCP Relay即DHCP中继，它是为解决DHCP服务器和DHCP客户端不在同一个广播域而提出的，提供了对DHCP广播报文的中继转发功能，能够把DHCP客户端的广播报文“透明地”传送到其它广播域的DHCP服务器上，同样也能够把DHCP服务器端的应答报文“透明地”传送到其它广播域的DHCP客户端。</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<h2 id="DHCP-Relay报文格式"><a href="#DHCP-Relay报文格式" class="headerlink" title="DHCP Relay报文格式"></a>DHCP Relay报文格式</h2><p>DHCP Relay主要负责转发DHCP客户端与DHCP服务器之间的DHCP报文，所以DHCP Relay的报文格式只是把DHCP的报文部分字段做了相应的修改，报文格式没有发生变化，如下图所示：</p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<p>Hops：表示当前的DHCP报文经过的DHCP中继的数目。该字段由客户端或服务器设置为0，每经过一个DHCP中继时，该字段加1。</p>
<p>Giaddr(gateway ip address)：表示第一个DHCP中继的IP地址。当客户端发出DHCP请求时，第一个DHCP中继在将DHCP请求报文转发给DHCP服务器时，会把自己的IP地址填入此字段。</p>
<blockquote>
<p>•Hops字段的作用是限制DHCP报文所经过的DHCP中继数目。服务器和客户端之间的DHCP中继数目不能超过16个，也就是Hops值不能大于16，否则DHCP报文将被丢弃。</p>
<p>•Giaddr字段，DHCP服务器会根据此字段来判断出客户端所在的网段地址，从而选择合适的地址池，为客户端分配该网段的IP地址。服务器还会根据此地址将响应报文发送给此DHCP中继，再由DHCP中继将此报文转发给客户端。若在到达DHCP服务器前经过了多个DHCP中继，该字段作为客户端所在的网段的标记，填充了第一个DHCP中继的IP地址后不会再变更，只是每经过一个DHCP中继，hops字段的数值会加1。</p>
</blockquote>
<h2 id="DHCP-Relay工作原理"><a href="#DHCP-Relay工作原理" class="headerlink" title="DHCP Relay工作原理"></a>DHCP Relay工作原理</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<p>有中继场景时DHCP客户端首次接入网络的工作原理：</p>
<p>1.发现阶段：DHCP中继接收到DHCP客户端广播发送的DHCP DISCOVER报文后，通过路由转发将DHCP报文单播发送到DHCP服务器或下一跳中继。</p>
<p>2.提供阶段：DHCP服务器根据DHCP DISCOVER报文中的Giaddr字段选择地址池为客户端分配相关网络参数，DHCP中继收到DHCP OFFER报文后，以单播或组播方式发送给DHCP Client。</p>
<p>3.选择阶段：中继接收到来自客户端的DHCP REQUEST报文的处理过程同“发现阶段”。</p>
<p>4.确认阶段：中继接收到来自服务器的DHCP ACK报文的处理过程同“提供阶段”。</p>
<blockquote>
<p>1.DHCP中继收到DHCP DISCOVER报文后，处理规则为：</p>
<ul>
<li>检查DHCP报文中的Hops字段，如果大于16，则丢弃DHCP报文；否则，将Hops字段加1（表明经过一次DHCP中继），并继续下面的操作。</li>
<li>检查DHCP报文中的Giaddr字段。如果是0，将Giaddr字段设置为接收DHCP DISCOVER报文的接口IP地址。如果不是0，则不修改该字段，继续下面的操作。</li>
<li>将DHCP报文的目的IP地址改为DHCP服务器或下一跳中继的IP地址，源地址改为中继连接客户端的接口地址，通过路由转发将DHCP报文单播发送到DHCP服务器或下一跳中继。</li>
</ul>
<p>2.DHCP服务器接收到DHCP DISCOVER报文后，选择与报文中Giaddr字段为同一网段的地址池，并为客户端分配IP地址等参数，然后向Giaddr字段标识的DHCP中继单播发送DHCP OFFER报文，DHCP中继收到DHCP OFFER报文后，会进行如下处理：</p>
<ul>
<li><p>检查报文中的Giaddr字段，如果不是接口的地址，则丢弃该报文；否则，继续下面的操作。</p>
</li>
<li><p>DHCP中继检查报文的广播标志位。如果广播标志位为1，则将DHCP OFFER报文广播发送给DHCP客户端；否则将DHCP OFFER报文单播发送给DHCP客户端。</p>
</li>
</ul>
</blockquote>
<h2 id="DHCP-Relay配置命令介绍"><a href="#DHCP-Relay配置命令介绍" class="headerlink" title="DHCP Relay配置命令介绍"></a>DHCP Relay配置命令介绍</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<h2 id="DHCP-Relay配置举例-1"><a href="#DHCP-Relay配置举例-1" class="headerlink" title="DHCP Relay配置举例 (1)"></a>DHCP Relay配置举例 (1)</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<blockquote>
<p>•各个设备配置DHCP前需要在全局视图下通过DHCP enable命令开启DHCP功能。</p>
</blockquote>
<h2 id="DHCP-Relay配置举例-2"><a href="#DHCP-Relay配置举例-2" class="headerlink" title="DHCP Relay配置举例 (2)"></a>DHCP Relay配置举例 (2)</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<h2 id="DHCP-Relay配置验证"><a href="#DHCP-Relay配置验证" class="headerlink" title="DHCP Relay配置验证"></a>DHCP Relay配置验证</h2><p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/27.png"></p>
<p><img src="/2021/05/17/IP-DHCP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/28.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（单选题）DHCP客户端向DHCP Server进行续租时会发送哪种报文？</p>
<p>A.DHCP DISCOVER</p>
<p>B.DHCP OFFER</p>
<p><strong>C.DHCP REQUEST</strong></p>
<p>D.DHCP ACK</p>
<p>2.（单选题）以下哪条命令可以开启路由器接口的DHCP中继功能？</p>
<p>A.DHCP select server</p>
<p>B.DHCP select global</p>
<p>C.DHCP select interface</p>
<p><strong>D.DHCP select relay</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•本章节主要讲解了DHCP报文的格式及关键字段的作用。通过报文交互介绍了DHCP服务器如何给DHCP客户端分配IP地址等网络参数的过程，同时阐述了地址续租与DHCP客户端重启之后如何获取IP地址的原理。</p>
<p>•当DHCP客户端与DHCP服务器不在一个广播域的时候，通过DHCP Relay的中继功能，实现DHCP报文的跨网段传输，从而完成DHCP客户端与服务器之间的报文协商。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mydog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zsy's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/" itemprop="url">IP-VRRP原理与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T20:53:26+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h1><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>•局域网中的用户终端通常采用配置一个默认网关的形式访问外部网络，如果默认网关设备发生故障，那么所有用户终端访问外部网络的流量将会中断。可以通过部署多个网关的方式来解决单点故障，但是需要解决多个网关之间的冲突问题。</p>
<p>•VRRP（Virtual Router Redundancy Protocol，虚拟路由器冗余协议）既能够实现网关的备份，又能解决多个网关之间互相冲突的问题，从而提高网络可靠性。</p>
<p>•本课程主要介绍VRRP的工作原理与基本配置，以及在网络中的典型应用。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>▫分析局域网单网关引发的问题</p>
<p>▫阐述VRRP基本概念及工作原理</p>
<p>▫描述VRRP主备切换过程</p>
<p>▫实现VRRP基本配置</p>
<h1 id="1-VRRP技术概述"><a href="#1-VRRP技术概述" class="headerlink" title="1.VRRP技术概述"></a>1.VRRP技术概述</h1><h2 id="单网关面临的问题"><a href="#单网关面临的问题" class="headerlink" title="单网关面临的问题"></a>单网关面临的问题</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/1.png"></p>
<h2 id="VRRP概述"><a href="#VRRP概述" class="headerlink" title="VRRP概述"></a>VRRP概述</h2><p>通过把几台路由设备联合组成一台虚拟的“路由设备”，使用一定的机制保证当主机的下一跳路由设备出现故障时，及时将业务切换到备份路由设备，从而保持通讯的连续性和可靠性。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/2.png"></p>
<blockquote>
<p>•VRRP的运行结果是在局域网上提供一个虚拟路由器。</p>
<p>•本例中：</p>
<ul>
<li><p>局域网中有两个路由器R1和R2，R1端口IP地址为192.168.1.251/24，R2端口IP地址为192.168.1.252/24。</p>
</li>
<li><p>配置R1和R2关联到同一个虚拟路由器，该虚拟路由器使用192.168.1.254做为端口IP地址。</p>
</li>
<li><p>所有的PC使用192.168.1.254做为默认网关。</p>
</li>
</ul>
</blockquote>
<h2 id="VRRP的基本概念-1"><a href="#VRRP的基本概念-1" class="headerlink" title="VRRP的基本概念 (1)"></a>VRRP的基本概念 (1)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/3.png"></p>
<p>•<strong>VRRP路由器：</strong>运行VRRP协议的路由器，如R1和R2。VRRP是配置在路由器的接口上的，而且也是基于接口来工作的。</p>
<p>•<strong>VRID：</strong>一个VRRP组（VRRP Group）由多台协同工作的路由器（的接口）组成，使用相同的VRID（Virtual Router Identifier，虚拟路由器标识符）进行标识。属于同一个VRRP组的路由器之间交互VRRP协议报文并产生一台虚拟“路由器”。一个VRRP组中只能出现一台Master路由器。 </p>
<h2 id="VRRP的基本概念-2"><a href="#VRRP的基本概念-2" class="headerlink" title="VRRP的基本概念 (2)"></a>VRRP的基本概念 (2)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/4.png"></p>
<p>•<strong>虚拟路由器：</strong>VRRP为每一个组抽象出一台虚拟“路由器”（Virtual Router），该路由器并非真实存在的物理设备，而是由VRRP虚拟出来的逻辑设备。一个VRRP组只会产生一台虚拟路由器。</p>
<p>•<strong>虚拟IP地址及虚拟MAC地址：</strong>虚拟路由器拥有自己的IP地址以及MAC地址，其中IP地址由网络管理员在配置VRRP时指定，一台虚拟路由器可以有一个或多个IP地址，通常情况下用户使用该地址作为网关地址。而虚拟MAC地址的格式是“0000-5e00-01xx”，其中xx为VRID。</p>
<h2 id="VRRP的基本概念-3"><a href="#VRRP的基本概念-3" class="headerlink" title="VRRP的基本概念 (3)"></a>VRRP的基本概念 (3)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/5.png"></p>
<p>•<strong>Master路由器：</strong>“Master路由器”在一个VRRP组中承担报文转发任务。在每一个VRRP组中，只有Master路由器才会响应针对虚拟IP地址的ARP Request。Master路由器会以一定的时间间隔周期性地发送VRRP报文，以便通知同一个VRRP组中的Backup路由器关于自己的存活情况。</p>
<p>•<strong>Backup路由器：</strong>也被称为备份路由器。Backup路由器将会实时侦听Master路由器发送出来的VRRP报文，它随时准备接替Master路由器的工作。</p>
<p>•<strong>Priority：</strong>优先级值是选举Master路由器和Backup路由器的依据，优先级取值范围0-255，值越大越优先，值相等则比较接口IP地址大小，大者优先。</p>
<h2 id="VRRP报文格式"><a href="#VRRP报文格式" class="headerlink" title="VRRP报文格式"></a>VRRP报文格式</h2><p>VRRP只有一种报文，即Advertisement报文，基于组播方式发送，因此只能在同一个广播域传递。 Advertisement报文的目的组播地址为224.0.0.18。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/6.png"></p>
<blockquote>
<p>VRRP报文字段含义如下：</p>
<p>▫Ver：VRRP目前有两个版本，其中VRRPv2仅适用于IPv4网络，VRRPv3适用于IPv4和IPv6两种网络。</p>
<p>▫Virtual Rtr ID：该报文所关联的虚拟路由器的标识。</p>
<p>▫Priority：发送该报文的VRRP路由器的优先级。</p>
<p>▫Count IP Addrs：该VRRP报文中所包含的虚拟IP地址的数量。</p>
<p>▫Auth Type：VRRP支持三种认证类型：不认证、纯文本密码认证、MD5方式认证，对应值分别为0、1、2。</p>
<p>▫Adver Int：发送VRRP通告消息的间隔。默认为1秒</p>
<p>▫IP Address：所关联的虚拟路由器的虚拟IP地址，可以为多个。</p>
<p>▫Authentication Data：验证所需要的密码信息。</p>
</blockquote>
<h2 id="VRRP定时器"><a href="#VRRP定时器" class="headerlink" title="VRRP定时器"></a>VRRP定时器</h2><p>在VRRP协议工作过程中，VRRP定义了两个定时器：</p>
<p>▫ADVER_INTERVAL定时器：Master发送VRRP通告报文时间周期，缺省值为1秒。</p>
<p>▫MASTER_DOWN定时器：Backup设备监听该定时器超时后，会变为Master状态。<br>     MASTER_DOWN定时器计算公式如下：</p>
<ul>
<li>MASTER_DOWN =（3* ADVER_INTERVAL）+ Skew_time（偏移时间）</li>
<li>其中，Skew_Time=（256–Priority）/256</li>
</ul>
<h1 id="2-VRRP技术原理"><a href="#2-VRRP技术原理" class="headerlink" title="2.VRRP技术原理"></a>2.VRRP技术原理</h1><h2 id="VRRP状态机"><a href="#VRRP状态机" class="headerlink" title="VRRP状态机"></a>VRRP状态机</h2><p>VRRP协议状态机有三种状态：Initialize（初始状态）、Master（活动状态）、Backup（备份状态）。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/7.png"></p>
<blockquote>
<p>•一个Startup事件可以由系统在VRRP配置完成后自动触发，也可以是在已经配置VRRP的端口上，底层链路由不可用变为可用而触发。</p>
</blockquote>
<h2 id="VRRP协议状态"><a href="#VRRP协议状态" class="headerlink" title="VRRP协议状态"></a>VRRP协议状态</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/8.png"></p>
<h2 id="VRRP主备选举-1"><a href="#VRRP主备选举-1" class="headerlink" title="VRRP主备选举 (1)"></a>VRRP主备选举 (1)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/9.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/10.png"></p>
<blockquote>
<p>•初始创建VRRP的设备工作在Initialize状态，收到接口Up的消息后，若此设备的优先级小于255，则会先切换至Backup状态，等待MASTER_DOWN定时器超时后再切换至Master状态。</p>
<p>•如果优先级高的设备先启动，优先级低的设备后启动，则优先级高的设备先进入Master状态，优先级低的设备收到高优先级的VRRP通告报文，自己仍处于Backup状态。</p>
<p>•如果优先级低的先启动，优先级高的后启动，则优先级低的先由Backup状态切换为Master状态，优先级高的设备收到优先级低的VRRP通告报文，重新进行选举，将优先级高的设备切换为Master状态。</p>
</blockquote>
<h2 id="VRRP主备选举-2"><a href="#VRRP主备选举-2" class="headerlink" title="VRRP主备选举 (2)"></a>VRRP主备选举 (2)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/11.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/12.png"></p>
<blockquote>
<p>•初始创建VRRP的设备工作在Initialize状态，收到接口Up的消息后，若此设备的优先级小于255，则会先切换至Backup状态，等待MASTER_DOWN定时器超时后再切换至Master状态。</p>
<p>•如果优先级高的设备先启动，优先级低的设备后启动，则优先级高的设备先进入Master状态，优先级低的设备收到高优先级的VRRP通告报文，自己仍处于Backup状态。</p>
<p>•如果优先级低的先启动，优先级高的后启动，则优先级低的先由Backup状态切换为Master状态，优先级高的设备收到优先级低的VRRP通告报文，重新进行选举，将优先级高的设备切换为Master状态。</p>
</blockquote>
<h2 id="VRRP主备选举-3"><a href="#VRRP主备选举-3" class="headerlink" title="VRRP主备选举 (3)"></a>VRRP主备选举 (3)</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/13.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/14.png"></p>
<blockquote>
<p>•通常情况下，VRRP路由器的接口IP地址不会与虚拟路由器的IP地址重叠，也就是说我们会为虚拟路由器单独规划一个IP地址，而不会使用某台路由器的接口IP地址。当然也存在一个特殊的情况，例如在某些网络中IP地址资源比较紧缺，那么也有可能会将某台路由器的接口IP地址用于虚拟路由器，此时该路由器将无条件成为Master。</p>
<p>•无法手动将VRRP接口优先级配置为255，当接口IP地址为IP地址拥有者时，优先级自动成为255。</p>
</blockquote>
<h2 id="VRRP主备切换"><a href="#VRRP主备切换" class="headerlink" title="VRRP主备切换"></a>VRRP主备切换</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/15.png"></p>
<blockquote>
<p>•当Master设备主动放弃Master地位（如Master设备退出备份组）时，会发送优先级为0的通告报文，用来使Backup设备快速切换成Master设备，而不用等到MASTER_DOWN定时器超时。这个切换的时间称为Skew_time。</p>
<p>•当Master设备发生网络故障而不能发送通告报文的时候，Backup设备并不能立即知道其工作状况。等到MASTER_DOWN定时器超时后，才会认为Master设备无法正常工作，从而将状态切换为Master。</p>
</blockquote>
<h2 id="VRRP主备回切"><a href="#VRRP主备回切" class="headerlink" title="VRRP主备回切"></a>VRRP主备回切</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/16.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/17.png"></p>
<blockquote>
<p>•开启抢占模式的VRRP备份组，当主备进行切换时，总共时长为：3xAdver_Interval+Skew_time+Delay_time</p>
<p>•在抢占模式下，当Master的设备状态不稳定或者网络质量差时，会导致VRRP备份组频繁切换，从而引发终端ARP表项频繁刷新，为缓解此问题，通常设置抢占延时定时器，通过MASTER_INTERVAL定时器超时时间加上延时时间，确定状态稳定后，再进行主备回切。</p>
</blockquote>
<h1 id="3-VRRP典型应用"><a href="#3-VRRP典型应用" class="headerlink" title="3.VRRP典型应用"></a>3.VRRP典型应用</h1><h2 id="VRRP负载分担"><a href="#VRRP负载分担" class="headerlink" title="VRRP负载分担"></a>VRRP负载分担</h2><p>通过创建多个虚拟路由器，每个物理路由器在不同的VRRP组中扮演不同的角色，不同虚拟路由器的Virtual IP作为不同的内网网关地址可以实现流量转发负载分担。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/18.png"></p>
<h2 id="VRRP监视上行端口"><a href="#VRRP监视上行端口" class="headerlink" title="VRRP监视上行端口"></a>VRRP监视上行端口</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/19.png"></p>
<blockquote>
<p>•如果用户未配置VRRP监视上行端口，则当VRRP备份组中的Master设备R1的上行接口或者链路出现故障时，VRRP备份组无法感知，Master无法向外转发流量。但是由于主备不会发生切换，导致出现流量黑洞。</p>
</blockquote>
<h2 id="VRRP与BFD联动"><a href="#VRRP与BFD联动" class="headerlink" title="VRRP与BFD联动"></a>VRRP与BFD联动</h2><p>通过配置VRRP与BFD联动，当Backup设备通过BFD感知故障发生之后，不再等待Master_Down_Timer计时器超时而会在BFD检测周期结束后立即切换VRRP状态，此时可以实现毫秒级的主备切换。</p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/20.png"></p>
<blockquote>
<p>•当VRRP备份组之间的链路出现故障时，由于此时VRRP报文无法正常交互，Backup设备需要等待Master_Down_Timer计时器超时后才会切换为Master设备，在等待切换期间内，业务流量仍会发往Master设备，此时会造成业务流量丢失。</p>
<p>•通过在Master设备和Backup设备之间建立BFD会话并与VRRP备份组进行绑定，由BFD机制快速检测VRRP备份组之间的通信故障，并在出现故障时及时通知VRRP备份组进行主备切换，从而大大减少应用中断时间。</p>
<p>•在普通BFD联动中，VRRP备份组会根据BFD会话的状态进行优先级调整，并根据调整后的优先级判断是否进行主备切换。在实际应用中，通常Master设备配置延时抢占，而Backup设备配置立即抢占，当Backup设备检测到BFD会话状态出现DOWN后，通过增加自身优先级大于Master优先级实现快速切换，当故障排除，BFD会话状态出现UP时，新的Master通过减小自己的优先级，发送vrrp通告报文，经过延迟时间后再次切换为Backup。</p>
</blockquote>
<h2 id="VRRP与MSTP结合应用"><a href="#VRRP与MSTP结合应用" class="headerlink" title="VRRP与MSTP结合应用"></a>VRRP与MSTP结合应用</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/21.png"></p>
<blockquote>
<p>•MSTP是将一个或多个VLAN映射到一个生成树的实例，若干个VLAN共用一个生成树，MSTP可以实现负载均衡。</p>
<p>•VRRP配置网关可以灵活根据网络拓扑变化而自动切换，提高网络可靠性。</p>
<p>•VRRP+MSTP可以在实现负载分担的同时保证网络冗余备份。</p>
</blockquote>
<h1 id="4-VRRP基本配置"><a href="#4-VRRP基本配置" class="headerlink" title="4.VRRP基本配置"></a>4.VRRP基本配置</h1><h2 id="VRRP常用配置命令"><a href="#VRRP常用配置命令" class="headerlink" title="VRRP常用配置命令"></a>VRRP常用配置命令</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/22.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/23.png"></p>
<h2 id="VRRP基础配置实例"><a href="#VRRP基础配置实例" class="headerlink" title="VRRP基础配置实例"></a>VRRP基础配置实例</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/24.png"></p>
<p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/25.png"></p>
<h2 id="VRRP基础配置验证"><a href="#VRRP基础配置验证" class="headerlink" title="VRRP基础配置验证"></a>VRRP基础配置验证</h2><p><img src="/2021/05/17/IP-VRRP%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE/26.png"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>1.（多选题）以下关于VRRP报文中IP地址的设置正确的说法是(   )。</p>
<p><strong>A.源IP地址为Master设备端口的IP地址</strong></p>
<p>B.源IP地址为虚拟路由器的虚拟IP地址</p>
<p>C.目的IP地址为广播IP地址</p>
<p><strong>D.目的IP地址为组播IP地址</strong></p>
<p>2.（多选题）以下关于VRRP协议中各定时器的说法正确的是(   )。</p>
<p><strong>A.VRRP通告消息发送间隔默认为1秒，关联到同一虚拟路由器VRRP路由器上配置的VRRP消息通告间隔必须一致。</strong></p>
<p>B.配置抢占延迟时间为4秒，表示如果4秒中之内没有收到Master发送的VRRP通告消息，则Slave应当成为新的Master。</p>
<p>C.配置抢占延迟时间为4秒，配置VRRP消息通告间隔为2秒，表示如果6秒中之内没有收到Master发送的VRRP通告消息，则Slave应当成为新的Master。</p>
<p><strong>D.在比较繁忙的网络中，应当适当的将抢占延迟设置为一个较大的值，以避免不必要的VRRP角色振荡。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>•VRRP作为一种非常重要的可靠性技术，常用于实现网关设备冗余，该协议既能提高网络可靠性，又可以实现网络负载分担。</p>
<p>•VRRP主备选举、主备切换及主备回切都主要通过VRRP优先级来控制，为了确保网络稳定性，VRRP设计了抢占延时机制，减少网络震荡。</p>
<p>•VRRP可监视上行接口状态，从而感知网络故障，联动VRRP实现网络可靠性。VRRP亦可绑定BFD会话实现快速收敛。此外，VRRP可与MSTP结合使用，在园区网络中，这是常见的组网方案。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/mydog.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">72</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zsy9959" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:zsy9959@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张思宇</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
